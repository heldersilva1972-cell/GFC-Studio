@page "/"
@namespace GFC.BlazorServer.Pages
@using Microsoft.AspNetCore.Components.Web
@using GFC.BlazorServer.Components
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="~/" />
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="css/diagnostics.css" />
    <link rel="stylesheet" href="css/camera-grid.css" />
    <link rel="stylesheet" href="css/god-tier-animations.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="GFC.BlazorServer.styles.css" />
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="manifest" href="manifest.json?v=3" />
    
    <!-- PWA Meta Tags for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="GFC" />
    <link rel="apple-touch-icon" href="/images/pwa-icon-192.png" />
    
    <!-- PWA Meta Tags for Android/Chrome -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#121212" />
    
    <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    <component type="typeof(App)" render-mode="Server" />

    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/gfc-select-helpers.js"></script>
    <!-- <script src="js/pwa-installer.js"></script> -->
    <script src="/js/download.js"></script>
    <script src="/js/fileUtils.js"></script>
    <script src="/js/camera-player.js"></script>
    <script src="/js/camera.js"></script>
    <script src="/js/multiselect.js"></script>
    <script src="/js/diagnostics-charts.js"></script>
    <script src="/js/bar-sales-charts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="/js/studio-dnd.js"></script>
    <script src="/js/studio.js"></script>
    <script src="/js/studioInterop.js"></script>
    <script src="js/animationInterop.js"></script>
    <script src="js/animationScrubbing.js"></script>
    <script src="js/timeline-interop.js"></script>
    <script src="js/animation-orchestrator.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/session-monitor.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="_framework/blazor.server.js"></script>
    <script>
        window.downloadFile = function (fileName, base64Data, contentType) {
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        };

        window.scrollToBottom = function (element) {
            if (element) {
                element.scrollTop = element.scrollHeight;
            }
        };

        window.setCookie = function (name, value, days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            // Force Secure if protocol is https
            var secure = location.protocol === 'https:' ? "; Secure" : "";
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax" + secure;
            console.log("Cookie set: " + name);
        };

        window.copyTextToClipboard = function (text) {
            if (!navigator.clipboard || !window.isSecureContext) {
                // Fallback for non-secure (HTTP)
                var textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                 document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('Copied to clipboard!');
                    return true;
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    return false;
                } finally {
                    document.body.removeChild(textArea);
                }
            }
            
            navigator.clipboard.writeText(text).then(function() {
                alert('Copied to clipboard!');
            }, function(err) {
                console.error('Async: Could not copy text: ', err);
                alert('Failed to copy. Please copy manually.');
            });
            return true;
        };

        // Quill Rich Text Editor Interop
        window.quillInterop = {
            init: function(elementId, content) {
                var elem = document.getElementById(elementId);
                if (!elem) return;

                // Check if already initialized by looking for Quill class
                if (elem.classList.contains('ql-container')) return;
                
                var quill = new Quill('#' + elementId, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'align': [] }],
                            ['clean']
                        ]
                    }
                });
                
                if (content) {
                    quill.root.innerHTML = content;
                }
                
                window[elementId] = quill;
            },
            getContent: function(elementId) {
                var quill = window[elementId];
                return quill ? quill.root.innerHTML : "";
            },
            setContent: function(elementId, content) {
                var quill = window[elementId];
                if (quill) {
                     quill.root.innerHTML = content;
                }
            }
        };

        window.selectBackupFolder = async function () {
            try {
                // Try File System Access API first (Chrome/Edge)
                if ('showDirectoryPicker' in window) {
                    const directoryHandle = await window.showDirectoryPicker();
                    // Note: We can't get the full path due to browser security
                    // Return the folder name and let user know they may need to enter full path
                    return directoryHandle.name;
                }
                
                // Fallback: Use file input with webkitdirectory
                return new Promise((resolve) => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.webkitdirectory = true;
                    input.style.display = 'none';
                    
                    input.onchange = function(e) {
                        const files = e.target.files;
                        if (files && files.length > 0) {
                            // Get folder path from first file
                            const fullPath = files[0].webkitRelativePath;
                            const folderName = fullPath.substring(0, fullPath.indexOf('/'));
                            // Note: Browser security prevents getting full file system path
                            // Return folder name - user may need to complete the path
                            resolve(folderName);
                        } else {
                            resolve(null);
                        }
                        document.body.removeChild(input);
                    };
                    
                    input.oncancel = function() {
                        resolve(null);
                        document.body.removeChild(input);
                    };
                    
                    document.body.appendChild(input);
                    input.click();
                });
            } catch (error) {
                console.error('Error selecting folder:', error);
                // If user cancels or error occurs, return null
                return null;
            }
        };

        // Register Service Worker for PWA support
        // Wait for Blazor to be ready to avoid conflicts
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('[PWA] Service Worker registered successfully:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('[PWA] Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>

