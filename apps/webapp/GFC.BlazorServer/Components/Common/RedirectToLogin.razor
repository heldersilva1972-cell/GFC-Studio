@inject NavigationManager Navigation

<div class="text-center text-muted py-5">
    <div class="spinner-border spinner-border-sm mb-2" role="status" aria-hidden="true"></div>
    <div>Redirecting to login...</div>
</div>

@code {
    private bool _navigationTriggered;

    protected override void OnInitialized()
    {
        if (_navigationTriggered)
        {
            return;
        }

        _navigationTriggered = true;

        var destination = BuildDestination();
        if (!string.IsNullOrWhiteSpace(destination))
        {
            Navigation.NavigateTo(destination, forceLoad: true);
        }
    }

    private string BuildDestination()
    {
        var relativePath = Navigation.ToBaseRelativePath(Navigation.Uri);
        var normalizedPath = NormalizeRelativePath(relativePath);

        if (IsLoginPath(normalizedPath))
        {
            return "/login";
        }

        var encodedReturnUrl = Uri.EscapeDataString(normalizedPath);
        return $"/login?returnUrl={encodedReturnUrl}";
    }

    private static string NormalizeRelativePath(string? relativePath)
    {
        if (string.IsNullOrWhiteSpace(relativePath))
        {
            return "/";
        }

        var trimmed = relativePath.Trim();
        return trimmed.StartsWith('/') ? trimmed : "/" + trimmed;
    }

    private static bool IsLoginPath(string path)
    {
        if (string.IsNullOrWhiteSpace(path))
        {
            return false;
        }

        var questionIndex = path.IndexOf('?', StringComparison.Ordinal);
        var comparisonTarget = questionIndex >= 0 ? path[..questionIndex] : path;
        return comparisonTarget.Equals("/login", StringComparison.OrdinalIgnoreCase);
    }
}

