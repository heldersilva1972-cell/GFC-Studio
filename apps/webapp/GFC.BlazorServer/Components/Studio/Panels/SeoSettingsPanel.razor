// [NEW]
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject ISeoService SeoService
@inject ToastService ToastService

<div class="seo-panel-container">
    <h4>SEO & Performance</h4>

    <div class="form-group">
        <label>Meta Title</label>
        <input @bind="Settings.MetaTitle" @bind:event="oninput" class="form-control" maxlength="70" />
        <small class="@GetTitleCharCountClass()">@Settings.MetaTitle?.Length / 70 chars</small>
    </div>

    <div class="form-group">
        <label>Meta Description</label>
        <textarea @bind="Settings.MetaDescription" @bind:event="oninput" class="form-control" maxlength="160"></textarea>
        <small class="@GetDescCharCountClass()">@Settings.MetaDescription?.Length / 160 chars</small>
    </div>

    <div class="form-group">
        <label>Open Graph Image</label>
        <div class="og-image-preview">
            @if (!string.IsNullOrEmpty(Settings.OpenGraphImageUrl))
            {
                <img src="@Settings.OpenGraphImageUrl" alt="Open Graph Preview" />
            }
            else
            {
                <div class="placeholder">No Image Selected</div>
            }
        </div>
        <button class="btn btn-secondary btn-sm" @onclick="OpenMediaLibrary">Choose Image</button>
    </div>

    <div class="performance-warnings">
        <h5>Real-time Warnings</h5>
        <ul>
            @if(string.IsNullOrWhiteSpace(Settings.MetaTitle))
            {
                <li class="warning">Missing Meta Title</li>
            }
            @if(string.IsNullOrWhiteSpace(Settings.MetaDescription))
            {
                <li class="warning">Missing Meta Description</li>
            }
            @* Placeholder for more advanced checks *@
            <li class="info">Missing Alt Text check not yet implemented.</li>
            <li class="info">Page Load Speed estimate not yet implemented.</li>
        </ul>
    </div>

    <button class="btn btn-success" @onclick="SaveChanges">Save SEO Settings</button>
</div>

@code {
    [Parameter]
    public int StudioPageId { get; set; }

    private SeoSettings Settings { get; set; } = new SeoSettings();

    // In a real app, you'd have a modal service to show the AssetBrowser
    // For now, this is a placeholder for the event.
    [Parameter]
    public EventCallback OnChooseImage { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (StudioPageId > 0)
        {
            Settings = await SeoService.GetSeoSettingsForPageAsync(StudioPageId);
        }
    }

    private async Task SaveChanges()
    {
        try
        {
            await SeoService.SaveSeoSettingsAsync(Settings);
            ToastService.ShowSuccess("SEO settings saved successfully!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to save settings: {ex.Message}");
        }
    }

    private async Task OpenMediaLibrary()
    {
        // This would typically open the AssetBrowser modal.
        // The parent component would handle the modal visibility and the OnAssetSelected callback.
        await OnChooseImage.InvokeAsync();
        ToastService.ShowInfo("Media library would open here.");
    }

    // Simple color-coding for character counts
    private string GetTitleCharCountClass() => Settings.MetaTitle?.Length > 60 ? "text-success" : "text-warning";
    private string GetDescCharCountClass() => Settings.MetaDescription?.Length > 150 ? "text-success" : "text-warning";
}
