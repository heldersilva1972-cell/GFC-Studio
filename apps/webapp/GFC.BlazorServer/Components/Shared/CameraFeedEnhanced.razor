<!-- [NEW] -->
@using System
@using System.Collections.Generic
@using System.Threading.Tasks
@using Microsoft.Extensions.Logging

@inject ICameraService CameraService
@inject IJSRuntime JS
@inject IConfiguration Configuration
@inject ILogger<CameraFeedEnhanced> _logger
@implements IAsyncDisposable

<div class="camera-feed-enhanced">
    <div class="video-container">
        <video id="camera-@CameraId" class="camera-video" controls autoplay muted @ref="videoElement"></video>

        @if (IsLoading)
        {
            <div class="loading-overlay">
                <div class="spinner-border text-light" role="status"></div>
                <p class="mt-2 small">Connecting...</p>
            </div>
        }

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="error-overlay">
                <i class="bi bi-exclamation-triangle-fill text-warning mb-2" style="font-size: 2rem;"></i>
                <h6 class="mb-2">@ErrorMessage</h6>
                <button class="btn btn-primary btn-sm" @onclick="RetryConnection">
                    <i class="bi bi-arrow-clockwise"></i> Retry
                </button>
            </div>
        }

        @if (ShowControls && !IsLoading && string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="controls-overlay">
                <div class="top-controls">
                    <div class="quality-selector">
                        <select class="form-select form-select-sm" @onchange="OnQualityChange">
                            @foreach (var quality in availableQualities)
                            {
                                <option value="@quality">@quality</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="bottom-controls">
                    <button class="btn btn-sm btn-outline-light" @onclick="CaptureSnapshot">
                        <i class="bi bi-camera"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" @onclick="ToggleFullscreen">
                        <i class="bi bi-fullscreen"></i>
                    </button>
                </div>

                @if (EnablePTZ && capabilities?.SupportsPTZ == true)
                {
                    <div class="ptz-control-popup">
                        <PTZControls OnCommand="HandlePTZCommand" />
                    </div>
                }
            </div>
        }
    </div>
    <div class="feed-footer">
        <div class="camera-title">
            <i class="bi bi-camera-video me-1"></i>
            @CameraName
        </div>
        <div class="stream-status-badge @StatusClass">
            <i class="bi @StatusIcon me-1"></i>
            @StreamStatus
        </div>
    </div>
</div>

@code {
    [Parameter] public int CameraId { get; set; }
    [Parameter] public string? CameraName { get; set; }
    [Parameter] public bool ShowControls { get; set; } = true;
    [Parameter] public bool EnablePTZ { get; set; } = false;
    [Parameter] public EventCallback OnFullscreen { get; set; }
    [Parameter] public EventCallback<string> OnSnapshot { get; set; }

    private ElementReference videoElement;
    private IJSObjectReference? hlsPlayer;
    private string StreamUrl = "";
    private string StreamStatus = "Connecting...";
    private string StatusClass = "connecting";
    private string StatusIcon = "bi-hourglass-split";
    private bool IsLoading = true;
    private string? ErrorMessage = null;

    private CameraCapabilities? capabilities;
    private List<StreamQuality> availableQualities = new();

    protected override async Task OnInitializedAsync()
    {
        CameraName ??= $"Camera {CameraId}";
        await LoadCapabilities();
    }

    private async Task LoadCapabilities()
    {
        try
        {
            capabilities = await CameraService.GetCameraCapabilitiesAsync(CameraId);
            availableQualities = capabilities.AvailableQualities;
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to load camera capabilities.";
            _logger.LogError(ex, ErrorMessage);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeStream();
        }
    }

    private async Task InitializeStream()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = null;
            StateHasChanged();

            var videoAgentUrl = Configuration["VideoAgent:BaseUrl"] ?? "https://localhost:5101";
            StreamUrl = $"{videoAgentUrl}/stream/camera{CameraId}.m3u8";

            hlsPlayer = await JS.InvokeAsync<IJSObjectReference>("CameraPlayer.init", $"camera-{CameraId}", StreamUrl);
            await Task.Delay(1500); // Simulate network delay

            StreamStatus = "LIVE";
            StatusClass = "live";
            StatusIcon = "bi-circle-fill";
        }
        catch (Exception ex)
        {
            ErrorMessage = "Connection Failed";
            StreamStatus = "Offline";
            StatusClass = "offline";
            StatusIcon = "bi-x-circle-fill";
            _logger.LogError(ex, ErrorMessage);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RetryConnection()
    {
        await InitializeStream();
    }

    private async Task OnQualityChange(ChangeEventArgs e)
    {
        if (Enum.TryParse<StreamQuality>(e.Value?.ToString(), out var quality))
        {
            await CameraService.SetStreamQualityAsync(CameraId, quality);
            await JS.InvokeVoidAsync("CameraPlayer.setQuality", hlsPlayer, StreamUrl);
        }
    }

    private async Task CaptureSnapshot()
    {
        try
        {
            var snapshotBytes = await CameraService.CaptureSnapshotAsync(CameraId);
            var base64Image = Convert.ToBase64String(snapshotBytes);
            var fileName = $"snapshot_{CameraName?.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.jpg";
            await JS.InvokeVoidAsync("downloadFile", fileName, base64Image, "image/jpeg");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to capture or download snapshot for Camera {CameraId}", CameraId);
            ErrorMessage = "Snapshot failed.";
            StateHasChanged();
        }
    }

    private async Task ToggleFullscreen()
    {
        await OnFullscreen.InvokeAsync();
    }

    private async Task HandlePTZCommand(PTZAction action)
    {
        await CameraService.SendPTZCommandAsync(CameraId, new PTZCommand { Action = action });
    }

    public async ValueTask DisposeAsync()
    {
        if (hlsPlayer != null)
        {
            try
            {
                await JS.InvokeVoidAsync("CameraPlayer.destroy", hlsPlayer);
            }
            catch (JSDisconnectedException) { /* Ignored */ }
            finally
            {
                await hlsPlayer.DisposeAsync();
            }
        }
    }
}
