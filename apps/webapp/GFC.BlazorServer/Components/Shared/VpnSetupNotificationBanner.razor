// [NEW]
@inject IVpnSetupService VpnSetupService
@inject NavigationManager NavigationManager
@inject CustomAuthenticationStateProvider AuthStateProvider

<CascadingAuthenticationState>
    <AuthorizeView>
        <Authorized>
            @if (_showBanner)
            {
                <MudAlert Severity="Severity.Info" Class="mb-4" Variant="Variant.Outlined">
                    <div class="d-flex align-center">
                        <MudText>
                            <strong>Action Required:</strong> To view cameras remotely, please complete the one-time secure access setup.
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Info" Size="Size.Small" OnClick="GoToSetup" Class="ml-auto">
                            Start Setup
                        </MudButton>
                    </div>
                </MudAlert>
            }
        </Authorized>
    </AuthorizeView>
</CascadingAuthenticationState>

@code {
    private bool _showBanner = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userIdClaim = user.FindFirst("UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var userId))
            {
                // In a real implementation, we'd also check for specific camera permissions here.
                _showBanner = await VpnSetupService.IsSetupRequiredAsync(userId);
            }
        }
    }

    private void GoToSetup()
    {
        NavigationManager.NavigateTo("/cameras/secure-access");
    }
}
