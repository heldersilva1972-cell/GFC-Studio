@using GFC.Core.Models.Diagnostics
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<div class="chart-container">
    <canvas id="@_chartId"></canvas>
</div>

@code {
    [Parameter]
    public List<PerformanceSnapshot> Snapshots { get; set; }

    [Parameter]
    public string Metric { get; set; }

    private string _chartId = $"chart-{Guid.NewGuid()}";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Snapshots != null && Snapshots.Any())
        {
            await JSRuntime.InvokeVoidAsync("renderChart", _chartId, GetChartData());
        }
    }

    private object GetChartData()
    {
        var labels = Snapshots.Select(s => s.Timestamp.ToString("HH:mm")).ToList();
        var data = Snapshots.Select(s => GetMetricValue(s)).ToList();

        return new
        {
            type = "line",
            data = new
            {
                labels = labels,
                datasets = new[]
                {
                    new
                    {
                        label = Metric,
                        data = data,
                        borderColor = "rgba(75, 192, 192, 1)",
                        backgroundColor = "rgba(75, 192, 192, 0.2)",
                        fill = true
                    }
                }
            },
            options = new
            {
                responsive = true,
                maintainAspectRatio = false
            }
        };
    }

    private double GetMetricValue(PerformanceSnapshot snapshot)
    {
        return Metric switch
        {
            "CPU" => snapshot.CpuUsage,
            "Memory" => snapshot.MemoryUsagePercentage,
            "Connections" => snapshot.ActiveConnections,
            "Requests" => snapshot.RequestsPerMinute,
            _ => 0
        };
    }
}
