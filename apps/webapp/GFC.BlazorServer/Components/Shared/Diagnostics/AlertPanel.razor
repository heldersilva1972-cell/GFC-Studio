@using GFC.Core.Models.Diagnostics
@using GFC.BlazorServer.Services.Diagnostics
@inject IAlertManagementService AlertManagementService
@inject IBlazorSystemSettingsService SystemSettingsService

<div class="alert-panel">
    <h4>Active Alerts</h4>
    @if (ActiveAlerts == null || !ActiveAlerts.Any())
    {
        <p>No active alerts.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Level</th>
                    <th>Triggered Value</th>
                    <th>Timestamp</th>
                    <th>Acknowledge</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var alert in ActiveAlerts)
                {
                    <tr>
                        <td>@alert.AlertThreshold.MetricType</td>
                        <td>@alert.AlertThreshold.AlertLevel</td>
                        <td>@alert.TriggerValue</td>
                        <td>@FormatTimestamp(alert.Timestamp)</td>
                        <td>
                            <button class="btn btn-sm btn-primary" @onclick="() => AcknowledgeAlert(alert.Id)">
                                Acknowledge
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    [Parameter]
    public List<DiagnosticAlert> ActiveAlerts { get; set; }

    [Parameter]
    public EventCallback OnAlertAcknowledged { get; set; }

    private async Task AcknowledgeAlert(Guid alertId)
    {
        // For simplicity, we'll use a hardcoded user. In a real app, you'd get this from the auth context.
        await AlertManagementService.AcknowledgeAlertAsync(alertId, "admin");
        await OnAlertAcknowledged.InvokeAsync();
    }

    private TimeZoneInfo _systemTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var settings = await SystemSettingsService.GetAsync();
            _systemTimeZone = TimeZoneInfo.FindSystemTimeZoneById(settings.SystemTimeZoneId ?? "Eastern Standard Time");
        }
        catch (Exception ex)
        {
            _systemTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");
        }
    }

    private string FormatTimestamp(DateTime utcTime)
    {
        return TimeZoneInfo.ConvertTimeFromUtc(utcTime, _systemTimeZone).ToString("yyyy-MM-dd HH:mm:ss");
    }
}
