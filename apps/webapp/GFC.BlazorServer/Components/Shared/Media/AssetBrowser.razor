// [NEW]
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject GFC.BlazorServer.Services.IMediaAssetService MediaAssetService
@inject ToastService ToastService

<div class="asset-browser-modal">
    <div class="asset-browser-content">
        <div class="asset-browser-header">
            <h3>Media Library</h3>
            <button class="close-btn" @onclick="CloseModal">&times;</button>
        </div>
        <div class="asset-browser-body">
            @if (_showEditModal && _editingAsset != null)
            {
                <div class="edit-modal">
                    <h4>Edit Asset Visibility</h4>
                    <p>Asset: <strong>@_editingAsset.FileName</strong></p>
                    <div class="form-group">
                        <label for="role-select">Required Role</label>
                        <select id="role-select" class="form-control" @bind="_editingAsset.RequiredRole">
                            <option value="">Public</option>
                            <option value="Admin">Admin</option>
                            <option value="Member">Member</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" @onclick="SaveAssetRole">Save</button>
                    <button class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                </div>
            }
            <div class="upload-section">
                <h4>Upload New Asset</h4>
                <InputFile OnChange="HandleFileSelected" />
                @if (_isLoading)
                {
                    <p>Uploading...</p>
                }
            </div>
            <div class="gallery-section">
                <h4>Existing Assets</h4>
                @if (_assets == null)
                {
                    <p>Loading assets...</p>
                }
                else
                {
                    <div class="asset-grid">
                        @foreach (var asset in _assets)
                        {
                            <div class="asset-card">
                                <img src="@GetThumbnailUrl(asset)" alt="@asset.FileName" @onclick="() => SelectAsset(asset)" />
                                <p>@asset.FileName</p>
                                <button class="btn btn-sm btn-secondary" @onclick="() => OpenEditModal(asset)">Edit</button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<MediaAsset> OnAssetSelected { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private List<MediaAsset> _assets;
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadAssets();
    }

    private async Task LoadAssets()
    {
        _assets = await MediaAssetService.GetAllAssetsAsync();
        StateHasChanged();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            await MediaAssetService.CreateAssetAsync(e.File, "General");
            ToastService.ShowSuccess("File uploaded successfully!");
            await LoadAssets();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Upload failed: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SelectAsset(MediaAsset asset)
    {
        await OnAssetSelected.InvokeAsync(asset);
    }

    private async Task CloseModal()
    {
        await OnClose.InvokeAsync();
    }

    private MediaAsset _editingAsset;
    private bool _showEditModal = false;

    private void OpenEditModal(MediaAsset asset)
    {
        _editingAsset = asset;
        _showEditModal = true;
    }

    private void CloseEditModal()
    {
        _editingAsset = null;
        _showEditModal = false;
    }

    private async Task SaveAssetRole()
    {
        if (_editingAsset != null)
        {
            await MediaAssetService.UpdateAssetRoleAsync(_editingAsset.Id, _editingAsset.RequiredRole);
            ToastService.ShowSuccess("Asset visibility updated successfully!");
            CloseEditModal();
        }
    }

    private string GetThumbnailUrl(MediaAsset asset)
    {
        // Prefer mobile-sized WebP for thumbnail preview
        var rendition = asset.Renditions?.FirstOrDefault(r => r.RenditionType == "mobile-webp");
        return rendition?.Url ?? "/images/placeholder.png";
    }
}
