@using GFC.Core.Models
@using System.Text.Json
@using GFC.BlazorServer.Components.Shared.Media

<div class="property-inspector">
    <h5>Properties Inspector</h5>
    @if (TargetSection != null)
    {
        <div class="p-3">
            <h6 class="border-bottom pb-2 mb-3">@TargetSection.sectionType</h6>

            @switch (TargetSection.sectionType)
            {
                case "Hero":
                    <div class="form-group">
                        <label>Headline</label>
                        <input type="text" class="form-control"
                               value="@(TargetSection.properties.ContainsKey("headline") ? TargetSection.properties["headline"].ToString() : "")"
                               @onchange="@((e) => HandlePropertyChanged("headline", e.Value.ToString()))" />
                    </div>
                    <div class="form-group">
                        <label>Background Image</label>
                        <button class="btn btn-secondary" @onclick="() => _showMediaLibrary = true">Choose Image</button>
                    </div>
                    break;

                case "RichTextBlock":
                    <div class="form-group">
                        <label>Content</label>
                        <textarea class="form-control" rows="5"
                                  value="@(TargetSection.properties.ContainsKey("content") ? TargetSection.properties["content"].ToString() : "")"
                                  @onchange="@((e) => HandlePropertyChanged("content", e.Value.ToString()))"></textarea>
                    </div>
                    break;

                case "ButtonCTA":
                    <div class="form-group">
                        <label>Text</label>
                        <input type="text" class="form-control"
                               value="@(TargetSection.properties.ContainsKey("text") ? TargetSection.properties["text"].ToString() : "")"
                               @onchange="@((e) => HandlePropertyChanged("text", e.Value.ToString()))" />
                    </div>
                    <div class="form-group">
                        <label>Link</label>
                        <input type="text" class="form-control"
                               value="@(TargetSection.properties.ContainsKey("link") ? TargetSection.properties["link"].ToString() : "")"
                               @onchange="@((e) => HandlePropertyChanged("link", e.Value.ToString()))" />
                    </div>
                    <ColorPicker Label="Button Color"
                                 Value="@(TargetSection.properties.ContainsKey("backgroundColor") ? TargetSection.properties["backgroundColor"].ToString() : "#007bff")"
                                 ValueChanged="@((v) => HandlePropertyChanged("backgroundColor", v))" />
                    break;

                default:
                    <p class="text-muted">No properties available for this component.</p>
                    <pre>@JsonSerializer.Serialize(TargetSection.properties, new JsonSerializerOptions { WriteIndented = true })</pre>
                    break;
            }
        </div>
    }
    else
    {
        <p class="text-muted p-3">Select a component to see its properties.</p>
    }
</div>

@if (_showMediaLibrary)
{
    <MediaLibrary OnAssetSelected="HandleAssetSelected" OnClose="CloseMediaLibrary" />
}

@code {
    [Parameter]
    public StudioSection TargetSection { get; set; }

    [Parameter]
    public EventCallback<(string sectionId, string propertyName, object propertyValue)> OnPropertyChanged { get; set; }

    [Parameter]
    public EventCallback<MediaAsset> OnAssetChanged { get; set; }

    private bool _showMediaLibrary = false;

    private async Task HandlePropertyChanged(string propertyName, object value)
    {
        if (TargetSection != null)
        {
            if (TargetSection.properties.ContainsKey(propertyName))
            {
                TargetSection.properties[propertyName] = value;
            }
            else
            {
                TargetSection.properties.Add(propertyName, value);
            }

            await OnPropertyChanged.InvokeAsync((TargetSection.ClientId.ToString(), propertyName, value));
            StateHasChanged();
        }
    }

    private async Task HandleAssetSelected(MediaAsset asset)
    {
        await OnAssetChanged.InvokeAsync(asset);
        await HandlePropertyChanged("backgroundImage", asset.Renditions.FirstOrDefault()?.Url);
        CloseMediaLibrary();
    }

    private void CloseMediaLibrary()
    {
        _showMediaLibrary = false;
        StateHasChanged();
    }

    public class WizardWarning
    {
        public string Message { get; set; }
        public string Severity { get; set; } = "Warning";
    }

    public List<WizardWarning> Warnings { get; set; } = new();
}
