@page "/members"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using System.Globalization
@using GFC.Core.BusinessRules
@using GFC.Core.DTOs
@using GFC.Core.Enums
@using GFC.Core.Interfaces
@using GFC.Core.Models
@inject IMemberQueryService MemberQueryService
@inject IMemberRepository MemberRepository
@inject ILogger<Members> Logger
@inject NavigationManager NavManager
@implements IDisposable

<div class="page-header align-items-center flex-wrap gap-3">
    <div>
        <h1 class="page-title mb-0">Members</h1>
    </div>
    <div class="ms-auto">
        <button class="btn btn-primary btn-lg" type="button" @onclick="NavigateToAdd">
            <i class="bi bi-plus-circle me-1"></i>
            Add Member
        </button>
    </div>
</div>

<div class="filter-bar">
    <div class="filter-row">
        <div class="filter-group search-group">
            <label class="filter-label" for="member-search">Search members</label>
            <div class="search-input">
                <i class="bi bi-search text-muted"></i>
                <input id="member-search"
                       class="form-control"
                       placeholder="Search by name, ID, email, or phone"
                       @bind="_searchTerm"
                       @bind:event="oninput"
                       @bind:after="OnSearchChanged"
                       disabled="@_isLoading" />
                @if (!string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <button type="button"
                            class="btn btn-clear"
                            @onclick="ClearSearch"
                            title="Clear search"
                            aria-label="Clear search"
                            disabled="@_isLoading">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
            </div>
        </div>

        <div class="filter-group sort-group">
            <label class="filter-label" for="member-sort">Sort by</label>
            <select id="member-sort"
                    class="form-select"
                    @bind="_sortOption"
                    @bind:after="() => ApplyFilters()"
                    disabled="@_isLoading">
                <option value="name">Name (A–Z)</option>
                <option value="status">Status</option>
                <option value="dues">Dues Status</option>
                <option value="id">Member ID</option>
            </select>
        </div>

        <div class="filter-group indicator-group">
            @if (HasActiveFilters)
            {
                <span class="badge filter-active-badge">
                    <i class="bi bi-funnel-fill me-1"></i>
                    Filters active
                </span>
            }
        </div>
    </div>

    <div class="filter-row chips-row">
        <div class="filter-group full-width">
            <label class="filter-label">Status filter</label>
            <div class="status-chips" role="list">
                @foreach (var chip in _statusChips)
                {
                    <button type="button"
                            role="listitem"
                            class="status-chip @(IsChipActive(chip.Value) ? "active" : string.Empty)"
                            style="--chip-color:@chip.Color"
                            @onclick="() => SetStatusFilter(chip.Value)"
                            disabled="@_isLoading">
                        @chip.Label
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@if (_isLoading)
{
    <div class="members-list skeleton-list" aria-live="polite">
        @for (var i = 0; i < 6; i++)
        {
            <div class="member-row skeleton">
                <div class="member-row-main">
                    <div class="skeleton-line w-50"></div>
                    <div class="skeleton-line w-30"></div>
                </div>
                <div class="member-row-badges">
                    <div class="skeleton-pill w-20"></div>
                    <div class="skeleton-pill w-16"></div>
                </div>
            </div>
        }
    </div>
}
else if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="alert alert-danger small d-flex align-items-center justify-content-between mb-3">
        <span>@_errorMessage</span>
        <button class="btn btn-outline-danger btn-sm" type="button" @onclick="LoadMembersAsync">Retry</button>
    </div>
}
else
{
    @if (_filteredMembers.Count == 0)
    {
        <div class="empty-state">
            <p class="mb-1 fw-semibold">No members found</p>
            <p class="text-muted small mb-2">Try clearing filters or search terms.</p>
            @if (HasActiveFilters)
            {
                <button class="btn btn-outline-secondary btn-sm" type="button" @onclick="ClearFilters" disabled="@_isLoading">
                    Clear filters
                </button>
            }
        </div>
    }
    else
    {
        @if (SelectedCount > 0)
        {
            <div class="bulk-actions-bar">
                <div class="bulk-actions-info">
                    <span class="bulk-count">@SelectedCount selected</span>
                </div>
                <div class="bulk-actions-controls">
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled>Export</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled>Set Status</button>
                    <button type="button" class="btn btn-link btn-sm text-danger" @onclick="ClearSelection">Clear Selection</button>
                </div>
            </div>
        }
        <div class="members-list">
            <div class="members-list-header">
                <label class="select-all-toggle">
                    <input type="checkbox"
                           class="form-check-input"
                           checked="@IsAllVisibleSelected"
                           disabled="@(_filteredMembers.Count == 0)"
                           @onclick:stopPropagation="true"
                           @onchange="ToggleSelectAll"
                           aria-label="Select all members on current view" />
                    <span>Select all on current view</span>
                </label>
            </div>
            <Virtualize Items="_filteredMembers" Context="member" ItemSize="96">
                <div class="member-row-wrapper">
                    <div class="member-select">
                        <input type="checkbox"
                               class="form-check-input"
                               checked="@IsSelected(member.MemberId)"
                               @onclick:stopPropagation="true"
                               @onchange="@CreateSelectionCallback(member.MemberId)"
                               aria-label="@($"Select {GetMemberDisplayName(member)}")" />
                    </div>
                    <div class="member-row @(IsSelected(member.MemberId) ? "selected" : string.Empty)"
                         tabindex="0"
                         role="button"
                         aria-label="@($"Open {GetMemberDisplayName(member)}")"
                         @onclick="@CreateRowClickCallback(member.MemberId)"
                         @onkeydown="(KeyboardEventArgs e) => OnRowKeyDown(e, member.MemberId)">
                        <div class="member-row-main">
                            <div class="member-primary">
                                <div class="member-name-line">
                                    <div class="member-name">@member.FullName</div>
                                    <div class="member-row-badges">
                                        <span class="pill badge status-badge @GetStatusBadgeClass(member.Status)">
                                            @GetStatusLabel(member.Status)
                                        </span>
                                        @if (!string.IsNullOrWhiteSpace(member.DuesStatus))
                                        {
                                            <span class="pill badge dues-badge @GetDuesBadgeClass(member.DuesStatus)">
                                                @GetDuesLabel(member.DuesStatus)
                                            </span>
                                        }
                                    </div>
                                </div>
                                <div class="member-sub">
                                    <span class="member-id">ID #@member.MemberId</span>
                                    <span class="dot">•</span>
                                    <span class="member-location">@(!string.IsNullOrWhiteSpace(member.City) ? member.City : "City —")</span>
                                    <span class="dot">•</span>
                                    <span class="member-queue">@((member.IsNonPortuguese ? "NP Queue" : "Portuguese"))</span>
                                </div>
                            </div>
                        </div>
                        <div class="member-row-meta">
                            <span>@(member.MemberSince.HasValue ? $"Joined {FormatDate(member.MemberSince)}" : "Join date —")</span>
                            <span>Key Cards: @member.KeyCardCount</span>
                            <span>Status: @GetStatusLabel(member.Status)</span>
                            <span>Dues: @GetDuesLabel(member.DuesStatus)</span>
                        </div>
                    </div>
                </div>
            </Virtualize>
                                </div>
    }
}

<style>
    .bulk-actions-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px 14px;
        margin-bottom: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        background: linear-gradient(0deg, rgba(37, 99, 235, 0.04), rgba(37, 99, 235, 0.04)), #ffffff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        min-height: 64px;
    }

    .bulk-actions-info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        color: #0f172a;
    }

    .bulk-actions-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }

    .bulk-count {
        font-size: 0.95rem;
    }

    .filter-bar {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 14px;
        margin-bottom: 16px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 220px;
    }

    .filter-group.full-width {
        min-width: 100%;
    }

    .filter-label {
        font-size: 0.9rem;
        font-weight: 700;
        color: #374151;
        margin-bottom: 0;
    }

    .search-input {
        position: relative;
    }

    .search-input i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }

    .search-input .form-control {
        padding-left: 38px;
        padding-right: 38px;
        height: 44px;
    }

    .btn-clear {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        width: 34px;
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 8px;
        background: transparent;
        color: #6b7280;
        transition: background-color 0.15s ease, color 0.15s ease;
    }

    .btn-clear:hover {
        background: #e5e7eb;
        color: #111827;
    }

    .btn-clear:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: transparent;
    }

    .status-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .status-chip {
        border: 1px solid #e5e7eb;
        background: #ffffff;
        color: #374151;
        padding: 8px 12px;
        border-radius: 10px;
        font-weight: 700;
        transition: background-color 0.15s ease, border-color 0.15s ease, transform 0.15s ease;
    }

    .status-chip:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
    }

    .status-chip.active {
        background: var(--chip-color);
        color: #ffffff;
        border-color: transparent;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
    }

    .status-chip:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
    }

    .indicator-group {
        display: flex;
        flex: 0 0 160px;
        min-width: 160px;
        justify-content: flex-end;
    }

    .filter-active-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        background: #dcfce7;
        color: #166534;
        font-weight: 700;
        border: 1px solid #bbf7d0;
    }

    .sort-group select {
        min-width: 180px;
    }

    .chips-row {
        align-items: flex-start;
    }

    @@media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group,
        .indicator-group {
            min-width: 100%;
        }

        .indicator-group {
            justify-content: flex-start;
        }
    }

    .members-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .members-list-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border: 1px dashed #d1d5db;
        border-radius: 10px;
        background: #f8fafc;
    }

    .select-all-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0;
    }

    .member-row-wrapper {
        display: grid;
        grid-template-columns: 44px 1fr;
        gap: 10px;
        align-items: stretch;
    }

    .member-select {
        display: flex;
        align-items: center;
        justify-content: center;
        padding-top: 0;
    }

    .member-row {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px 16px;
        background: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        cursor: pointer;
        position: relative;
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
    }

    .member-row:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
        transform: translateY(-1px);
    }

    .btn-clear:focus-visible,
    .status-chip:focus-visible,
    .bulk-actions-controls .btn:focus-visible {
        outline: 2px solid #2563eb;
        outline-offset: 2px;
    }

    .form-check-input:focus-visible {
        outline: 2px solid #2563eb;
        outline-offset: 2px;
        box-shadow: none;
    }

    .member-row:focus-visible {
        border-color: #3b82f6;
        box-shadow:
            0 0 0 2px rgba(59, 130, 246, 0.35),
            0 8px 24px rgba(0, 0, 0, 0.08);
        background: linear-gradient(0deg, rgba(59, 130, 246, 0.06), rgba(59, 130, 246, 0.06)), #ffffff;
    }

    .member-row.selected {
        border-color: #2563eb;
        background: linear-gradient(0deg, rgba(37, 99, 235, 0.08), rgba(37, 99, 235, 0.08)), #ffffff;
        box-shadow:
            0 0 0 1px rgba(37, 99, 235, 0.25),
            0 10px 28px rgba(37, 99, 235, 0.12);
        transform: translateY(-1px);
    }

    .member-row-main {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .member-primary {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .member-name-line {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        align-items: flex-start;
        column-gap: 12px;
        row-gap: 8px;
    }

    .member-name {
        font-size: 1.05rem;
        font-weight: 700;
        color: #111827;
        min-width: 0;
        word-break: break-word;
    }

    .member-sub {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .member-id {
        font-weight: 600;
        color: #374151;
    }

    .dot {
        color: #d1d5db;
    }

    .member-row-badges {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        row-gap: 6px;
        flex-wrap: wrap;
        flex-shrink: 0;
        min-width: 0;
    }

    .pill {
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.85rem;
        font-weight: 700;
        line-height: 1;
        border: none;
        white-space: nowrap;
    }

    .status-badge {
        color: #0f172a;
        background: #e5e7eb;
    }

    .status-regular { background: #16a34a; color: #ffffff; }
    .status-regular-np { background: #0ea5e9; color: #ffffff; }
    .status-guest { background: #6b7280; color: #ffffff; }
    .status-life { background: #d6b33d; color: #1f2937; }
    .status-inactive { background: #ef4444; color: #ffffff; }
    .status-deceased { background: #b91c1c; color: #ffffff; }
    .status-rejected { background: #7f1d1d; color: #ffffff; }

    .dues-badge {
        background: #e5e7eb;
        color: #111827;
    }

    .dues-paid { background: #16a34a; color: #ffffff; }
    .dues-overdue { background: #f97316; color: #111827; }
    .dues-waived { background: #6b7280; color: #ffffff; }
    .dues-life { background: #d6b33d; color: #1f2937; }

    .member-row-meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 8px;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .skeleton-list {
        gap: 0.6rem;
    }

    .skeleton-line {
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
        background-size: 200% 100%;
        animation: shimmer 1.2s infinite;
    }

    .skeleton-pill {
        height: 22px;
        border-radius: 999px;
        background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
        background-size: 200% 100%;
        animation: shimmer 1.2s infinite;
    }

    .w-50 { width: 50%; }
    .w-30 { width: 30%; }
    .w-20 { width: 20%; }
    .w-16 { width: 16%; }

    @@keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    @@media (max-width: 1024px) {
        .member-row {
            padding: 12px 14px;
        }

        .member-name-line {
            align-items: flex-start;
        }

        .member-row-badges {
            justify-content: flex-start;
        }

        .member-row-meta {
            flex-direction: column;
            gap: 6px;
        }
    }

    @@media (max-width: 640px) {
        .bulk-actions-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .bulk-actions-controls {
            width: 100%;
            justify-content: flex-start;
        }

        .member-row-wrapper {
            grid-template-columns: 40px 1fr;
        }

        .member-name-line {
            grid-template-columns: 1fr;
        }

        .member-row {
            padding: 12px;
        }

        .member-row-main {
            gap: 8px;
        }

        .member-name-line {
            gap: 8px;
        }

        .member-name {
            font-size: 1rem;
        }

        .member-row-badges {
            width: 100%;
            justify-content: flex-start;
        }

        .member-sub {
            gap: 6px;
            font-size: 0.9rem;
        }

        .member-sub .dot,
        .member-sub .member-location {
            display: none;
        }

        .member-row-meta {
            display: none;
        }

        .pill {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
    }
</style>
@code {
    private readonly List<StatusChip> _statusChips = new()
    {
        new("all", "All", "#1f2937"),
        new("active", "Active", "#16a34a"),
        new("pastdue", "Past Due", "#f97316"),
        new("npqueue", "NP Queue", "#2563eb"),
        new("guest", "Guest", "#6b7280"),
        new("regular", "Regular", "#14b8a6"),
        new("life", "Life", "#d6b33d"),
        new("suspended", "Suspended", "#ef4444")
    };

    private List<MemberCardModel> _allMembers = new();
    private List<MemberCardModel> _filteredMembers = new();
    private string _searchTerm = string.Empty;
    private string _statusFilter = "all";
    private string _sortOption = "name";
    private bool HasActiveFilters =>
        !string.IsNullOrWhiteSpace(_searchTerm) || !IsChipActive("all");
    private bool _isLoading = true;
    private string? _errorMessage;
    private CancellationTokenSource? _debounceCts;

    protected override async Task OnInitializedAsync()
    {
        await LoadMembersAsync();
    }

    private async Task LoadMembersAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var listTask = MemberQueryService.GetMembersAsync(new MemberFilterOptions());
            var detailsTask = Task.Run(() => MemberRepository.GetAllMembers());

            await Task.WhenAll(listTask, detailsTask);

            var list = listTask.Result;
            var detailsLookup = detailsTask.Result.ToDictionary(m => m.MemberID);

            _allMembers = list
                .Select(item =>
                {
                    detailsLookup.TryGetValue(item.MemberId, out var detail);
                    var status = item.Status;
                    var normalized = MemberStatusHelper.NormalizeStatus(detail?.Status ?? status.ToString());
                    var duesStatus = status switch
                    {
            MemberStatus.Life => "Life",
                        MemberStatus.Inactive => "Past Due",
                        _ => "Paid"
                    };

                    return new MemberCardModel
                    {
                        MemberId = item.MemberId,
                        FullName = detail is null
                            ? item.FullName
                            : $"{detail.FirstName} {detail.LastName}".Trim(),
                        Status = status,
                        City = detail?.City,
                        Email = detail?.Email,
                        Phone = detail?.Phone ?? detail?.CellPhone,
                        MemberSince = item.MemberSince,
                        RegularSince = item.RegularSince,
                        IsNonPortuguese = item.IsNonPortuguese,
                        HasKeyCard = item.HasKeyCard,
                        InactiveDate = item.InactiveDate,
                        DuesStatus = duesStatus,
                        NormalizedStatus = normalized
                    };
                })
                .ToList();

            ApplyFilters();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[Members] Unable to load members");
            _errorMessage = "Unable to load members.";
            _allMembers = new();
            _filteredMembers = new();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ApplyFilters(ChangeEventArgs? _ = null)
    {
        IEnumerable<MemberCardModel> query = _allMembers;

        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            var term = _searchTerm.Trim();
            query = query.Where(m =>
                (!string.IsNullOrWhiteSpace(m.FullName) && m.FullName.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                m.MemberId.ToString().Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrWhiteSpace(m.Email) && m.Email.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrWhiteSpace(m.Phone) && m.Phone.Contains(term, StringComparison.OrdinalIgnoreCase)));
        }

        query = query.Where(MatchesStatusFilter);

        query = _sortOption switch
        {
            "status" => query.OrderBy(m => GetStatusLabel(m.Status)).ThenBy(m => m.FullName),
            "dues" => query.OrderBy(m => m.DuesStatus).ThenBy(m => m.FullName),
            "id" => query.OrderBy(m => m.MemberId),
            _ => query.OrderBy(m => m.FullName)
        };

        _filteredMembers = query.ToList();
        StateHasChanged();
    }

    private bool MatchesStatusFilter(MemberCardModel member) => _statusFilter switch
    {
        "active" => member.Status is MemberStatus.Regular or MemberStatus.RegularNonPortuguese or MemberStatus.Life,
        "pastdue" => string.Equals(member.DuesStatus, "Past Due", StringComparison.OrdinalIgnoreCase),
        "npqueue" => member.IsNonPortuguese,
        "guest" => member.Status == MemberStatus.Guest,
        "regular" => member.Status is MemberStatus.Regular or MemberStatus.RegularNonPortuguese,
        "life" => member.Status == MemberStatus.Life,
        "suspended" => member.Status == MemberStatus.Inactive,
        _ => true
    };

    private void OnSearchChanged()
    {
        _debounceCts?.Cancel();
        var cts = new CancellationTokenSource();
        _debounceCts = cts;

        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(200, cts.Token);
                if (!cts.IsCancellationRequested)
                {
                    ApplyFilters();
                }
            }
            catch (TaskCanceledException)
            {
                // ignore
            }
        });
    }

    private void ClearSearch()
    {
        _searchTerm = string.Empty;
        ApplyFilters();
    }

    private void ClearFilters()
    {
        _searchTerm = string.Empty;
        _statusFilter = "all";
        ApplyFilters();
    }

    private void SetStatusFilter(string value)
    {
        _statusFilter = value;
        ApplyFilters();
    }

    private bool IsChipActive(string value) => string.Equals(_statusFilter, value, StringComparison.OrdinalIgnoreCase);

    private readonly HashSet<int> _selectedMemberIds = new();

    private int SelectedCount => _selectedMemberIds.Count;

    private bool IsSelected(int memberId) => _selectedMemberIds.Contains(memberId);

    private bool IsAllVisibleSelected =>
        _filteredMembers.Count > 0 && _filteredMembers.All(m => _selectedMemberIds.Contains(m.MemberId));

    private string GetMemberDisplayName(MemberCardModel member) =>
        string.IsNullOrWhiteSpace(member.FullName) ? $"Member {member.MemberId}" : member.FullName;

    private void OnMemberRowClick(int memberId)
    {
        NavigateToMember(memberId);
    }

    private void OnRowKeyDown(KeyboardEventArgs e, int memberId)
    {
        if (e.Key == "Enter" || e.Key == " " || e.Key == "Spacebar")
        {
            NavigateToMember(memberId);
        }
    }

    private EventCallback<MouseEventArgs> CreateRowClickCallback(int memberId) =>
        EventCallback.Factory.Create<MouseEventArgs>(this, () => OnMemberRowClick(memberId));

    private void ToggleSelection(ChangeEventArgs e, int memberId)
    {
        var isChecked = e.Value is bool value && value;

        if (isChecked)
        {
            _selectedMemberIds.Add(memberId);
        }
        else
        {
            _selectedMemberIds.Remove(memberId);
        }
    }

    private EventCallback<ChangeEventArgs> CreateSelectionCallback(int memberId) =>
        EventCallback.Factory.Create<ChangeEventArgs>(this, e => ToggleSelection(e, memberId));

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        var isChecked = e.Value is bool value && value;

        if (isChecked)
        {
            foreach (var member in _filteredMembers)
            {
                _selectedMemberIds.Add(member.MemberId);
            }
        }
        else
        {
            foreach (var member in _filteredMembers)
            {
                _selectedMemberIds.Remove(member.MemberId);
            }
        }
    }

    private void ClearSelection()
    {
        if (_selectedMemberIds.Count == 0)
        {
            return;
        }

        _selectedMemberIds.Clear();
    }

    private static string GetStatusLabel(MemberStatus status) => status switch
    {
        MemberStatus.Regular => "Regular",
        MemberStatus.RegularNonPortuguese => "Regular-NP",
        MemberStatus.Guest => "Guest",
        MemberStatus.Life => "Life",
        MemberStatus.Inactive => "Suspended",
        MemberStatus.Deceased => "Deceased",
        MemberStatus.Rejected => "Rejected",
        _ => "Unknown"
    };

    private static string FormatDate(DateTime? value) =>
        value?.ToString("MMM d, yyyy", CultureInfo.InvariantCulture) ?? "—";

    private string GetStatusBadgeClass(MemberStatus status) => status switch
    {
        MemberStatus.Regular => "status-regular",
        MemberStatus.RegularNonPortuguese => "status-regular-np",
        MemberStatus.Guest => "status-guest",
        MemberStatus.Life => "status-life",
        MemberStatus.Inactive => "status-inactive",
        MemberStatus.Deceased => "status-deceased",
        MemberStatus.Rejected => "status-rejected",
        _ => "status-guest"
    };

    private string GetDuesBadgeClass(string dues) => dues?.Trim().ToLowerInvariant() switch
    {
        "paid" => "dues-paid",
        "past due" => "dues-overdue",
        "overdue" => "dues-overdue",
        "waived" => "dues-waived",
        "life" => "dues-life",
        _ => "dues-waived"
    };

    private string GetDuesLabel(string dues) => dues?.Trim().ToLowerInvariant() switch
    {
        "paid" => "Paid",
        "past due" => "Overdue",
        "overdue" => "Overdue",
        "waived" => "Waived",
        "life" => "Life",
        _ => string.IsNullOrWhiteSpace(dues) ? "Dues —" : CultureInfo.CurrentCulture.TextInfo.ToTitleCase(dues)
    };

    private void NavigateToMember(int memberId) =>
        NavManager.NavigateTo($"/members/{memberId}");

    private void NavigateToAdd() =>
        NavManager.NavigateTo("/members/new");

    public void Dispose()
    {
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
    }

    private sealed record StatusChip(string Value, string Label, string Color);

    private sealed class MemberCardModel
    {
        public int MemberId { get; set; }
        public string FullName { get; set; } = string.Empty;
        public MemberStatus Status { get; set; }
        public string NormalizedStatus { get; set; } = string.Empty;
        public string? City { get; set; }
        public string? Email { get; set; }
        public string? Phone { get; set; }
        public DateTime? MemberSince { get; set; }
        public DateTime? RegularSince { get; set; }
        public bool IsNonPortuguese { get; set; }
        public bool HasKeyCard { get; set; }
        public DateTime? InactiveDate { get; set; }
        public string DuesStatus { get; set; } = "Paid";
        public int KeyCardCount => HasKeyCard ? 1 : 0;
    }
}
