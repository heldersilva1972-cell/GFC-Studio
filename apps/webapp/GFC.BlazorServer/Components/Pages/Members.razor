@page "/members"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using System.Globalization
@using GFC.Core.BusinessRules
@using GFC.Core.DTOs
@using GFC.Core.Enums
@using GFC.Core.Interfaces
@using GFC.Core.Models
@inject IMemberQueryService MemberQueryService
@inject IMemberRepository MemberRepository
@inject ILogger<Members> Logger
@inject NavigationManager NavManager
@inject IKeyCardRepository KeyCardRepository
@inject IDuesRepository DuesRepository
@inject IBoardRepository BoardRepository
@inject IDuesYearSettingsRepository DuesYearSettingsRepository
@inject KeyCardService CardService
@implements IDisposable

<div class="page-header align-items-center mb-4">
    <div>
        <h1 class="page-title-modern mb-0">Members</h1>
        <p class="text-muted small mb-0">Manage the club's membership database and card access</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-9">

<div class="data-card mb-4">
    <div class="row g-3 align-items-end">
        <!-- Search Box -->
        <div class="col-md-6">
            <label class="form-label fw-semibold">
                <i class="bi bi-search me-1"></i>Search Members
            </label>
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input class="form-control"
                       placeholder="Search by name, ID, email, or phone"
                       @bind="_searchTerm"
                       @bind:event="oninput"
                       @bind:after="OnSearchChanged"
                       disabled="@_isLoading" />
                @if (!string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <button type="button"
                            class="btn btn-outline-secondary"
                            @onclick="ClearSearch"
                            title="Clear search"
                            disabled="@_isLoading">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
            </div>
        </div>

        <!-- Sort Dropdown -->
        <div class="col-md-3">
            <label class="form-label fw-semibold">
                <i class="bi bi-sort-down me-1"></i>Sort By
            </label>
            <select class="form-select"
                    @bind="_sortOption"
                    @bind:after="() => ApplyFilters()"
                    disabled="@_isLoading">
                <option value="name">Name (A–Z)</option>
                <option value="status">Status</option>
                <option value="dues">Dues Status</option>
                <option value="id">Member ID</option>
            </select>
        </div>

        <!-- Filter Indicator -->
        <div class="col-md-3 text-end">
            @if (HasActiveFilters)
            {
                <span class="badge bg-primary" style="font-size: 0.9rem; padding: 8px 12px;">
                    <i class="bi bi-funnel-fill me-1"></i>
                    Filters Active
                </span>
            }
        </div>
    </div>

    <!-- Status Filter Chips -->
    <div class="mt-3 pt-3 border-top">
        <label class="form-label fw-semibold mb-2">
            <i class="bi bi-filter me-1"></i>Filter by Status
        </label>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var chip in _statusChips)
            {
                <button type="button"
                        class="btn btn-sm @(IsChipActive(chip.Value) ? "btn-primary" : "btn-outline-secondary")"
                        style="border-radius: 20px; padding: 6px 16px;"
                        @onclick="() => SetStatusFilter(chip.Value)"
                        disabled="@_isLoading">
                    @chip.Label
                </button>
            }
        </div>
    </div>
</div>

@if (_isLoading)
{
    <div class="data-card">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading members...</p>
        </div>
    </div>
}
else if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
        <button class="btn btn-outline-danger btn-sm ms-3" type="button" @onclick="LoadMembersAsync">Retry</button>
    </div>
}
else
{
    @if (_filteredMembers.Count == 0)
    {
        <div class="data-card text-center py-5">
            <i class="bi bi-people" style="font-size: 3rem; color: #ccc;"></i>
            <h5 class="mt-3">No members found</h5>
            <p class="text-muted">Try clearing filters or search terms.</p>
            @if (HasActiveFilters)
            {
                <button class="btn btn-outline-secondary" type="button" @onclick="ClearFilters">
                    <i class="bi bi-x-circle me-2"></i>Clear Filters
                </button>
            }
        </div>
    }
    else
    {
        <div class="data-card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="sticky-header">
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Name</th>
                            <th>City</th>
                            <th>Membership</th>
                            <th>Dues Status</th>
                            <th style="width: 120px;">Member Since</th>
                            <th style="width: 140px;">Card Number</th>
                            <th style="width: 100px;" class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var member in _filteredMembers)
                        {
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">#@member.MemberId</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <div class="fw-semibold">@member.FullName</div>
                                            @if (!string.IsNullOrWhiteSpace(member.Email))
                                            {
                                                <small class="text-muted">@member.Email</small>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>@(member.City ?? "—")</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(member.Status)">
                                        @GetStatusLabel(member.Status)
                                    </span>
                                </td>
                                <td>
                                    <span class="badge @GetDuesBadgeClass(member.DuesStatus)">
                                        @GetDuesLabel(member.DuesStatus)
                                    </span>
                                </td>
                                <td>
                                    @if (member.MemberSince.HasValue)
                                    {
                                        <small>@member.MemberSince.Value.ToString("MMM d, yyyy")</small>
                                    }
                                    else
                                    {
                                        <small class="text-muted">—</small>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (!string.IsNullOrEmpty(member.CardNumber))
                                    {
                                        <div class="d-flex flex-column align-items-center">
                                            <code class="fw-bold text-dark" style="font-size: 0.85rem;">@member.CardNumber</code>
                                            <span class="badge @(member.CardIsActive == true ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger")" 
                                                  style="font-size: 0.65rem; padding: 2px 6px;">
                                                @(member.CardIsActive == true ? "ACTIVE" : "INACTIVE")
                                            </span>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">No card assigned</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            @onclick="() => NavigateToMember(member.MemberId)"
                                            title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            @if (_filteredMembers.Count > 0)
            {
                <div class="p-3 border-top border-main">
                    <small class="text-secondary">
                        Showing @_filteredMembers.Count of @_allMembers.Count members
                    </small>
                </div>
            }
        </div>
    }
}
</div>

    <!-- Sidebar / Quick Actions Column -->
    <div class="col-lg-3">
        <div class="action-tile-modern scale-in mb-4">
            <div class="action-tile-content">
                <div class="action-icon-wrapper pulse-slow">
                    <i class="bi bi-person-plus-fill"></i>
                </div>
                <h3>Membership Actions</h3>
                <p>Register a new member into the system</p>
                <button class="btn btn-primary btn-action-modern w-100 mt-2" @onclick="NavigateToAdd">
                    <i class="bi bi-plus-lg me-2"></i>
                    Add New Member
                </button>
            </div>
        </div>

        <!-- System Stats / Info (Optional context) -->
        <div class="data-card p-4">
            <h6 class="fw-800 text-uppercase small text-muted mb-3" style="letter-spacing: 0.5px;">Quick Stats</h6>
            <div class="d-flex justify-content-between mb-2">
                <span class="text-muted small">Total Members</span>
                <span class="fw-bold">@_allMembers.Count</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span class="text-muted small">Active Members</span>
                <span class="fw-bold text-success">@_allMembers.Count(m => m.Status is MemberStatus.Regular or MemberStatus.RegularNonPortuguese or MemberStatus.Life)</span>
            </div>
            <div class="d-flex justify-content-between">
                <span class="text-muted small">With Cards</span>
                <span class="fw-bold text-primary">@_allMembers.Count(m => !string.IsNullOrEmpty(m.CardNumber))</span>
            </div>
        </div>
    </div>
</div>

<style>
    .bulk-actions-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px 14px;
        margin-bottom: 12px;
        border: 1px solid var(--glass-border);
        border-radius: 10px;
        background: var(--glass-bg);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        min-height: 64px;
    }

    .bulk-actions-info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .bulk-actions-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }

    .bulk-count {
        font-size: 0.95rem;
    }

    .filter-bar {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 14px;
        margin-bottom: 16px;
        background: var(--bg-primary);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 220px;
    }

    .filter-group.full-width {
        min-width: 100%;
    }

    .filter-label {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-secondary);
        margin-bottom: 0;
    }

    .search-input {
        position: relative;
    }

    .search-input i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }

    .search-input .form-control {
        padding-left: 38px;
        padding-right: 38px;
        height: 44px;
    }

    .btn-clear {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        width: 34px;
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 8px;
        background: transparent;
        color: #6b7280;
        transition: background-color 0.15s ease, color 0.15s ease;
    }

    .btn-clear:hover {
        background: var(--bg-surface-hover);
        color: var(--text-primary);
    }

    .btn-clear:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: transparent;
    }

    .status-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .status-chip {
        border: 1px solid var(--glass-border);
        background: var(--glass-bg);
        color: var(--text-secondary);
        padding: 8px 12px;
        border-radius: 10px;
        font-weight: 700;
        transition: background-color 0.15s ease, border-color 0.15s ease, transform 0.15s ease;
    }

    .status-chip:hover {
        background: var(--bg-surface-hover);
        border-color: var(--accent-primary);
    }

    .status-chip.active {
        background: var(--chip-color);
        color: #ffffff;
        border-color: transparent;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
    }

    .status-chip:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
    }

    .indicator-group {
        display: flex;
        flex: 0 0 160px;
        min-width: 160px;
        justify-content: flex-end;
    }

    .filter-active-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        font-weight: 700;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .sort-group select {
        min-width: 180px;
    }

    .chips-row {
        align-items: flex-start;
    }

    @@media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group,
        .indicator-group {
            min-width: 100%;
        }

        .indicator-group {
            justify-content: flex-start;
        }
    }

    .members-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .members-list-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border: 1px dashed var(--glass-border);
        border-radius: 10px;
        background: var(--bg-primary);
    }

    .select-all-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0;
    }

    .member-row-wrapper {
        display: grid;
        grid-template-columns: 44px 1fr;
        gap: 10px;
        align-items: stretch;
    }

    .member-select {
        display: flex;
        align-items: center;
        justify-content: center;
        padding-top: 0;
    }

    .member-row {
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 14px 16px;
        background: var(--glass-bg);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        cursor: pointer;
        position: relative;
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
        color: var(--text-primary);
    }

    .member-row:hover {
        border-color: var(--accent-primary);
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-1px);
    }

    .btn-clear:focus-visible,
    .status-chip:focus-visible,
    .bulk-actions-controls .btn:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
    }

    .form-check-input:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
        box-shadow: none;
    }

    .member-row:focus-visible {
        border-color: var(--accent-primary);
        box-shadow:
            0 0 0 2px rgba(14, 165, 233, 0.35),
            0 8px 24px rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 0.08);
    }

    .member-row.selected {
        border-color: var(--accent-primary);
        background: rgba(14, 165, 233, 0.1);
        box-shadow:
            0 0 0 1px rgba(14, 165, 233, 0.25),
            0 10px 28px rgba(0, 0, 0, 0.2);
        transform: translateY(-1px);
    }

    .member-row-main {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .member-primary {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .member-name-line {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        align-items: flex-start;
        column-gap: 12px;
        row-gap: 8px;
    }

    .member-name {
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--text-primary);
        min-width: 0;
        word-break: break-word;
    }

    .member-sub {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .member-id {
        font-weight: 600;
        color: #374151;
    }

    .dot {
        color: #d1d5db;
    }

    .member-row-badges {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        row-gap: 6px;
        flex-wrap: wrap;
        flex-shrink: 0;
        min-width: 0;
    }

    .pill {
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.85rem;
        font-weight: 700;
        line-height: 1;
        border: none;
        white-space: nowrap;
    }

    .status-badge {
        color: #0f172a;
        background: #e5e7eb;
    }

    .status-regular { background: #16a34a; color: #ffffff; }
    .status-regular-np { background: #0ea5e9; color: #ffffff; }
    .status-guest { background: #6b7280; color: #ffffff; }
    .status-life { background: #d6b33d; color: #1f2937; }
    .status-inactive { background: #ef4444; color: #ffffff; }
    .status-deceased { background: #b91c1c; color: #ffffff; }
    .status-rejected { background: #7f1d1d; color: #ffffff; }

    .dues-badge {
        background: #e5e7eb;
        color: #111827;
    }

    .dues-paid { background: #16a34a; color: #ffffff; }
    .dues-overdue { background: #f97316; color: #111827; }
    .dues-waived { background: #6b7280; color: #ffffff; }
    .dues-life { background: #d6b33d; color: #1f2937; }

    .member-row-meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 8px;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .skeleton-list {
        gap: 0.6rem;
    }

    .skeleton-line {
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
        background-size: 200% 100%;
        animation: shimmer 1.2s infinite;
    }

    .skeleton-pill {
        height: 22px;
        border-radius: 999px;
        background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
        background-size: 200% 100%;
        animation: shimmer 1.2s infinite;
    }

    .w-50 { width: 50%; }
    .w-30 { width: 30%; }
    .w-20 { width: 20%; }
    .w-16 { width: 16%; }

    @@keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    @@media (max-width: 1024px) {
        .member-row {
            padding: 12px 14px;
        }

        .member-name-line {
            align-items: flex-start;
        }

        .member-row-badges {
            justify-content: flex-start;
        }

        .member-row-meta {
            flex-direction: column;
            gap: 6px;
        }
    }

    @@media (max-width: 640px) {
        .bulk-actions-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .bulk-actions-controls {
            width: 100%;
            justify-content: flex-start;
        }

        .member-row-wrapper {
            grid-template-columns: 40px 1fr;
        }

        .member-name-line {
            grid-template-columns: 1fr;
        }

        .member-row {
            padding: 12px;
        }

        .member-row-main {
            gap: 8px;
        }

        .member-name-line {
            gap: 8px;
        }

        .member-name {
            font-size: 1rem;
        }

        .member-row-badges {
            width: 100%;
            justify-content: flex-start;
        }

        .member-sub {
            gap: 6px;
            font-size: 0.9rem;
        }

        .member-sub .dot,
        .member-sub .member-location {
            display: none;
        }

        .member-row-meta {
            display: none;
        }

        .pill {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
    }
</style>
@code {
    private readonly List<StatusChip> _statusChips = new()
    {
        new("all", "All", "#1f2937"),
        new("regular", "Regular", "#14b8a6"),
        new("guest", "Guest", "#6b7280"),
        new("life", "Life", "#d6b33d"),
        new("npqueue", "NP-Regular", "#2563eb"),
        new("pastdue", "Suspended", "#f97316"),
        new("inactive", "Inactive", "#ef4444")
    };

    private List<MemberCardModel> _allMembers = new();
    private List<MemberCardModel> _filteredMembers = new();
    private string _searchTerm = string.Empty;
    private string _statusFilter = "all";
    private string _sortOption = "name";
    private bool HasActiveFilters =>
        !string.IsNullOrWhiteSpace(_searchTerm) || !IsChipActive("all");
    private bool _isLoading = true;
    private string? _errorMessage;
    private CancellationTokenSource? _debounceCts;

    protected override async Task OnInitializedAsync()
    {
        await LoadMembersAsync();
    }

    private async Task LoadMembersAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var year = DateTime.Today.Year;
            var listTask = MemberQueryService.GetMembersAsync(new MemberFilterOptions());
            var detailsTask = Task.Run(() => MemberRepository.GetAllMembers());
            var cardsTask = Task.Run(() => KeyCardRepository.GetAll());
            var duesCurrentTask = Task.Run(() => DuesRepository.GetDuesForYear(year));
            var duesPrevTask = Task.Run(() => DuesRepository.GetDuesForYear(year - 1));
            var boardCurrentTask = Task.Run(() => BoardRepository.GetAssignmentsByYear(year));
            var boardPrevTask = Task.Run(() => BoardRepository.GetAssignmentsByYear(year - 1));
            var settingsTask = Task.Run(() => DuesYearSettingsRepository.GetSettingsForYear(year));

            await Task.WhenAll(
                listTask, detailsTask, cardsTask, 
                duesCurrentTask, duesPrevTask, 
                boardCurrentTask, boardPrevTask, settingsTask
            );

            var list = listTask.Result;
            var detailsLookup = detailsTask.Result.ToDictionary(m => m.MemberID);
            var allCards = cardsTask.Result;
            
            var duesCurrent = duesCurrentTask.Result.ToDictionary(d => d.MemberID);
            var duesPrev = duesPrevTask.Result.ToDictionary(d => d.MemberID);
            var boardCurrent = boardCurrentTask.Result.Select(a => a.MemberID).ToHashSet();
            var boardPrev = boardPrevTask.Result.Select(a => a.MemberID).ToHashSet();
            var settings = settingsTask.Result;

            var activeCardByMember = allCards
                .Where(c => c.IsActive)
                .GroupBy(c => c.MemberId)
                .ToDictionary(g => g.Key, g => g.First());
            
            // Secondary lookup for inactive cards if no active one exists
            var anyCardByMember = allCards
                .GroupBy(c => c.MemberId)
                .ToDictionary(g => g.Key, g => g.First());

            _allMembers = list
                .Select(item =>
                {
                    detailsLookup.TryGetValue(item.MemberId, out var detail);
                    var status = item.Status;
                    var normalized = MemberStatusHelper.NormalizeStatus(detail?.Status ?? status.ToString());
                    var isLife = status == MemberStatus.Life;
                    var isBoard = boardCurrent.Contains(item.MemberId);
                    
                    // Determine Dues Status logic (matching KeyCardService rules)
                    bool currentPaid = isBoard || isLife || (duesCurrent.TryGetValue(item.MemberId, out var dc) && KeyCardService.IsDuesSatisfied(dc.PaymentType, dc.PaidDate));
                    bool prevPaid = isBoard || isLife || (duesPrev.TryGetValue(item.MemberId, out var dp) && KeyCardService.IsDuesSatisfied(dp.PaymentType, dp.PaidDate));
                    
                    if (detail == null) return null;
                    var eligibility = CardService.GetEligibilityBulk(detail, year, settings, currentPaid, prevPaid);

                    string duesStatus = "Paid";
                    if (status == MemberStatus.Inactive)
                    {
                        duesStatus = "None";
                    }
                    else if (isLife)
                    {
                        duesStatus = "Life";
                    }
                    else if (isBoard)
                    {
                        duesStatus = "Paid"; // Board members have paid status by privilege
                    }
                    else if (!eligibility.Eligible && !eligibility.GracePeriodActive)
                    {
                        duesStatus = "Past Due";
                    }
                    else if (eligibility.GracePeriodActive && !eligibility.CurrentYearSatisfied)
                    {
                        duesStatus = "In Grace Period";
                    }

                    // Enrich with card details
                    string? cardNumber = null;
                    bool? cardActive = null;

                    if (activeCardByMember.TryGetValue(item.MemberId, out var activeCard))
                    {
                        cardNumber = activeCard.CardNumber;
                        cardActive = true;
                    }
                    else if (anyCardByMember.TryGetValue(item.MemberId, out var anyCard))
                    {
                        cardNumber = anyCard.CardNumber;
                        cardActive = anyCard.IsActive;
                    }

                    return new MemberCardModel
                    {
                        MemberId = item.MemberId,
                        FullName = detail is null
                            ? item.FullName
                            : $"{detail.FirstName} {detail.LastName}".Trim(),
                        Status = status,
                        City = detail?.City,
                        Email = detail?.Email,
                        Phone = detail?.Phone ?? detail?.CellPhone,
                        MemberSince = item.MemberSince,
                        RegularSince = item.RegularSince,
                        IsNonPortuguese = item.IsNonPortuguese,
                        HasKeyCard = !string.IsNullOrEmpty(cardNumber),
                        InactiveDate = item.InactiveDate,
                        DuesStatus = duesStatus,
                        IsBoardMember = isBoard,
                        NormalizedStatus = normalized,
                        CardNumber = cardNumber,
                        CardIsActive = cardActive
                    };
                })
                .Where(m => m != null)
                .Cast<MemberCardModel>()
                .ToList();

            ApplyFilters();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[Members] Unable to load members");
            _errorMessage = "Unable to load members.";
            _allMembers = new();
            _filteredMembers = new();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ApplyFilters(ChangeEventArgs? _ = null)
    {
        IEnumerable<MemberCardModel> query = _allMembers;

        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            var term = _searchTerm.Trim();
            query = query.Where(m =>
                (!string.IsNullOrWhiteSpace(m.FullName) && m.FullName.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                m.MemberId.ToString().Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrWhiteSpace(m.Email) && m.Email.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrWhiteSpace(m.Phone) && m.Phone.Contains(term, StringComparison.OrdinalIgnoreCase)));
        }

        query = query.Where(MatchesStatusFilter);

        query = _sortOption switch
        {
            "status" => query.OrderBy(m => GetStatusLabel(m.Status)).ThenBy(m => m.FullName),
            "dues" => query.OrderBy(m => m.DuesStatus).ThenBy(m => m.FullName),
            "id" => query.OrderBy(m => m.MemberId),
            _ => query.OrderBy(m => m.FullName)
        };

        _filteredMembers = query.ToList();
        StateHasChanged();
    }

    private bool MatchesStatusFilter(MemberCardModel member) => _statusFilter switch
    {
        "regular" => member.Status == MemberStatus.Regular,
        "guest" => member.Status == MemberStatus.Guest,
        "life" => member.Status == MemberStatus.Life,
        "npqueue" => member.Status == MemberStatus.RegularNonPortuguese,
        "pastdue" => string.Equals(member.DuesStatus, "Past Due", StringComparison.OrdinalIgnoreCase),
        "inactive" => member.Status is MemberStatus.Inactive or MemberStatus.Deceased or MemberStatus.Rejected,
        _ => true
    };

    private void OnSearchChanged()
    {
        _debounceCts?.Cancel();
        var cts = new CancellationTokenSource();
        _debounceCts = cts;

        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(200, cts.Token);
                if (!cts.IsCancellationRequested)
                {
                    ApplyFilters();
                }
            }
            catch (TaskCanceledException)
            {
                // ignore
            }
        });
    }

    private void ClearSearch()
    {
        _searchTerm = string.Empty;
        ApplyFilters();
    }

    private void ClearFilters()
    {
        _searchTerm = string.Empty;
        _statusFilter = "all";
        ApplyFilters();
    }

    private void SetStatusFilter(string value)
    {
        _statusFilter = value;
        ApplyFilters();
    }

    private bool IsChipActive(string value) => string.Equals(_statusFilter, value, StringComparison.OrdinalIgnoreCase);

    private readonly HashSet<int> _selectedMemberIds = new();

    private int SelectedCount => _selectedMemberIds.Count;

    private bool IsSelected(int memberId) => _selectedMemberIds.Contains(memberId);

    private bool IsAllVisibleSelected =>
        _filteredMembers.Count > 0 && _filteredMembers.All(m => _selectedMemberIds.Contains(m.MemberId));

    private string GetMemberDisplayName(MemberCardModel member) =>
        string.IsNullOrWhiteSpace(member.FullName) ? $"Member {member.MemberId}" : member.FullName;

    private void OnMemberRowClick(int memberId)
    {
        NavigateToMember(memberId);
    }

    private void OnRowKeyDown(KeyboardEventArgs e, int memberId)
    {
        if (e.Key == "Enter" || e.Key == " " || e.Key == "Spacebar")
        {
            NavigateToMember(memberId);
        }
    }

    private EventCallback<MouseEventArgs> CreateRowClickCallback(int memberId) =>
        EventCallback.Factory.Create<MouseEventArgs>(this, () => OnMemberRowClick(memberId));

    private void ToggleSelection(ChangeEventArgs e, int memberId)
    {
        var isChecked = e.Value is bool value && value;

        if (isChecked)
        {
            _selectedMemberIds.Add(memberId);
        }
        else
        {
            _selectedMemberIds.Remove(memberId);
        }
    }

    private EventCallback<ChangeEventArgs> CreateSelectionCallback(int memberId) =>
        EventCallback.Factory.Create<ChangeEventArgs>(this, e => ToggleSelection(e, memberId));

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        var isChecked = e.Value is bool value && value;

        if (isChecked)
        {
            foreach (var member in _filteredMembers)
            {
                _selectedMemberIds.Add(member.MemberId);
            }
        }
        else
        {
            foreach (var member in _filteredMembers)
            {
                _selectedMemberIds.Remove(member.MemberId);
            }
        }
    }

    private void ClearSelection()
    {
        if (_selectedMemberIds.Count == 0)
        {
            return;
        }

        _selectedMemberIds.Clear();
    }

    private static string GetStatusLabel(MemberStatus status) => status switch
    {
        MemberStatus.Regular => "Regular",
        MemberStatus.RegularNonPortuguese => "NP-Regular",
        MemberStatus.Guest => "Guest",
        MemberStatus.Life => "Life",
        MemberStatus.Inactive => "Inactive",
        MemberStatus.Deceased => "Deceased",
        MemberStatus.Rejected => "Rejected",
        _ => "Unknown"
    };

    private static string FormatDate(DateTime? value) =>
        value?.ToString("MMM d, yyyy", CultureInfo.InvariantCulture) ?? "—";

    private string GetStatusBadgeClass(MemberStatus status) => status switch
    {
        MemberStatus.Regular => "status-regular",
        MemberStatus.RegularNonPortuguese => "status-regular-np",
        MemberStatus.Guest => "status-guest",
        MemberStatus.Life => "status-life",
        MemberStatus.Inactive => "status-inactive",
        MemberStatus.Deceased => "status-deceased",
        MemberStatus.Rejected => "status-rejected",
        _ => "status-guest"
    };

    private string GetDuesBadgeClass(string dues) => dues?.Trim().ToLowerInvariant() switch
    {
        "paid" => "dues-paid",
        "past due" => "dues-overdue",
        "overdue" => "dues-overdue",
        "waived" => "dues-waived",
        "life" => "dues-life",
        "suspended" => "dues-overdue",
        _ => "dues-waived"
    };

    private string GetDuesLabel(string dues) => dues?.Trim().ToLowerInvariant() switch
    {
        "paid" => "Paid",
        "past due" => "Overdue",
        "overdue" => "Overdue",
        "waived" => "Waived",
        "life" => "Life",
        "suspended" => "Suspended",
        _ => string.IsNullOrWhiteSpace(dues) ? "Dues —" : CultureInfo.CurrentCulture.TextInfo.ToTitleCase(dues)
    };

    private void NavigateToMember(int memberId) =>
        NavManager.NavigateTo($"/members/{memberId}");

    private void NavigateToAdd() =>
        NavManager.NavigateTo("/members/new");

    public void Dispose()
    {
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
    }

    private sealed record StatusChip(string Value, string Label, string Color);

    private sealed class MemberCardModel
    {
        public int MemberId { get; set; }
        public string FullName { get; set; } = string.Empty;
        public MemberStatus Status { get; set; }
        public string NormalizedStatus { get; set; } = string.Empty;
        public string? City { get; set; }
        public string? Email { get; set; }
        public string? Phone { get; set; }
        public DateTime? MemberSince { get; set; }
        public DateTime? RegularSince { get; set; }
        public bool IsNonPortuguese { get; set; }
        public bool HasKeyCard { get; set; }
        public DateTime? InactiveDate { get; set; }
        public string DuesStatus { get; set; } = "Paid";
        public bool IsBoardMember { get; set; }
        public string? CardNumber { get; set; }
        public bool? CardIsActive { get; set; }
    }
}
