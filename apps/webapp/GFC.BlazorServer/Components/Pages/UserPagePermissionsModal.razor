// [MODIFIED]
@using GFC.Core.Models
@inject IUserManagementService UserService
@inject IEmailService EmailService
@inject ILogger<UserPagePermissionsModal> Logger

<div class="modal-backdrop"></div>
<div class="modal-card" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-card__header d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            <i class="bi bi-shield-lock"></i> Page Access Permissions - @Username
            @if (IsAdmin)
            {
                <span class="badge bg-primary ms-2">Admin</span>
            }
        </h4>
        <button class="btn btn-link text-muted p-0" type="button" @onclick="OnClose">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger mb-3">
            <strong>Error:</strong> @ErrorMessage
        </div>
    }

    @if (IsAdmin)
    {
        <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i>
            <strong>Admin User:</strong> Administrators have full access to all pages by default and cannot have their permissions restricted.
        </div>
    }
    else
    {
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <p class="text-muted mb-0">
                    Select which pages this user can access. Unchecked pages will be inaccessible to this user.
                </p>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" @onclick="SelectAll">
                        <i class="bi bi-check-square"></i> Select All
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ClearAll">
                        <i class="bi bi-square"></i> Clear All
                    </button>
                </div>
            </div>
        </div>

        @if (Loading)
        {
            <div class="loading-state">
                <div class="spinner-border spinner-border-sm text-info" role="status"></div> Loading pages...
            </div>
        }
        else
        {
            @foreach (var category in PagesByCategory.Keys.OrderBy(k => k))
            {
                <div class="mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-folder"></i> @category
                    </h6>
                    <div class="row g-2">
                        @foreach (var page in PagesByCategory[category])
                        {
                            <div class="col-md-6">
                                @{
                                    var pageId = page.PageId;
                                    var checkboxId = $"page_{pageId}";
                                    var isSelected = SelectedPageIds.Contains(pageId);
                                    var isDisabled = page.RequiresAdmin;
                                    var pageName = page.PageName;
                                    var pageRoute = page.PageRoute;
                                    var pageDescription = page.Description;
                                    var requiresAdmin = page.RequiresAdmin;
                                }
                                <div class="form-check p-3 border rounded @(isSelected ? "bg-light" : "")">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="@checkboxId"
                                           checked="@isSelected"
                                           @onchange="@(e => TogglePage(pageId, page.PageRoute))"
                                           disabled="@isDisabled" />
                                    <label class="form-check-label w-100" for="@checkboxId">
                                        <div class="fw-semibold">@pageName</div>
                                        <div class="small text-muted">@pageRoute</div>
                                        @if (!string.IsNullOrEmpty(pageDescription))
                                        {
                                            <div class="small text-muted fst-italic">@pageDescription</div>
                                        }
                                        @if (requiresAdmin)
                                        {
                                            <span class="badge bg-warning text-dark small">Admin Only</span>
                                        }
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    }

    <div class="modal-card__actions">
        @if (!IsAdmin)
        {
            <button type="button" class="btn btn-primary" @onclick="SavePermissions" disabled="@Saving">
                <span class="spinner-border spinner-border-sm me-1" hidden="@(!Saving)"></span>
                <i class="bi bi-save"></i> Save Permissions
            </button>
        }
        <button type="button" class="btn btn-outline" @onclick="OnClose" disabled="@Saving">Close</button>
    </div>
</div>

@code {
    [Parameter] public int UserId { get; set; }
    [Parameter] public string Username { get; set; } = string.Empty;
    [Parameter] public bool IsAdmin { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private bool Loading { get; set; } = true;
    private bool Saving { get; set; } = false;
    private string ErrorMessage { get; set; } = string.Empty;
    
    private List<AppPage> AllPages { get; set; } = new();
    private Dictionary<string, List<AppPage>> PagesByCategory { get; set; } = new();
    private HashSet<int> SelectedPageIds { get; set; } = new();
    private HashSet<int> OriginalSelectedPageIds { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        Loading = true;
        ErrorMessage = string.Empty;
        
        try
        {
            AllPages = await Task.Run(() => UserService.GetActivePages());
            
            PagesByCategory = AllPages
                .GroupBy(p => p.Category ?? "Other")
                .ToDictionary(g => g.Key, g => g.OrderBy(p => p.DisplayOrder).ThenBy(p => p.PageName).ToList());
            
            if (!IsAdmin)
            {
                var userPermissions = await Task.Run(() => UserService.GetUserPagePermissions(UserId));
                SelectedPageIds = userPermissions.Select(p => p.PageId).ToHashSet();
                OriginalSelectedPageIds = new HashSet<int>(SelectedPageIds);
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load page permissions: {ex.Message}";
        }
        finally
        {
            Loading = false;
        }
    }

    private void TogglePage(int pageId, string pageRoute)
    {
        if (SelectedPageIds.Contains(pageId))
        {
            SelectedPageIds.Remove(pageId);
        }
        else
        {
            SelectedPageIds.Add(pageId);
            if(pageRoute == "/cameras/view")
            {
                // The user was just granted camera access. We'll send the email on save.
            }
        }
    }

    private void SelectAll()
    {
        SelectedPageIds = AllPages
            .Where(p => !p.RequiresAdmin)
            .Select(p => p.PageId)
            .ToHashSet();
    }

    private void ClearAll()
    {
        SelectedPageIds.Clear();
    }

    private async Task SavePermissions()
    {
        Saving = true;
        ErrorMessage = string.Empty;
        
        try
        {
            var cameraPermissionPage = AllPages.FirstOrDefault(p => p.PageRoute == "/cameras/view");
            bool wasCameraPermissionGranted = false;
            if (cameraPermissionPage != null)
            {
                bool originallyHadPermission = OriginalSelectedPageIds.Contains(cameraPermissionPage.PageId);
                bool nowHasPermission = SelectedPageIds.Contains(cameraPermissionPage.PageId);
                if (!originallyHadPermission && nowHasPermission)
                {
                    wasCameraPermissionGranted = true;
                }
            }

            await Task.Run(() => UserService.SetUserPagePermissions(
                UserId, 
                SelectedPageIds.ToList(), 
                "Admin"));

            if (wasCameraPermissionGranted)
            {
                var user = await UserService.GetUserAsync(UserId);
                if (user != null && !string.IsNullOrEmpty(user.Email))
                {
                    await EmailService.SendEmailAsync(
                        user.Email,
                        "Your Secure Access to GFC Cameras is Ready",
                        $"<p>Hello {user.Username},</p><p>You have been granted secure remote access to the GFC camera system. You can now complete the one-time setup to view cameras from any device.</p><p>Please log in to the GFC website and navigate to the Cameras page to begin the setup wizard.</p>");
                }
            }
            
            await OnSaved.InvokeAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to save permissions: {ex.Message}";
            Saving = false;
        }
        finally
        {
            if (string.IsNullOrEmpty(ErrorMessage))
            {
                Saving = false;
            }
        }
    }
}
