@page "/website-home"
@using GFC.Core.Models
@using GFC.BlazorServer.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<GfcDbContext> DbContextFactory
@inject NavigationManager NavigationManager

<PageTitle>@(page?.Title ?? "GFC Website")</PageTitle>

@if (page == null)
{
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="spinner-border text-primary"></div>
        </div>
    }
    else
    {
        <div class="container py-5 text-center">
            <h1>Welcome to GFC</h1>
            <p>Our website is currently under construction. Please check back soon!</p>
            <a href="/login" class="btn btn-outline-primary shadow-sm rounded-pill px-4">Admin Login</a>
        </div>
    }
}
else
{
    <div class="generated-page">
        @foreach (var sec in page.Sections.OrderBy(s => s.OrderIndex))
        {
            <div id="@($"section-{sec.Id}")" class="page-section" @attributes="@(GetAttributes(sec))">
                @RenderSection(sec)
            </div>
        }
    </div>
}

@code {
    private StudioPage? page;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try 
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            // Try to find the home page (slug 'home' or 'index')
            page = await context.StudioPages
                .Include(p => p.Sections)
                .AsNoTracking()
                .FirstOrDefaultAsync(p => (p.Slug == "home" || p.Slug == "index") && p.Status == "Published");
                
            if (page != null)
            {
                foreach (var s in page.Sections)
                {
                    s.SyncDataToProperties();
                }
            }
        }
        catch(Exception ex) 
        {
            Console.WriteLine($"Error loading home page: {ex.Message}");
        }
        finally 
        {
            isLoading = false;
        }
    }

    private Dictionary<string, object> GetAttributes(StudioSection section)
    {
        var attrs = new Dictionary<string, object>();
        // Future: apply styles from section.Styles
        return attrs;
    }

    private RenderFragment RenderSection(StudioSection section) => builder =>
    {
        switch (section.ComponentType)
        {
             case "Heading":
                builder.OpenElement(0, "h1");
                builder.AddContent(1, section.properties.ContainsKey("content") ? section.properties["content"].ToString() : (section.properties.ContainsKey("headline") ? section.properties["headline"].ToString() : section.Title));
                builder.CloseElement();
                break;
                
            case "TextBlock":
            case "RichTextBlock":
                builder.OpenElement(0, "div");
                builder.AddAttribute(1, "class", "text-content");
                builder.AddMarkupContent(2, section.properties.ContainsKey("content") ? section.properties["content"]?.ToString() : "");
                builder.CloseElement();
                break;
                
            case "Image":
                if (section.properties.ContainsKey("src"))
                {
                    builder.OpenElement(0, "img");
                    builder.AddAttribute(1, "src", section.properties["src"]?.ToString() ?? "");
                    builder.AddAttribute(2, "class", "img-fluid");
                    builder.CloseElement();
                }
                break;
                
            default:
                builder.OpenElement(0, "div");
                builder.AddContent(1, $"[{section.ComponentType}] {section.Title}");
                builder.CloseElement();
                break;
        }
    };
}
