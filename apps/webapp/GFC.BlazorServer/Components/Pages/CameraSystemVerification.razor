<!-- [NEW] -->
@page "/camera-verification"
@using GFC.Core.Models
@using GFC.BlazorServer.Services.Camera
@using System.Text
@inject ICameraVerificationService VerificationService
@inject IJSRuntime JSRuntime

<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Camera System Pre-Implementation Verification</h3>
        </div>
        <div class="card-body">
            @if (_isLoading)
            {
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Running verification tests, please wait...</p>
                </div>
            }
            else
            {
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 50%;">Test Description</th>
                            <th style="width: 15%;" class="text-center">Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var result in _results)
                        {
                            <tr>
                                <td>@result.TestName</td>
                                <td class="text-center">
                                    @if (result.Success)
                                    {
                                        <span class="badge bg-success">PASS</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">FAIL</span>
                                    }
                                </td>
                                <td>@result.Message</td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="mt-3 text-end">
                    <button class="btn btn-secondary" @onclick="ExportReport">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<VerificationResult> _results = new List<VerificationResult>();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // To provide a better user experience, we'll stream the results in.
        // This is a simulation for now.
        _isLoading = true;
        var allTests = await VerificationService.RunAllVerificationsAsync();
        foreach (var test in allTests)
        {
            _results.Add(test);
            StateHasChanged(); // Re-render the component
            await Task.Delay(250); // Small delay to make the streaming visible
        }
        _isLoading = false;
    }

    private async Task ExportReport()
    {
        var sb = new StringBuilder();
        sb.AppendLine("GFC Camera System Verification Report");
        sb.AppendLine($"Generated on: {DateTime.Now}");
        sb.AppendLine("---");

        foreach (var result in _results)
        {
            sb.AppendLine($"[{(result.Success ? "PASS" : "FAIL")}] {result.TestName}: {result.Message}");
        }

        var reportContent = sb.ToString();
        var fileName = $"GFC_Camera_Verification_Report_{DateTime.Now:yyyyMMddHHmmss}.txt";

        // Use JS interop to trigger the file download
        var bytes = Encoding.UTF8.GetBytes(reportContent);
        var base64 = Convert.ToBase64String(bytes);
        await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", fileName, base64);
    }
}
