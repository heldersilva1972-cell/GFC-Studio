@page "/keycards"
@implements IDisposable
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using GFC.Core.Interfaces
@using GFC.Core.Models
@using GFC.Core.Services
@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Components.Pages.KeyCardTabs
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using GFC.BlazorServer.Components.Pages.Controllers.Settings
@using GFC.BlazorServer.Models
@using Microsoft.EntityFrameworkCore
@inject IKeyCardRepository KeyCardRepository
@inject IMemberRepository MemberRepository
@inject NavigationManager NavManager
@inject ILogger<KeyCards> Logger
@inject IControllerSyncQueueRepository SyncQueueRepository
@inject IDuesYearSettingsRepository DuesYearSettingsRepository
@inject IBoardRepository BoardRepository
@inject IDuesRepository DuesRepository
@inject ControllerHealthService ControllerHealthService
@inject ControllerFullSyncService ControllerFullSyncService
@inject IControllerClient ControllerClient
@inject IDbContextFactory<GfcDbContext> DbFactory
@inject IJSRuntime JSRuntime
@inject IDuesInsightService DuesInsightService
@inject KeyCardLifecycleService KeyCardLifecycleService
@inject KeyHistoryService KeyHistoryService
@inject AuthenticationStateProvider AuthStateProvider
@inject IMemberAccessService MemberAccessService
@inject ControllerRegistryService ControllerRegistryService
@inject ICommunicationLogService LogService
@inject KeyCardService CardService

<style>
    /* Identify Modal Styles */
    .scan-animation-container {
        position: relative;
        width: 200px;
        height: 120px;
        margin: 0 auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .scan-card {
        font-size: 5rem;
        color: #e2e8f0;
        z-index: 1;
    }

    .scan-beam {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        box-shadow: 0 0 15px #3b82f6;
        animation: scan-beam-anim 2s infinite ease-in-out;
        z-index: 2;
    }

    @@keyframes scan-beam-anim {
        0% { top: 10%; opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { top: 90%; opacity: 0; }
    }

    .identified-member-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
    }

    .member-avatar-large {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border-radius: 50%;
        font-size: 2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
    }

    .card-status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .card-status-badge.active {
        background: #dcfce7;
        color: #166534;
    }

    .card-status-badge.inactive {
        background: #fee2e2;
        color: #991b1b;
    }

    .scanner-input {
        position: absolute;
        opacity: 0;
        width: 1px;
        height: 1px;
        pointer-events: none;
    }

    /* Modern Filter Bar Styles */
    .filter-pills {
        display: flex;
        align-items: center;
        overflow-x: auto;
        padding-bottom: 5px;
        scrollbar-width: none;
    }
    .filter-pills::-webkit-scrollbar { display: none; }

    .filter-pill {
        white-space: nowrap;
        padding: 0.6rem 1.1rem;
        border-radius: 12px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        color: #475569;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .filter-pill:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
        transform: translateY(-1px);
    }

    .filter-pill.active {
        background: white;
        border-color: #6366f1;
        color: #6366f1;
        box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1), 0 2px 4px -1px rgba(99, 102, 241, 0.06);
    }

    .filter-badge {
        background: rgba(0,0,0,0.05);
        color: inherit;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .filter-pill.active .filter-badge {
        background: rgba(99, 102, 241, 0.1);
    }

    .filter-divider {
        width: 1px;
        height: 24px;
        background: #e2e8f0;
        margin: 0 0.5rem;
    }

    .pill-highlight.active {
        background: #eef2ff;
        border-color: #6366f1;
        color: #4f46e5;
    }

    .badge-primary {
        background: #6366f1 !important;
        color: white !important;
    }

    /* Header Action Button Refinement */
    .btn-modern {
        font-weight: 600;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        transition: all 0.2s;
    }

    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .search-box-compact {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-box-compact i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        font-size: 1.1rem;
        z-index: 10;
        pointer-events: none;
    }

    .search-box-compact input {
        border: 2px solid #e2e8f0 !important;
        background: #ffffff !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02) !important;
        transition: all 0.2s ease !important;
    }

    .search-box-compact input:focus {
        border-color: #6366f1 !important;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
        background: #fff !important;
    }

    .btn-clear {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: #f1f5f9;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        cursor: pointer;
        z-index: 11;
    }

    .btn-clear:hover {
        background: #e2e8f0;
        color: #1e293b;
    }
</style>

<PageTitle>Key Card Management - GFC</PageTitle>

<!-- Sticky Page Header -->
<div class="page-header-modern fade-in" style="position: sticky; top: 0; z-index: 100; background: var(--bg-primary); padding-bottom: 0.5rem; margin-bottom: 0;">
    <div class="header-content">
        <div class="header-icon-wrapper">
            <div class="header-icon pulse">
                <i class="bi bi-credit-card-2-front"></i>
            </div>
        </div>
        <div>
            <h1 class="page-title-modern">Key Card Management</h1>
            <p class="page-subtitle">Manage member access cards, monitor activity, and configure permissions</p>
        </div>
    </div>
    <div class="header-actions d-flex align-items-center gap-2">
        @* Grace Period Compact Badge *@
        @if (_graceEndDate.HasValue)
        {
            var daysRemaining = (_graceEndDate.Value - DateTime.Today).Days;
            var badgeClass = daysRemaining > 15 ? "bg-success" : daysRemaining > 0 ? "bg-warning" : "bg-danger";
            var remainingText = daysRemaining > 0 ? $"{daysRemaining} Days Remaining" : (daysRemaining == 0 ? "Expires Today" : "Expired");
            
            <div class="badge @badgeClass text-white d-flex align-items-center gap-2 px-3 py-2 me-2" 
                 style="font-size: 0.85rem; cursor: pointer; font-weight: 600; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2);" 
                 @onclick="EditGracePeriod"
                 title="Click to edit grace period">
                <i class="bi bi-calendar-check" style="font-size: 1rem;"></i>
                <span>Grace Period: <strong style="font-weight: 800;">@remainingText</strong></span>
                <span style="opacity: 0.8; font-size: 0.75rem;">(@_graceEndDate.Value.ToString("MMM d"))</span>
                <i class="bi bi-pencil-fill" style="font-size: 0.7rem; opacity: 0.9; margin-left: 2px;"></i>
            </div>
        }
        
        @if (_activeTab != "assignments" && _activeTab != "pending")
        {
            <button class="btn btn-outline-secondary btn-modern me-2" @onclick='() => SetActiveTab("assignments")'>
                <i class="bi bi-arrow-left"></i>
                <span>Back to Member Cards</span>
            </button>
        }
        
        <button class="btn @(_activeTab == "activity" ? "btn-secondary text-white" : "btn-outline-secondary") btn-modern me-2" @onclick='() => SetActiveTab("activity")'>
            <i class="bi bi-activity"></i>
            <span>Door Activity</span>
        </button>
        <button class="btn btn-outline-info btn-modern me-2" @onclick="() => _hardwareMonitorExpanded = !_hardwareMonitorExpanded">
            <i class="bi bi-hdd-network"></i>
            <span>@(_hardwareMonitorExpanded ? "Hide" : "Show") Hardware Monitor</span>
        </button>
        <button class="btn btn-outline-primary btn-modern me-2" @onclick="OpenIdentifyCardModal">
            <i class="bi bi-search"></i>
            <span>Scan to Identify Card</span>
        </button>
        <button class="btn btn-primary btn-modern" @onclick="OpenAssignCardModal">
            <div class="btn-shine"></div>
            <i class="bi bi-plus-lg"></i>
            <span>Assign New Card</span>
        </button>
    </div>
</div>

@* Hardware Monitor - Full Component (Show/Hide) *@
@if (_hardwareMonitorExpanded)
{
    <div class="mb-2 fade-in">
        <HardwareCommunicationMonitor />
    </div>
}

<!-- Sticky Filter Section (Shared between Assignments and Needing Cards) -->
<div style="position: sticky; top: 130px; z-index: 45; background: #f8fafc; padding: 1rem 1.5rem; margin-bottom: 1.5rem; border: 1px solid #e2e8f0; border-radius: 0 0 16px 16px; box-shadow: 0 10px 15px -10px rgba(0,0,0,0.05);" 
     class="@(_activeTab == "assignments" || _activeTab == "pending" ? "fade-in" : "d-none")">
    <div class="d-flex align-items-center gap-3 mb-3">
        <div class="search-box-compact flex-grow-1" style="max-width: 450px;">
            <i class="bi bi-search"></i>
            <input type="text" 
                   class="form-control form-control-sm" 
                   placeholder="Search members, cards, or IDs..."
                   @bind="_cardSearchTerm"
                   @bind:event="oninput"
                   style="font-size: 0.9rem; padding: 0.5rem 1rem 0.5rem 2.5rem; height: 42px; border-radius: 12px;" />
            @if (!string.IsNullOrEmpty(_cardSearchTerm))
            {
                <button class="btn-clear" @onclick="() => _cardSearchTerm = string.Empty" style="right: 12px;">
                    <i class="bi bi-x-lg"></i>
                </button>
            }
        </div>
        
        <div class="d-flex align-items-center gap-2 ms-auto">
            <div class="view-toggle shadow-sm">
                <button class="btn-toggle @(_cardViewMode == "grid" ? "active" : "")" @onclick='() => _cardViewMode = "grid"' title="Grid View">
                    <i class="bi bi-grid-3x3-gap-fill"></i>
                </button>
                <button class="btn-toggle @(_cardViewMode == "list" ? "active" : "")" @onclick='() => _cardViewMode = "list"' title="List View">
                    <i class="bi bi-list-ul"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="filter-pills gap-2">
        <button class="filter-pill @(_activeTab == "assignments" && _cardStatusFilter == "all" ? "active" : "")" 
                @onclick='() => { SetActiveTab("assignments"); _cardStatusFilter = "all"; }'>
            All Cards <span class="filter-badge">@_countAll</span>
        </button>
        <button class="filter-pill @(_activeTab == "assignments" && _cardStatusFilter == "active" ? "active" : "")" 
                @onclick='() => { SetActiveTab("assignments"); _cardStatusFilter = "active"; }'>
            <i class="bi bi-check-circle-fill text-success"></i> Active <span class="filter-badge">@_countActive</span>
        </button>
        <button class="filter-pill @(_activeTab == "assignments" && _cardStatusFilter == "inactive" ? "active" : "")" 
                @onclick='() => { SetActiveTab("assignments"); _cardStatusFilter = "inactive"; }'>
            <i class="bi bi-pause-circle-fill text-warning"></i> Inactive <span class="filter-badge">@_countInactive</span>
        </button>
        <button class="filter-pill @(_activeTab == "assignments" && _cardStatusFilter == "unpaid" ? "active" : "")" 
                @onclick='() => { SetActiveTab("assignments"); _cardStatusFilter = "unpaid"; }' title="Active cards with unpaid dues">
            <i class="bi bi-clock-history text-info"></i> At Risk <span class="filter-badge">@_countAtRisk</span>
        </button>
        <button class="filter-pill @(_activeTab == "assignments" && _cardStatusFilter == "delinquent" ? "active" : "")" 
                @onclick='() => { SetActiveTab("assignments"); _cardStatusFilter = "delinquent"; }' title="Cards where previous year was also unpaid">
            <i class="bi bi-x-circle-fill text-danger"></i> Delinquent <span class="filter-badge">@_countDelinquent</span>
        </button>
        
        <div class="filter-divider"></div>
        
        <button class="filter-pill pill-highlight @(_activeTab == "pending" ? "active" : "")" 
                @onclick='() => SetActiveTab("pending")'>
            <i class="bi bi-person-badge-fill"></i> Needing Cards <span class="filter-badge badge-primary">@_countNeeding</span>
        </button>
    </div>
</div>

@if (!_controllerOnline)
{
    <div class="alert alert-danger d-flex align-items-center gap-2 mb-2 py-2 fade-in" style="animation-delay: 0.2s; font-size: 0.85rem;">
        <i class="bi bi-wifi-off"></i>
        <div class="flex-grow-1">
            <strong>Controller Offline</strong> - New assignments will be queued
        </div>
        @if (_pendingSyncCount > 0)
        {
            <span class="badge bg-warning text-dark">@_pendingSyncCount pending</span>
        }
        <button class="btn btn-sm btn-outline-danger py-0 px-2" @onclick="ViewSyncQueue" style="font-size: 0.7rem;">
            Queue
        </button>
    </div>
}

<!-- Tab Content with Fade Transition -->
<div class="tab-content-modern">
    <div class="tab-pane fade-in" style="@(_activeTab == "assignments" ? "" : "display:none")">
        @if (_assignmentsTabLoaded)
        {
            <CardAssignmentsTab 
                OnReplaceCard="HandleReplaceCard" 
                OnNeedingCardsClick="@(() => SetActiveTab("pending"))"
                SearchTerm="@_cardSearchTerm"
                StatusFilter="@_cardStatusFilter"
                ViewMode="@_cardViewMode" />
        }
    </div>

    <div class="tab-pane fade-in" style="@(_activeTab == "activity" ? "" : "display:none")">
        @if (_activityTabLoaded)
        {
            <DoorActivityTab />
        }
    </div>

    <div class="tab-pane fade-in" style="@(_activeTab == "access" ? "" : "display:none")">
        @if (_accessTabLoaded)
        {
            <AccessControlTab />
        }
    </div>

    <div class="tab-pane fade-in" style="@(_activeTab == "pending" ? "" : "display:none")">
        @if (_pendingTabLoaded)
        {
            <MembersNeedingCardsTab 
                @ref="_needingCardsTab" 
                OnAssignMember="HandleAssignMember"
                SearchTerm="@_cardSearchTerm"
                ViewMode="@_cardViewMode" />
        }
    </div>
</div>

<!-- Assign Card Modal -->
@if (_showAssignModal)
{
    <div class="modal-backdrop-modern fade-in" @onclick="CloseAssignCardModal"></div>
    <div class="modal-modern-container fade-in scale-in">
        <div class="modal-modern">
            <div class="modal-header-modern">
                <div>
                    <h3 class="modal-title-modern">
                        <i class="bi bi-credit-card-2-front text-primary"></i>
                        Assign New Key Card
                    </h3>
                    <p class="modal-subtitle">Scan a card and assign it to a member</p>
                </div>
                <button class="btn-close-modern" @onclick="CloseAssignCardModal" disabled="@_assigning">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            @if (!_controllerOnline && !_assigning && string.IsNullOrEmpty(_assignSuccessMessage))
            {
                <div class="alert alert-warning border-0 rounded-0 m-0 d-flex align-items-center gap-2" style="font-size: 0.8rem; padding: 0.5rem 1.25rem; background: #fffbeb;">
                    <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                    <span><strong>Controller Offline:</strong> New assignments will be queued and synced automatically.</span>
                </div>
            }
            
            <div class="modal-body-modern">
                <div class="assign-card-content">
                    <!-- Step Indicator -->
                    <div class="steps-indicator" data-step="@_assignStep">
                        <div class="step @(_assignStep >= 1 ? "active" : "") @(_assignStep > 1 ? "completed" : "")">
                            <div class="step-number">
                                @if (_assignStep > 1) { <i class="bi bi-check"></i> } else { <span>1</span> }
                            </div>
                            <div class="step-label">Scan</div>
                        </div>
                        
                        @if (_selectedMemberId == 0)
                        {
                            <div class="step-line"></div>
                            <div class="step @(_assignStep >= 2 ? "active" : "") @(_assignStep > 2 ? "completed" : "")">
                                <div class="step-number">
                                    @if (_assignStep > 2) { <i class="bi bi-check"></i> } else { <span>2</span> }
                                </div>
                                <div class="step-label">Member</div>
                            </div>
                        }

                        <div class="step-line"></div>
                        <div class="step @(_assignStep >= 3 ? "active" : "") @(_assignStep > 3 ? "completed" : "")">
                            <div class="step-number">
                                @if (_assignStep > 3) { <i class="bi bi-check"></i> } 
                                else { <span>@(_selectedMemberId == 0 ? "3" : "2")</span> }
                            </div>
                            <div class="step-label">Card</div>
                        </div>
                        
                        <div class="step-line"></div>
                        <div class="step @(_assignStep >= 4 ? "active" : "") @(_assignStep > 4 ? "completed" : "")">
                            <div class="step-number">
                                @if (_assignStep > 4) { <i class="bi bi-check"></i> } 
                                else { <span>@(_selectedMemberId == 0 ? "4" : "3")</span> }
                            </div>
                            <div class="step-label">Access</div>
                        </div>

                        <div class="step-line"></div>
                        <div class="step @(_assignStep >= 5 ? "active" : "") @(_assignStep > 5 ? "completed" : "")">
                            <div class="step-number">
                                @if (_assignStep > 5) { <i class="bi bi-check"></i> } 
                                else { <span>@(_selectedMemberId == 0 ? "5" : "4")</span> }
                            </div>
                            <div class="step-label">Confirm</div>
                        </div>

                        <div class="step-line"></div>
                        <div class="step @(_assignStep >= 6 ? "active" : "")">
                            <div class="step-number">
                                @if (_assignStep >= 6) { <i class="bi bi-check"></i> } 
                                else { <span>@(_selectedMemberId == 0 ? "6" : "5")</span> }
                            </div>
                            <div class="step-label">Finish</div>
                        </div>
                    </div>


                    <!-- Step 1: Scan Card -->
                    @if (_assignStep == 1)
                    {
                        <div class="step-content fade-in">
                                    <div class="card-scanner-visual">
                                        @if (!_cardScanned)
                                        {
                                            <div class="scanner-animation">
                                                <div class="scanner-icon @(_scanningEnabled ? "pulse-active" : "pulse-slow")">
                                                    <i class="bi bi-upc-scan"></i>
                                                </div>
                                                @if (_scanningEnabled)
                                                {
                                                    <div class="scanner-status-badge">ACTIVE</div>
                                                }
                                                <div class="scanner-waves">
                                                    <div class="wave wave-1"></div>
                                                    <div class="wave wave-2"></div>
                                                    <div class="wave wave-3"></div>
                                                </div>
                                            </div>
                                            <h4 class="mt-4 mb-2">@(_scanningEnabled ? "Waiting for Card..." : "Ready to Scan")</h4>
                                            <p class="scanner-instruction mb-4">
                                                @if (_scanningEnabled)
                                                {
                                                    <span>Tap a card on <strong>ANY reader</strong> or scan with a USB device</span>
                                                }
                                                else
                                                {
                                                    <span>Click below to start enrollment</span>
                                                }
                                            </p>
                                            
                                            <div class="d-flex flex-column gap-2 align-items-center">
                                                @if (!_scanningEnabled)
                                                {
                                                    <button class="btn btn-primary btn-lg btn-scan px-5" @onclick="EnableScanning">
                                                        <i class="bi bi-play-fill me-2"></i> Start Card Read
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-outline-danger px-4" @onclick="CancelScanning">
                                                        Cancel
                                                    </button>
                                                    <div class="mt-3 text-muted small">
                                                        <i class="bi bi-info-circle me-1"></i> Supports network readers and USB wedges
                                                    </div>
                                                }
                                                
                                                @if (!string.IsNullOrEmpty(_assignError))
                                                {
                                                    <div class="alert alert-danger mt-3 slide-in-down">
                                                        <i class="bi bi-exclamation-triangle"></i> @_assignError
                                                    </div>
                                                }
                                            </div>
                                        }
                                else
                                {
                                    <div class="scan-success bounce-in">
                                        <div class="success-checkmark">
                                            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                                                <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                                            </svg>
                                        </div>
                                        <h4 class="status-title-success mt-3">Card Detected!</h4>
                                        <div class="card-number-display my-3">
                                            <span class="text-muted small d-block">CARD NUMBER</span>
                                            <code>@_scannedCardNumber</code>
                                        </div>
                                        <div class="d-flex gap-2 justify-content-center">
                                            <button class="btn btn-outline-secondary" @onclick="EnableScanning">Rescan</button>
                                            <button class="btn btn-outline-danger" @onclick="CloseAssignCardModal">Cancel</button>
                                            <button class="btn btn-primary px-4" @onclick="HandleContinueFromScan">
                                                Continue <i class="bi bi-arrow-right ms-1"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            <!-- Shared Hidden input for capturing keyboard wedge readers -->
                            <div style="position: fixed; top: -100px; left: -100px; width: 1px; height: 1px; opacity: 0; overflow: hidden; pointer-events: none;">
                                <input @ref="_cardInputRef" 
                                       @bind="_keyboardInput" 
                                       @bind:event="oninput" 
                                       @onkeydown="HandleKeyDown"
                                       autocomplete="off" />
                            </div>
                        </div>
                    }

                    <!-- Step 2: Select Member -->
                    @if (_assignStep == 2)
                    {
                        <div class="step-content fade-in">
                            <div class="member-selection">
                                <label class="form-label-modern">Select Member</label>
                                <div class="search-box-modern mb-3">
                                    <i class="bi bi-search"></i>
                                    <input type="text" 
                                           class="form-control" 
                                           placeholder="Search members by name or ID..."
                                           @bind="_memberSearch"
                                           @bind:event="oninput" />
                                </div>
                                
                                <div class="member-list">
                                    @foreach (var member in FilteredMembers.Take(10))
                                    {
                                        <div class="member-card @(_selectedMemberId == member.MemberID ? "selected" : "")"
                                             @onclick="() => SelectMember(member)">
                                            <div class="member-card-icon">
                                                <i class="bi bi-person"></i>
                                            </div>
                                            <div class="member-card-info">
                                                <span class="member-card-name">
                                                    @member.FirstName @member.LastName
                                                </span>
                                                <div class="member-card-meta">
                                                    <span>ID: @member.MemberID</span> â€¢ 
                                                    <span class="text-@GetStatusClass(member.Status)">@member.Status</span>
                                                    @if (_directorIds.Contains(member.MemberID))
                                                    {
                                                        <span class="badge bg-danger text-white ms-1" style="font-size: 0.55rem; padding: 1px 4px;">DIRECTOR</span>
                                                    }
                                                    @if (_unpaidMemberIds.Contains(member.MemberID))
                                                    {
                                                        var atRisk = _atRiskMembers.FirstOrDefault(m => m.MemberId == member.MemberID);
                                                        @if (atRisk != null && atRisk.IsDelinquent)
                                                        {
                                                            <span class="ms-1 badge bg-danger text-white border border-danger border-opacity-25" style="font-size: 0.55rem; padding: 1px 4px;">
                                                                DELINQUENT (Lockout)
                                                            </span>
                                                        }
                                                        else if (atRisk != null && atRisk.InGracePeriod)
                                                        {
                                                            <span class="ms-1 badge bg-warning-subtle text-warning-emphasis border border-warning border-opacity-25" style="font-size: 0.55rem; padding: 1px 4px;">
                                                                GRACE PERIOD (Ends @_graceEndDate?.ToString("MM/dd"))
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="ms-1 badge bg-warning-subtle text-warning-emphasis border border-warning border-opacity-25" style="font-size: 0.55rem; padding: 1px 4px;">
                                                                UNPAID (@_graceEndDate?.ToString("MM/dd"))
                                                            </span>
                                                        }
                                                    }
                                                    else if (member.Status != "LIFE")
                                                    {
                                                        <span class="ms-1 badge bg-success-subtle text-success border border-success border-opacity-25" style="font-size: 0.55rem; padding: 1px 4px;">PAID</span>
                                                    }
                                                </div>
                                            </div>
                                            @if (_selectedMemberId == member.MemberID)
                                            {
                                                <div class="member-card-select">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>

                                <div class="step-actions">
                                    <button class="btn btn-outline-secondary" @onclick="() => _assignStep = 1">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button class="btn btn-primary" @onclick="HandleProceedToCardType" disabled="@(_selectedMemberId == 0)">
                                        Continue <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Step 3: Select Card Type -->
                    @if (_assignStep == 3)
                    {
                        <div class="step-content fade-in">
                            <div class="card-type-selection">
                                <h5 class="mb-3 text-center">Select Access Device Type</h5>
                                <p class="text-muted text-center mb-4">Choose whether you're assigning a card or a fob</p>
                                
                                <div class="card-type-options">
                                    <div class="card-type-option @(_selectedCardType == "Card" ? "selected" : "")" 
                                         @onclick='() => _selectedCardType = "Card"'>
                                        <div class="card-type-icon">
                                            <i class="bi bi-credit-card-2-front"></i>
                                        </div>
                                        <div class="card-type-label">Key Card</div>
                                        <div class="card-type-description">Standard access card</div>
                                        @if (_selectedCardType == "Card")
                                        {
                                            <div class="card-type-check">
                                                <i class="bi bi-check-circle-fill"></i>
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="card-type-option @(_selectedCardType == "Fob" ? "selected" : "")" 
                                         @onclick='() => _selectedCardType = "Fob"'>
                                        <div class="card-type-icon">
                                            <i class="bi bi-key-fill"></i>
                                        </div>
                                        <div class="card-type-label">Key Fob</div>
                                        <div class="card-type-description">Keychain access fob</div>
                                        @if (_selectedCardType == "Fob")
                                        {
                                            <div class="card-type-check">
                                                <i class="bi bi-check-circle-fill"></i>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="step-actions">
                                    <button class="btn btn-outline-secondary" @onclick="() => _assignStep = 2">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button class="btn btn-primary" @onclick="HandleProceedToAccessRights" disabled="@(string.IsNullOrEmpty(_selectedCardType))">
                                        Continue <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Step 4: Access Rights -->
                    @if (_assignStep == 4)
                    {
                        <div class="step-content fade-in">
                            <div class="access-rights-selection">
                                <h5 class="mb-3 text-center">Configure Access Rights</h5>
                                <p class="text-muted text-center mb-4">Select which doors this card can open</p>
                                
                                <div class="doors-list-container mb-4" style="max-height: 300px; overflow-y: auto;">
                                    @if (!_availableDoors.Any())
                                    {
                                        <div class="text-center p-4 text-muted">
                                            <i class="bi bi-door-closed" style="font-size: 2rem;"></i>
                                            <p class="mt-2">No doors available for configuration.</p>
                                        </div>
                                    }
                                    else 
                                    {
                                        <div class="list-group">
                                            @foreach (var door in _availableDoors)
                                            {
                                                var isSelected = _selectedDoorIds.Contains(door.Id);
                                                <div class="list-group-item list-group-item-action d-flex align-items-center justify-content-between @(isSelected ? "list-group-item-primary" : "")" 
                                                     @onclick="() => ToggleDoorSelection(door.Id)" style="cursor: pointer;">
                                                    <div>
                                                        <h6 class="mb-0">
                                                            <i class="bi bi-door-open me-2"></i> @door.Name
                                                        </h6>
                                                        <small class="text-muted">@(door.Controller?.Name ?? "Unknown Controller")</small>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" checked="@isSelected" readonly style="pointer-events: none;">
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                                
                                <div class="step-actions">
                                    <button class="btn btn-outline-secondary" @onclick="() => _assignStep = 3">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button class="btn btn-primary" @onclick="HandleProceedToConfirm" disabled="@(!_selectedDoorIds.Any())">
                                        Continue <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Step 5: Confirm -->
                    @if (_assignStep == 5)
                    {
                        <div class="step-content fade-in">
                            <div class="confirmation-summary">
                                <div class="summary-card">
                                    <div class="summary-label mb-2" style="font-weight: 800; color: #475569;">Assignment Summary</div>
                                    <div class="summary-row">
                                        <span class="summary-label">Card Number:</span>
                                        <span class="summary-value"><code>@_scannedCardNumber</code></span>
                                    </div>
                                    <div class="summary-row">
                                        <span class="summary-label">Member:</span>
                                        <span class="summary-value">@_selectedMemberName</span>
                                    </div>
                                    <div class="summary-row">
                                        <span class="summary-label">Issued Date:</span>
                                        <span class="summary-value">@DateTime.Today.ToString("MMMM dd, yyyy")</span>
                                    </div>
                                    <div class="summary-row">
                                        <span class="summary-label">Device Type:</span>
                                        <span class="summary-value">
                                            <span class="badge bg-primary">
                                                <i class="bi bi-@(_selectedCardType == "Fob" ? "key-fill" : "credit-card-2-front") me-1"></i>
                                                @_selectedCardType
                                            </span>
                                        </span>
                                    </div>
                                    <div class="summary-row">
                                        <span class="summary-label">Dues Status:</span>
                                        <span class="summary-value d-flex align-items-center gap-1">
                                            @{
                                                var atRisk = _atRiskMembers.FirstOrDefault(m => m.MemberId == _selectedMemberId);
                                            }
                                            @if (atRisk != null)
                                            {
                                                @if (atRisk.IsDelinquent)
                                                {
                                                    <span class="text-danger fw-bold"><i class="bi bi-x-circle-fill me-1"></i>Delinquent (No access)</span>
                                                }
                                                else
                                                {
                                                    <span class="text-warning fw-bold"><i class="bi bi-exclamation-triangle-fill me-1"></i>Grace Period (Expires @_graceEndDate?.ToString("MMM dd"))</span>
                                                }
                                            }
                                            else if (_unpaidMemberIds.Contains(_selectedMemberId))
                                            {
                                                <span class="text-warning fw-bold"><i class="bi bi-exclamation-triangle-fill me-1"></i>Unpaid (Expires @_graceEndDate?.ToString("MMM dd"))</span>
                                            }
                                            else
                                            {
                                                <span class="text-success fw-bold"><i class="bi bi-check-circle-fill me-1"></i>All Dues Paid</span>
                                            }
                                        </span>
                                    </div>
                                </div>

                                <div class="form-group-modern">
                                    <label class="form-label-modern">Notes (Optional)</label>
                                    <textarea class="form-control" rows="3" @bind="_assignNotes" placeholder="Add any notes about this assignment..."></textarea>
                                </div>

                                @if (!string.IsNullOrEmpty(_assignError))
                                {
                                    <div class="alert alert-danger slide-in-down">
                                        <i class="bi bi-exclamation-triangle"></i> @_assignError
                                    </div>
                                }

                                <div class="step-actions">
                                    <button class="btn btn-outline-secondary" @onclick="HandleBackFromConfirm" disabled="@_assigning">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button class="btn btn-primary px-4" @onclick="ConfirmAssignment" disabled="@_assigning">
                                        @if (_assigning)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <span>Processing...</span>
                                        }
                                        else
                                        {
                                            <span><i class="bi bi-shield-check me-2"></i> Confirm & Sync</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Step 6: Final Feedback -->
                    @if (_assignStep == 6)
                    {
                        <div class="step-content fade-in text-center py-3">
                            <div class="success-checkmark mb-3 mx-auto">
                                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" style="stroke: #10b981;"/>
                                    <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" style="stroke: #10b981;"/>
                                </svg>
                            </div>
                            
                            <h4 class="mb-2">Assignment Processed</h4>
                            <p class="text-muted small px-4 mb-4">@_assignSuccessMessage</p>
                            
                            @if (_pendingSyncCount > 0 && !_controllerOnline)
                            {
                                <div class="sync-queue-tip mb-4 p-3 rounded-3" style="background: #f8fafc; border: 1px solid #e2e8f0; text-align: left;">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <i class="bi bi-info-circle text-info"></i>
                                        <span class="fw-800 small text-uppercase" style="letter-spacing: 0.5px;">Sync Logic</span>
                                    </div>
                                    <div class="small text-muted">
                                        The system is waiting for the controller to come back online. You can monitor the progress in the 
                                        <a href="/keycards/sync-queue" class="text-primary text-decoration-none fw-bold" @onclick="CloseAssignCardModal">Sync Queue</a>.
                                    </div>
                                </div>
                            }

                            <div class="step-actions">
                                <button class="btn btn-success px-5" @onclick="CloseAssignCardModal">
                                    Done
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- Identify Card Modal -->
@if (_showIdentifyModal)
{
    <div class="modal-backdrop-modern fade-in" @onclick="CloseIdentifyModal"></div>
    <div class="modal-modern-container fade-in scale-in">
        <div class="modal-modern" style="max-width: 500px;">
            <div class="modal-header-modern">
                <div>
                    <h3 class="modal-title-modern">
                        <i class="bi bi-person-badge text-primary"></i>
                        Identify Card
                    </h3>
                    <p class="modal-subtitle">Scan a card to find the member</p>
                </div>
                <button class="btn-close-modern" @onclick="CloseIdentifyModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="modal-body-modern text-center py-4">
                @if (_identifiedCard == null)
                {
                    <div class="scan-animation-container mb-4">
                        <div class="scan-card">
                            <i class="bi bi-credit-card-2-front"></i>
                        </div>
                        <div class="scan-beam"></div>
                    </div>
                    
                    <h5 class="mb-2">Waiting for Scan...</h5>
                    <p class="text-muted small mb-0">Tap your card on the reader</p>
                    
                    @if (!string.IsNullOrEmpty(_identifyError))
                    {
                        <div class="alert alert-danger mt-3 mb-0 d-flex align-items-center justify-content-center gap-2">
                             <i class="bi bi-exclamation-circle-fill"></i> @_identifyError
                        </div>
                    }
                }
                else
                {
                    <div class="identified-member-card fade-in scale-in">
                        <div class="member-avatar-large mb-3 mx-auto">
                            @GetInitials(_identifiedMemberName)
                        </div>
                        
                        <h4 class="mb-1">@_identifiedMemberName</h4>
                        <p class="text-muted mb-3">Member #@_identifiedMemberId</p>
                        
                        <div class="card-status-badge mb-4 @(_identifiedCard.IsActive ? "active" : "inactive")">
                            @if (_identifiedCard.IsActive)
                            {
                                <i class="bi bi-check-circle-fill me-1"></i> <span>Active Card</span>
                            }
                            else
                            {
                                <i class="bi bi-x-circle-fill me-1"></i> <span>Inactive Card</span>
                            }
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            @if (_identifiedCard.IsActive)
                            {
                                <button class="btn btn-outline-danger" @onclick="DeactivateIdentifiedCard">
                                    <i class="bi bi-lock-fill me-1"></i> Deactivate
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-outline-success" @onclick="ReactivateIdentifiedCard">
                                    <i class="bi bi-unlock-fill me-1"></i> Reactivate
                                </button>
                            }
                            <button class="btn btn-outline-secondary" @onclick="HandleScanAnother">
                                <i class="bi bi-arrow-repeat me-1"></i> Scan Another
                            </button>
                            <button class="btn btn-primary px-4" @onclick="CloseIdentifyModal">
                                Done
                            </button>
                        </div>
                    </div>
                }
            </div>
            
            <!-- Hidden input for scanner focus -->
            <input @ref="_identifyInputRef" 
                   class="scanner-input" 
                   @bind="_identifyInput" 
                   @bind:event="oninput"
                   @onkeydown="HandleIdentifyKeyDown"
                   @onblur="KeepIdentifyFocus"
                   autocomplete="off" />
        </div>
    </div>
}

<!-- Grace Period Edit Modal - NEW -->
@if (_showGracePeriodModal)
{
    <div class="modal-backdrop-modern fade-in" @onclick="CloseGracePeriodModal"></div>
    <div class="modal-modern-container fade-in scale-in">
        <div class="modal-modern">
            <div class="modal-header-modern">
                <div>
                    <h3 class="modal-title-modern">
                        <i class="bi bi-calendar-check text-success"></i>
                        Configure Grace Period
                    </h3>
                    <p class="modal-subtitle">Set the grace end date for @DateTime.Today.Year dues</p>
                </div>
                <button class="btn-close-modern" @onclick="CloseGracePeriodModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="modal-body-modern">
                <div class="grace-period-config">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle"></i>
                        <div>
                            <strong>About Grace Period:</strong>
                            <p class="mb-0 small">Members who paid last year can continue using their key cards until this recurring date.</p>
                        </div>
                    </div>

                    <div class="form-group-modern mb-4">
                        <label class="form-label-modern">
                            Recurring Deadline <span class="text-danger">*</span>
                        </label>
                        <div class="d-flex gap-3">
                            <select class="form-select form-select-lg" @bind="_gracePeriodMonth">
                                @for (int m = 1; m <= 12; m++)
                                {
                                    <option value="@m">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
                                }
                            </select>
                            <select class="form-select form-select-lg" style="width: 100px;" @bind="_gracePeriodDay">
                                @for (int d = 1; d <= 31; d++)
                                {
                                    <option value="@d">@d</option>
                                }
                            </select>
                        </div>
                        <small class="text-muted">
                            Setting "April 1st" means cards expire on April 1st, @DateTime.Today.Year.
                        </small>
                    </div>

                    <div class="summary-card mb-4">
                        <h6 class="mb-3">Summary</h6>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Selected Date:</span>
                            <strong>@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(_gracePeriodMonth) @_gracePeriodDay</strong>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Effect:</span>
                            <span class="badge bg-primary">Recurs Annually</span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_gracePeriodError))
                    {
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> @_gracePeriodError
                        </div>
                    }

                    <div class="modal-actions">
                        <button class="btn btn-outline-secondary" 
                                @onclick="CloseGracePeriodModal" 
                                disabled="@_savingGracePeriod">
                            Cancel
                        </button>
                        <button class="btn btn-success btn-lg" 
                                @onclick="RequestSaveGracePeriod" 
                                disabled="@_savingGracePeriod">
                            @if (_savingGracePeriod)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <i class="bi bi-check-circle"></i>
                                <span>Save Grace Period</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string _activeTab = "assignments";
    private bool _showAssignModal = false;
    private int _assignStep = 1;
    private bool _scanningEnabled = false;
    private bool _cardScanned = false;
    private string _scannedCardNumber = string.Empty;
    private int _selectedMemberId = 0;
    private string _selectedMemberName = string.Empty;
    private string _memberSearch = string.Empty;
    private string _selectedCardType = "Card"; // Card or Fob
    private string _assignNotes = string.Empty;
    private bool _assigning = false;
    private string _assignError = string.Empty;
    private string _assignSuccessMessage = string.Empty;
    
    private List<Member> _allMembers = new();
    
    // Grace Period & Sync Status - NEW
    private DateTime? _graceEndDate;
    private int _membersAtRiskCount = 0;
    private int _pendingSyncCount = 0;
    private DateTime? _lastSyncTime;
    private bool _controllerOnline = true;
    
    // Grace Period Modal - NEW
    private bool _showGracePeriodModal = false;
    private int _gracePeriodMonth = 4; // Default April
    private int _gracePeriodDay = 1;   // Default 1st
    private bool _savingGracePeriod = false;
    private string _gracePeriodError = string.Empty;
    private bool _isAutoSelectedMember = false;
    
    private int _paidMembersWithoutCardsCount = 0;
    private HashSet<int> _directorIds = new();
    private HashSet<int> _unpaidMemberIds = new();
    private List<MemberAtRiskDto> _atRiskMembers = new();
    
    // Scanning state
    private CancellationTokenSource? _scanCts;
    private ElementReference _cardInputRef;
    private string _keyboardInput = string.Empty;

    // Tab Lazy Loading State
    private bool _assignmentsTabLoaded = true; // Default tab
    private bool _activityTabLoaded = false;
    private bool _accessTabLoaded = false;
    private bool _pendingTabLoaded = false;

    private void SetActiveTab(string tab)
    {
        _activeTab = tab;
        if (tab == "assignments") _assignmentsTabLoaded = true;
        if (tab == "activity") _activityTabLoaded = true;
        if (tab == "access") _accessTabLoaded = true;
        if (tab == "pending") _pendingTabLoaded = true;
    }
    
    // Card Filter State (shared with CardAssignmentsTab)
    private string _cardSearchTerm = string.Empty;
    private string _cardStatusFilter = "all";
    private string _cardViewMode = "grid";
    
    // Card Counts for Filter Bar
    private int _countAll = 0;
    private int _countActive = 0;
    private int _countInactive = 0;
    private int _countAtRisk = 0;
    private int _countDelinquent = 0;
    private int _countNeeding = 0;
    
    private GFC.BlazorServer.Components.Pages.KeyCardTabs.MembersNeedingCardsTab? _needingCardsTab;

    // Identify Card Logic
    private bool _showIdentifyModal = false;
    private ElementReference _identifyInputRef;
    private string _identifyInput = string.Empty;
    private string _identifyError = string.Empty;
    private KeyCard? _identifiedCard;
    private string _identifiedMemberName = string.Empty;
    private int _identifiedMemberId;

    // Confirmation Modal State
    private bool _showConfirmModal = false;
    private string _confirmTitle = "";
    private string _confirmMessage = "";
    private string _confirmSubMessage = "";
    private string _confirmActionText = "";
    private string _confirmIcon = "";
    private ConfirmActionModal.ConfirmType _confirmType;
    private Func<Task>? _confirmAction;
    
    // Hardware Monitor State
    private bool _hardwareMonitorExpanded = false;
    private string? _lastCommand = null;


    private async Task HandleConfirmedAction()
    {
        if (_confirmAction != null)
        {
            try
            {
                _showConfirmModal = false;
                StateHasChanged(); // Hide modal immediately
                await _confirmAction();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error performing confirmed action");
            }
            finally
            {
                StateHasChanged();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var sw = System.Diagnostics.Stopwatch.StartNew();
        Logger.LogInformation("KeyCards page initialization started");
        
        // NOTE: We don't load members here because CardAssignmentsTab loads all the data it needs
        // Including members, cards, dues, board assignments, etc.
        // Loading members here would be redundant and slow down the page load
        
        await LoadGracePeriodAndSyncStatusAsync();
        await LoadCardCountsAsync();
        Logger.LogInformation("LoadGracePeriodAndSyncStatusAsync completed in {ms}ms", sw.ElapsedMilliseconds);
        
        _ = StartStatusRefresh();
        Logger.LogInformation("KeyCards page initialization completed in {ms}ms total", sw.ElapsedMilliseconds);
    }
    
    private async Task LoadCardCountsAsync()
    {
        try
        {
            var year = DateTime.Today.Year;
            var settings = await Task.Run(() => DuesYearSettingsRepository.GetSettingsForYear(year));
            var cards = await Task.Run(() => KeyCardRepository.GetAll());
            
            // For counts, we need some context-heavy calculation (eligibility)
            var membersList = await Task.Run(() => MemberRepository.GetAllMembers());
            var duesCurrent = await Task.Run(() => DuesRepository.GetDuesForYear(year));
            var duesPrev = await Task.Run(() => DuesRepository.GetDuesForYear(year - 1));
            var boardCurrentList = await Task.Run(() => BoardRepository.GetAssignmentsByYear(year));
            var boardPrevList = await Task.Run(() => BoardRepository.GetAssignmentsByYear(year - 1));

            var duesCurrentMap = duesCurrent.ToDictionary(d => d.MemberID);
            var duesPrevMap = duesPrev.ToDictionary(d => d.MemberID);
            var boardCurrent = boardCurrentList.Select(a => a.MemberID).ToHashSet();
            var boardPrev = boardPrevList.Select(a => a.MemberID).ToHashSet();
            var cardMemberIds = cards.Select(c => c.MemberId).Distinct().ToHashSet();

            // Calculate Counts
            _countAll = cards.Count;
            _countActive = cards.Count(c => c.IsActive);
            _countInactive = cards.Count(c => !c.IsActive);
            
            _countAtRisk = 0;
            _countDelinquent = 0;
            
            foreach (var card in cards.Where(c => c.IsActive))
            {
                var member = membersList.FirstOrDefault(m => m.MemberID == card.MemberId);
                if (member == null) continue;

                bool currentSatisfied = boardCurrent.Contains(card.MemberId) || (duesCurrentMap.TryGetValue(card.MemberId, out var dc) && KeyCardService.IsDuesSatisfied(dc.PaymentType, dc.PaidDate));
                bool prevSatisfied = boardPrev.Contains(card.MemberId) || (duesPrevMap.TryGetValue(card.MemberId, out var dp) && KeyCardService.IsDuesSatisfied(dp.PaymentType, dp.PaidDate));
                
                var eligibility = CardService.GetEligibilityBulk(member, year, settings, currentSatisfied, prevSatisfied);
                
                if (!eligibility.CurrentYearSatisfied)
                {
                    _countAtRisk++;
                    if (!eligibility.Eligible && !eligibility.GracePeriodActive)
                    {
                        _countDelinquent++;
                    }
                }
            }

            // Needing Cards Count
            _countNeeding = 0;
            foreach (var m in membersList)
            {
                if (!cardMemberIds.Contains(m.MemberID))
                {
                    bool currentSatisfied = boardCurrent.Contains(m.MemberID) || (duesCurrentMap.TryGetValue(m.MemberID, out var dc) && KeyCardService.IsDuesSatisfied(dc.PaymentType, dc.PaidDate));
                    bool prevSatisfied = boardPrev.Contains(m.MemberID) || (duesPrevMap.TryGetValue(m.MemberID, out var dp) && KeyCardService.IsDuesSatisfied(dp.PaymentType, dp.PaidDate));
                    
                    var eligibility = CardService.GetEligibilityBulk(m, year, settings, currentSatisfied, prevSatisfied);
                    if (eligibility.Eligible)
                    {
                        _countNeeding++;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading card counts");
        }
    }
    
    private async Task LoadGracePeriodAndSyncStatusAsync()
    {
        try
        {
            var currentYear = DateTime.Today.Year;
            
            // 1. Load Essential Data Sequentially (avoids excessive connection pooling/locking, Task.Run avoids UI freeze)
            var settings = await Task.Run(() => DuesYearSettingsRepository.GetSettingsForYear(currentYear));
            var boardAssignments = await Task.Run(() => BoardRepository.GetAssignmentsByYear(currentYear));
            var pendingSyncs = await SyncQueueRepository.GetPendingItemsAsync();
            var completedSyncs = await SyncQueueRepository.GetByStatusAsync("COMPLETED");

            // 2. Assign Results
            _graceEndDate = settings?.GraceEndDate;
            _directorIds = boardAssignments.Select(a => a.MemberID).ToHashSet();
            _unpaidMemberIds = new HashSet<int>(); // Not needed for card display
            _atRiskMembers = new List<MemberAtRiskDto>(); // Not needed for card display  
            _membersAtRiskCount = 0; // Not needed for card display
            
            // Simplified: Just use pending syncs count (detailed card metrics are in CardAssignmentsTab)
            _pendingSyncCount = pendingSyncs.Count;
            
            _lastSyncTime = completedSyncs.Any() 
                ? completedSyncs.Max(x => x.CompletedDate ?? x.QueuedDate)
                : null;
            
            _controllerOnline = ControllerHealthService.GetHealthStatus().IsOnline;
            
            // Refresh counts as well
            await LoadCardCountsAsync();

            // NOTE: Removed _paidMembersWithoutCardsCount calculation - requires loading all cards
            // This metric is available in the CardAssignmentsTab which loads cards anyway
            _paidMembersWithoutCardsCount = 0;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading grace period and sync status");
        }
    }
    
    private async Task LoadMembersAsync()
    {
        try
        {
            var members = await Task.Run(() => MemberRepository.GetAllMembers());
            _allMembers = members
                .Where(m => !m.Status.Equals("DECEASED", StringComparison.OrdinalIgnoreCase))
                .OrderBy(m => m.LastName)
                .ThenBy(m => m.FirstName)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading members");
        }
    }
    
    private IEnumerable<Member> FilteredMembers
    {
        get
        {
            if (_allMembers == null)
                return Enumerable.Empty<Member>();

            if (string.IsNullOrWhiteSpace(_memberSearch))
                return _allMembers;
            
            var search = _memberSearch.ToLower();
            return _allMembers.Where(m =>
                (m.FirstName != null && m.FirstName.ToLower().Contains(search)) ||
                (m.LastName != null && m.LastName.ToLower().Contains(search)) ||
                m.MemberID.ToString().Contains(search));
        }
    }
    

    
    protected override async Task OnParametersSetAsync()
    {
        // Check for assignTo query parameter
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("assignTo", out var memberIdVal))
        {
            if (int.TryParse(memberIdVal, out var mid))
            {
                await HandleAssignMember(mid);
            }
        }
    }

    private async Task HandleAssignMember(int memberId)
    {
        // Load members on-demand when assigning a card (not on page load)
        if (!_allMembers.Any()) await LoadMembersAsync();
        
        var member = _allMembers.FirstOrDefault(m => m.MemberID == memberId);
        if (member != null && !_showAssignModal)
        {
            OpenAssignCardModalForMember(member);
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initial load is handled in OnParametersSetAsync and OnInitializedAsync
        }
    }

    private async Task OpenAssignCardModal()
    {
        // Load members on-demand for the member search dropdown
        if (!_allMembers.Any()) await LoadMembersAsync();
        
        _showAssignModal = true;
        _assignStep = 1;
        _cardScanned = false;
        _scannedCardNumber = string.Empty;
        _selectedMemberId = 0;
        _selectedMemberName = string.Empty;
        _memberSearch = string.Empty;
        _selectedCardType = "Card";
        _assignNotes = string.Empty;
        _assignError = string.Empty;
    }

    private async Task OpenAssignCardModalForMember(Member member)
    {
        await OpenAssignCardModal();
        _isAutoSelectedMember = true;
        _selectedMemberId = member.MemberID;
        _selectedMemberName = $"{member.FirstName} {member.LastName}";
        _memberSearch = member.MemberID.ToString(); // Pre-filter the list so they see the selection clearly
        // Optional: Could set specific message or note
    }
    
    private void CloseAssignCardModal()
    {
        _showAssignModal = false;
        StopScanning();
    }
    
    private async Task EnableScanning()
    {
        _scanningEnabled = true;
        _cardScanned = false;
        _scannedCardNumber = string.Empty;
        _keyboardInput = string.Empty;
        
        _scanCts?.Cancel();
        _scanCts = new CancellationTokenSource();
        
        try 
        {
            await Task.Delay(150);
            await _cardInputRef.FocusAsync();
        } 
        catch (Exception ex)
        {
            Logger.LogWarning("Could not focus card input: {Message}", ex.Message);
        }

        // Start background polling for network readers
        _ = PollForNetworkCardRead(_scanCts.Token);
    }

    private void CancelScanning()
    {
        StopScanning();
    }

    private void StopScanning()
    {
        _scanningEnabled = false;
        _scanCts?.Cancel();
        _keyboardInput = string.Empty;
    }

    private async Task PollForNetworkCardRead(CancellationToken token)
    {
        var startTime = DateTime.UtcNow;
        var timeout = TimeSpan.FromMinutes(2);

        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            while (!token.IsCancellationRequested)
            {
                if (DateTime.UtcNow - startTime > timeout)
                {
                     StopScanning();
                     await InvokeAsync(StateHasChanged);
                     break;
                }

                // Look for ANY card read from ANY controller in the last few seconds
                var cardEvent = await db.ControllerEvents
                    .Where(e => e.TimestampUtc > startTime && e.CardNumber != null)
                    .OrderBy(e => e.TimestampUtc)
                    .FirstOrDefaultAsync(token);

                if (cardEvent != null)
                {
                    _scannedCardNumber = cardEvent.CardNumber.ToString();
                    _cardScanned = true;
                    StopScanning();
                    await InvokeAsync(StateHasChanged);
                    break;
                }

                await Task.Delay(1000, token);
            }
        }
        catch (TaskCanceledException) { }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error polling for network card read");
        }
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            if (!string.IsNullOrWhiteSpace(_keyboardInput))
            {
                _scannedCardNumber = _keyboardInput.Trim();
                
                // Check for duplicate immediately
                var existingCard = await Task.Run(() => KeyCardRepository.GetByCardNumber(_scannedCardNumber));
                if (existingCard != null)
                {
                    _assignError = $"Card #{_scannedCardNumber} is already assigned to another member.";
                    _cardScanned = false;
                    _scannedCardNumber = string.Empty;
                    _keyboardInput = string.Empty;
                    StateHasChanged();
                    return;
                }
                
                _cardScanned = true;
                _assignError = string.Empty;
                StopScanning();
                StateHasChanged();
            }
        }
        else if (e.Key == "Escape")
        {
            StopScanning();
            StateHasChanged();
        }
    }
    
    private void HandleCardScan(KeyboardEventArgs e)
    {
        // Legacy method, replaced by HandleKeyDown via hidden input
    }
    
    private void HandleContinueFromScan()
    {
        if (_selectedMemberId != 0)
        {
            _assignStep = 3;
        }
        else
        {
            _assignStep = 2;
        }
    }

    private void SelectMember(Member member)
    {
        _isAutoSelectedMember = false;
        _selectedMemberId = member.MemberID;
        _selectedMemberName = $"{member.FirstName} {member.LastName}";
    }

    // Adding Access Rights Fields
    private List<GFC.BlazorServer.Data.Entities.Door> _availableDoors = new();
    private HashSet<int> _selectedDoorIds = new();

    private async Task LoadDoorsForAssignment()
    {
        var controllers = await ControllerRegistryService.GetControllersAsync(includeDoors: true);
        _availableDoors = controllers.SelectMany(c => c.Doors).ToList();
        // Default to selecting all doors
        _selectedDoorIds = _availableDoors.Select(d => d.Id).ToHashSet();
    }

    private void ToggleDoorSelection(int doorId)
    {
        if (_selectedDoorIds.Contains(doorId))
            _selectedDoorIds.Remove(doorId);
        else
            _selectedDoorIds.Add(doorId);
    }

    private async Task HandleProceedToAccessRights()
    {
        await LoadDoorsForAssignment();
        _assignStep = 4;
    }

    private void HandleProceedToConfirm()
    {
        _assignStep = 5;
    }

    private void HandleProceedToCardType()
    {
        _assignStep = 3; // Go to card type selection
    }

    private void HandleBackFromConfirm()
    {
        _assignStep = 4; // Go back to access rights selection
    }
    
    private async Task ConfirmAssignment()
    {
        _assigning = true;
        _assignError = string.Empty;
        _assignSuccessMessage = string.Empty;
        
        try
        {
            if (_selectedDoorIds == null || !_selectedDoorIds.Any())
            {
                _assignError = "Please select at least one door for access selection before confirming.";
                _assigning = false;
                StateHasChanged();
                return;
            }
            // Check if member already has an active card
            var allCards = await Task.Run(() => KeyCardRepository.GetAll());
            var memberActiveCard = allCards.FirstOrDefault(c => c.MemberId == _selectedMemberId && c.IsActive);
            if (memberActiveCard != null)
            {
                _assignError = $"Member already has an active card (#{memberActiveCard.CardNumber}). Please deactivate it first or use the Replace function.";
                return;
            }
            
            // 1. Create the new card in database
            var newCard = await Task.Run(() => 
                KeyCardRepository.Create(_scannedCardNumber, _selectedMemberId, _assignNotes, _selectedCardType));

            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = authState.User.Identity?.Name ?? "Unknown";
                
                // Log to KeyHistory
                if (long.TryParse(_scannedCardNumber, out long cardNumberLong))
                {
                    await KeyHistoryService.LogAssignmentAsync(_selectedMemberId, cardNumberLong, _assignNotes ?? "New Assignment", user, _selectedCardType);
                }
                
                Logger.LogInformation("Card {CardNumber} ({CardType}) assigned to member {MemberId} in DB by {User}", _scannedCardNumber, _selectedCardType, _selectedMemberId, user);

                // Grant permissions based on selection
                if (_selectedDoorIds.Any())
                {
                    var updates = _availableDoors.Select(d => new MemberDoorAccessUpdateDto 
                    {
                         DoorId = d.Id,
                         CardNumber = _scannedCardNumber,
                         IsEnabled = _selectedDoorIds.Contains(d.Id),
                         TimeProfileId = 1 // Default 24/7
                    }).ToList();
                    
                    await MemberAccessService.UpdateMemberDoorAccessAsync(_selectedMemberId, updates);
                    Logger.LogInformation("Updated door access for member {MemberId} with {Count} doors", _selectedMemberId, _selectedDoorIds.Count);
                }

                // Sync Privileges (which pushes to controller)
                // Use the lifecycle service which now handles immediate sync + automatic queuing fallback
                await KeyCardLifecycleService.SyncCardToControllerAsync(newCard.KeyCardId, true);
                
                Logger.LogInformation("Dispatched sync for new card {CardNumber} to member {MemberId}", _scannedCardNumber, _selectedMemberId);
            }
            catch (Exception syncEx)
            {
                // CRITICAL ROLLBACK: For Business Rule or Validation failures
                // Note: Communication timeouts are handled by the dispatcher (stays in PENDING queue)
                Logger.LogError(syncEx, "Sync failed for card {CardNumber}. Rolling back DB record if it was a data error.", _scannedCardNumber);
                throw; // Rethrow to show UI error
            }


            // 3. Close modal and show feedback
            _assigning = false;
            
            _assignSuccessMessage = $"Card #{_scannedCardNumber} has been successfully assigned and activated for {_selectedMemberName}.";
            _assignStep = 6; // New completion step
            
            // Refresh counts and lists
            await LoadGracePeriodAndSyncStatusAsync();
            if (_needingCardsTab != null)
            {
                await _needingCardsTab.RefreshAsync();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error assigning card");
            _assignError = "Failed to assign card. Please try again.";
            _assigning = false;
        }
    }

    private async Task HandleReplaceCard(int cardId)
    {
        try
        {
            var card = await Task.Run(() => KeyCardRepository.GetById(cardId));
            if (card == null) return;

            // Deactivate
            if (card.IsActive)
            {
                _confirmTitle = "Replace Key Card";
                _confirmMessage = $"Are you sure you want to REPLACE Card #{card.CardNumber}?";
                _confirmSubMessage = "The current card will be deactivated immediately. You will then be prompted to assign a new physical card.";
                _confirmActionText = "Confirm Replacement";
                _confirmType = ConfirmActionModal.ConfirmType.Warning;
                _confirmIcon = "bi-arrow-repeat";
                _confirmAction = async () => 
                {
                    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                    var user = authState.User.Identity?.Name ?? "Unknown";

                    // Deactivate and proceed to scan new card
                    await KeyCardLifecycleService.DeactivateCardAsync(
                        card.KeyCardId, 
                        "Replaced", 
                        "User initiated replacement via UI", 
                        user,
                        System.Threading.CancellationToken.None);
                    
                    // Log revocation to KeyHistory
                    if (long.TryParse(card.CardNumber, out long cardNumberLong))
                    {
                        await KeyHistoryService.LogRevocationAsync(card.MemberId, cardNumberLong, $"Replacing with new card", user);
                    }

                    await LoadGracePeriodAndSyncStatusAsync();
                    
                    _scannedCardNumber = string.Empty;
                    _selectedMemberId = card.MemberId;
                    _selectedMemberName = await GetMemberNameAsync(card.MemberId);
                    _assignNotes = $"Replacement for card #{card.CardNumber}";
                    _assignStep = 1;
                    _showAssignModal = true;
                    StateHasChanged();
                };
                _showConfirmModal = true;
                return;
            }

            // Open Assign Modal
            // We need to ensure members are loaded
            if (!_allMembers.Any()) await LoadMembersAsync();
            
            var member = _allMembers.FirstOrDefault(m => m.MemberID == card.MemberId);
            if (member != null)
            {
                OpenAssignCardModalForMember(member);
                _assignNotes = $"Replacing Card #{card.CardNumber}";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling replace card");
        }
    }
    
    // Grace Period & Sync Actions - NEW
    // Grace Period & Sync Actions - NEW
    private void EditGracePeriod()
    {
        // Default to April 1st if not set, otherwise parse existing date
        if (_graceEndDate.HasValue)
        {
            _gracePeriodMonth = _graceEndDate.Value.Month;
            _gracePeriodDay = _graceEndDate.Value.Day;
        }
        else
        {
            _gracePeriodMonth = 4;
            _gracePeriodDay = 1;
        }

        _gracePeriodError = string.Empty;
        _showGracePeriodModal = true;
    }
    
    private void CloseGracePeriodModal()
    {
        _showGracePeriodModal = false;
        _gracePeriodError = string.Empty;
    }

    private void RequestSaveGracePeriod()
    {
        // 1. Validate Day in Month
        int daysInMonth = DateTime.DaysInMonth(DateTime.Today.Year, _gracePeriodMonth);
        if (_gracePeriodDay > daysInMonth)
        {
            _gracePeriodError = $"Invalid date. {System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(_gracePeriodMonth)} only has {daysInMonth} days.";
            return;
        }

        _gracePeriodError = string.Empty;
        
        // 2. Show Confirmation
        var monthName = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(_gracePeriodMonth);
        _confirmTitle = "Change Grace Period Date";
        _confirmMessage = $"Are you sure you want to change the annual grace period deadline to: {monthName} {_gracePeriodDay}?";
        _confirmSubMessage = "This date will recur annually. Key cards for members who haven't paid by this date will be automatically deactivated.";
        _confirmActionText = "Yes, Change Date";
        _confirmIcon = "bi-calendar-check";
        _confirmType = ConfirmActionModal.ConfirmType.Warning;
        _confirmAction = ExecuteSaveGracePeriod;
        _showGracePeriodModal = false; // Hide edit modal
        _showConfirmModal = true;      // Show confirm modal
    }
    
    private async Task ExecuteSaveGracePeriod()
    {
        _savingGracePeriod = true;
        
        try
        {
            var currentYear = DateTime.Today.Year;
            
            // Construct the proper date for the current year
            var newDate = new DateTime(currentYear, _gracePeriodMonth, _gracePeriodDay);
            
            var settings = await Task.Run(() => DuesYearSettingsRepository.GetSettingsForYear(currentYear));
            
            if (settings == null)
            {
                // Create new settings for this year
                settings = new DuesYearSettings
                {
                    Year = currentYear,
                    StandardDues = 250, // Default baseline dues
                    GraceEndApplied = true,
                    GraceEndDate = newDate
                };
                await DuesYearSettingsRepository.UpsertSettings(settings);
            }
            else
            {
                settings.GraceEndDate = newDate;
                settings.GraceEndApplied = true;
                await DuesYearSettingsRepository.UpsertSettings(settings);
            }
            
            // Also update next year just in case? Or keep it per year. 
            // Constraint says "remain the same month and day every year". 
            // Since DuesYearSettings is by year, we only affect the current year record here. 
            // In a real recurrence model, we would store "GraceMonth" and "GraceDay" in a global config.
            // But for now, updating the current year's deadline effectively sets the active rule.
            
            await LoadGracePeriodAndSyncStatusAsync();
            _gracePeriodError = string.Empty;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving grace period");
            _gracePeriodError = "Failed to save grace period settings.";
            // Re-show modal on error
            _showGracePeriodModal = true;
        }
        finally
        {
            _savingGracePeriod = false;
            StateHasChanged();
        }
    }

    
    private void ViewSyncQueue()
    {
        NavManager.NavigateTo("/keycards/sync-queue");
    }
    
    private async Task RetryAllSync()
    {
        try
        {
            await SyncQueueRepository.ResetPendingAsync();
            await LoadGracePeriodAndSyncStatusAsync();
            Logger.LogInformation("All pending syncs have been reset for retry");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error resetting sync queue");
        }
    }
    
    private async Task ForceFullSync()
    {
        if (!_controllerOnline)
        {
            Logger.LogWarning("Cannot perform full sync - controller is offline");
            await JSRuntime.InvokeVoidAsync("alert", "Cannot perform full sync - the controller is currently offline.");
            return;
        }
        
        try
        {
            _confirmTitle = "Full Controller Sync";
            _confirmMessage = "This will synchronize ALL active cards to the physical controller.";
            _confirmSubMessage = "This process ensures the controller matches the database exactly. It may take up to a minute depending on the number of cards.";
            _confirmActionText = "Start Full Sync";
            _confirmType = ConfirmActionModal.ConfirmType.Info;
            _confirmIcon = "bi-cpu-fill";
            _confirmAction = async () => 
            {
                Logger.LogInformation("Starting force full sync");
                var result = await ControllerFullSyncService.PerformFullSyncAsync();
                
                if (result.Success)
                {
                    Logger.LogInformation(
                        "Full sync completed successfully: {Success}/{Total} cards synced in {Duration}s",
                        result.SuccessCount, result.TotalCards, result.Duration.TotalSeconds);
                    
                    await LoadGracePeriodAndSyncStatusAsync();
                }
                else
                {
                    Logger.LogError(
                        "Full sync completed with errors: {Success}/{Total} cards synced, {Failed} failures",
                        result.SuccessCount, result.TotalCards, result.FailureCount);
                }
            };
            _showConfirmModal = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error performing full sync");
        }
    }
    
    private string GetStatusClass(string status)
    {
        if (string.IsNullOrWhiteSpace(status)) return "secondary";
        
        if (status.Equals("REGULAR", StringComparison.OrdinalIgnoreCase) || 
            status.Equals("REGULAR-NP", StringComparison.OrdinalIgnoreCase))
            return "success";
            
        if (status.Equals("LIFE", StringComparison.OrdinalIgnoreCase))
            return "primary";
            
        if (status.Equals("GUEST", StringComparison.OrdinalIgnoreCase))
            return "info";
            
        if (status.Equals("DIRECTOR", StringComparison.OrdinalIgnoreCase))
            return "danger";
            
        return "secondary";
    }

    // Identify Card Methods
    private async Task OpenIdentifyCardModal()
    {
        _showIdentifyModal = true;
        ResetIdentifyScan();
        
        // Wait for render
        await Task.Delay(150);
        try 
        {
            await _identifyInputRef.FocusAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning("Could not focus identify input: {Message}", ex.Message);
        }
    }

    private void CloseIdentifyModal()
    {
        _showIdentifyModal = false;
        ResetIdentifyScan();
    }

    private void ResetIdentifyScan()
    {
        _identifyInput = string.Empty;
        _identifyError = string.Empty;
        _identifiedCard = null;
        _identifiedMemberName = string.Empty;
        _identifiedMemberId = 0;
    }

    private async Task HandleScanAnother()
    {
        ResetIdentifyScan();
        await Task.Delay(50);
        try { await _identifyInputRef.FocusAsync(); } catch { }
    }

    private async Task HandleIdentifyKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            if (!string.IsNullOrWhiteSpace(_identifyInput))
            {
                await IdentifyCard(_identifyInput.Trim());
                _identifyInput = string.Empty;
            }
        }
        else if (e.Key == "Escape")
        {
            CloseIdentifyModal();
        }
    }

    private async Task KeepIdentifyFocus()
    {
        // Keep focus on the hidden input so we don't miss scans
        if (_showIdentifyModal && _identifiedCard == null)
        {
            try 
            {
                await _identifyInputRef.FocusAsync();
            }
            catch { /* Ignore focus errors on blur */ }
        }
    }

    private async Task IdentifyCard(string cardNumber)
    {
        try
        {
            // Clear previous identification first
            _identifyError = string.Empty;
            _identifiedCard = null;
            _identifiedMemberName = string.Empty;
            _identifiedMemberId = 0;
            
            // 1. Find card
            var card = await Task.Run(() => KeyCardRepository.GetByCardNumber(cardNumber));
            if (card == null)
            {
                _identifyError = "Card not found in system.";
                StateHasChanged();
                return;
            }

            // 2. Find member
            if (!_allMembers.Any()) await LoadMembersAsync();
            var member = _allMembers.FirstOrDefault(m => m.MemberID == card.MemberId);
            
            if (member == null)
            {
                _identifyError = $"Card #{cardNumber} is not assigned to any member.";
                StateHasChanged();
                return;
            }
            
            _identifiedCard = card;
            _identifiedMemberId = card.MemberId;
            _identifiedMemberName = $"{member.FirstName} {member.LastName}";

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error identifying card {CardNumber}", cardNumber);
            _identifyError = "Error identifying card. Please try again.";
            // Clear any partial data on error
            _identifiedCard = null;
            _identifiedMemberName = string.Empty;
            _identifiedMemberId = 0;
            StateHasChanged();
        }
    }

    private async Task ReactivateIdentifiedCard()
    {
        if (_identifiedCard == null) return;
        
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User.Identity?.Name ?? "Unknown";

        _confirmTitle = "Confirm Reactivation";
        _confirmMessage = $"Are you sure you want to REACTIVATE Card #{_identifiedCard.CardNumber}?";
        _confirmSubMessage = $"This will restore door access for {_identifiedMemberName} immediately.";
        _confirmActionText = "Confirm Reactivate";
        _confirmType = ConfirmActionModal.ConfirmType.Success;
        _confirmIcon = "bi-unlock-fill";
        _confirmAction = async () => 
        {
            await KeyCardLifecycleService.ReactivateCardAsync(_identifiedCard.KeyCardId, "Manual reactivation via scan identify", user);
            
            // Refresh the identified card state
            var refreshedCard = await Task.Run(() => KeyCardRepository.GetById(_identifiedCard.KeyCardId));
            if (refreshedCard != null) _identifiedCard = refreshedCard;
            
            await LoadGracePeriodAndSyncStatusAsync();
        };
        _showConfirmModal = true;
    }

    private async Task DeactivateIdentifiedCard()
    {
        if (_identifiedCard == null) return;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User.Identity?.Name ?? "Unknown";

        _confirmTitle = "Confirm Deactivation";
        _confirmMessage = $"Are you sure you want to DEACTIVATE Card #{_identifiedCard.CardNumber}?";
        _confirmSubMessage = $"This will REVOKE door access for {_identifiedMemberName} immediately.";
        _confirmActionText = "Confirm Deactivate";
        _confirmType = ConfirmActionModal.ConfirmType.Danger;
        _confirmIcon = "bi-lock-fill";
        _confirmAction = async () => 
        {
            await KeyCardLifecycleService.DeactivateCardAsync(_identifiedCard.KeyCardId, "Manual", "Deactivated via scan identify", user);
            
            // Refresh the identified card state
            var refreshedCard = await Task.Run(() => KeyCardRepository.GetById(_identifiedCard.KeyCardId));
            if (refreshedCard != null) _identifiedCard = refreshedCard;
            
            await LoadGracePeriodAndSyncStatusAsync();
        };
        _showConfirmModal = true;
    }
    
    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "??";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0) return "??";
        if (parts.Length == 1) return parts[0][0].ToString().ToUpper();
        return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
    }

    private async Task<string> GetMemberNameAsync(int memberId)
    {
        if (!_allMembers.Any()) await LoadMembersAsync();
        var member = _allMembers.FirstOrDefault(m => m.MemberID == memberId);
        return member != null ? $"{member.FirstName} {member.LastName}" : $"Member #{memberId}";
    }

    // Auto-refresh logic
    private CancellationTokenSource? _refreshCts;

    private async Task StartStatusRefresh()
    {
        _refreshCts?.Cancel();
        _refreshCts = new CancellationTokenSource();
        var token = _refreshCts.Token;

        try
        {
            while (!token.IsCancellationRequested)
            {
                await Task.Delay(5000, token); // Refresh every 5s
                
                var oldOnline = _controllerOnline;
                var oldPending = _pendingSyncCount;
                
                await LoadGracePeriodAndSyncStatusAsync();
                
                // Only trigger UI update if status actually changed to reduce flicker
                if (oldOnline != _controllerOnline || oldPending != _pendingSyncCount)
                {
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (TaskCanceledException) { }
    }
    
    private string GetLastCommand()
    {
        try
        {
            var lastLog = LogService.GetRecentLogs(1).FirstOrDefault();
            if (lastLog != null)
            {
                return $"{lastLog.Operation} [0x{(lastLog.RequestPacket?[1] ?? 0):X2}]";
            }
        }
        catch { }
        return "None";
    }

    public void Dispose()

    {
        _refreshCts?.Cancel();
        _refreshCts?.Dispose();
        _scanCts?.Cancel();
    }
}

@* Custom Confirmation Modal *@
@if (_showConfirmModal)
{
    <ConfirmActionModal 
        Title="@_confirmTitle"
        Message="@_confirmMessage"
        SubMessage="@_confirmSubMessage"
        ConfirmText="@_confirmActionText"
        Type="@_confirmType"
        Icon="@_confirmIcon"
        OnConfirm="HandleConfirmedAction"
        OnCancel="() => _showConfirmModal = false" />
}
