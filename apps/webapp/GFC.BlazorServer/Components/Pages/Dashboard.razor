@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using System.Linq
@using GFC.BlazorServer.Components.Common
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Models.Dashboard
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using GFC.BlazorServer.Services.Dashboard
@attribute [Authorize]
@inject IDashboardService DashboardService
@inject IDashboardMetricsService DashboardMetricsService
@inject ControllerRegistryService ControllerRegistryService
@inject ControllerEventService ControllerEventService
@inject ISystemSettingsService SystemSettingsService
@inject NavigationManager NavMgr
@inject IControllerClient ControllerClient

@if (_showSplash)
{
    <GfcDashboardSplash IsFadingOut="_isSplashFadingOut" />
}

<div class="dash-page @(_showSplash && !_isSplashFadingOut ? "dash-hidden" : "dash-visible")">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0">Dashboard</h1>
            <div class="d-flex align-items-center gap-2">
                <span class="small text-muted">Auto-refresh</span>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input"
                           type="checkbox"
                           id="dashAutoRefreshToggle"
                           @bind="IsAutoRefreshEnabled">
                    <label class="form-check-label small text-muted" for="dashAutoRefreshToggle">
                        @(IsAutoRefreshEnabled ? "On" : "Off")
                    </label>
                </div>
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        data-bs-toggle="collapse"
                        data-bs-target="#dash-settings-panel"
                        aria-expanded="false"
                        aria-controls="dash-settings-panel">
                    Settings
                </button>
                <button type="button"
                        class="btn btn-sm btn-outline-primary d-flex align-items-center"
                        @onclick="RefreshAsync"
                        disabled="@(_isLoading || IsRefreshing)"
                        aria-busy="@IsRefreshing">
                    @if (IsRefreshing)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    @if (IsRefreshing)
                    {
                        <span>Refreshing</span>
                    }
                    @if (!IsRefreshing)
                    {
                        <i class="bi bi-arrow-repeat me-2"></i>
                    }
                    @if (!IsRefreshing)
                    {
                        <span>Refresh</span>
                    }
                </button>
            </div>
        </div>

        @if (IsAutoRefreshEnabled)
        {
            <div class="alert alert-info py-1 px-2 small mb-2">
                Live refresh is enabled (visual only - data refresh will be wired in a later phase).
            </div>
        }

        <div class="collapse mb-3" id="dash-settings-panel">
            <div class="card shadow-sm rounded">
                <div class="card-header">
                    <h5 class="mb-0">Dashboard Settings</h5>
                </div>
                <div class="card-body small">
                    <p class="text-muted mb-2">
                        These settings control what you see on the dashboard. They are UI-only for now; behavior will be wired in a future phase.
                    </p>

                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowMembershipCard"
                                       @bind="ShowMembershipCard">
                                <label class="form-check-label" for="settingShowMembershipCard">
                                    Show Membership &amp; Dues card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowAccessCard"
                                       @bind="ShowAccessControlCard">
                                <label class="form-check-label" for="settingShowAccessCard">
                                    Show Access Control &amp; Doors card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowEventsCard"
                                       @bind="ShowEventsCard">
                                <label class="form-check-label" for="settingShowEventsCard">
                                    Show Events &amp; Hall Rentals card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowAlertsCard"
                                       @bind="ShowAlertsCard">
                                <label class="form-check-label" for="settingShowAlertsCard">
                                    Show Alerts &amp; Warnings card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowQuickActionsCard"
                                       @bind="ShowQuickActionsCard">
                                <label class="form-check-label" for="settingShowQuickActionsCard">
                                    Show Quick Actions card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowSystemStatusCard"
                                       @bind="ShowSystemStatusCard">
                                <label class="form-check-label" for="settingShowSystemStatusCard">
                                    Show System Status card
                                </label>
                            </div>
                        </div>
                    </div>

                    <p class="text-muted mt-3 mb-0">
                        @* TODO: Persist these settings per user/role in a future phase. Currently, they are session-only UI toggles. *@
                    </p>
                </div>
            </div>
        </div>

        @if (_isLoading)
        {
            <div class="loading-state">
                <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                Loading dashboard...
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <div class="alert alert-danger">@_errorMessage</div>
        }
        else if (_memberSummary is not null && _duesSummary is not null && _alerts is not null && _backupStatus is not null)
        {
            var totalMembers = _metrics?.TotalMembers ?? _memberSummary.TotalMembers;
            var activeMembers = _metrics?.ActiveMembers ?? _memberSummary.RegularMembers + _memberSummary.LifeMembers;
            var overdueCount = _metrics?.PastDueMembers ?? _duesSummary.UnpaidCount;

            <div class="container-fluid">
                <div class="row g-3">
                    <div class="col-12 col-lg-8">
                        <div class="dash-fade-in">
                            @if (ShowMembershipCard)
                            {
                                <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action {GetMembershipCardStateClass()}")" role="button" tabindex="0" aria-label="Open member list" @onclick="NavigateToSearchMember" @onkeydown="(e => HandleCardKeyDown(e, NavigateToSearchMember))">
                                    <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                        <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-membership-card" aria-expanded="true" aria-controls="dash-membership-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                            <h5 class="mb-0">
                                                <i class="bi bi-people me-2"></i>Membership &amp; Dues Overview
                                            </h5>
                                        </button>
                                        <NavLink href="/members" class="small text-decoration-none" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                            View members
                                        </NavLink>
                                    </div>
                                    <div class="collapse show" id="dash-membership-card">
                                        <div class="card-body">
                                            <p class="text-muted mb-2">
                                                High-level view of member counts and dues status will appear here.
                                            </p>
                                            <ul class="mb-0 small">
                                                <li>Total Members: <span class="fw-semibold">@totalMembers</span></li>
                                                <li>Members In Good Standing: <span class="fw-semibold">@activeMembers</span></li>
                                                <li>
                                                    Dues Overdue:
                                                    <span class="badge bg-warning text-dark ms-2 dash-pill-hover">@overdueCount</span>
                                                </li>
                                            </ul>
                                            @* TODO: Bind to real membership and dues metrics *@
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (ShowAccessControlCard)
                            {
                                <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action {GetControllersCardStateClass()}")" role="button" tabindex="0" aria-label="Open controller overview" @onclick="NavigateToControllerDiagnostics" @onkeydown="(e => HandleCardKeyDown(e, NavigateToControllerDiagnostics))">
                                    <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                        <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-access-card" aria-expanded="true" aria-controls="dash-access-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                            <div class="d-flex align-items-center gap-2">
                                                <h5 class="mb-0">
                                                    <i class="bi bi-door-open me-2"></i>Access Control &amp; Doors
                                                </h5>
                                                <span class="badge bg-primary dash-pill-hover">@_controllerSnapshots.Count</span>
                                            </div>
                                        </button>
                                        <NavLink href="/controllers" class="small text-decoration-none" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                            View controllers
                                        </NavLink>
                                    </div>
                                    <div class="collapse show" id="dash-access-card">
                                        <div class="card-body">
                                            <div class="small text-primary fw-semibold mb-2">
                                                Access System Overview
                                            </div>
                                            <p class="text-muted mb-2">
                                                Door status and access control activity will be summarized here.
                                            </p>
                                            @if (!string.IsNullOrWhiteSpace(_controllerConnectivityNote))
                                            {
                                                <div class="text-muted small mb-2">
                                                    Controller connectivity: @_controllerConnectivityNote
                                                </div>
                                            }
                                            <ul class="mb-0 small">
                                                <li>
                                                    Online Controllers:
                                                    <span class="badge bg-primary-subtle text-primary dash-pill-hover">@_controllerSnapshots.Count</span>
                                                </li>
                                                <li>Recent Door Events: <span class="fw-semibold">[placeholder]</span></li>
                                            </ul>
                                            @* TODO: Connect to controller status and event summaries *@
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (ShowEventsCard)
                            {
                                <div class="card mb-3 shadow-sm rounded dash-hover-card">
                                    <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                        <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-events-card" aria-expanded="true" aria-controls="dash-events-card">
                                            <h5 class="mb-0">
                                                <i class="bi bi-calendar-event me-2"></i>Events &amp; Hall Rentals
                                            </h5>
                                        </button>
                                    </div>
                                    <div class="collapse show" id="dash-events-card">
                                        <div class="card-body">
                                            <div class="small text-info fw-semibold mb-2">
                                                Current Activity
                                            </div>
                                            <p class="text-muted mb-2">
                                                Upcoming events and rental activity will be shown here.
                                            </p>
                                            <ul class="mb-0 small">
                                                <li>Upcoming Events: <span class="fw-semibold">[placeholder]</span></li>
                                                <li>Hall Rentals This Month: <span class="fw-semibold">[placeholder]</span></li>
                                            </ul>
                                            @* TODO: Hook into events and hall rental data when available *@
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="col-12 col-lg-4">
                        @if (ShowAlertsCard)
                        {
                            <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action {GetAlertsCardStateClass()}")" role="button" tabindex="0" aria-label="Open alerts center" @onclick="NavigateToAlerts" @onkeydown="(e => HandleCardKeyDown(e, NavigateToAlerts))">
                                <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                    <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-alerts-card" aria-expanded="true" aria-controls="dash-alerts-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                        <h5 class="mb-0">
                                            <i class="bi bi-exclamation-triangle me-2"></i>Alerts &amp; Warnings
                                        </h5>
                                    </button>
                                </div>
                                <div class="collapse show" id="dash-alerts-card">
                                    <div class="card-body">
                                        <div class="small text-warning fw-semibold mb-2">
                                            System Alerts
                                        </div>
                                        <p class="text-muted small mb-2">
                                            Important alerts will appear here when attention is required.
                                        </p>
                                        @if (Alerts != null && Alerts.Count > 0)
                                        {
                                            <ul class="mb-0 small">
                                                @foreach (var alert in Alerts)
                                                {
                                                    var alertClass = alert.Severity switch
                                                    {
                                                        "Danger" => "text-danger",
                                                        "Warning" => "text-warning",
                                                        "Info" or _ => "text-info"
                                                    };

                                                    <li class="@alertClass">
                                                        <strong>@alert.Source:</strong> @alert.Message
                                                    </li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <ul class="mb-0 small">
                                                <li class="text-muted">No critical alerts detected.</li>
                                            </ul>
                                        }
                                        @* TODO: Populate Alerts from dues, waiver, controller, and membership logic in a future phase *@
                                    </div>
                                </div>
                            </div>
                        }

                        @if (ShowQuickActionsCard)
                        {
                            <div class="card mb-3 shadow-sm rounded dash-card-action" role="button" tabindex="0" aria-label="Open quick actions panel" @onclick="NavigateToRecordDues" @onkeydown="(e => HandleCardKeyDown(e, NavigateToRecordDues))">
                                <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                    <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-quick-card" aria-expanded="true" aria-controls="dash-quick-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                        <h5 class="mb-0">
                                            <i class="bi bi-lightning-charge me-2"></i>Quick Actions
                                        </h5>
                                    </button>
                                </div>
                                <div class="collapse show" id="dash-quick-card">
                                    <div class="card-body">
                                        <p class="text-muted small mb-2">
                                            Frequently used actions for board and office staff.
                                        </p>
                                        <div class="p-2 bg-light rounded d-flex flex-wrap gap-2">
                                            <a href="/members/new" class="btn btn-sm btn-primary dash-quick-action" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">Add Member</a>
                                            <a href="/dues" class="btn btn-sm btn-outline-primary dash-quick-action" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">Record Payment</a>
                                            <button type="button" class="btn btn-sm btn-outline-secondary dash-quick-action" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">Open Door (Test)</button>
                                        </div>
                                        @* TODO: Wire buttons to real navigation/commands *@
                                    </div>
                                </div>
                            </div>
                        }

                        @if (ShowSystemStatusCard)
                        {
                            <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action {GetSystemStatusCardStateClass()}")" role="button" tabindex="0" aria-label="Open system status details" @onclick="NavigateToReplaceCard" @onkeydown="(e => HandleCardKeyDown(e, NavigateToReplaceCard))">
                                <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                    <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-status-card" aria-expanded="true" aria-controls="dash-status-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                        <h5 class="mb-0">
                                            <i class="bi bi-activity me-2"></i>System Status
                                        </h5>
                                    </button>
                                </div>
                                <div class="collapse show" id="dash-status-card">
                                    <div class="card-body">
                                        <div class="small text-secondary fw-semibold mb-2">
                                            Current System Health
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(_controllerConnectivityNote))
                                        {
                                            <div class="text-muted small mb-2">
                                                Controller connectivity: @_controllerConnectivityNote
                                            </div>
                                        }
                                        <ul class="mb-0 small">
                                            <li>
                                                Controllers:
                                                <span class="badge bg-secondary-subtle text-dark dash-pill-hover">@_controllerSnapshots.Count</span>
                                            </li>
                                            <li>Database: <span class="fw-semibold">[placeholder]</span></li>
                                            <li>
                                                Backups:
                                                <span class="badge bg-secondary-subtle text-dark dash-pill-hover">@FormatDate(_backupStatus.LastBackupUtc)</span>
                                            </li>
                                        </ul>
                                        @* TODO: Connect to maintenance/health metrics *@
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    .dash-page {
        transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    .dash-hidden {
        opacity: 0;
        transform: scale(0.98) translateY(10px);
        pointer-events: none;
        height: 0;
        overflow: hidden;
    }
    
    .dash-visible {
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: auto;
    }

    .dash-fade-in {
        opacity: 0;
        animation: dash-fade-in .25s ease forwards;
    }

    @@keyframes dash-fade-in {
        to {
            opacity: 1;
        }
    }

    .dash-card-action {
        cursor: pointer;
        transition: transform .15s ease, box-shadow .15s ease;
    }

    .dash-card-action:hover,
    .dash-card-action:focus-visible {
        transform: translateY(-3px);
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.12);
    }

    .dash-card-action:focus-visible {
        outline: 2px solid var(--bs-primary);
        outline-offset: 2px;
    }

    .dash-hover-card {
        transition: transform .15s ease, box-shadow .15s ease;
    }

    .dash-hover-card:hover,
    .dash-hover-card:focus-within {
        transform: translateY(-3px);
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.12);
    }

    .dash-card-header {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: border-color .2s ease;
    }

    .dash-card-action:hover .dash-card-header,
    .dash-card-action:focus-visible .dash-card-header,
    .dash-hover-card:hover .dash-card-header,
    .dash-hover-card:focus-within .dash-card-header {
        border-color: rgba(0, 0, 0, 0.15);
    }

    .dash-pill-hover {
        transition: background-color .2s ease, transform .15s ease;
    }

    .dash-pill-hover:hover,
    .dash-pill-hover:focus-visible {
        transform: scale(1.06);
        outline: 2px solid transparent;
        outline-offset: 2px;
    }

    .dash-quick-action {
        transition: transform .12s ease, box-shadow .12s ease;
    }

    .dash-quick-action:hover,
    .dash-quick-action:focus-visible {
        transform: scale(1.04);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }
</style>

@code {
    private bool _isLoading = true;
    private bool _metricsLoading;
    private bool _alertsLoading;
    private bool _showSplash = true;
    private bool _isSplashFadingOut = false;
    private MemberSummaryDto? _memberSummary;
    private DuesSummaryDto? _duesSummary;
    private AlertSummaryDto? _alerts;
    private BackupStatusDto? _backupStatus;
    private string? _errorMessage;
    private string? _metricsError;
    private string? _alertsError;
    private DashboardMetricsDto? _metrics;
    private bool _sidebarOpen = true;
    private DashboardSidebarTab _activeSidebarTab = DashboardSidebarTab.Alerts;
    private bool _alertsExpanded = true;
    private readonly List<AlertPreviewItem> _importantAlerts = new();
    private readonly List<AlertPreviewItem> _alertPreview = new();
    private readonly List<ControllerSnapshot> _controllerSnapshots = new();
    private string? _controllerConnectivityNote;
    private bool _useRealControllers;
    private bool _isSimulationMode;
    private bool IsRefreshing;
    private bool IsAutoRefreshEnabled { get; set; } = false;
    private bool ShowMembershipCard { get; set; } = true;
    private bool ShowAccessControlCard { get; set; } = true;
    private bool ShowEventsCard { get; set; } = true;
    private bool ShowAlertsCard { get; set; } = true;
    private bool ShowQuickActionsCard { get; set; } = true;
    private bool ShowSystemStatusCard { get; set; } = true;
    private string? _defaultControllerSerial;
    private int? _defaultDoorIndex;
    private sealed class DashboardAlert
    {
        public string Severity { get; set; } = "Info";   // e.g., Info, Warning, Danger
        public string Message { get; set; } = string.Empty;
        public string Source { get; set; } = string.Empty; // e.g., "Dues", "Access", "System"
    }

    private List<DashboardAlert> Alerts { get; set; } = new();
    private enum MetricState
    {
        Normal,
        Warning,
        Critical
    }

    private static class DashboardThresholds
    {
        public const int AlertsWarning = 1;
        public const int AlertsCritical = 5;
        public const int OverdueWarning = 1;
        public const int OverdueCritical = 5;
        public const int ControllersOfflineWarning = 1;
        public const int ControllersOfflineCritical = 2;
        public const int BackupStaleDaysWarning = 7;
        public const int BackupStaleDaysCritical = 30;
    }

    protected override async Task OnInitializedAsync() => await LoadDashboardAsync(includeSplash: true);

    private async Task LoadDashboardAsync(bool includeSplash)
    {
        _showSplash = includeSplash;
        _isSplashFadingOut = false;
        _isLoading = true;
        _metricsLoading = true;
        _alertsLoading = true;
        _errorMessage = null;
        _metricsError = null;
        _alertsError = null;
        
        // 1. Kick off all data fetching tasks IMMEDIATELY
        var metricsTask = DashboardMetricsService.GetMetricsAsync();
        var controllerModeTask = LoadControllerModeAsync();
        var memberTask = DashboardService.GetMemberSummaryAsync();
        var duesTask = DashboardService.GetCurrentYearDuesSummaryAsync();
        var alertsTask = DashboardService.GetAlertSummaryAsync();
        var backupTask = DashboardService.GetBackupStatusAsync();

        // 2. Define minimum splash duration (Ensure it stays for at least 1.2 seconds per user request)
        var minSplashDelay = includeSplash ? Task.Delay(1200) : Task.CompletedTask;

        try
        {
            // 3. Wait for critical data and internal delays in parallel
            await Task.WhenAll(memberTask, duesTask, alertsTask, backupTask, minSplashDelay);

            _memberSummary = memberTask.Result;
            _duesSummary = duesTask.Result;
            _alerts = alertsTask.Result;
            _backupStatus = backupTask.Result;

            _importantAlerts.Clear();
            _alertPreview.Clear();
            var important = BuildAlertPreview(_alerts);
            _alertPreview.AddRange(important);
            _importantAlerts.AddRange(important);
            
            _isLoading = false; // Data is ready
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard] {ex}");
            _errorMessage = "We couldn't load the dashboard metrics right now. Please try again shortly.";
            _isLoading = false;
        }

        // 4. Handle the smooth transition out
        if (includeSplash)
        {
            _isSplashFadingOut = true;
            StateHasChanged();
            await Task.Delay(600); // Wait for fade-out to complete (synced with CSS 0.6s)
            _showSplash = false;
        }
        
        // 5. Cleanup metrics and controllers (secondary)
        try { _metrics = await metricsTask; } catch { /* log handled elsewhere */ }
        await controllerModeTask;
        _isSimulationMode = !_useRealControllers;
        await LoadControllerStatusSafeAsync();
        
        Alerts ??= new List<DashboardAlert>();
        StateHasChanged();
    }

    private async Task RefreshAsync()
    {
        if (IsRefreshing || _isLoading)
        {
            return;
        }

        IsRefreshing = true;
        StateHasChanged();

        try
        {
            await LoadDashboardAsync(includeSplash: false);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:refresh] {ex}");
            _errorMessage = "Dashboard refresh failed. Please try again.";
        }
        finally
        {
            IsRefreshing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string FormatDate(DateTime? value)
    {
        if (value == null)
        {
            return "Not available";
        }

        return value.Value.ToLocalTime().ToString("MMM d, yyyy h:mm tt");
    }

    private static string FormatShort(DateTime? value)
    {
        if (value == null)
        {
            return "Never";
        }

        return value.Value.ToLocalTime().ToString("MMM d, h:mm tt");
    }

    private void ToggleSidebar() => _sidebarOpen = !_sidebarOpen;

    private void ToggleAlertsSection() => _alertsExpanded = !_alertsExpanded;

    private void SetTab(DashboardSidebarTab tab) => _activeSidebarTab = tab;

    private int GetOpenAlertsCount()
    {
        if (_metrics?.OpenAlerts is { } open)
        {
            return open;
        }

        return _alerts is null ? 0 : CalculateOpenAlerts(_alerts);
    }

    private IEnumerable<AlertPreviewItem> BuildAlertPreview(AlertSummaryDto summary)
    {
        var now = DateTime.UtcNow;
        var items = new List<AlertPreviewItem>();

        if (summary.LifeEligibleCount > 0)
        {
            items.Add(new AlertPreviewItem(
                "Life eligible",
                "Members meet Life criteria but are still Regular.",
                summary.LifeEligibleCount,
                now,
                "dash-alert-pill-warn"));
        }

        if (summary.NpQueueCount > 0)
        {
            items.Add(new AlertPreviewItem(
                "NP queue",
                "Guests are waiting for promotion to Regular.",
                summary.NpQueueCount,
                now,
                "dash-alert-pill-info"));
        }

        if (summary.OverdueMembers15Months > 0)
        {
            items.Add(new AlertPreviewItem(
                "Overdue 15+ months",
                "Members overdue on dues beyond 15 months.",
                summary.OverdueMembers15Months,
                now,
                "dash-alert-pill-danger"));
        }

        if (summary.PhysicalKeysToReturn > 0)
        {
            items.Add(new AlertPreviewItem(
                "Physical keys to return",
                "Non-board members hold active physical keys.",
                summary.PhysicalKeysToReturn,
                now,
                "dash-alert-pill-warn"));
        }

        if (summary.BoardAlertYear > 0 && (!summary.BoardConfirmed || summary.BoardPositionsUnfilled.Count > 0))
        {
            items.Add(new AlertPreviewItem(
                "Board roles open",
                $"Board {summary.BoardAlertYear} needs: {string.Join(", ", summary.BoardPositionsUnfilled)}",
                Math.Max(1, summary.BoardPositionsUnfilled.Count),
                now,
                "dash-alert-pill-danger"));
        }

        return items;
    }

    private async Task LoadControllerSnapshotAsync()
    {
        try
        {
            _controllerConnectivityNote = null;
            _controllerSnapshots.Clear();

            if (_isSimulationMode)
            {
                await ApplySimulationControllerStateAsync();
                return;
            }

            await ControllerClient.PingAsync(CancellationToken.None);

            var controllers = await ControllerRegistryService.GetControllersAsync(cancellationToken: CancellationToken.None);
            var firstControllerWithDoor = controllers.FirstOrDefault(c => c.Doors.Any());
            if (firstControllerWithDoor is not null)
            {
                _defaultControllerSerial ??= firstControllerWithDoor.SerialNumberDisplay;
                _defaultDoorIndex ??= firstControllerWithDoor.Doors.OrderBy(d => d.DoorIndex).First().DoorIndex;
            }
            var controllerIds = controllers.Select(c => c.Id).ToList();
            var latestEvents = controllerIds.Count > 0
                ? await ControllerEventService.GetLatestEventsByControllerAsync(controllerIds)
                : new Dictionary<int, ControllerEvent>();

            foreach (var controller in controllers)
            {
                latestEvents.TryGetValue(controller.Id, out var evt);
                _controllerSnapshots.Add(new ControllerSnapshot(
                    controller.Id,
                    controller.Name,
                    GetControllerStatusText(evt),
                    GetControllerStatusClass(evt),
                    controller.IsEnabled,
                    evt?.TimestampUtc));
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:controllers] {ex}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadControllerStatusSafeAsync()
    {
        await LoadControllerSnapshotAsync();
    }
    private async Task ApplySimulationControllerStateAsync()
    {
        _controllerConnectivityNote = "Simulation Mode";
        _controllerSnapshots.Clear();

        var controllers = await ControllerRegistryService.GetControllersAsync(cancellationToken: CancellationToken.None);
        var firstControllerWithDoor = controllers.FirstOrDefault(c => c.Doors.Any());
        if (firstControllerWithDoor is not null)
        {
            _defaultControllerSerial ??= firstControllerWithDoor.SerialNumberDisplay;
            _defaultDoorIndex ??= firstControllerWithDoor.Doors.OrderBy(d => d.DoorIndex).First().DoorIndex;
        }

        foreach (var controller in controllers)
        {
            _controllerSnapshots.Add(new ControllerSnapshot(
                controller.Id,
                controller.Name,
                "Simulation Mode",
                "bg-secondary",
                controller.IsEnabled,
                null));
        }
    }

    private async Task LoadControllerModeAsync()
    {
        try
        {
            var settings = await SystemSettingsService.GetAsync();
            _useRealControllers = true; // Simulation mode removed
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:controllerMode] {ex}");
            _useRealControllers = false;
        }
    }

    private static string GetControllerStatusText(ControllerEvent? lastEvent)
    {
        if (lastEvent == null)
        {
            return "Never";
        }

        var age = DateTime.UtcNow - lastEvent.TimestampUtc;
        if (age.TotalHours < 1)
        {
            return "Online";
        }
        if (age.TotalHours < 24)
        {
            return "Stale";
        }

        return "Offline";
    }

    private static string GetControllerStatusClass(ControllerEvent? lastEvent)
    {
        if (lastEvent == null)
        {
            return "bg-secondary";
        }

        var age = DateTime.UtcNow - lastEvent.TimestampUtc;
        if (age.TotalHours < 1)
        {
            return "bg-success";
        }
        if (age.TotalHours < 24)
        {
            return "bg-warning text-dark";
        }

        return "bg-danger";
    }

    private static string GetStatusDotClass(string statusClass)
    {
        if (statusClass.Contains("success", StringComparison.OrdinalIgnoreCase))
        {
            return "text-success";
        }

        if (statusClass.Contains("warning", StringComparison.OrdinalIgnoreCase))
        {
            return "text-warning";
        }

        if (statusClass.Contains("danger", StringComparison.OrdinalIgnoreCase))
        {
            return "text-danger";
        }

        return "text-secondary";
    }

    private string GetControllerDetailText(ControllerSnapshot snapshot)
    {
        if (snapshot.LastEventUtc == null)
        {
            return "Last event: never";
        }

        return $"Last event: {FormatShort(snapshot.LastEventUtc)}";
    }

    private static void HandleCardKeyDown(KeyboardEventArgs e, Action navigateAction)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            navigateAction();
        }
    }

    private void NavigateToAlerts() => NavMgr.NavigateTo("/alerts");

    private void NavigateToControllerDiagnostics() => NavMgr.NavigateTo("/controllers");

    private void NavigateToNewMember() => NavMgr.NavigateTo("/members");

    private void NavigateToRecordDues() => NavMgr.NavigateTo("/dues");

    private void NavigateToReplaceCard() => NavMgr.NavigateTo("/keycards");

    private void NavigateToSearchMember() => NavMgr.NavigateTo("/members");

    private async Task TestSimulatedDoorOpen()
    {
        if (!_isSimulationMode || string.IsNullOrWhiteSpace(_defaultControllerSerial) || !_defaultDoorIndex.HasValue)
        {
            return;
        }

        try
        {
            await ControllerClient.OpenDoorAsync(_defaultControllerSerial, _defaultDoorIndex.Value);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:simOpenDoor] {ex}");
        }
    }

    private static int CalculateOpenAlerts(AlertSummaryDto alert)
    {
        var boardPositions = alert.BoardPositionsUnfilled?.Count ?? 0;
        var boardOpen = alert.BoardAlertYear > 0 && (!alert.BoardConfirmed || boardPositions > 0)
            ? Math.Max(1, boardPositions)
            : 0;

        return Math.Max(0, alert.PhysicalKeysToReturn)
             + Math.Max(0, alert.NpQueueCount)
             + Math.Max(0, alert.OverdueMembers15Months)
             + Math.Max(0, alert.LifeEligibleCount)
             + boardOpen;
    }

    private static string GetSeverityLabel(AlertPreviewItem alert) => alert.SeverityClass switch
    {
        "dash-alert-pill-danger" => "Critical",
        "dash-alert-pill-warn" => "Warning",
        "dash-alert-pill-info" => "Info",
        _ => "Info"
    };

    private static string GetSeverityClass(AlertPreviewItem alert) => alert.SeverityClass switch
    {
        "dash-alert-pill-danger" => "alert-severity alert-severity-critical",
        "dash-alert-pill-warn" => "alert-severity alert-severity-warning",
        "dash-alert-pill-info" => "alert-severity alert-severity-info",
        _ => "alert-severity alert-severity-info"
    };

    private string GetTabClass(DashboardSidebarTab tab)
        => _activeSidebarTab == tab ? "is-active" : string.Empty;

    private enum DashboardSidebarTab
    {
        Alerts,
        Controllers,
        QuickActions
    }

    private sealed record AlertPreviewItem(string Title, string Message, int Count, DateTime Timestamp, string SeverityClass);

    private sealed record ControllerSnapshot(int Id, string Name, string StatusText, string StatusClass, bool IsEnabled, DateTime? LastEventUtc);

    private string GetAlertsCardStateClass() => GetCardClass(GetAlertsState());

    private string GetMembershipCardStateClass() => GetCardClass(GetOverdueState());

    private string GetControllersCardStateClass() => GetCardClass(GetControllersState());

    private string GetSystemStatusCardStateClass() => GetCardClass(MergeStates(GetControllersState(), GetBackupState()));

    private static string GetCardClass(MetricState state) => state switch
    {
        MetricState.Critical => "metric-card--critical",
        MetricState.Warning => "metric-card--warning",
        _ => "metric-card--normal"
    };

    private MetricState GetAlertsState()
    {
        var count = Alerts?.Count ?? 0;
        if (count >= DashboardThresholds.AlertsCritical)
        {
            return MetricState.Critical;
        }

        if (count >= DashboardThresholds.AlertsWarning)
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }

    private MetricState GetOverdueState()
    {
        var overdue = _metrics?.PastDueMembers ?? _duesSummary?.UnpaidCount ?? 0;
        if (overdue >= DashboardThresholds.OverdueCritical)
        {
            return MetricState.Critical;
        }

        if (overdue >= DashboardThresholds.OverdueWarning)
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }

    private MetricState GetControllersState()
    {
        if (_isSimulationMode || _controllerSnapshots.Count == 0)
        {
            return MetricState.Normal;
        }

        var offline = _controllerSnapshots.Count(c => c.StatusText.Equals("Offline", StringComparison.OrdinalIgnoreCase));
        var stale = _controllerSnapshots.Count(c => c.StatusText.Equals("Stale", StringComparison.OrdinalIgnoreCase));

        if (offline >= DashboardThresholds.ControllersOfflineCritical)
        {
            return MetricState.Critical;
        }

        if (offline >= DashboardThresholds.ControllersOfflineWarning || stale > 0)
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }

    private MetricState GetBackupState()
    {
        var lastBackup = _backupStatus?.LastBackupUtc;
        if (lastBackup == null)
        {
            return MetricState.Warning;
        }

        var ageDays = (DateTime.UtcNow - lastBackup.Value).TotalDays;
        if (ageDays >= DashboardThresholds.BackupStaleDaysCritical)
        {
            return MetricState.Critical;
        }

        if (ageDays >= DashboardThresholds.BackupStaleDaysWarning)
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }

    private static MetricState MergeStates(params MetricState[] states)
    {
        if (states.Any(s => s == MetricState.Critical))
        {
            return MetricState.Critical;
        }

        if (states.Any(s => s == MetricState.Warning))
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }
}

