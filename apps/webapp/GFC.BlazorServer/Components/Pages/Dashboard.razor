@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using System.Linq
@using GFC.BlazorServer.Components.Common
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Models.Dashboard
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using GFC.BlazorServer.Services.Dashboard
@attribute [Authorize]
@inject IDashboardService DashboardService
@inject IDashboardMetricsService DashboardMetricsService
@inject ControllerRegistryService ControllerRegistryService
@inject ControllerEventService ControllerEventService
@inject ISystemSettingsService SystemSettingsService
@inject NavigationManager NavMgr
@inject IControllerClient ControllerClient
@inject DashboardSessionState SessionState
@using GFC.BlazorServer.Components.Shared
@using GFC.Core.Models
@inject IRentalService RentalService
@inject IJSRuntime JS
@inject IDuesYearSettingsRepository DuesYearSettingsRepository
@inject IControllerSyncQueueRepository SyncQueueRepository
@inject ControllerHealthService ControllerHealthService
@inject KeyCardLifecycleService KeyCardLifecycleService

@if (_showSplash)
{
    <GfcDashboardSplash IsFadingOut="_isSplashFadingOut" />
}

<div class="dash-page @(_showSplash && !_isSplashFadingOut ? "dash-hidden" : "dash-visible")">
    <VpnSetupNotificationBanner />
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0">Dashboard</h1>
            <div class="d-flex align-items-center gap-2">
                <span class="small text-muted">Auto-refresh</span>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input"
                           type="checkbox"
                           id="dashAutoRefreshToggle"
                           @bind="IsAutoRefreshEnabled">
                    <label class="form-check-label small text-muted" for="dashAutoRefreshToggle">
                        @(IsAutoRefreshEnabled ? "On" : "Off")
                    </label>
                </div>
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        @onclick="ToggleSettingsPanel">
                    Settings
                </button>
                <button type="button"
                        class="btn btn-sm btn-outline-primary d-flex align-items-center"
                        @onclick="RefreshAsync"
                        disabled="@(_isLoading || IsRefreshing)"
                        aria-busy="@IsRefreshing">
                    @if (IsRefreshing)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    @if (IsRefreshing)
                    {
                        <span>Refreshing</span>
                    }
                    @if (!IsRefreshing)
                    {
                        <i class="bi bi-arrow-repeat me-2"></i>
                    }
                    @if (!IsRefreshing)
                    {
                        <span>Refresh</span>
                    }
                </button>
            </div>
        </div>

        @if (IsAutoRefreshEnabled)
        {
            <div class="alert alert-info py-1 px-2 small mb-2">
                Live refresh is enabled (visual only - data refresh will be wired in a later phase).
            </div>
        }

        <div class="collapse mb-3 @(_showSettingsPanel ? "show" : "")" id="dash-settings-panel">
            <div class="card shadow-sm rounded">
                <div class="card-header">
                    <h5 class="mb-0">Dashboard Settings</h5>
                </div>
                <div class="card-body small">
                    <p class="text-muted mb-2">
                        These settings control what you see on the dashboard. They are UI-only for now; behavior will be wired in a future phase.
                    </p>

                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowMembershipCard"
                                       @bind="ShowMembershipCard">
                                <label class="form-check-label" for="settingShowMembershipCard">
                                    Show Membership &amp; Dues card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowAccessCard"
                                       @bind="ShowAccessControlCard">
                                <label class="form-check-label" for="settingShowAccessCard">
                                    Show Access Control &amp; Doors card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowEventsCard"
                                       @bind="ShowEventsCard">
                                <label class="form-check-label" for="settingShowEventsCard">
                                    Show Events &amp; Hall Rentals card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowAlertsCard"
                                       @bind="ShowAlertsCard">
                                <label class="form-check-label" for="settingShowAlertsCard">
                                    Show Alerts &amp; Warnings card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowQuickActionsCard"
                                       @bind="ShowQuickActionsCard">
                                <label class="form-check-label" for="settingShowQuickActionsCard">
                                    Show Quick Actions card
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowBarSales"
                                       @bind="ShowBarSalesCard">
                                <label class="form-check-label" for="settingShowBarSales">
                                    Show Bar Sales &amp; Financials
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowBartenders"
                                       @bind="ShowBartendersCard">
                                <label class="form-check-label" for="settingShowBartenders">
                                    Show Tonight's Bartenders
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowActivityFeed"
                                       @bind="ShowActivityFeedCard">
                                <label class="form-check-label" for="settingShowActivityFeed">
                                    Show Recent Activity Feed
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowGracePeriod"
                                       @bind="ShowGracePeriodCard">
                                <label class="form-check-label" for="settingShowGracePeriod">
                                    Show Grace Period status
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowControllerHealth"
                                       @bind="ShowControllerHealthCard">
                                <label class="form-check-label" for="settingShowControllerHealth">
                                    Show Controller Health &amp; Queue
                                </label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="settingShowSystemStatusCard"
                                       checked="@ShowSystemStatusCard"
                                       @onchange="@(async e => { ShowSystemStatusCard = (bool)e.Value!; await SavePreferencesAsync(); })">
                                <label class="form-check-label" for="settingShowSystemStatusCard">
                                    Show System Status card
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-top">
                        <label class="small fw-bold text-muted mb-3 d-block uppercase-tracking">Quick Action Customization</label>
                        <div class="row g-2">
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="form-check form-switch card p-2 bg-light border-0">
                                    <input class="form-check-input ms-0" type="checkbox" id="qa_member" checked="@QaShowAddMember" @onchange="@(async e => { QaShowAddMember = (bool)e.Value!; await SavePreferencesAsync(); })">
                                    <label class="form-check-label ms-2 small fw-semibold" for="qa_member">Add Member</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="form-check form-switch card p-2 bg-light border-0">
                                    <input class="form-check-input ms-0" type="checkbox" id="qa_payment" checked="@QaShowRecordPayment" @onchange="@(async e => { QaShowRecordPayment = (bool)e.Value!; await SavePreferencesAsync(); })">
                                    <label class="form-check-label ms-2 small fw-semibold" for="qa_payment">Record Payment</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="form-check form-switch card p-2 bg-light border-0">
                                    <input class="form-check-input ms-0" type="checkbox" id="qa_door" checked="@QaShowOpenDoor" @onchange="@(async e => { QaShowOpenDoor = (bool)e.Value!; await SavePreferencesAsync(); })">
                                    <label class="form-check-label ms-2 small fw-semibold" for="qa_door">Open Door</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="form-check form-switch card p-2 bg-light border-0">
                                    <input class="form-check-input ms-0" type="checkbox" id="qa_rental" checked="@QaShowNewRental" @onchange="@(async e => { QaShowNewRental = (bool)e.Value!; await SavePreferencesAsync(); })">
                                    <label class="form-check-label ms-2 small fw-semibold" for="qa_rental">New Rental</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="form-check form-switch card p-2 bg-light border-0">
                                    <input class="form-check-input ms-0" type="checkbox" id="qa_sales" checked="@QaShowBarSales" @onchange="@(async e => { QaShowBarSales = (bool)e.Value!; await SavePreferencesAsync(); })">
                                    <label class="form-check-label ms-2 small fw-semibold" for="qa_sales">Bar Sales</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="form-check form-switch card p-2 bg-light border-0">
                                    <input class="form-check-input ms-0" type="checkbox" id="qa_staff" checked="@QaShowStaff" @onchange="@(async e => { QaShowStaff = (bool)e.Value!; await SavePreferencesAsync(); })">
                                    <label class="form-check-label ms-2 small fw-semibold" for="qa_staff">Staff Shifts</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="form-check form-switch card p-2 bg-light border-0">
                                    <input class="form-check-input ms-0" type="checkbox" id="qa_studio" checked="@QaShowStudio" @onchange="@(async e => { QaShowStudio = (bool)e.Value!; await SavePreferencesAsync(); })">
                                    <label class="form-check-label ms-2 small fw-semibold" for="qa_studio">Go to Studio</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="form-check form-switch card p-2 bg-light border-0">
                                    <input class="form-check-input ms-0" type="checkbox" id="qa_settings" checked="@QaShowSettings" @onchange="@(async e => { QaShowSettings = (bool)e.Value!; await SavePreferencesAsync(); })">
                                    <label class="form-check-label ms-2 small fw-semibold" for="qa_settings">Sys Settings</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-muted mt-3 mb-0">
                        @* TODO: Persist these settings per user/role in a future phase. Currently, they are session-only UI toggles. *@
                    </p>
                </div>
            </div>
        </div>

        @if (_isLoading && !_showSplash)
        {
            <div class="dash-loader-wrapper dash-fade-in">
                <div class="dash-loader-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-monogram">GFC</div>
                </div>
                <div class="dash-loader-text">Refreshing Control Center</div>
                <div class="dash-loader-progress">
                    <div class="dash-loader-bar"></div>
                </div>
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <div class="alert alert-danger">@_errorMessage</div>
        }
        else
        {
            var totalMembers = _metrics?.TotalMembers ?? _memberSummary?.TotalMembers ?? 0;
            var activeMembers = _metrics?.ActiveMembers ?? (_memberSummary is not null ? _memberSummary.RegularMembers + _memberSummary.LifeMembers : 0);
            var overdueCount = _metrics?.PastDueMembers ?? _duesSummary?.UnpaidCount ?? 0;

            <div class="container-fluid">
                <div class="row g-3">
                    <div class="col-12 col-lg-8">
                        <div class="dash-fade-in">
                            @if (ShowMembershipCard)
                            {
                                <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action {GetMembershipCardStateClass()}")" role="button" tabindex="0" aria-label="Open member list" @onclick="NavigateToSearchMember" @onkeydown="(e => HandleCardKeyDown(e, NavigateToSearchMember))">
                                    <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                        <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-membership-card" aria-expanded="true" aria-controls="dash-membership-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                            <h5 class="mb-0">
                                                <i class="bi bi-people me-2"></i>Membership &amp; Dues Overview
                                            </h5>
                                        </button>
                                        <NavLink href="/members" class="small text-decoration-none" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                            View members
                                        </NavLink>
                                    </div>
                                    <div class="collapse show" id="dash-membership-card">
                                        <div class="card-body">
                                            <p class="text-muted mb-2">
                                                High-level view of member counts and dues status will appear here.
                                            </p>
                                            <ul class="mb-0 small">
                                                <li>Total Members: <span class="fw-semibold">@totalMembers</span></li>
                                                <li>Members In Good Standing: <span class="fw-semibold">@activeMembers</span></li>
                                                <li>
                                                    Dues Overdue:
                                                    <span class="badge bg-warning text-dark ms-2 dash-pill-hover">@overdueCount</span>
                                                </li>
                                            </ul>
                                            @* TODO: Bind to real membership and dues metrics *@
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (ShowAccessControlCard)
                            {
                                <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action {GetControllersCardStateClass()}")" role="button" tabindex="0" aria-label="Open controller overview" @onclick="NavigateToControllerDiagnostics" @onkeydown="(e => HandleCardKeyDown(e, NavigateToControllerDiagnostics))">
                                    <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                        <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-access-card" aria-expanded="true" aria-controls="dash-access-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                            <div class="d-flex align-items-center gap-2">
                                                <h5 class="mb-0">
                                                    <i class="bi bi-door-open me-2"></i>Access Control &amp; Doors
                                                </h5>
                                                <span class="badge bg-primary dash-pill-hover">@_controllerSnapshots.Count</span>
                                            </div>
                                        </button>
                                        <NavLink href="/controllers" class="small text-decoration-none" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                            View controllers
                                        </NavLink>
                                    </div>
                                    <div class="collapse show" id="dash-access-card">
                                        <div class="card-body">
                                            <div class="small text-primary fw-semibold mb-2">
                                                Access System Overview
                                            </div>
                                            <p class="text-muted mb-2">
                                                Door status and access control activity will be summarized here.
                                            </p>
                                            @if (!string.IsNullOrWhiteSpace(_controllerConnectivityNote))
                                            {
                                                <div class="text-muted small mb-2">
                                                    Controller connectivity: @_controllerConnectivityNote
                                                </div>
                                            }
                                            <ul class="mb-0 small">
                                                <li>
                                                    Online Controllers:
                                                    <span class="badge bg-primary-subtle text-primary dash-pill-hover">@_controllerSnapshots.Count</span>
                                                </li>
                                                <li>Recent Door Events: <span class="fw-semibold">[placeholder]</span></li>
                                            </ul>
                                            @* TODO: Connect to controller status and event summaries *@
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (ShowEventsCard)
                            {
                                <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action")" role="button" tabindex="0" aria-label="Open rental management" @onclick='() => NavMgr.NavigateTo("/admin/rental-management")'>
                                    <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                        <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-events-card" aria-expanded="true" aria-controls="dash-events-card" @onclick:stopPropagation="true">
                                            <h5 class="mb-0">
                                                <i class="bi bi-calendar-event me-2"></i>Events &amp; Hall Rentals
                                            </h5>
                                        </button>
                                        <NavLink href="/admin/rental-management" class="small text-decoration-none" @onclick:stopPropagation="true">
                                            Manage rentals
                                        </NavLink>
                                    </div>
                                    <div class="collapse show" id="dash-events-card">
                                        <div class="card-body">
                                            <div class="small text-info fw-semibold mb-2">
                                                Current Schedule
                                            </div>
                                            @if (_upcomingRentals.Count == 0 && _pendingRentalCount == 0)
                                            {
                                                <p class="text-muted small mb-0">
                                                    No upcoming events or pending requests.
                                                </p>
                                            }
                                            else
                                            {
                                                <ul class="mb-0 small list-unstyled">
                                                    @foreach (var rental in _upcomingRentals)
                                                    {
                                                        <li class="mb-2 d-flex justify-content-between align-items-center">
                                                            <span>
                                                                <span class="badge bg-info-subtle text-info me-1">@rental.RequestedDate.ToString("MMM dd")</span>
                                                                <span class="fw-semibold">@rental.ApplicantName</span>
                                                            </span>
                                                            <span class="extra-small text-muted">@rental.StartTime</span>
                                                        </li>
                                                    }
                                                    @if (_pendingRentalCount > 0)
                                                    {
                                                        <li class="mt-2 pt-2 border-top">
                                                            <span class="text-warning">
                                                                <i class="bi bi-clock-history me-1"></i> <strong>@_pendingRentalCount</strong> Pending Requests
                                                            </span>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (ShowBarSalesCard)
                            {
                                <div class="card mb-3 shadow-sm rounded metric-card dash-card-action" role="button" tabindex="0" aria-label="Open Bar Sales" @onclick='() => NavMgr.NavigateTo("/bar-sales")'>
                                    <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                        <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-barsales-card" aria-expanded="true" aria-controls="dash-barsales-card" @onclick:stopPropagation="true">
                                            <h5 class="mb-0">
                                                <i class="bi bi-currency-dollar me-2"></i>Bar Sales &amp; Financials
                                            </h5>
                                        </button>
                                        <NavLink href="/bar-sales" class="small text-decoration-none" @onclick:stopPropagation="true">
                                            View detail
                                        </NavLink>
                                    </div>
                                    <div class="collapse show" id="dash-barsales-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-end mb-2">
                                                <div>
                                                    <div class="small text-muted mb-0">Sales (This Week)</div>
                                                    <div class="h4 mb-0 fw-bold @(_metrics?.WeeklyBarSalesTrend >= 0 ? "text-success" : "text-danger")">
                                                        @(_metrics?.WeeklyBarSales.ToString("C") ?? "$0.00")
                                                    </div>
                                                </div>
                                                <div class="text-end">
                                                    <div class="small text-muted mb-0">Transactions</div>
                                                    <div class="fw-semibold">@(_metrics?.WeeklyBarTransactionCount ?? 0)</div>
                                                </div>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar @(_metrics?.WeeklyBarSalesTrend >= 0 ? "bg-success" : "bg-danger")" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <div class="small text-muted mt-1">
                                                @if (_metrics?.WeeklyBarSalesTrend != 0)
                                                {
                                                    <span>@Math.Abs(_metrics?.WeeklyBarSalesTrend ?? 0).ToString("N1")% @(_metrics?.WeeklyBarSalesTrend >= 0 ? "increase" : "decrease") from last week</span>
                                                }
                                                else
                                                {
                                                    <span>No change from last week</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (ShowActivityFeedCard)
                            {
                                <div class="card mb-3 shadow-sm rounded metric-card">
                                    <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                        <h5 class="mb-0">
                                            <i class="bi bi-lightning-charge me-2"></i>Recent Activity Feed
                                        </h5>
                                        <NavLink href="/controller-events" class="small text-decoration-none">
                                            Full log
                                        </NavLink>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush small">
                                            @if (_metrics?.RecentActivities == null || !_metrics.RecentActivities.Any())
                                            {
                                                <div class="list-group-item text-muted py-3 text-center border-0">
                                                    No recent activity recorded.
                                                </div>
                                            }
                                            else
                                            {
                                                @foreach (var activity in _metrics.RecentActivities)
                                                {
                                                    <div class="list-group-item py-2 border-0 bg-transparent">
                                                        <div class="d-flex justify-content-between">
                                                            <span class="fw-semibold">@activity.Title</span>
                                                            <span class="extra-small text-muted">@GetRelativeTime(activity.TimestampUtc)</span>
                                                        </div>
                                                        <div class="text-muted">@activity.Detail</div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="col-12 col-lg-4">
                        @if (ShowGracePeriodCard && _graceEndDate.HasValue && DateTime.Today <= _graceEndDate.Value)
                        {
                            var daysRemaining = (_graceEndDate.Value - DateTime.Today).Days;
                            var statusColor = daysRemaining > 30 ? "success" : daysRemaining > 7 ? "warning" : "danger";
                            var iconClass = daysRemaining > 7 ? "bi-calendar-check" : "bi-exclamation-circle";
                            
                            <div class="card mb-3 shadow-sm rounded metric-card dash-card-action" role="button" tabindex="0" @onclick='() => NavMgr.NavigateTo("/keycards")'>
                                <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                    <h5 class="mb-0">
                                        <i class="bi @iconClass me-2 text-@statusColor"></i>Grace Period
                                    </h5>
                                    <span class="badge bg-@statusColor">@daysRemaining days</span>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="small text-muted">Ends</div>
                                        <div class="fw-semibold">@_graceEndDate.Value.ToShortDateString()</div>
                                    </div>
                                    @if (_membersAtRiskCount > 0)
                                    {
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="small text-muted">Members at Risk</div>
                                            <span class="badge bg-warning text-dark">@_membersAtRiskCount</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (ShowControllerHealthCard)
                        {
                            var isOnline = _controllerHealthStatus?.IsOnline ?? false;
                            var statusClass = isOnline ? "success" : "danger";
                            var statusText = isOnline ? "Online" : "Offline";
                            
                            <div class="card mb-3 shadow-sm rounded metric-card dash-card-action" role="button" tabindex="0" @onclick='() => NavMgr.NavigateTo("/keycards/sync-queue")'>
                                <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-cpu me-2"></i>Controller Health
                                    </h5>
                                    <span class="badge bg-@statusClass">@statusText</span>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="small text-muted">Pending Syncs</div>
                                        <div class="fw-semibold">
                                            @if (_pendingSyncCount > 0)
                                            {
                                                <span class="badge bg-warning text-dark">@_pendingSyncCount</span>
                                            }
                                            else
                                            {
                                                <span class="text-success">All Clear</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="small text-muted">Last Ping</div>
                                        <div class="small">
                                            @if (_controllerHealthStatus?.LastSuccessfulPing.HasValue == true)
                                            {
                                                @GetRelativeTime(_controllerHealthStatus.LastSuccessfulPing.Value.ToUniversalTime())
                                            }
                                            else
                                            {
                                                <span>Never</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (ShowAlertsCard)
                        {
                            <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action {GetAlertsCardStateClass()}")" role="button" tabindex="0" aria-label="Open alerts center" @onclick="NavigateToAlerts" @onkeydown="(e => HandleCardKeyDown(e, NavigateToAlerts))">
                                <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                    <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-alerts-card" aria-expanded="true" aria-controls="dash-alerts-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                        <h5 class="mb-0">
                                            <i class="bi bi-exclamation-triangle me-2"></i>Alerts &amp; Warnings
                                        </h5>
                                    </button>
                                </div>
                                <div class="collapse show" id="dash-alerts-card">
                                    <div class="card-body">
                                        <div class="small text-warning fw-semibold mb-2">
                                            System Alerts
                                        </div>
                                        <p class="text-muted small mb-2">
                                            Important alerts will appear here when attention is required.
                                        </p>
                                        @if (Alerts != null && Alerts.Count > 0)
                                        {
                                            <ul class="mb-0 small">
                                                @foreach (var alert in Alerts)
                                                {
                                                    var alertClass = alert.Severity switch
                                                    {
                                                        "Danger" => "text-danger",
                                                        "Warning" => "text-warning",
                                                        "Info" or _ => "text-info"
                                                    };

                                                    <li class="@alertClass">
                                                        <strong>@alert.Source:</strong> @alert.Message
                                                    </li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <ul class="mb-0 small">
                                                <li class="text-muted">No critical alerts detected.</li>
                                            </ul>
                                        }
                                        @* TODO: Populate Alerts from dues, waiver, controller, and membership logic in a future phase *@
                                    </div>
                                </div>
                            </div>
                        }

                        @if (ShowBartendersCard)
                        {
                            <div class="card mb-3 shadow-sm rounded metric-card">
                                <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-person-badge me-2"></i>Tonight's Bartenders
                                    </h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush small">
                                        @if (_metrics?.TonightBartenders == null || !_metrics.TonightBartenders.Any())
                                        {
                                            <div class="list-group-item text-muted py-3 text-center border-0">
                                                No staff scheduled for tonight.
                                            </div>
                                        }
                                        else
                                        {
                                            @foreach (var staff in _metrics.TonightBartenders)
                                            {
                                                <div class="list-group-item d-flex align-items-center gap-2 py-2 border-0 bg-transparent">
                                                    <div class="rounded-circle bg-primary-subtle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                        <i class="bi bi-person text-primary"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-semibold">@staff.Name</div>
                                                        <div class="extra-small text-muted">@staff.Assignment</div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        @if (ShowQuickActionsCard)
                        {
                            <div class="card mb-3 shadow-sm border-0 rounded-4 overflow-hidden">
                                <div class="card-header bg-white border-bottom-0 pt-3 pb-1">
                                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                                        <span class="p-2 rounded-3 bg-primary-subtle text-primary me-2 d-flex align-items-center justify-content-center">
                                            <i class="bi bi-lightning-charge-fill fs-6"></i>
                                        </span>
                                        Quick Actions
                                    </h5>
                                </div>
                                <div class="card-body pt-2">
                                    <div class="row g-2">
                                        @if (QaShowAddMember)
                                        {
                                            <div class="col-6">
                                                <a href="/members/new?returnUrl=/" class="quick-action-btn">
                                                    <i class="bi bi-person-plus"></i>
                                                    <span>Add Member</span>
                                                </a>
                                            </div>
                                        }
                                        @if (QaShowRecordPayment)
                                        {
                                            <div class="col-6">
                                                <a href="/dues" class="quick-action-btn">
                                                    <i class="bi bi-cash-stack"></i>
                                                    <span>Record Dues</span>
                                                </a>
                                            </div>
                                        }
                                        @if (QaShowOpenDoor)
                                        {
                                            <div class="col-6">
                                                <button type="button" class="quick-action-btn" @onclick="TestSimulatedDoorOpen">
                                                    <i class="bi bi-door-open"></i>
                                                    <span>Open Door</span>
                                                </button>
                                            </div>
                                        }
                                        @if (QaShowNewRental)
                                        {
                                            <div class="col-6">
                                                <a href="/admin/hall-management" class="quick-action-btn">
                                                    <i class="bi bi-calendar-check"></i>
                                                    <span>New Rental</span>
                                                </a>
                                            </div>
                                        }
                                        @if (QaShowBarSales)
                                        {
                                            <div class="col-6">
                                                <a href="/admin/bar-sales" class="quick-action-btn">
                                                    <i class="bi bi-currency-dollar"></i>
                                                    <span>Bar Sales</span>
                                                </a>
                                            </div>
                                        }
                                        @if (QaShowStaff)
                                        {
                                            <div class="col-6">
                                                <a href="/admin/staff-shifts" class="quick-action-btn">
                                                    <i class="bi bi-people"></i>
                                                    <span>Staff Management</span>
                                                </a>
                                            </div>
                                        }
                                        @if (QaShowStudio)
                                        {
                                            <div class="col-6">
                                                <a href="/studio" class="quick-action-btn">
                                                    <i class="bi bi-brush"></i>
                                                    <span>Visual Studio</span>
                                                </a>
                                            </div>
                                        }
                                        @if (QaShowSettings)
                                        {
                                            <div class="col-6">
                                                <a href="/admin/settings" class="quick-action-btn">
                                                    <i class="bi bi-gear"></i>
                                                    <span>Sys Settings</span>
                                                </a>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        @if (ShowSystemStatusCard)
                        {
                            <div class="@($"card mb-3 shadow-sm rounded metric-card dash-card-action {GetSystemStatusCardStateClass()}")" role="button" tabindex="0" aria-label="Open system status details" @onclick="NavigateToReplaceCard" @onkeydown="(e => HandleCardKeyDown(e, NavigateToReplaceCard))">
                                <div class="card-header d-flex justify-content-between align-items-center dash-card-header">
                                    <button class="btn btn-link btn-sm text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dash-status-card" aria-expanded="true" aria-controls="dash-status-card" @onclick:stopPropagation="true" @onkeydown:stopPropagation="true">
                                        <h5 class="mb-0">
                                            <i class="bi bi-activity me-2"></i>System Status
                                        </h5>
                                    </button>
                                </div>
                                <div class="collapse show" id="dash-status-card">
                                    <div class="card-body">
                                        <div class="small text-secondary fw-semibold mb-2">
                                            Current System Health
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(_controllerConnectivityNote))
                                        {
                                            <div class="text-muted small mb-2">
                                                Controller connectivity: @_controllerConnectivityNote
                                            </div>
                                        }
                                        <ul class="mb-0 small">
                                            <li>
                                                Controllers:
                                                <span class="badge bg-secondary-subtle text-dark dash-pill-hover">@_controllerSnapshots.Count</span>
                                            </li>
                                            <li>Database: <span class="fw-semibold">[placeholder]</span></li>
                                            <li>
                                                Backups:
                                                <span class="badge bg-secondary-subtle text-dark dash-pill-hover">@FormatDate(_backupStatus?.LastBackupUtc)</span>
                                            </li>
                                        </ul>
                                        @* TODO: Connect to maintenance/health metrics *@
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    .dash-page {
        transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    .dash-hidden {
        opacity: 0;
        transform: scale(0.98) translateY(10px);
        pointer-events: none;
        height: 0;
        overflow: hidden;
    }
    
    .dash-visible {
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: auto;
    }

    .dash-fade-in {
        opacity: 0;
        animation: dash-fade-in .25s ease forwards;
    }

    @@keyframes dash-fade-in {
        to {
            opacity: 1;
        }
    }

    .dash-card-action {
        cursor: pointer;
        transition: transform .15s ease, box-shadow .15s ease;
    }

    .dash-card-action:hover,
    .dash-card-action:focus-visible {
        transform: translateY(-3px);
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.12);
    }

    .dash-card-action:focus-visible {
        outline: 2px solid var(--bs-primary);
        outline-offset: 2px;
    }

    .dash-hover-card {
        transition: transform .15s ease, box-shadow .15s ease;
    }

    .dash-hover-card:hover,
    .dash-hover-card:focus-within {
        transform: translateY(-3px);
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.12);
    }

    .dash-card-header {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: border-color .2s ease;
    }

    .dash-card-action:hover .dash-card-header,
    .dash-card-action:focus-visible .dash-card-header,
    .dash-hover-card:hover .dash-card-header,
    .dash-hover-card:focus-within .dash-card-header {
        border-color: rgba(0, 0, 0, 0.15);
    }

    .dash-pill-hover {
        transition: background-color .2s ease, transform .15s ease;
    }

    .dash-pill-hover:hover,
    .dash-pill-hover:focus-visible {
        transform: scale(1.06);
        outline: 2px solid transparent;
        outline-offset: 2px;
    }

    .dash-quick-action:hover,
    .dash-quick-action:focus-visible {
        transform: scale(1.04);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }

    /* Modern Simple Loader */
    .dash-loader-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        width: 100%;
        padding: 2rem;
        gap: 1.5rem;
    }

    .dash-loader-spinner {
        position: relative;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .spinner-ring {
        position: absolute;
        inset: 0;
        border: 3px solid rgba(14, 165, 233, 0.1);
        border-top: 3px solid var(--accent-primary, #0ea5e9);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .spinner-monogram {
        font-weight: 800;
        font-size: 1.2rem;
        color: var(--accent-primary);
        letter-spacing: -1px;
        animation: pulse-op 2s ease-in-out infinite;
    }

    @@keyframes pulse-op {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(0.95); }
    }

    .dash-loader-text {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.95rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    .dash-loader-progress {
        width: 160px;
        height: 4px;
        background: var(--bg-surface-hover);
        border-radius: 999px;
        overflow: hidden;
    }

    .dash-loader-bar {
        width: 40%;
        height: 100%;
        background: var(--accent-primary);
        border-radius: 999px;
        animation: progress-flow 1.5s infinite ease-in-out;
    }

    @@keyframes progress-flow {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(250%); }
    }
</style>

@code {
    private bool _isLoading = true;
    private bool _metricsLoading;
    private bool _alertsLoading;
    private bool _showSplash = true;
    private bool _isSplashFadingOut = false;
    private MemberSummaryDto? _memberSummary;
    private DuesSummaryDto? _duesSummary;
    private AlertSummaryDto? _alerts;
    private BackupStatusDto? _backupStatus;
    private string? _errorMessage;
    private string? _metricsError;
    private string? _alertsError;
    private DashboardMetricsDto? _metrics;
    private bool _sidebarOpen = true;
    private DashboardSidebarTab _activeSidebarTab = DashboardSidebarTab.Alerts;
    private bool _alertsExpanded = true;
    private readonly List<AlertPreviewItem> _importantAlerts = new();
    private readonly List<AlertPreviewItem> _alertPreview = new();
    private readonly List<ControllerSnapshot> _controllerSnapshots = new();
    private string? _controllerConnectivityNote;
    private bool _useRealControllers;
    private bool _isSimulationMode;
    private bool IsRefreshing;
    private bool IsAutoRefreshEnabled { get; set; } = false;
    private bool ShowMembershipCard { get; set; } = true;
    private bool ShowAccessControlCard { get; set; } = true;
    private bool ShowEventsCard { get; set; } = true;
    private bool ShowAlertsCard { get; set; } = true;
    private bool ShowQuickActionsCard { get; set; } = true;
    private bool ShowSystemStatusCard { get; set; } = true;
    private bool ShowBarSalesCard { get; set; } = true;
    private bool ShowBartendersCard { get; set; } = true;
    private bool ShowGracePeriodCard { get; set; } = true;
    private bool ShowControllerHealthCard { get; set; } = true;
    private bool ShowActivityFeedCard { get; set; } = true;

    // Quick Action Toggles
    private bool QaShowAddMember { get; set; } = true;
    private bool QaShowRecordPayment { get; set; } = true;
    private bool QaShowOpenDoor { get; set; } = true;
    private bool QaShowNewRental { get; set; } = false;
    private bool QaShowBarSales { get; set; } = false;
    private bool QaShowStaff { get; set; } = false;
    private bool QaShowStudio { get; set; } = false;
    private bool QaShowSettings { get; set; } = false;

    private class DashboardPreferences
    {
        public bool ShowMembershipCard { get; set; } = true;
        public bool ShowAccessControlCard { get; set; } = true;
        public bool ShowEventsCard { get; set; } = true;
        public bool ShowAlertsCard { get; set; } = true;
        public bool ShowQuickActionsCard { get; set; } = true;
        public bool ShowSystemStatusCard { get; set; } = true;
        public bool ShowBarSalesCard { get; set; } = true;
        public bool ShowBartendersCard { get; set; } = true;
        public bool ShowActivityFeedCard { get; set; } = true;
        public bool ShowGracePeriodCard { get; set; } = true;
        public bool ShowControllerHealthCard { get; set; } = true;
        public bool QaShowAddMember { get; set; } = true;
        public bool QaShowRecordPayment { get; set; } = true;
        public bool QaShowOpenDoor { get; set; } = true;
        public bool QaShowNewRental { get; set; } = false;
        public bool QaShowBarSales { get; set; } = false;
        public bool QaShowStaff { get; set; } = false;
        public bool QaShowStudio { get; set; } = false;
        public bool QaShowSettings { get; set; } = false;
    }

    private async Task SavePreferencesAsync()
    {
        try
        {
            var prefs = new DashboardPreferences
            {
                ShowMembershipCard = ShowMembershipCard,
                ShowAccessControlCard = ShowAccessControlCard,
                ShowEventsCard = ShowEventsCard,
                ShowAlertsCard = ShowAlertsCard,
                ShowQuickActionsCard = ShowQuickActionsCard,
                ShowSystemStatusCard = ShowSystemStatusCard,
                ShowBarSalesCard = ShowBarSalesCard,
                ShowBartendersCard = ShowBartendersCard,
                ShowActivityFeedCard = ShowActivityFeedCard,
                ShowGracePeriodCard = ShowGracePeriodCard,
                ShowControllerHealthCard = ShowControllerHealthCard,
                QaShowAddMember = QaShowAddMember,
                QaShowRecordPayment = QaShowRecordPayment,
                QaShowOpenDoor = QaShowOpenDoor,
                QaShowNewRental = QaShowNewRental,
                QaShowBarSales = QaShowBarSales,
                QaShowStaff = QaShowStaff,
                QaShowStudio = QaShowStudio,
                QaShowSettings = QaShowSettings
            };
            var json = System.Text.Json.JsonSerializer.Serialize(prefs);
            await JS.InvokeVoidAsync("localStorage.setItem", "dashboard_prefs", json);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:save] {ex}");
        }
    }

    private async Task LoadPreferencesAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_prefs");
            if (!string.IsNullOrEmpty(json))
            {
                var prefs = System.Text.Json.JsonSerializer.Deserialize<DashboardPreferences>(json);
                if (prefs != null)
                {
                    ShowMembershipCard = prefs.ShowMembershipCard;
                    ShowAccessControlCard = prefs.ShowAccessControlCard;
                    ShowEventsCard = prefs.ShowEventsCard;
                    ShowAlertsCard = prefs.ShowAlertsCard;
                    ShowQuickActionsCard = prefs.ShowQuickActionsCard;
                    ShowSystemStatusCard = prefs.ShowSystemStatusCard;
                    ShowBarSalesCard = prefs.ShowBarSalesCard;
                    ShowBartendersCard = prefs.ShowBartendersCard;
                    ShowActivityFeedCard = prefs.ShowActivityFeedCard;
                    ShowGracePeriodCard = prefs.ShowGracePeriodCard;
                    ShowControllerHealthCard = prefs.ShowControllerHealthCard;
                    QaShowAddMember = prefs.QaShowAddMember;
                    QaShowRecordPayment = prefs.QaShowRecordPayment;
                    QaShowOpenDoor = prefs.QaShowOpenDoor;
                    QaShowNewRental = prefs.QaShowNewRental;
                    QaShowBarSales = prefs.QaShowBarSales;
                    QaShowStaff = prefs.QaShowStaff;
                    QaShowStudio = prefs.QaShowStudio;
                    QaShowSettings = prefs.QaShowSettings;
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:load] {ex}");
        }
    }

    private bool _showSettingsPanel = false;
    private string? _defaultControllerSerial;
    private int? _defaultDoorIndex;
    private List<HallRentalRequest> _upcomingRentals = new();
    private int _pendingRentalCount;
    private sealed class DashboardAlert
    {
        public string Severity { get; set; } = "Info";   // e.g., Info, Warning, Danger
        public string Message { get; set; } = string.Empty;
        public string Source { get; set; } = string.Empty; // e.g., "Dues", "Access", "System"
    }

    private List<DashboardAlert> Alerts { get; set; } = new();
    
    // Key Card & Sync Data
    private DateTime? _graceEndDate;
    private int _membersAtRiskCount;
    private int _pendingSyncCount;
    private ControllerHealthStatus _controllerHealthStatus;
    
    private enum MetricState
    {
        Normal,
        Warning,
        Critical
    }

    private static class DashboardThresholds
    {
        public const int AlertsWarning = 1;
        public const int AlertsCritical = 5;
        public const int OverdueWarning = 1;
        public const int OverdueCritical = 5;
        public const int ControllersOfflineWarning = 1;
        public const int ControllersOfflineCritical = 2;
        public const int BackupStaleDaysWarning = 7;
        public const int BackupStaleDaysCritical = 30;
    }

    protected override async Task OnInitializedAsync()
    {
        bool showSplash = !SessionState.HasShownSplash;
        if (showSplash) SessionState.HasShownSplash = true;
        
        await LoadDashboardAsync(includeSplash: showSplash);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadPreferencesAsync();
            StateHasChanged();
        }
    }

    private async Task LoadDashboardAsync(bool includeSplash)
    {
        _showSplash = includeSplash;
        _isSplashFadingOut = false;
        _isLoading = true;
        _metricsLoading = true;
        _alertsLoading = true;
        _errorMessage = null;
        _metricsError = null;
        _alertsError = null;
        
        // 1. Kick off all data fetching tasks IMMEDIATELY
        var metricsTask = DashboardMetricsService.GetMetricsAsync();
        var controllerModeTask = LoadControllerModeAsync();
        var memberTask = DashboardService.GetMemberSummaryAsync();
        var duesTask = DashboardService.GetCurrentYearDuesSummaryAsync();
        var alertsTask = DashboardService.GetAlertSummaryAsync();
        var backupStatusTask = DashboardService.GetBackupStatusAsync();
        var rentalsTask = RentalService.GetRentalRequestsAsync();

        // 2. Define minimum splash duration (Reduced for faster perceived speed)
        var minSplashDelay = includeSplash ? Task.Delay(800) : Task.CompletedTask;

        try
        {
            // 3. Show the UI shell as soon as the splash/delay is done
            if (includeSplash)
            {
                await minSplashDelay;
                _isSplashFadingOut = true;
                StateHasChanged();
                await Task.Delay(400); // Sync with CSS
                _showSplash = false;
            }

            _isLoading = false;
            StateHasChanged();

            // 4. Update data as it arrives (Progressive Loading)
            try { _memberSummary = await memberTask; } catch (Exception ex) { Console.Error.WriteLine($"[Dashboard:memberTask] {ex.Message}"); }
            try { _duesSummary = await duesTask; } catch (Exception ex) { Console.Error.WriteLine($"[Dashboard:duesTask] {ex.Message}"); }
            try { _alerts = await alertsTask; } catch (Exception ex) { Console.Error.WriteLine($"[Dashboard:alertsTask] {ex.Message}"); }
            try { _backupStatus = await backupStatusTask; } catch (Exception ex) { Console.Error.WriteLine($"[Dashboard:backupStatusTask] {ex.Message}"); }
            
            // New Data Fetching
            try 
            {
                var settings = await Task.Run(() => DuesYearSettingsRepository.GetSettingsForYear(DateTime.Today.Year));
                _graceEndDate = settings?.GraceEndDate;
                
                var risks = await KeyCardLifecycleService.GetMembersAtRiskAsync(DateTime.Today.Year);
                _membersAtRiskCount = risks.Count;
                
                _pendingSyncCount = await SyncQueueRepository.GetPendingCountAsync();
                _controllerHealthStatus = ControllerHealthService.GetHealthStatus();
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"[Dashboard:newMetrics] {ex.Message}");
            }
            
            try 
            {
                var allRentals = await rentalsTask;
                var rentalList = allRentals.ToList();
                _upcomingRentals = rentalList.Where(r => r.Status == RentalStatus.Approved && r.RequestedDate.Date >= DateTime.Today).OrderBy(r => r.RequestedDate).Take(3).ToList();
                _pendingRentalCount = rentalList.Count(r => r.Status == RentalStatus.Pending);
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"[Dashboard:rentalsTask] {ex.Message}");
            }

            _importantAlerts.Clear();
            _alertPreview.Clear();
            if (_alerts != null)
            {
                var important = BuildAlertPreview(_alerts);
                _alertPreview.AddRange(important);
                _importantAlerts.AddRange(important);
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard] Critical: {ex.Message}");
            // We no longer set _errorMessage here to allow the shell to stay visible even if data fails.
            _isLoading = false;
        }

        // 5. Cleanup metrics and controllers (secondary)
        try { _metrics = await metricsTask; } catch { /* log handled elsewhere */ }
        await controllerModeTask;
        _isSimulationMode = !_useRealControllers;
        await LoadControllerStatusSafeAsync();
        
        Alerts ??= new List<DashboardAlert>();
        StateHasChanged();
    }

    private async Task RefreshAsync()
    {
        if (IsRefreshing || _isLoading)
        {
            return;
        }

        IsRefreshing = true;
        StateHasChanged();

        try
        {
            await LoadDashboardAsync(includeSplash: false);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:refresh] {ex}");
            _errorMessage = "Dashboard refresh failed. Please try again.";
        }
        finally
        {
            IsRefreshing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string FormatDate(DateTime? value)
    {
        if (value == null)
        {
            return "Not available";
        }

        return value.Value.ToLocalTime().ToString("MMM d, yyyy h:mm tt");
    }

    private static string FormatShort(DateTime? value)
    {
        if (value == null)
        {
            return "Never";
        }

        return value.Value.ToLocalTime().ToString("MMM d, h:mm tt");
    }

    private void ToggleSidebar() => _sidebarOpen = !_sidebarOpen;

    private void ToggleAlertsSection() => _alertsExpanded = !_alertsExpanded;

    private void SetTab(DashboardSidebarTab tab) => _activeSidebarTab = tab;

    private void ToggleSettingsPanel() => _showSettingsPanel = !_showSettingsPanel;

    private int GetOpenAlertsCount()
    {
        if (_metrics?.OpenAlerts is { } open)
        {
            return open;
        }

        return _alerts is null ? 0 : CalculateOpenAlerts(_alerts);
    }

    private IEnumerable<AlertPreviewItem> BuildAlertPreview(AlertSummaryDto summary)
    {
        var now = DateTime.UtcNow;
        var items = new List<AlertPreviewItem>();

        if (summary.LifeEligibleCount > 0)
        {
            items.Add(new AlertPreviewItem(
                "Life eligible",
                "Members meet Life criteria but are still Regular.",
                summary.LifeEligibleCount,
                now,
                "dash-alert-pill-warn"));
        }

        if (summary.NpQueueCount > 0)
        {
            items.Add(new AlertPreviewItem(
                "NP queue",
                "Guests are waiting for promotion to Regular.",
                summary.NpQueueCount,
                now,
                "dash-alert-pill-info"));
        }

        if (summary.OverdueMembers15Months > 0)
        {
            items.Add(new AlertPreviewItem(
                "Overdue 15+ months",
                "Members overdue on dues beyond 15 months.",
                summary.OverdueMembers15Months,
                now,
                "dash-alert-pill-danger"));
        }

        if (summary.PhysicalKeysToReturn > 0)
        {
            items.Add(new AlertPreviewItem(
                "Physical keys to return",
                "Non-board members hold active physical keys.",
                summary.PhysicalKeysToReturn,
                now,
                "dash-alert-pill-warn"));
        }

        if (summary.BoardAlertYear > 0 && (!summary.BoardConfirmed || (summary.BoardPositionsUnfilled?.Count ?? 0) > 0))
        {
            items.Add(new AlertPreviewItem(
                "Board roles open",
                $"Board {summary.BoardAlertYear} needs: {string.Join(", ", summary.BoardPositionsUnfilled ?? Array.Empty<string>())}",
                Math.Max(1, summary.BoardPositionsUnfilled?.Count ?? 0),
                now,
                "dash-alert-pill-danger"));
        }

        return items;
    }

    private async Task LoadControllerSnapshotAsync()
    {
        try
        {
            _controllerConnectivityNote = null;
            _controllerSnapshots.Clear();

            if (_isSimulationMode)
            {
                await ApplySimulationControllerStateAsync();
                return;
            }

            await ControllerClient.PingAsync(CancellationToken.None);

            var controllers = await ControllerRegistryService.GetControllersAsync(cancellationToken: CancellationToken.None);
            var firstControllerWithDoor = controllers.FirstOrDefault(c => c.Doors.Any());
            if (firstControllerWithDoor is not null)
            {
                _defaultControllerSerial ??= firstControllerWithDoor.SerialNumberDisplay;
                _defaultDoorIndex ??= firstControllerWithDoor.Doors.OrderBy(d => d.DoorIndex).First().DoorIndex;
            }
            var controllerIds = controllers.Select(c => c.Id).ToList();
            var latestEvents = controllerIds.Count > 0
                ? await ControllerEventService.GetLatestEventsByControllerAsync(controllerIds)
                : new Dictionary<int, ControllerEvent>();

            foreach (var controller in controllers)
            {
                latestEvents.TryGetValue(controller.Id, out var evt);
                _controllerSnapshots.Add(new ControllerSnapshot(
                    controller.Id,
                    controller.Name,
                    GetControllerStatusText(evt),
                    GetControllerStatusClass(evt),
                    controller.IsEnabled,
                    evt?.TimestampUtc));
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:controllers] {ex}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadControllerStatusSafeAsync()
    {
        await LoadControllerSnapshotAsync();
    }
    private async Task ApplySimulationControllerStateAsync()
    {
        _controllerConnectivityNote = "Simulation Mode";
        _controllerSnapshots.Clear();

        var controllers = await ControllerRegistryService.GetControllersAsync(cancellationToken: CancellationToken.None);
        var firstControllerWithDoor = controllers.FirstOrDefault(c => c.Doors.Any());
        if (firstControllerWithDoor is not null)
        {
            _defaultControllerSerial ??= firstControllerWithDoor.SerialNumberDisplay;
            _defaultDoorIndex ??= firstControllerWithDoor.Doors.OrderBy(d => d.DoorIndex).First().DoorIndex;
        }

        foreach (var controller in controllers)
        {
            _controllerSnapshots.Add(new ControllerSnapshot(
                controller.Id,
                controller.Name,
                "Simulation Mode",
                "bg-secondary",
                controller.IsEnabled,
                null));
        }
    }

    private async Task LoadControllerModeAsync()
    {
        try
        {
            var settings = await SystemSettingsService.GetAsync();
            _useRealControllers = true; // Simulation mode removed
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:controllerMode] {ex}");
            _useRealControllers = false;
        }
    }

    private static string GetControllerStatusText(ControllerEvent? lastEvent)
    {
        if (lastEvent == null)
        {
            return "Never";
        }

        var age = DateTime.UtcNow - lastEvent.TimestampUtc;
        if (age.TotalHours < 1)
        {
            return "Online";
        }
        if (age.TotalHours < 24)
        {
            return "Stale";
        }

        return "Offline";
    }

    private static string GetControllerStatusClass(ControllerEvent? lastEvent)
    {
        if (lastEvent == null)
        {
            return "bg-secondary";
        }

        var age = DateTime.UtcNow - lastEvent.TimestampUtc;
        if (age.TotalHours < 1)
        {
            return "bg-success";
        }
        if (age.TotalHours < 24)
        {
            return "bg-warning text-dark";
        }

        return "bg-danger";
    }

    private static string GetStatusDotClass(string statusClass)
    {
        if (statusClass.Contains("success", StringComparison.OrdinalIgnoreCase))
        {
            return "text-success";
        }

        if (statusClass.Contains("warning", StringComparison.OrdinalIgnoreCase))
        {
            return "text-warning";
        }

        if (statusClass.Contains("danger", StringComparison.OrdinalIgnoreCase))
        {
            return "text-danger";
        }

        return "text-secondary";
    }

    private string GetControllerDetailText(ControllerSnapshot snapshot)
    {
        if (snapshot.LastEventUtc == null)
        {
            return "Last event: never";
        }

        return $"Last event: {FormatShort(snapshot.LastEventUtc)}";
    }

    private static void HandleCardKeyDown(KeyboardEventArgs e, Action navigateAction)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            navigateAction();
        }
    }

    private void NavigateToAlerts() => NavMgr.NavigateTo("/alerts");

    private void NavigateToControllerDiagnostics() => NavMgr.NavigateTo("/controllers");

    private void NavigateToNewMember() => NavMgr.NavigateTo("/members");

    private void NavigateToRecordDues() => NavMgr.NavigateTo("/dues");

    private void NavigateToReplaceCard() => NavMgr.NavigateTo("/keycards");

    private void NavigateToSearchMember() => NavMgr.NavigateTo("/members");

    private async Task TestSimulatedDoorOpen()
    {
        if (!_isSimulationMode || string.IsNullOrWhiteSpace(_defaultControllerSerial) || !_defaultDoorIndex.HasValue)
        {
            return;
        }

        try
        {
            await ControllerClient.OpenDoorAsync(_defaultControllerSerial, _defaultDoorIndex.Value);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dashboard:simOpenDoor] {ex}");
        }
    }

    private static int CalculateOpenAlerts(AlertSummaryDto alert)
    {
        var boardPositions = alert.BoardPositionsUnfilled?.Count ?? 0;
        var boardOpen = alert.BoardAlertYear > 0 && (!alert.BoardConfirmed || boardPositions > 0)
            ? Math.Max(1, boardPositions)
            : 0;

        return Math.Max(0, alert.PhysicalKeysToReturn)
             + Math.Max(0, alert.NpQueueCount)
             + Math.Max(0, alert.OverdueMembers15Months)
             + Math.Max(0, alert.LifeEligibleCount)
             + boardOpen;
    }

    private static string GetSeverityLabel(AlertPreviewItem alert) => alert.SeverityClass switch
    {
        "dash-alert-pill-danger" => "Critical",
        "dash-alert-pill-warn" => "Warning",
        "dash-alert-pill-info" => "Info",
        _ => "Info"
    };

    private static string GetSeverityClass(AlertPreviewItem alert) => alert.SeverityClass switch
    {
        "dash-alert-pill-danger" => "alert-severity alert-severity-critical",
        "dash-alert-pill-warn" => "alert-severity alert-severity-warning",
        "dash-alert-pill-info" => "alert-severity alert-severity-info",
        _ => "alert-severity alert-severity-info"
    };

    private string GetTabClass(DashboardSidebarTab tab)
        => _activeSidebarTab == tab ? "is-active" : string.Empty;

    private enum DashboardSidebarTab
    {
        Alerts,
        Controllers,
        QuickActions
    }

    private sealed record AlertPreviewItem(string Title, string Message, int Count, DateTime Timestamp, string SeverityClass);

    private sealed record ControllerSnapshot(int Id, string Name, string StatusText, string StatusClass, bool IsEnabled, DateTime? LastEventUtc);

    private string GetAlertsCardStateClass() => GetCardClass(GetAlertsState());

    private string GetMembershipCardStateClass() => GetCardClass(GetOverdueState());

    private string GetControllersCardStateClass() => GetCardClass(GetControllersState());

    private string GetSystemStatusCardStateClass() => GetCardClass(MergeStates(GetControllersState(), GetBackupState()));

    private static string GetCardClass(MetricState state) => state switch
    {
        MetricState.Critical => "metric-card--critical",
        MetricState.Warning => "metric-card--warning",
        _ => "metric-card--normal"
    };

    private MetricState GetAlertsState()
    {
        var count = Alerts?.Count ?? 0;
        if (count >= DashboardThresholds.AlertsCritical)
        {
            return MetricState.Critical;
        }

        if (count >= DashboardThresholds.AlertsWarning)
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }

    private MetricState GetOverdueState()
    {
        var overdue = _metrics?.PastDueMembers ?? _duesSummary?.UnpaidCount ?? 0;
        if (overdue >= DashboardThresholds.OverdueCritical)
        {
            return MetricState.Critical;
        }

        if (overdue >= DashboardThresholds.OverdueWarning)
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }

    private MetricState GetControllersState()
    {
        if (_isSimulationMode || _controllerSnapshots.Count == 0)
        {
            return MetricState.Normal;
        }

        var offline = _controllerSnapshots.Count(c => c.StatusText.Equals("Offline", StringComparison.OrdinalIgnoreCase));
        var stale = _controllerSnapshots.Count(c => c.StatusText.Equals("Stale", StringComparison.OrdinalIgnoreCase));

        if (offline >= DashboardThresholds.ControllersOfflineCritical)
        {
            return MetricState.Critical;
        }

        if (offline >= DashboardThresholds.ControllersOfflineWarning || stale > 0)
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }

    private MetricState GetBackupState()
    {
        var lastBackup = _backupStatus?.LastBackupUtc;
        if (lastBackup == null)
        {
            return MetricState.Warning;
        }

        var ageDays = (DateTime.UtcNow - lastBackup.Value).TotalDays;
        if (ageDays >= DashboardThresholds.BackupStaleDaysCritical)
        {
            return MetricState.Critical;
        }

        if (ageDays >= DashboardThresholds.BackupStaleDaysWarning)
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }

    private static MetricState MergeStates(params MetricState[] states)
    {
        if (states.Any(s => s == MetricState.Critical))
        {
            return MetricState.Critical;
        }

        if (states.Any(s => s == MetricState.Warning))
        {
            return MetricState.Warning;
        }

        return MetricState.Normal;
    }
    private static string GetRelativeTime(DateTime timestampUtc)
    {
        var diff = DateTime.UtcNow - timestampUtc;
        if (diff.TotalDays >= 1) return $"{(int)diff.TotalDays}d ago";
        if (diff.TotalHours >= 1) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalMinutes >= 1) return $"{(int)diff.TotalMinutes}m ago";
        return "just now";
    }
}

