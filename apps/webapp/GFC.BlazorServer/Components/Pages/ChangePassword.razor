@page "/changepassword"
@using Microsoft.AspNetCore.Authorization
@layout GFC.BlazorServer.Components.Layout.FullPageLayout
@using GFC.BlazorServer.Services
@using GFC.Core.Interfaces
@attribute [Authorize]
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject IUserManagementService UserManagementService
@inject NavigationManager Navigation
@inject ILogger<ChangePassword> Logger
@inject IJSRuntime JSRuntime
@inject IPasswordPolicy PasswordPolicy

<PageTitle>Change Password - GFC Membership</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h1>@(_isSetupMode ? "Setup Your Account" : "Change Credentials")</h1>
            <p class="text-white mb-1">Account: <strong class="text-warning">@_currentUsername</strong></p>
            <p class="text-muted">Choose your preferred sign-in method</p>
        </div>

        <div class="mb-4">
            <ul class="nav nav-pills nav-fill">
                <li class="nav-item">
                    <a class="nav-link @(_mode == SetupMode.Password ? "active" : "")" 
                       href="javascript:void(0)" 
                       @onclick="() => SetMode(SetupMode.Password)">
                        <i class="bi bi-key-fill me-1"></i> Password
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(_mode == SetupMode.PassCode ? "active" : "")" 
                       href="javascript:void(0)" 
                       @onclick="() => SetMode(SetupMode.PassCode)">
                        <i class="bi bi-grid-3x3-gap-fill me-1"></i> Passcode
                    </a>
                </li>
            </ul>
        </div>

        @if (_mode == SetupMode.Password)
        {
            <div class="mb-3">
                <label class="form-label" for="newPassword">New Password</label>
                <input id="newPassword" type="password" class="form-control" @bind="_newPassword" @bind:event="oninput" placeholder="Enter new password" />
            </div>
            <div class="mb-3">
                <label class="form-label" for="confirmPassword">Confirm Password</label>
                <input id="confirmPassword" type="password" class="form-control" @bind="_confirmPassword" @bind:event="oninput" placeholder="Confirm new password" />
            </div>
            <button type="button" 
                    class="btn btn-primary w-100" 
                    disabled="@_isLoading" 
                    @onclick="HandleChangePassword">
                @if (_isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <span>Set Password</span>
                }
            </button>
        }
        else
        {
            <div class="mb-3">
                <label class="form-label" for="passcode">New 6-Digit Passcode</label>
                <div class="d-flex justify-content-center gap-2 mb-3">
                    <input id="passcode" type="password" 
                           class="form-control text-center fs-4 fw-bold" 
                           maxlength="6" 
                           @bind="_passcode" 
                           @bind:event="oninput"
                           placeholder="000000" 
                           style="letter-spacing: 0.5rem;" />
                </div>
                <div class="form-text text-light opacity-75 text-center">
                    This numeric PIN can be used to log in quickly from this device.
                </div>
            </div>
            <button type="button" 
                    class="btn btn-primary w-100" 
                    disabled="@_isLoading" 
                    @onclick="HandleChangePassCode">
                @if (_isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <span>Set Passcode</span>
                }
            </button>
        }
        
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-3" role="alert">
                @_errorMessage
            </div>
        }
        
        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success mt-3" role="alert">
                @_successMessage
            </div>
        }
    </div>
</div>

@code {
    private enum SetupMode { Password, PassCode }
    private SetupMode _mode = SetupMode.Password;
    private string _currentUsername = string.Empty;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string _passcode = string.Empty;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;
    private bool _isLoading = false;
    private bool _isSetupMode = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if user is authenticated and password change is required
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated != true)
            {
                Navigation.NavigateTo("/login?returnUrl=/changepassword");
                return;
            }

            var currentUser = AuthStateProvider.GetCurrentUser();
            _currentUsername = currentUser?.Username ?? "Unknown User";
            
            // Check for setup override param
            var uri = new Uri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            _isSetupMode = !string.IsNullOrEmpty(query["setup"]) || !string.IsNullOrEmpty(query["reason"]);

            if (currentUser == null)
            {
                Navigation.NavigateTo("/login?returnUrl=/changepassword");
                return;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during initialization: {Error}", ex.Message);
        }
    }

    private void SetMode(SetupMode mode)
    {
        _mode = mode;
        _errorMessage = "";
    }

    private async Task HandleChangePassword()
    {
        _errorMessage = string.Empty;
        _successMessage = string.Empty;
        _isLoading = true;
        StateHasChanged();
        
        try
        {
            // Validate inputs
            if (string.IsNullOrWhiteSpace(_newPassword))
            {
                _errorMessage = "Please enter a new password.";
                return;
            }

            if (_newPassword != _confirmPassword)
            {
                _errorMessage = "Passwords do not match.";
                return;
            }

            // Get current user
            var currentUser = AuthStateProvider.GetCurrentUser();
            if (currentUser == null)
            {
                _errorMessage = "User not found. Please log in again.";
                return;
            }

            var policyResult = PasswordPolicy.Validate(currentUser.Username, _newPassword);
            if (!policyResult.IsValid)
            {
                _errorMessage = string.IsNullOrWhiteSpace(policyResult.ErrorMessage)
                    ? PasswordPolicy.RequirementSummary
                    : policyResult.ErrorMessage;
                return;
            }

            // Change password and clear the password change required flag
            await Task.Run(() => UserManagementService.ChangePassword(
                currentUser.UserId,
                _newPassword,
                clearPasswordChangeRequired: true,
                performedByUserId: currentUser.UserId));
            
            _successMessage = "Password set successfully! Redirecting...";
            StateHasChanged();
            
            await Task.Delay(1500);

            if (_isSetupMode)
            {
                // Force re-login with new credentials
                await AuthStateProvider.LogoutAsync();
                Navigation.NavigateTo("/login", true);
            }
            else
            {
                Navigation.NavigateTo("/", true);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing password: {Message}", ex.Message);
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleChangePassCode()
    {
        _errorMessage = string.Empty;
        _successMessage = string.Empty;
        _isLoading = true;
        
        try
        {
            if (string.IsNullOrWhiteSpace(_passcode) || _passcode.Length < 6 || !_passcode.All(char.IsDigit))
            {
                _errorMessage = "Please enter a 6-digit numeric passcode.";
                return;
            }

            var currentUser = AuthStateProvider.GetCurrentUser();
            if (currentUser == null)
            {
                _errorMessage = "User not found.";
                return;
            }

            await Task.Run(() => UserManagementService.ChangePassCode(
                currentUser.UserId,
                _passcode,
                clearPasswordChangeRequired: true,
                performedByUserId: currentUser.UserId));

            _successMessage = "Passcode set successfully! Redirecting...";
            StateHasChanged();

            await Task.Delay(1500);

            if (_isSetupMode)
            {
                // Force re-login with new credentials
                await AuthStateProvider.LogoutAsync();
                Navigation.NavigateTo("/login", true);
            }
            else
            {
                Navigation.NavigateTo("/", true);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error setting passcode: {Message}", ex.Message);
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}

