@page "/changepassword"
@using Microsoft.AspNetCore.Authorization
@using GFC.BlazorServer.Services
@using GFC.Core.Interfaces
@attribute [Authorize]
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject IUserManagementService UserManagementService
@inject NavigationManager Navigation
@inject ILogger<ChangePassword> Logger
@inject IJSRuntime JSRuntime
@inject IPasswordPolicy PasswordPolicy

<PageTitle>Change Password - GFC Membership</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h1>Change Password</h1>
            <p class="text-muted">You must change your password before continuing</p>
        </div>

        <div class="mb-3">
            <label class="form-label" for="newPassword">New Password</label>
            <input id="newPassword" type="password" class="form-control" @bind="_newPassword" @bind:event="oninput" placeholder="Enter new password" />
        </div>
        <div class="mb-3">
            <label class="form-label" for="confirmPassword">Confirm Password</label>
            <input id="confirmPassword" type="password" class="form-control" @bind="_confirmPassword" @bind:event="oninput" placeholder="Confirm new password" />
        </div>
        <button type="button" 
                class="btn btn-primary w-100" 
                disabled="@_isLoading" 
                @onclick="HandleChangePassword">
            @if (_isLoading)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Changing password...</span>
            }
            else
            {
                <span>Change Password</span>
            }
        </button>
        
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-3" role="alert">
                @_errorMessage
            </div>
        }
        
        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success mt-3" role="alert">
                @_successMessage
            </div>
        }
    </div>
</div>

@code {
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if user is authenticated and password change is required
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated != true)
            {
                Navigation.NavigateTo("/login?returnUrl=/changepassword");
                return;
            }

            var currentUser = AuthStateProvider.GetCurrentUser();
            if (currentUser == null || !currentUser.PasswordChangeRequired)
            {
                // Password change not required, redirect to home
                Navigation.NavigateTo("/");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during initialization: {Error}", ex.Message);
        }
    }

    private async Task HandleChangePassword()
    {
        _errorMessage = string.Empty;
        _successMessage = string.Empty;
        _isLoading = true;
        StateHasChanged();
        
        try
        {
            // Validate inputs
            if (string.IsNullOrWhiteSpace(_newPassword))
            {
                _errorMessage = "Please enter a new password.";
                _isLoading = false;
                StateHasChanged();
                return;
            }

            if (_newPassword != _confirmPassword)
            {
                _errorMessage = "Passwords do not match.";
                _isLoading = false;
                StateHasChanged();
                return;
            }

            // Get current user
            var currentUser = AuthStateProvider.GetCurrentUser();
            if (currentUser == null)
            {
                _errorMessage = "User not found. Please log in again.";
                _isLoading = false;
                StateHasChanged();
                return;
            }

            var policyResult = PasswordPolicy.Validate(currentUser.Username, _newPassword);
            if (!policyResult.IsValid)
            {
                _errorMessage = string.IsNullOrWhiteSpace(policyResult.ErrorMessage)
                    ? PasswordPolicy.RequirementSummary
                    : policyResult.ErrorMessage;
                _isLoading = false;
                StateHasChanged();
                return;
            }

            // Change password and clear the password change required flag
            await Task.Run(() => UserManagementService.ChangePassword(
                currentUser.UserId,
                _newPassword,
                clearPasswordChangeRequired: true,
                performedByUserId: currentUser.UserId));
            
            _successMessage = "Password changed successfully. Redirecting...";
            StateHasChanged();
            
            // Wait a moment then redirect
            await Task.Delay(1000);
            await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/';");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing password: {Message}", ex.Message);
            _errorMessage = $"An error occurred while changing password: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}

