// [NEW]
@page "/admin/import"
@using global::System.Collections.Generic
@using global::System.Linq
@using global::System.Threading.Tasks
@using GFC.BlazorServer.Services

@inject IImportService ImportService

<h3>Import External Page</h3>

<div class="alert alert-danger" role="alert">
    <h4 class="alert-heading">Beta Feature - Important Limitations</h4>
    <p>
        This URL importer is a best-effort tool and is currently in beta. It is designed for simple, static HTML websites.
    </p>
    <hr>
    <p class="mb-0">
        <strong>It will not work correctly for most modern websites</strong> that are built with JavaScript frameworks (e.g., React, Angular, Vue). The import may be incomplete or fail entirely for such sites.
    </p>
</div>

<div class="card">
    <div class="card-body">
        <div class="mb-3">
            <label for="urlInput" class="form-label">URL to Import</label>
            <input type="url" class="form-control" id="urlInput" @bind="_importUrl" placeholder="https://example.com/page-to-import">
        </div>
        <button class="btn btn-primary" @onclick="HandleImport" disabled="@_isLoading || string.IsNullOrWhiteSpace(_importUrl)">
            @if (_isLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span>Importing...</span>
            }
            else
            {
                <span>Import</span>
            }
        </button>
    </div>
</div>

@if (_logs.Any())
{
    <div class="card mt-4">
        <div class="card-header">
            Import Log
        </div>
        <ul class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
            @foreach (var log in _logs)
            {
                <li class="list-group-item">@log</li>
            }
        </ul>
    </div>
}


@code {
    private string _importUrl;
    private bool _isLoading;
    private readonly List<string> _logs = new();

    private async Task HandleImport()
    {
        _isLoading = true;
        _logs.Clear();
        StateHasChanged();

        try
        {
            await ImportService.ImportPageFromUrlAsync(_importUrl, Log);
            Log("Import process finished.");
        }
        catch (Exception ex)
        {
            Log($"An unexpected error occurred: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void Log(string message)
    {
        _logs.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
        InvokeAsync(StateHasChanged);
    }
}
