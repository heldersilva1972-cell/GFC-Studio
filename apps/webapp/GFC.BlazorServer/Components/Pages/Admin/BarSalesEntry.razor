@page "/admin/bar-sales"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using GFC.BlazorServer.Data
@using GFC.Core.Models
@inject IDbContextFactory<GfcDbContext> DbFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS
@attribute [Authorize]

<PageTitle>Bar Sales Entry | GFC Admin</PageTitle>

<style>
    /* Hide number input spinners */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type="number"] {
        -moz-appearance: textfield;
    }

    .bar-sales-page {
        min-height: 100vh;
        background: radial-gradient(circle at top right, #f8fafc, #ebf8ff);
        padding-bottom: 5rem;
    }

    .bar-sales-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .hero-section {
        background: linear-gradient(135deg, #1A365D 0%, #2B6CB0 100%);
        border-radius: 24px;
        padding: 2.5rem 2rem;
        color: white;
        margin-bottom: -2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(26, 54, 93, 0.2);
        z-index: 1;
    }

    .main-form-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 30px;
        padding: 3rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        margin-bottom: 4rem;
        z-index: 2;
        position: relative;
    }

    .analytics-card {
        background: white;
        border-radius: 30px;
        padding: 2rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
        margin-bottom: 3rem;
    }

    .chart-container {
        height: 350px;
        position: relative;
    }

    .total-revenue-summary {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        border: 1px solid #f1f5f9;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        border-left: 5px solid #2ecc71;
    }

    .summary-val {
        font-size: 2.25rem;
        font-weight: 800;
        color: #2ecc71;
    }

    .view-toggle {
        background: #f1f5f9;
        padding: 0.4rem;
        border-radius: 14px;
        display: inline-flex;
        gap: 0.25rem;
        align-items: center;
    }

    .view-toggle button {
        border: none;
        padding: 0.5rem 1.25rem;
        border-radius: 10px;
        font-weight: 700;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        background: transparent;
        color: #64748b;
    }

    .view-toggle button.active {
        background: white;
        color: #3b82f6;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .chart-controls-panel {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
    }

    .chart-select {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }

    .chart-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .form-label-premium {
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #64748b;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .input-premium {
        background: #f8fafc;
        border: 2px solid #f1f5f9;
        border-radius: 16px;
        padding: 1rem 1.25rem;
        font-size: 1.1rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .entry-row {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #f1f5f9;
    }
</style>

<div class="bar-sales-page">
    <div class="bar-sales-container">
        <div class="hero-section text-center">
            <div class="mb-4">
                <span class="badge bg-white bg-opacity-20 text-white px-3 py-2 rounded-pill mb-3">Club Operations</span>
                <h1 class="display-4 fw-bold mb-2">Bar Revenue Analytics</h1>
                <p class="lead opacity-80 mb-0">Unified dashboard for financial tracking and inventory movement.</p>
            </div>
        </div>

        <!-- CHART SECTION -->
        <div class="analytics-card" style="margin-top: 4rem;">
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-end mb-4 flex-wrap gap-3">
                    <div>
                        <h3 class="fw-bold mb-1">Financial Performance</h3>
                        <p class="text-muted small mb-0">Revenue trends and analysis</p>
                    </div>
                    
                    <div class="d-flex gap-4 align-items-center bg-light rounded-4 px-4 py-2 border">
                        <div>
                            <div class="small fw-bold text-muted text-uppercase" style="font-size: 0.7rem;">Lifetime Revenue</div>
                            <div class="h3 fw-bold text-success mb-0">@_grandTotalRevenue.ToString("C")</div>
                        </div>
                        <div class="vr opacity-25"></div>
                        <div>
                            <div class="small fw-bold text-muted text-uppercase" style="font-size: 0.7rem;">Items Sold</div>
                            <div class="h3 fw-bold text-dark mb-0">@_grandTotalItemsSold.ToString("N0")</div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Controls -->
                <div class="chart-controls-panel">
                    <div class="row g-3">
                        <!-- Row 1: Main Filters -->
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted mb-2">TIME PERIOD</label>
                            <select class="form-select chart-select" @bind="_selectedPeriod" @bind:after="UpdateChart">
                                <option value="year">Full Year Comparison</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted mb-2">GROUP BY</label>
                            <select class="form-select chart-select" @bind="_groupBy" @bind:after="UpdateChart">
                                <option value="day">Daily</option>
                                <option value="week">Weekly</option>
                                <option value="month">Monthly</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="small fw-bold text-muted mb-2">FILTER DAYS</label>
                            <select class="form-select chart-select" @bind="_chartDayFilter" @bind:after="UpdateChart">
                                <option value="">All Days</option>
                                <option value="Sunday">Sundays</option>
                                <option value="Monday">Mondays</option>
                                <option value="Tuesday">Tuesdays</option>
                                <option value="Wednesday">Wednesdays</option>
                                <option value="Thursday">Thursdays</option>
                                <option value="Friday">Fridays</option>
                                <option value="Saturday">Saturdays</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted mb-2">FILTER SHIFT</label>
                            <select class="form-select chart-select" @bind="_chartShiftFilter" @bind:after="UpdateChart">
                                <option value="">All Shifts</option>
                                <option value="Day">Day Shift</option>
                                <option value="Night">Night Shift</option>
                            </select>
                        </div>

                        @if (_selectedPeriod == "custom")
                        {
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted mb-2">START DATE</label>
                                <input type="date" class="form-control chart-select" @bind="_customStartDate" @bind:after="UpdateChart" />
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted mb-2">END DATE</label>
                                <input type="date" class="form-control chart-select" @bind="_customEndDate" @bind:after="UpdateChart" />
                            </div>
                        }
                    </div>

                    <!-- Row 2: Year Selection (Visible for Full Year View) -->
                    @if (_selectedPeriod == "year")
                    {
                        <div class="mt-3 pt-3 border-top">
                            <label class="small fw-bold text-muted mb-2 d-block">COMPARE YEARS</label>
                            <div class="d-flex flex-wrap gap-3">
                                @foreach (var year in _availableYears)
                                {
                                    <label class="year-checkbox-label">
                                        <input type="checkbox" checked="@(_selectedComparisonYears.Contains(year))" 
                                               @onchange="@(e => ToggleYearComparison(year, (bool)e.Value))" />
                                        <span>@year</span>
                                    </label>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="barSalesChart"></canvas>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show mb-4 border-0 shadow-sm rounded-4" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> @_successMessage
                <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
            </div>
        }

        <div class="row g-4">
            <!-- ENTRY FORM AND LOG CONTROLS -->
            <div class="col-12">
                @if (!_showEntryForm)
                {
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-primary rounded-pill px-4 shadow-sm" @onclick="() => _showEntryForm = true">
                            <i class="bi bi-plus-lg me-2"></i>New Entry
                        </button>
                    </div>
                }
                else
                {
                    <div class="main-form-card mb-4 slide-in-down">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3 class="fw-bold mb-0">New Entry</h3>
                            <button class="btn btn-outline-secondary rounded-circle btn-sm" @onclick="() => _showEntryForm = false">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        
                        <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                            <DataAnnotationsValidator />
                            
                            <div class="row g-4">
                                <div class="col-md-3">
                                    <label class="form-label-premium">Month</label>
                                    <select class="form-control input-premium w-100" @bind="_selectedMonth">
                                        @for (int i = 1; i <= 12; i++)
                                        {
                                            <option value="@i">@(new DateTime(2000, i, 1).ToString("MMMM"))</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-premium">Day</label>
                                    <select class="form-control input-premium w-100" @bind="_selectedDay">
                                        @for (int i = 1; i <= DateTime.DaysInMonth(_selectedEntryYear, _selectedMonth); i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-premium">Year</label>
                                    <select class="form-control input-premium w-100" @bind="_selectedEntryYear">
                                        @for (int i = DateTime.Now.Year; i >= DateTime.Now.Year - 5; i--)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-premium">Hour</label>
                                    <select class="form-control input-premium w-100" @bind="_selectedHour">
                                        @for (int i = 0; i <= 23; i++)
                                        {
                                            <option value="@i">@i.ToString("D2")</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-premium">Minute</label>
                                    <select class="form-control input-premium w-100" @bind="_selectedMinute">
                                        @for (int i = 0; i <= 59; i++)
                                        {
                                            <option value="@i">@i.ToString("D2")</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label-premium text-success">Gross Revenue</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0" style="border-radius: 16px 0 0 16px;">$</span>
                                        <InputNumber class="form-control input-premium" style="border-radius: 0 16px 16px 0;" @bind-Value="_model.TotalSales" onfocus="this.select()" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label-premium text-warning">Items Sold</label>
                                    <InputNumber class="form-control input-premium w-100" @bind-Value="_model.TotalItemsSold" onfocus="this.select()" />
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label-premium text-info">Notes</label>
                                    <InputText class="form-control input-premium w-100" @bind-Value="_model.Notes" placeholder="Context (e.g. Member Event)..." />
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label-premium">Shift Type</label>
                                    <div class="d-flex gap-4 p-3 rounded-3" style="background: #f8fafc; border: 2px solid #f1f5f9;">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="shiftType" id="shiftDay" value="Day" 
                                                checked="@(_model.Shift == "Day")" 
                                                @onchange="@(() => _model.Shift = "Day")">
                                            <label class="form-check-label fw-bold" for="shiftDay">
                                                <i class="bi bi-sun-fill text-warning me-2"></i>Day Shift
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="shiftType" id="shiftNight" value="Night" 
                                                checked="@(_model.Shift == "Night")" 
                                                @onchange="@(() => _model.Shift = "Night")">
                                            <label class="form-check-label fw-bold" for="shiftNight">
                                                <i class="bi bi-moon-stars-fill text-info me-2"></i>Night Shift
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-5 text-end d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-light px-4" @onclick="() => _showEntryForm = false">Cancel</button>
                                <button type="submit" class="btn btn-lg px-5 save-btn @GetButtonClass()" disabled="@_isSaving">
                                    <span class="shockwave"></span>
                                    @if (_isSaving)
                                    {
                                        <i class="bi bi-arrow-repeat me-2"></i>
                                        <span>Processing...</span>
                                    }
                                    else if (_showSuccess)
                                    {
                                        <i class="bi bi-check-all me-2"></i>
                                        <span>Recorded!</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-plus-circle-fill me-2"></i>
                                        <span>Commit Entry</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    </div>
                }
            </div>

            <!-- ACTIVITY LOG TABLE (Full Width) -->
            <div class="col-12">
                <div class="bg-white rounded-5 border shadow-sm h-100 overflow-hidden d-flex flex-column">
                    <div class="p-4 border-bottom bg-light bg-opacity-50">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h4 class="fw-bold mb-1">Activity Log</h4>
                                <div class="text-muted small">Recent transactions</div>
                            </div>
                            <button class="btn btn-sm btn-light border rounded-pill px-3" @onclick="LoadData">
                                <i class="bi bi-arrow-clockwise me-1"></i> Sync
                            </button>
                        </div>
                        
                        <!-- Day Filter -->
                        <select class="form-select form-select-sm border-0 bg-white shadow-sm rounded-pill" 
                                @bind="_selectedDayFilter" @bind:after="LoadData">
                            <option value="">All Days</option>
                            <option value="Sunday">Sundays</option>
                            <option value="Monday">Mondays</option>
                            <option value="Tuesday">Tuesdays</option>
                            <option value="Wednesday">Wednesdays</option>
                            <option value="Thursday">Thursdays</option>
                            <option value="Friday">Fridays</option>
                            <option value="Saturday">Saturdays</option>
                        </select>
                    </div>
                    
                    <div class="flex-grow-1 overflow-auto">
                        @if (_entries == null)
                        {
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        }
                        else if (!_entries.Any())
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-journal-x fs-1 text-muted opacity-50"></i>
                                <p class="mt-3 text-muted">No sales recordings yet.</p>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light sticky-top">
                                        <tr>
                                            <th class="ps-4 py-3 text-uppercase text-muted small fw-bold border-0">Date</th>
                                            <th class="py-3 text-uppercase text-muted small fw-bold border-0">Details</th>
                                            <th class="pe-4 py-3 text-end text-uppercase text-muted small fw-bold border-0">Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var entry in _entries)
                                        {
                                            <tr>
                                                <td class="ps-4 border-bottom-0">
                                                    <div class="fw-bold text-dark">@entry.SaleDate.ToString("ddd, MMM dd")</div>
                                                    <div class="small text-muted">@entry.SaleDate.ToString("hh:mm tt")</div>
                                                </td>
                                                <td class="border-bottom-0">
                                                    <div class="text-dark">
                                                        @(string.IsNullOrEmpty(entry.Notes) ? "Standard Sale" : entry.Notes)
                                                        <span class="badge rounded-pill bg-light text-dark border ms-2" style="font-weight: 500;">
                                                            <i class="bi @(entry.Shift == "Night" ? "bi-moon-stars-fill text-info" : "bi-sun-fill text-warning") me-1"></i>
                                                            @entry.Shift
                                                        </span>
                                                    </div>
                                                    <div class="small text-muted">@entry.TotalItemsSold items</div>
                                                </td>
                                                <td class="pe-4 text-end border-bottom-0">
                                                    <span class="fw-bold text-success bg-success bg-opacity-10 px-2 py-1 rounded">
                                                        @entry.TotalSales.ToString("C")
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>

                    <!-- Pagination -->
                    @if (_totalPages > 1)
                    {
                        <div class="p-3 border-top bg-light bg-opacity-50 d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" 
                                    disabled="@(_currentPage == 1)" 
                                    @onclick="PrevPage">
                                Previous
                            </button>
                            <span class="text-muted small fw-bold">Page @_currentPage of @_totalPages</span>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" 
                                    disabled="@(_currentPage == _totalPages)" 
                                    @onclick="NextPage">
                                Next
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private BarSaleEntry _model = new();
    private List<BarSaleEntry> _entries;
    private bool _isSaving = false;
    private bool _showSuccess = false;
    private bool _showEntryForm = false;
    private string _successMessage;

    // Pagination & Filters
    private int _currentPage = 1;
    private int _pageSize = 10;
    private int _totalEntries = 0;
    private string _selectedDayFilter = ""; // Empty = All
    private int _totalPages => (int)Math.Ceiling((double)_totalEntries / _pageSize);

    // Persistent date components
    private int _selectedMonth = DateTime.Now.Month;
    private int _selectedDay = DateTime.Now.Day;
    private int _selectedEntryYear = DateTime.Now.Year;
    
    // Time components (24-hour format for entry)
    private int _selectedHour = DateTime.Now.Hour;
    private int _selectedMinute = DateTime.Now.Minute;

    private decimal _grandTotalRevenue = 0;
    private int _grandTotalItemsSold = 0;

    private List<int> _availableYears = new();
    private List<int> _selectedComparisonYears = new();

    // Chart controls
    private string _selectedPeriod = "year";
    private string _groupBy = "month";
    private string _chartDayFilter = ""; // Empty = All Days
    private string _chartShiftFilter = ""; // Empty = All Shifts
    private DateTime _customStartDate = DateTime.Now.AddDays(-30);
    private DateTime _customEndDate = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UpdateChart();
        }
    }

    private async Task NextPage()
    {
        if (_currentPage < _totalPages)
        {
            _currentPage++;
            await LoadData();
        }
    }

    private async Task PrevPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        
        // Base Query
        var query = db.BarSaleEntries.AsQueryable();

        // Apply Day Filter (Client-Side evaluation for DayOfWeek often safer/easier if small dataset, 
        // but for pagination we want Server-Side. 
        // NOTE: EF Core can translate DateTime.DayOfWeek usually. Let's try.)
        if (!string.IsNullOrEmpty(_selectedDayFilter))
        {
            var targetDay = (DayOfWeek)Enum.Parse(typeof(DayOfWeek), _selectedDayFilter);
            // EF Core SQL translation for DayOfWeek
            query = query.Where(e => e.SaleDate.DayOfWeek == targetDay);
        }

        // Load Pagination Stats
        _totalEntries = await query.CountAsync();
        
        // Load Page Data
        _entries = await query
            .OrderByDescending(e => e.SaleDate)
            .Skip((_currentPage - 1) * _pageSize)
            .Take(_pageSize)
            .ToListAsync();

        _grandTotalRevenue = await db.BarSaleEntries.SumAsync(e => e.TotalSales);
        _grandTotalItemsSold = await db.BarSaleEntries.SumAsync(e => e.TotalItemsSold);

        // Load available years
        _availableYears = await db.BarSaleEntries
            .Select(e => e.SaleDate.Year)
            .Distinct()
            .OrderByDescending(y => y)
            .ToListAsync();

        if (!_availableYears.Any())
        {
            _availableYears.Add(DateTime.Now.Year);
        }
        
        // Default to selecting all available years for comparison initially, ONLY if list is empty (first load)
        if (!_selectedComparisonYears.Any())
        {
            _selectedComparisonYears = new List<int>(_availableYears);
        }
    }

    private async Task ToggleYearComparison(int year, bool isChecked)
    {
        if (isChecked && !_selectedComparisonYears.Contains(year))
        {
            _selectedComparisonYears.Add(year);
        }
        else if (!isChecked && _selectedComparisonYears.Contains(year))
        {
            _selectedComparisonYears.Remove(year);
        }
        
        // Prevent empty selection
        if (!_selectedComparisonYears.Any() && _availableYears.Any())
        {
            _selectedComparisonYears.Add(year); // Keep the last one unchecked
        }

        await UpdateChart();
    }

    private async Task UpdateChart()
    {
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var now = DateTime.Now;
            
            // 1. Fetch ALL data first (Robustness)
            var allData = await db.BarSaleEntries.ToListAsync();

            // 2. Apply Day Filter if selected
            if (!string.IsNullOrEmpty(_chartDayFilter))
            {
                var targetDay = (DayOfWeek)Enum.Parse(typeof(DayOfWeek), _chartDayFilter);
                if (allData.Any()) // Only filter if we have data
                {
                    allData = allData.Where(e => e.SaleDate.DayOfWeek == targetDay).ToList();
                }
            }

            // 3. Apply Shift Filter if selected
            if (!string.IsNullOrEmpty(_chartShiftFilter))
            {
                 allData = allData.Where(e => e.Shift == _chartShiftFilter).ToList();
            }
            
            List<string> labels = new();
            var datasets = new List<object>();

            // LOGIC A: Full Year Comparison View
            if (_selectedPeriod == "year")
            {
                // Setup Month Labels
                for (int i = 1; i <= 12; i++)
                {
                    labels.Add(new DateTime(2000, i, 1).ToString("MMM"));
                }

                // Create a dataset for EACH selected year
                foreach (var year in _selectedComparisonYears.OrderByDescending(y => y))
                {
                    var yearValues = new List<decimal>();
                    for (int month = 1; month <= 12; month++)
                    {
                        var total = allData
                            .Where(e => e.SaleDate.Year == year && e.SaleDate.Month == month)
                            .Sum(e => e.TotalSales);
                        yearValues.Add(total);
                    }
                    datasets.Add(new { label = year.ToString(), data = yearValues });
                }
            }
            // LOGIC B: Standard Time Periods (Single Series usually, unless we add comparison later)
            else
            {
                // Define Date Range
                DateTime startDate = now, endDate = now;
                if (_selectedPeriod == "week") { startDate = now.AddDays(-6).Date; endDate = now.Date; }
                else if (_selectedPeriod == "month") { startDate = now.AddDays(-29).Date; endDate = now.Date; }
                else if (_selectedPeriod == "thisMonth") { startDate = new DateTime(now.Year, now.Month, 1); endDate = now.Date; }
                else if (_selectedPeriod == "lastMonth") { 
                    var last = now.AddMonths(-1); 
                    startDate = new DateTime(last.Year, last.Month, 1); 
                    endDate = new DateTime(last.Year, last.Month, DateTime.DaysInMonth(last.Year, last.Month)); 
                }
                else if (_selectedPeriod == "custom") { startDate = _customStartDate.Date; endDate = _customEndDate.Date; }

                // Generate Labels and Data based on Grouping
                var periodData = allData.Where(e => e.SaleDate.Date >= startDate && e.SaleDate.Date <= endDate).ToList();
                var periodValues = new List<decimal>();

                if (_groupBy == "day")
                {
                    var days = (endDate - startDate).Days;
                    for (int i = 0; i <= days; i++)
                    {
                        var d = startDate.AddDays(i);
                        labels.Add(d.ToString("MMM d"));
                        periodValues.Add(periodData.Where(e => e.SaleDate.Date == d).Sum(e => e.TotalSales));
                    }
                }
                else if (_groupBy == "week")
                {
                    // Simple weekly grouping for range
                    // Note: This matches the "range" logic, not aligned to calendar weeks for simplicity
                     var current = startDate;
                     while(current <= endDate) {
                         var next = current.AddDays(6);
                         if(next > endDate) next = endDate;
                         labels.Add($"{current:MMM d}-{next:dd}");
                         periodValues.Add(periodData.Where(e => e.SaleDate.Date >= current && e.SaleDate.Date <= next).Sum(e => e.TotalSales));
                         current = next.AddDays(1);
                     }
                }
                else if (_groupBy == "month")
                {
                    var current = new DateTime(startDate.Year, startDate.Month, 1);
                    var endMonth = new DateTime(endDate.Year, endDate.Month, 1);
                    while(current <= endMonth)
                    {
                         labels.Add(current.ToString("MMM yyyy"));
                         periodValues.Add(periodData.Where(e => e.SaleDate.Year == current.Year && e.SaleDate.Month == current.Month).Sum(e => e.TotalSales));
                         current = current.AddMonths(1);
                    }
                }

                datasets.Add(new { label = "Revenue", data = periodValues });
            }
            
            await JS.InvokeVoidAsync("barSalesCharts.renderChart", "barSalesChart", new { labels, datasets });
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "UpdateChart Error:", ex.Message);
        }
    }

    private async Task HandleSubmit()
    {
        _isSaving = true;
        _showSuccess = false;
        StateHasChanged();

        try
        {
            // Validate and adjust day if needed (e.g., if month changed to one with fewer days)
            int maxDays = DateTime.DaysInMonth(_selectedEntryYear, _selectedMonth);
            if (_selectedDay > maxDays)
            {
                _selectedDay = maxDays;
            }

            // Construct date from persistent components (hour is in 24hr format)
            _model.SaleDate = new DateTime(
                _selectedEntryYear, 
                _selectedMonth, 
                _selectedDay, 
                _selectedHour,
                _selectedMinute, 
                0);

            await Task.Delay(1000);

            using var db = await DbFactory.CreateDbContextAsync();
            _model.CreatedAt = DateTime.UtcNow;
            db.BarSaleEntries.Add(_model);
            await db.SaveChangesAsync();

            _isSaving = false;
            _showSuccess = true;
            _successMessage = $"Recorded: {_model.TotalSales:C} at {_model.SaleDate:hh:mm tt}";
            
            // Reset form but keep month and year selections
            _model = new BarSaleEntry();
            _selectedDay = DateTime.Now.Day;
            _selectedHour = DateTime.Now.Hour;
            _selectedMinute = DateTime.Now.Minute;
            // Note: _selectedMonth and _selectedEntryYear persist
            
            await LoadData();
            await UpdateChart();
            StateHasChanged();

            await Task.Delay(3000);
            await Task.Delay(3000);
            _showSuccess = false;
            _showEntryForm = false; // Close form on success
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private string GetButtonClass()
    {
        if (_isSaving) return "is-saving btn-success";
        if (_showSuccess) return "is-success btn-success";
        return "btn-primary";
    }
}
