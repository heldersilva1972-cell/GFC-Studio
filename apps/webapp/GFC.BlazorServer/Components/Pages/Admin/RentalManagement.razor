// [NEW]
@page "/admin/rental-management"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "RequireAdmin")]
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject IRentalService RentalService
@inject ToastService ToastService
@inject IJSRuntime JSRuntime
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Hall Rental Management</h3>
    <div>
        <small class="text-muted me-3">Last updated: @lastUpdated.ToString("h:mm:ss tt")</small>
        <button class="btn btn-sm btn-primary" @onclick="RefreshData">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Filters
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label for="statusFilter">Status</label>
                <InputSelect id="statusFilter" class="form-control" @bind-Value="selectedStatus">
                    <option value="">All</option>
                    <option value="@RentalStatus.Pending">Pending</option>
                    <option value="@RentalStatus.Approved">Approved</option>
                    <option value="@RentalStatus.Denied">Denied</option>
                </InputSelect>
            </div>
            <div class="col-md-4">
                <label for="startDate">Start Date</label>
                <InputDate id="startDate" class="form-control" @bind-Value="startDate" />
            </div>
            <div class="col-md-4">
                <label for="endDate">End Date</label>
                <InputDate id="endDate" class="form-control" @bind-Value="endDate" />
            </div>
        </div>
        <button class="btn btn-primary mt-2" @onclick="ApplyFilters">Apply</button>
        <button class="btn btn-secondary mt-2" @onclick="ClearFilters">Clear</button>
    </div>
</div>

@if (_isLoading)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped mt-4">
        <thead>
            <tr>
                <th>Applicant</th>
                <th>Requested Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var request in filteredRequests)
            {
                <tr>
                    <td>@request.ApplicantName</td>
                    <td>@request.RequestedDate.ToShortDateString()</td>
                    <td><span class="badge @GetStatusBadgeClass(request.Status)">@request.Status</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" @onclick="() => ViewRequestDetails(request)">Details</button>
                        @if (request.Status == RentalStatus.Pending)
                        {
                            <button class="btn btn-sm btn-success" @onclick="() => ApproveRequest(request)">Approve</button>
                            <button class="btn btn-sm btn-danger" @onclick="() => DenyRequest(request)">Deny</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}


@if (selectedRequest != null)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rental Request Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Applicant:</strong> @selectedRequest.ApplicantName</p>
                    <p><strong>Date:</strong> @selectedRequest.RequestedDate.ToShortDateString()</p>
                    <p><strong>Status:</strong> <span class="badge @GetStatusBadgeClass(selectedRequest.Status)">@selectedRequest.Status</span></p>
                    
                    <hr />
                    <h6 class="text-muted">Audit Trail</h6>
                    <p><strong>Created:</strong> @selectedRequest.CreatedDate.ToLocalTime().ToString("g")</p>
                    
                    @if (selectedRequest.ApprovedBy != null)
                    {
                        <p><strong>Approved By:</strong> @selectedRequest.ApprovedBy on @selectedRequest.ApprovalDate?.ToLocalTime().ToString("g")</p>
                    }
                    
                    @if (selectedRequest.DeniedBy != null)
                    {
                        <p><strong>Denied By:</strong> @selectedRequest.DeniedBy on @selectedRequest.DenialDate?.ToLocalTime().ToString("g")</p>
                    }
                    
                    @if (selectedRequest.StatusChangedBy != null)
                    {
                        <p><strong>Last Status Change:</strong> @selectedRequest.StatusChangedBy on @selectedRequest.StatusChangedDate?.ToLocalTime().ToString("g")</p>
                    }
                    
                    <hr />
                    <div class="mb-3">
                        <label for="internalNotes" class="form-label">Internal Notes</label>
                        <textarea id="internalNotes" class="form-control" rows="3" @bind="selectedRequest.InternalNotes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <button class="btn btn-secondary" @onclick="() => ChangeMonth(-1)">‹</button>
        <h5 class="mb-0">@currentMonth.ToString("MMMM yyyy")</h5>
        <button class="btn btn-secondary" @onclick="() => ChangeMonth(1)">›</button>
    </div>
    <div class="card-body">
        <div class="d-grid" style="grid-template-columns: repeat(7, 1fr);">
            @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
            {
                <div class="text-center fw-bold p-2">@day</div>
            }
            @for (int i = 0; i < firstDayOfMonthOffset; i++)
            {
                <div class="border p-2"></div>
            }
            @for (int day = 1; day <= daysInMonth; day++)
            {
                var currentDate = new DateTime(currentMonth.Year, currentMonth.Month, day);
                var isBooked = approvedRentals.Any(r => r.RequestedDate.Date == currentDate.Date);
                <div class="border p-2 text-center calendar-day @(isBooked ? "booked" : "")">
                    @day
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool _isLoading = true;
    private List<HallRentalRequest> allRequests = new();
    private List<HallRentalRequest> filteredRequests = new();
    private HallRentalRequest selectedRequest;
    private List<HallRentalRequest> approvedRentals = new();

    private DateTime currentMonth = DateTime.Today;
    private int firstDayOfMonthOffset = 0;
    private int daysInMonth = 0;

    private string selectedStatus = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private DateTime lastUpdated = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        await LoadRequests();
        await LoadApprovedRentals();
        RenderCalendar();
    }

    private async Task RefreshData()
    {
        await LoadRequests();
        await LoadApprovedRentals();
        lastUpdated = DateTime.Now;
        StateHasChanged();
    }

    private async Task LoadRequests()
    {
        _isLoading = true;
        allRequests = (await RentalService.GetRentalRequestsAsync()).ToList();
        ApplyFilters();
        _isLoading = false;
        StateHasChanged();
    }

    private async Task LoadApprovedRentals()
    {
        approvedRentals = (await RentalService.GetApprovedRentalsAsync()).ToList();
    }

    private void RenderCalendar()
    {
        daysInMonth = DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month);
        var firstDayOfMonth = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        firstDayOfMonthOffset = (int)firstDayOfMonth.DayOfWeek;
    }

    private void ChangeMonth(int direction)
    {
        currentMonth = currentMonth.AddMonths(direction);
        RenderCalendar();
        StateHasChanged();
    }

    private void ApplyFilters()
    {
        filteredRequests = allRequests;

        if (!string.IsNullOrEmpty(selectedStatus))
        {
            filteredRequests = filteredRequests.Where(r => r.Status == selectedStatus).ToList();
        }

        if (startDate.HasValue)
        {
            filteredRequests = filteredRequests.Where(r => r.RequestedDate.Date >= startDate.Value.Date).ToList();
        }

        if (endDate.HasValue)
        {
            filteredRequests = filteredRequests.Where(r => r.RequestedDate.Date <= endDate.Value.Date).ToList();
        }
        StateHasChanged();
    }

    private async Task ClearFilters()
    {
        selectedStatus = "";
        startDate = null;
        endDate = null;
        await LoadRequests();
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        RentalStatus.Approved => "bg-success",
        RentalStatus.Denied => "bg-danger",
        RentalStatus.Pending => "bg-warning",
        _ => "bg-secondary"
    };

    private void ViewRequestDetails(HallRentalRequest request)
    {
        selectedRequest = request;
        StateHasChanged();
    }

    private void CloseDetailsModal()
    {
        selectedRequest = null;
        StateHasChanged();
    }

    private async Task SaveChanges()
    {
        if (selectedRequest != null)
        {
            await RentalService.UpdateRentalRequestAsync(selectedRequest);
            CloseDetailsModal();
            await LoadRequests();
        }
    }

    private async Task ApproveRequest(HallRentalRequest request)
    {
        try
        {
            var currentUser = HttpContextAccessor.HttpContext?.User?.Identity?.Name ?? "Admin";
            var success = await RentalService.ApproveRentalRequestAsync(request.Id, "Approved via admin panel.", currentUser);
            if (success)
            {
                await ToastService.ShowToastAsync($"Request for {request.ApplicantName} approved.", ToastLevel.Success);
                await LoadApprovedRentals(); // Refresh calendar
            }
            else
            {
                await ToastService.ShowToastAsync("Failed to approve request. The date is already booked.", ToastLevel.Error);
            }
            await LoadRequests();
        }
        catch (Exception ex)
        {
            await ToastService.ShowToastAsync($"Error approving request: {ex.Message}", ToastLevel.Error);
            Console.WriteLine($"Approval error: {ex}");
        }
    }

    private async Task DenyRequest(HallRentalRequest request)
    {
        try
        {
            var currentUser = HttpContextAccessor.HttpContext?.User?.Identity?.Name ?? "Admin";
            await RentalService.DenyRentalRequestAsync(request.Id, "Denied via admin panel.", currentUser);
            await ToastService.ShowToastAsync($"Request for {request.ApplicantName} denied.", ToastLevel.Info);
            await LoadApprovedRentals(); // Refresh calendar
            await LoadRequests();
        }
        catch (Exception ex)
        {
            await ToastService.ShowToastAsync($"Error denying request: {ex.Message}", ToastLevel.Error);
            Console.WriteLine($"Denial error: {ex}");
        }
    }
}
