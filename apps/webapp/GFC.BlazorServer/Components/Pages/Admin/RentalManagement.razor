// [NEW]
@page "/admin/rental-management"
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Components.Shared
@inject IRentalService RentalService

<h3>Hall Rental Management <span class="badge bg-info gfc-new-tag">[NEW]</span></h3>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}

@if (_rentalRequests == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Requester Name</th>
                <th>Requested Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var request in _rentalRequests)
            {
                <tr>
                    <td>@request.RequesterName</td>
                    <td>@request.RequestedDate.ToShortDateString()</td>
                    <td>@request.Status</td>
                    <td>
                        <button class="btn btn-primary btn-sm" @onclick="() => ShowDetailsModal(request)">Details</button>
                        <button class="btn btn-success btn-sm" @onclick="() => UpdateRequestStatus(request, RentalStatus.Approved)">Approve</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => UpdateRequestStatus(request, RentalStatus.Denied)">Deny</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<RentalRequestDetailsModal @ref="_detailsModal" Request="_selectedRequest" OnClose="@(() => { _selectedRequest = null; StateHasChanged(); })" />

@code {
    private IEnumerable<HallRentalRequest> _rentalRequests;
    private RentalRequestDetailsModal _detailsModal;
    private HallRentalRequest _selectedRequest;
    private string _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        _rentalRequests = await RentalService.GetRentalRequestsAsync();
    }

    private void ShowDetailsModal(HallRentalRequest request)
    {
        _selectedRequest = request;
        _detailsModal.Show();
    }

    private async Task UpdateRequestStatus(HallRentalRequest request, string status)
    {
        _errorMessage = null;
        var originalStatus = request.Status;
        request.Status = status;

        var success = await RentalService.UpdateRentalRequestAsync(request);

        if (success)
        {
            if (status == RentalStatus.Approved)
            {
                await RentalService.UpdateCalendarAvailabilityAsync(request.RequestedDate, "Booked");
            }
            else if (originalStatus == RentalStatus.Approved && status == RentalStatus.Denied) // If an approved request is now denied
            {
                // Check if any OTHER request for that date is still approved.
                var otherApprovedRequests = _rentalRequests.Any(r => r.Id != request.Id
                                                                 && r.RequestedDate.Date == request.RequestedDate.Date
                                                                 && r.Status == RentalStatus.Approved);
                if (!otherApprovedRequests)
                {
                    // Only free up the slot if no other approved requests exist for that day.
                    await RentalService.UpdateCalendarAvailabilityAsync(request.RequestedDate, "Available");
                }
            }
        }
        else
        {
            // Revert the status on the UI and show an error
            request.Status = originalStatus;
            _errorMessage = $"Could not approve the request for {request.RequesterName} on {request.RequestedDate.ToShortDateString()} because the date is already booked.";
        }

        StateHasChanged();
    }
}
