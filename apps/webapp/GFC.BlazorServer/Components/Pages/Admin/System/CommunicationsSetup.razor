@page "/admin/system/communications"
@using GFC.Core.Interfaces
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Data.Entities
@using Microsoft.AspNetCore.Authorization
@inject IBlazorSystemSettingsService SystemSettingsService
@inject ILogger<CommunicationsSetup> Logger
@attribute [Authorize]

<PageTitle>Communications Setup - GFC</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-envelope-at-fill text-primary"></i> Text & Email Setup</h2>
            <p class="text-muted mb-0">Configure and toggle outbound communication channels.</p>
        </div>
        <button class="btn btn-primary shadow-sm" @onclick="SaveSettings" disabled="@_isSaving">
            @if (_isSaving)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            else
            {
                <i class="bi bi-save me-2"></i>
            }
            Save Configuration
        </button>
    </div>

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert alert-success border-0 shadow-sm mb-4">
            <i class="bi bi-check-circle-fill me-2"></i> @_successMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger border-0 shadow-sm mb-4">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @_errorMessage
        </div>
    }

    @if (_settings == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Loading system profile...</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            <!-- SMS GATEWAY (TWILIO) -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-chat-left-dots-fill text-primary me-2"></i>SMS (Twilio)</h5>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" role="switch" id="smsToggle" @bind="_settings.SmsEnabled">
                            <label class="form-check-label fw-bold small @(_settings.SmsEnabled ? "text-success" : "text-muted")" for="smsToggle">
                                @(_settings.SmsEnabled ? "ACTIVE" : "DISABLED")
                            </label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="@(!_settings.SmsEnabled ? "opacity-50 pointer-events-none" : "")">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Account SID</label>
                                <input type="text" class="form-control" @bind="_settings.TwilioAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" disabled="@(!_settings.SmsEnabled)" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">Auth Token</label>
                                <div class="input-group">
                                    <input type="@(_showAuthToken ? "text" : "password")" class="form-control" @bind="_settings.TwilioAuthToken" placeholder="Your Twilio Secret Token" disabled="@(!_settings.SmsEnabled)" />
                                    <button class="btn btn-outline-secondary" type="button" @onclick="() => _showAuthToken = !_showAuthToken" disabled="@(!_settings.SmsEnabled)">
                                        <i class="bi @(_showAuthToken ? "bi-eye-slash" : "bi-eye")"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label small fw-bold">From Phone Number</label>
                                <input type="text" class="form-control" @bind="_settings.TwilioFromNumber" placeholder="+15550001234" disabled="@(!_settings.SmsEnabled)" />
                            </div>
                        </div>

                        @if (!_settings.SmsEnabled)
                        {
                            <div class="alert alert-secondary py-2 small mb-0">
                                <i class="bi bi-info-circle me-2"></i> SMS sending is currently disabled globally.
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- EMAIL GATEWAY (SMTP) -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-envelope-paper-fill text-primary me-2"></i>Email (SMTP)</h5>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" role="switch" id="emailToggle" @bind="_settings.EmailEnabled">
                            <label class="form-check-label fw-bold small @(_settings.EmailEnabled ? "text-success" : "text-muted")" for="emailToggle">
                                @(_settings.EmailEnabled ? "ACTIVE" : "DISABLED")
                            </label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="@(!_settings.EmailEnabled ? "opacity-50 pointer-events-none" : "")">
                            <div class="row g-2 mb-3">
                                <div class="col-md-9">
                                    <label class="form-label small fw-bold">SMTP Host</label>
                                    <input type="text" class="form-control form-control-sm" @bind="_settings.SmtpHost" placeholder="smtp.gmail.com" disabled="@(!_settings.EmailEnabled)" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold">Port</label>
                                    <input type="number" class="form-control form-control-sm" @bind="_settings.SmtpPort" disabled="@(!_settings.EmailEnabled)" />
                                </div>
                            </div>

                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Username</label>
                                    <input type="text" class="form-control form-control-sm" @bind="_settings.SmtpUsername" disabled="@(!_settings.EmailEnabled)" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Password</label>
                                    <input type="password" class="form-control form-control-sm" @bind="_settings.SmtpPassword" disabled="@(!_settings.EmailEnabled)" />
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="smtpSsl" @bind="_settings.SmtpEnableSsl" disabled="@(!_settings.EmailEnabled)" />
                                    <label class="form-check-label small" for="smtpSsl">Enable SSL/TLS Security</label>
                                </div>
                            </div>

                            <div class="row g-2 mb-0">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">From Address</label>
                                    <input type="text" class="form-control form-control-sm" @bind="_settings.SmtpFromAddress" placeholder="system@yourclub.com" disabled="@(!_settings.EmailEnabled)" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">From Display Name</label>
                                    <input type="text" class="form-control form-control-sm" @bind="_settings.SmtpFromName" disabled="@(!_settings.EmailEnabled)" />
                                </div>
                            </div>
                        </div>

                        @if (!_settings.EmailEnabled)
                        {
                            <div class="alert alert-secondary py-2 small mb-0 mt-3">
                                <i class="bi bi-info-circle me-2"></i> Email sending is currently disabled globally.
                            </div>
                        }
                    </div>
                </div>
            </div>
            
            <!-- PREFERENCES & LOGINS -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label class="form-label fw-bold mb-0">Magic Link Login Strategy</label>
                                <p class="text-muted small mb-0">How should passwordless links be delivered?</p>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" @bind="_settings.PreferredMagicLinkMethod">
                                    <option value="Email">Email Priority</option>
                                    <option value="SMS">SMS Priority</option>
                                    <option value="Both">Both Enabled</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <div class="form-check form-switch ms-md-4">
                                    <input class="form-check-input" type="checkbox" role="switch" id="magicGlobal" @bind="_settings.MagicLinkEnabled">
                                    <label class="form-check-label fw-bold" for="magicGlobal">Enable Universal Magic Link Support</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .form-label { color: #475569; }
    .card { border-radius: 12px; }
    .card-header { border-top-left-radius: 12px !important; border-top-right-radius: 12px !important; }
    .btn-primary { background: #2563eb; border: none; padding: 0.6rem 1.2rem; font-weight: 500; border-radius: 8px; }
    .btn-primary:hover { background: #1d4ed8; }
    .pointer-events-none { pointer-events: none; }
    .x-small { font-size: 0.75rem; }
</style>

@code {
    private SystemSettings? _settings;
    private bool _isSaving = false;
    private bool _showAuthToken = false;
    private string? _successMessage;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _settings = await SystemSettingsService.GetAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = "Failed to load system profile: " + ex.Message;
        }
    }

    private async Task SaveSettings()
    {
        if (_settings == null) return;
        
        _isSaving = true;
        _successMessage = null;
        _errorMessage = null;

        try
        {
            await SystemSettingsService.UpdateAsync(_settings);
            _successMessage = "Gateway configurations successfully applied.";
            
            _ = Task.Delay(5000).ContinueWith(_ => {
                _successMessage = null;
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            _errorMessage = "Update Failed: " + ex.Message;
            Logger.LogError(ex, "Failed to save communication configurations");
        }
        finally
        {
            _isSaving = false;
        }
    }
}
