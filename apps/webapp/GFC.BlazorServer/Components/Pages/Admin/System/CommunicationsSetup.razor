@page "/admin/system/communications"
@using GFC.Core.Interfaces
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Data.Entities
@using Microsoft.AspNetCore.Authorization
@inject IBlazorSystemSettingsService SystemSettingsService
@inject ILogger<CommunicationsSetup> Logger
@attribute [Authorize]

<PageTitle>Communications Setup - GFC</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-envelope-at-fill text-primary"></i> Text & Email Setup</h2>
            <p class="text-muted mb-0">Manage system communication gateways and delivery preferences.</p>
        </div>
        <button class="btn btn-primary shadow-sm" @onclick="SaveSettings" disabled="@_isSaving">
            @if (_isSaving)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            else
            {
                <i class="bi bi-save me-2"></i>
            }
            Save Configurations
        </button>
    </div>

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert alert-success border-0 shadow-sm mb-4">
            <i class="bi bi-check-circle-fill me-2"></i> @_successMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger border-0 shadow-sm mb-4">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @_errorMessage
        </div>
    }

    @if (_settings == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Loading system profile...</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            <!-- SMS GATEWAY (TWILIO) -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0"><i class="bi bi-chat-left-dots-fill text-primary me-2"></i>SMS Gateway (Twilio)</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-4">Securely connect your Twilio account to enable passwordless login and system alerts via text message.</p>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Account SID</label>
                            <input type="text" class="form-control" @bind="_settings.TwilioAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Auth Token</label>
                            <div class="input-group">
                                <input type="@(_showAuthToken ? "text" : "password")" class="form-control" @bind="_settings.TwilioAuthToken" placeholder="Your Twilio Secret Token" />
                                <button class="btn btn-outline-secondary" type="button" @onclick="() => _showAuthToken = !_showAuthToken">
                                    <i class="bi @(_showAuthToken ? "bi-eye-slash" : "bi-eye")"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label small fw-bold">From Phone Number</label>
                            <input type="text" class="form-control" @bind="_settings.TwilioFromNumber" placeholder="+15550001234" />
                            <div class="form-text">The Twilio-provided number used to send outbound texts.</div>
                        </div>

                        <div class="p-3 bg-light rounded border">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-info-circle-fill text-primary fs-4"></i>
                                </div>
                                <div class="ms-3">
                                    <h6 class="mb-0 fw-bold small">Connection Status</h6>
                                    @if (string.IsNullOrEmpty(_settings.TwilioAccountSid))
                                    {
                                        <span class="badge bg-warning text-dark mt-1">Simulated Mode (Console Only)</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success mt-1">Ready for API Connection</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EMAIL & DELIVERY -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0"><i class="bi bi-envelope-paper-fill text-primary me-2"></i>Email & Delivery Policy</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label small fw-bold">Preferred Delivery Method</label>
                            <select class="form-select" @bind="_settings.PreferredMagicLinkMethod">
                                <option value="Email">Email Only (SMTP Simulator)</option>
                                <option value="SMS">SMS (Twilio Priority)</option>
                                <option value="Both">Broadcast Everywhere (Both)</option>
                            </select>
                            <div class="form-text">Determines how the system prioritizes magic link and alert deliveries.</div>
                        </div>

                        <div class="alert alert-primary bg-primary bg-opacity-10 border-0 p-3 mb-4">
                            <h6 class="fw-bold small"><i class="bi bi-server me-2"></i>SMTP Gateway Note</h6>
                            <p class="small mb-0 opacity-75">Email is currently operating in <strong>Secure Simulator Mode</strong>. Outbound messages are captured in the system logs for verification. Enterprise SMTP relay configuration is managed via the secure environment profile.</p>
                        </div>

                        <div class="form-check form-switch p-3 border rounded">
                            <input class="form-check-input ms-0 me-3" type="checkbox" role="switch" id="magicLinkToggle" @bind="_settings.MagicLinkEnabled">
                            <label class="form-check-label fw-bold" for="magicLinkToggle">Enable Passwordless "Magic Link" Logins</label>
                            <p class="text-muted small mb-0 ms-0 mt-1">Allows users to log in with a secure one-time link sent to their phone or inbox.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .form-label { color: #475569; }
    .card { border-radius: 12px; }
    .card-header { border-top-left-radius: 12px !important; border-top-right-radius: 12px !important; }
    .btn-primary { background: #2563eb; border: none; padding: 0.6rem 1.2rem; font-weight: 500; border-radius: 8px; }
    .btn-primary:hover { background: #1d4ed8; }
</style>

@code {
    private SystemSettings? _settings;
    private bool _isSaving = false;
    private bool _showAuthToken = false;
    private string? _successMessage;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _settings = await SystemSettingsService.GetAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = "Failed to load system profile: " + ex.Message;
        }
    }

    private async Task SaveSettings()
    {
        if (_settings == null) return;
        
        _isSaving = true;
        _successMessage = null;
        _errorMessage = null;

        try
        {
            await SystemSettingsService.UpdateAsync(_settings);
            _successMessage = "Communication gateways successfully updated.";
            
            // Auto-hide success message
            _ = Task.Delay(5000).ContinueWith(_ => {
                _successMessage = null;
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            _errorMessage = "Save Failed: " + ex.Message;
            Logger.LogError(ex, "Failed to save communication settings");
        }
        finally
        {
            _isSaving = false;
        }
    }
}
