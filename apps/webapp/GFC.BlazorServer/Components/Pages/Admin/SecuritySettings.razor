@page "/admin/security-settings"
@using GFC.Core.Enums
@using GFC.Core.Models
@using GFC.Core.Interfaces
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Services.Vpn
@using Microsoft.AspNetCore.Components.Authorization
@inject IBlazorSystemSettingsService SystemSettingsService
@inject IAuthorizedUserService AuthorizedUserService
@inject IVpnManagementService VpnManagementService
@inject IVpnConfigurationService VpnConfigurationService
@inject IJSRuntime JSRuntime
@inject IUserManagementService UserManagementService
@inject IUrlHelperService UrlHelperService
@inject IAuthenticationService AuthenticationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserConnectionService UserConnectionService
@inject ILogger<SecuritySettings> Logger

<PageTitle>Security & Policy Hub</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-shield-lock-fill text-primary"></i> Security & Policy Hub</h2>
            <p class="text-muted mb-0">Unified management of system governance, identity, and notification policies.</p>
        </div>
        <div>
            <button class="btn btn-primary shadow-sm" @onclick="SaveChanges">
                <i class="bi bi-save me-2"></i> Save All Policies
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show border-0 shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @_errorMessage
            <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show border-0 shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @_successMessage
            <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
        </div>
    }

    <!-- TABS -->
    <ul class="nav nav-pills mb-4 bg-light p-1 rounded border shadow-sm" id="securityTabs">
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "governance" ? "active" : "")" @onclick="@(() => _activeTab = "governance")">
                <i class="bi bi-shield-shaded me-2"></i>Governance
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "auth" ? "active" : "")" @onclick="@(() => _activeTab = "auth")">
                <i class="bi bi-key-fill me-2"></i>Auth & Identity
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "users" ? "active" : "")" @onclick="@(() => _activeTab = "users")">
                <i class="bi bi-people-fill me-2"></i>Authorized Users
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "notifications" ? "active" : "")" @onclick="@(() => _activeTab = "notifications")">
                <i class="bi bi-bell-fill me-2"></i>Notifications
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "domain" ? "active" : "")" @onclick="@(() => _activeTab = "domain")">
                <i class="bi bi-globe me-2"></i>Domain Policy
            </button>
        </li>
    </ul>

    @if (_settings == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Synchronizing policy state...</p>
        </div>
    }
    else
    {
        <div class="tab-content border rounded p-4 bg-white shadow-sm min-vh-50">
            
            <!-- GOVERNANCE TAB -->
            @if (_activeTab == "governance")
            {
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card border-danger mb-4 shadow-sm">
                            <div class="card-header bg-danger text-white py-3">
                                <h5 class="mb-0 small fw-bold text-uppercase"><i class="bi bi-exclamation-octagon-fill me-2"></i>Emergency Multi-Factor Lockdown</h5>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h6 class="fw-bold mb-1">Safe Mode Governance</h6>
                                        <p class="text-muted small mb-0">Instantly blocks non-admin access and suspends all public onboarding flows.</p>
                                    </div>
                                    <div class="col-auto">
                                        <div class="form-check form-switch custom-switch-lg">
                                            <input class="form-check-input" type="checkbox" role="switch" id="safeModeToggle" checked="@_settings.SafeModeEnabled" @onchange="InitiateSafeModeChange">
                                        </div>
                                    </div>
                                </div>
                                <hr />
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="small text-muted">Public Access Killswitch: Forcefully terminatate all active sessions.</span>
                                    <button class="btn btn-sm btn-outline-danger px-4" @onclick="TriggerEmergencyLockdown">Terminate All Sessions</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- AUTH TAB -->
            @if (_activeTab == "auth")
            {
                <div class="row">
                    <div class="col-lg-6">
                        <div class="mb-4 p-3 border rounded @(_settings.EnableTwoFactorAuth ? "bg-primary bg-opacity-10 border-primary" : "bg-light")">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable2fa" @bind="_settings.EnableTwoFactorAuth" />
                                <label for="enable2fa" class="form-check-label fw-bold h6 mb-0">Enable Multi-Factor Authentication</label>
                            </div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Device Trust (Days)</label>
                                <input type="number" class="form-control form-control-sm" @bind="_settings.TrustedDeviceDurationDays" />
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                         <div class="card bg-light border-0">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3 small text-uppercase text-muted">Session Resilience</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="x-small fw-bold">Idle Timeout (m)</label>
                                        <input type="number" class="form-control form-control-sm" @bind="_settings.IdleTimeoutMinutes" />
                                    </div>
                                    <div class="col-6">
                                        <label class="x-small fw-bold">Absolute Max (m)</label>
                                        <input type="number" class="form-control form-control-sm" @bind="_settings.AbsoluteSessionMaxMinutes" />
                                    </div>
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
            }

            <!-- NOTIFICATIONS TAB -->
            @if (_activeTab == "notifications")
            {
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">System Notification Matrix</h6>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" style="width: 250px;" placeholder="Search users..." @bind="_notifSearchText" @bind:event="oninput" @bind:after="ApplyNotifFilter" />
                            </div>
                        </div>
                        <div class="table-responsive border rounded">
                             <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">User</th>
                                        <th class="text-center">Member Signup</th>
                                        <th class="text-center">Dues Payment</th>
                                        <th class="text-center">System Alerts</th>
                                        <th class="text-center">Lottery Sales</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach(var u in _filteredUsers)
                                    {
                                        <tr>
                                            <td class="ps-3 fw-bold small">@u.UserName</td>
                                            <td class="text-center">
                                                <div class="form-check form-check-inline m-0">
                                                    <input type="checkbox" class="form-check-input" @bind="u.MemberSignupNotifyEmail" />
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <div class="form-check form-check-inline m-0">
                                                    <input type="checkbox" class="form-check-input" @bind="u.DuesPaymentNotifyEmail" />
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <div class="form-check form-check-inline m-0">
                                                    <input type="checkbox" class="form-check-input" @bind="u.SystemAlertNotifyEmail" />
                                                </div>
                                            </td>
                                             <td class="text-center">
                                                <div class="form-check form-check-inline m-0">
                                                    <input type="checkbox" class="form-check-input" @bind="u.LotterySalesNotifyEmail" />
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                             </table>
                        </div>
                    </div>
                </div>
            }

            <!-- USERS TAB -->
            @if (_activeTab == "users")
            {
                <div class="row">
                    <div class="col-lg-12">
                         <div class="card border-0">
                            <div class="card-body p-0">
                                <div class="d-flex justify-content-between mb-3">
                                    <h6 class="fw-bold mb-0">Administrator Access Grants</h6>
                                    <button class="btn btn-sm btn-primary" @onclick="() => _showAddUser = !_showAddUser"><i class="bi bi-plus"></i> Grant Access</button>
                                </div>
                                @if (_showAddUser)
                                {
                                    <div class="bg-light p-3 rounded mb-3 border">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <select class="form-select form-select-sm" @bind="_newAuthorizedUser.UserId">
                                                    <option value="0">Select User...</option>
                                                    @foreach (var user in _allAppUsers)
                                                    {
                                                        <option value="@user.UserId">@user.Username @(string.IsNullOrEmpty(user.MemberName) ? "" : $"({user.MemberName})")</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <select class="form-select form-select-sm" @bind="_newAuthorizedUser.AccessLevel">
                                                    <option value="Full Access">Full Access (Admin)</option>
                                                    <option value="View Only">View Only</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-primary btn-sm w-100" @onclick="AddAuthorizedUser">Add</button>
                                            </div>
                                        </div>
                                    </div>
                                }
                                <div class="table-responsive border rounded">
                                    <table class="table table-sm hover mb-0">
                                        <thead class="table-light"><tr><th class="ps-3">Name</th><th>Level</th><th class="text-end pe-3">Actions</th></tr></thead>
                                        <tbody>
                                            @foreach (var user in _authorizedUsers)
                                            {
                                                <tr>
                                                    <td class="ps-3 fw-bold small">@user.User?.Username</td>
                                                    <td><span class="badge @(user.AccessLevel == "Full Access" ? "bg-primary" : "bg-secondary") px-2">@user.AccessLevel</span></td>
                                                    <td class="text-end pe-3">
                                                        <button class="btn btn-link btn-sm text-danger" @onclick="() => RemoveAuthorizedUser(user.Id, user.UserId)"><i class="bi bi-trash"></i></button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
            }

            <!-- DOMAIN TAB -->
            @if (_activeTab == "domain")
            {
                <div class="row">
                    <div class="col-lg-6">
                         <div class="card bg-primary text-white mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3"><i class="bi bi-person-plus-fill me-2"></i>VPN Onboarding</h6>
                                <p class="x-small opacity-75">Generate single-use encrypted tunnel onboarding links.</p>
                                <div class="row g-2">
                                    <div class="col-8">
                                        <select class="form-select form-select-sm bg-white text-dark" @bind="_inviteUserId">
                                            @foreach (var user in _allAppUsers) { <option value="@user.UserId">@user.Username</option> }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <button class="btn btn-light btn-sm w-100" @onclick="GenerateInviteLink">Invite</button>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(_generatedLink))
                                {
                                    <div class="mt-3 p-2 bg-white text-dark rounded border shadow-sm small">
                                        <code class="user-select-all text-break d-block">@_generatedLink</code>
                                    </div>
                                }
                            </div>
                         </div>
                    </div>
                    <div class="col-lg-6">
                         <h6 class="fw-bold small text-uppercase text-muted mb-3">Authorized Origins</h6>
                         <div class="input-group input-group-sm mb-3">
                             <input type="text" class="form-control" placeholder="e.g. status.lovanow.com" @bind="_newAllowedDomain" />
                             <button class="btn btn-outline-secondary" @onclick="AddAllowedDomain">Add</button>
                         </div>
                         <ul class="list-group list-group-flush x-small border rounded">
                             @foreach (var domain in _allowedDomains)
                             {
                                 <li class="list-group-item d-flex justify-content-between">@domain <i class="bi bi-x-circle text-danger pointer" @onclick="() => RemoveAllowedDomain(domain)"></i></li>
                             }
                         </ul>
                    </div>
                </div>
            }

        </div>
    }
</div>

@if (_showSafeModeModal)
{
    <div class="modal-backdrop show" style="background-color: rgba(0,0,0,0.8);"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white border-0 py-3">
                    <h5 class="modal-title fw-bold"><i class="bi bi-shield-lock me-2"></i>AUTHORIZE SYSTEM LOCKDOWN</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelSafeModeChange"></button>
                </div>
                <div class="modal-body py-4">
                    <p class="lead fw-bold text-danger mb-3">Administrative Password Required</p>
                    <input type="password" class="form-control form-control-lg" @bind="_safeModePassword" placeholder="Confirm your identity" />
                    @if (!string.IsNullOrEmpty(_safeModeError)) { <div class="text-danger small mt-2 fw-bold">@_safeModeError</div> }
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" @onclick="CancelSafeModeChange">Abort</button>
                    <button type="button" class="btn btn-danger px-4" @onclick="ConfirmSafeModeChange" disabled="@_isVerifying">Confirm Policy Change</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .custom-switch-lg .form-check-input { width: 3.5rem; height: 1.75rem; cursor: pointer; }
    .x-small { font-size: 0.75rem; }
    .pointer { cursor: pointer; }
    .nav-pills .nav-link { cursor: pointer; color: #6c757d; font-weight: 500; font-size: 0.9rem; border-radius: 8px; margin-right: 4px; }
    .nav-pills .nav-link.active { background-color: #0d6efd; box-shadow: 0 4px 12px rgba(13,110,253,0.2); }
</style>

@using GFC.Core.DTOs
@code {
    private string _activeTab = "governance";
    private SystemSettings _settings;
    private List<AuthorizedUser> _authorizedUsers = new();
    private AuthorizedUser _newAuthorizedUser = new() { AccessLevel = "Full Access" };
    private List<UserListItemDto> _allAppUsers = new();
    private List<UserNotificationPreferencesModel> _notifUsers = new();
    private List<UserNotificationPreferencesModel> _filteredUsers = new();
    private string _notifSearchText = "";
    
    private string _errorMessage;
    private string _successMessage;
    private List<string> _allowedDomains = new();
    private string _newAllowedDomain;
    private bool _showAddUser = false;
    private int _inviteUserId;
    private string _generatedLink;

    private bool _showSafeModeModal = false;
    private bool _pendingSafeModeState = false;
    private string _safeModePassword = "";
    private string _safeModeError = "";
    private bool _isVerifying = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _settings = await SystemSettingsService.GetAsync();
            _authorizedUsers = await AuthorizedUserService.GetAuthorizedUsersAsync();
            _allAppUsers = UserManagementService.GetAllUsers();
            _allowedDomains = _settings.AllowedDomains?.Split(',', StringSplitOptions.RemoveEmptyEntries).ToList() ?? new List<string>();
            if (_allAppUsers.Any()) _inviteUserId = _allAppUsers.First().UserId;
            
            // Load notification users (using Username as primary identifier)
            _notifUsers = _allAppUsers.Select(u => new UserNotificationPreferencesModel { UserName = u.Username, Email = "" }).ToList();
            ApplyNotifFilter();
        }
        catch (Exception ex) { _errorMessage = "Initialization Error: " + ex.Message; }
    }

    private void ApplyNotifFilter()
    {
        _filteredUsers = string.IsNullOrWhiteSpace(_notifSearchText) 
            ? _notifUsers 
            : _notifUsers.Where(u => u.UserName.Contains(_notifSearchText, StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private async Task SaveChanges()
    {
        _errorMessage = null; _successMessage = null;
        try
        {
            _settings.AllowedDomains = string.Join(",", _allowedDomains);
            await SystemSettingsService.UpdateAsync(_settings);
            _successMessage = "System security and notification policies synchronized.";
        }
        catch (Exception ex) { _errorMessage = "Save Error: " + ex.Message; }
    }

    private void AddAllowedDomain() { if (!string.IsNullOrWhiteSpace(_newAllowedDomain) && !_allowedDomains.Contains(_newAllowedDomain)) { _allowedDomains.Add(_newAllowedDomain); _newAllowedDomain = ""; } }
    private void RemoveAllowedDomain(string domain) { if (domain != _settings.PrimaryDomain) _allowedDomains.Remove(domain); }

    private async Task InitiateSafeModeChange(ChangeEventArgs e) { _pendingSafeModeState = (bool)e.Value!; _safeModePassword = ""; _safeModeError = ""; _showSafeModeModal = true; }
    private void CancelSafeModeChange() { _showSafeModeModal = false; StateHasChanged(); }
    
    private async Task ConfirmSafeModeChange()
    {
        _isVerifying = true;
        try {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var result = await AuthenticationService.LoginAsync(authState.User.Identity?.Name, _safeModePassword);
            if (result.Code != LoginResultCode.Success && result.Code != LoginResultCode.MfaRequired) { _safeModeError = "Validation failed."; return; }
            _settings.SafeModeEnabled = _pendingSafeModeState;
            await SystemSettingsService.UpdateAsync(_settings);
            _showSafeModeModal = false;
            _successMessage = $"Safe Mode {(_pendingSafeModeState ? "Enabled" : "Disabled")}.";
        } catch (Exception ex) { _safeModeError = ex.Message; } finally { _isVerifying = false; }
    }

    private async Task AddAuthorizedUser()
    {
        if (_newAuthorizedUser.UserId <= 0) return;
        await AuthorizedUserService.AddAuthorizedUserAsync(_newAuthorizedUser);
        _newAuthorizedUser = new AuthorizedUser() { AccessLevel = "Full Access" };
        _authorizedUsers = await AuthorizedUserService.GetAuthorizedUsersAsync();
        _showAddUser = false;
    }

    private async Task RemoveAuthorizedUser(int id, int userId) { await VpnManagementService.RevokeUserAccessAsync(userId); await AuthorizedUserService.RemoveAuthorizedUserAsync(id); _authorizedUsers = await AuthorizedUserService.GetAuthorizedUsersAsync(); }
    
    private async Task TriggerEmergencyLockdown() { if (await JSRuntime.InvokeAsync<bool>("confirm", "TERMINATE ALL SESSIONS?")) { await VpnManagementService.DisconnectAllUsersAsync(); _successMessage = "All sessions terminated."; } }

    private async Task GenerateInviteLink() { var token = await VpnConfigurationService.CreateOnboardingTokenAsync(_inviteUserId); _generatedLink = $"{NavigationManager.BaseUri.TrimEnd('/')}/setup/{token}"; }

    private class UserNotificationPreferencesModel
    {
        public string UserName { get; set; }
        public string Email { get; set; }
        public bool MemberSignupNotifyEmail { get; set; } = true;
        public bool DuesPaymentNotifyEmail { get; set; } = true;
        public bool SystemAlertNotifyEmail { get; set; } = true;
        public bool LotterySalesNotifyEmail { get; set; } = false;
    }

    [Inject] private NavigationManager NavigationManager { get; set; }
}
