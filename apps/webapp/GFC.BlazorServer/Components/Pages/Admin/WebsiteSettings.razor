// [NEW]
@page "/admin/website-settings"
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject GFC.Core.Interfaces.IWebsiteSettingsService WebsiteSettingsService

<h3>Website Settings <span class="badge bg-info gfc-new-tag">[NEW]</span></h3>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}

@if (_settings == null)
{
    @if (string.IsNullOrEmpty(_errorMessage))
    {
        <p><em>Loading...</em></p>
    }
}
else
{
    <EditForm Model="@_settings" OnValidSubmit="SaveChanges">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-card">
            <div class="form-card-header">
                <i class="bi bi-globe"></i>
                <h5>Global Information</h5>
            </div>
            <div class="form-card-body">
                <div class="mb-3">
                    <label for="clubPhone" class="form-label">Club Phone</label>
                    <InputText id="clubPhone" class="form-control" @bind-Value="_settings.ClubPhone" />
                </div>

                <div class="mb-3">
                    <label for="clubAddress" class="form-label">Club Address</label>
                    <InputText id="clubAddress" class="form-control" @bind-Value="_settings.ClubAddress" />
                </div>
                <div class="mb-3">
                    <label for="memberRate" class="form-label">Member Rental Rate</label>
                    <InputNumber id="memberRate" class="form-control" @bind-Value="_settings.MemberRate" />
                </div>
                <div class="mb-3">
                    <label for="nonMemberRate" class="form-label">Non-Member Rental Rate</label>
                    <InputNumber id="nonMemberRate" class="form-control" @bind-Value="_settings.NonMemberRate" />
                </div>
            </div>
        </div>

        <div class="form-card mt-4">
            <div class="form-card-header">
                <i class="bi bi-envelope-slash"></i>
                <h5>Email Settings</h5>
            </div>
            <div class="form-card-body">
                <div class="form-check">
                    <InputCheckbox id="emailKillSwitch" class="form-check-input" @bind-Value="_settings.MasterEmailKillSwitch" />
                    <label for="emailKillSwitch" class="form-check-label">Master Email Kill Switch</label>
                    <small class="form-text text-muted">When checked, all outgoing emails from the system will be disabled.</small>
                </div>
            </div>
        </div>

        <div class="action-bar mt-4">
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
    </EditForm>
}

@code {
    private GFC.Core.Models.WebsiteSettings _settings;
    private string _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _settings = await WebsiteSettingsService.GetWebsiteSettingsAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading website settings: {ex.Message}. The database may be missing the 'WebsiteSettings' table.";
        }
    }

    private async Task SaveChanges()
    {
        try
        {
            await WebsiteSettingsService.UpdateWebsiteSettingsAsync(_settings);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving settings: {ex.Message}";
        }
    }
}
