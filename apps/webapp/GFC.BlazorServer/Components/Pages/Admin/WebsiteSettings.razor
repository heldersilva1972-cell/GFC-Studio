// [NEW]
@page "/admin/website-settings"
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject GFC.Core.Interfaces.IWebsiteSettingsService WebsiteSettingsService

<h3>Website Settings <span class="badge bg-info gfc-new-tag">[NEW]</span></h3>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}

@if (_settings == null)
{
    @if (string.IsNullOrEmpty(_errorMessage))
    {
        <p><em>Loading...</em></p>
    }
}
else
{
    <EditForm Model="@_settings" OnValidSubmit="SaveChanges">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-card">
            <div class="form-card-header">
                <i class="bi bi-globe"></i>
                <h5>Global Information</h5>
            </div>
            <div class="form-card-body">
                <div class="mb-3">
                    <label for="clubPhone" class="form-label">Club Phone</label>
                    <InputText id="clubPhone" class="form-control" @bind-Value="_settings.ClubPhone" />
                </div>

                <div class="mb-3">
                    <label for="clubAddress" class="form-label">Club Address</label>
                    <InputText id="clubAddress" class="form-control" @bind-Value="_settings.ClubAddress" />
                </div>
                <div class="mb-3">
                    <label for="memberRate" class="form-label">Member Rental Rate</label>
                    <InputNumber id="memberRate" class="form-control" @bind-Value="MemberRateProxy" />
                </div>
                <div class="mb-3">
                    <label for="nonMemberRate" class="form-label">Non-Member Rental Rate</label>
                    <InputNumber id="nonMemberRate" class="form-control" @bind-Value="NonMemberRateProxy" />
                </div>
                <div class="form-check form-switch mb-3">
                    <InputCheckbox id="isClubOpen" class="form-check-input" @bind-Value="IsClubOpenProxy" />
                    <label for="isClubOpen" class="form-check-label">Club Status (Open/Closed)</label>
                    <small class="form-text text-muted">Controls the "Open" or "Closed" status displayed on the public website header.</small>
                </div>
            </div>
        </div>

        <div class="form-card mt-4">
            <div class="form-card-header">
                <i class="bi bi-envelope-slash"></i>
                <h5>Email Settings</h5>
            </div>
            <div class="form-card-body">
                <div class="form-check">
                    <InputCheckbox id="emailKillSwitch" class="form-check-input" @bind-Value="MasterEmailKillSwitchProxy" />
                    <label for="emailKillSwitch" class="form-check-label">Master Email Kill Switch</label>
                    <small class="form-text text-muted">When checked, all outgoing emails from the system will be disabled.</small>
                </div>
            </div>
        </div>

        <div class="form-card mt-4">
            <div class="form-card-header">
                <i class="bi bi-search"></i>
                <h5>SEO Settings</h5>
            </div>
            <div class="form-card-body">
                <div class="mb-3">
                    <label for="seoTitle" class="form-label">SEO Title</label>
                    <InputText id="seoTitle" class="form-control" @bind-Value="_settings.SeoTitle" />
                </div>
                <div class="mb-3">
                    <label for="seoDescription" class="form-label">SEO Description</label>
                    <InputTextArea id="seoDescription" class="form-control" @bind-Value="_settings.SeoDescription" />
                </div>
                <div class="mb-3">
                    <label for="seoKeywords" class="form-label">SEO Keywords</label>
                    <InputText id="seoKeywords" class="form-control" @bind-Value="_settings.SeoKeywords" />
                    <small class="form-text text-muted">Comma-separated keywords.</small>
                </div>
            </div>
        </div>

        <div class="action-bar mt-4">
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
    </EditForm>
}

@code {
    private GFC.Core.Models.WebsiteSettings _settings;
    private string _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _settings = await WebsiteSettingsService.GetWebsiteSettingsAsync();
            if (_settings == null)
            {
               _settings = new GFC.Core.Models.WebsiteSettings();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading website settings: {ex.Message}. Using default settings.";
            // Fallback so the user can at least try to save and correct the DB
            _settings = new GFC.Core.Models.WebsiteSettings();
        }
    }

    private async Task SaveChanges()
    {
        try
        {
            await WebsiteSettingsService.UpdateWebsiteSettingsAsync(_settings);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving settings: {ex.Message}";
        }
    }

    // Proxy properties to handle nullable types for UI binding
    public decimal MemberRateProxy
    {
        get => _settings?.MemberRate ?? 0;
        set { if (_settings != null) _settings.MemberRate = value; }
    }

    public decimal NonMemberRateProxy
    {
        get => _settings?.NonMemberRate ?? 0;
        set { if (_settings != null) _settings.NonMemberRate = value; }
    }

    public bool IsClubOpenProxy
    {
        get => _settings?.IsClubOpen ?? true;
        set { if (_settings != null) _settings.IsClubOpen = value; }
    }

    public bool MasterEmailKillSwitchProxy
    {
        get => _settings?.MasterEmailKillSwitch ?? false;
        set { if (_settings != null) _settings.MasterEmailKillSwitch = value; }
    }
}
