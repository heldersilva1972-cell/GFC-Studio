@page "/admin/form-builder"
@page "/admin/form-builder/{FormId:int}"
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject IFormService FormService
@inject NavigationManager NavigationManager

<h3>Form Builder</h3>

@if (form != null)
{
    <div class="form-group">
        <label>Form Name</label>
        <InputText @bind-Value="form.Name" class="form-control" />
    </div>

    <div class="form-group">
        <label>Form Description</label>
        <InputTextArea @bind-Value="form.Description" class="form-control" />
    </div>

    <hr />

    <h4>Form Fields</h4>

    @foreach (var field in form.FormFields.OrderBy(f => f.Order))
    {
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="form-group">
                        <label>Field Type</label>
                        <InputSelect @bind-Value="field.FieldType" class="form-control">
                            <option value="text">Text</option>
                            <option value="email">Email</option>
                            <option value="tel">Phone</option>
                            <option value="date">Date</option>
                            <option value="select">Dropdown</option>
                            <option value="checkbox">Checkbox</option>
                            <option value="file">File Upload</option>
                        </InputSelect>
                    </div>
                    <div>
                        <button class="btn btn-light btn-sm" @onclick="() => MoveFieldUp(field)" disabled="@(form.FormFields.OrderBy(f => f.Order).First() == field)">Up</button>
                        <button class="btn btn-light btn-sm" @onclick="() => MoveFieldDown(field)" disabled="@(form.FormFields.OrderBy(f => f.Order).Last() == field)">Down</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Label</label>
                    <InputText @bind-Value="field.Label" class="form-control" />
                </div>
                @if (field.FieldType == "select")
                {
                    <div class="form-group">
                        <label>Options (comma-separated)</label>
                        <InputTextArea @bind-Value="field.Options" class="form-control" />
                    </div>
                }
                <div class="form-group">
                    <label>Placeholder</label>
                    <InputText @bind-Value="field.Placeholder" class="form-control" />
                </div>
                <div class="form-check">
                    <InputCheckbox @bind-Value="field.IsRequired" class="form-check-input" />
                    <label class="form-check-label">Required</label>
                </div>
                <button class="btn btn-danger btn-sm" @onclick="() => RemoveField(field)">Remove</button>
            </div>
        </div>
    }

    <button class="btn btn-primary" @onclick="AddField">Add Field</button>
    <button class="btn btn-success" @onclick="SaveForm">Save Form</button>
}
else
{
    <p>Loading...</p>
}

@code {
    [Parameter]
    public int FormId { get; set; }

    private Form form;

    protected override async Task OnInitializedAsync()
    {
        if (FormId > 0)
        {
            form = await FormService.GetFormByIdAsync(FormId);
        }
        else
        {
            form = new Form();
        }
    }

    private void AddField()
    {
        form.FormFields.Add(new FormField
        {
            Order = form.FormFields.Any() ? form.FormFields.Max(f => f.Order) + 1 : 1,
            FieldType = "text"
        });
    }

    private void RemoveField(FormField field)
    {
        form.FormFields.Remove(field);
        RenumberFields();
    }

    private void MoveFieldUp(FormField field)
    {
        var orderedFields = form.FormFields.OrderBy(f => f.Order).ToList();
        var index = orderedFields.IndexOf(field);
        if (index > 0)
        {
            var previousField = orderedFields[index - 1];
            (field.Order, previousField.Order) = (previousField.Order, field.Order);
        }
    }

    private void MoveFieldDown(FormField field)
    {
        var orderedFields = form.FormFields.OrderBy(f => f.Order).ToList();
        var index = orderedFields.IndexOf(field);
        if (index < orderedFields.Count - 1)
        {
            var nextField = orderedFields[index + 1];
            (field.Order, nextField.Order) = (nextField.Order, field.Order);
        }
    }

    private void RenumberFields()
    {
        var orderedFields = form.FormFields.OrderBy(f => f.Order).ToList();
        for (int i = 0; i < orderedFields.Count; i++)
        {
            orderedFields[i].Order = i + 1;
        }
    }

    private async Task SaveForm()
    {
        if (form.Id > 0)
        {
            await FormService.UpdateFormAsync(form);
        }
        else
        {
            var createdForm = await FormService.CreateFormAsync(form);
            form = createdForm;
        }
        NavigationManager.NavigateTo($"/admin/form-builder/{form.Id}");
    }
}
