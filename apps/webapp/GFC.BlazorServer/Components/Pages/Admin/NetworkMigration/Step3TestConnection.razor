@using GFC.BlazorServer.Services.NetworkMigration

<div>
    <h5 class="mb-4">Test Connection</h5>

    @if (Request.SkipConnectionTest)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Connection test skipped</strong> - Migration will proceed without verification
        </div>
    }
    else if (TestResult == null)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Testing connection to <strong>@Request.NewIpAddress:@Request.NewPort</strong>
        </div>

        <button class="btn btn-primary" @onclick="OnRunTest" disabled="@IsExecuting">
            @if (IsExecuting)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
                <text>Testing...</text>
            }
            else
            {
                <i class="bi bi-play-circle me-2"></i>
                <text>Run Connection Test</text>
            }
        </button>
    }
    else
    {
        <div class="alert @(TestResult.Success ? "alert-success" : "alert-danger")">
            @if (TestResult.Success)
            {
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>Connection test passed!</strong>
            }
            else
            {
                <i class="bi bi-x-circle-fill me-2"></i>
                <strong>Connection test failed:</strong> @TestResult.ErrorMessage
            }
        </div>

        <div class="card">
            <div class="card-body">
                <h6>Test Results</h6>
                <div class="list-group list-group-flush">
                    @foreach (var step in TestResult.Steps)
                    {
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                @if (step.Status == "Success")
                                {
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                }
                                else if (step.Status == "Failed")
                                {
                                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                }
                                else
                                {
                                    <i class="bi bi-dash-circle text-muted me-2"></i>
                                }
                                <strong>@step.Name:</strong> @step.Message
                            </div>
                            @if (step.DurationMs > 0)
                            {
                                <span class="badge bg-secondary">@step.DurationMs ms</span>
                            }
                        </div>
                    }
                </div>
                <div class="mt-2 text-muted small">
                    Total duration: @TestResult.TotalDurationMs ms
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button class="btn btn-outline-secondary" @onclick="OnRunTest">
                <i class="bi bi-arrow-clockwise"></i> Retry Test
            </button>
        </div>
    }

    <div class="mt-4 d-flex justify-content-between">
        <button class="btn btn-secondary" @onclick="OnBack">
            <i class="bi bi-arrow-left"></i> Back
        </button>
        <button class="btn btn-primary" @onclick="OnNext" 
                disabled="@(!Request.SkipConnectionTest && (TestResult == null || !TestResult.Success))">
            Next: Review Plan <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</div>

@code {
    [Parameter] public NetworkMigrationRequest Request { get; set; } = new();
    [Parameter] public ConnectionTestResult? TestResult { get; set; }
    [Parameter] public bool IsExecuting { get; set; }
    [Parameter] public EventCallback OnRunTest { get; set; }
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public EventCallback OnNext { get; set; }
}
