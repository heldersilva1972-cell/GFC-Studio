// [NEW]
@page "/admin/staff-shifts"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "RequireAdmin")]
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject IShiftService ShiftService
@inject ToastService ToastService
@inject IJSRuntime JSRuntime

<h3>Staff Shift Scheduler</h3>

<!-- Staff Management Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Staff Roster</h5>
        <button class="btn btn-success btn-sm" @onclick="OpenAddStaffModal">
            <i class="bi bi-plus-circle"></i> Add Staff Member
        </button>
    </div>
    <div class="card-body">
        @if (staffMembers.Any())
        {
            <div class="row">
                @foreach (var staff in staffMembers)
                {
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">@staff.Name</h6>
                                <p class="card-text text-muted mb-2">@staff.Role</p>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" @onclick="() => EditStaff(staff)">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger" @onclick="() => DeleteStaff(staff.Id)">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No staff members added yet. Click "Add Staff Member" to get started.
            </div>
        }
    </div>
</div>

<!-- Shift Schedule Section -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-primary" @onclick="() => ChangeWeek(-7)">
                <i class="bi bi-chevron-left"></i> Previous Week
            </button>
            <h4 class="mb-0">@currentDate.ToString("MMMM yyyy")</h4>
            <button class="btn btn-primary" @onclick="() => ChangeWeek(7)">
                Next Week <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading shifts...</span>
                </div>
                <p class="mt-2">Loading shifts...</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            @for (int i = 0; i < 7; i++)
                            {
                                <th scope="col">@currentDate.AddDays(i).ToString("ddd, MMM dd")</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            @for (int i = 0; i < 7; i++)
                            {
                                var day = currentDate.AddDays(i);
                                var dayShift = weeklyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 1);
                                <td>
                                    <strong class="text-primary">Day Shift</strong><br>
                                    @if (dayShift != null)
                                    {
                                        <div class="shift-card mt-2 p-2 bg-light border rounded" @onclick="() => ViewShiftDetails(dayShift)" style="cursor: pointer;">
                                            <i class="bi bi-person-fill"></i> @dayShift.StaffName
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-success mt-2" @onclick="@(() => AssignDayShift(day))">
                                            <i class="bi bi-plus-circle"></i> Assign
                                        </button>
                                    }
                                </td>
                            }
                        </tr>
                        <tr>
                            @for (int i = 0; i < 7; i++)
                            {
                                var day = currentDate.AddDays(i);
                                var nightShift = weeklyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 2);
                                <td>
                                    <strong class="text-info">Night Shift</strong><br>
                                    @if (nightShift != null)
                                    {
                                        <div class="shift-card mt-2 p-2 bg-light border rounded" @onclick="() => ViewShiftDetails(nightShift)" style="cursor: pointer;">
                                            <i class="bi bi-moon-fill"></i> @nightShift.StaffName
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-success mt-2" @onclick="@(() => AssignNightShift(day))">
                                            <i class="bi bi-plus-circle"></i> Assign
                                        </button>
                                    }
                                </td>
                            }
                        </tr>
                    </tbody>
                </table>
            </div>
        }
    </div>
     <div class="card-footer">
        <button class="btn btn-info" @onclick="ExportReports">
            <i class="bi bi-download"></i> Export Shift Reports
        </button>
    </div>
</div>

<!-- Add/Edit Staff Modal -->
@if (showStaffModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingStaff?.Id > 0 ? "Edit" : "Add") Staff Member</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="staffName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" id="staffName" class="form-control" @bind="editingStaff.Name" placeholder="Enter staff member name" />
                    </div>
                    <div class="mb-3">
                        <label for="staffRole" class="form-label">Role</label>
                        <select id="staffRole" class="form-select" @bind="editingStaff.Role">
                            <option value="">Select role...</option>
                            <option value="Bartender">Bartender</option>
                            <option value="Manager">Manager</option>
                            <option value="Server">Server</option>
                            <option value="Cook">Cook</option>
                            <option value="Cleaner">Cleaner</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveStaff" disabled="@(string.IsNullOrWhiteSpace(editingStaff?.Name))">
                        <i class="bi bi-check-circle"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Assign Shift Modal -->
@if (showAssignmentModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Shift</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <p>Assigning shift for <strong>@newShift.Date.ToShortDateString() (@(newShift.ShiftType == 1 ? "Day" : "Night") shift)</strong></p>
                    
                    @if (staffMembers.Any())
                    {
                        <div class="mb-3">
                            <label for="staffMember" class="form-label">Select Staff Member <span class="text-danger">*</span></label>
                            <select id="staffMember" class="form-select" @bind="selectedStaffId">
                                <option value="0">-- Select a staff member --</option>
                                @foreach (var staff in staffMembers)
                                {
                                    <option value="@staff.Id">@staff.Name (@staff.Role)</option>
                                }
                            </select>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No staff members available. Please add staff members first.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveShiftAssignment" disabled="@(selectedStaffId == 0)">
                        <i class="bi bi-check-circle"></i> Assign Shift
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Shift Report Modal -->
@if (selectedShiftReport != null)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shift Report</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Staff:</strong> @selectedShiftReport.StaffShift.StaffName</p>
                            <p><strong>Date:</strong> @selectedShiftReport.StaffShift.Date.ToShortDateString()</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Shift:</strong> @(selectedShiftReport.StaffShift.ShiftType == 1 ? "Day" : "Night")</p>
                            <p><strong>Status:</strong> 
                                <span class="badge @(selectedShiftReport.IsLate ? "bg-warning" : "bg-success")">
                                    @(selectedShiftReport.IsLate ? "Late" : "On Time")
                                </span>
                            </p>
                        </div>
                    </div>
                    <hr />
                    <h6>Financial Report</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Bar Sales</h6>
                                    <h4 class="card-title">@selectedShiftReport.BarSales.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Lotto Sales</h6>
                                    <h4 class="card-title">@selectedShiftReport.LottoSales.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Deposit</h6>
                                    <h4 class="card-title">@selectedShiftReport.TotalDeposit.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3"><strong>Submitted:</strong> @selectedShiftReport.SubmittedAt.ToString("g")</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private bool _isLoading = true;
    private DateTime currentDate = DateTime.Today;
    private List<StaffShift> weeklyShifts = new();
    private List<StaffMember> staffMembers = new();

    private bool showAssignmentModal = false;
    private bool showStaffModal = false;
    private StaffShift newShift;
    private ShiftReport selectedShiftReport;
    private StaffMember editingStaff = new();
    private int selectedStaffId = 0;

    protected override async Task OnInitializedAsync()
    {
        // Start week on a Sunday
        currentDate = currentDate.AddDays(-(int)currentDate.DayOfWeek);
        await LoadData();
    }

    private async Task LoadData()
    {
        await LoadShifts();
        await LoadStaffMembers();
    }

    private async Task LoadShifts()
    {
        _isLoading = true;
        weeklyShifts = (await ShiftService.GetShiftsForWeekAsync(currentDate)).ToList();
        _isLoading = false;
        StateHasChanged();
    }

    private async Task LoadStaffMembers()
    {
        staffMembers = (await ShiftService.GetAssignableStaffAsync()).ToList();
        StateHasChanged();
    }

    private async Task ChangeWeek(int days)
    {
        currentDate = currentDate.AddDays(days);
        await LoadShifts();
    }

    // Staff Management Methods
    private void OpenAddStaffModal()
    {
        editingStaff = new StaffMember();
        showStaffModal = true;
        StateHasChanged();
    }

    private void EditStaff(StaffMember staff)
    {
        editingStaff = new StaffMember 
        { 
            Id = staff.Id, 
            Name = staff.Name, 
            Role = staff.Role,
            PhoneNumber = staff.PhoneNumber,
            Email = staff.Email,
            HourlyRate = staff.HourlyRate,
            IsActive = staff.IsActive,
            HireDate = staff.HireDate,
            Notes = staff.Notes
        };
        showStaffModal = true;
        StateHasChanged();
    }

    private async Task SaveStaff()
    {
        if (string.IsNullOrWhiteSpace(editingStaff?.Name))
        {
            ToastService.ShowError("Staff name is required");
            return;
        }

        try
        {
            if (editingStaff.Id > 0)
            {
                // Update existing staff
                await ShiftService.UpdateStaffMemberAsync(editingStaff);
                ToastService.ShowSuccess("Staff member updated successfully");
            }
            else
            {
                // Add new staff
                await ShiftService.CreateStaffMemberAsync(editingStaff);
                ToastService.ShowSuccess("Staff member added successfully");
            }

            await LoadStaffMembers();
            CloseModals();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving staff member: {ex.Message}");
        }
    }

    private async Task DeleteStaff(int staffId)
    {
        try
        {
            var staff = staffMembers.FirstOrDefault(s => s.Id == staffId);
            if (staff != null)
            {
                await ShiftService.DeleteStaffMemberAsync(staffId);
                ToastService.ShowSuccess($"{staff.Name} removed from staff roster");
                await LoadStaffMembers();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting staff member: {ex.Message}");
        }
    }

    // Shift Assignment Methods
    private void AssignShift(DateTime date, string shiftType)
    {
        if (!staffMembers.Any())
        {
            ToastService.ShowWarning("Please add staff members before assigning shifts");
            return;
        }

        newShift = new StaffShift { Date = date, ShiftType = shiftType == "Day" ? 1 : 2 };
        selectedStaffId = 0;
        showAssignmentModal = true;
        StateHasChanged();
    }

    private void AssignDayShift(DateTime date)
    {
        AssignShift(date, "Day");
    }

    private void AssignNightShift(DateTime date)
    {
        AssignShift(date, "Night");
    }

    private async Task SaveShiftAssignment()
    {
        if (newShift != null && selectedStaffId > 0)
        {
            try
            {
                var selectedStaff = staffMembers.FirstOrDefault(s => s.Id == selectedStaffId);
                if (selectedStaff != null)
                {
                    newShift.StaffName = selectedStaff.Name;
                    newShift.StaffMemberId = selectedStaff.Id;
                    
                    await ShiftService.CreateStaffShiftAsync(newShift);
                    ToastService.ShowSuccess($"Shift assigned to {selectedStaff.Name}");
                    CloseModals();
                    await LoadShifts();
                }
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Error assigning shift: {ex.Message}");
            }
        }
    }

    private async Task ViewShiftDetails(StaffShift shift)
    {
        var report = await ShiftService.GetShiftReportAsync(shift.Id);
        if (report != null)
        {
            selectedShiftReport = report;
            StateHasChanged();
        }
        else
        {
            ToastService.ShowInfo("No report available for this shift yet");
        }
    }

    private void CloseModals()
    {
        showAssignmentModal = false;
        showStaffModal = false;
        selectedShiftReport = null;
        editingStaff = new();
        selectedStaffId = 0;
        StateHasChanged();
    }

    private async Task ExportReports()
    {
        var reports = await ShiftService.GetShiftReportsForExportAsync(currentDate, currentDate.AddDays(7));
        if (!reports.Any())
        {
            await ToastService.ShowToastAsync("No shift reports available for the current week.", ToastLevel.Warning);
            return;
        }

        var csvBuilder = new System.Text.StringBuilder();
        csvBuilder.AppendLine("ShiftDate,ShiftType,StaffMember,ReportContent");

        foreach (var report in reports)
        {
            var date = report.StaffShift.Date.ToString("yyyy-MM-dd");
            var type = report.StaffShift.ShiftType == 1 ? "Day" : "Night";
            var staff = report.StaffShift.StaffName;
            var sales = $"Bar: {report.BarSales:C}, Lotto: {report.LottoSales:C}, Total: {report.TotalDeposit:C}";
            csvBuilder.AppendLine($"{date},{type},{staff},\"{sales}\"");
        }

        var csvBytes = System.Text.Encoding.UTF8.GetBytes(csvBuilder.ToString());
        var base64 = System.Convert.ToBase64String(csvBytes);

        var fileName = $"ShiftReports_{currentDate:yyyy-MM-dd}.csv";
        await JSRuntime.InvokeVoidAsync("saveAsFile", fileName, base64);
    }
}
