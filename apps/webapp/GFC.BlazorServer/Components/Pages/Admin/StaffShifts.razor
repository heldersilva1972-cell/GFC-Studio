```
// [NEW]
@page "/admin/staff-shifts"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "RequireAdmin")]
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Data.Entities
@using GFC.Core.Interfaces
@inject IShiftService ShiftService
@inject IMemberRepository MemberRepository
@inject ToastService ToastService
@inject IJSRuntime JSRuntime

<style>
    .calendar-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    .table-calendar {
        table-layout: fixed;
    }
    .table-calendar th, .table-calendar td {
        width: 14.28% !important;
        overflow: hidden;
    }
    .month-calendar table td { height: 120px !important; }
    
    .roster-pill {
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #dee2e6;
        background: white;
    }
    .roster-pill:hover {
        background: #f8f9fa;
        border-color: #007bff;
    }
    .roster-pill .bi-chevron-down {
        transition: transform 0.2s;
    }
    .roster-pill.expanded .bi-chevron-down {
        transform: rotate(180deg);
    }
    .day-pill {
        cursor: pointer;
        padding: 5px 12px;
        border-radius: 20px;
        border: 1px solid #dee2e6;
        background: #f8f9fa;
        font-size: 0.8rem;
        transition: all 0.2s;
        user-select: none;
        display: inline-block;
        margin: 2px;
    }
    .day-pill.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
</style>

<h3>Bartender Schedule</h3>
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Error:</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        <hr>
        <p class="mb-0">
            <strong>Possible solutions:</strong>
        </p>
        <ul class="mb-0">
            <li>Run the database migration script: <code>Database_Migration_StaffManagement.sql</code></li>
            <li>Check that the database connection is working</li>
            <li>Verify that StaffMembers and StaffShifts tables exist</li>
        </ul>
    </div>
}

<!-- Staff Management Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Bartender Roster</h5>
        <button class="btn btn-success btn-sm" @onclick="OpenAddStaffModal">
            <i class="bi bi-plus-circle"></i> Add Bartender
        </button>
    </div>
    <div class="card-body">
        @{
            var activeStaff = staffMembers.Where(s => s.IsActive).ToList();
            var inactiveStaff = staffMembers.Where(s => !s.IsActive).ToList();
        }

        @if (activeStaff.Any())
        {
            <div class="mb-3">
                <label class="form-label small text-muted text-uppercase fw-bold">Active Bartenders</label>
                <div class="d-flex flex-wrap gap-2 align-items-start">
                    @foreach (var staff in activeStaff)
                    {
                        var isExpanded = expandedStaffId == staff.Id;
                        <div class="roster-pill rounded p-2 d-inline-flex flex-column @(isExpanded ? "expanded shadow-sm border-primary" : "")" style="min-width: 180px;">
                            <div class="d-flex justify-content-between align-items-center" @onclick="() => ToggleStaffExpand(staff.Id)">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-person-circle me-2 text-success"></i>
                                    <span class="fw-bold" style="font-size: 0.9rem;">@staff.Name</span>
                                </div>
                                <i class="bi bi-chevron-down ms-2 small"></i>
                            </div>

                            @if (isExpanded)
                            {
                                <div class="mt-2 border-top pt-2">
                                    <div class="small mb-2">
                                        <div class="text-muted"><i class="bi bi-calendar-plus me-1"></i> Roster: @(staff.CreatedAt.ToShortDateString())</div>
                                        @if (!string.IsNullOrEmpty(staff.PhoneNumber))
                                        {
                                            <div class="text-muted"><i class="bi bi-telephone me-1"></i> @staff.PhoneNumber</div>
                                        }
                                    </div>
                                    <div class="d-grid gap-1">
                                        <button class="btn btn-xs btn-outline-info py-1" style="font-size: 0.75rem;" @onclick="() => ViewHistory(staff)">
                                            <i class="bi bi-clock-history"></i> History & Stats
                                        </button>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary py-1" @onclick="() => EditStaff(staff)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-warning py-1" @onclick="() => DeactivateStaff(staff)" title="Mark as Former">
                                                <i class="bi bi-person-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (inactiveStaff.Any())
        {
            <div class="mt-4">
                <label class="form-label small text-muted text-uppercase fw-bold">Former Bartenders</label>
                <div class="d-flex flex-wrap gap-2 align-items-start">
                    @foreach (var staff in inactiveStaff)
                    {
                        var isExpanded = expandedStaffId == staff.Id;
                        <div class="roster-pill rounded p-2 d-inline-flex flex-column @(isExpanded ? "expanded shadow-sm border-secondary opacity-75" : "opacity-50")" style="min-width: 180px; background: #f8f9fa;">
                            <div class="d-flex justify-content-between align-items-center" @onclick="() => ToggleStaffExpand(staff.Id)">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-person-dash me-2 text-muted"></i>
                                    <span class="fw-bold" style="font-size: 0.9rem;">@staff.Name</span>
                                </div>
                                <i class="bi bi-chevron-down ms-2 small"></i>
                            </div>

                            @if (isExpanded)
                            {
                                <div class="mt-2 border-top pt-2">
                                    <div class="small mb-2">
                                        <span class="badge bg-secondary mb-1">Inactive</span>
                                        <div class="text-muted small">Removed: @(staff.UpdatedAt?.ToShortDateString() ?? "Unk")</div>
                                    </div>
                                    <div class="d-grid gap-1">
                                        <button class="btn btn-xs btn-outline-info py-1" style="font-size: 0.75rem;" @onclick="() => ViewHistory(staff)">
                                            <i class="bi bi-clock-history"></i> View History
                                        </button>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-success py-1" @onclick="() => ReactivateStaff(staff)" title="Restore to Roster">
                                                <i class="bi bi-arrow-counterclockwise"></i>
                                            </button>
                                            <button class="btn btn-outline-danger py-1" @onclick="() => DeleteStaffPermanently(staff.Id)" title="Delete Permanently">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (!activeStaff.Any() && !inactiveStaff.Any())
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No bartenders added yet. Click "Add Bartender" to get started.
            </div>
        }
    </div>
</div>

<!-- Shift Schedule Section -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-primary" @onclick="NavigatePrevious">
                <i class="bi bi-chevron-left"></i> Previous @(viewMode == ViewMode.Week ? "Week" : "Month")
            </button>
            <h4 class="mb-0">@GetCurrentPeriodTitle()</h4>
            <button class="btn btn-primary" @onclick="NavigateNext">
                Next @(viewMode == ViewMode.Week ? "Week" : "Month") <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        <div class="btn-group w-100" role="group">
            <button type="button" class="btn @(viewMode == ViewMode.Week ? "btn-primary" : "btn-outline-primary")" @onclick="() => SwitchView(ViewMode.Week)">
                <i class="bi bi-calendar-week"></i> Week View
            </button>
            <button type="button" class="btn @(viewMode == ViewMode.Month ? "btn-primary" : "btn-outline-primary")" @onclick="() => SwitchView(ViewMode.Month)">
                <i class="bi bi-calendar-month"></i> Month View
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="calendar-container py-3">
            @if (_isLoading)
            {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading shifts...</span>
                </div>
                <p class="mt-2">Loading shifts...</p>
            </div>
        }
        else
        {
                @if (viewMode == ViewMode.Week)
            {
                <!-- Week View -->
                <div class="table-responsive px-3">
                    <table class="table table-bordered text-center mb-0 table-calendar">
                        <thead class="table-light">
                            <tr>
                                @for (int i = 0; i < 7; i++)
                                {
                                    <th scope="col" style="width: 14.28%;">@currentDate.AddDays(i).ToString("ddd, MMM dd")</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                @for (int i = 0; i < 7; i++)
                                {
                                    var day = currentDate.AddDays(i);
                                    var dayShift = weeklyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 1);
                                    <td class="p-2">
                                        <div class="small fw-bold text-primary mb-1">Day Shift</div>
                                        @if (dayShift != null)
                                        {
                                            <div class="shift-card p-1 bg-light border rounded" style="min-width: 0;">
                                                <div class="d-flex justify-content-between align-items-center" style="min-width: 0;">
                                                    <span class="text-truncate me-1" style="flex: 1; text-align: left; min-width: 0; font-size: 0.75rem;" title="@dayShift.StaffName">
                                                        <i class="bi bi-person-fill"></i> @dayShift.StaffName
                                                    </span>
                                                    <div class="btn-group btn-group-sm flex-shrink-0">
                                                        <button class="btn btn-sm p-0 text-primary me-1" @onclick="() => EditShift(dayShift)" title="Change">
                                                            <i class="bi bi-pencil" style="font-size: 0.7rem;"></i>
                                                        </button>
                                                        <button class="btn btn-sm p-0 text-danger" @onclick="() => DeleteShift(dayShift)" title="Remove">
                                                            <i class="bi bi-trash" style="font-size: 0.7rem;"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-primary w-100 py-0" style="font-size: 0.7rem;" @onclick="@(() => AssignDayShift(day))">
                                                <i class="bi bi-plus"></i> Assign
                                            </button>
                                        }
                                    </td>
                                }
                            </tr>
                            <tr>
                                @for (int i = 0; i < 7; i++)
                                {
                                    var day = currentDate.AddDays(i);
                                    var nightShift = weeklyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 2);
                                    <td class="p-2">
                                        <div class="small fw-bold text-info mb-1">Night Shift</div>
                                        @if (nightShift != null)
                                        {
                                            <div class="shift-card p-1 bg-light border rounded" style="min-width: 0;">
                                                <div class="d-flex justify-content-between align-items-center" style="min-width: 0;">
                                                    <span class="text-truncate me-1" style="flex: 1; text-align: left; min-width: 0; font-size: 0.75rem;" title="@nightShift.StaffName">
                                                        <i class="bi bi-moon-fill"></i> @nightShift.StaffName
                                                    </span>
                                                    <div class="btn-group btn-group-sm flex-shrink-0">
                                                        <button class="btn btn-sm p-0 text-primary me-1" @onclick="() => EditShift(nightShift)" title="Change">
                                                            <i class="bi bi-pencil" style="font-size: 0.7rem;"></i>
                                                        </button>
                                                        <button class="btn btn-sm p-0 text-danger" @onclick="() => DeleteShift(nightShift)" title="Remove">
                                                            <i class="bi bi-trash" style="font-size: 0.7rem;"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-info w-100 py-0" style="font-size: 0.7rem;" @onclick="@(() => AssignNightShift(day))">
                                                <i class="bi bi-plus"></i> Assign
                                            </button>
                                        }
                                    </td>
                                }
                            </tr>
                        </tbody>
                    </table>
                </div>
            }
            else if (viewMode == ViewMode.Month)
            {
                <!-- Month View -->
                <div class="month-calendar px-3">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" style="width: 14.28%;">Sun</th>
                                <th class="text-center" style="width: 14.28%;">Mon</th>
                                <th class="text-center" style="width: 14.28%;">Tue</th>
                                <th class="text-center" style="width: 14.28%;">Wed</th>
                                <th class="text-center" style="width: 14.28%;">Thu</th>
                                <th class="text-center" style="width: 14.28%;">Fri</th>
                                <th class="text-center" style="width: 14.28%;">Sat</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var week in GetMonthWeeks())
                            {
                                <tr>
                                    @foreach (var day in week)
                                    {
                                        var isCurrentMonth = day.Month == currentDate.Month;
                                        var dayShift = monthlyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 1);
                                        var nightShift = monthlyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 2);
                                        
                                        <td class="@(isCurrentMonth ? "" : "text-muted bg-light")" style="vertical-align: top; height: 100px !important;">
                                            <div class="fw-bold mb-1" style="font-size: 0.8rem;">@day.Day</div>
                                            @if (isCurrentMonth)
                                            {
                                            <div class="small">
                                                <div class="mb-1">
                                                    @if (dayShift != null)
                                                    {
                                                        <div class="badge bg-primary w-100 d-flex justify-content-between align-items-center mb-1 p-1" style="cursor: default; min-width: 0; font-size: 0.7rem;">
                                                            <span class="text-truncate" style="cursor: pointer; min-width: 0; flex: 1; text-align: left;" @onclick="() => ViewShiftDetails(dayShift)">
                                                                <i class="bi bi-sun"></i> @dayShift.StaffName
                                                            </span>
                                                            <div class="ms-1 flex-shrink-0">
                                                                <i class="bi bi-pencil" style="cursor: pointer;" @onclick="() => EditShift(dayShift)" title="Edit"></i>
                                                                <i class="bi bi-trash ms-1" style="cursor: pointer;" @onclick="() => DeleteShift(dayShift)" title="Delete"></i>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn btn-sm btn-outline-primary w-100 p-0" style="font-size: 0.65rem;" @onclick="@(() => AssignDayShift(day))">
                                                            <i class="bi bi-plus"></i> Day
                                                        </button>
                                                    }
                                                </div>
                                                <div>
                                                    @if (nightShift != null)
                                                    {
                                                        <div class="badge bg-info w-100 d-flex justify-content-between align-items-center p-1 text-dark" style="cursor: default; min-width: 0; font-size: 0.7rem;">
                                                            <span class="text-truncate" style="cursor: pointer; min-width: 0; flex: 1; text-align: left;" @onclick="() => ViewShiftDetails(nightShift)">
                                                                <i class="bi bi-moon"></i> @nightShift.StaffName
                                                            </span>
                                                            <div class="ms-1 flex-shrink-0">
                                                                <i class="bi bi-pencil" style="cursor: pointer;" @onclick="() => EditShift(nightShift)" title="Edit"></i>
                                                                <i class="bi bi-trash ms-1" style="cursor: pointer;" @onclick="() => DeleteShift(nightShift)" title="Delete"></i>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn btn-sm btn-outline-info w-100 p-0" style="font-size: 0.65rem;" @onclick="@(() => AssignNightShift(day))">
                                                            <i class="bi bi-plus"></i> Night
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            }
        }
    </div>
</div>
     <div class="card-footer">
        <button class="btn btn-info" @onclick="ExportReports">
            <i class="bi bi-download"></i> Export Shift Reports
        </button>
    </div>
</div>

<!-- Add/Edit Staff Modal -->
@if (showStaffModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingStaff?.Id > 0 ? "Edit" : "Add") Bartender</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Bartender Type <span class="text-danger">*</span></label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn @(!isExistingMemberMode ? "btn-primary" : "btn-outline-primary")" @onclick="() => SelectBartenderType(false)">
                                <i class="bi bi-person-plus"></i> New Bartender
                            </button>
                            <button type="button" class="btn @(isExistingMemberMode ? "btn-primary" : "btn-outline-primary")" @onclick="() => SelectBartenderType(true)">
                                <i class="bi bi-person-badge"></i> Existing Member
                            </button>
                        </div>
                    </div>

                    @if (isExistingMemberMode)
                    {
                        <div class="mb-3">
                            <label for="memberSelect" class="form-label">Select GFC Member <span class="text-danger">*</span></label>
                            <select id="memberSelect" class="form-select" @bind="selectedMemberId" @bind:after="OnMemberSelected">
                                <option value="0">-- Select a member --</option>
                                @foreach (var member in activeMembers)
                                {
                                    <option value="@member.MemberID">@member.FirstName @member.LastName</option>
                                }
                            </select>
                            <div class="form-text">Link this bartender position to an existing GFC member</div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label for="staffName" class="form-label">Bartender Name <span class="text-danger">*</span></label>
                            <input type="text" id="staffName" class="form-control" @bind="editingStaff.Name" placeholder="Enter bartender name" />
                            <div class="form-text">For non-member bartenders</div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveStaff" disabled="@(string.IsNullOrWhiteSpace(editingStaff?.Name))">
                        <i class="bi bi-check-circle"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Assign Shift Modal -->
@if (showAssignmentModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Shift</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <p>Assigning shift for <strong>@newShift.Date.ToShortDateString() (@(newShift.ShiftType == 1 ? "Day" : "Night") shift)</strong></p>
                    
                    @if (staffMembers.Any())
                    {
                        <div class="mb-3">
                            <label for="staffMember" class="form-label">Select Staff Member <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="selectedStaffId">
                                <option value="0">Select a bartender...</option>
                                @foreach (var staff in staffMembers.Where(s => s.IsActive || (newShift?.Id > 0 && s.Id == newShift.StaffMemberId)))
                                {
                                    <option value="@staff.Id">@staff.Name</option>
                                }
                            </select>
                        </div>
                        
                        @if (newShift?.Id == 0)
                        {
                            <div class="mb-3">
                                <label class="form-label d-block small text-muted text-uppercase fw-bold">Also assign to these days:</label>
                                <div class="d-flex flex-wrap gap-1">
                                    @{
                                        var days = new[] { 
                                            (DayOfWeek.Monday, "Mon"), 
                                            (DayOfWeek.Tuesday, "Tue"), 
                                            (DayOfWeek.Wednesday, "Wed"), 
                                            (DayOfWeek.Thursday, "Thu"), 
                                            (DayOfWeek.Friday, "Fri"), 
                                            (DayOfWeek.Saturday, "Sat"), 
                                            (DayOfWeek.Sunday, "Sun") 
                                        };
                                        foreach (var d in days)
                                        {
                                            var isInitialDay = newShift.Date.DayOfWeek == d.Item1;
                                            var isOccupied = weeklyShifts.Any(s => s.Date.DayOfWeek == d.Item1 && s.ShiftType == newShift.ShiftType);
                                            
                                            // Don't show the day if it's already assigned (unless it's the one we're editing/starting with)
                                            if (isOccupied && !isInitialDay && !targetDays.Contains(d.Item1))
                                            {
                                                <!-- Day is already assigned, skipping -->
                                                continue;
                                            }

                                            <div class="day-pill @(targetDays.Contains(d.Item1) || isInitialDay ? "active" : "") @(isInitialDay ? "opacity-75" : "")" 
                                                 @onclick="() => ToggleTargetDay(d.Item1)">
                                                @d.Item2
                                            </div>
                                        }
                                    }
                                </div>
                                <div class="form-text small mt-2">
                                    <i class="bi bi-info-circle"></i> Days with existing assignments are hidden.
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No staff members available. Please add staff members first.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveShiftAssignment" disabled="@(selectedStaffId == 0)">
                        <i class="bi bi-check-circle"></i> Assign Shift
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Shift Report Modal -->
@if (selectedShiftReport != null)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shift Report</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Staff:</strong> @selectedShiftReport.StaffShift.StaffName</p>
                            <p><strong>Date:</strong> @selectedShiftReport.StaffShift.Date.ToShortDateString()</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Shift:</strong> @(selectedShiftReport.StaffShift.ShiftType == 1 ? "Day" : "Night")</p>
                            <p><strong>Status:</strong> 
                                <span class="badge @(selectedShiftReport.IsLate ? "bg-warning" : "bg-success")">
                                    @(selectedShiftReport.IsLate ? "Late" : "On Time")
                                </span>
                            </p>
                        </div>
                    </div>
                    <hr />
                    <h6>Financial Report</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Bar Sales</h6>
                                    <h4 class="card-title">@selectedShiftReport.BarSales.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Lotto Sales</h6>
                                    <h4 class="card-title">@selectedShiftReport.LottoSales.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Deposit</h6>
                                    <h4 class="card-title">@selectedShiftReport.TotalDeposit.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3"><strong>Submitted:</strong> @selectedShiftReport.SubmittedAt.ToString("g")</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- History Modal -->
@if (showHistoryModal && selectedHistoryStaff != null)
{
    var dayShifts = staffHistory.Count(s => s.ShiftType == 1);
    var nightShifts = staffHistory.Count(s => s.ShiftType == 2);
    var firstShift = staffHistory.OrderBy(s => s.Date).FirstOrDefault();
    var lastShift = staffHistory.OrderByDescending(s => s.Date).FirstOrDefault();

    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-clock-history"></i> Work History: @selectedHistoryStaff.Name
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <!-- Staff Insights Header -->
                    <div class="row g-2 mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light border-0 text-center p-3 h-100">
                                <div class="small text-muted mb-1">Total Shifts</div>
                                <div class="h3 mb-0">@staffHistory.Count</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light border-0 text-center p-3 h-100">
                                <div class="small text-muted mb-1">Day / Night</div>
                                <div class="h5 mb-0">@dayShifts / @nightShifts</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light border-0 text-center p-3 h-100">
                                <div class="small text-muted mb-1">Added to Roster</div>
                                <div class="small fw-bold">@selectedHistoryStaff.CreatedAt.ToShortDateString()</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light border-0 text-center p-3 h-100">
                                <div class="small text-muted mb-1">@(selectedHistoryStaff.IsActive ? "Last Worked" : "Removed On")</div>
                                <div class="small fw-bold text-danger">@(selectedHistoryStaff.IsActive ? (lastShift?.Date.ToShortDateString() ?? "N/A") : (selectedHistoryStaff.UpdatedAt?.ToShortDateString() ?? "N/A"))</div>
                            </div>
                        </div>
                    </div>

                    @if (!selectedHistoryStaff.IsActive)
                    {
                        <div class="alert alert-warning mb-3 py-2 small">
                            <i class="bi bi-info-circle"></i> This person no longer works at GFC as a bartender. History is preserved for auditing.
                        </div>
                    }

                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Date</th>
                                    <th>Shift Type</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (staffHistory == null || !staffHistory.Any())
                                {
                                    <tr>
                                        <td colspan="3" class="text-center py-4 text-muted">No shift history found for this bartender.</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var shift in staffHistory)
                                    {
                                        <tr>
                                            <td>@shift.Date.ToShortDateString()</td>
                                            <td>
                                                <span class="badge @(shift.ShiftType == 1 ? "bg-primary" : "bg-info text-dark")">
                                                    @(shift.ShiftType == 1 ? "Day" : "Night")
                                                </span>
                                            </td>
                                            <td>@shift.Status</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    // View mode enum
    public enum ViewMode
    {
        Week,
        Month
    }

    private bool _isLoading = true;
    private DateTime currentDate = DateTime.Today;
    private List<StaffShift> weeklyShifts = new();
    private List<StaffShift> monthlyShifts = new();
    private List<StaffMember> staffMembers = new();
    private List<Member> activeMembers = new();

    private bool showAssignmentModal = false;
    private bool showStaffModal = false;
    private bool showHistoryModal = false;
    private StaffShift newShift;
    private ShiftReport selectedShiftReport;
    private StaffMember editingStaff = new();
    private StaffMember selectedHistoryStaff;
    private List<StaffShift> staffHistory = new();
    private int selectedStaffId = 0;
    private int selectedMemberId = 0;
    private int expandedStaffId = 0;
    private bool isExistingMemberMode = false;
    private List<DayOfWeek> targetDays = new();
    
    private ViewMode viewMode = ViewMode.Week;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Start week on a Sunday
            currentDate = currentDate.AddDays(-(int)currentDate.DayOfWeek);
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error initializing page: {ex.Message}";
            _isLoading = false;
            StateHasChanged();
        }
    }

    private bool _dataLoading = false;
    private async Task LoadData()
    {
        if (_dataLoading) return;
        
        try
        {
            _dataLoading = true;
            await LoadShifts();
            await LoadStaffMembers();
            await LoadActiveMembers();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
            await ToastService.ShowError(errorMessage);
        }
        finally
        {
            _dataLoading = false;
        }
    }

    private async Task LoadShifts()
    {
        try
        {
            _isLoading = true;
            
            if (viewMode == ViewMode.Week)
            {
                weeklyShifts = (await ShiftService.GetShiftsForWeekAsync(currentDate)).ToList();
            }
            else
            {
                // Load entire month
                var firstDayOfMonth = new DateTime(currentDate.Year, currentDate.Month, 1);
                var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
                
                // Get first Sunday before or on first day of month
                var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
                // Get last Saturday after or on last day of month  
                var endDate = lastDayOfMonth.AddDays(6 - (int)lastDayOfMonth.DayOfWeek);
                
                // Load ALL shifts in the range at once for performance
                var allShifts = await ShiftService.GetShiftsForRangeAsync(startDate, endDate.AddDays(1));
                
                monthlyShifts = allShifts.ToList();
            }
            
            _isLoading = false;
        }
        catch (Exception ex)
        {
            _isLoading = false;
            errorMessage = $"Error loading shifts: {ex.Message}";
            await ToastService.ShowError("Failed to load shifts. Please ensure the database tables exist.");
            weeklyShifts = new List<StaffShift>();
            monthlyShifts = new List<StaffShift>();
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadStaffMembers()
    {
        try
        {
            staffMembers = (await ShiftService.GetAllStaffMembersAsync()).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading staff members: {ex.Message}";
            await ToastService.ShowError("Failed to load bartenders. Please ensure the database tables exist.");
            staffMembers = new List<StaffMember>();
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadActiveMembers()
    {
        try
        {
            // Removed Task.Run to keep DB operations on the primary context thread
            // and prevent DbContext concurrency issues in Blazor Server
            activeMembers = MemberRepository.GetAllMembers()
                .Where(m => m.Status != null && 
                            !m.Status.Equals("INACTIVE", StringComparison.OrdinalIgnoreCase) &&
                            m.DateOfDeath == null)
                .OrderBy(m => m.LastName)
                .ThenBy(m => m.FirstName)
                .ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading members: {ex.Message}";
            await ToastService.ShowError("Failed to load GFC members.");
            activeMembers = new List<Member>();
        }
        finally
        {
            StateHasChanged();
        }
    }

    // View Mode Methods
    private async Task SwitchView(ViewMode mode)
    {
        viewMode = mode;
        
        if (viewMode == ViewMode.Week)
        {
            currentDate = currentDate.AddDays(-(int)currentDate.DayOfWeek);
        }
        await LoadShifts();
    }

    private async Task NavigatePrevious()
    {
        if (viewMode == ViewMode.Week)
        {
            currentDate = currentDate.AddDays(-7);
        }
        else
        {
            currentDate = currentDate.AddMonths(-1);
        }
        await LoadShifts();
    }

    private async Task NavigateNext()
    {
        if (viewMode == ViewMode.Week)
        {
            currentDate = currentDate.AddDays(7);
        }
        else
        {
            currentDate = currentDate.AddMonths(1);
        }
        await LoadShifts();
    }

    private string GetCurrentPeriodTitle()
    {
        if (viewMode == ViewMode.Week)
        {
            var weekEnd = currentDate.AddDays(6);
            return $"{currentDate:MMM dd} - {weekEnd:MMM dd, yyyy}";
        }
        else
        {
            return currentDate.ToString("MMMM yyyy");
        }
    }

    private List<List<DateTime>> GetMonthWeeks()
    {
        var weeks = new List<List<DateTime>>();
        var firstDayOfMonth = new DateTime(currentDate.Year, currentDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        
        // Start from the Sunday before or on the first day of the month
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        
        // End on the Saturday after or on the last day of the month
        var endDate = lastDayOfMonth.AddDays(6 - (int)lastDayOfMonth.DayOfWeek);
        
        var currentDay = startDate;
        while (currentDay <= endDate)
        {
            var week = new List<DateTime>();
            for (int i = 0; i < 7; i++)
            {
                week.Add(currentDay);
                currentDay = currentDay.AddDays(1);
            }
            weeks.Add(week);
        }
        
        return weeks;
    }

    // Staff Management Methods
    private void OpenAddStaffModal()
    {
        editingStaff = new StaffMember { Role = "Bartender", HireDate = DateTime.Today, IsActive = true };
        selectedMemberId = 0;
        isExistingMemberMode = false; // Default to "New Bartender" mode
        showStaffModal = true;
        StateHasChanged();
    }

    private void EditStaff(StaffMember staff)
    {
        editingStaff = new StaffMember 
        { 
            Id = staff.Id, 
            Name = staff.Name, 
            Role = "Bartender",
            PhoneNumber = staff.PhoneNumber,
            Email = staff.Email,
            HourlyRate = staff.HourlyRate,
            IsActive = staff.IsActive,
            HireDate = staff.HireDate,
            Notes = staff.Notes,
            MemberId = staff.MemberId
        };
        selectedMemberId = staff.MemberId ?? 0;
        showStaffModal = true;
        StateHasChanged();
    }

    private void SelectBartenderType(bool isExistingMember)
    {
        isExistingMemberMode = isExistingMember;
        
        if (isExistingMember)
        {
            // Set to 0 to show dropdown with "-- Select a member --" option
            selectedMemberId = 0;
            editingStaff.Name = "";
            editingStaff.MemberId = null;
        }
        else
        {
            selectedMemberId = 0;
            editingStaff.Name = "";
            editingStaff.MemberId = null;
        }
        StateHasChanged();
    }

    private void OnMemberSelected()
    {
        if (selectedMemberId > 0)
        {
            var member = activeMembers.FirstOrDefault(m => m.MemberID == selectedMemberId);
            if (member != null)
            {
                editingStaff.Name = $"{member.FirstName} {member.LastName}";
                editingStaff.MemberId = member.MemberID;
                editingStaff.Email = member.Email;
                editingStaff.PhoneNumber = member.CellPhone ?? member.Phone; // Prefer cell phone, fallback to home phone
            }
        }
    }

    private async Task SaveStaff()
    {
        if (string.IsNullOrWhiteSpace(editingStaff?.Name))
        {
            await ToastService.ShowError("Bartender name is required");
            return;
        }

        try
        {
            // Always set role to Bartender
            editingStaff.Role = "Bartender";
            
            if (editingStaff.Id > 0)
            {
                // Update existing staff
                await ShiftService.UpdateStaffMemberAsync(editingStaff);
                await ToastService.ShowSuccess("Bartender updated successfully");
            }
            else
            {
                // Add new staff
                await ShiftService.CreateStaffMemberAsync(editingStaff);
                await ToastService.ShowSuccess("Bartender added successfully");
            }

            await LoadStaffMembers();
            CloseModals();
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error saving bartender: {ex.Message}");
        }
    }

    private async Task DeleteStaff(int staffId)
    {
        try
        {
            var staff = staffMembers.FirstOrDefault(s => s.Id == staffId);
            if (staff != null)
            {
                await ShiftService.DeleteStaffMemberAsync(staffId);
                await ToastService.ShowSuccess($"{staff.Name} removed from bartender roster");
                await LoadStaffMembers();
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error deleting bartender: {ex.Message}");
        }
    }

    // Shift Assignment Methods
    private void AssignShift(DateTime date, string shiftType)
    {
        if (!staffMembers.Any())
        {
            ToastService.ShowWarning("Please add bartenders before assigning shifts");
            return;
        }

        newShift = new StaffShift { Date = date, ShiftType = shiftType == "Day" ? 1 : 2 };
        selectedStaffId = 0;
        showAssignmentModal = true;
        StateHasChanged();
    }

    private void AssignDayShift(DateTime date)
    {
        AssignShift(date, "Day");
    }

    private void AssignNightShift(DateTime date)
    {
        AssignShift(date, "Night");
    }

    private async Task SaveShiftAssignment()
    {
        Console.WriteLine($"=== SaveShiftAssignment called ===");
        Console.WriteLine($"newShift is null: {newShift == null}");
        Console.WriteLine($"selectedStaffId: {selectedStaffId}");
        
        if (newShift != null && selectedStaffId > 0)
        {
            try
            {
                var selectedStaff = staffMembers.FirstOrDefault(s => s.Id == selectedStaffId);
                Console.WriteLine($"Selected staff: {selectedStaff?.Name ?? "NULL"}");
                
                if (selectedStaff != null)
                {
                    newShift.StaffName = selectedStaff.Name;
                    newShift.StaffMemberId = selectedStaff.Id;
                    newShift.Status = "Scheduled";
                    
                    Console.WriteLine($"Saving shift:");
                    Console.WriteLine($"  - Date: {newShift.Date:yyyy-MM-dd}");
                    Console.WriteLine($"  - ShiftType: {newShift.ShiftType} ({(newShift.ShiftType == 1 ? "Day" : "Night")})");
                    Console.WriteLine($"  - StaffMemberId: {newShift.StaffMemberId}");
                    Console.WriteLine($"  - StaffName: {newShift.StaffName}");
                    Console.WriteLine($"  - Status: {newShift.Status}");
                    
                    if (newShift.Id > 0)
                    {
                        // Update existing shift
                        await ShiftService.UpdateStaffShiftAsync(newShift);
                        await ToastService.ShowSuccess($"Shift updated for {selectedStaff.Name} on {newShift.Date:MMM dd}");
                    }
                    else
                    {
                        // Calculate Monday of this week to use as base for target days
                        var dayOfWeek = (int)newShift.Date.DayOfWeek;
                        var diff = (dayOfWeek == 0) ? -6 : 1 - dayOfWeek;
                        var mondayOfThisWeek = newShift.Date.AddDays(diff);
                        
                        // Combine initial day with target days
                        var allTargetDays = new List<DayOfWeek>(targetDays);
                        if (!allTargetDays.Contains(newShift.Date.DayOfWeek))
                        {
                            allTargetDays.Add(newShift.Date.DayOfWeek);
                        }

                        int createdCount = 0;
                        var existingShiftsInWeek = (await ShiftService.GetShiftsForWeekAsync(mondayOfThisWeek)).ToList();

                        foreach (var day in allTargetDays)
                        {
                            // Find the specific date for this day of week in the current week
                            int offset = (day == DayOfWeek.Sunday) ? 6 : (int)day - 1;
                            var targetDate = mondayOfThisWeek.AddDays(offset);
                            
                            // Check if shift already exists
                            if (!existingShiftsInWeek.Any(s => s.Date.Date == targetDate.Date && s.ShiftType == newShift.ShiftType))
                            {
                                var shiftToAdd = new StaffShift
                                {
                                    Date = targetDate,
                                    ShiftType = newShift.ShiftType,
                                    StaffMemberId = selectedStaff.Id,
                                    StaffName = selectedStaff.Name,
                                    Status = "Scheduled"
                                };
                                await ShiftService.CreateStaffShiftAsync(shiftToAdd);
                                createdCount++;
                            }
                        }
                        
                        if (createdCount > 1)
                            await ToastService.ShowSuccess($"Assigned {selectedStaff.Name} to {createdCount} shifts.");
                        else if (createdCount == 1)
                            await ToastService.ShowSuccess($"Assigned {selectedStaff.Name} to shift.");
                    }
                    
                    targetDays.Clear();
                    CloseModals();
                    await LoadShifts();
                }
                else
                {
                    await ToastService.ShowError("Selected bartender not found");
                }
            }
            catch (Exception ex)
            {
                await ToastService.ShowError($"Error saving shift: {ex.Message}");
                Console.WriteLine($"SaveShiftAssignment Error: {ex}");
            }
        }
        else
        {
            await ToastService.ShowWarning("Please select a bartender");
            Console.WriteLine($"Validation failed - newShift null or selectedStaffId = 0");
        }
    }

    private async Task ViewHistory(StaffMember staff)
    {
        try
        {
            selectedHistoryStaff = staff;
            var allShifts = await ShiftService.GetStaffShiftsAsync();
            staffHistory = allShifts
                .Where(s => s.StaffMemberId == staff.Id)
                .OrderByDescending(s => s.Date)
                .ToList();
            showHistoryModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ToastService.ShowError("Could not load history");
            await JSRuntime.InvokeVoidAsync("console.error", ex.ToString());
        }
    }

    private async Task ViewShiftDetails(StaffShift shift)
    {
        try
        {
            if (shift == null)
            {
                await ToastService.ShowWarning("Shift not found");
                return;
            }

            var report = await ShiftService.GetShiftReportAsync(shift.Id);
            if (report != null)
            {
                selectedShiftReport = report;
                StateHasChanged();
            }
            else
            {
                await ToastService.ShowInfo($"No report available for {shift.StaffName ?? "this shift"} on {shift.Date:MMM dd}");
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error loading shift details: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("console.error", $"ViewShiftDetails Error: {ex}");
        }
    }

    private void EditShift(StaffShift shift)
    {
        if (shift == null) return;
        
        // Open assignment modal with current shift
        newShift = shift;
        selectedStaffId = shift.StaffMemberId;
        showAssignmentModal = true;
        StateHasChanged();
    }

    private async Task DeactivateStaff(StaffMember staff)
    {
        if (staff == null) return;
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to mark {staff.Name} as a Former Bartender? They will be removed from the active roster but their history will be preserved.");
        if (confirmed)
        {
            staff.IsActive = false;
            await ShiftService.UpdateStaffMemberAsync(staff);
            await ToastService.ShowSuccess($"{staff.Name} marked as former bartender.");
            await LoadData();
        }
    }

    private async Task ReactivateStaff(StaffMember staff)
    {
        if (staff == null) return;
        staff.IsActive = true;
        await ShiftService.UpdateStaffMemberAsync(staff);
        await ToastService.ShowSuccess($"{staff.Name} restored to active roster.");
        await LoadData();
    }

    private async Task DeleteStaffPermanently(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "WARNING: This will permanently delete this person and ALL their shift history from the database. This cannot be undone. Are you sure?");
        if (confirmed)
        {
            await ShiftService.DeleteStaffMemberAsync(id);
            await ToastService.ShowSuccess("Bartender and history deleted permanently.");
            await LoadData();
        }
    }

    private async Task DeleteShift(StaffShift shift)
    {
        if (shift == null) return;

        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                $"Remove {shift.StaffName ?? "this bartender"} from {shift.Date:MMM dd} {(shift.ShiftType == 1 ? "Day" : "Night")} shift?");
            
            if (confirmed)
            {
                await ShiftService.DeleteStaffShiftAsync(shift.Id);
                await ToastService.ShowSuccess("Shift removed");
                await LoadShifts();
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error removing shift: {ex.Message}");
        }
    }

    private void CloseModals()
    {
        showAssignmentModal = false;
        showStaffModal = false;
        showHistoryModal = false;
        selectedShiftReport = null;
        editingStaff = new();
        selectedHistoryStaff = null;
        staffHistory.Clear();
        selectedStaffId = 0;
        selectedMemberId = 0;
        targetDays.Clear();
        StateHasChanged();
    }

    private void ToggleTargetDay(DayOfWeek day)
    {
        // Don't toggle the day we initially picked
        if (newShift != null && newShift.Date.DayOfWeek == day) return;

        if (targetDays.Contains(day))
            targetDays.Remove(day);
        else
            targetDays.Add(day);
    }

    private async Task ExportReports()
    {
        var reports = await ShiftService.GetShiftReportsForExportAsync(currentDate, currentDate.AddDays(7));
        
        if (!reports.Any())
        {
            await ToastService.ShowWarning("No shift reports available for export");
            return;
        }

        var csvBuilder = new System.Text.StringBuilder();
        csvBuilder.AppendLine("Date,ShiftType,Bartender,BarSales,LottoSales,TotalDeposit,SubmittedAt,Status");
        
        foreach (var report in reports)
        {
            var date = report.StaffShift.Date.ToString("yyyy-MM-dd");
            var type = report.StaffShift.ShiftType == 1 ? "Day" : "Night";
            var staff = report.StaffShift.StaffName;
            var status = report.IsLate ? "Late" : "On Time";
            csvBuilder.AppendLine($"{date},{type},{staff},{report.BarSales},{report.LottoSales},{report.TotalDeposit},{report.SubmittedAt:yyyy-MM-dd HH:mm},{status}");
        }

        var csvBytes = System.Text.Encoding.UTF8.GetBytes(csvBuilder.ToString());
        var base64 = System.Convert.ToBase64String(csvBytes);

        var fileName = $"BartenderShiftReports_{currentDate:yyyy-MM-dd}.csv";
        await JSRuntime.InvokeVoidAsync("saveAsFile", fileName, base64);
        await ToastService.ShowSuccess($"Exported {reports.Count()} shift reports");
    }
    private void ToggleStaffExpand(int id)
    {
        if (expandedStaffId == id)
            expandedStaffId = 0;
        else
            expandedStaffId = id;
    }
}
