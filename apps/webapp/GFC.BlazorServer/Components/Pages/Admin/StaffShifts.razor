// [NEW]
@page "/admin/staff-shifts"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "RequireAdmin")]
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Data.Entities
@using GFC.Core.Interfaces
@inject IShiftService ShiftService
@inject IMemberRepository MemberRepository
@inject ToastService ToastService
@inject IJSRuntime JSRuntime

<h3>Bartender Schedule</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Error:</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        <hr>
        <p class="mb-0">
            <strong>Possible solutions:</strong>
        </p>
        <ul class="mb-0">
            <li>Run the database migration script: <code>Database_Migration_StaffManagement.sql</code></li>
            <li>Check that the database connection is working</li>
            <li>Verify that StaffMembers and StaffShifts tables exist</li>
        </ul>
    </div>
}

<!-- Staff Management Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Bartender Roster</h5>
        <button class="btn btn-success btn-sm" @onclick="OpenAddStaffModal">
            <i class="bi bi-plus-circle"></i> Add Bartender
        </button>
    </div>
    <div class="card-body">
        @if (staffMembers.Any())
        {
            <div class="row">
                @foreach (var staff in staffMembers)
                {
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">@staff.Name</h6>
                                @if (staff.MemberId.HasValue)
                                {
                                    <p class="card-text text-muted mb-2">
                                        <i class="bi bi-person-badge"></i> GFC Member
                                    </p>
                                }
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" @onclick="() => EditStaff(staff)">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger" @onclick="() => DeleteStaff(staff.Id)">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No bartenders added yet. Click "Add Bartender" to get started.
            </div>
        }
    </div>
</div>

<!-- Shift Schedule Section -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-primary" @onclick="NavigatePrevious">
                <i class="bi bi-chevron-left"></i> Previous @(viewMode == ViewMode.Week ? "Week" : "Month")
            </button>
            <h4 class="mb-0">@GetCurrentPeriodTitle()</h4>
            <button class="btn btn-primary" @onclick="NavigateNext">
                Next @(viewMode == ViewMode.Week ? "Week" : "Month") <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        <div class="btn-group w-100" role="group">
            <button type="button" class="btn @(viewMode == ViewMode.Week ? "btn-primary" : "btn-outline-primary")" @onclick="() => SwitchView(ViewMode.Week)">
                <i class="bi bi-calendar-week"></i> Week View
            </button>
            <button type="button" class="btn @(viewMode == ViewMode.Month ? "btn-primary" : "btn-outline-primary")" @onclick="() => SwitchView(ViewMode.Month)">
                <i class="bi bi-calendar-month"></i> Month View
            </button>
        </div>
    </div>
    <div class="card-body">
        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading shifts...</span>
                </div>
                <p class="mt-2">Loading shifts...</p>
            </div>
        }
        else
        {
            @if (viewMode == ViewMode.Week)
            {
                <!-- Week View -->
                <div class="table-responsive">
                    <table class="table table-bordered text-center">
                        <thead class="table-light">
                            <tr>
                                @for (int i = 0; i < 7; i++)
                                {
                                    <th scope="col">@currentDate.AddDays(i).ToString("ddd, MMM dd")</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                @for (int i = 0; i < 7; i++)
                                {
                                    var day = currentDate.AddDays(i);
                                    var dayShift = weeklyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 1);
                                    <td>
                                        <strong class="text-primary">Day Shift</strong><br>
                                        @if (dayShift != null)
                                        {
                                            <div class="shift-card mt-2 p-2 bg-light border rounded" @onclick="() => ViewShiftDetails(dayShift)" style="cursor: pointer;">
                                                <i class="bi bi-person-fill"></i> @dayShift.StaffName
                                            </div>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-success mt-2" @onclick="@(() => AssignDayShift(day))">
                                                <i class="bi bi-plus-circle"></i> Assign
                                            </button>
                                        }
                                    </td>
                                }
                            </tr>
                            <tr>
                                @for (int i = 0; i < 7; i++)
                                {
                                    var day = currentDate.AddDays(i);
                                    var nightShift = weeklyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 2);
                                    <td>
                                        <strong class="text-info">Night Shift</strong><br>
                                        @if (nightShift != null)
                                        {
                                            <div class="shift-card mt-2 p-2 bg-light border rounded" @onclick="() => ViewShiftDetails(nightShift)" style="cursor: pointer;">
                                                <i class="bi bi-moon-fill"></i> @nightShift.StaffName
                                            </div>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-success mt-2" @onclick="@(() => AssignNightShift(day))">
                                                <i class="bi bi-plus-circle"></i> Assign
                                            </button>
                                        }
                                    </td>
                                }
                            </tr>
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <!-- Month View -->
                <div class="month-calendar">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Sunday</th>
                                <th class="text-center">Monday</th>
                                <th class="text-center">Tuesday</th>
                                <th class="text-center">Wednesday</th>
                                <th class="text-center">Thursday</th>
                                <th class="text-center">Friday</th>
                                <th class="text-center">Saturday</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var week in GetMonthWeeks())
                            {
                                <tr>
                                    @foreach (var day in week)
                                    {
                                        var isCurrentMonth = day.Month == currentDate.Month;
                                        var dayShift = monthlyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 1);
                                        var nightShift = monthlyShifts.FirstOrDefault(s => s.Date.Date == day.Date && s.ShiftType == 2);
                                        
                                        <td class="@(isCurrentMonth ? "" : "text-muted bg-light")" style="vertical-align: top; height: 120px;">
                                            <div class="fw-bold mb-2">@day.Day</div>
                                            @if (isCurrentMonth)
                                            {
                                                <div class="small">
                                                    <div class="mb-1">
                                                        @if (dayShift != null)
                                                        {
                                                            <div class="badge bg-primary text-truncate w-100" @onclick="() => ViewShiftDetails(dayShift)" style="cursor: pointer;">
                                                                <i class="bi bi-sun"></i> @dayShift.StaffName
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <button class="btn btn-sm btn-outline-primary w-100 py-0" @onclick="@(() => AssignDayShift(day))">
                                                                <i class="bi bi-plus"></i> Day
                                                            </button>
                                                        }
                                                    </div>
                                                    <div>
                                                        @if (nightShift != null)
                                                        {
                                                            <div class="badge bg-info text-truncate w-100" @onclick="() => ViewShiftDetails(nightShift)" style="cursor: pointer;">
                                                                <i class="bi bi-moon"></i> @nightShift.StaffName
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <button class="btn btn-sm btn-outline-info w-100 py-0" @onclick="@(() => AssignNightShift(day))">
                                                                <i class="bi bi-plus"></i> Night
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
    </div>
     <div class="card-footer">
        <button class="btn btn-info" @onclick="ExportReports">
            <i class="bi bi-download"></i> Export Shift Reports
        </button>
    </div>
</div>

<!-- Add/Edit Staff Modal -->
@if (showStaffModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingStaff?.Id > 0 ? "Edit" : "Add") Bartender</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Bartender Type <span class="text-danger">*</span></label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn @(!isExistingMemberMode ? "btn-primary" : "btn-outline-primary")" @onclick="() => SelectBartenderType(false)">
                                <i class="bi bi-person-plus"></i> New Bartender
                            </button>
                            <button type="button" class="btn @(isExistingMemberMode ? "btn-primary" : "btn-outline-primary")" @onclick="() => SelectBartenderType(true)">
                                <i class="bi bi-person-badge"></i> Existing Member
                            </button>
                        </div>
                    </div>

                    @if (isExistingMemberMode)
                    {
                        <div class="mb-3">
                            <label for="memberSelect" class="form-label">Select GFC Member <span class="text-danger">*</span></label>
                            <select id="memberSelect" class="form-select" @bind="selectedMemberId" @bind:after="OnMemberSelected">
                                <option value="0">-- Select a member --</option>
                                @foreach (var member in activeMembers)
                                {
                                    <option value="@member.MemberID">@member.FirstName @member.LastName</option>
                                }
                            </select>
                            <div class="form-text">Link this bartender position to an existing GFC member</div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label for="staffName" class="form-label">Bartender Name <span class="text-danger">*</span></label>
                            <input type="text" id="staffName" class="form-control" @bind="editingStaff.Name" placeholder="Enter bartender name" />
                            <div class="form-text">For non-member bartenders</div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveStaff" disabled="@(string.IsNullOrWhiteSpace(editingStaff?.Name))">
                        <i class="bi bi-check-circle"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Assign Shift Modal -->
@if (showAssignmentModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Shift</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <p>Assigning shift for <strong>@newShift.Date.ToShortDateString() (@(newShift.ShiftType == 1 ? "Day" : "Night") shift)</strong></p>
                    
                    @if (staffMembers.Any())
                    {
                        <div class="mb-3">
                            <label for="staffMember" class="form-label">Select Staff Member <span class="text-danger">*</span></label>
                            <select id="staffMember" class="form-select" @bind="selectedStaffId">
                                <option value="0">-- Select a staff member --</option>
                                @foreach (var staff in staffMembers)
                                {
                                    <option value="@staff.Id">@staff.Name (@staff.Role)</option>
                                }
                            </select>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No staff members available. Please add staff members first.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveShiftAssignment" disabled="@(selectedStaffId == 0)">
                        <i class="bi bi-check-circle"></i> Assign Shift
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Shift Report Modal -->
@if (selectedShiftReport != null)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shift Report</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Staff:</strong> @selectedShiftReport.StaffShift.StaffName</p>
                            <p><strong>Date:</strong> @selectedShiftReport.StaffShift.Date.ToShortDateString()</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Shift:</strong> @(selectedShiftReport.StaffShift.ShiftType == 1 ? "Day" : "Night")</p>
                            <p><strong>Status:</strong> 
                                <span class="badge @(selectedShiftReport.IsLate ? "bg-warning" : "bg-success")">
                                    @(selectedShiftReport.IsLate ? "Late" : "On Time")
                                </span>
                            </p>
                        </div>
                    </div>
                    <hr />
                    <h6>Financial Report</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Bar Sales</h6>
                                    <h4 class="card-title">@selectedShiftReport.BarSales.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Lotto Sales</h6>
                                    <h4 class="card-title">@selectedShiftReport.LottoSales.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Deposit</h6>
                                    <h4 class="card-title">@selectedShiftReport.TotalDeposit.ToString("C")</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3"><strong>Submitted:</strong> @selectedShiftReport.SubmittedAt.ToString("g")</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    // View mode enum
    public enum ViewMode
    {
        Week,
        Month
    }

    private bool _isLoading = true;
    private DateTime currentDate = DateTime.Today;
    private List<StaffShift> weeklyShifts = new();
    private List<StaffShift> monthlyShifts = new();
    private List<StaffMember> staffMembers = new();
    private List<Member> activeMembers = new();

    private bool showAssignmentModal = false;
    private bool showStaffModal = false;
    private StaffShift newShift;
    private ShiftReport selectedShiftReport;
    private StaffMember editingStaff = new();
    private int selectedStaffId = 0;
    private int selectedMemberId = 0;
    private bool isExistingMemberMode = false;
    
    private ViewMode viewMode = ViewMode.Week;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Start week on a Sunday
            currentDate = currentDate.AddDays(-(int)currentDate.DayOfWeek);
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error initializing page: {ex.Message}";
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadData()
    {
        try
        {
            await LoadShifts();
            await LoadStaffMembers();
            await LoadActiveMembers();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
            await ToastService.ShowError(errorMessage);
        }
    }

    private async Task LoadShifts()
    {
        try
        {
            _isLoading = true;
            
            if (viewMode == ViewMode.Week)
            {
                weeklyShifts = (await ShiftService.GetShiftsForWeekAsync(currentDate)).ToList();
                Console.WriteLine($"Loaded {weeklyShifts.Count} shifts for week starting {currentDate:MMM dd}");
                foreach (var shift in weeklyShifts)
                {
                    Console.WriteLine($"  - Shift {shift.Id}: {shift.StaffName} on {shift.Date:MMM dd} ({(shift.ShiftType == 1 ? "Day" : "Night")})");
                }
            }
            else
            {
                // Load entire month
                var firstDayOfMonth = new DateTime(currentDate.Year, currentDate.Month, 1);
                var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
                
                // Get first Sunday before or on first day of month
                var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
                // Get last Saturday after or on last day of month
                var endDate = lastDayOfMonth.AddDays(6 - (int)lastDayOfMonth.DayOfWeek);
                
                monthlyShifts = (await ShiftService.GetShiftsForWeekAsync(startDate))
                    .Where(s => s.Date >= startDate && s.Date <= endDate)
                    .ToList();
                Console.WriteLine($"Loaded {monthlyShifts.Count} shifts for month {currentDate:MMMM yyyy}");
            }
            
            _isLoading = false;
        }
        catch (Exception ex)
        {
            _isLoading = false;
            errorMessage = $"Error loading shifts: {ex.Message}";
            await ToastService.ShowError("Failed to load shifts. Please ensure the database tables exist.");
            weeklyShifts = new List<StaffShift>();
            monthlyShifts = new List<StaffShift>();
            Console.WriteLine($"LoadShifts Error: {ex}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadStaffMembers()
    {
        try
        {
            staffMembers = (await ShiftService.GetAssignableStaffAsync()).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading staff members: {ex.Message}";
            await ToastService.ShowError("Failed to load bartenders. Please ensure the database tables exist.");
            staffMembers = new List<StaffMember>();
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadActiveMembers()
    {
        try
        {
            await Task.Run(() =>
            {
                // Get all members except INACTIVE and those with DateOfDeath
                activeMembers = MemberRepository.GetAllMembers()
                    .Where(m => m.Status != null && 
                                !m.Status.Equals("INACTIVE", StringComparison.OrdinalIgnoreCase) &&
                                m.DateOfDeath == null)
                    .OrderBy(m => m.LastName)
                    .ThenBy(m => m.FirstName)
                    .ToList();
            });
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading members: {ex.Message}";
            await ToastService.ShowError("Failed to load GFC members.");
            activeMembers = new List<Member>();
        }
        finally
        {
            StateHasChanged();
        }
    }

    // View Mode Methods
    private async Task SwitchView(ViewMode mode)
    {
        viewMode = mode;
        
        if (mode == ViewMode.Month)
        {
            // Adjust to first day of current month
            currentDate = new DateTime(currentDate.Year, currentDate.Month, 1);
        }
        else
        {
            // Adjust to Sunday of current week
            currentDate = currentDate.AddDays(-(int)currentDate.DayOfWeek);
        }
        
        await LoadShifts();
    }

    private async Task NavigatePrevious()
    {
        if (viewMode == ViewMode.Week)
        {
            currentDate = currentDate.AddDays(-7);
        }
        else
        {
            currentDate = currentDate.AddMonths(-1);
        }
        await LoadShifts();
    }

    private async Task NavigateNext()
    {
        if (viewMode == ViewMode.Week)
        {
            currentDate = currentDate.AddDays(7);
        }
        else
        {
            currentDate = currentDate.AddMonths(1);
        }
        await LoadShifts();
    }

    private string GetCurrentPeriodTitle()
    {
        if (viewMode == ViewMode.Week)
        {
            var weekEnd = currentDate.AddDays(6);
            return $"{currentDate:MMM dd} - {weekEnd:MMM dd, yyyy}";
        }
        else
        {
            return currentDate.ToString("MMMM yyyy");
        }
    }

    private List<List<DateTime>> GetMonthWeeks()
    {
        var weeks = new List<List<DateTime>>();
        var firstDayOfMonth = new DateTime(currentDate.Year, currentDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        
        // Start from the Sunday before or on the first day of the month
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        
        // End on the Saturday after or on the last day of the month
        var endDate = lastDayOfMonth.AddDays(6 - (int)lastDayOfMonth.DayOfWeek);
        
        var currentDay = startDate;
        while (currentDay <= endDate)
        {
            var week = new List<DateTime>();
            for (int i = 0; i < 7; i++)
            {
                week.Add(currentDay);
                currentDay = currentDay.AddDays(1);
            }
            weeks.Add(week);
        }
        
        return weeks;
    }

    // Staff Management Methods
    private void OpenAddStaffModal()
    {
        editingStaff = new StaffMember { Role = "Bartender" };
        selectedMemberId = 0;
        isExistingMemberMode = false; // Default to "New Bartender" mode
        showStaffModal = true;
        StateHasChanged();
    }

    private void EditStaff(StaffMember staff)
    {
        editingStaff = new StaffMember 
        { 
            Id = staff.Id, 
            Name = staff.Name, 
            Role = "Bartender",
            PhoneNumber = staff.PhoneNumber,
            Email = staff.Email,
            HourlyRate = staff.HourlyRate,
            IsActive = staff.IsActive,
            HireDate = staff.HireDate,
            Notes = staff.Notes,
            MemberId = staff.MemberId
        };
        selectedMemberId = staff.MemberId ?? 0;
        showStaffModal = true;
        StateHasChanged();
    }

    private void SelectBartenderType(bool isExistingMember)
    {
        isExistingMemberMode = isExistingMember;
        
        if (isExistingMember)
        {
            // Set to 0 to show dropdown with "-- Select a member --" option
            selectedMemberId = 0;
            editingStaff.Name = "";
            editingStaff.MemberId = null;
        }
        else
        {
            selectedMemberId = 0;
            editingStaff.Name = "";
            editingStaff.MemberId = null;
        }
        StateHasChanged();
    }

    private void OnMemberSelected()
    {
        if (selectedMemberId > 0)
        {
            var member = activeMembers.FirstOrDefault(m => m.MemberID == selectedMemberId);
            if (member != null)
            {
                editingStaff.Name = $"{member.FirstName} {member.LastName}";
                editingStaff.MemberId = member.MemberID;
                editingStaff.Email = member.Email;
                editingStaff.PhoneNumber = member.CellPhone ?? member.Phone; // Prefer cell phone, fallback to home phone
            }
        }
    }

    private async Task SaveStaff()
    {
        if (string.IsNullOrWhiteSpace(editingStaff?.Name))
        {
            await ToastService.ShowError("Bartender name is required");
            return;
        }

        try
        {
            // Always set role to Bartender
            editingStaff.Role = "Bartender";
            
            if (editingStaff.Id > 0)
            {
                // Update existing staff
                await ShiftService.UpdateStaffMemberAsync(editingStaff);
                await ToastService.ShowSuccess("Bartender updated successfully");
            }
            else
            {
                // Add new staff
                await ShiftService.CreateStaffMemberAsync(editingStaff);
                await ToastService.ShowSuccess("Bartender added successfully");
            }

            await LoadStaffMembers();
            CloseModals();
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error saving bartender: {ex.Message}");
        }
    }

    private async Task DeleteStaff(int staffId)
    {
        try
        {
            var staff = staffMembers.FirstOrDefault(s => s.Id == staffId);
            if (staff != null)
            {
                await ShiftService.DeleteStaffMemberAsync(staffId);
                await ToastService.ShowSuccess($"{staff.Name} removed from bartender roster");
                await LoadStaffMembers();
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error deleting bartender: {ex.Message}");
        }
    }

    // Shift Assignment Methods
    private void AssignShift(DateTime date, string shiftType)
    {
        if (!staffMembers.Any())
        {
            ToastService.ShowWarning("Please add bartenders before assigning shifts");
            return;
        }

        newShift = new StaffShift { Date = date, ShiftType = shiftType == "Day" ? 1 : 2 };
        selectedStaffId = 0;
        showAssignmentModal = true;
        StateHasChanged();
    }

    private void AssignDayShift(DateTime date)
    {
        AssignShift(date, "Day");
    }

    private void AssignNightShift(DateTime date)
    {
        AssignShift(date, "Night");
    }

    private async Task SaveShiftAssignment()
    {
        if (newShift != null && selectedStaffId > 0)
        {
            try
            {
                var selectedStaff = staffMembers.FirstOrDefault(s => s.Id == selectedStaffId);
                if (selectedStaff != null)
                {
                    newShift.StaffName = selectedStaff.Name;
                    newShift.StaffMemberId = selectedStaff.Id;
                    newShift.Status = "Scheduled"; // Add default status
                    
                    await ShiftService.CreateStaffShiftAsync(newShift);
                    await ToastService.ShowSuccess($"Shift assigned to {selectedStaff.Name} on {newShift.Date:MMM dd}");
                    CloseModals();
                    await LoadShifts();
                }
                else
                {
                    await ToastService.ShowError("Selected bartender not found");
                }
            }
            catch (Exception ex)
            {
                await ToastService.ShowError($"Error assigning shift: {ex.Message}");
                // Log the full exception for debugging
                Console.WriteLine($"SaveShiftAssignment Error: {ex}");
            }
        }
        else
        {
            await ToastService.ShowWarning("Please select a bartender");
        }
    }

    private async Task ViewShiftDetails(StaffShift shift)
    {
        var report = await ShiftService.GetShiftReportAsync(shift.Id);
        if (report != null)
        {
            selectedShiftReport = report;
            StateHasChanged();
        }
        else
        {
            await ToastService.ShowInfo("No report available for this shift yet");
        }
    }

    private void CloseModals()
    {
        showAssignmentModal = false;
        showStaffModal = false;
        selectedShiftReport = null;
        editingStaff = new();
        selectedStaffId = 0;
        selectedMemberId = 0;
        StateHasChanged();
    }

    private async Task ExportReports()
    {
        var reports = await ShiftService.GetShiftReportsForExportAsync(currentDate, currentDate.AddDays(7));
        
        if (!reports.Any())
        {
            await ToastService.ShowWarning("No shift reports available for export");
            return;
        }

        var csvBuilder = new System.Text.StringBuilder();
        csvBuilder.AppendLine("Date,ShiftType,Bartender,BarSales,LottoSales,TotalDeposit,SubmittedAt,Status");
        
        foreach (var report in reports)
        {
            var date = report.StaffShift.Date.ToString("yyyy-MM-dd");
            var type = report.StaffShift.ShiftType == 1 ? "Day" : "Night";
            var staff = report.StaffShift.StaffName;
            var status = report.IsLate ? "Late" : "On Time";
            csvBuilder.AppendLine($"{date},{type},{staff},{report.BarSales},{report.LottoSales},{report.TotalDeposit},{report.SubmittedAt:yyyy-MM-dd HH:mm},{status}");
        }

        var csvBytes = System.Text.Encoding.UTF8.GetBytes(csvBuilder.ToString());
        var base64 = System.Convert.ToBase64String(csvBytes);

        var fileName = $"BartenderShiftReports_{currentDate:yyyy-MM-dd}.csv";
        await JSRuntime.InvokeVoidAsync("saveAsFile", fileName, base64);
        await ToastService.ShowSuccess($"Exported {reports.Count()} shift reports");
    }
}
