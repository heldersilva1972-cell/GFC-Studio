// [MODIFIED] Modern Hall Rental Management Dashboard
@page "/admin/hall-management"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "RequireAdmin")]
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject IRentalService RentalService
@inject ToastService ToastService
@inject IJSRuntime JSRuntime
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<div class="management-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Hall Rental Management</h2>
            <p class="text-muted small mb-0">Manage bookings, view schedule, and process inquiries.</p>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="text-end d-none d-md-block">
                <div class="text-muted small">Systems Status: <span class="text-success fw-bold">Online</span></div>
                <div class="text-muted extra-small">Last Sync: @lastUpdated.ToString("h:mm:ss tt")</div>
            </div>
            <button class="btn btn-white shadow-sm border rounded-pill px-3" @onclick="RefreshData">
                <i class="bi bi-arrow-clockwise me-1"></i> Sync Data
            </button>
        </div>
    </div>

    <!-- Stats Summary Row -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="stat-card stat-pending clickable" @onclick="() => ShowFilteredList(FilterType.Pending)">
                <div class="stat-icon">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Pending Requests</div>
                    <div class="stat-value">@_pendingCount</div>
                </div>
                <i class="bi bi-chevron-right stat-arrow"></i>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card stat-success clickable" @onclick="() => ShowFilteredList(FilterType.Approved)">
                <div class="stat-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Approved Rentals</div>
                    <div class="stat-value">@_approvedCount</div>
                </div>
                <i class="bi bi-chevron-right stat-arrow"></i>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card stat-warning clickable" @onclick="() => ShowFilteredList(FilterType.ClubEvents)">
                <div class="stat-icon">
                    <i class="bi bi-star-fill"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Club Events</div>
                    <div class="stat-value">@_clubEventsCount</div>
                </div>
                <i class="bi bi-chevron-right stat-arrow"></i>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card stat-info clickable" @onclick="() => ShowFilteredList(FilterType.All)">
                <div class="stat-icon">
                    <i class="bi bi-calendar3"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Bookings</div>
                    <div class="stat-value">@_totalBookings</div>
                </div>
                <i class="bi bi-chevron-right stat-arrow"></i>
            </div>
        </div>
    </div>

    @if (_showFilteredModal)
    {
        <div class="modal-overlay" @onclick="() => _showFilteredModal = false">
            <div class="modal-container modal-medium modal-modern" @onclick:stopPropagation="true">
                <div class="modal-header-gradient">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="modal-title-section">
                            <i class="bi bi-filter-circle modal-icon"></i>
                            <h3>@GetFilterTitle()</h3>
                        </div>
                        <button class="btn-close-pill" @onclick="() => _showFilteredModal = false">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div class="filtered-list">
                        @foreach (var item in GetFilteredItems())
                        {
                            <div class="filtered-item" @onclick="() => SelectFilteredItem(item)">
                                @if (item is HallRentalRequest request)
                                {
                                    <span>@request.ApplicantName - @request.RequestedDate.ToShortDateString()</span>
                                }
                                else if (item is AvailabilityCalendar clubEvent)
                                {
                                    <span>@clubEvent.Description - @clubEvent.Date.ToShortDateString()</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="row g-4">
        <!-- Main Content Area (Table & Filters) -->
        <div class="col-xl-8">
            <div class="card content-card">
                <div class="card-header bg-white border-0 pt-4 px-4 pb-2">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                        <h5 class="fw-bold mb-0">Booking Requests</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <InputSelect class="form-select form-select-sm border-0 bg-light rounded-pill px-3" style="width: auto;" @bind-Value="selectedStatus" @bind-Value:after="ApplyFilters">
                                <option value="">All Statuses</option>
                                <option value="@RentalStatus.Pending">Pending Only</option>
                                <option value="@RentalStatus.Approved">Approved Only</option>
                                <option value="@RentalStatus.Denied">Denied Only</option>
                            </InputSelect>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" @onclick="ClearFilters">Clear Filters</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        @if (_isLoading)
                        {
                            <div class="p-5 text-center">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2 text-muted">Retrieving records...</div>
                            </div>
                        }
                        else if (!filteredRequests.Any())
                        {
                            <div class="p-5 text-center text-muted">
                                <i class="bi bi-search d-block h1 mb-3 opacity-25"></i>
                                No requests found matching current filters.
                            </div>
                        }
                        else
                        {
                            <table class="table modern-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Applicant</th>
                                        <th>Event Type</th>
                                        <th>Requested Date</th>
                                        <th>Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var request in filteredRequests.OrderByDescending(r => r.CreatedDate))
                                    {
                                        <tr class="request-row cursor-pointer" @onclick="() => ViewRequestDetails(request)">
                                            <td>
                                                <div class="fw-bold text-dark">@request.ApplicantName</div>
                                                <div class="text-muted extra-small">@request.RequesterEmail</div>
                                            </td>
                                            <td>
                                                <span class="text-muted">@(string.IsNullOrEmpty(request.EventType) ? "General Rental" : request.EventType)</span>
                                            </td>
                                            <td>
                                                <div class="small fw-bold">@request.RequestedDate.ToShortDateString()</div>
                                                <div class="extra-small text-muted">Submitted @request.CreatedDate.ToShortDateString()</div>
                                            </td>
                                            <td>
                                                <span class="status-pill @GetStatusBadgeClass(request.Status)">
                                                    <i class="bi @GetStatusIcon(request.Status)"></i>
                                                    @request.Status
                                                </span>
                                            </td>
                                            <td class="text-end" @onclick:stopPropagation="true">
                                                <button title="View Details" class="btn btn-action btn-light text-primary" @onclick="() => ViewRequestDetails(request)">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                @if (request.Status == RentalStatus.Pending)
                                                {
                                                    <button title="Approve" class="btn btn-action btn-light text-success" @onclick="() => ApproveRequest(request)">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                    <button title="Deny" class="btn btn-action btn-light text-danger" @onclick="() => DenyRequest(request)">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Area (Calendar) -->
        <div class="col-xl-4">
            <div class="calendar-container shadow-sm">
                <div class="calendar-header d-flex justify-content-between align-items-center" style="background-color: #1a2a44 !important; color: white !important;">
                    <button type="button" class="btn btn-sm btn-primary shadow-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; border: 2px solid rgba(255,255,255,0.2);" @onclick="() => ChangeMonth(-1)" title="Previous Month">
                        <i class="bi bi-chevron-left h5 mb-0 fw-bold text-white"></i>
                    </button>
                    <div class="fw-bold h5 mb-0 text-white">@currentMonth.ToString("MMMM yyyy")</div>
                    <button type="button" class="btn btn-sm btn-primary shadow-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; border: 2px solid rgba(255,255,255,0.2);" @onclick="() => ChangeMonth(1)" title="Next Month">
                        <i class="bi bi-chevron-right h5 mb-0 fw-bold text-white"></i>
                    </button>
                </div>
                <div class="calendar-grid mt-2">
                    @foreach (var dayName in new[] { "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" })
                    {
                        <div class="calendar-day-header">@dayName</div>
                    }
                    @for (int i = 0; i < firstDayOfMonthOffset; i++)
                    {
                        <div class="calendar-cell other-month opacity-25"></div>
                    }
                    @for (int day = 1; day <= daysInMonth; day++)
                    {
                        var currentDate = new DateTime(currentMonth.Year, currentMonth.Month, day);
                        var isToday = currentDate.Date == DateTime.Today;

                        // Show both Approved and Pending on the admin calendar
                        var requestsOnDay = allRequests.Where(r => r.RequestedDate.Date == currentDate.Date &&
                                                                 (r.Status == RentalStatus.Approved || r.Status == RentalStatus.Pending))
                                                      .ToList();
                        var hasRequests = requestsOnDay.Any();
                        var isApproved = requestsOnDay.Any(r => r.Status == RentalStatus.Approved);

                        <div class="calendar-cell @(isToday ? "today" : "") @(hasRequests ? (isApproved ? "cell-approved" : "cell-pending") : "")"
                             style="cursor: pointer;"
                             @onclick="() => SelectDay(currentDate)">
                            <span class="day-number">@day</span>
                            @if (hasRequests)
                            {
                                <div class="booked-dot @(isApproved ? "bg-success" : "bg-warning")"></div>
                                @foreach (var r in requestsOnDay.Take(1))
                                {
                                    <span class="booked-label" title="@r.ApplicantName">
                                        <span class="fw-bold">@r.ApplicantName</span>
                                        @if (!string.IsNullOrEmpty(r.StartTime))
                                        {
                                            <span class="d-block extra-small opacity-75">@r.StartTime@(!string.IsNullOrEmpty(r.EndTime) ? $" - {r.EndTime}" : "")</span>
                                        }
                                    </span>
                                }
                            }
                        </div>
                    }
                </div>
                <div class="mt-3 p-2 bg-light rounded shadow-inner">
                    <h6 class="fw-bold extra-small text-muted text-uppercase mb-2">Upcoming Schedule</h6>
                    <div class="events-list">
                        @if (!_upcomingEvents.Any())
                        {
                            <div class="extra-small text-center py-2 text-muted italic">No upcoming events found</div>
                        }
                        else
                        {
                            @foreach (var item in _upcomingEvents)
                            {
                                if (item is HallRentalRequest r)
                                {
                                    <div class="d-flex align-items-center gap-2 mb-2 p-1 border-bottom border-white @(r.Status == RentalStatus.Pending ? "opacity-75" : "")"
                                         style="cursor: pointer;" @onclick="() => ViewRequestDetails(r)">
                                        <div class="badge @(r.Status == RentalStatus.Approved ? "bg-success" : "bg-warning") rounded-pill p-1" style="font-size: 0.6rem;">@r.RequestedDate.ToString("MMM dd")</div>
                                        <div class="extra-small text-truncate" title="@r.ApplicantName">
                                            <span class="fw-bold">@r.ApplicantName</span>
                                            <span class="text-muted d-block" style="font-size: 0.6rem;">@(r.EventType ?? "Rental") @(r.Status == RentalStatus.Pending ? "(PENDING)" : "")</span>
                                        </div>
                                    </div>
                                }
                                else if (item is AvailabilityCalendar e)
                                {
                                    <div class="d-flex align-items-center gap-2 mb-2 p-1 border-bottom border-white"
                                         style="cursor: pointer;" @onclick="() => SelectFilteredItem(e)">
                                        <div class="badge bg-info rounded-pill p-1" style="font-size: 0.6rem;">@e.Date.ToString("MMM dd")</div>
                                        <div class="extra-small text-truncate" title="@e.Description">
                                            <span class="fw-bold">@e.Description</span>
                                            <span class="text-muted d-block" style="font-size: 0.6rem;">Club Event</span>
                                        </div>
                                    </div>
                                }
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Request Details Modal -->
@if (selectedRequest != null)
{
    <div class="modal-overlay" @onclick="() => CloseRequestModal()">
        <div class="modal-container modal-large modal-modern" @onclick:stopPropagation="true">
            <div class="modal-header-gradient">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="modal-title-section">
                        <i class="bi bi-calendar-check modal-icon"></i>
                        <h3>Rental Request Details</h3>
                    </div>
                    <button class="btn-close-pill" @onclick="() => CloseRequestModal()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <!-- Applicant Info -->
                    <div class="col-md-6">
                        <div class="detail-card h-100">
                            <div class="detail-label">Applicant Details</div>
                            <div class="detail-value fw-bold">@selectedRequest.ApplicantName</div>
                            <div class="small text-muted"><i class="bi bi-envelope me-1"></i> @selectedRequest.RequesterEmail</div>
                            <div class="small text-muted"><i class="bi bi-telephone me-1"></i> @selectedRequest.RequesterPhone</div>
                        </div>
                    </div>

                    <!-- Event Info -->
                    <div class="col-md-6">
                        <div class="detail-card h-100">
                            <div class="detail-label">Event Information</div>
                            <div class="detail-value fw-bold">@(string.IsNullOrEmpty(selectedRequest.EventType) ? "General Hall Rental" : selectedRequest.EventType)</div>
                            <div class="detail-value h5 text-primary mb-0 mt-1">@selectedRequest.RequestedDate.ToLongDateString()</div>
                            <div class="small text-dark fw-bold">@selectedRequest.StartTime - @selectedRequest.EndTime</div>
                            <div class="small text-muted"><i class="bi bi-people me-1"></i> Estimated Guests: @selectedRequest.GuestCount</div>
                        </div>
                    </div>

                    <!-- Status Timeline -->
                    <div class="col-12">
                        <div class="detail-card">
                            <div class="detail-label">Processing Status: <span class="status-pill @GetStatusBadgeClass(selectedRequest.Status)">@selectedRequest.Status</span></div>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <div class="extra-small text-muted">SUBMITTED ON</div>
                                    <div class="small">@selectedRequest.CreatedDate.ToLocalTime().ToString("g")</div>
                                </div>
                                @if (selectedRequest.Status != RentalStatus.Pending)
                                {
                                    <div class="col-md-4">
                                        <div class="extra-small text-muted">PROCESSED BY</div>
                                        <div class="small">@(selectedRequest.ApprovedBy ?? selectedRequest.DeniedBy ?? "System")</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="extra-small text-muted">APPROVAL DATE</div>
                                        <div class="small">@((selectedRequest.ApprovalDate ?? selectedRequest.DenialDate)?.ToLocalTime().ToString("g") ?? "N/A")</div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Technical Details -->
                    <div class="col-md-6">
                        <div class="detail-card h-100">
                            <div class="detail-label">Additional Info</div>
                            <div class="small mb-1">Kitchen Usage: <span class="badge @(selectedRequest.KitchenUsage ? "bg-success" : "bg-light text-muted")">@(selectedRequest.KitchenUsage ? "YES" : "NO")</span></div>
                            <div class="small mb-1">Member Status: <span class="badge @(selectedRequest.MemberStatus ? "bg-info" : "bg-light text-muted")">@(selectedRequest.MemberStatus ? "MEMBER" : "NON-MEMBER")</span></div>
                            <div class="small mb-1">Renter Type: <span class="badge bg-light text-dark">@selectedRequest.RenterType</span></div>
                            <div class="small mb-1">Security Deposit: <span class="badge @(selectedRequest.SecurityDepositPaid ? "bg-success" : "bg-warning")">@(selectedRequest.SecurityDepositPaid ? "PAID" : "PENDING")</span></div>
                            <div class="small mb-2">Pricing Base: <span class="fw-bold">@selectedRequest.TotalPrice.ToString("C")</span></div>

                            <div class="mt-2 pt-2 border-top">
                                <div class="form-check form-switch small mb-1">
                                    <input class="form-check-input" type="checkbox" id="rentalPaid"
                                           checked="@selectedRequest.IsPaid"
                                           @onchange="@(e => { selectedRequest.IsPaid = (bool)e.Value; if(selectedRequest.IsPaid) selectedRequest.PaymentDate = DateTime.Now; })">
                                    <label class="form-check-label fw-bold" for="rentalPaid text-success">Rental Fee Paid</label>
                                </div>
                                @if (selectedRequest.IsPaid)
                                {
                                    <div class="mt-2 text-success extra-small fw-bold">
                                        <i class="bi bi-calendar-check me-1"></i> Paid on @(selectedRequest.PaymentDate?.ToString("MMM dd, yyyy") ?? "recently")
                                    </div>
                                    <div class="mt-2">
                                        <label class="extra-small text-muted d-block">Payment Method</label>
                                        <select class="form-select form-select-sm" @bind="selectedRequest.PaymentMethod">
                                            <option value="">-- Select --</option>
                                            <option value="Online">Online</option>
                                            <option value="Mailed">Mailed</option>
                                            <option value="Dropped Off">Dropped Off</option>
                                            <option value="In Person">In Person (Office)</option>
                                        </select>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Internal Notes -->
                    <div class="col-md-6">
                        <div class="detail-card h-100">
                            <label for="internalNotes" class="detail-label">Internal Admin Notes</label>
                            <textarea id="internalNotes" class="form-control form-control-sm"
                                      rows="8"
                                      placeholder="Add private notes for staff..."
                                      @bind="selectedRequest.InternalNotes"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modern btn-outline" @onclick="CloseRequestModal">Cancel</button>
                @if (selectedRequest.Status == RentalStatus.Pending)
                {
                    <button type="button" class="btn-modern btn-danger" @onclick="() => { DenyRequest(selectedRequest); CloseRequestModal(); }">Deny</button>
                    <button type="button" class="btn-modern btn-success" @onclick="() => { ApproveRequest(selectedRequest); CloseRequestModal(); }">Approve</button>
                }
                <button type="button" class="btn-modern btn-primary" @onclick="SaveChanges">Save Changes</button>
            </div>
        </div>
    </div>
}

@if (_showEventModal)
{
    <div class="modal-overlay" @onclick="() => CloseEventModal()">
        <div class="modal-container modal-medium modal-modern" @onclick:stopPropagation="true">
            <div class="modal-header-gradient">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="modal-title-section">
                        <i class="bi bi-star-fill modal-icon"></i>
                        <h3>@(_editingEvent != null ? "Edit Club Event" : "Add Club Event")</h3>
                    </div>
                    <button class="btn-close-pill" @onclick="() => CloseEventModal()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body p-4">
                <div class="form-group-modern">
                    <label for="eventName"><i class="bi bi-bookmark-star"></i> Event Name</label>
                    <input type="text" id="eventName" class="form-input-modern" @bind="_eventForm.Description" placeholder="e.g., Christmas Party" />
                </div>
                <div class="form-group-modern">
                    <label for="eventDate"><i class="bi bi-calendar-event"></i> Date</label>
                    <input type="date" id="eventDate" class="form-input-modern" @bind="_eventForm.Date" />
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group-modern">
                            <label for="startTime"><i class="bi bi-clock"></i> Start Time</label>
                            <input type="text" id="startTime" class="form-input-modern" @bind="_eventForm.StartTime" placeholder="e.g., 3:00 PM" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group-modern">
                            <label for="endTime"><i class="bi bi-clock-fill"></i> End Time</label>
                            <input type="text" id="endTime" class="form-input-modern" @bind="_eventForm.EndTime" placeholder="e.g., 11:00 PM" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modern btn-outline" @onclick="() => CloseEventModal()">Cancel</button>
                <button class="btn-modern btn-primary" @onclick="async () => await SaveClubEvent()">
                    <i class="bi bi-plus-circle me-1"></i> @(_editingEvent != null ? "Update Event" : "Add Event")
                </button>
            </div>
        </div>
    </div>
}

@if (_selectedDay.HasValue)
{
    <div class="modal-overlay" @onclick="() => _selectedDay = null">
        <div class="modal-container modal-medium modal-modern" @onclick:stopPropagation="true">
            <div class="modal-header-gradient">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="modal-title-section">
                        <i class="bi bi-calendar-day modal-icon"></i>
                        <h3>Events for @_selectedDay.Value.ToString("MMMM d, yyyy")</h3>
                    </div>
                    <button class="btn-close-pill" @onclick="() => _selectedDay = null">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="filtered-list">
                    @foreach (var ev in GetEventsForDay(_selectedDay.Value))
                    {
                        <div class="filtered-item" @onclick="() => SelectFilteredItem(ev.Request ?? (object)ev.ClubEvent)">
                            @if (ev.Type == EventType.RentalApproved || ev.Type == EventType.RentalPending)
                            {
                                <span>@ev.Request.ApplicantName - @ev.Request.EventType</span>
                            }
                            else
                            {
                                <span>@ev.ClubEvent.Description</span>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    .extra-small { font-size: 0.7rem; }
    .cell-approved { background-color: rgba(25, 135, 84, 0.05); }
    .cell-pending { background-color: rgba(255, 193, 7, 0.05); }
    .booked-dot.bg-warning { box-shadow: 0 0 5px rgba(255, 193, 7, 0.5); }
    .booked-dot.bg-success { box-shadow: 0 0 5px rgba(25, 135, 84, 0.5); }
</style>

@code {
    private bool _isLoading = true;
    private List<HallRentalRequest> allRequests = new();
    private List<HallRentalRequest> filteredRequests = new();
    private HallRentalRequest selectedRequest;
    private List<HallRentalRequest> approvedRentals = new();
    private List<AvailabilityCalendar> _clubEvents = new();
    private AvailabilityCalendar _editingEvent;
    private bool _showEventModal = false;
    private EventForm _eventForm = new();
    private DateTime? _selectedDay;
    private int _pendingCount;
    private int _approvedCount;
    private int _clubEventsCount;
    private int _totalBookings;
    private List<HallRentalRequest> _pendingRequests = new();
    private List<object> _upcomingEvents = new();

    private DateTime currentMonth = DateTime.Today;
    private int firstDayOfMonthOffset = 0;
    private int daysInMonth = 0;

    private string selectedStatus = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private DateTime lastUpdated = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        RenderCalendar(); // Always render structure first
        try
        {
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing RentalManagement: {ex}");
            await ToastService.ShowToastAsync("Failed to load rental data. Please check database connection.", ToastLevel.Error);
        }
    }

    private async Task RefreshData()
    {
        await LoadRequests();
        await LoadApprovedRentals();
        lastUpdated = DateTime.Now;
        StateHasChanged();
    }

    private async Task LoadRequests()
    {
        _isLoading = true;
        allRequests = (await RentalService.GetRentalRequestsAsync()).ToList();
        _pendingRequests = allRequests.Where(r => r.Status == RentalStatus.Pending).ToList();
        _pendingCount = _pendingRequests.Count;
        _approvedCount = allRequests.Count(r => r.Status == RentalStatus.Approved);
        _clubEventsCount = _clubEvents.Count;
        _totalBookings = _approvedCount + _clubEventsCount;
        _upcomingEvents = allRequests.Where(r => r.Status == RentalStatus.Approved || r.Status == RentalStatus.Pending)
            .Cast<object>()
            .Concat(_clubEvents.Cast<object>())
            .ToList();

        ApplyFilters();
        _isLoading = false;
        StateHasChanged();
    }

    private async Task LoadApprovedRentals()
    {
        approvedRentals = (await RentalService.GetApprovedRentalsAsync()).ToList();
    }

    private void RenderCalendar()
    {
        daysInMonth = DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month);
        var firstDayOfMonth = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        firstDayOfMonthOffset = (int)firstDayOfMonth.DayOfWeek;
    }

    private void ChangeMonth(int direction)
    {
        currentMonth = currentMonth.AddMonths(direction);
        RenderCalendar();
        StateHasChanged();
    }

    private void ApplyFilters()
    {
        filteredRequests = allRequests ?? new();

        if (allRequests != null && !string.IsNullOrEmpty(selectedStatus))
        {
            filteredRequests = filteredRequests.Where(r => r.Status == selectedStatus).ToList();
        }

        if (startDate.HasValue)
        {
            filteredRequests = filteredRequests.Where(r => r.RequestedDate.Date >= startDate.Value.Date).ToList();
        }

        if (endDate.HasValue)
        {
            filteredRequests = filteredRequests.Where(r => r.RequestedDate.Date <= endDate.Value.Date).ToList();
        }
    }

    private async Task ClearFilters()
    {
        selectedStatus = "";
        startDate = null;
        endDate = null;
        await LoadRequests();
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        RentalStatus.Approved => "status-approved",
        RentalStatus.Denied => "status-denied",
        RentalStatus.Pending => "status-pending",
        _ => "bg-light text-muted"
    };

    private string GetStatusIcon(string status) => status switch
    {
        RentalStatus.Approved => "bi-check-circle-fill",
        RentalStatus.Denied => "bi-x-circle-fill",
        RentalStatus.Pending => "bi-hourglass-split",
        _ => "bi-question-circle"
    };

    private void ViewRequestDetails(HallRentalRequest request)
    {
        selectedRequest = request;
        StateHasChanged();
    }

    private void SelectDay(DateTime date)
    {
        var dayEvents = GetEventsForDay(date);
        if (dayEvents.Count == 0)
        {
            // Show empty day modal with option to add event
            _selectedDay = date;
        }
        else if (dayEvents.Count == 1 && (dayEvents[0].Type == EventType.RentalApproved || dayEvents[0].Type == EventType.RentalPending))
        {
            // If single rental request, show details directly
            ViewRequestDetails(dayEvents[0].Request);
        }
        else
        {
            // Show day modal with all events (multiple events or club events)
            _selectedDay = date;
        }
    }

    private void CloseRequestModal()
    {
        selectedRequest = null;
        StateHasChanged();
    }

    private async Task SaveClubEvent()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_eventForm.Description))
            {
                await ToastService.ShowToastAsync("Please enter an event name", ToastLevel.Warning);
                return;
            }

            var existingEvent = _clubEvents.FirstOrDefault(e => e.Date.Date == _eventForm.Date.Date);
            if (existingEvent != null && (_editingEvent == null || existingEvent.Id != _editingEvent.Id))
            {
                await ToastService.ShowToastAsync(
                    $"A club event '{existingEvent.Description}' already exists on {_eventForm.Date.ToString("MMMM d, yyyy")}. Please choose a different date or edit the existing event.",
                    ToastLevel.Warning);
                return;
            }

            if (_editingEvent != null)
            {
                // Update existing event
                await RentalService.UpdateBlackoutDateAsync(_editingEvent.Id, _eventForm.Date, _eventForm.Description, _eventForm.StartTime, _eventForm.EndTime);
                await ToastService.ShowToastAsync("Club event updated successfully", ToastLevel.Success);
            }
            else
            {
                // Add new event
                await RentalService.AddBlackoutDateAsync(_eventForm.Date, _eventForm.Description, _eventForm.StartTime, _eventForm.EndTime);
                await ToastService.ShowToastAsync("Club event added successfully", ToastLevel.Success);
            }
            CloseEventModal();
            await LoadData();
        }
        catch (Exception ex)
        {
            await ToastService.ShowToastAsync($"Error saving event: {ex.Message}", ToastLevel.Error);
        }
    }

    private async Task SaveChanges()
    {
        if (selectedRequest != null)
        {
            await RentalService.UpdateRentalRequestAsync(selectedRequest);
            await ToastService.ShowToastAsync("Changes saved successfully.", ToastLevel.Success);
            CloseRequestModal();
            await LoadRequests();
        }
    }

    private void CloseEventModal()
    {
        _showEventModal = false;
        _editingEvent = null;
        _eventForm = new EventForm();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        await LoadRequests();
        await LoadApprovedRentals();
        await LoadClubEvents();
        CalculateStatCounts();
        _isLoading = false;
        StateHasChanged();
    }

    private void CalculateStatCounts()
    {
        _pendingRequests = allRequests.Where(r => r.Status == RentalStatus.Pending).ToList();
        _pendingCount = _pendingRequests.Count;
        _approvedCount = allRequests.Count(r => r.Status == RentalStatus.Approved);
        _clubEventsCount = _clubEvents.Count;
        _totalBookings = _approvedCount + _clubEventsCount;
        _upcomingEvents = allRequests
            .Where(r => r.RequestedDate >= DateTime.Today && (r.Status == RentalStatus.Approved || r.Status == RentalStatus.Pending))
            .OrderBy(r => r.RequestedDate)
            .Cast<object>()
            .Concat(_clubEvents.Where(e => e.Date >= DateTime.Today).OrderBy(e => e.Date).Cast<object>())
            .ToList();
    }

    private async Task LoadClubEvents()
    {
        _clubEvents = (await RentalService.GetClubEventsAsync()).ToList();
    }

    private List<CalendarEvent> GetEventsForDay(DateTime date)
    {
        var events = new List<CalendarEvent>();
        events.AddRange(allRequests.Where(r => r.RequestedDate.Date == date.Date && r.Status == RentalStatus.Pending).Select(r => new CalendarEvent { Type = EventType.RentalPending, Request = r }));
        events.AddRange(allRequests.Where(r => r.RequestedDate.Date == date.Date && r.Status == RentalStatus.Approved).Select(r => new CalendarEvent { Type = EventType.RentalApproved, Request = r }));
        events.AddRange(_clubEvents.Where(e => e.Date.Date == date.Date).Select(e => new CalendarEvent { Type = EventType.Club, ClubEvent = e }));
        return events;
    }

    private async Task ApproveRequest(HallRentalRequest request)
    {
        try
        {
            var currentUser = HttpContextAccessor.HttpContext?.User?.Identity?.Name ?? "Admin";
            var success = await RentalService.ApproveRentalRequestAsync(request.Id, "Approved via admin panel.", currentUser);
            if (success)
            {
                await ToastService.ShowToastAsync($"Request for {request.ApplicantName} approved.", ToastLevel.Success);
                await LoadApprovedRentals(); // Refresh calendar
            }
            else
            {
                await ToastService.ShowToastAsync("Failed to approve request. The date is already booked.", ToastLevel.Error);
            }
            await LoadRequests();
        }
        catch (Exception ex)
        {
            await ToastService.ShowToastAsync($"Error approving request: {ex.Message}", ToastLevel.Error);
            Console.WriteLine($"Approval error: {ex}");
        }
    }

    private async Task DenyRequest(HallRentalRequest request)
    {
        try
        {
            var currentUser = HttpContextAccessor.HttpContext?.User?.Identity?.Name ?? "Admin";
            await RentalService.DenyRentalRequestAsync(request.Id, "Denied via admin panel.", currentUser);
            await ToastService.ShowToastAsync($"Request for {request.ApplicantName} denied.", ToastLevel.Info);
            await LoadApprovedRentals(); // Refresh calendar
            await LoadRequests();
        }
        catch (Exception ex)
        {
            await ToastService.ShowToastAsync($"Error denying request: {ex.Message}", ToastLevel.Error);
            Console.WriteLine($"Denial error: {ex}");
        }
    }

    private enum FilterType { Pending, Approved, ClubEvents, All }
    private FilterType? _activeFilter = null;
    private bool _showFilteredModal = false;

    private void ShowFilteredList(FilterType filter)
    {
        _activeFilter = filter;
        _showFilteredModal = true;
    }

    private string GetFilterTitle()
    {
        return _activeFilter switch
        {
            FilterType.Pending => "Pending Requests",
            FilterType.Approved => "Approved Rentals",
            FilterType.ClubEvents => "Club Events",
            FilterType.All => "All Bookings",
            _ => "Events"
        };
    }

    private List<object> GetFilteredItems()
    {
        return _activeFilter switch
        {
            FilterType.Pending => _pendingRequests.Cast<object>().ToList(),
            FilterType.Approved => allRequests.Where(r => r.Status == RentalStatus.Approved).Cast<object>().ToList(),
            FilterType.ClubEvents => _clubEvents.Cast<object>().ToList(),
            FilterType.All => _upcomingEvents.Cast<object>().ToList(),
            _ => new List<object>()
        };
    }

    private void SelectFilteredItem(object item)
    {
        if (item is HallRentalRequest request)
        {
            ViewRequestDetails(request);
            _showFilteredModal = false;
        }
        else if (item is AvailabilityCalendar clubEvent)
        {
            _selectedDay = clubEvent.Date;
            _showFilteredModal = false;
        }
    }

    public class EventForm
    {
        public string Description { get; set; }
        public DateTime Date { get; set; } = DateTime.Today;
        public string StartTime { get; set; }
        public string EndTime { get; set; }
    }

    public class CalendarEvent
    {
        public EventType Type { get; set; }
        public HallRentalRequest Request { get; set; }
        public AvailabilityCalendar ClubEvent { get; set; }
        public DateTime Date => Request?.RequestedDate ?? ClubEvent.Date;
    }

    public enum EventType
    {
        RentalPending,
        RentalApproved,
        Club
    }
}
