@page "/admin/blackout-dates"
@using GFC.Core.Models
@attribute [Authorize(Roles = "Admin")]
@inject IRentalService RentalService
@inject IJSRuntime JSRuntime

<style>
    .blackout-management-container {
        background: #f4f6f9;
        min-height: calc(100vh - 60px);
    }
    .calendar-container {
        background: white;
        border-radius: 15px;
        padding: 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    .calendar-header {
        background: #1a2a44;
        color: white;
        padding: 0.75rem 1rem;
    }
    .calendar-grid {
        display: grid !important;
        grid-template-columns: repeat(7, 1fr) !important;
        border: 1px solid #e9ecef;
        background: white;
    }
    .calendar-day-header {
        background: #f8f9fa;
        padding: 0.5rem;
        font-weight: 700;
        font-size: 0.75rem;
        text-align: center;
        border-bottom: 1px solid #e9ecef;
        border-right: 1px solid #e9ecef;
    }
    .calendar-cell {
        min-height: 100px;
        border-bottom: 0.5px solid #e9ecef;
        border-right: 0.5px solid #e9ecef;
        padding: 0.25rem;
        position: relative;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        cursor: cell;
    }
    .calendar-cell:hover:not(.other-month) {
        background: #f0f7ff;
    }
    .calendar-cell.today {
        background: #e6f0ff;
    }
    .calendar-cell.blackout {
        background: #fff5f5;
    }
    .calendar-cell.has-rental {
        background: #f0fff4;
    }
    .day-number {
        font-size: 0.8rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 2px;
        display: block;
    }
    .booked-label {
        font-size: 0.6rem;
        background: rgba(40, 167, 69, 0.1);
        color: #155724;
        padding: 2px 4px;
        border-radius: 4px;
        margin-top: 2px;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        border-left: 3px solid #28a745;
        line-height: 1.2;
    }
    .blackout-tag {
        font-size: 0.6rem;
        background: #dc3545;
        color: white;
        padding: 2px 4px;
        border-radius: 4px;
        margin-top: 2px;
        display: block;
        text-align: left;
        cursor: pointer;
        border-left: 3px solid #660000;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        line-height: 1.1;
    }
    .extra-small {
        font-size: 0.6rem;
        opacity: 0.8;
    }
</style>

<PageTitle>Blackout & Club Events</PageTitle>

<div class="blackout-management-container p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="bi bi-calendar-x me-2"></i>Blackout & Club events</h1>
            <p class="text-muted small">Manage dates unavailable for hall rentals due to club events, holidays, or maintenance.</p>
        </div>
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body py-2 px-3">
                <div class="d-flex gap-3 align-items-end">
                    <div>
                        <label class="extra-small text-uppercase fw-bold text-muted d-block">Description</label>
                        <input type="text" class="form-control form-control-sm" placeholder="e.g. Christmas Party" @bind="_newDescription" />
                    </div>
                    <div>
                        <label class="extra-small text-uppercase fw-bold text-muted d-block">Date</label>
                        <input type="date" class="form-control form-control-sm" @bind="_newBlackoutDate" />
                    </div>
                    <div style="width: 80px;">
                        <label class="extra-small text-uppercase fw-bold text-muted d-block">Start</label>
                        <input type="text" class="form-control form-control-sm" placeholder="3pm" @bind="_newStartTime" />
                    </div>
                    <div style="width: 80px;">
                        <label class="extra-small text-uppercase fw-bold text-muted d-block">End</label>
                        <input type="text" class="form-control form-control-sm" placeholder="11pm" @bind="_newEndTime" />
                    </div>
                    <button class="btn btn-primary btn-sm rounded-pill px-3" @onclick="AddBlackoutDate">
                        <i class="bi bi-plus-circle me-1"></i> Add Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Calendar View (Left side) -->
        <div class="col-xl-8">
            <div class="calendar-container shadow-sm p-0">
                <div class="calendar-header d-flex justify-content-between align-items-center" style="background-color: #1a2a44 !important; color: white !important;">
                    <button type="button" class="btn btn-sm btn-primary shadow-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; border: 2px solid rgba(255,255,255,0.2);" @onclick="() => ChangeMonth(-1)">
                        <i class="bi bi-chevron-left h5 mb-0 fw-bold text-white"></i>
                    </button>
                    <div class="fw-bold h5 mb-0 text-white">@currentMonth.ToString("MMMM yyyy")</div>
                    <button type="button" class="btn btn-sm btn-primary shadow-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; border: 2px solid rgba(255,255,255,0.2);" @onclick="() => ChangeMonth(1)">
                        <i class="bi bi-chevron-right h5 mb-0 fw-bold text-white"></i>
                    </button>
                </div>
                <div class="calendar-grid">
                    @foreach (var dayName in new[] { "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" })
                    {
                        <div class="calendar-day-header">@dayName</div>
                    }
                    @for (int i = 0; i < firstDayOfMonthOffset; i++)
                    {
                        <div class="calendar-cell other-month opacity-25"></div>
                    }
                    @for (int day = 1; day <= daysInMonth; day++)
                    {
                        var currentDate = new DateTime(currentMonth.Year, currentMonth.Month, day);
                        var isToday = currentDate.Date == DateTime.Today;
                        
                        var blackoutEventsOnDay = _blackoutEvents?.Where(d => d.Date.Date == currentDate.Date).ToList();
                        var hasBlackout = blackoutEventsOnDay?.Any() ?? false;
                        
                        var rentalsOnDay = _allRentals?.Where(r => r.RequestedDate.Date == currentDate.Date && 
                                                                  (r.Status == RentalStatus.Approved || r.Status == RentalStatus.Pending))
                                                       .ToList();
                        var hasRentals = rentalsOnDay?.Any() ?? false;

                        <div class="calendar-cell @(isToday ? "today" : "") @(hasBlackout ? "blackout" : "") @(hasRentals ? "has-rental" : "")"
                             @onclick="() => QuickAddBlackout(currentDate)">
                            <span class="day-number">@day</span>
                            
                            @if (hasBlackout)
                            {
                                @foreach (var ev in blackoutEventsOnDay!)
                                {
                                    <div class="blackout-tag" @onclick:stopPropagation="true" @onclick="() => EditBlackout(ev)">
                                        <div class="fw-bold">@(ev.Description ?? "Blackout")</div>
                                        @if (!string.IsNullOrEmpty(ev.StartTime))
                                        {
                                            <div class="extra-small">@ev.StartTime@(!string.IsNullOrEmpty(ev.EndTime) ? $" - {ev.EndTime}" : "")</div>
                                        }
                                    </div>
                                }
                            }

                            @if (hasRentals)
                            {
                                @foreach (var r in rentalsOnDay!.Take(1))
                                {
                                    <span class="booked-label" title="@r.ApplicantName" @onclick:stopPropagation="true">
                                        <strong>@r.ApplicantName</strong>
                                        <span class="d-block extra-small opacity-75">@(r.StartTime ?? "Rental")@(!string.IsNullOrEmpty(r.EndTime) ? $" - {r.EndTime}" : "")</span>
                                    </span>
                                }
                            }
                        </div>
                    }
                </div>
            </div>
            
            <div class="mt-3 d-flex gap-4 small">
                <div class="d-flex align-items-center gap-1">
                    <div style="width: 12px; height: 12px; border: 1px solid #feb2b2; background: #fff5f5;"></div>
                    <span>Private Event / Blackout</span>
                </div>
                <div class="d-flex align-items-center gap-1">
                    <div style="width: 12px; height: 12px; background: #f0fff4; border: 1px solid #c6f6d5;"></div>
                    <span>Rental Request</span>
                </div>
                <div class="ms-auto text-muted italic">
                    <i class="bi bi-info-circle me-1"></i> Click any date cell to quickly add a blackout event.
                </div>
            </div>
        </div>

        <!-- List View (Right side) -->
        <div class="col-xl-4">
            <!-- Club Events Section -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-star-fill text-warning me-2"></i>Upcoming Club Events</h6>
                </div>
                <div class="card-body p-0 overflow-auto" style="max-height: 400px;">
                    <div class="list-group list-group-flush">
                        @if (_blackoutEvents == null || !_blackoutEvents.Any())
                        {
                            <div class="p-4 text-center text-muted">
                                <p class="small mb-0">No club events scheduled.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var ev in _blackoutEvents.Where(e => e.Date >= DateTime.Today).OrderBy(d => d.Date))
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-center py-3 cursor-pointer hover-bg-light" @onclick="() => EditBlackout(ev)">
                                    <div>
                                        <div class="fw-bold">@(ev.Description ?? "Club Event")</div>
                                        <div class="text-primary small fw-bold">@ev.Date.ToString("MMM dd, yyyy")</div>
                                        @if (!string.IsNullOrEmpty(ev.StartTime))
                                        {
                                            <div class="text-muted extra-small"><i class="bi bi-clock me-1"></i>@ev.StartTime - @ev.EndTime</div>
                                        }
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm border-0" @onclick:stopPropagation="true" @onclick="() => EditBlackout(ev)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm border-0" @onclick:stopPropagation="true" @onclick="() => RemoveBlackoutEvent(ev)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Private Events Section -->
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-person-fill text-primary me-2"></i>Upcoming Private Events</h6>
                </div>
                <div class="card-body p-0 overflow-auto" style="max-height: 400px;">
                    <div class="list-group list-group-flush">
                        @{
                            var upcomingRentals = _allRentals?
                                .Where(r => r.RequestedDate.Date >= DateTime.Now.Date && (r.Status == RentalStatus.Approved || r.Status == RentalStatus.Pending))
                                .GroupBy(r => new { r.ApplicantName, Date = r.RequestedDate.Date })
                                .Select(g => g.OrderByDescending(r => r.Id).First())
                                .OrderBy(r => r.RequestedDate)
                                .Take(10)
                                .ToList();
                        }
                        @if (upcomingRentals == null || !upcomingRentals.Any())
                        {
                            <div class="p-4 text-center text-muted">
                                <p class="small mb-0">No upcoming rentals scheduled.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var r in upcomingRentals)
                            {
                                <div class="list-group-item py-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold small">@r.ApplicantName</span>
                                        <span class="badge @(r.Status == RentalStatus.Approved ? "bg-success" : "bg-warning") opacity-75 extra-small">@r.Status</span>
                                    </div>
                                    <div class="extra-small text-muted">
                                        <i class="bi bi-calendar-event me-1"></i>@r.RequestedDate.ToString("MMM dd") 
                                        @if (!string.IsNullOrEmpty(r.StartTime)) {
                                            <span class="ms-2"><i class="bi bi-clock me-1"></i>@r.StartTime</span>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Editor Modal -->
@if (_showEditModal)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-primary text-white py-3">
                    <h5 class="modal-title fw-bold">@(isEditing ? "Edit Club Event" : "Add Club Event")</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => _showEditModal = false"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Date</label>
                        <input type="date" class="form-control" @bind="_editingDate" disabled="@isEditing" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Description / Name</label>
                        <input type="text" class="form-control" placeholder="e.g. Christmas Party" @bind="_editingDescription" />
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label small fw-bold text-uppercase text-muted">Start Time</label>
                            <input type="text" class="form-control" placeholder="3:00 PM" @bind="_editingStartTime" />
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold text-uppercase text-muted">End Time</label>
                            <input type="text" class="form-control" placeholder="11:00 PM" @bind="_editingEndTime" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" @onclick="() => _showEditModal = false">Cancel</button>
                    @if (isEditing)
                    {
                        <button type="button" class="btn btn-danger rounded-pill px-4 me-auto" @onclick="() => RemoveBlackoutEventFromModal()">Delete</button>
                    }
                    <button type="button" class="btn btn-primary rounded-pill px-4" @onclick="SaveBlackoutFromModal">
                        @(isEditing ? "Update Event" : "Add Event")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .hover-bg-light:hover { background: #f8f9fa; }
    .modal-content { border: none !important; }
</style>

@code {
    private DateTime _newBlackoutDate = DateTime.Today;
    private string? _newDescription;
    private string? _newStartTime;
    private string? _newEndTime;

    private List<AvailabilityCalendar>? _blackoutEvents;
    private List<HallRentalRequest>? _allRentals;
    
    private DateTime currentMonth = DateTime.Today;
    private int firstDayOfMonthOffset = 0;
    private int daysInMonth = 0;

    protected override async Task OnInitializedAsync()
    {
        RenderCalendar();
        await LoadData();
    }

    private async Task LoadData()
    {
        _blackoutEvents = await RentalService.GetBlackoutEventsAsync();
        _allRentals = (await RentalService.GetRentalRequestsAsync()).ToList();
        StateHasChanged();
    }

    private void RenderCalendar()
    {
        daysInMonth = DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month);
        var firstDayOfMonth = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        firstDayOfMonthOffset = (int)firstDayOfMonth.DayOfWeek;
    }

    private void ChangeMonth(int direction)
    {
        currentMonth = currentMonth.AddMonths(direction);
        RenderCalendar();
        StateHasChanged();
    }

    private bool _showEditModal = false;
    private bool isEditing = false;
    private DateTime _editingDate = DateTime.Today;
    private string? _editingDescription;
    private string? _editingStartTime;
    private string? _editingEndTime;

    private async Task QuickAddBlackout(DateTime date)
    {
        isEditing = false;
        _editingDate = date;
        _editingDescription = null;
        _editingStartTime = null;
        _editingEndTime = null;
        _showEditModal = true;
    }

    private void EditBlackout(AvailabilityCalendar ev)
    {
        isEditing = true;
        _editingDate = ev.Date;
        _editingDescription = ev.Description;
        _editingStartTime = ev.StartTime;
        _editingEndTime = ev.EndTime;
        _showEditModal = true;
    }

    private async Task SaveBlackoutFromModal()
    {
        await RentalService.AddBlackoutDateAsync(_editingDate, _editingDescription, _editingStartTime, _editingEndTime);
        _showEditModal = false;
        await LoadData();
    }

    private async Task RemoveBlackoutEventFromModal()
    {
        await RentalService.RemoveBlackoutDateAsync(_editingDate);
        _showEditModal = false;
        await LoadData();
    }

    private async Task AddBlackoutDate()
    {
        await RentalService.AddBlackoutDateAsync(_newBlackoutDate, _newDescription, _newStartTime, _newEndTime);
        _newDescription = null;
        _newStartTime = null;
        _newEndTime = null;
        await LoadData();
    }

    private async Task RemoveBlackoutEvent(AvailabilityCalendar ev)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to remove '{ev.Description ?? "this event"}' on {ev.Date.ToLongDateString()}?");
        if (confirmed)
        {
            await RentalService.RemoveBlackoutDateAsync(ev.Date);
            await LoadData();
        }
    }
}
