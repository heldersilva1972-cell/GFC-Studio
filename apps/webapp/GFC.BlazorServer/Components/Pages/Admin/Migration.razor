// [MODIFIED]
@page "/admin/migration"
@attribute [Authorize(Roles = "Administrator")]
@inject GFC.Core.Interfaces.IMigrationService MigrationService
@inject GFC.BlazorServer.Services.ToastService ToastService

<PageTitle>Migration & Export</PageTitle>

<h1>Migration & Export</h1>

<div class="gfc-modified-tag">[NEW]</div>

<p>Tools for migrating legacy website content and managing data portability.</p>

<div class="card my-4">
    <div class="card-header">
        <h5 class="card-title">Legacy Content Migration</h5>
    </div>
    <div class="card-body">
        <p class="card-text">Scrape content from the old website, convert it to the new Studio block format, and import it into the system.</p>
        <button class="btn btn-primary" @onclick="HandleStartMigration" disabled="@_isProcessing">
            @if (_isMigrating)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span> Migrating...</span>
            }
            else
            {
                <span>Start Migration</span>
            }
        </button>
    </div>
</div>

<div class="card my-4">
    <div class="card-header">
        <h5 class="card-title">Data Export & Backup</h5>
    </div>
    <div class="card-body">
        <p class="card-text">Export the entire site as a static HTML snapshot, a portable JSON backup, or a complete asset bundle.</p>
        <button class="btn btn-secondary" @onclick="HandleExportData" disabled="@_isProcessing">
            @if (_isExporting)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span> Exporting...</span>
            }
            else
            {
                <span>Export Data</span>
            }
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="card-title">SEO & URL Management</h5>
    </div>
    <div class="card-body">
        <p class="card-text">Generate 301 redirects for old URLs to maintain SEO rankings and ensure a seamless transition.</p>
        <button class="btn btn-info" @onclick="HandleManageRedirects" disabled="@_isProcessing">
            @if (_isGeneratingRedirects)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span> Generating...</span>
            }
            else
            {
                <span>Manage Redirects</span>
            }
        </button>
    </div>
</div>

@code {
    private bool _isMigrating = false;
    private bool _isExporting = false;
    private bool _isGeneratingRedirects = false;

    private bool _isProcessing => _isMigrating || _isExporting || _isGeneratingRedirects;

    private async Task HandleStartMigration()
    {
        _isMigrating = true;
        try
        {
            ToastService.ShowInfo("Starting legacy content migration...");
            await MigrationService.StartLegacyScrapeAsync();
            ToastService.ShowSuccess("Legacy content migration complete.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Migration failed", ex.Message);
        }
        finally
        {
            _isMigrating = false;
        }
    }

    private async Task HandleExportData()
    {
        _isExporting = true;
        try
        {
            ToastService.ShowInfo("Exporting site data...");
            await MigrationService.ExportStaticSiteAsync();
            ToastService.ShowSuccess("Site data export complete.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Export failed", ex.Message);
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task HandleManageRedirects()
    {
        _isGeneratingRedirects = true;
        try
        {
            ToastService.ShowInfo("Generating URL redirects...");
            await MigrationService.GenerateRedirectsAsync();
            ToastService.ShowSuccess("URL redirects generated.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Redirect generation failed", ex.Message);
        }
        finally
        {
            _isGeneratingRedirects = false;
        }
    }
}
