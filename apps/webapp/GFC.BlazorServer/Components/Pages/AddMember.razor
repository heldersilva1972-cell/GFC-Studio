@page "/members/new"
@implements IDisposable
@using Microsoft.AspNetCore.Authorization
@using GFC.Core.Models
@using GFC.Core.Interfaces
@using GFC.Core.BusinessRules
@using System.ComponentModel.DataAnnotations
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@inject IMemberRepository MemberRepository
@inject NavigationManager NavManager
@inject ILogger<AddMember> Logger
@inject TutorialService TutorialService

<PageTitle>Add New Member - GFC Membership</PageTitle>

<link href="css/add-member-animations.css" rel="stylesheet" />

<style>
    .date-picker-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .date-picker-group .form-select {
        flex: 1;
        min-width: 100px;
    }

    .date-picker-group .form-select:first-child {
        min-width: 140px; /* Month dropdown */
    }

    .date-picker-group .form-select:nth-child(2) {
        min-width: 80px; /* Day dropdown */
    }

    .date-picker-group .form-select:nth-child(3) {
        min-width: 100px; /* Year dropdown */
    }

    .date-picker-group .btn {
        flex-shrink: 0;
    }
</style>

<div class="page-header mb-4">
    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-outline-secondary" @onclick="GoBack" disabled="@_saving">
            <i class="bi bi-arrow-left"></i>
        </button>
        <div>
            <h1 class="page-title mb-0">Add New Member</h1>
            <p class="text-muted mb-0">Create a new member profile</p>
        </div>
    </div>
</div>

@* Tutorial Step 3: Fill out member form *@
@if (TutorialService.ShouldShowStep(3))
{
    <TutorialBubble 
        Show="true"
        Title="Profile Details"
        Message="Enter the member's core information. Required fields are marked with an asterisk."
        Tip="In sample mode, some fields are pre-filled to help you learn faster!"
        Position="top-center"
        ShowNext="false"
        ShowWait="true"
        WaitingText="Waiting for you to save the member..."
        AllowCancel="true"
        OnCancel="@(async () => await TutorialService.CancelTutorialAsync())" />
}

@* Tutorial Step 4: Member saved successfully *@
@if (TutorialService.ShouldShowStep(4))
{
    <TutorialBubble 
        Show="true"
        Title="Member Created"
        Message="Profile saved successfully. Next: initialize dues and payment history."
        Tip="Click 'Record Dues' to continue the onboarding process."
        Position="top-center"
        ShowNext="false"
        ShowWait="true"
        WaitingText="Waiting for you to click Record Dues..."
        AllowCancel="true"
        OnCancel="@(async () => await TutorialService.CancelTutorialAsync())" />
}

@if (_showSuccessAnimation)
{
    <div class="success-overlay">
        <div class="success-card">
            <div class="success-checkmark">
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <h2 class="success-title">Member Added Successfully!</h2>
            <p class="success-message">@_newMemberName has been added to the system.</p>
            <div class="success-actions">
                <button class="btn btn-primary" @onclick="GoToMemberList">
                    <i class="bi bi-list-ul me-2"></i>View All Members
                </button>
                <button class="btn btn-outline-primary" @onclick="AddAnother">
                    <i class="bi bi-plus-circle me-2"></i>Add Another
                </button>
            </div>
        </div>
    </div>
}

@if (_showDuesPrompt)
{
    <div class="success-overlay">
        <div class="success-card">
            <div class="success-checkmark">
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <h2 class="success-title">Member Added!</h2>
            <p class="success-message"><strong>@_newMemberName</strong> has been saved successfully.</p>
            
            <div class="alert alert-success border-0 shadow-sm mb-4" style="border-radius: 12px; background: #e0e7ff; color: #3730a3; text-align: left;">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-currency-dollar" style="font-size: 1.25rem;"></i>
                    <strong style="font-weight: 700;">Record Initial Dues?</strong>
                </div>
                <p class="mb-0 small">Would you like to record the annual dues payment for this new member now?</p>
            </div>

            <div class="success-actions d-flex flex-column gap-2">
                <button class="btn btn-primary btn-lg w-100 py-3 shadow-sm @(TutorialService.ShouldShowStep(4) ? "tutorial-pulse" : "")" @onclick="GoToRecordDues" style="border-radius: 14px; font-weight: 700;">
                    <i class="bi bi-wallet2 me-2"></i>Yes, Record Payment
                </button>
                <button class="btn btn-outline-secondary w-100 py-2" @onclick="() => { _showDuesPrompt = false; _showSuccessAnimation = true; }" style="border-radius: 12px; border-style: dashed;">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>
}

<EditForm Model="@_memberForm" OnValidSubmit="SaveMember">
    <DataAnnotationsValidator />
    
    <div class="row g-4">
        <!-- Personal Information Card -->
        <div class="col-lg-6">
            <div class="form-card">
                <div class="form-card-header">
                    <i class="bi bi-person-circle"></i>
                    <h5>Personal Information</h5>
                </div>
                <div class="form-card-body">
                    <div class="mb-3">
                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                        <InputText class="@($"form-control form-control-modern {(TutorialService.ShouldShowStep(3) ? "tutorial-pulse" : "")}")" @bind-Value="_memberForm.FirstName" placeholder="Enter first name" disabled="@_saving" />
                        <ValidationMessage For="@(() => _memberForm.FirstName)" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Middle Name</label>
                        <InputText class="form-control form-control-modern" @bind-Value="_memberForm.MiddleName" placeholder="Enter middle name (optional)" disabled="@_saving" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Last Name <span class="text-danger">*</span></label>
                        <InputText class="form-control form-control-modern" @bind-Value="_memberForm.LastName" placeholder="Enter last name" disabled="@_saving" />
                        <ValidationMessage For="@(() => _memberForm.LastName)" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Suffix</label>
                        <InputText class="form-control form-control-modern" @bind-Value="_memberForm.Suffix" placeholder="Jr., Sr., III, etc." disabled="@_saving" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                        <div class="date-picker-group">
                            <select class="form-select" @bind="_dobMonth" disabled="@_saving" @bind:after="UpdateDateOfBirth">
                                <option value="0">Month</option>
                                <option value="1">01 - January</option>
                                <option value="2">02 - February</option>
                                <option value="3">03 - March</option>
                                <option value="4">04 - April</option>
                                <option value="5">05 - May</option>
                                <option value="6">06 - June</option>
                                <option value="7">07 - July</option>
                                <option value="8">08 - August</option>
                                <option value="9">09 - September</option>
                                <option value="10">10 - October</option>
                                <option value="11">11 - November</option>
                                <option value="12">12 - December</option>
                            </select>
                            <select class="form-select" @bind="_dobDay" disabled="@_saving" @bind:after="UpdateDateOfBirth">
                                <option value="0">Day</option>
                                @for (int i = 1; i <= 31; i++)
                                {
                                    <option value="@i">@i</option>
                                }
                            </select>
                            <select class="form-select" @bind="_dobYear" disabled="@_saving" @bind:after="UpdateDateOfBirth">
                                <option value="0">Year</option>
                                @for (int year = DateTime.Today.Year - 18; year >= DateTime.Today.Year - 100; year--)
                                {
                                    <option value="@year">@year</option>
                                }
                            </select>
                        </div>
                        <ValidationMessage For="@(() => _memberForm.DateOfBirth)" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Card -->
        <div class="col-lg-6">
            <div class="form-card">
                <div class="form-card-header">
                    <i class="bi bi-telephone"></i>
                    <h5>Contact Information</h5>
                </div>
                <div class="form-card-body">
                    <div class="mb-3">
                        <label class="form-label">Email <span class="text-muted small">(Optional)</span></label>
                        <InputText type="email" class="form-control form-control-modern" @bind-Value="_memberForm.Email" placeholder="member@example.com" disabled="@_saving" />
                        <ValidationMessage For="@(() => _memberForm.Email)" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Home Phone <span class="text-danger">*</span></label>
                        <InputText class="form-control form-control-modern" @bind-Value="_memberForm.Phone" placeholder="(555) 123-4567" disabled="@_saving" />
                        <ValidationMessage For="@(() => _memberForm.Phone)" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Cell Phone <span class="text-danger">*</span></label>
                        <InputText class="form-control form-control-modern" @bind-Value="_memberForm.CellPhone" placeholder="(555) 987-6543" disabled="@_saving" />
                        <ValidationMessage For="@(() => _memberForm.CellPhone)" />
                        <small class="text-muted">At least one phone number is required</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Address <span class="text-danger">*</span></label>
                        <InputText class="form-control form-control-modern" @bind-Value="_memberForm.Address1" placeholder="123 Main Street" disabled="@_saving" />
                        <ValidationMessage For="@(() => _memberForm.Address1)" />
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-5">
                            <label class="form-label">City <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control form-control-modern" 
                                   @bind="_memberForm.City" 
                                   @bind:event="oninput"
                                   list="cityList" 
                                   placeholder="Enter or select city" 
                                   disabled="@_saving" />
                            <datalist id="cityList">
                                @foreach (var city in _cities)
                                {
                                    <option value="@city">@city</option>
                                }
                            </datalist>
                            <ValidationMessage For="@(() => _memberForm.City)" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">State <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control form-control-modern" 
                                   @bind="_memberForm.State" 
                                   @bind:event="oninput"
                                   list="stateList" 
                                   placeholder="MA" 
                                   maxlength="2" 
                                   disabled="@_saving" 
                                   style="text-transform: uppercase;" />
                            <datalist id="stateList">
                                @foreach (var state in _states)
                                {
                                    <option value="@state">@state</option>
                                }
                            </datalist>
                            <ValidationMessage For="@(() => _memberForm.State)" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Zip Code <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control form-control-modern" 
                                   @bind="_memberForm.PostalCode" 
                                   @bind:event="oninput"
                                   list="zipList" 
                                   placeholder="02101" 
                                   disabled="@_saving" />
                            <datalist id="zipList">
                                @foreach (var zip in _postalCodes)
                                {
                                    <option value="@zip">@zip</option>
                                }
                            </datalist>
                            <ValidationMessage For="@(() => _memberForm.PostalCode)" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Membership Details Card -->
        <div class="col-lg-6">
            <div class="form-card">
                <div class="form-card-header">
                    <i class="bi bi-card-checklist"></i>
                    <h5>Membership Details</h5>
                </div>
                <div class="form-card-body">
                    <div class="mb-3">
                        <label class="form-label">Initial Status <span class="text-danger">*</span></label>
                        <InputSelect class="form-select form-control-modern" @bind-Value="_memberForm.Status" disabled="@_saving">
                            <option value="">-- Select Status --</option>
                            <option value="GUEST">Guest</option>
                            <option value="REGULAR">Regular</option>
                            <option value="REJECTED">Rejected</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => _memberForm.Status)" />
                        <small class="text-muted">New members typically start as Guest</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Application Date <span class="text-danger">*</span></label>
                        <div class="date-picker-group">
                            <select class="form-select" @bind="_appMonth" disabled="@_saving" @bind:after="UpdateApplicationDate">
                                <option value="0">Month</option>
                                <option value="1">01 - January</option>
                                <option value="2">02 - February</option>
                                <option value="3">03 - March</option>
                                <option value="4">04 - April</option>
                                <option value="5">05 - May</option>
                                <option value="6">06 - June</option>
                                <option value="7">07 - July</option>
                                <option value="8">08 - August</option>
                                <option value="9">09 - September</option>
                                <option value="10">10 - October</option>
                                <option value="11">11 - November</option>
                                <option value="12">12 - December</option>
                            </select>
                            <select class="form-select" @bind="_appDay" disabled="@_saving" @bind:after="UpdateApplicationDate">
                                <option value="0">Day</option>
                                @for (int i = 1; i <= 31; i++)
                                {
                                    <option value="@i">@i</option>
                                }
                            </select>
                            <select class="form-select" @bind="_appYear" disabled="@_saving" @bind:after="UpdateApplicationDate">
                                <option value="0">Year</option>
                                @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 10; year--)
                                {
                                    <option value="@year">@year</option>
                                }
                            </select>
                        </div>
                        <ValidationMessage For="@(() => _memberForm.ApplicationDate)" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Accepted Date</label>
                        <div class="date-picker-group">
                            <select class="form-select" @bind="_accMonth" disabled="@_saving" @bind:after="UpdateAcceptedDate">
                                <option value="0">Month</option>
                                <option value="1">01 - January</option>
                                <option value="2">02 - February</option>
                                <option value="3">03 - March</option>
                                <option value="4">04 - April</option>
                                <option value="5">05 - May</option>
                                <option value="6">06 - June</option>
                                <option value="7">07 - July</option>
                                <option value="8">08 - August</option>
                                <option value="9">09 - September</option>
                                <option value="10">10 - October</option>
                                <option value="11">11 - November</option>
                                <option value="12">12 - December</option>
                            </select>
                            <select class="form-select" @bind="_accDay" disabled="@_saving" @bind:after="UpdateAcceptedDate">
                                <option value="0">Day</option>
                                @for (int i = 1; i <= 31; i++)
                                {
                                    <option value="@i">@i</option>
                                }
                            </select>
                            <select class="form-select" @bind="_accYear" disabled="@_saving" @bind:after="UpdateAcceptedDate">
                                <option value="0">Year</option>
                                @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 10; year--)
                                {
                                    <option value="@year">@year</option>
                                }
                            </select>
                        </div>
                        <ValidationMessage For="@(() => _memberForm.AcceptedDate)" />
                        <small class="text-muted">Date when member was accepted (leave blank if not yet accepted)</small>
                    </div>
                    
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        <small><strong>Note:</strong> Members with GUEST status are automatically marked as Non-Portuguese origin.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Card -->
        <div class="col-lg-6">
            <div class="form-card">
                <div class="form-card-header">
                    <i class="bi bi-sticky"></i>
                    <h5>Additional Notes</h5>
                </div>
                <div class="form-card-body">
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <InputTextArea class="form-control form-control-modern" @bind-Value="_memberForm.Notes" rows="8" placeholder="Add any additional information about this member..." disabled="@_saving" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-bar">
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
            </div>
        }
        
        <div class="d-flex gap-3 justify-content-end">
            <button type="button" class="btn btn-outline-secondary" @onclick="GoBack" disabled="@_saving">
                <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="submit" class="btn-save @(_saving ? "saving" : "") @(TutorialService.ShouldShowStep(3) ? "tutorial-pulse" : "")" disabled="@_saving">
                @if (_saving)
                {
                    <span class="spinner"></span>
                    <span class="save-text">Saving...</span>
                }
                else
                {
                    <i class="bi bi-check-circle me-2"></i>
                    <span class="save-text">Save Member</span>
                }
            </button>
        </div>
    </div>
</EditForm>

@code {
    private MemberFormModel _memberForm = new();
    private bool _saving = false;
    private bool _showSuccessAnimation = false;
    private string _errorMessage = "";
    private string _newMemberName = "";
    private int _newMemberId = 0;
    private bool _showDuesPrompt = false;
    private List<string> _cities = new();
    private List<string> _states = new();
    private List<string> _postalCodes = new();

    // Date picker backing fields
    private int _dobMonth = 0;
    private int _dobDay = 0;
    private int _dobYear = 0;
    
    private int _appMonth = 0;
    private int _appDay = 0;
    private int _appYear = 0;
    
    private int _accMonth = 0;
    private int _accDay = 0;
    private int _accYear = 0;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    protected override void OnInitialized()
    {
        // Don't set default values - let user fill them out
        
        TutorialService.OnTutorialStateChanged += HandleTutorialStateChanged;

        // Auto-advance from Step 2 (Navigate to Membership) to Step 3 (Fill out form)
        if (TutorialService.ShouldShowStep(2))
        {
            _ = TutorialService.NextStepAsync();
        }

        // Load existing cities, states and postal codes for dropdowns
        try
        {
            _cities = MemberRepository.GetDistinctCities()
                .Where(c => !string.IsNullOrWhiteSpace(c))
                .OrderBy(c => c)
                .ToList();
            
            _states = MemberRepository.GetDistinctStates()
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .OrderBy(s => s)
                .ToList();
                
            _postalCodes = MemberRepository.GetDistinctPostalCodes()
                .Where(z => !string.IsNullOrWhiteSpace(z))
                .OrderBy(z => z)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dropdown data");
        }
    }

    private void UpdateDateOfBirth()
    {
        if (_dobMonth > 0 && _dobDay > 0 && _dobYear > 0)
        {
            try
            {
                _memberForm.DateOfBirth = new DateTime(_dobYear, _dobMonth, _dobDay);
            }
            catch
            {
                // Invalid date combination (e.g., Feb 30)
                _memberForm.DateOfBirth = null;
            }
        }
        else
        {
            _memberForm.DateOfBirth = null;
        }
    }

    private void UpdateApplicationDate()
    {
        if (_appMonth > 0 && _appDay > 0 && _appYear > 0)
        {
            try
            {
                _memberForm.ApplicationDate = new DateTime(_appYear, _appMonth, _appDay);
            }
            catch
            {
                // Invalid date combination
                _memberForm.ApplicationDate = null;
            }
        }
        else
        {
            _memberForm.ApplicationDate = null;
        }
    }

    private void UpdateAcceptedDate()
    {
        if (_accMonth > 0 && _accDay > 0 && _accYear > 0)
        {
            try
            {
                _memberForm.AcceptedDate = new DateTime(_accYear, _accMonth, _accDay);
            }
            catch
            {
                // Invalid date combination
                _memberForm.AcceptedDate = null;
            }
        }
        else
        {
            _memberForm.AcceptedDate = null;
        }
    }

    private void ClearAcceptedDate()
    {
        _accMonth = 0;
        _accDay = 0;
        _accYear = 0;
        _memberForm.AcceptedDate = null;
    }

    private async Task SaveMember()
    {
        _saving = true;
        _errorMessage = "";
        
        // Custom validation: At least one phone required
        if (string.IsNullOrWhiteSpace(_memberForm.Phone) && string.IsNullOrWhiteSpace(_memberForm.CellPhone))
        {
            _errorMessage = "At least one phone number (Home or Cell) is required.";
            _saving = false;
            return;
        }

        // Custom validation: Minimum Age
        if (_memberForm.DateOfBirth.HasValue)
        {
            var age = MemberStatusHelper.CalculateAge(_memberForm.DateOfBirth.Value, DateTime.Today);
            if (age < MemberStatusHelper.MinimumMemberAge)
            {
                _errorMessage = $"Member must be at least {MemberStatusHelper.MinimumMemberAge} years old (Current age: {age}).";
                _saving = false;
                return;
            }
        }
        
        StateHasChanged();

        try
        {
            // Automatically set IsNonPortugueseOrigin based on status
            bool isNonPortuguese = _memberForm.Status?.Trim().Equals("GUEST", StringComparison.OrdinalIgnoreCase) ?? false;
            
            // Create Member object with formatted data
            var member = new Member
            {
                FirstName = FormatName(_memberForm.FirstName),
                MiddleName = FormatName(_memberForm.MiddleName),
                LastName = FormatName(_memberForm.LastName),
                Suffix = _memberForm.Suffix?.Trim(),
                Address1 = FormatAddress(_memberForm.Address1),
                City = FormatName(_memberForm.City),
                State = _memberForm.State?.Trim().ToUpperInvariant(),
                PostalCode = _memberForm.PostalCode?.Trim(),
                Phone = FormatPhone(_memberForm.Phone),
                CellPhone = FormatPhone(_memberForm.CellPhone),
                Email = string.IsNullOrWhiteSpace(_memberForm.Email) ? null : _memberForm.Email.Trim().ToLowerInvariant(),
                ApplicationDate = _memberForm.ApplicationDate,
                AcceptedDate = _memberForm.AcceptedDate,
                DateOfBirth = _memberForm.DateOfBirth,
                Status = _memberForm.Status,
                IsNonPortugueseOrigin = isNonPortuguese,
                Notes = _memberForm.Notes?.Trim(),
                AddressInvalid = false
            };

            // Save to database
            var newMemberId = MemberRepository.InsertMember(member);
            _newMemberId = newMemberId;
            _newMemberName = $"{member.FirstName} {member.LastName}";
            
            // Add new values to dropdown lists (prevent duplicates)
            if (!string.IsNullOrWhiteSpace(member.City) && !_cities.Contains(member.City, StringComparer.OrdinalIgnoreCase))
            {
                _cities.Add(member.City);
                _cities.Sort();
            }
            if (!string.IsNullOrWhiteSpace(member.State) && !_states.Contains(member.State, StringComparer.OrdinalIgnoreCase))
            {
                _states.Add(member.State);
                _states.Sort();
            }
            if (!string.IsNullOrWhiteSpace(member.PostalCode) && !_postalCodes.Contains(member.PostalCode, StringComparer.OrdinalIgnoreCase))
            {
                _postalCodes.Add(member.PostalCode);
                _postalCodes.Sort();
            }
            
            // Show success animation or prompt
            _saving = false;

            // Tutorial: Advance to Step 4 after saving
            if (TutorialService.ShouldShowStep(3))
            {
                await TutorialService.NextStepAsync();
            }

            if (member.AcceptedDate.HasValue)
            {
                _showDuesPrompt = true;
            }
            else
            {
                _showSuccessAnimation = true;
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving new member");
            _errorMessage = "Failed to save member. Please try again.";
            _saving = false;
        }
    }
    
    // Format names: Capitalize first letter of each word, lowercase the rest
    private string? FormatName(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return name;
        
        var textInfo = System.Globalization.CultureInfo.CurrentCulture.TextInfo;
        return textInfo.ToTitleCase(name.Trim().ToLowerInvariant());
    }
    
    // Format addresses: Proper capitalization
    private string? FormatAddress(string? address)
    {
        if (string.IsNullOrWhiteSpace(address)) return address;
        
        var textInfo = System.Globalization.CultureInfo.CurrentCulture.TextInfo;
        return textInfo.ToTitleCase(address.Trim().ToLowerInvariant());
    }
    
    // Format phone numbers to xxx-xxx-xxxx if they are 10 digits
    private string? FormatPhone(string? phone)
    {
        if (string.IsNullOrWhiteSpace(phone)) return phone;
        
        // Remove allowed characters to check for digits
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        
        if (digits.Length == 10)
        {
            return $"{digits.Substring(0, 3)}-{digits.Substring(3, 3)}-{digits.Substring(6)}";
        }
        
        return phone?.Trim();
    }

    private void GoBack()
    {
        if (!string.IsNullOrEmpty(ReturnUrl))
        {
            NavManager.NavigateTo(ReturnUrl);
        }
        else
        {
            NavManager.NavigateTo("/members");
        }
    }

    private void GoToMemberList()
    {
        NavManager.NavigateTo("/members");
    }

    private void AddAnother()
    {
        _showSuccessAnimation = false;
        _showDuesPrompt = false;
        _newMemberId = 0;
        _memberForm = new MemberFormModel(); // Reset to blank form
    }

    private void GoToRecordDues()
    {
        // Tutorial: Advance to Step 5 (Navigate to Dues) if we're on Step 4
        if (TutorialService.ShouldShowStep(4))
        {
            _ = TutorialService.NextStepAsync();
        }
        NavManager.NavigateTo($"/members/{_newMemberId}/dues");
    }

    private void HandleTutorialStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        TutorialService.OnTutorialStateChanged -= HandleTutorialStateChanged;
    }

    private class MemberFormModel
    {
        [Required(ErrorMessage = "First name is required")]
        [StringLength(50, ErrorMessage = "First name cannot exceed 50 characters")]
        public string FirstName { get; set; } = "";

        public string? MiddleName { get; set; }

        [Required(ErrorMessage = "Last name is required")]
        [StringLength(50, ErrorMessage = "Last name cannot exceed 50 characters")]
        public string LastName { get; set; } = "";

        public string? Suffix { get; set; }

        private string? _email;
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string? Email 
        { 
            get => _email; 
            set => _email = string.IsNullOrWhiteSpace(value) ? null : value; 
        }

        public string? Phone { get; set; }
        public string? CellPhone { get; set; }
        
        [Required(ErrorMessage = "Address is required")]
        public string? Address1 { get; set; }
        
        [Required(ErrorMessage = "City is required")]
        public string? City { get; set; }
        
        [Required(ErrorMessage = "State is required")]
        [StringLength(2, ErrorMessage = "State must be 2 characters")]
        public string? State { get; set; }
        
        [Required(ErrorMessage = "Zip code is required")]
        public string? PostalCode { get; set; }

        [Required(ErrorMessage = "Status is required")]
        public string Status { get; set; } = "";

        [Required(ErrorMessage = "Application date is required")]
        public DateTime? ApplicationDate { get; set; }
        
        public DateTime? AcceptedDate { get; set; }
        
        [Required(ErrorMessage = "Date of birth is required")]
        public DateTime? DateOfBirth { get; set; }
        public string? Notes { get; set; }
    }
}
