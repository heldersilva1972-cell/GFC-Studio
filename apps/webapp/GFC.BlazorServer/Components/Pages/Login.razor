@page "/login"
@using GFC.BlazorServer.Services
@using GFC.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@attribute [AllowAnonymous]
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ILogger<Login> Logger
@inject IJSRuntime JSRuntime
@inject IMagicLinkService MagicLinkService
@inject IUserConnectionService UserConnectionService
@inject IBlazorSystemSettingsService SystemSettingsService

<PageTitle>Login - GFC Membership</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h1>GFC Membership System</h1>
            <p class="text-muted">Please sign in to continue</p>
        </div>

        @if (_loginRestricted)
        {
            <div class="alert alert-warning text-center" role="alert">
                <h4 class="alert-heading h5"><i class="bi bi-shield-lock-fill"></i> Access Restricted</h4>
                <p class="mb-0">Login is restricted to secure private network access only.</p>
                <div class="mt-2 small text-muted">
                    Your location: @UserConnectionService.LocationType
                </div>
            </div>
        }
        else
        {
            <div class="mb-4">
                <ul class="nav nav-pills nav-fill">
                    <li class="nav-item">
                        <a class="nav-link @(_loginMode == LoginMode.Password ? "active" : "")" 
                           href="javascript:void(0)" 
                           @onclick="() => SetMode(LoginMode.Password)">
                            Password
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(_loginMode == LoginMode.MagicLink ? "active" : "")" 
                           href="javascript:void(0)" 
                           @onclick="() => SetMode(LoginMode.MagicLink)">
                            Magic Link
                        </a>
                    </li>
                </ul>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="alert alert-danger" role="alert">@_error</div>
            }

            @if (!string.IsNullOrEmpty(_successMessage))
            {
                <div class="alert alert-success" role="alert">@_successMessage</div>
            }

            @if (_loginMode == LoginMode.Password)
            {
                <EditForm Model="_model" OnValidSubmit="HandleLoginAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="alert alert-danger" />

                    <div class="mb-3">
                        <label class="form-label" for="username">Username</label>
                        <InputText id="username" 
                                   class="form-control" 
                                   @bind-Value="_model.Username" 
                                   placeholder="Enter username" />
                        <ValidationMessage For="@(() => _model.Username)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="password">Password</label>
                        <input id="password"
                               type="password"
                               class="form-control"
                               @bind="_model.Password"
                               placeholder="Enter password" />
                        <ValidationMessage For="@(() => _model.Password)" />
                    </div>

                    <div class="mb-3 form-check">
                        <InputCheckbox id="remember-me" class="form-check-input" @bind-Value="_model.RememberMe" />
                        <label class="form-check-label" for="remember-me">Remember this device</label>
                    </div>

                    <button class="btn btn-primary w-100 mt-3"
                            type="submit"
                            disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Signing in...</span>
                        }
                        else
                        {
                            <span>Sign In</span>
                        }
                    </button>
                </EditForm>
            }
            else
            {
                <EditForm Model="_magicLinkModel" OnValidSubmit="HandleMagicLinkAsync">
                    <DataAnnotationsValidator />
                    <div class="mb-3">
                        <label class="form-label text-start d-block" for="email">Email Address</label>
                        <InputText id="email" 
                                   class="form-control" 
                                   @bind-Value="_magicLinkModel.Email" 
                                   placeholder="Enter your email" />
                        <ValidationMessage For="@(() => _magicLinkModel.Email)" />
                        <div class="form-text">We'll send a secure login link to your inbox.</div>
                    </div>

                    <button class="btn btn-primary w-100 mt-3"
                            type="submit"
                            disabled="@_isSubmitting">
                         @if (_isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Sending...</span>
                        }
                        else
                        {
                            <span>Send Magic Link</span>
                        }
                    </button>
                </EditForm>
            }
        }
    </div>
</div>

<style>
    .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        padding: 2rem;
    }

    .login-card {
        background: rgba(15, 23, 42, 0.95) !important;
        border-radius: 1.5rem;
        padding: 2.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 420px;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .login-header h1 {
        color: #ffffff !important;
        font-weight: 700 !important;
        margin-bottom: 0.5rem;
    }

    .login-header p {
        color: #e2e8f0 !important;
        font-size: 1rem;
    }

    /* Force labels to be bright white and bold */
    .login-card .form-label, 
    .login-card .form-check-label,
    .login-card label {
        color: #ffffff !important;
        font-weight: 700 !important;
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
        display: block !important;
        opacity: 1 !important;
        text-shadow: 0 1px 3px rgba(0,0,0,0.8) !important;
    }

    .login-card .form-check-label {
        display: inline-block !important;
        margin-bottom: 0 !important;
        margin-left: 0.5rem !important;
        vertical-align: middle !important;
    }

    .login-card .nav-link {
        color: #cbd5e1 !important;
        font-weight: 600;
        border-radius: 0.75rem;
        margin: 0 0.25rem;
    }

    .login-card .nav-link.active {
        background-color: #2563eb !important;
        color: #ffffff !important;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .login-card .form-control {
        background: #f8fafc !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 0.75rem !important;
        padding: 0.75rem 1rem !important;
        font-size: 1rem !important;
        color: #1e293b !important;
    }

    .login-card .btn-primary {
        background: #3b82f6 !important;
        border: none !important;
        padding: 0.8rem !important;
        font-weight: 700 !important;
        font-size: 1.1rem !important;
        border-radius: 0.75rem !important;
        margin-top: 1rem !important;
    }

    .login-card .alert {
        border-radius: 0.75rem;
        font-weight: 500;
    }
</style>

@code {
    private LoginModel _model = new();
    private MagicLinkModel _magicLinkModel = new();
    private bool _isSubmitting = false;
    private string? _error;
    private string? _successMessage;
    private string? _resolvedReturnUrl;
    private bool _loginRestricted = false;
    private LoginMode _loginMode = LoginMode.Password;

    [Parameter]
    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        UpdateResolvedReturnUrl();
        await CheckLoginRestriction();

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                Navigation.NavigateTo(GetPostLoginDestination());
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during initialization: {Error}", ex.Message);
        }
    }

    private async Task CheckLoginRestriction()
    {
        try
        {
            // Dev override: if loopback, never restrict
            if (UserConnectionService.LocationType == LocationType.Local)
            {
                return;
            }

            var settings = await SystemSettingsService.GetSystemSettingsAsync();
            if (settings != null && settings.EnforceVpn)
            {
                if (UserConnectionService.LocationType != LocationType.VPN &&
                    UserConnectionService.LocationType != LocationType.LAN &&
                    UserConnectionService.LocationType != LocationType.Local)
                {
                    _loginRestricted = true;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to check login restriction");
        }
    }

    private void SetMode(LoginMode mode)
    {
        _loginMode = mode;
        _error = null;
        _successMessage = null;
    }

    private async Task HandleLoginAsync()
    {
        _error = null;
        _isSubmitting = true;
        UpdateResolvedReturnUrl();

        try
        {
            var result = await AuthStateProvider.LoginAsync(_model.Username, _model.Password, _model.RememberMe);

            if (result.Code != LoginResultCode.Success)
            {
                if (result.Code == LoginResultCode.Error && !string.IsNullOrEmpty(result.ErrorMessageForLog))
                {
                    _error = result.ErrorMessageForLog;
                }
                else
                {
                    _error = GetUserMessage(result.Code);
                }
                return;
            }
             
            if (result.User == null)
            {
                 _error = "Login failed.";
                 return;
            }

            if (!string.IsNullOrWhiteSpace(result.DeviceToken))
            {
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "gfc_device_token", result.DeviceToken);
                // Keep cookie in sync for middleware
                await JSRuntime.InvokeVoidAsync("window.setCookie", "GFC_DeviceTrustToken", result.DeviceToken, 365);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "gfc_device_token");
            }

            if (result.PasswordChangeRequired)
            {
                Navigation.NavigateTo("/changepassword", forceLoad: false);
                return;
            }

            Navigation.NavigateTo(GetPostLoginDestination(), forceLoad: false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Login error");
            _error = "An unexpected error occurred.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task HandleMagicLinkAsync()
    {
        _error = null;
        _successMessage = null;
        _isSubmitting = true;

        try
        {
            var sent = await MagicLinkService.SendMagicLinkAsync(_magicLinkModel.Email);
            if (sent)
            {
                _successMessage = "A magic link has been sent to your email address. It will expire in 15 minutes.";
                _magicLinkModel.Email = string.Empty; // Clear form
            }
            else
            {
                // To avoid enumeration, we might want to say "If the email exists..." 
                // but if we used 'false' for rate limit too, generic message is best.
                // However, Service returns false for both Not Found and Rate Limit.
                _successMessage = "If an account exists for this email, we have sent a login link.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Magic link error");
            _error = "Failed to send magic link. Please try again.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private sealed class LoginModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string Username { get; set; } = "";
        [System.ComponentModel.DataAnnotations.Required]
        public string Password { get; set; } = "";
        public bool RememberMe { get; set; }
    }

    private sealed class MagicLinkModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.EmailAddress]
        public string Email { get; set; } = "";
    }

    private enum LoginMode { Password, MagicLink }

    // Helpers from original file
    private static string GetUserMessage(LoginResultCode code) => code switch
    {
        LoginResultCode.InvalidCredentials => "Invalid username or password.",
        LoginResultCode.AccountLockedOrDisabled => "Your account is locked or disabled.",
        _ => "Unable to sign in at this time."
    };

    private void UpdateResolvedReturnUrl() => _resolvedReturnUrl = NormalizeReturnUrl(ReturnUrl);
    private string GetPostLoginDestination() => _resolvedReturnUrl ?? "/";
    
    private static string? NormalizeReturnUrl(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return null;
        try { raw = Uri.UnescapeDataString(raw); } catch { return null; }
        if (raw.StartsWith("//") || raw.Contains("://")) return null;
        if (!raw.StartsWith('/')) raw = "/" + raw;
        return raw.Equals("/login", StringComparison.OrdinalIgnoreCase) ? null : raw;
    }
}
