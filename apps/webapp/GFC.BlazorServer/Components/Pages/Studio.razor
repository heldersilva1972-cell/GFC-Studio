@page "/studio"
@page "/studio/{PageId:int}"
@layout GFC.BlazorServer.Components.Layout.StudioLayout
@using System.Text.Json
@using GFC.Core.Models
@using GFC.Core.Interfaces
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Auth
@using GFC.BlazorServer.Components.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using GFC.BlazorServer.Data
@implements IDisposable
@inject IJSRuntime JSRuntime
@inject GFC.BlazorServer.Services.IStudioService StudioService
@inject Services.IStudioCmsService CmsService
@inject IStudioAutoSaveService AutoSaveService
@inject IPageService PageService
@inject ITemplateService TemplateService
@inject IStudioEngineService EngineService
@inject IContentIngestionService ContentIngestionService
@inject IStaticExportService StaticExportService
@inject ILogger<Studio> Logger
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAuthorizationService AuthorizationService
@inject IConfiguration Configuration
@inject IDbContextFactory<GfcDbContext> DbContextFactory
@inject GFC.BlazorServer.Services.IMediaAssetService AssetService
@inject GFC.Core.Interfaces.IProjectFileService ProjectFileService

<script src="/js/studio-preview.js"></script>

<style>
    /* DIRECT OVERRIDE TO ENSURE BLUE HEADER APPLIES WITHOUT REBUILD */
    .studio-container {
        --ide-bg-header: #93c5fd !important; /* Standard Light Blue */
        --ide-bg-activity-bar: #f0f9ff !important; /* Very pale blue for sidebar */
    }
    
    .top-command-bar {
        background-color: #93c5fd !important;
        border-bottom: 1px solid #60a5fa !important;
    }
    
    .brand-section {
        color: #172554 !important; /* Deep Blue Text */
    }
    
    .top-command-bar .text-muted {
        color: #1e3a8a !important;
    }
    
    .toolbar-controls {
        background: rgba(255,255,255,0.4) !important;
        border: 1px solid rgba(255,255,255,0.6) !important;
    }

    /* FIX: Sidebar Selection */
    .pro-list-item {
        padding: 10px 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        transition: all 0.2s;
        border-radius: 6px;
        margin-bottom: 2px;
        border: 1px solid transparent;
    }

    .pro-list-item:hover {
        background-color: #f8fafc;
        border-color: #e2e8f0;
    }

    .pro-list-item.selected {
        background-color: #eff6ff !important;
        color: #1e40af !important;
        border-color: #bfdbfe !important;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* FIX: Right Inspector Header & Tabs */
    .inspector-tabs {
        background-color: #f1f5f9 !important; /* Light gray */
        border-bottom: 1px solid #e2e8f0 !important;
    }

    .inspector-tab {
        color: #64748b !important; /* Muted slate */
    }
    
    .inspector-tab:hover {
        background-color: #e2e8f0 !important;
        color: #334155 !important;
    }

    .inspector-tab.active {
        background-color: #ffffff !important;
        color: #2563eb !important; /* Bright Blue */
        border-bottom: 2px solid #2563eb !important;
    }

    .panel-section-header {
        background-color: #f8fafc !important; /* Very light gray */
        color: #334155 !important; /* Dark slate text */
        border-bottom: 1px solid #e2e8f0 !important;
    }
    
    /* FIX: Input Fields Dark Backgrounds */
    .pro-input, .pro-select {
        background-color: #ffffff !important;
        color: #1e293b !important;
        border: 1px solid #cbd5e1 !important;
    }

    /* FIX: Collapsible Sidebar & Inspector */
    .side-bar.collapsed,
    .inspector-panel.collapsed {
        display: none !important;
        width: 0 !important;
    }

    /* FIX: Component Cards (Force Light Theme) */
    .pro-card {
        background-color: #ffffff !important;
        color: #334155 !important; /* Slate-700 */
        border: 1px solid #cbd5e1 !important; /* Slate-300 */
        box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
    }
    
    .pro-card:hover {
        border-color: #3b82f6 !important; /* Blue-500 */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
        transform: translateY(-1px);
    }
    
    .pro-card .text-muted {
        color: #64748b !important; /* Ensure icons aren't too dark/light */
    }

    /* FIX: Inspector Accordions (Force Light Theme) */
    .style-group summary {
        background-color: #f8fafc !important; /* Very light gray */
        color: #334155 !important; /* Dark slate text */
        border-bottom: 1px solid #e2e8f0 !important;
    }

    /* FIX: Icon Buttons (Force Light Theme) */
    .pro-icon-btn {
        background-color: #ffffff !important;
        color: #475569 !important;
        border: 1px solid #cbd5e1 !important;
    }

    .pro-icon-btn.active, .pro-icon-btn:hover {
        background-color: #dbeafe !important;
        color: #1e40af !important;
        border-color: #93c5fd !important;
    }

    /* FIX: Animation Timeline (Force Light Theme) */
    .animation-orchestrator-panel-container {
        background-color: #ffffff !important;
        color: #334155 !important;
        border-top: 1px solid #e2e8f0 !important;
        position: relative !important; /* Ensure it fits in tab */
        height: 100% !important;
    }
    
    .panel-toolbar {
        background-color: #f8fafc !important;
        border-bottom: 1px solid #e2e8f0 !important;
    }
    
    .editor-section {
        background-color: #f1f5f9 !important;
        border-left: 1px solid #e2e8f0 !important;
    }
    
    .time-ruler {
        background-color: #f1f5f9 !important;
        border-bottom: 1px solid #e2e8f0 !important;
    }
    
    .time-marker {
        border-left: 1px solid #cbd5e1 !important;
        color: #94a3b8 !important;
    }
    
    .layer-header {
        background-color: #ffffff !important;
        color: #475569 !important;
        border-right: 1px solid #e2e8f0 !important;
    }
    
    .animation-layer { 
        border-bottom: 1px solid #f1f5f9 !important; 
    }
    
    .motion-bar {
        background-color: #dbeafe !important;
        border: 1px solid #93c5fd !important; 
        color: #1e40af !important;
    }
    .status-badge {
        background: rgba(255,255,255,0.7) !important;
        color: #1e3a8a !important;
        border: 1px solid rgba(37, 99, 235, 0.2) !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        font-weight: 600;
        z-index: 100;
        min-width: 120px;
        text-align: center;
    }

    .status-badge i {
        color: #2563eb;
    }

    .center-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .engine-log-console {
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 11px;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        border-radius: 4px;
        line-height: 1.4;
    }

    .log-line.error { color: #f87171; }
    .log-line.warn { color: #fbbf24; }
    .log-line.info { color: #60a5fa; }

    .canvas-frame {
        background-color: #ffffff !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }

    .studio-preview-iframe {
        background-color: #ffffff !important;
    }

    .empty-canvas-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        z-index: 5;
        pointer-events: auto; /* Ensure it can receive drops */
    }

    .empty-canvas-content {
        text-align: center;
        max-width: 400px;
        padding: 40px;
        border: 2px dashed #e2e8f0;
        border-radius: 24px;
        background: #fafafa;
        color: #64748b;
    }
</style>

<div class="studio-container">
    <!-- 1. PROFESSIONAL HEADER (Minimal Toolbar) -->
    <div class="top-command-bar">
        <div class="brand-section d-flex align-items-center">
            <a href="/" class="icon-btn me-2" title="Exit to Home">
                <i class="bi bi-list"></i>
            </a>
            <span class="fs-6 fw-bold me-3">GFC Studio</span>
            <button class="btn btn-sm btn-outline-dark border-0 px-2 me-2 @(showProjectPicker ? "bg-light" : "")" @onclick="() => { BrowseProjectFolder(); showProjectPicker = true; }" title="Select Project Folder">
                <i class="bi @(string.IsNullOrEmpty(currentProjectRoot) ? "bi-folder2-open" : "bi-folder-check text-success") me-1"></i> 
                @(string.IsNullOrEmpty(currentProjectRoot) ? "Open Project..." : currentProjectRoot.Split('\\').Last())
            </button>
            <button class="btn btn-sm btn-outline-dark border-0 px-2 me-2" @onclick="() => showPageBrowser = true" title="Switch Page (Ctrl+P)">
                <i class="bi bi-search me-1"></i> Open Page...
            </button>
            <button class="btn btn-sm btn-primary px-3 shadow-sm rounded-pill fw-bold me-3" @onclick='() => { newPageFolder = ExistingFolders.FirstOrDefault() ?? "/"; showNewPageModal = true; }' style="font-size: 0.75rem;">
                <i class="bi bi-plus-lg me-1"></i> New Page
            </button>
            
            <div class="form-check form-switch d-flex align-items-center gap-2 border-start ps-3">
                <input class="form-check-input" type="checkbox" id="helperToggle" @bind="isHelperModeEnabled">
                <label class="form-check-label small fw-bold text-muted" for="helperToggle">
                    <i class="bi bi-life-preserver text-info me-1"></i> Helper
                </label>
            </div>
        </div>

        <div class="center-section d-flex flex-column align-items-center justify-content-center flex-grow-1 mx-3" style="max-width: 600px;">
             <!-- Console / Log Box (Larger) -->
             <div class="log-console w-100 bg-dark text-light rounded p-2 mb-2 shadow-sm border border-secondary" style="height: 120px; min-height: 120px; overflow-y: auto; font-family: monospace; font-size: 0.75rem;">
                @if (activityLog.Count == 0)
                {
                    <div class="text-secondary opacity-50 fst-italic">> System Ready...</div>
                }
                else
                {
                    @foreach (var log in activityLog.AsEnumerable().Reverse())
                    {
                        <div class="@(log.IsError ? "text-warning fw-bold" : "text-info") border-bottom border-secondary border-opacity-25 pb-1 mb-1">
                            <span class="text-secondary me-2">[@log.Time.ToString("HH:mm:ss")]</span>
                            @log.Message
                        </div>
                    }
                }
             </div>
            
             <div class="toolbar-controls d-flex align-items-center mt-1 scale-75">
                <button class="icon-btn @(currentViewport == "desktop" ? "active" : "")" @onclick='() => setViewport("desktop")' title="Desktop View">
                    <i class="bi bi-display"></i>
                </button>
                <button class="icon-btn @(currentViewport == "tablet" ? "active" : "")" @onclick='() => setViewport("tablet")' title="Tablet View">
                    <i class="bi bi-tablet"></i>
                </button>
                <button class="icon-btn @(currentViewport == "mobile" ? "active" : "")" @onclick='() => setViewport("mobile")' title="Mobile View">
                    <i class="bi bi-phone"></i>
                </button>
                <div class="vr mx-1 bg-white opacity-25" style="height: 16px;"></div>
                <a href="@_previewUrl" target="_blank" class="icon-btn" title="Open Preview in New Tab (Debug Iframe)">
                    <i class="bi bi-box-arrow-up-right"></i>
                </a>
                <button class="icon-btn text-warning" @onclick="() => LoadPageAsync(PageId)" title="Reload Preview Frame">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <div class="actions-section d-flex gap-2">
            <div class="undo-redo-group me-2 align-self-center">
                 <button class="icon-btn" @onclick="Undo" disabled="@(undoStack.Count == 0)" title="Undo (Ctrl+Z)">
                    <i class="bi bi-arrow-counterclockwise"></i>
                 </button>
                 <button class="icon-btn" @onclick="Redo" disabled="@(redoStack.Count == 0)" title="Redo (Ctrl+Y)">
                    <i class="bi bi-arrow-clockwise"></i>
                 </button>
            </div>

             <button class="action-btn btn-save" @onclick="() => SaveDraft()">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="action-btn btn-publish" @onclick="OpenPublishWizard">
                <i class="bi bi-rocket-takeoff"></i> Publish
            </button>
            <div class="vr mx-2 bg-secondary opacity-25"></div>
            <button class="icon-btn" @onclick="() => isRightPanelCollapsed = !isRightPanelCollapsed" title="Toggle Inspector">
                <i class="bi bi-layout-sidebar-reverse"></i>
            </button>
        </div>
    </div>

    @if (isHelperModeEnabled)
    {
        <div class="helper-overlay p-3 bg-white shadow-lg border rounded-3 position-absolute" style="top: 70px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 400px; border-left: 5px solid #0dcaf0 !important;">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="fw-bold text-info"><i class="bi bi-life-preserver me-2"></i>Studio Helper</h6>
                <button class="btn-close small" @onclick="() => isHelperModeEnabled = false"></button>
            </div>
            
            @if (currentHelperStep == 1)
            {
                <p class="small text-muted mb-2">Welcome! Let's create your first page. Click the <b>New Page</b> button in the top left.</p>
                <div class="progress" style="height: 4px;"><div class="progress-bar bg-info" style="width: 20%"></div></div>
            }
            else if (currentHelperStep == 2)
            {
                 <p class="small text-muted mb-2">Great! Now open the <b>Components Panel</b> (Cube Icon on the left sidebar).</p>
                 <div class="progress" style="height: 4px;"><div class="progress-bar bg-info" style="width: 40%"></div></div>
            }
            else if (currentHelperStep == 3)
            {
                 <p class="small text-muted mb-2">Drag a <b>Hero Section</b> from the list onto the empty canvas area.</p>
                 <div class="progress" style="height: 4px;"><div class="progress-bar bg-info" style="width: 60%"></div></div>
            }
            else if (currentHelperStep == 4)
            {
                 <p class="small text-muted mb-2">Nice! Now add a <b>Text Block</b> below the Hero section.</p>
                 <div class="progress" style="height: 4px;"><div class="progress-bar bg-info" style="width: 80%"></div></div>
            }
             else if (currentHelperStep == 5)
            {
                 <p class="small text-muted mb-2">Finally, drag a <b>Button</b> onto the canvas.</p>
                 <div class="progress" style="height: 4px;"><div class="progress-bar bg-info" style="width: 90%"></div></div>
            }
            else
            {
                 <p class="small text-muted mb-2 text-success"><b>You're all set!</b> You've built a basic page. Turn off Helper Mode to continue freely.</p>
                 <div class="progress" style="height: 4px;"><div class="progress-bar bg-success" style="width: 100%"></div></div>
            }
        </div>
    }

    <!-- 2. MAIN WORKSPACE ROW -->
    <div class="studio-workspace">
        
        <!-- A. ACTIVITY BAR (Far Left Rail) -->
        <div class="activity-bar">
            <!-- 1. Pages / Explorer -->
            <button class="activity-item @(activeToolboxTab == "pages" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("pages")' 
                    title="Pages & Navigation">
                <i class="bi bi-files"></i>
            </button>
            
             <!-- 2. Outline / Tree View (NEW) -->
            <button class="activity-item @(activeToolboxTab == "outline" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("outline")' 
                    title="Page Outline">
                <i class="bi bi-diagram-3"></i>
            </button>

            <!-- 3. Components / Add -->
            <button class="activity-item @(activeToolboxTab == "elements" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("elements")' 
                    title="Add Elements">
                <i class="bi bi-plus-square"></i>
            </button>

             <!-- 4. CMS / Data (NEW) -->
             <button class="activity-item @(activeToolboxTab == "cms" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("cms")' 
                    title="CMS Collections">
                <i class="bi bi-database"></i>
            </button>
            
            <!-- 5. Assets / Media (NEW) -->
             <button class="activity-item @(activeToolboxTab == "assets" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("assets")' 
                    title="Media Assets">
                <i class="bi bi-images"></i>
            </button>

            <!-- 6. Templates -->
            <button class="activity-item @(activeToolboxTab == "templates" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("templates")' 
                    title="Templates">
                <i class="bi bi-window-stack"></i>
            </button>

            <!-- 7. Migration -->
             <button class="activity-item @(activeToolboxTab == "migration" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("migration")' 
                    title="Sync & Migration">
                <i class="bi bi-arrow-left-right"></i>
             </button>

            <!-- 8. Engine Manager (NEW) -->
             <button class="activity-item @(activeToolboxTab == "engine" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("engine")' 
                    title="Rendering Engine">
                <i class="bi bi-cpu @(EngineService.IsRunning ? "text-success" : "text-muted")"></i>
             </button>

            <div style="flex-grow: 1;"></div>
            
             <!-- Bottom Actions -->
            <button class="activity-item @(activeToolboxTab == "help" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("help")' 
                    title="How-To Guide">
                <i class="bi bi-question-circle"></i>
            </button>
            <button class="activity-item @(activeToolboxTab == "settings" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => SetSidebarTab("settings")' 
                    title="Studio Settings">
                <i class="bi bi-gear"></i>
            </button>
        </div>

        <!-- B. SIDEBAR (Collapsible Drawer) -->
        <div class="side-bar @(isLeftPanelCollapsed ? "collapsed" : "")">
            <div class="sidebar-header d-flex justify-content-between align-items-center">
                <span>@GetSidebarTitle()</span>
                <button class="btn btn-sm text-muted p-0" @onclick="() => isLeftPanelCollapsed = true"><i class="bi bi-x"></i></button>
            </div>
            <div class="sidebar-content">
                @if (activeToolboxTab == "pages")
                {
                    <div class="p-2">
                        <div class="px-3 py-2 mb-3 bg-light rounded-2 border border-dashed">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <i class="bi bi-folder-check text-success"></i>
                                <span class="fw-bold small opacity-75">WORKSPACE</span>
                            </div>
                            <div class="text-muted x-small text-truncate" title="@currentProjectRoot">@currentProjectRoot</div>
                        </div>

                         <div class="input-group input-group-sm mb-3">
                             <span class="input-group-text bg-white border-end-0"><i class="bi bi-search small"></i></span>
                             <input type="text" class="form-control pro-input border-start-0" placeholder="Search pages..." @bind="pageSearchTerm" @bind:event="oninput" />
                         </div>

                        <div class="tree-view">
                            @foreach (var group in PageGroups.OrderBy(g => g.Key == "/" ? "" : g.Key))
                            {
                                <div class="tree-node expanded mb-1">
                                    <div class="node-header py-1 px-2 d-flex align-items-center gap-2 text-primary fw-bold rounded hover-bg-light" 
                                         style="font-size: 0.72rem; cursor: pointer; transition: background 0.2s;">
                                        <i class="bi @(group.Key == "/" ? "bi-house-door-fill" : "bi-folder-fill text-warning")"></i>
                                        <span class="text-uppercase tracking-wider">@(group.Key == "/" ? "SITE ROOT" : group.Key.TrimStart('/'))</span>
                                        <div class="ms-auto d-flex gap-1">
                                            <button class="btn btn-xs p-0 text-muted opacity-50 hover-opacity-100" @onclick='() => { newPageFolder = group.Key; showNewPageModal = true; }' title="Add Page to this folder">
                                                <i class="bi bi-file-earmark-plus"></i>
                                            </button>
                                            <button class="btn btn-xs p-0 text-muted opacity-50 hover-opacity-100" title="Folder Settings">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="node-content ps-3 border-start ms-2 mt-1">
                                        @foreach (var p in group.OrderBy(x => x.Title))
                                        {
                                            <div class="pro-list-item @(p.Id == PageId ? "selected" : "")" style="padding: 4px 10px; border-radius: 4px; margin-bottom: 1px;">
                                                 <div class="d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center gap-2" @onclick="() => HandlePageSelected(p)" style="cursor: pointer; flex-grow: 1;">
                                                        <i class="bi @(p.IsPublished ? "bi-globe text-success" : "bi-file-earmark-text text-muted")" style="font-size: 0.8rem;"></i>
                                                        <span class="small" style="font-size: 0.8rem; font-weight: @(p.Id == PageId ? "600" : "400")">@p.Title</span>
                                                    </div>
                                                 </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="mt-4 px-2">
                            <div class="text-muted mb-2" style="font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Legend</div>
                            <div class="d-flex align-items-center gap-2 small mb-1">
                                <i class="bi bi-globe text-success"></i> <span class="text-muted">Live on Website</span>
                            </div>
                            <div class="d-flex align-items-center gap-2 small">
                                <i class="bi bi-file-earmark-text text-muted"></i> <span class="text-muted">Draft / Not Public</span>
                            </div>
                        </div>
                    </div>
                }
                
                @if (activeToolboxTab == "outline")
                {
                    <div class="p-2 outline-tree">
                        <div class="pro-list-item mb-2" style="background: transparent;">
                            <i class="bi bi-caret-down-fill me-1 small"></i>
                            <i class="bi bi-window me-2"></i> <strong>Page Body</strong>
                        </div>
                        
                        <div class="ms-3">
                            @if (sections == null || !sections.Any())
                            {
                                <div class="text-muted small ps-3 py-2 border-start">No elements on page</div>
                            }
                            else
                            {
                                @foreach (var section in sections)
                                {
                                    <div class="pro-list-item @(selectedSection?.ClientId == section.ClientId ? "selected" : "")" 
                                         @onclick="() => SelectSection(section)">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi @(section.ComponentType switch {
                                                "HeroSection" => "bi-layout-sidebar-reverse",
                                                "Heading" => "bi-type-h1",
                                                "TextBlock" => "bi-fonts",
                                                "Image" => "bi-image",
                                                "Button" => "bi-hand-index-thumb",
                                                _ => "bi-box"
                                            }) text-muted small"></i>
                                            <span class="text-truncate">@(section.Title ?? section.ComponentType)</span>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
                
                @if (activeToolboxTab == "cms")
                {
                    <div class="p-2">
                        <div class="d-flex justify-content-between align-items-center mb-2 px-2">
                            <span class="text-muted small fw-bold">COLLECTIONS</span>
                            <button class="btn btn-sm btn-link p-0" @onclick="() => showNewCollectionModal = true"><i class="bi bi-plus-circle"></i></button>
                        </div>
                        
                        @if (showNewCollectionModal)
                        {
                            <div class="p-2 bg-light border rounded mb-2">
                                <input class="form-control form-control-sm mb-2" placeholder="Collection Name (e.g. Blogs)" @bind="newCollectionName" />
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-primary w-100" @onclick="CreateCollection">Create</button>
                                    <button class="btn btn-sm btn-outline-secondary w-100" @onclick="() => showNewCollectionModal = false">Cancel</button>
                                </div>
                            </div>
                        }

                        @if (cmsCollections != null)
                        {
                            @foreach (var col in cmsCollections)
                            {
                                <div class="pro-list-item @(selectedCollection?.Id == col.Id ? "active" : "")" @onclick="() => SelectCollection(col)">
                                    <i class="bi bi-database me-2"></i> @col.Name
                                </div>
                            }
                        }

                        @if (selectedCollection != null)
                        {
                             <div class="mt-3 border-top pt-2">
                                <div class="d-flex justify-content-between align-items-center px-2 mb-2">
                                    <span class="text-muted small fw-bold">@selectedCollection.Name Items</span>
                                    <button class="btn btn-sm btn-primary py-0" style="font-size: 0.7rem;" @onclick="AddNewCmsItem">New Item</button>
                                </div>
                                
                                @if (isEditingCmsItem && selectedCmsItem != null)
                                {
                                    <div class="bg-light p-2 border border-start-0 border-end-0 mb-2">
                                         @foreach(var field in selectedCollection.Fields)
                                         {
                                             <div class="mb-2">
                                                 <label class="x-small text-muted">@field.Name</label>
                                                 @if(field.Type == "Image") {
                                                     <div class="input-group input-group-sm">
                                                        <input class="form-control" type="text" value="@(selectedCmsItem.Data.ContainsKey(field.Key) ? selectedCmsItem.Data[field.Key] : "")"
                                                               @onchange="@(e => selectedCmsItem.Data[field.Key] = e.Value?.ToString() ?? "")" placeholder="Image URL" />
                                                        <button class="btn btn-outline-secondary"><i class="bi bi-upload"></i></button>
                                                     </div>
                                                 } else {
                                                    <input class="form-control form-control-sm" type="text" 
                                                           value="@(selectedCmsItem.Data.ContainsKey(field.Key) ? selectedCmsItem.Data[field.Key] : "")"
                                                           @onchange="@(e => selectedCmsItem.Data[field.Key] = e.Value?.ToString() ?? "")" />
                                                 }
                                             </div>
                                         }
                                         <div class="d-flex gap-2">
                                             <button class="btn btn-sm btn-success w-100" @onclick="SaveCmsItem">Save</button>
                                             <button class="btn btn-sm btn-outline-secondary w-100" @onclick="() => isEditingCmsItem = false">Cancel</button>
                                         </div>
                                    </div>
                                }

                                @if (selectedCollection.Items != null)
                                {
                                     @foreach(var item in selectedCollection.Items)
                                     {
                                         var displayTitle = "";
                                         // Try to find a 'title' or 'name' field
                                         try {
                                             var data = JsonSerializer.Deserialize<Dictionary<string, object>>(item.DataJson);
                                             if (data.ContainsKey("title")) displayTitle = data["title"].ToString();
                                             else if (data.ContainsKey("name")) displayTitle = data["name"].ToString();
                                             else displayTitle = $"Item #{item.Id}";
                                         } catch { displayTitle = $"Item #{item.Id}"; }
                                         
                                         <div class="cms-item-row d-flex justify-content-between align-items-center px-2 py-1 border-bottom" style="font-size:0.8rem;">
                                             <span class="text-truncate" style="max-width: 150px;">@displayTitle</span>
                                             <button class="btn btn-sm btn-link text-muted p-0" @onclick="() => EditCmsItem(item)"><i class="bi bi-pencil"></i></button>
                                         </div>
                                     }
                                }
                            </div>
                        }
                    </div>
                }

                @if (activeToolboxTab == "assets")
                {
                    <div class="p-2">
                        <div class="d-flex justify-content-between align-items-center mb-2 px-1">
                            <span class="text-muted small fw-bold">MEDIA ASSETS</span>
                            <button class="icon-btn btn-sm" title="Upload Media"><i class="bi bi-upload"></i></button>
                        </div>
                        <div class="input-group input-group-sm mb-3">
                             <input type="text" class="form-control pro-input" placeholder="Search assets...">
                             <span class="input-group-text bg-white border-start-0"><i class="bi bi-search small"></i></span>
                        </div>
                        
                        <div class="row g-2 px-1">
                            @if (mediaAssets == null || !mediaAssets.Any())
                            {
                                <div class="col-12 py-4 text-center text-muted small">No assets found</div>
                            }
                            else
                            {
                                @foreach (var asset in mediaAssets)
                                {
                                    <div class="col-6">
                                        <div class="asset-thumb-card border rounded overflow-hidden bg-light" 
                                             draggable="true" @ondragstart="@(e => HandleAssetDragStart(asset))"
                                             title="@asset.FileName">
                                            <div class="ratio ratio-1x1 d-flex align-items-center justify-content-center">
                                                @if (asset.ContentType.StartsWith("image/"))
                                                {
                                                    <img src="@asset.FilePath" class="object-fit-cover w-100 h-100" />
                                                }
                                                else
                                                {
                                                    <i class="bi bi-file-earmark-code fs-3 text-muted"></i>
                                                }
                                            </div>
                                            <div class="p-1 x-small text-truncate border-top bg-white">@asset.FileName</div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }

                @if (activeToolboxTab == "templates")
                {
                     <div class="p-2">
                         <select class="form-select form-select-sm pro-select mb-2" @onchange="FilterTemplates">
                                <option value="">All Categories</option>
                                @foreach (var category in templateCategories) { <option value="@category">@category</option> }
                        </select>
                        @foreach (var template in filteredTemplates)
                        {
                            <div class="pro-card" draggable="true" data-comp-type="Template" @ondragstart="@(() => HandleDragStart(template))">
                                <div class="fw-bold">@template.Name</div>
                                <small class="text-muted">@template.Category</small>
                            </div>
                        }
                    </div>
                }
                @if (activeToolboxTab == "elements")
                {
                    <div class="p-2">
                        <!-- 1. Layout -->
                        <div class="panel-section-header bg-transparent border-0 pt-0 pb-1">Layout</div>
                        <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="Section">
                            <i class="bi bi-view-list fs-5 text-muted"></i>
                            <div><div class="fw-bold small">Section</div></div>
                        </div>
                        <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="Grid">
                            <i class="bi bi-grid-3x3 fs-5 text-muted"></i>
                             <div><div class="fw-bold small">Grid</div></div>
                        </div>
                        <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="Columns">
                             <i class="bi bi-layout-three-columns fs-5 text-muted"></i>
                             <div><div class="fw-bold small">Columns</div></div>
                        </div>

                         <!-- 2. Basic -->
                         <div class="panel-section-header bg-transparent border-0 pt-2 pb-1">Basic</div>
                          <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="Heading">
                            <i class="bi bi-type-h1 fs-5 text-muted"></i>
                            <div><div class="fw-bold small">Heading</div></div>
                        </div>
                         <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="TextBlock">
                            <i class="bi bi-fonts fs-5 text-muted"></i>
                            <div><div class="fw-bold small">Text Block</div></div>
                        </div>
                         <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="Image">
                            <i class="bi bi-card-image fs-5 text-muted"></i>
                            <div><div class="fw-bold small">Image</div></div>
                        </div>
                        <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="Button">
                            <i class="bi bi-hand-index-thumb fs-5 text-muted"></i>
                            <div><div class="fw-bold small">Button</div></div>
                        </div>

                        <!-- 3. Forms -->
                        <div class="panel-section-header bg-transparent border-0 pt-2 pb-1">Forms</div>
                         <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="Input">
                            <i class="bi bi-input-cursor-text fs-5 text-muted"></i>
                            <div><div class="fw-bold small">Input</div></div>
                        </div>
                         <div class="pro-card d-flex align-items-center gap-2 mb-2" draggable="true" data-comp-type="Checkbox">
                            <i class="bi bi-ui-checks fs-5 text-muted"></i>
                            <div><div class="fw-bold small">Checkbox</div></div>
                        </div>
                    </div>
                }
                 @if (activeToolboxTab == "migration")
                {
                     <div class="p-3">
                        <h6 class="text-muted small fw-bold mb-3">CONTENT SYNC</h6>
                        <button class="action-btn w-100 mb-2 justify-content-center bg-white border" @onclick="() => showUrlImportModal = true">
                            <i class="bi bi-cloud-download"></i> Import from URL
                        </button>
                         <button class="action-btn w-100 justify-content-center bg-white border" @onclick="ExportSite">
                            <i class="bi bi-archive"></i> Export Site
                        </button>
                    </div>
                }

                @if (activeToolboxTab == "help")
                {
                    <div class="p-3 help-guide" style="overflow-y: auto; height: calc(100vh - 120px);">
                         <h6 class="text-primary small fw-bold mb-3" style="letter-spacing: 0.1rem; text-transform: uppercase;">Features Deep-Dive</h6>
                         
                         <div class="help-section mb-4">
                            <div class="fw-bold mb-1 small"><i class="bi bi-display me-2 text-primary"></i>Visual Canvas</div>
                            <p style="font-size: 0.75rem" class="text-muted">The central iframe is an isolated rendering engine. Toggle viewports (Desktop, Tablet, Mobile) in the top bar to preview responsiveness.</p>
                         </div>

                         <div class="help-section mb-4">
                            <div class="fw-bold mb-1 small"><i class="bi bi-plus-square me-2 text-primary"></i>Drag & Drop</div>
                            <p style="font-size: 0.75rem" class="text-muted">Open the "Components" tab (3rd icon) and drag elements directly onto the canvas. Blue indicators show where the element will land.</p>
                         </div>

                         <div class="help-section mb-4">
                            <div class="fw-bold mb-1 small"><i class="bi bi-database me-2 text-primary"></i>CMS Data Binding</div>
                            <p style="font-size: 0.75rem" class="text-muted">Bind any component property (like Heading text or Image src) to a CMS field. Select a component, go to the "Data Binding" tab in the inspector, and select a source.</p>
                         </div>

                         <div class="help-section mb-4">
                            <div class="fw-bold mb-1 small"><i class="bi bi-lightning me-2 text-primary"></i>Anims & Interactions</div>
                            <p style="font-size: 0.75rem" class="text-muted">Use the "Animation" tab to set GSAP-powered entrance effects. Use "Interactions" to trigger actions like navigation or popup on click/hover.</p>
                         </div>

                         <div class="help-section mb-4">
                            <div class="fw-bold mb-1 small"><i class="bi bi-arrow-counterclockwise me-2 text-primary"></i>Undo/Redo History</div>
                            <p style="font-size: 0.75rem" class="text-muted">The top bar contains Undo (Ctrl+Z) and Redo (Ctrl+Y) buttons. We track up to 50 state changes locally.</p>
                         </div>

                         <h6 class="text-primary small fw-bold mb-3 mt-5" style="letter-spacing: 0.1rem; text-transform: uppercase;">Step-by-Step Workflow</h6>
                         <ol class="help-list text-muted ps-3" style="font-size: 0.75rem">
                            <li class="mb-2"><b>Initialize:</b> Select a page from the Explorer tab or import one via URL.</li>
                            <li class="mb-2"><b>Design:</b> Drag components from the panel. Use the Inspector (right) to refine Styles (Padding, Colors, Fonts).</li>
                            <li class="mb-2"><b>Connect:</b> Switch to "Data Binding" to pull real content from CMS collections.</li>
                            <li class="mb-2"><b>Animate:</b> Set a fade-in or slide effect in the Animation orchestrator.</li>
                            <li class="mb-2"><b>Preview:</b> Check your work in different screen sizes using the viewport toggles.</li>
                            <li class="mb-2"><b>Save/Publish:</b> Save a "Draft" to create a version snapshot. "Publish" to sync changes to the live /p/ route.</li>
                         </ol>
                    </div>
                }

                @if (activeToolboxTab == "engine")
                {
                    <div class="p-3">
                         <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted small fw-bold mb-0">RENDERING ENGINE</h6>
                            <div class="badge @(EngineService.IsRunning ? "bg-success-subtle text-success" : "bg-secondary-subtle text-secondary") border">
                                @(EngineService.IsRunning ? "Active" : "Stopped")
                            </div>
                         </div>

                         <div class="card bg-light border mb-3">
                             <div class="card-body p-3">
                                 <p class="x-small text-muted mb-3">The rendering engine (Next.js) powers the live-preview and final site export.</p>
                                 
                                 <div class="d-grid gap-2">
                                     @if (EngineService.IsRunning)
                                     {
                                         <button class="btn btn-sm btn-outline-danger" @onclick="() => EngineService.StopAsync()">
                                             <i class="bi bi-stop-circle me-2"></i> Stop Engine
                                         </button>
                                     }
                                     else
                                     {
                                         <button class="btn btn-sm btn-primary" @onclick="() => EngineService.StartAsync(currentProjectRoot)">
                                             <i class="bi bi-play-circle me-2"></i> Start Engine
                                         </button>
                                     }
                                 </div>
                             </div>
                         </div>

                         @if (EngineService.IsRunning || EngineService.Logs.Any())
                         {
                             <div class="mb-2 d-flex justify-content-between">
                                 <span class="x-small fw-bold">Live Logs</span>
                                 <button class="btn btn-xs p-0 text-muted" @onclick="() => EngineService.Logs.Clear()"><i class="bi bi-eraser"></i></button>
                             </div>
                             <div class="engine-log-console" id="engine-console">
                                 @foreach (var log in EngineService.Logs)
                                 {
                                     <div class="log-line">@log</div>
                                 }
                                 @if (!EngineService.Logs.Any())
                                 {
                                     <div class="text-muted opacity-50">Waiting for engine output...</div>
                                 }
                             </div>
                         }
                         
                         @if (!string.IsNullOrEmpty(EngineService.LastError))
                         {
                             <div class="alert alert-danger p-2 x-small mt-3">
                                 <i class="bi bi-exclamation-triangle me-1"></i> @EngineService.LastError
                             </div>
                         }
                    </div>
                }
                {
                    <div class="p-3">
                         <h6 class="text-muted small fw-bold mb-3">STUDIO PREFERENCES</h6>
                         
                         <div class="mb-4">
                             <label class="d-flex justify-content-between align-items-center mb-1">
                                 <span style="font-size: 0.8rem">Auto-Save Drafts</span>
                                 <div class="form-check form-switch m-0">
                                     <input class="form-check-input" type="checkbox" checked disabled>
                                 </div>
                             </label>
                             <small class="text-muted" style="font-size: 0.7rem">Saves your work locally every 30 seconds.</small>
                         </div>

                         <div class="mb-4 pt-3 border-top">
                             <div class="fw-bold small mb-2">History Management</div>
                             <button class="btn btn-sm btn-outline-danger w-100" @onclick="() => { undoStack.Clear(); redoStack.Clear(); StateHasChanged(); }" disabled="@(undoStack.Count == 0 && redoStack.Count == 0)">
                                 <i class="bi bi-trash me-2"></i> Clear Local History
                             </button>
                             <small class="text-muted d-block mt-1" style="font-size: 0.7rem">Current stack: @undoStack.Count items.</small>
                         </div>

                         <div class="mt-auto pt-5">
                             <div class="text-center">
                                 <div class="badge bg-light text-muted border">v2.1.0-beta</div>
                                 <div class="mt-2 text-muted" style="font-size: 0.65rem">GFC Studio Professional Edition</div>
                             </div>
                         </div>
                    </div>
                }
            </div>
        </div>

        <!-- C. CANVAS (Main Editor) -->
        <div class="canvas-area @($"viewport-{currentViewport}")">
            <div class="canvas-scroller">
                <div class="canvas-frame" @ondrop="HandleDropOnCanvas" @ondragover:preventDefault="true">
                    @if (sections == null || !sections.Any())
                    {
                        <div class="empty-canvas-placeholder" id="studio-canvas-dropzone">
                            <div class="empty-canvas-content">
                                <i class="bi bi-intersect fs-1 text-primary mb-3 d-block opacity-50"></i>
                                <h4 class="fw-bold text-dark">Blank Canvas</h4>
                                <p class="small mb-4">Start your design by dragging components from the library panel on the left.</p>
                                <button class="btn btn-primary btn-sm rounded-pill px-4" @onclick='() => SetSidebarTab("elements")'>
                                    Browse Components
                                </button>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(_previewUrl))
                    {
                        <div class="canvas-stage @currentViewport">
                            <iframe @ref="_previewIframe" 
                                    id="studio-preview-iframe" 
                                    src="@_previewUrl" 
                                    class="studio-preview-iframe" 
                                    style="width: 100%; height: 100%; border: none; background: white;"
                                    allow="clipboard-write">
                            </iframe>
                        </div>
                    }
                    else 
                    {
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <div class="spinner-border text-secondary mb-3" style="width: 1.5rem; height: 1.5rem;" role="status"></div>
                            <small>Initializing Engine...</small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- D. RIGHT INSPECTOR (Tabbed & Compact) -->
        <div class="inspector-panel @(isRightPanelCollapsed ? "collapsed" : "")">
            <!-- Inspector Tabs -->
            <div class="inspector-tabs">
                <button class="inspector-tab @(activeInspectorTab == "properties" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "properties"' 
                        title="Properties">
                    <i class="bi bi-sliders"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "style" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "style"' 
                        title="Styling">
                    <i class="bi bi-palette"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "animation" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "animation"' 
                        title="Animations">
                    <i class="bi bi-film"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "theme" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "theme"' 
                        title="Global Theme">
                    <i class="bi bi-droplet-fill"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "settings" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "settings"' 
                        title="Settings">
                    <i class="bi bi-gear"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "interactions" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "interactions"' 
                        title="Interactions">
                    <i class="bi bi-lightning-charge"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "binding" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "binding"' 
                        title="Data Binding">
                    <i class="bi bi-diagram-3"></i>
                </button>
            </div>

            <!-- Inspector Content Area -->
            <div class="inspector-body">
                @if (activeInspectorTab == "properties")
                {
                    <div class="panel-section-header">Content Properties</div>
                    <div class="property-grid">
                        <StudioWizard @ref="studioWizard" TargetSection="selectedSection" OnAssetChanged="HandleAssetChange" OnPropertyChanged="HandlePropertyChange" />
                        
                        <div class="p-3 border-top mt-3 bg-light">
                             <button class="btn btn-sm btn-outline-secondary w-100 mb-2" @onclick="() => OpenSaveAsTemplateModal(selectedSection)">
                                  <i class="bi bi-plus-circle me-2"></i> Save as Template
                             </button>
                             <button class="btn btn-sm btn-outline-danger w-100" @onclick="() => DeleteSection(selectedSection)">
                                  <i class="bi bi-trash me-2"></i> Delete Element
                             </button>
                        </div>
                    </div>
                }
                
                @if (activeInspectorTab == "style")
                {
                    <div class="panel-section-header">Visual Styling</div>
                    
                    <!-- 1. Layout -->
                    <details class="style-group" open>
                        <summary>Layout</summary>
                        <div class="group-content">
                            <div class="pro-label">Display</div>
                            <div class="pro-icon-group mb-2">
                                <button class="pro-icon-btn active" title="Block"><i class="bi bi-square"></i></button>
                                <button class="pro-icon-btn" title="Flex"><i class="bi bi-layout-three-columns"></i></button>
                                <button class="pro-icon-btn" title="Grid"><i class="bi bi-grid-3x3"></i></button>
                                <button class="pro-icon-btn" title="Inline"><i class="bi bi-type"></i></button>
                                <button class="pro-icon-btn" title="None"><i class="bi bi-eye-slash"></i></button>
                            </div>
                        </div>
                    </details>

                    <!-- 2. Spacing -->
                    <details class="style-group" open>
                        <summary>Spacing</summary>
                        <div class="group-content">
                            <!-- Helper graphic for Margin/Padding -->
                            <div class="p-4 bg-light text-center border rounded mb-2 text-muted" style="font-size: 10px;">
                                <div class="border border-dashed p-2 mb-1">MARGIN</div>
                                <div class="bg-white border p-2">PADDING</div>
                            </div>
                            <div class="pro-row two-col">
                                <div><span class="pro-label">Margin</span><input type="text" class="pro-input" placeholder="0px" value="@GetStyleValue("margin")" @onchange="@(e => HandleStyleChange("margin", e))" /></div>
                                <div><span class="pro-label">Padding</span><input type="text" class="pro-input" placeholder="0px" value="@GetStyleValue("padding")" @onchange="@(e => HandleStyleChange("padding", e))" /></div>
                            </div>
                        </div>
                    </details>

                     <!-- 3. Size -->
                    <details class="style-group">
                        <summary>Size</summary>
                        <div class="group-content">
                            <div class="pro-row two-col">
                                <div><span class="pro-label">Width</span><input type="text" class="pro-input" placeholder="auto" value="@GetStyleValue("width")" @onchange="@(e => HandleStyleChange("width", e))" /></div>
                                <div><span class="pro-label">Height</span><input type="text" class="pro-input" placeholder="auto" value="@GetStyleValue("height")" @onchange="@(e => HandleStyleChange("height", e))" /></div>
                            </div>
                             <div class="pro-row two-col">
                                <div><span class="pro-label">Min W</span><input type="text" class="pro-input" placeholder="0" value="@GetStyleValue("min-width")" @onchange="@(e => HandleStyleChange("min-width", e))" /></div>
                                <div><span class="pro-label">Max W</span><input type="text" class="pro-input" placeholder="none" value="@GetStyleValue("max-width")" @onchange="@(e => HandleStyleChange("max-width", e))" /></div>
                            </div>
                        </div>
                    </details>

                    <!-- 4. Typography -->
                    <details class="style-group">
                        <summary>Typography</summary>
                        <div class="group-content">
                             <div class="pro-row">
                                <span class="pro-label">Font</span>
                                <select class="pro-select" value="@GetStyleValue("font-family")" @onchange="@(e => HandleStyleChange("font-family", e))">
                                    <option value="">Default</option>
                                    <option value="Inter, sans-serif">Inter</option>
                                    <option value="Arial, sans-serif">Arial</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Times New Roman', serif">Serif</option>
                                    <option value="'Courier New', monospace">Mono</option>
                                </select>
                            </div>
                            <div class="pro-row two-col">
                                <div><span class="pro-label">Weight</span>
                                    <select class="pro-select" value="@GetStyleValue("font-weight", "400")" @onchange="@(e => HandleStyleChange("font-weight", e))">
                                        <option value="300">Light</option>
                                        <option value="400">Regular</option>
                                        <option value="600">SemiBold</option>
                                        <option value="700">Bold</option>
                                        <option value="900">Black</option>
                                    </select>
                                </div>
                                <div><span class="pro-label">Size</span><input type="text" class="pro-input" placeholder="16px" value="@GetStyleValue("font-size")" @onchange="@(e => HandleStyleChange("font-size", e))" /></div>
                            </div>
                            <div class="pro-row two-col">
                                <div><span class="pro-label">Color</span><input type="color" class="pro-input" style="height: 30px; padding: 2px;" value="@GetStyleValue("color", "#000000")" @onchange="@(e => HandleStyleChange("color", e))" /></div>
                                <div><span class="pro-label">Align</span>
                                    <div class="pro-icon-group">
                                         <button class="pro-icon-btn @(GetStyleValue("text-align") == "left" ? "active" : "")" @onclick="@(() => HandleStyleChange("text-align", new ChangeEventArgs { Value = "left" }))"><i class="bi bi-text-left"></i></button>
                                         <button class="pro-icon-btn @(GetStyleValue("text-align") == "center" ? "active" : "")" @onclick="@(() => HandleStyleChange("text-align", new ChangeEventArgs { Value = "center" }))"><i class="bi bi-text-center"></i></button>
                                         <button class="pro-icon-btn @(GetStyleValue("text-align") == "right" ? "active" : "")" @onclick="@(() => HandleStyleChange("text-align", new ChangeEventArgs { Value = "right" }))"><i class="bi bi-text-right"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 5. Backgrounds -->
                    <details class="style-group">
                        <summary>Backgrounds</summary>
                        <div class="group-content">
                             <div class="pro-row">
                                <span class="pro-label">Color</span>
                                <div class="d-flex align-items-center gap-2 w-100">
                                     <input type="color" class="pro-input" value="#ffffff" style="width: 30px; height: 30px; padding: 0;" />
                                     <input type="text" class="pro-input" value="#ffffff" />
                                </div>
                            </div>
                             <button class="btn btn-sm btn-outline-secondary w-100 mt-2" style="font-size: 11px;">+ Image / Gradient</button>
                        </div>
                    </details>
                    
                     <!-- 6. Borders -->
                    <details class="style-group">
                        <summary>Borders</summary>
                        <div class="group-content">
                             <div class="pro-row two-col">
                                <div><span class="pro-label">Radius</span><input type="text" class="pro-input" placeholder="0px" /></div>
                                <div><span class="pro-label">Width</span><input type="text" class="pro-input" placeholder="0px" /></div>
                            </div>
                        </div>
                    </details>
                }
                
                @if (activeInspectorTab == "theme")
                {
                    <div class="panel-section-header">Global Design System</div>
                    
                    <div class="p-3">
                        <div class="mb-3">
                            <label class="pro-label text-muted fw-bold mb-1">Brand Colors</label>
                            <div class="mb-2">
                                <small>Primary Color</small>
                                <div class="d-flex gap-2">
                                    <input type="color" class="pro-input p-0" style="width: 30px; height: 30px;" 
                                           value="@GetThemeValue("primary-color", "#3b82f6")" 
                                           @onchange="@(e => UpdateThemeValue("primary-color", e.Value?.ToString()))" />
                                    <input type="text" class="pro-input flex-grow-1" 
                                           value="@GetThemeValue("primary-color", "#3b82f6")" 
                                           @onchange="@(e => UpdateThemeValue("primary-color", e.Value?.ToString()))" />
                                </div>
                            </div>
                            <div class="mb-2">
                                <small>Secondary Color</small>
                                <div class="d-flex gap-2">
                                    <input type="color" class="pro-input p-0" style="width: 30px; height: 30px;" 
                                           value="@GetThemeValue("secondary-color", "#64748b")" 
                                           @onchange="@(e => UpdateThemeValue("secondary-color", e.Value?.ToString()))" />
                                    <input type="text" class="pro-input flex-grow-1" 
                                           value="@GetThemeValue("secondary-color", "#64748b")" 
                                           @onchange="@(e => UpdateThemeValue("secondary-color", e.Value?.ToString()))" />
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="pro-label text-muted fw-bold mb-1">Typography</label>
                            <div class="mb-2">
                                <small>Headings Font</small>
                                <select class="pro-select" value="@GetThemeValue("font-heading", "Inter")" @onchange="@(e => UpdateThemeValue("font-heading", e.Value?.ToString()))">
                                    <option value="Inter">Inter</option>
                                    <option value="Roboto">Roboto</option>
                                    <option value="Merriweather">Merriweather</option>
                                    <option value="Playfair Display">Playfair Display</option>
                                    <option value="Orbitron">Orbitron</option>
                                </select>
                            </div>
                             <div class="mb-2">
                                <small>Body Font</small>
                                <select class="pro-select" value="@GetThemeValue("font-body", "Inter")" @onchange="@(e => UpdateThemeValue("font-body", e.Value?.ToString()))">
                                    <option value="Inter">Inter</option>
                                    <option value="Open Sans">Open Sans</option>
                                    <option value="Lato">Lato</option>
                                </select>
                            </div>
                        </div>

                         <div class="mb-3">
                            <label class="pro-label text-muted fw-bold mb-1">Global Scale</label>
                             <div class="mb-2">
                                <small>Border Radius (Base)</small>
                                <div class="d-flex gap-2">
                                     <input type="text" class="pro-input" 
                                           value="@GetThemeValue("border-radius", "0.375rem")" 
                                           @onchange="@(e => UpdateThemeValue("border-radius", e.Value?.ToString()))" />
                                </div>
                            </div>
                         </div>

                        <button class="btn btn-primary btn-sm w-100" @onclick="ApplyGlobalTheme">
                            <i class="bi bi-check2-circle"></i> Save & Apply Theme
                        </button>
                    </div>
                }

                @if (activeInspectorTab == "animation")
                {
                    <div class="panel-section-header">Animation Timeline</div>
                    <div class="timeline-container">
                        <AnimationOrchestrator TargetSection="selectedSection" OnAnimationSettingsChanged="HandleAnimationSettingsChanged" />
                    </div>
                }

                @if (activeInspectorTab == "settings")
                {
                    <div class="panel-section-header">Page Settings</div>
                     <div class="p-3">
                         <div class="mb-3">
                             <label class="pro-label">Page Title</label>
                             <input type="text" class="pro-input" value="@allPages.FirstOrDefault(p => p.Id == PageId)?.Title" placeholder="Page Name" />
                         </div>
                         <div class="mb-3">
                             <label class="pro-label">URL Slug</label>
                             <input type="text" class="pro-input" value="@allPages.FirstOrDefault(p => p.Id == PageId)?.Slug" placeholder="/example" />
                         </div>
                    </div>
                    
                    <div class="panel-section-header">SEO & Meta</div>
                    <div class="p-3">
                         <div class="mb-3">
                             <label class="pro-label">Meta Title</label>
                             <input type="text" class="pro-input" placeholder="Search Engine Title" />
                         </div>
                          <div class="mb-3">
                             <label class="pro-label">Meta Description</label>
                             <textarea class="pro-input" rows="3" placeholder="Description for search results..."></textarea>
                         </div>
                         <div class="mb-3">
                             <label class="pro-label">Open Graph Image</label>
                             <div class="d-flex gap-1">
                                <input type="text" class="pro-input" placeholder="https://..." />
                                <button class="btn btn-sm btn-secondary"><i class="bi bi-upload"></i></button>
                             </div>
                         </div>
                    </div>

                     <div class="panel-section-header">Custom Code</div>
                    <div class="p-3">
                         <div class="mb-3">
                             <label class="pro-label">Inside &lt;head&gt; tag</label>
                             <textarea class="pro-input font-monospace" rows="3" placeholder="<script>..."></textarea>
                         </div>
                         <div class="mb-3">
                             <label class="pro-label">Before &lt;/body&gt; tag</label>
                             <textarea class="pro-input font-monospace" rows="3" placeholder="<script>..."></textarea>
                         </div>
                    </div>
                }
                
                @if (activeInspectorTab == "interactions")
                {
                    <div class="panel-section-header">Interactions <span class="badge bg-info text-dark ms-2">NEW</span></div>
                    
                    @if (selectedSection != null)
                    {
                        <div class="p-3">
                            <div class="mb-3">
                                <label class="pro-label text-muted fw-bold mb-2">Active Interactions</label>
                                @if (selectedSection.Interactions == null || !selectedSection.Interactions.Any())
                                {
                                    <div class="text-muted small fst-italic mb-3">No interactions defined.</div>
                                }
                                else
                                {
                                    @foreach (var interaction in selectedSection.Interactions)
                                    {
                                        <div class="card mb-2 border-0 bg-light">
                                            <div class="card-body p-2 d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="fw-bold small">@interaction.Trigger</div>
                                                    <div class="text-muted x-small">@interaction.Action</div>
                                                </div>
                                                <button class="btn btn-sm text-danger" @onclick="() => RemoveInteraction(interaction)"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>

                            <button class="btn btn-outline-secondary btn-sm w-100 mb-3" @onclick="() => showAddInteractionForm = !showAddInteractionForm">
                                <i class="bi bi-plus-lg"></i> Add Interaction
                            </button>

                            @if (showAddInteractionForm)
                            {
                                <div class="card bg-white border p-3 mb-3">
                                    <h6 class="card-title small fw-bold">New Interaction</h6>
                                    
                                    <div class="mb-2">
                                        <label class="pro-label">Trigger</label>
                                        <select class="pro-select" @bind="newInteractionTrigger">
                                            <option value="click">Mouse Click</option>
                                            <option value="hover">Mouse Hover</option>
                                            <option value="scrollIntoView">Scroll Into View</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="pro-label">Action</label>
                                        <select class="pro-select" @bind="newInteractionAction">
                                            <option value="navigate">Navigate to URL</option>
                                            <option value="scrollTo">Scroll to Section</option>
                                            <option value="toggleVisibility">Toggle Visibility</option>
                                            <option value="alert">Show Alert</option>
                                        </select>
                                    </div>

                                    @if (newInteractionAction == "navigate")
                                    {
                                        <div class="mb-2">
                                            <label class="pro-label">Target URL</label>
                                            <input type="text" class="pro-input" placeholder="/contact" @bind="newInteractionParam" />
                                        </div>
                                    }

                                    <div class="d-flex gap-2 mt-3">
                                        <button class="btn btn-secondary btn-sm flex-grow-1" @onclick="() => showAddInteractionForm = false">Cancel</button>
                                        <button class="btn btn-primary btn-sm flex-grow-1" @onclick="AddInteraction">Add</button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                         <div class="p-3 text-muted small text-center">
                             Select an element to add interactions.
                         </div>
                    }
                }

                @if (activeInspectorTab == "binding")
                {
                    <div class="panel-section-header">Data Bindings</div>
                    @if (selectedSection != null)
                    {
                        <div class="p-3">
                             <div class="alert alert-info py-2 small mb-3">
                                <i class="bi bi-info-circle me-1"></i> Connect this element to CMS content.
                            </div>

                            <!-- 1. Select Data Source (Context) -->
                            <div class="mb-3">
                                <label class="pro-label">Collection</label>
                                <select class="pro-select" @onchange="BindCollectionChange">
                                    <option value="">-- None --</option>
                                    @foreach(var col in cmsCollections)
                                    {
                                        <option value="@col.Id" selected="@(selectedSection.DataBindings.ContainsKey("CollectionId") && selectedSection.DataBindings["CollectionId"] == col.Id.ToString())">@col.Name</option>
                                    }
                                </select>
                            </div>

                            @if (selectedSection.DataBindings.ContainsKey("CollectionId") && int.TryParse(selectedSection.DataBindings["CollectionId"], out int colId))
                            {
                                var col = cmsCollections.FirstOrDefault(c => c.Id == colId);
                                if (col != null)
                                {
                                     <div class="mb-3">
                                        <label class="pro-label">Item</label>
                                        <select class="pro-select" @onchange="BindItemChange">
                                            <option value="">-- Select Item --</option>
                                            @foreach(var item in col.Items)
                                            {
                                                var name = GetItemDisplayName(item);
                                                <option value="@item.Id" selected="@(selectedSection.DataBindings.ContainsKey("ItemId") && selectedSection.DataBindings["ItemId"] == item.Id.ToString())">@name</option>
                                            }
                                        </select>
                                    </div>

                                    @if(selectedSection.DataBindings.ContainsKey("ItemId"))
                                    {
                                        <hr class="border-secondary opacity-25" />
                                        <div class="mb-2 fw-bold small">Map Fields</div>
                                        
                                        <!-- Dynamic Mappings based on Component Type -->
                                        @if (selectedSection.ComponentType == "TextBlock" || selectedSection.ComponentType == "Heading")
                                        {
                                             <div class="mb-2">
                                                <label class="pro-label">Text Content</label>
                                                <select class="pro-select" @onchange="@(e => UpdateBinding("content", e.Value?.ToString()))">
                                                    <option value="">-- Static --</option>
                                                    @foreach(var field in col.Fields)
                                                    {
                                                        <option value="@field.Key" selected="@(selectedSection.DataBindings.ContainsKey("content") && selectedSection.DataBindings["content"] == field.Key)">@field.Name</option>
                                                    }
                                                </select>
                                            </div>
                                        }
                                        else if (selectedSection.ComponentType == "Image")
                                        {
                                             <div class="mb-2">
                                                <label class="pro-label">Image Source</label>
                                                <select class="pro-select" @onchange="@(e => UpdateBinding("src", e.Value?.ToString()))">
                                                    <option value="">-- Static --</option>
                                                    @foreach(var field in col.Fields)
                                                    {
                                                        <option value="@field.Key" selected="@(selectedSection.DataBindings.ContainsKey("src") && selectedSection.DataBindings["src"] == field.Key)">@field.Name</option>
                                                    }
                                                </select>
                                            </div>
                                        }
                                    }
                                }
                            }
                        </div>
                    }
                    else
                    {
                         <div class="p-3 text-muted small text-center">
                             Select an element to configure data binding.
                         </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private DotNetObjectReference<Studio>? dotNetHelper;
    private List<(string Message, bool IsError, DateTime Time)> activityLog = new();

    private void AddLog(string message, bool isError = false)
    {
        // Simple console-like logging
        activityLog.Add((message, isError, DateTime.Now));
        if (activityLog.Count > 50) activityLog.RemoveAt(0);
        StateHasChanged();
    }

    // --- STYLE HANDLING ---
    private string GetStyleValue(string property, string defaultValue = "")
    {
        if (selectedSection != null && selectedSection.Styles.ContainsKey(property))
        {
            return selectedSection.Styles[property];
        }
        return defaultValue;
    }

    private async Task HandleStyleChange(string property, ChangeEventArgs e)
    {
        if (selectedSection == null) return;
        
        string value = e.Value?.ToString() ?? "";
        
        // Update local model
        if (selectedSection.Styles.ContainsKey(property))
        {
            selectedSection.Styles[property] = value;
        }
        else
        {
            selectedSection.Styles.Add(property, value);
        }
        
        // Sync to JSON for persistance
        selectedSection.SyncPropertiesToData();
        
        // Notify Preview (Live Update)
        await UpdatePreviewStyle(selectedSection.Id, property, value);
        
        // Trigger Auto-Save (debounced)
        if (selectedSection.StudioPageId > 0) 
            AutoSaveService.MarkAsDirty(selectedSection.StudioPageId, sections, currentUserName);
    }

    private async Task UpdatePreviewStyle(int sectionId, string property, string value)
    {
        try {
            // Send direct DOM update to iframe via JS Interop
            await JSRuntime.InvokeVoidAsync("studioPreview.updateElementStyle", sectionId, property, value);
        } catch { /* ignore if preview not ready */ }
    }

    // ... Existing Code
    private string activeInspectorTab = "properties"; // Default tab
    // ...
}
@if (showSaveAsTemplateModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Section as Template</h5>
                    <button type="button" class="close" @onclick="CloseSaveAsTemplateModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="templateName">Template Name</label>
                        <input type="text" class="form-control" id="templateName" @bind="newTemplateName" />
                    </div>
                    <div class="form-group">
                        <label for="templateCategory">Category</label>
                        <input type="text" class="form-control" id="templateCategory" @bind="newTemplateCategory" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSaveAsTemplateModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveTemplate">Save Template</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}


@if (showNewPageModal)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-plus me-2"></i>Create New Page</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showNewPageModal = false"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold small">Page Title</label>
                        <input type="text" class="form-control pro-input" @bind="newPageTitle" placeholder="e.g. About Us" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small">Folder Path</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="bi bi-folder"></i></span>
                            <input type="text" class="form-control pro-input" @bind="newPageFolder" list="folderEntries" placeholder="/ (Root)" />
                            <datalist id="folderEntries">
                                @foreach (var f in ExistingFolders)
                                {
                                    <option value="@f">@f</option>
                                }
                            </datalist>
                        </div>
                        <div class="form-text x-small">Select an existing folder or type a new one (e.g., /news)</div>
                    </div>
                    @if (!string.IsNullOrEmpty(_newPageErrorMessage))
                    {
                        <div class="alert alert-danger py-2">
                             <i class="bi bi-exclamation-circle me-2"></i> @_newPageErrorMessage
                        </div>
                    }
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-link text-muted text-decoration-none" @onclick="() => showNewPageModal = false">Cancel</button>
                    <button type="button" class="btn btn-primary px-4" @onclick="HandleCreatePage">
                        Create Page <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showSaveVersionModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Named Version</h5>
                    <button type="button" class="close" @onclick="() => showSaveVersionModal = false">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="versionDescription">Description (optional)</label>
                        <input type="text" class="form-control" id="versionDescription" @bind="versionDescription" placeholder="e.g., Before Christmas Redesign" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showSaveVersionModal = false">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="() => SaveDraft(true)">Save Version</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showUrlImportModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import from URL</h5>
                    <button type="button" class="close" @onclick="CloseImportModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    @if (isImporting)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p>Scraping content, please wait...</p>
                        </div>
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(importErrorMessage))
                        {
                            <div class="alert alert-danger">@importErrorMessage</div>
                        }
                        <div class="form-group">
                            <label for="urlInput">URL to Scrape</label>
                            <input type="text" class="form-control" id="urlInput" @bind="urlToImport" />
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseImportModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ImportFromUrl">Import</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showProjectPicker)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5); z-index: 1060;" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-folder2-open me-2"></i>Select Project Workspace</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showProjectPicker = false"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="form-label fw-bold small text-muted text-uppercase tracking-wider">Current Location</label>
                        <div class="d-flex align-items-center gap-2 mb-2 p-2 bg-white border rounded shadow-sm">
                            <i class="bi bi-folder-symlink-fill text-warning fs-5"></i>
                            <span class="font-monospace small flex-grow-1 text-truncate">@currentProjectRoot</span>
                            <button class="btn btn-xs btn-outline-secondary" @onclick="GoUpOneLevel" title="Go up one level">
                                <i class="bi bi-arrow-90deg-up"></i>
                            </button>
                        </div>
                        
                        <div class="directory-browser border rounded bg-white" style="height: 300px; overflow-y: auto;">
                            <div class="list-group list-group-flush">
                                @if (subDirectories == null || !subDirectories.Any())
                                {
                                    <div class="p-4 text-center text-muted">
                                        <i class="bi bi-folder-x fs-1 opacity-25 d-block mb-2"></i>
                                        <small>No subfolders found or access denied.</small>
                                    </div>
                                }
                                else
                                {
                                    @foreach (var dir in subDirectories)
                                    {
                                        <button class="list-group-item list-group-item-action d-flex align-items-center gap-2 py-2 px-3 border-0" 
                                                @onclick='() => NavigateToFolder(dir)'>
                                            <i class="bi bi-folder-fill text-warning"></i>
                                            <span class="small text-truncate">@System.IO.Path.GetFileName(dir)</span>
                                            <i class="bi bi-chevron-right ms-auto text-muted" style="font-size: 0.7rem;"></i>
                                        </button>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="project-info bg-light p-3 rounded border border-dashed text-center">
                        <div class="fw-bold text-primary mb-1">
                            <i class="bi bi-check-circle-fill me-1"></i> Ready to Initialize
                        </div>
                        <div class="x-small text-muted">Pages and assets will be managed relative to this root.</div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-link text-muted text-decoration-none" @onclick="() => showProjectPicker = false">Cancel</button>
                    <button type="button" class="btn btn-primary px-4" @onclick="ConfirmProjectSelection">
                        Switch Project <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showPublishWizard)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Publish to Live</h5>
                    <button type="button" class="close btn-close" @onclick="() => showPublishWizard = false" disabled="@isPublishing"></button>
                </div>
                <div class="modal-body">
                    @if (isPublishing)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h6 class="fw-bold">@publishMessage</h6>
                            <p class="text-muted small">This may take a few moments...</p>
                        </div>
                    }
                    else if (saveStatusText == "Published Live")
                    {
                         <div class="text-center py-4">
                            <div class="mb-3 text-success display-1">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <h4 class="fw-bold text-success mb-2">Published Successfully!</h4>
                            <p class="text-muted mb-4">Your changes are now live.</p>

                            <a href="/p/@_pageSlug" target="_blank" class="btn btn-success btn-lg px-4">
                                <i class="bi bi-box-arrow-up-right me-2"></i> View Live Site
                            </a>
                        </div>
                    }
                    else
                    {
                        <p>Are you sure you want to publish your changes? This will:</p>
                        <ul class="mys-3">
                            <li>Create a new version snapshot</li>
                            <li>Generate the static site assets</li>
                            <li>Update the live website content</li>
                        </ul>
                        <div class="alert alert-warning small">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> This action cannot be undone immediately.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showPublishWizard = false" disabled="@isPublishing">@(saveStatusText == "Published Live" ? "Close" : "Cancel")</button>
                    @if (!isPublishing && saveStatusText != "Published Live")
                    {
                        <button type="button" class="btn btn-primary" @onclick="ConfirmPublish"><i class="bi bi-rocket-takeoff me-2"></i> Publish Now</button>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showPageBrowser)
{
    <div class="modal d-block" style="background: rgba(0,0,0,0.5); z-index: 1060;">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white py-3">
                    <div>
                        <h6 class="modal-title fw-bold"><i class="bi bi-search me-2"></i> Open Existing Page</h6>
                        <div class="small opacity-75 font-monospace mt-1"><i class="bi bi-folder2-open me-1"></i> @currentProjectRoot</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showPageBrowser = false"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="p-3 bg-light border-bottom d-flex gap-2">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" placeholder="Search pages..." @bind="pageSearchTerm" @bind:event="oninput" autofocus />
                        </div>
                        <button class="btn btn-outline-secondary" @onclick="RefreshPages" title="Refresh List">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    
                    <div class="list-group list-group-flush" style="min-height: 200px;">
                        @if (allPages == null || !allPages.Any())
                        {
                            <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
                                <i class="bi bi-folder-x display-4 opacity-25 mb-3"></i>
                                <h6>No pages found in this project.</h6>
                                <p class="small">Try creating a new page or checking the project folder.</p>
                                <button class="btn btn-sm btn-outline-primary mt-2" @onclick="RefreshPages">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Scan Project Folder
                                </button>
                            </div>
                        }
                        else
                        {
                            var filteredPages = allPages.Where(x => string.IsNullOrEmpty(pageSearchTerm) || x.Title.Contains(pageSearchTerm, StringComparison.OrdinalIgnoreCase)).OrderBy(x => x.Title).ToList();
                            
                            if (!filteredPages.Any())
                            {
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-search display-6 opacity-25 mb-2"></i>
                                    <p>No pages match "@pageSearchTerm"</p>
                                </div>
                            }

                            @foreach (var p in filteredPages)
                            {
                                <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 @(p.Id == PageId ? "bg-light fw-bold" : "text-dark")" 
                                        @onclick="() => { HandlePageSelected(p); showPageBrowser = false; }">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="rounded-circle bg-light p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="bi @(p.IsPublished ? "bi-check-circle-fill text-success" : "bi-file-earmark text-primary") fs-5"></i>
                                        </div>
                                        <div class="text-start">
                                            <div class="mb-0 fw-bold text-dark">@p.Title</div>
                                            <div class="small text-muted font-monospace">
                                                <i class="bi bi-link-45deg me-1"></i>/@p.Slug
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge @(p.Status == "Published" ? "bg-success" : "bg-warning text-dark") rounded-pill">
                                            @(p.Status ?? "Draft")
                                        </span>
                                        <div class="x-small text-muted mt-1">ID: @p.Id</div>
                                    </div>
                                </button>
                            }
                        }
                    </div>
                </div>
                <div class="modal-footer bg-light p-2 justify-content-between">
                    <button class="btn btn-sm btn-link text-decoration-none" @onclick='() => { showPageBrowser = false; showNewPageModal = true; }'>
                        <i class="bi bi-plus-circle me-1"></i> Create New Page
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" @onclick="() => showPageBrowser = false">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    public class StudioComponentDefinition
    {
        public string Name { get; set; }
        public string Description { get; set; }
        public string Icon { get; set; }
        public string ComponentType { get; set; }
        public string DefaultProperties { get; set; }
    }

    private List<StudioComponentDefinition> availableComponents = new List<StudioComponentDefinition>
    {
        new StudioComponentDefinition { Name = "Hero Section", Description = "Large banner with title and image", Icon = "", ComponentType = "HeroSection", DefaultProperties = "{ \"headline\": \"Welcome\", \"backgroundImage\": \"\" }" },
        new StudioComponentDefinition { Name = "Text Block", Description = "Rich text content", Icon = "", ComponentType = "RichTextBlock", DefaultProperties = "{ \"content\": \"<p>Enter text...</p>\" }" },
        new StudioComponentDefinition { Name = "Button CTA", Description = "Call to action button", Icon = "", ComponentType = "ButtonCTA", DefaultProperties = "{ \"text\": \"Click Me\", \"link\": \"#\" }" }
    };

    private StudioComponentDefinition draggedComponent;
    public enum SaveStatus
    {
        Saved,
        Saving,
        Error
    }

    [Parameter]
    public int PageId { get; set; }

    private bool showUrlImportModal = false;
    private string urlToImport = "";
    private bool isImporting = false;
    private string importErrorMessage = "";

    private bool isExporting = false;
    private string exportErrorMessage = "";

    private bool isLeftPanelCollapsed = false;
    private bool isRightPanelCollapsed = false;

    // Feature 2: Global Theme State
    private Dictionary<string, string> globalThemeSettings = new Dictionary<string, string>();

    private string GetThemeValue(string key, string defaultValue)
    {
        return globalThemeSettings.ContainsKey(key) ? globalThemeSettings[key] : defaultValue;
    }

    private void UpdateThemeValue(string key, string value)
    {
        if (globalThemeSettings.ContainsKey(key))
            globalThemeSettings[key] = value;
        else
            globalThemeSettings.Add(key, value);
        
    }

    private async Task ApplyGlobalTheme()
    {
        // 1. Send to Preview
        if (_previewIframe.Id != null)
        {
            await JSRuntime.InvokeVoidAsync("studioInterop.updateGlobalTheme", _previewIframe, globalThemeSettings);
        }

        // 2. Persist to Database (StudioSettings)
        await SaveGlobalTheme();
    }

    private async Task SaveStudioSetting(string key, string value, string type = "General")
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var setting = await context.StudioSettings.FirstOrDefaultAsync(s => s.SettingKey == key);
            
            if (setting == null)
            {
                setting = new StudioSetting 
                { 
                    SettingKey = key, 
                    SettingValue = value, 
                    SettingType = type,
                    UpdatedBy = currentUserName ?? "System",
                    UpdatedAt = DateTime.UtcNow
                };
                context.StudioSettings.Add(setting);
            }
            else
            {
                setting.SettingValue = value;
                setting.UpdatedBy = currentUserName ?? "System";
                setting.UpdatedAt = DateTime.UtcNow;
            }
            
            await context.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save studio setting {Key}", key);
        }
    }

    private async Task SaveGlobalTheme()
    {
        var themeJson = JsonSerializer.Serialize(globalThemeSettings);
        await SaveStudioSetting("GlobalTheme", themeJson, "Theme");
    }

    private async Task LoadGlobalTheme()
    {
        try
        {
             using var context = await DbContextFactory.CreateDbContextAsync();
             var setting = await context.StudioSettings.FirstOrDefaultAsync(s => s.SettingKey == "GlobalTheme");
             if (setting != null && !string.IsNullOrEmpty(setting.SettingValue))
             {
                 globalThemeSettings = JsonSerializer.Deserialize<Dictionary<string, string>>(setting.SettingValue) ?? new Dictionary<string, string>();
             }
        }
        catch (Exception ex)
        {
             Logger.LogWarning("Could not load global theme: " + ex.Message);
        }
    }


    private bool showNewPageModal = false;
    private bool showPageBrowser = false;
    private bool showProjectPicker = false;
    private string newPageTitle = "";
    private string newPageFolder = "/";
    private string currentProjectRoot = @"c:\Users\hnsil\Documents\GFC\cursor files\GFC-System\GFC-Studio V2";

    private string pageSearchTerm = "";
    private List<StudioPage> allPages = new();
    
    private IEnumerable<IGrouping<string, StudioPage>> PageGroups => 
        allPages.Where(x => string.IsNullOrEmpty(pageSearchTerm) || x.Title.Contains(pageSearchTerm, StringComparison.OrdinalIgnoreCase))
                .GroupBy(x => x.Folder ?? "/");

    private IEnumerable<string> ExistingFolders => 
        allPages.Select(p => p.Folder ?? "/").Distinct().OrderBy(f => f);

    private StudioPage currentPage;
    private StudioDraft draft;
    private List<StudioSection> sections = new();
    private List<MediaAsset> mediaAssets = new();

    private async Task LoadAssets()
    {
        try {
            mediaAssets = (await AssetService.GetAllAssetsAsync()).ToList();
        } catch {}
    }

    private void HandleAssetDragStart(MediaAsset asset)
    {
         // Logic for dragging image into canvas
    }

    private async Task DeleteSection(StudioSection section)
    {
        if (section != null)
        {
            RecordState();
            sections.Remove(section);
            selectedSection = null;
            MarkAsDirty();
            StateHasChanged();
            await SendSectionsToPreview();
        }
    }

    private bool _isCreatingPage = false;
    private async Task HandleCreatePage()
    {
        if (_isCreatingPage) return;

        if (string.IsNullOrWhiteSpace(newPageTitle))
        {
            _newPageErrorMessage = "Page title is required.";
            return;
        }

        try 
        {
            _isCreatingPage = true;
            _newPageErrorMessage = null;
            // First Page Logic: Initialize folders if this is a new project or first page
            saveStatusText = "Checking Workspace Structure...";
            StateHasChanged();
            
            await ProjectFileService.InitializeProjectStructureAsync(currentProjectRoot);
            
            saveStatusText = "Creating Page Files...";
            StateHasChanged();

            var stub = new StudioPage { Title = newPageTitle };
            await CreateNewPage(stub);
            
            if (string.IsNullOrEmpty(_newPageErrorMessage))
            {
                saveStatusText = "Ready";
                newPageTitle = "";
                showNewPageModal = false;
            }
        }
        catch (Exception ex)
        {
            _newPageErrorMessage = "Workspace Error: " + ex.Message;
            saveStatusText = "Error! Check Modal.";
        }
        finally
        {
            _isCreatingPage = false;
        }
    }

    
    // Undo/Redo History Stacks
    private Stack<string> undoStack = new Stack<string>();
    private Stack<string> redoStack = new Stack<string>();

    private void RecordState()
    {
        // Snapshot current sections to JSON
        var snapshot = JsonSerializer.Serialize(sections);
        undoStack.Push(snapshot);
        redoStack.Clear(); // Clear redo stack on new action
        
        // Limit stack size to prevent memory issues
        if (undoStack.Count > 50)
        {
            var list = undoStack.ToList();
            list.RemoveAt(list.Count - 1); // Remove oldest
            list.Reverse();
            undoStack = new Stack<string>(list);
        }
    }

    private async Task Undo()
    {
        if (undoStack.Count > 0)
        {
            // Save current state to Redo before changing
            redoStack.Push(JsonSerializer.Serialize(sections));

            var previousState = undoStack.Pop();
            sections = JsonSerializer.Deserialize<List<StudioSection>>(previousState) ?? new List<StudioSection>();
            selectedSection = null; // Clear selection to avoid stale references
            
            MarkAsDirty();
            StateHasChanged();
            await SendSectionsToPreview();
        }
    }

    private async Task Redo()
    {
        if (redoStack.Count > 0)
        {
            // Save current state to Undo before changing
            undoStack.Push(JsonSerializer.Serialize(sections));

            var nextState = redoStack.Pop();
            sections = JsonSerializer.Deserialize<List<StudioSection>>(nextState) ?? new List<StudioSection>();
            selectedSection = null;

            MarkAsDirty();
            StateHasChanged();
            await SendSectionsToPreview();
        }
    }

    private StudioSection selectedSection;
    private List<StudioTemplate> templates = new();
    private List<StudioTemplate> filteredTemplates = new();
    private List<string> templateCategories = new();
    private string selectedTemplateCategory = "";
    private string activeToolboxTab = "pages"; // Default to Pages tab
    private StudioSection sectionToSave;
    private bool showSaveAsTemplateModal = false;
    private string newTemplateName = "";
    private string newTemplateCategory = "";
    private string lastWizardAction = "";
    private bool showHistory = false;
    private Dictionary<string, string> heroSectionProperties = new();
    private List<StudioDraft> draftHistory = new();
    private StudioSection lastUndoState;
    private StudioTemplate draggedTemplate;
    private void HandleAnimationSettingsChanged(string newSettings)
    {
        if (selectedSection != null)
        {
            selectedSection.AnimationSettings = newSettings;
            StateHasChanged();
        }
    }

    private AnimationSettings currentAnimationSettings = new();
    private StudioWizard studioWizard;
    private List<StudioWizard.WizardWarning> wizardWarnings = new();
    private ElementReference _previewIframe;
    private string _previewUrl;
    private string _pageSlug;
    private string currentUserName;
    private string saveStatusText = "All changes saved.";
    private int latestVersion = 0;
    private bool showSaveVersionModal = false;
    private string versionDescription = string.Empty;
    private SaveStatus saveStatus = SaveStatus.Saved;
    private bool isLocked = false;
    private string lockedBy = "";
    private bool canForceUnlock = false;

    // Feature: Helper Mode
    private bool isHelperModeEnabled = false;
    private int currentHelperStep = 1;

    private void AdvanceHelperStep(int completedStep)
    {
        if (isHelperModeEnabled && currentHelperStep == completedStep)
        {
            currentHelperStep++;
            StateHasChanged();
        }
    }

    // OnParametersSetAsync handles navigation and loading

    // MarkAsDirty removed (duplicate)

    private void HandleContentFixed(string newContent, string fixName)
    {
        if (selectedSection != null)
        {
            lastUndoState = new StudioSection { PropertiesJson = selectedSection.PropertiesJson };
            // This needs to be updated to modify the JSON properties, not a simple string.
            // selectedSection.PropertiesJson = newContent;
            lastWizardAction = $"Auto-Fix: {fixName}";
            MarkAsDirty();
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void SetSelectedSection(StudioSection section)
    {
        selectedSection = section;
        StateHasChanged();
    }

    private async Task HandlePropertyChange((string sectionId, string propertyName, object propertyValue) args)
    {
        RecordState();
        var styleUpdate = new Dictionary<string, object>
        {
            { args.propertyName, args.propertyValue }
        };

        if (_previewIframe.Context != null)
        {
            await JSRuntime.InvokeVoidAsync("studioInterop.updateStyleInPreview", _previewIframe, args.sectionId, styleUpdate);
        }
    }

    private async Task HandleAssetChange(MediaAsset asset)
    {
        if (selectedSection != null)
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var existingLinks = context.StudioSectionAssets.Where(ssa => ssa.StudioSectionId == selectedSection.Id);
            context.StudioSectionAssets.RemoveRange(existingLinks);

            var newLink = new StudioSectionAsset
            {
                StudioSectionId = selectedSection.Id,
                MediaAssetId = asset.Id
            };
            context.StudioSectionAssets.Add(newLink);

            await context.SaveChangesAsync();
            MarkAsDirty();
        }
    }

    private void UndoLastAction()
    {
        if (selectedSection != null && lastUndoState != null)
        {
            selectedSection.Content = lastUndoState.Content;
            selectedSection.AnimationSettingsJson = lastUndoState.AnimationSettingsJson;
            lastWizardAction = "";
            lastUndoState = null;
            MarkAsDirty();
            StateHasChanged();
        }
    }

    private void ToggleHistory() => showHistory = !showHistory;

    private async Task SelectSection(StudioSection section)
    {
        selectedSection = section;

      if (!string.IsNullOrEmpty(selectedSection.AnimationSettingsJson))
        {
            try
            {
                currentAnimationSettings = JsonSerializer.Deserialize<AnimationSettings>(selectedSection.AnimationSettingsJson) ?? new AnimationSettings();
            }
            catch(Exception ex)
            {
                currentAnimationSettings = new AnimationSettings();
            }
        }
        else
        {
            currentAnimationSettings = new AnimationSettings();
        }

        // Re-initialize JS interop for the timeline
        await JSRuntime.InvokeVoidAsync("animationInterop.initializeTimeline", DotNetObjectReference.Create(this));
        await JSRuntime.InvokeVoidAsync("animationScrubbing.initializeScrubbing", _previewIframe);
    }

    private async Task UpdateAnimationSettings()
    {
        if (selectedSection != null)
        {
            selectedSection.AnimationSettingsJson = JsonSerializer.Serialize(currentAnimationSettings);
            await JSRuntime.InvokeVoidAsync("studioInterop.updateAnimation", _previewIframe, selectedSection);
        }
        showHistory = false;
        MarkAsDirty(); // When a user rolls back, it should be saved as a new draft
        StateHasChanged();
    }

    // Updated Sidebar Controller

    private string GetSidebarTitle()
    {
        return activeToolboxTab switch
        {
            "pages" => "Explorer",
            "outline" => "Structure",
            "elements" => "Components",
            "cms" => "Data Collections",
            "assets" => "Media Assets",
            "templates" => "Templates",
            "migration" => "Sync & Migration",
            "engine" => "Rendering Engine",
            "help" => "How-To Guide",
            _ => activeToolboxTab.ToUpper()
        };
    }

    private async Task HandlePageSelected(StudioPage page)
    {
        if (page != null && page.Id != PageId)
        {
            // Update the URL in the browser's address bar without forcing a reload
            NavigationManager.NavigateTo($"/studio/{page.Id}");

            // Now, reload the component's state with the new page's data
            await LoadPageAsync(page.Id);
        }
    }

    private void MarkAsDirty()
    {
        saveStatus = SaveStatus.Saving;
        saveStatusText = "Saving...";
        AddLog("Saving changes..."); 
        if (currentUserName != null)
        {
            AutoSaveService.MarkAsDirty(PageId, sections, currentUserName);
        }
    }

    private void AddKeyframe()
    {
        // currentAnimationKeyframes.Add(new AnimationKeyframe { Delay = currentAnimationKeyframes.LastOrDefault()?.Delay + currentAnimationKeyframes.LastOrDefault()?.Duration ?? 0 });
        MarkAsDirty();
    }

    private string _newPageErrorMessage = null;

    private async Task CreateNewPage(StudioPage pageStub)
    {
        _newPageErrorMessage = null;
        try
        {
            if (string.IsNullOrEmpty(currentProjectRoot))
            {
                AddLog("CRITICAL ERROR: No Project Folder selected. Please select a project folder (Top Left Button) before creating pages.", true);
                _newPageErrorMessage = "Please select a Project Folder first.";
                return;
            }

            AddLog($"Creating new page '{pageStub.Title}' in '{newPageFolder}'...");
            var created = await PageService.CreatePageAsync(pageStub.Title, newPageFolder);
            AddLog($"Page record created (ID: {created.Id}). Saving files to {currentProjectRoot}...");
            
            // Physical File Save
            await ProjectFileService.SavePageDataAsync(currentProjectRoot, created, new List<StudioSection>());
            await ProjectFileService.GeneratePageFileAsync(currentProjectRoot, created, new List<StudioSection>());
            AddLog("Files saved successfully.");

            // Force full refresh to ensure ID and state are synced
            await RefreshPages();
            
            showNewPageModal = false;
            newPageTitle = "";
            newPageFolder = "/";

            // Re-find the created page from the refreshed list to ensure we have the full object
            var reloadedPage = allPages.FirstOrDefault(p => p.Id == created.Id) ?? created;
            await HandlePageSelected(reloadedPage);
            AdvanceHelperStep(1); // Helper Step 1 Complete: Page Created
            AddLog("New page loaded.");
        }
        catch (Exception ex)
        {
            _newPageErrorMessage = ex.Message;
            AddLog($"Error creating page: {ex.Message}", true);
            Logger.LogError(ex, "Failed to create page");
        }
    }

    private async Task LoadDraft(StudioDraft selectedDraft)
    {
        draft = selectedDraft;
        if (!string.IsNullOrEmpty(draft.ContentJson))
        {
            sections = JsonSerializer.Deserialize<List<StudioSection>>(draft.ContentJson);
            // Re-hydrate helpers
            foreach(var s in sections) s.SyncAll();
        }
        showHistory = false;
        StateHasChanged();
    }

    private List<string> subDirectories = new();

    private void NavigateToFolder(string path)
    {
        try 
        {
            if (System.IO.Directory.Exists(path))
            {
                currentProjectRoot = path;
                subDirectories = System.IO.Directory.GetDirectories(path).ToList();
            }
        }
        catch (Exception ex)
        {
            saveStatusText = "Access Error: " + ex.Message;
        }
    }

    private void GoUpOneLevel()
    {
        var parent = System.IO.Directory.GetParent(currentProjectRoot);
        if (parent != null)
        {
            NavigateToFolder(parent.FullName);
        }
    }

    private async Task BrowseProjectFolder()
    {
        // Now handles initial listing
        NavigateToFolder(currentProjectRoot);
    }

    private async Task ConfirmProjectSelection()
    {
        showProjectPicker = false;
        saveStatusText = "Project Root set to: " + currentProjectRoot;
        await SaveStudioSetting("LastProjectRoot", currentProjectRoot);
        // Refresh folders for the tree view
        await RefreshPages();
    }

    [JSInvokable]
    public void SetDraggedComponentType(string type)
    {
        // If it's a template, we let Blazor's @ondragstart handle the specific object state
        if (type == "Template") return;

        draggedComponent = new StudioComponentDefinition { ComponentType = type };
        draggedTemplate = null;
    }

    // Deprecated: Handled by JS
    private void HandleComponentDragStart(StudioComponentDefinition component)
    {
        // draggedComponent = component;
        // draggedTemplate = null;
    }

    private void HandleDragStart(StudioTemplate template)
    {
        draggedTemplate = template;
        draggedComponent = null;
    }

    // Deprecated: Handled by JS Interop
    private async Task HandleDropOnCanvas()
    {
        await Task.CompletedTask;
    }

    [JSInvokable]
    public async Task HandleComponentDrop(string componentType, string closestId, bool insertAfter)
    {
        try
        {
            StudioSection newSection = null;

            // 1. Determine if we are dropping a Template or a raw Component
            if (draggedTemplate != null)
            {
                try 
                {
                    newSection = JsonSerializer.Deserialize<StudioSection>(draggedTemplate.ContentJson) ?? new StudioSection();
                    newSection.Id = 0; // Ensure it's treated as new
                    newSection.ClientId = Guid.NewGuid();
                }
                catch (Exception ex)
                {
                    AddLog($"Error deserializing template: {ex.Message}", true);
                    return;
                }
                draggedTemplate = null; // Reset
            }
            else if (!string.IsNullOrEmpty(componentType))
            {
                // Find component in available components or create default
                var def = availableComponents.FirstOrDefault(c => c.ComponentType == componentType);
                
                newSection = new StudioSection
                {
                    Id = 0,
                    ClientId = Guid.NewGuid(),
                    ComponentType = componentType,
                    properties = new Dictionary<string, object>(),
                    Styles = new Dictionary<string, string>
                    {
                        { "padding", "20px" },
                        { "min-height", "50px" }
                    }
                };

                if (def != null && !string.IsNullOrEmpty(def.DefaultProperties))
                {
                    try 
                    {
                        newSection.properties = JsonSerializer.Deserialize<Dictionary<string, object>>(def.DefaultProperties) ?? new();
                    }
                    catch {}
                }
                
                // Add default content for Sidebar items
                if (componentType == "Heading" && !newSection.properties.ContainsKey("content")) 
                    newSection.properties["content"] = "New Heading";
                if (componentType == "TextBlock" && !newSection.properties.ContainsKey("content")) 
                    newSection.properties["content"] = "Add your text here...";
                if (componentType == "Button" && !newSection.properties.ContainsKey("text")) 
                    newSection.properties["text"] = "Click Me";
                if (componentType == "Section")
                {
                    newSection.Styles["background-color"] = "#f8fafc";
                    newSection.Styles["border"] = "1px dashed #cbd5e1";
                }
            }

            if (newSection == null) return;

            // Sync for DB/Preview
            newSection.SyncPropertiesToData();
            newSection.SyncAll();

            // 2. Insert into the list at the right spot
            RecordState(); // For Undo
            
            if (string.IsNullOrEmpty(closestId) || closestId == "null")
            {
                sections.Add(newSection);
            }
            else
            {
                // Find by ClientId because real Ids are 0 for new sections
                var idx = sections.FindIndex(s => s.ClientId.ToString() == closestId);
                if (idx != -1)
                {
                    if (insertAfter) sections.Insert(idx + 1, newSection);
                    else sections.Insert(idx, newSection);
                }
                else
                {
                    sections.Add(newSection);
                }
            }

            // Helper Mode Tracking
            AdvanceHelperStep(2); // Implicitly complete step 2 if they dragged something
            if (componentType == "HeroSection") AdvanceHelperStep(3);
            if (componentType == "TextBlock") AdvanceHelperStep(4);
            if (componentType == "Button") AdvanceHelperStep(5);

            AddLog($"Added component: {componentType}");
            MarkAsDirty();
            StateHasChanged();
            await SendSectionsToPreview();
        }
        catch (Exception ex)
        {
            AddLog($"Error adding component: {ex.Message}", true);
            Logger.LogError(ex, "Drop component failed");
        }
    }

    private async Task HandleDrop()
    {
        // This is now fully handled by JS interop (HandleComponentDrop)
        await Task.CompletedTask;
    }

    // Feature 4: Interaction Builder Logic
    private bool showAddInteractionForm = false;
    private string newInteractionTrigger = "click";
    private string newInteractionAction = "navigate";
    private string newInteractionParam = "";

    // Feature 5: CMS Integration
    private List<StudioCollection> cmsCollections = new();
    private StudioCollection? selectedCollection;
    private StudioCollectionItem? selectedCmsItem;
    private bool isEditingCmsItem = false;
    private bool showNewCollectionModal = false;
    private string newCollectionName = "";

    private async Task LoadCmsCollections()
    {
        try {
            cmsCollections = await CmsService.GetCollectionsAsync();
        } catch (Exception ex) {
            Logger.LogError(ex, "Failed to load CMS collections");
        }
    }

    private async Task CreateCollection()
    {
        if (string.IsNullOrWhiteSpace(newCollectionName)) return;
        
        var slug = newCollectionName.ToLower().Replace(" ", "-"); // simplified slugify
        var collection = new StudioCollection { Name = newCollectionName, Slug = slug };
        
        // Add default fields for demo
        collection.Fields.Add(new StudioCollectionField { Name = "Title", Key = "title", Type = "Text", IsRequired = true });
        collection.Fields.Add(new StudioCollectionField { Name = "Cover Image", Key = "cover", Type = "Image" });
        collection.Fields.Add(new StudioCollectionField { Name = "Content", Key = "content", Type = "RichText" });

        await CmsService.CreateCollectionAsync(collection);
        await LoadCmsCollections();
        showNewCollectionModal = false;
        newCollectionName = "";
    }

    private async Task SelectCollection(StudioCollection collection)
    {
        selectedCollection = await CmsService.GetCollectionWithFieldsAsync(collection.Id);
        selectedCmsItem = null;
        isEditingCmsItem = false;
    }

    private void AddNewCmsItem()
    {
        if (selectedCollection == null) return;
        selectedCmsItem = new StudioCollectionItem { CollectionId = selectedCollection.Id };
        // Pre-fill keys
        foreach(var field in selectedCollection.Fields)
        {
            selectedCmsItem.Data[field.Key] = "";
        }
        isEditingCmsItem = true;
    }

    private async Task SaveCmsItem()
    {
        if (selectedCmsItem == null) return;
        
        // Serialize dictionary back to JSON
        selectedCmsItem.DataJson = JsonSerializer.Serialize(selectedCmsItem.Data);
        
        await CmsService.SaveItemAsync(selectedCmsItem);
        // Refresh
        await SelectCollection(selectedCollection!);
        isEditingCmsItem = false;
    }

    private void EditCmsItem(StudioCollectionItem item)
    {
        selectedCmsItem = item;
        // Deserialize JSON to Dictionary
        try {
            item.Data = JsonSerializer.Deserialize<Dictionary<string, object>>(item.DataJson) ?? new Dictionary<string, object>();
        } catch {}
        isEditingCmsItem = true;
    }

    // Feature 6: Data Binding Logic
    private async Task BindCollectionChange(ChangeEventArgs e)
    {
        if (selectedSection == null) return;
        var val = e.Value?.ToString();
        
        if (string.IsNullOrEmpty(val)) {
            selectedSection.DataBindings.Clear();
        } else {
            selectedSection.DataBindings["CollectionId"] = val;
        }
        selectedSection.SyncBindingsToData();
        MarkAsDirty();
        await ApplyDataBindings(); // Clear bindings if removed
    }

    private async Task BindItemChange(ChangeEventArgs e)
    {
        if (selectedSection == null) return;
        var val = e.Value?.ToString();
        
        if (string.IsNullOrEmpty(val)) {
             selectedSection.DataBindings.Remove("ItemId");
        } else {
             selectedSection.DataBindings["ItemId"] = val;
        }
        selectedSection.SyncBindingsToData();
        MarkAsDirty();
        await ApplyDataBindings();
    }

    private async Task UpdateBinding(string key, string? fieldKey)
    {
        if (selectedSection == null) return;
        
        if (string.IsNullOrEmpty(fieldKey)) {
            selectedSection.DataBindings.Remove(key);
        } else {
            selectedSection.DataBindings[key] = fieldKey;
        }
        selectedSection.SyncBindingsToData();
        MarkAsDirty();
        await ApplyDataBindings();
    }

    private string GetItemDisplayName(StudioCollectionItem item)
    {
        try {
             var data = JsonSerializer.Deserialize<Dictionary<string, object>>(item.DataJson);
             if (data.ContainsKey("title")) return data["title"].ToString();
             if (data.ContainsKey("name")) return data["name"].ToString();
        } catch {}
        return $"Item #{item.Id}";
    }

    private async Task ApplyDataBindings()
    {
        if (_previewIframe.Id == null) return;

        // Map: { "clientId": { "propName": "finalValue" } }
        var updates = new Dictionary<string, Dictionary<string, string>>();

        foreach(var sec in sections)
        {
            if (sec.DataBindings.ContainsKey("CollectionId") && sec.DataBindings.ContainsKey("ItemId"))
            {
                if (int.TryParse(sec.DataBindings["CollectionId"], out int colId) && 
                    int.TryParse(sec.DataBindings["ItemId"], out int itemId))
                {
                    // Find actual data
                    var col = cmsCollections.FirstOrDefault(c => c.Id == colId);
                    var item = col?.Items.FirstOrDefault(i => i.Id == itemId);
                    
                    if (item != null)
                    {
                        var data = JsonSerializer.Deserialize<Dictionary<string, object>>(item.DataJson) ?? new Dictionary<string, object>();
                        var propUpdates = new Dictionary<string, string>();

                        foreach(var binding in sec.DataBindings)
                        {
                            // binding.Key is the target prop (e.g. "content"), binding.Value is the source field key (e.g. "blog_title")
                            if (binding.Key == "CollectionId" || binding.Key == "ItemId") continue;
                            
                            if (data.ContainsKey(binding.Value)) {
                                propUpdates[binding.Key] = data[binding.Value]?.ToString() ?? "";
                            }
                        }

                        if (propUpdates.Any())
                        {
                            updates[sec.ClientId.ToString()] = propUpdates;
                        }
                    }
                }
            }
        }

        if (updates.Any())
        {
             await JSRuntime.InvokeVoidAsync("studioPreview.applyDataBindings", _previewIframe, updates);
        }
    }

    private async void AddInteraction()
    {
        if (selectedSection == null) return;
        
        if (selectedSection.Interactions == null) 
            selectedSection.Interactions = new List<StudioInteraction>();

        var interaction = new StudioInteraction
        {
            Trigger = newInteractionTrigger,
            Action = newInteractionAction
        };

        if (newInteractionAction == "navigate" && !string.IsNullOrEmpty(newInteractionParam))
        {
            interaction.Parameters.Add("url", newInteractionParam);
        }

        selectedSection.Interactions.Add(interaction);
        selectedSection.SyncInteractionsToData();
        
        MarkAsDirty();
        showAddInteractionForm = false;
        newInteractionParam = "";

        await ApplyInteractions();
    }

    private async void RemoveInteraction(StudioInteraction interaction)
    {
        if (selectedSection != null && selectedSection.Interactions != null)
        {
            selectedSection.Interactions.Remove(interaction);
            selectedSection.SyncInteractionsToData();
            MarkAsDirty();
            await ApplyInteractions();
        }
    }

    private async Task ApplyInteractions()
    {
         if (_previewIframe.Id == null) return;
         
         // 1. Build Map: { "clientId": [interactions] }
         var map = new Dictionary<string, List<StudioInteraction>>();
         foreach(var section in sections)
         {
             if (section.Interactions != null && section.Interactions.Any())
             {
                 map[section.ClientId.ToString()] = section.Interactions;
             }
         }

         // 2. Send to JS
         if (map.Any())
         {
             await JSRuntime.InvokeVoidAsync("studioPreview.attachInteractions", _previewIframe, map);
         }
    }



    private void OpenSaveAsTemplateModal(StudioSection section)
    {
        sectionToSave = section;
        newTemplateName = section.Title ?? section.ComponentType;
        newTemplateCategory = "General";
        showSaveAsTemplateModal = true;
    }

    private void CloseSaveAsTemplateModal()
    {
        showSaveAsTemplateModal = false;
        sectionToSave = null;
        newTemplateName = "";
        newTemplateCategory = "";
    }

    private async Task SaveTemplate()
    {
        if (sectionToSave != null && !string.IsNullOrWhiteSpace(newTemplateName) && !string.IsNullOrWhiteSpace(newTemplateCategory))
        {
            var newTemplate = new StudioTemplate
            {
                Name = newTemplateName,
                Category = newTemplateCategory,
                ContentJson = JsonSerializer.Serialize(sectionToSave)
            };
            await TemplateService.CreateTemplateAsync(newTemplate);
            await LoadTemplates();
            CloseSaveAsTemplateModal();
        }
    }
    private string currentViewport = "desktop";
    private string errorMessage;
    private string errorDetails;

    private async Task LoadTemplates()
    {
        templates = await TemplateService.GetAllTemplatesAsync();
        templateCategories = templates.Select(t => t.Category).Distinct().OrderBy(c => c).ToList();
        FilterTemplates(new ChangeEventArgs { Value = "" });
    }

    private void FilterTemplates(ChangeEventArgs e)
    {
        selectedTemplateCategory = e.Value?.ToString() ?? "";
        if (string.IsNullOrEmpty(selectedTemplateCategory))
        {
            filteredTemplates = templates;
        }
        else
        {
            filteredTemplates = templates.Where(t => t.Category == selectedTemplateCategory).ToList();
        }
    }

    private async Task DeleteTemplate(int id)
    {
        await TemplateService.DeleteTemplateAsync(id);
        await LoadTemplates();
    }

    private void SetSidebarTab(string tabName)
    {
        activeToolboxTab = tabName;
        isLeftPanelCollapsed = false; // Ensure panel opens
        
        // Helper Step 2 Complete: Opened Components Panel
        if (tabName == "elements") AdvanceHelperStep(2);
    }

    private void setViewport(string viewport)
    {
        currentViewport = viewport;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && string.IsNullOrEmpty(errorMessage))
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            currentUserName = authState.User.Identity?.Name ?? "System";

            try 
            {
                allPages = await PageService.GetAllPagesAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to load pages list");
            }

            // Feature 5: Load CMS Data
            await LoadCmsCollections();
            await LoadAssets();
            await LoadTemplates();
            
            // Subscribe to Engine Events
            EngineService.OnStatusChanged += StateHasChanged;
            EngineService.OnLogReceived += (log) => InvokeAsync(StateHasChanged);

            // AUTO-START ENGINE: If this is the Studio and engine isn't running, start it
            if (string.IsNullOrEmpty(currentProjectRoot))
            {
                using var context = await DbContextFactory.CreateDbContextAsync();
                var lastRoot = await context.StudioSettings.FirstOrDefaultAsync(s => s.SettingKey == "LastProjectRoot");
                if (lastRoot != null && !string.IsNullOrEmpty(lastRoot.SettingValue))
                {
                    currentProjectRoot = lastRoot.SettingValue;
                }
            }

            // AUTO-START ENGINE: DISABLED - Studio now uses internal Blazor preview
            // The external Next.js server is no longer required for the Studio to function
            /*
            if (!EngineService.IsRunning && !string.IsNullOrEmpty(currentProjectRoot))
            {
                saveStatusText = "Igniting Rendering Engine...";
                StateHasChanged();
                await EngineService.StartAsync(currentProjectRoot);
                saveStatusText = "Ready";
                StateHasChanged();
            }
            */

            // Initialize global dotNetHelper if not already done
            if (dotNetHelper == null) dotNetHelper = DotNetObjectReference.Create(this);

            // Initialize Drag & Drop Listener
            await JSRuntime.InvokeVoidAsync("studioPreview.initDropListener", dotNetHelper);
            
            // Legacy init (consider removing if replaced by studioPreview)
            if (PageId == 0)
            {
                 // Re-using the same helper
                 await JSRuntime.InvokeVoidAsync("studioInterop.setDotNetHelper", dotNetHelper);
                 await JSRuntime.InvokeVoidAsync("studioInterop.initializeMessageHandler");
            }

            if (PageId > 0)
            {
                try
                {
                    await LoadGlobalTheme(); // Feature 2: Load Theme

                    var lockResult = await StudioService.AcquireLockAsync(PageId, "System"); // TODO: Use real user
                    if (!lockResult)
                    {
                        var currentLock = await StudioService.GetLockAsync(PageId);
                        isLocked = true;
                        lockedBy = currentLock?.LockedBy ?? "another user";

                        var userState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                        var user = userState.User;
                        canForceUnlock = (await AuthorizationService.AuthorizeAsync(user, AppPolicies.CanForceUnlock)).Succeeded;

                        return;
                    }

                    draft = await StudioService.GetLatestDraftAsync(PageId);
                    latestVersion = await AutoSaveService.GetLatestVersionAsync(PageId);

                    // Feature 2: Apply Theme to Preview (once loaded)
                    if (globalThemeSettings.Any())
                    {
                         await ApplyGlobalTheme();
                    }

                    // Feature 4: Apply Interactions (once loaded)
                     await ApplyInteractions();

                    // Feature 6: Apply Data Bindings
                    await ApplyDataBindings();
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error initializing page data inside OnAfterRenderAsync");
                }
            }
        }
    }

    private async Task LoadPageAsync(int pageId)
    {
        errorMessage = null;
        errorDetails = null;
        sections = new();
        draft = null;
        currentPage = null;

        try
        {
            currentPage = await PageService.GetPageAsync(pageId);
            if (currentPage == null)
            {
                errorMessage = "The requested page could not be found.";
                return;
            }

            PageId = pageId; // Update the component's parameter
            _pageSlug = currentPage.Slug;
            _previewUrl = $"/studio/preview/{_pageSlug}";

            draft = await StudioService.GetLatestDraftAsync(PageId);
            sections = !string.IsNullOrEmpty(draft?.ContentSnapshotJson)
                ? JsonSerializer.Deserialize<List<StudioSection>>(draft.ContentSnapshotJson)
                : new List<StudioSection>();

            await LoadHistory();
            await LoadTemplates(); // Consider if this needs to be reloaded every time
            
            // Send sections to the preview iframe
            await SendSectionsToPreview();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load page data for page {PageId}", pageId);
            errorMessage = "An unexpected error occurred while loading the page.";
            errorDetails = ex.Message;
        }

        StateHasChanged(); // Ensure the UI updates
    }



    private async Task SendSectionsToPreview()
    {
        try
        {
            if (_previewIframe.Id != null && sections != null)
            {
                var sectionsJson = JsonSerializer.Serialize(sections);
                await JSRuntime.InvokeVoidAsync("sendSectionsToPreview", _previewIframe, sectionsJson);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to send sections to preview");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Handle external navigation or initial load
        if (PageId > 0 && PageId != currentPage?.Id)
        {
            await LoadPageAsync(PageId);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        dotNetHelper = DotNetObjectReference.Create(this);
        
        try
        {
            // 1. Load Last Project Settting
            using var context = await DbContextFactory.CreateDbContextAsync();
            var projSetting = await context.StudioSettings.FirstOrDefaultAsync(s => s.SettingKey == "LastProjectRoot");
            if (projSetting != null && !string.IsNullOrEmpty(projSetting.SettingValue))
            {
                currentProjectRoot = projSetting.SettingValue;
            }

            // 2. Load FileSystem
            NavigateToFolder(currentProjectRoot);

            // 3. Load Pages from DB
            allPages = await PageService.GetAllPagesAsync();

            if (PageId == 0)
            {
                var firstPage = allPages.OrderBy(p => p.Title).FirstOrDefault();
                if (firstPage != null)
                {
                    NavigationManager.NavigateTo($"/studio/{firstPage.Id}", replace: true);
                }
                else
                {
                    errorMessage = "No pages found. Create a new page to begin.";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize Studio");
            errorMessage = $"Studio initialization failed: {ex.Message}";
        }
    }

    private async Task RefreshPages()
    {
        try {
            allPages = await PageService.GetAllPagesAsync();
            StateHasChanged();
        } catch (Exception ex) {
            Logger.LogError(ex, "Failed to refresh page list");
        }
    }

    [JSInvokable]
    public async Task UpdateAnimationTimeline(double delay, double duration)
    {
        currentAnimationSettings.Delay = Math.Round(delay, 2);
        currentAnimationSettings.Duration = Math.Round(duration, 2);
        await UpdateAnimationSettings();
        StateHasChanged();
    }

    // Feature 7: Publish Workflow
    private bool showPublishWizard = false;
    private bool isPublishing = false;
    private string publishMessage = "";

    private void OpenPublishWizard()
    {
        showPublishWizard = true;
        publishMessage = "";
    }

    private async Task ConfirmPublish()
    {
        isPublishing = true;
        publishMessage = "Generating production build...";
        StateHasChanged();

        try 
        {
            // 1. Save current state
            await SaveDraft(true);
            
            publishMessage = "Deploying to live environment...";
            StateHasChanged();

            // 2. Publish via Service
            if (draft != null)
            {
                await StudioService.PublishDraftAsync(draft.Id);
            }

            // 3. (Optional) Generate Static Export for CDN
            // await StaticExportService.GenerateStaticSiteAsync(PageId);

            publishMessage = "Successfully published!";
            await Task.Delay(1000);
            showPublishWizard = false;
            saveStatus = SaveStatus.Saved;
            saveStatusText = "Published Live";
        }
        catch (Exception ex)
        {
            publishMessage = "Error: " + ex.Message;
            Logger.LogError(ex, "Publish failed");
        }
        finally
        {
            isPublishing = false;
        }
    }

    private async Task LoadHistory()
    {
        draftHistory = (await StudioService.GetDraftHistoryAsync(PageId)).ToList();
    }

    private async Task SaveDraft(bool fromModal = false)
    {
        if (!fromModal)
        {
            showSaveVersionModal = true;
            return;
        }

        showSaveVersionModal = false;

        try
        {
            saveStatus = SaveStatus.Saving;
            saveStatusText = "Saving manual version...";
            StateHasChanged();

            if (selectedSection != null)
            {
               // Update animation settings logic if needed
            }
            
            var json = JsonSerializer.Serialize(sections);
            draft = await StudioService.SaveDraftAsync(PageId, json, "System", versionDescription); // TODO: Use real user
            
            // Physical File Sync
            if (currentPage != null)
            {
                await ProjectFileService.SavePageDataAsync(currentProjectRoot, currentPage, sections);
                await ProjectFileService.GeneratePageFileAsync(currentProjectRoot, currentPage, sections);
            }

            versionDescription = string.Empty; // Reset for next time
            
            await LoadHistory();
            latestVersion = await AutoSaveService.GetLatestVersionAsync(PageId);

            saveStatus = SaveStatus.Saved;
            saveStatusText = "Saved to Database & Project Folder";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save draft");
            errorMessage = "Failed to save draft: " + ex.Message;
        }
    }

    private void AddSection()
    {
        // This is now deprecated in favor of dragging components.
        // var newSection = new StudioSection
        // {
        //     ClientId = Guid.NewGuid(),
        //     PageIndex = sections.Count,
        //     StudioPageId = PageId,
        //     ComponentType = "TextBlock", // Default component
        //     PropertiesJson = "{ \"text\": \"New Section\" }"
        // };
        // sections.Add(newSection);
    }

    private RenderFragment RenderPropertyEditor(StudioSection section) => builder =>
    {
        if (section.ComponentType == "HeroSection")
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "property-group");

            builder.OpenElement(2, "label");
            builder.AddAttribute(3, "for", "hero-headline");
            builder.AddContent(4, "Headline");
            builder.CloseElement();

            builder.OpenElement(5, "input");
            builder.AddAttribute(6, "type", "text");
            builder.AddAttribute(7, "id", "hero-headline");
            builder.AddAttribute(8, "class", "form-control");
            builder.AddAttribute(9, "value", heroSectionProperties.GetValueOrDefault("Headline"));
            builder.AddAttribute(10, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, async e => await UpdateHeroProperty("Headline", (string)e.Value)));
            builder.CloseElement();

            builder.CloseElement();
        }
    };

    private async Task UpdateHeroProperty(string key, string value)
    {
        heroSectionProperties[key] = value;
        selectedSection.PropertiesJson = JsonSerializer.Serialize(heroSectionProperties);
        await SaveDraft();
        await JSRuntime.InvokeVoidAsync("studioInterop.refreshPreview");
    }

    [JSInvokable]
    public void SelectComponent(string componentId)
    {
        var section = sections.FirstOrDefault(s => s.ClientId.ToString() == componentId);
        if (section != null)
        {
            selectedSection = section;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void UpdateSectionOrder(string[] clientIds)
    {
        var newSections = new List<StudioSection>();
        foreach (var id in clientIds)
        {
            var section = sections.First(s => s.ClientId == Guid.Parse(id));
            section.PageIndex = newSections.Count;
            newSections.Add(section);
        }
        sections = newSections;
        MarkAsDirty();
        StateHasChanged();
    }

    private void CloseImportModal()
    {
        showUrlImportModal = false;
        importErrorMessage = "";
        urlToImport = "";
    }

    private async Task ImportFromUrl()
    {
        if (string.IsNullOrWhiteSpace(urlToImport))
        {
            importErrorMessage = "Please enter a URL to import.";
            return;
        }

        isImporting = true;
        importErrorMessage = "";
        StateHasChanged();

        try
        {
            var scrapedSections = await ContentIngestionService.ScrapeUrlAsync(urlToImport);
            if (scrapedSections.Any())
            {
                // 1. Create a new page
                var pageTitle = scrapedSections.FirstOrDefault(s => s.ComponentType == StudioComponentType.Heading)?.Title ?? "Imported Page";
                var newPage = await PageService.CreatePageAsync(pageTitle, "/");

                // 2. Create the redirect
                await ContentIngestionService.CreateRedirectAsync(urlToImport, newPage.Slug);

                // 3. Associate sections with the new page and save
                int index = 0;
                foreach (var section in scrapedSections)
                {
                    section.StudioPageId = newPage.Id;
                    section.PageIndex = index++;
                }

                var json = JsonSerializer.Serialize(scrapedSections);
                await StudioService.SaveDraftAsync(newPage.Id, json, currentUserName, "Initial import from URL");

                // 4. Navigate to the new page
                CloseImportModal();
                NavigationManager.NavigateTo($"/studio/{newPage.Id}");
            }
            else
            {
                importErrorMessage = "No content (headings, paragraphs, or images) could be found at the specified URL.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to import from URL {Url}", urlToImport);
            importErrorMessage = $"Failed to import content. Error: {ex.Message}";
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    private async Task ExportSite()
    {
        isExporting = true;
        exportErrorMessage = "";
        StateHasChanged();

        try
        {
            var zipBytes = await StaticExportService.ExportSiteAsZipAsync();
            var fileName = $"GFC-Studio-Export-{DateTime.Now:yyyyMMddHHmmss}.zip";

            // Trigger download using JavaScript interop
            var fileStream = new MemoryStream(zipBytes);
            using var streamRef = new DotNetStreamReference(stream: fileStream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to export site");
            exportErrorMessage = $"Failed to export site. Error: {ex.Message}";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        EngineService.OnStatusChanged -= StateHasChanged;
        // EngineService.OnLogReceived -= ... (requires better cleanup if using lambdas)
        dotNetHelper?.Dispose();
    }
}
