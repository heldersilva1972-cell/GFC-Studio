@page "/studio"
@page "/studio/{PageId:int}"
@layout GFC.BlazorServer.Components.Layout.StudioLayout
@using System.Text.Json
@using GFC.Core.Models
@using GFC.Core.Interfaces
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Auth
@using GFC.BlazorServer.Components.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using GFC.BlazorServer.Data
@inject IJSRuntime JSRuntime
@inject GFC.BlazorServer.Services.IStudioService StudioService
@inject IStudioAutoSaveService AutoSaveService
@inject IPageService PageService
@inject ITemplateService TemplateService
@inject IContentIngestionService ContentIngestionService
@inject IStaticExportService StaticExportService
@inject ILogger<Studio> Logger
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAuthorizationService AuthorizationService
@inject IConfiguration Configuration
@inject IDbContextFactory<GfcDbContext> DbContextFactory

<script src="~/js/studio-preview.js"></script>

<style>
    /* DIRECT OVERRIDE TO ENSURE BLUE HEADER APPLIES WITHOUT REBUILD */
    .studio-container {
        --ide-bg-header: #93c5fd !important; /* Standard Light Blue */
        --ide-bg-activity-bar: #f0f9ff !important; /* Very pale blue for sidebar */
    }
    
    .top-command-bar {
        background-color: #93c5fd !important;
        border-bottom: 1px solid #60a5fa !important;
    }
    
    .brand-section {
        color: #172554 !important; /* Deep Blue Text */
    }
    
    .top-command-bar .text-muted {
        color: #1e3a8a !important;
    }
    
    .toolbar-controls {
        background: rgba(255,255,255,0.4) !important;
        border: 1px solid rgba(255,255,255,0.6) !important;
    }

    /* FIX: Sidebar Selection */
    .pro-list-item.selected {
        background-color: #dbeafe !important; /* Light blue match */
        color: #1e40af !important; /* Dark blue text */
        border-right: 3px solid #3b82f6 !important; /* Blue active indicator */
    }

    /* FIX: Right Inspector Header & Tabs */
    .inspector-tabs {
        background-color: #f1f5f9 !important; /* Light gray */
        border-bottom: 1px solid #e2e8f0 !important;
    }

    .inspector-tab {
        color: #64748b !important; /* Muted slate */
    }
    
    .inspector-tab:hover {
        background-color: #e2e8f0 !important;
        color: #334155 !important;
    }

    .inspector-tab.active {
        background-color: #ffffff !important;
        color: #2563eb !important; /* Bright Blue */
        border-bottom: 2px solid #2563eb !important;
    }

    .panel-section-header {
        background-color: #f8fafc !important; /* Very light gray */
        color: #334155 !important; /* Dark slate text */
        border-bottom: 1px solid #e2e8f0 !important;
    }
    
    /* FIX: Input Fields Dark Backgrounds */
    .pro-input, .pro-select {
        background-color: #ffffff !important;
        color: #1e293b !important;
        border: 1px solid #cbd5e1 !important;
    }

    /* FIX: Collapsible Sidebar */
    .side-bar.collapsed {
        display: none !important;
        width: 0 !important;
    }
</style>

<div class="studio-container">
    <!-- 1. PROFESSIONAL HEADER (Minimal Toolbar) -->
    <div class="top-command-bar">
        <div class="brand-section">
            <a href="/" class="icon-btn" title="Exit to Home">
                <i class="bi bi-list"></i>
            </a>
            <span class="fs-6">GFC Studio</span>
        </div>

        <div class="center-section">
             <div class="toolbar-controls">
                <button class="icon-btn @(currentViewport == "desktop" ? "active" : "")" @onclick='() => currentViewport = "desktop"' title="Desktop">
                    <i class="bi bi-display"></i>
                </button>
                <button class="icon-btn @(currentViewport == "tablet" ? "active" : "")" @onclick='() => currentViewport = "tablet"' title="Tablet">
                    <i class="bi bi-tablet"></i>
                </button>
                <button class="icon-btn @(currentViewport == "mobile" ? "active" : "")" @onclick='() => currentViewport = "mobile"' title="Mobile">
                    <i class="bi bi-phone"></i>
                </button>
            </div>
        </div>

        <div class="actions-section d-flex gap-2">
            <span class="text-muted small me-2 align-self-center">@saveStatusText</span>
             <button class="action-btn btn-save" @onclick="() => SaveDraft()">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="action-btn btn-publish" @onclick="OpenPublishWizard">
                <i class="bi bi-rocket-takeoff"></i> Publish
            </button>
        </div>
    </div>

    <!-- 2. MAIN WORKSPACE ROW -->
    <div class="studio-workspace">
        
        <!-- A. ACTIVITY BAR (Far Left Rail) -->
        <div class="activity-bar">
            <!-- 1. Pages / Explorer -->
            <button class="activity-item @(activeToolboxTab == "pages" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => ToggleSidebar("pages")' 
                    title="Pages & Navigation">
                <i class="bi bi-files"></i>
            </button>
            
             <!-- 2. Outline / Tree View (NEW) -->
            <button class="activity-item @(activeToolboxTab == "outline" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => ToggleSidebar("outline")' 
                    title="Page Outline">
                <i class="bi bi-diagram-3"></i>
            </button>

            <!-- 3. Components / Add -->
            <button class="activity-item @(activeToolboxTab == "elements" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => ToggleSidebar("elements")' 
                    title="Add Elements">
                <i class="bi bi-plus-square"></i>
            </button>

             <!-- 4. CMS / Data (NEW) -->
             <button class="activity-item @(activeToolboxTab == "cms" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => ToggleSidebar("cms")' 
                    title="CMS Collections">
                <i class="bi bi-database"></i>
            </button>
            
            <!-- 5. Assets / Media (NEW) -->
             <button class="activity-item @(activeToolboxTab == "assets" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => ToggleSidebar("assets")' 
                    title="Media Assets">
                <i class="bi bi-images"></i>
            </button>

            <!-- 6. Templates -->
            <button class="activity-item @(activeToolboxTab == "templates" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => ToggleSidebar("templates")' 
                    title="Templates">
                <i class="bi bi-grid-1x2"></i>
            </button>
            
            <!-- 7. Sync -->
            <button class="activity-item @(activeToolboxTab == "migration" && !isLeftPanelCollapsed ? "active" : "")" 
                    @onclick='() => ToggleSidebar("migration")' 
                    title="Data Sync">
                <i class="bi bi-arrow-repeat"></i>
            </button>

            <div style="flex-grow: 1;"></div>
            
             <!-- Bottom Actions -->
            <button class="activity-item" title="Settings">
                <i class="bi bi-gear"></i>
            </button>
        </div>

        <!-- B. SIDEBAR (Collapsible Drawer) -->
        <div class="side-bar @(isLeftPanelCollapsed ? "collapsed" : "")">
            <div class="sidebar-header d-flex justify-content-between align-items-center">
                <span>@GetSidebarTitle()</span>
                <button class="btn btn-sm text-muted p-0" @onclick="() => isLeftPanelCollapsed = true"><i class="bi bi-x"></i></button>
            </div>
            <div class="sidebar-content">
                @if (activeToolboxTab == "pages")
                {
                    <div class="p-2">
                         <div class="d-flex justify-content-between align-items-center mb-2 px-2">
                            <span class="text-muted small fw-bold">SITE PAGES</span>
                            <button class="icon-btn btn-sm" @onclick="() => showNewPageModal = true" title="New Page"><i class="bi bi-plus"></i></button>
                        </div>
                        
                        @foreach (var p in allPages.OrderBy(x => x.Title))
                        {
                            <div class="pro-list-item @(p.Id == PageId ? "selected" : "")" @onclick="() => HandlePageSelected(p)">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-file-earmark-text text-muted"></i>
                                    <span>@p.Title</span>
                                </div>
                                <small class="text-muted ms-4">/@(p.Slug)</small>
                            </div>
                        }
                    </div>
                }
                
                @if (activeToolboxTab == "outline")
                {
                    <!-- Placeholder: Tree View -->
                    <div class="p-3 text-muted">
                        <div class="mb-2"><i class="bi bi-caret-down-fill"></i> Body</div>
                        <div class="ms-3 mb-2"><i class="bi bi-caret-down-fill"></i> Navbar</div>
                        <div class="ms-3 mb-2"><i class="bi bi-caret-down-fill"></i> Hero Section</div>
                         <div class="ms-4 mb-2 ps-2 border-start border-3 text-dark fw-bold"><i class="bi bi-fonts"></i> Heading</div>
                         <div class="ms-4 mb-2 ps-2 border-start border-3"><i class="bi bi-card-image"></i> Hero Image</div>
                        <div class="ms-3 mb-2"><i class="bi bi-caret-right"></i> Footer</div>
                    </div>
                }
                
                @if (activeToolboxTab == "cms")
                {
                    <!-- Placeholder: CMS Data -->
                     <div class="p-2">
                        <span class="text-muted small fw-bold px-2 d-block mb-2">COLLECTIONS</span>
                        <div class="pro-list-item"><i class="bi bi-journal-text me-2"></i> Blog Posts</div>
                        <div class="pro-list-item"><i class="bi bi-calendar-event me-2"></i> Events</div>
                        <div class="pro-list-item"><i class="bi bi-people me-2"></i> Authors</div>
                        <div class="pro-list-item"><i class="bi bi-tags me-2"></i> Categories</div>
                    </div>
                }

                @if (activeToolboxTab == "assets")
                {
                     <!-- Placeholder: Assets -->
                     <div class="p-2">
                        <div class="input-group input-group-sm mb-2">
                             <input type="text" class="form-control form-control-sm pro-input" placeholder="Search assets...">
                             <span class="input-group-text bg-white border"><i class="bi bi-search"></i></span>
                        </div>
                        <div class="row g-2 px-2">
                            <div class="col-6"><div class="ratio ratio-1x1 bg-light rounded border"></div></div>
                            <div class="col-6"><div class="ratio ratio-1x1 bg-light rounded border"></div></div>
                            <div class="col-6"><div class="ratio ratio-1x1 bg-light rounded border"></div></div>
                            <div class="col-6"><div class="ratio ratio-1x1 bg-light rounded border"></div></div>
                        </div>
                    </div>
                }

                @if (activeToolboxTab == "templates")
                {
                     <div class="p-2">
                         <select class="form-select form-select-sm pro-select mb-2" @onchange="FilterTemplates">
                                <option value="">All Categories</option>
                                @foreach (var category in templateCategories) { <option value="@category">@category</option> }
                        </select>
                        @foreach (var template in filteredTemplates)
                        {
                            <div class="pro-card" draggable="true" @ondragstart="@(() => HandleDragStart(template))">
                                <div class="fw-bold">@template.Name</div>
                                <small class="text-muted">@template.Category</small>
                            </div>
                        }
                    </div>
                }
                @if (activeToolboxTab == "elements")
                {
                    <div class="p-2">
                         @foreach (var component in availableComponents)
                        {
                            <div class="pro-card d-flex align-items-center gap-3" draggable="true" @ondragstart="@(() => HandleComponentDragStart(component))">
                                <span class="fs-5 text-muted">@component.Icon</span>
                                <div>
                                    <div class="fw-bold small">@component.Name</div>
                                    <div class="text-muted small" style="font-size: 10px;">@component.Description</div>
                                </div>
                            </div>
                        }
                    </div>
                }
                 @if (activeToolboxTab == "migration")
                {
                     <div class="p-3">
                        <h6 class="text-muted small fw-bold mb-3">CONTENT SYNC</h6>
                        <button class="action-btn w-100 mb-2 justify-content-center bg-white border" @onclick="() => showUrlImportModal = true">
                            <i class="bi bi-cloud-download"></i> Import from URL
                        </button>
                        <button class="action-btn w-100 justify-content-center bg-white border" @onclick="ExportSite">
                            <i class="bi bi-archive"></i> Export Site
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- C. CANVAS (Main Editor) -->
        <div class="canvas-area @($"viewport-{currentViewport}")">
            <div class="canvas-scroller">
                <div class="canvas-frame" @ondrop="HandleDrop" @ondragover:preventDefault="true">
                    @if (!string.IsNullOrEmpty(_previewUrl))
                    {
                         <iframe @ref="_previewIframe" 
                                src="@_previewUrl" 
                                class="studio-preview-iframe" 
                                style="width: 100%; height: 100%; border: none;"
                                allow="clipboard-write">
                        </iframe>
                    }
                    else 
                    {
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <div class="spinner-border text-secondary mb-3" style="width: 1.5rem; height: 1.5rem;" role="status"></div>
                            <small>Initializing Engine...</small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- D. RIGHT INSPECTOR (Tabbed & Compact) -->
        <div class="inspector-panel">
            <!-- Inspector Tabs -->
            <div class="inspector-tabs">
                <button class="inspector-tab @(activeInspectorTab == "properties" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "properties"' 
                        title="Properties">
                    <i class="bi bi-sliders"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "style" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "style"' 
                        title="Styling">
                    <i class="bi bi-palette"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "animation" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "animation"' 
                        title="Animations">
                    <i class="bi bi-film"></i>
                </button>
                <button class="inspector-tab @(activeInspectorTab == "settings" ? "active" : "")" 
                        @onclick='() => activeInspectorTab = "settings"' 
                        title="Settings">
                    <i class="bi bi-gear"></i>
                </button>
            </div>

            <!-- Inspector Content Area -->
            <div class="inspector-body">
                @if (activeInspectorTab == "properties")
                {
                    <div class="panel-section-header">Content Properties</div>
                    <div class="property-grid">
                        <StudioWizard @ref="studioWizard" TargetSection="selectedSection" OnAssetChanged="HandleAssetChange" OnPropertyChanged="HandlePropertyChange" />
                    </div>
                }
                
                @if (activeInspectorTab == "style")
                {
                    <div class="panel-section-header">Visual Styling</div>
                    
                    <!-- 1. Layout -->
                    <details class="style-group" open>
                        <summary>Layout</summary>
                        <div class="group-content">
                            <div class="pro-label">Display</div>
                            <div class="pro-icon-group mb-2">
                                <button class="pro-icon-btn active" title="Block"><i class="bi bi-square"></i></button>
                                <button class="pro-icon-btn" title="Flex"><i class="bi bi-layout-three-columns"></i></button>
                                <button class="pro-icon-btn" title="Grid"><i class="bi bi-grid-3x3"></i></button>
                                <button class="pro-icon-btn" title="Inline"><i class="bi bi-type"></i></button>
                                <button class="pro-icon-btn" title="None"><i class="bi bi-eye-slash"></i></button>
                            </div>
                        </div>
                    </details>

                    <!-- 2. Spacing -->
                    <details class="style-group" open>
                        <summary>Spacing</summary>
                        <div class="group-content">
                            <!-- Helper graphic for Margin/Padding -->
                            <div class="p-4 bg-light text-center border rounded mb-2 text-muted" style="font-size: 10px;">
                                <div class="border border-dashed p-2 mb-1">MARGIN</div>
                                <div class="bg-white border p-2">PADDING</div>
                            </div>
                            <div class="pro-row two-col">
                                <div><span class="pro-label">Margin</span><input type="text" class="pro-input" placeholder="0px" /></div>
                                <div><span class="pro-label">Padding</span><input type="text" class="pro-input" placeholder="0px" /></div>
                            </div>
                        </div>
                    </details>

                     <!-- 3. Size -->
                    <details class="style-group">
                        <summary>Size</summary>
                        <div class="group-content">
                            <div class="pro-row two-col">
                                <div><span class="pro-label">Width</span><input type="text" class="pro-input" placeholder="auto" /></div>
                                <div><span class="pro-label">Height</span><input type="text" class="pro-input" placeholder="auto" /></div>
                            </div>
                             <div class="pro-row two-col">
                                <div><span class="pro-label">Min W</span><input type="text" class="pro-input" placeholder="0" /></div>
                                <div><span class="pro-label">Max W</span><input type="text" class="pro-input" placeholder="none" /></div>
                            </div>
                        </div>
                    </details>

                    <!-- 4. Typography -->
                    <details class="style-group">
                        <summary>Typography</summary>
                        <div class="group-content">
                             <div class="pro-row">
                                <span class="pro-label">Font</span>
                                <select class="pro-select"><option>Inter</option><option>Arial</option><option>Roboto</option></select>
                            </div>
                            <div class="pro-row two-col">
                                <div><span class="pro-label">Weight</span><select class="pro-select"><option>400</option><option>700</option></select></div>
                                <div><span class="pro-label">Size</span><input type="text" class="pro-input" placeholder="16px" /></div>
                            </div>
                            <div class="pro-row two-col">
                                <div><span class="pro-label">Color</span><input type="color" class="pro-input" value="#000000" style="height: 30px; padding: 2px;" /></div>
                                <div><span class="pro-label">Align</span>
                                    <div class="pro-icon-group">
                                         <button class="pro-icon-btn"><i class="bi bi-text-left"></i></button>
                                         <button class="pro-icon-btn"><i class="bi bi-text-center"></i></button>
                                         <button class="pro-icon-btn"><i class="bi bi-text-right"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 5. Backgrounds -->
                    <details class="style-group">
                        <summary>Backgrounds</summary>
                        <div class="group-content">
                             <div class="pro-row">
                                <span class="pro-label">Color</span>
                                <div class="d-flex align-items-center gap-2 w-100">
                                     <input type="color" class="pro-input" value="#ffffff" style="width: 30px; height: 30px; padding: 0;" />
                                     <input type="text" class="pro-input" value="#ffffff" />
                                </div>
                            </div>
                             <button class="btn btn-sm btn-outline-secondary w-100 mt-2" style="font-size: 11px;">+ Image / Gradient</button>
                        </div>
                    </details>
                    
                     <!-- 6. Borders -->
                    <details class="style-group">
                        <summary>Borders</summary>
                        <div class="group-content">
                             <div class="pro-row two-col">
                                <div><span class="pro-label">Radius</span><input type="text" class="pro-input" placeholder="0px" /></div>
                                <div><span class="pro-label">Width</span><input type="text" class="pro-input" placeholder="0px" /></div>
                            </div>
                        </div>
                    </details>
                }
                
                @if (activeInspectorTab == "animation")
                {
                    <div class="panel-section-header">Animation Timeline</div>
                    <div class="timeline-container">
                        <AnimationOrchestrator TargetSection="selectedSection" OnAnimationSettingsChanged="HandleAnimationSettingsChanged" />
                    </div>
                }

                @if (activeInspectorTab == "settings")
                {
                    <div class="panel-section-header">Page Settings</div>
                     <div class="p-3">
                         <div class="mb-3">
                             <label class="pro-label">Page Title</label>
                             <input type="text" class="pro-input" value="@allPages.FirstOrDefault(p => p.Id == PageId)?.Title" placeholder="Page Name" />
                         </div>
                         <div class="mb-3">
                             <label class="pro-label">URL Slug</label>
                             <input type="text" class="pro-input" value="@allPages.FirstOrDefault(p => p.Id == PageId)?.Slug" placeholder="/example" />
                         </div>
                    </div>
                    
                    <div class="panel-section-header">SEO & Meta</div>
                    <div class="p-3">
                         <div class="mb-3">
                             <label class="pro-label">Meta Title</label>
                             <input type="text" class="pro-input" placeholder="Search Engine Title" />
                         </div>
                          <div class="mb-3">
                             <label class="pro-label">Meta Description</label>
                             <textarea class="pro-input" rows="3" placeholder="Description for search results..."></textarea>
                         </div>
                         <div class="mb-3">
                             <label class="pro-label">Open Graph Image</label>
                             <div class="d-flex gap-1">
                                <input type="text" class="pro-input" placeholder="https://..." />
                                <button class="btn btn-sm btn-secondary"><i class="bi bi-upload"></i></button>
                             </div>
                         </div>
                    </div>

                    <div class="panel-section-header">Custom Code</div>
                    <div class="p-3">
                         <div class="mb-3">
                             <label class="pro-label">Inside &lt;head&gt; tag</label>
                             <textarea class="pro-input font-monospace" rows="3" placeholder="<script>..."></textarea>
                         </div>
                         <div class="mb-3">
                             <label class="pro-label">Before &lt;/body&gt; tag</label>
                             <textarea class="pro-input font-monospace" rows="3" placeholder="<script>..."></textarea>
                         </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    // ... Existing Code
    private string activeInspectorTab = "properties"; // Default tab
    // ...
}
@if (showSaveAsTemplateModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Section as Template</h5>
                    <button type="button" class="close" @onclick="CloseSaveAsTemplateModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="templateName">Template Name</label>
                        <input type="text" class="form-control" id="templateName" @bind="newTemplateName" />
                    </div>
                    <div class="form-group">
                        <label for="templateCategory">Category</label>
                        <input type="text" class="form-control" id="templateCategory" @bind="newTemplateCategory" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSaveAsTemplateModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveTemplate">Save Template</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showPublishingWizard)
{
    <PublishingWizard Page="allPages.FirstOrDefault(p => p.Id == PageId)" OnCancel="() => showPublishingWizard = false" OnConfirm="HandlePublish" />
}

@if (showSaveVersionModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Named Version</h5>
                    <button type="button" class="close" @onclick="() => showSaveVersionModal = false">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="versionDescription">Description (optional)</label>
                        <input type="text" class="form-control" id="versionDescription" @bind="versionDescription" placeholder="e.g., Before Christmas Redesign" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showSaveVersionModal = false">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="() => SaveDraft(true)">Save Version</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showUrlImportModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import from URL</h5>
                    <button type="button" class="close" @onclick="CloseImportModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    @if (isImporting)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p>Scraping content, please wait...</p>
                        </div>
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(importErrorMessage))
                        {
                            <div class="alert alert-danger">@importErrorMessage</div>
                        }
                        <div class="form-group">
                            <label for="urlInput">URL to Scrape</label>
                            <input type="text" class="form-control" id="urlInput" @bind="urlToImport" />
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseImportModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ImportFromUrl">Import</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showPublishModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Publish</h5>
                    <button type="button" class="close" @onclick="() => showPublishModal = false">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to publish your changes to the live website? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showPublishModal = false">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmPublish">Publish</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    public class StudioComponentDefinition
    {
        public string Name { get; set; }
        public string Description { get; set; }
        public string Icon { get; set; }
        public string ComponentType { get; set; }
        public string DefaultProperties { get; set; }
    }

    private List<StudioComponentDefinition> availableComponents = new List<StudioComponentDefinition>
    {
        new StudioComponentDefinition { Name = "Hero Section", Description = "Large banner with title and image", Icon = "üñºÔ∏è", ComponentType = "HeroSection", DefaultProperties = "{ \"headline\": \"Welcome\", \"backgroundImage\": \"\" }" },
        new StudioComponentDefinition { Name = "Text Block", Description = "Rich text content", Icon = "üìù", ComponentType = "RichTextBlock", DefaultProperties = "{ \"content\": \"<p>Enter text...</p>\" }" },
        new StudioComponentDefinition { Name = "Button CTA", Description = "Call to action button", Icon = "üîò", ComponentType = "ButtonCTA", DefaultProperties = "{ \"text\": \"Click Me\", \"link\": \"#\" }" }
    };

    private StudioComponentDefinition draggedComponent;
    public enum SaveStatus
    {
        Saved,
        Saving,
        Error
    }

    [Parameter]
    public int PageId { get; set; }

    private bool showUrlImportModal = false;
    private string urlToImport = "";
    private bool isImporting = false;
    private string importErrorMessage = "";

    private bool isExporting = false;
    private string exportErrorMessage = "";

    private bool isLeftPanelCollapsed = false;
    private bool isRightPanelCollapsed = false;

    private bool showNewPageModal = false;
    private List<StudioPage> allPages = new();
    private StudioPage currentPage;
    private StudioDraft draft;
    // allPages removed (duplicate)
    private List<StudioSection> sections = new();
    private StudioSection selectedSection;
    private List<StudioTemplate> templates = new();
    private List<StudioTemplate> filteredTemplates = new();
    private List<string> templateCategories = new();
    private string selectedTemplateCategory = "";
    private string activeToolboxTab = "pages"; // Default to Pages tab
    private StudioSection sectionToSave;
    private bool showSaveAsTemplateModal = false;
    private string newTemplateName = "";
    private string newTemplateCategory = "";
    private string lastWizardAction = "";
    private bool showHistory = false;
    private Dictionary<string, string> heroSectionProperties = new();
    private List<StudioDraft> draftHistory = new();
    private StudioSection lastUndoState;
    private StudioTemplate draggedTemplate;
    private void HandleAnimationSettingsChanged(string newSettings)
    {
        if (selectedSection != null)
        {
            selectedSection.AnimationSettings = newSettings;
            StateHasChanged();
        }
    }

    private AnimationSettings currentAnimationSettings = new();
    private StudioWizard studioWizard;
    private List<StudioWizard.WizardWarning> wizardWarnings = new();
    private ElementReference _timelineElement;
    private ElementReference _previewIframe;
    private string _previewUrl;
    private string _pageSlug;
    private string currentUserName;
    private SaveStatus saveStatus = SaveStatus.Saved;
    private string saveStatusText = "All changes saved.";
    private int latestVersion = 0;
    private bool showPublishModal = false;
    private bool showSaveVersionModal = false;
    private string versionDescription = string.Empty;
    private bool showPublishingWizard = false;
    private bool isLocked = false;
    private string lockedBy = "";
    private bool canForceUnlock = false;

    protected override void OnParametersSet()
    {
        if (studioWizard != null)
        {
            wizardWarnings = studioWizard.Warnings;
        }
    }

    // MarkAsDirty removed (duplicate)

    private void HandleContentFixed(string newContent, string fixName)
    {
        if (selectedSection != null)
        {
            lastUndoState = new StudioSection { PropertiesJson = selectedSection.PropertiesJson };
            // This needs to be updated to modify the JSON properties, not a simple string.
            // selectedSection.PropertiesJson = newContent;
            lastWizardAction = $"Auto-Fix: {fixName}";
            MarkAsDirty();
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void SetSelectedSection(StudioSection section)
    {
        selectedSection = section;
        StateHasChanged();
    }

    private async Task HandlePropertyChange((string sectionId, string propertyName, object propertyValue) args)
    {
        var styleUpdate = new Dictionary<string, object>
        {
            { args.propertyName, args.propertyValue }
        };

        if (_previewIframe.Context != null)
        {
            await JSRuntime.InvokeVoidAsync("studioInterop.updateStyleInPreview", _previewIframe, args.sectionId, styleUpdate);
        }
    }

    private async Task HandleAssetChange(MediaAsset asset)
    {
        if (selectedSection != null)
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var existingLinks = context.StudioSectionAssets.Where(ssa => ssa.StudioSectionId == selectedSection.Id);
            context.StudioSectionAssets.RemoveRange(existingLinks);

            var newLink = new StudioSectionAsset
            {
                StudioSectionId = selectedSection.Id,
                MediaAssetId = asset.Id
            };
            context.StudioSectionAssets.Add(newLink);

            await context.SaveChangesAsync();
            MarkAsDirty();
        }
    }

    private void UndoLastAction()
    {
        if (selectedSection != null && lastUndoState != null)
        {
            selectedSection.Content = lastUndoState.Content;
            selectedSection.AnimationSettingsJson = lastUndoState.AnimationSettingsJson;
            lastWizardAction = "";
            lastUndoState = null;
            MarkAsDirty();
            StateHasChanged();
        }
    }

    private void ToggleHistory() => showHistory = !showHistory;

    private async Task SelectSection(StudioSection section)
    {
        selectedSection = section;

      if (!string.IsNullOrEmpty(selectedSection.AnimationSettingsJson))
        {
            try
            {
                currentAnimationSettings = JsonSerializer.Deserialize<AnimationSettings>(selectedSection.AnimationSettingsJson) ?? new AnimationSettings();
            }
            catch(Exception ex)
            {
                currentAnimationSettings = new AnimationSettings();
            }
        }
        else
        {
            currentAnimationSettings = new AnimationSettings();
        }

        // Re-initialize JS interop for the timeline
        await JSRuntime.InvokeVoidAsync("animationInterop.initializeTimeline", DotNetObjectReference.Create(this));
        await JSRuntime.InvokeVoidAsync("animationScrubbing.initializeScrubbing", _previewIframe);
    }

    private async Task UpdateAnimationSettings()
    {
        if (selectedSection != null)
        {
            selectedSection.AnimationSettingsJson = JsonSerializer.Serialize(currentAnimationSettings);
            await JSRuntime.InvokeVoidAsync("studioInterop.updateAnimation", _previewIframe, selectedSection);
        }
        showHistory = false;
        MarkAsDirty(); // When a user rolls back, it should be saved as a new draft
        StateHasChanged();
    }

    // Updated Sidebar Controller
    private void ToggleSidebar(string tabName)
    {
        if (activeToolboxTab == tabName && !isLeftPanelCollapsed)
        {
            // If clicking the active tab, toggle collapse
            isLeftPanelCollapsed = true;
        }
        else
        {
            // Switch tab and open
            activeToolboxTab = tabName;
            isLeftPanelCollapsed = false;
        }
    }

    private string GetSidebarTitle()
    {
        return activeToolboxTab switch
        {
            "pages" => "Explorer",
            "outline" => "Structure",
            "elements" => "Components",
            "cms" => "Data Collections",
            "assets" => "Media Assets",
            "templates" => "Templates",
            "migration" => "Sync & Migration",
            _ => activeToolboxTab.ToUpper()
        };
    }

    private async Task HandlePageSelected(StudioPage page)
    {
        if (page != null && page.Id != PageId)
        {
            // Update the URL in the browser's address bar without forcing a reload
            NavigationManager.NavigateTo($"/studio/{page.Id}");

            // Now, reload the component's state with the new page's data
            await LoadPageAsync(page.Id);
        }
    }

    private void MarkAsDirty()
    {
        saveStatus = SaveStatus.Saving;
        saveStatusText = "Saving...";
        if (currentUserName != null)
        {
            AutoSaveService.MarkAsDirty(PageId, sections, currentUserName);
        }
    }

    private void AddKeyframe()
    {
        // currentAnimationKeyframes.Add(new AnimationKeyframe { Delay = currentAnimationKeyframes.LastOrDefault()?.Delay + currentAnimationKeyframes.LastOrDefault()?.Duration ?? 0 });
        MarkAsDirty();
    }

    private string _newPageErrorMessage = null;

    private async Task CreateNewPage(StudioPage pageStub)
    {
        _newPageErrorMessage = null;
        try
        {
            var created = await PageService.CreatePageAsync(pageStub.Title);
            allPages.Add(created);
            showNewPageModal = false;
            await HandlePageSelected(created);
        }
        catch (Exception ex)
        {
            _newPageErrorMessage = ex.Message;
        }
    }

    private async Task LoadDraft(StudioDraft selectedDraft)
    {
        draft = selectedDraft;
        if (!string.IsNullOrEmpty(draft.ContentJson))
        {
            sections = JsonSerializer.Deserialize<List<StudioSection>>(draft.ContentJson);
        }
        showHistory = false;
        StateHasChanged();
    }

    private void HandleComponentDragStart(StudioComponentDefinition component)
    {
        draggedComponent = component;
        draggedTemplate = null;
    }

    private void HandleDragStart(StudioTemplate template)
    {
        draggedTemplate = template;
        draggedComponent = null;
    }

    private async Task HandleDrop()
    {
        // This is now handled by the JS interop
    }

    [JSInvokable]
    public async Task HandleComponentDrop()
    {
        if (draggedComponent != null)
        {
            var newSection = JsonSerializer.Deserialize<StudioSection>(draggedTemplate.ContentJson);
            newSection.ClientId = Guid.NewGuid();
            newSection.StudioPageId = PageId;
            newSection.PageIndex = sections.Count;

            await JSRuntime.InvokeVoidAsync("studioInterop.sendComponentToPreview", _previewIframe, newSection);

            sections.Add(newSection); // Optimistically add to local state
            draggedTemplate = null;
            MarkAsDirty();
        }
    }


    private void OpenSaveAsTemplateModal(StudioSection section)
    {
        sectionToSave = section;
        newTemplateName = section.Title ?? section.ComponentType;
        newTemplateCategory = "General";
        showSaveAsTemplateModal = true;
    }

    private void CloseSaveAsTemplateModal()
    {
        showSaveAsTemplateModal = false;
        sectionToSave = null;
        newTemplateName = "";
        newTemplateCategory = "";
    }

    private async Task SaveTemplate()
    {
        if (sectionToSave != null && !string.IsNullOrWhiteSpace(newTemplateName) && !string.IsNullOrWhiteSpace(newTemplateCategory))
        {
            var newTemplate = new StudioTemplate
            {
                Name = newTemplateName,
                Category = newTemplateCategory,
                ContentJson = JsonSerializer.Serialize(sectionToSave)
            };
            await TemplateService.CreateTemplateAsync(newTemplate);
            await LoadTemplates();
            CloseSaveAsTemplateModal();
        }
    }
    private string currentViewport = "desktop";
    private string errorMessage;
    private string errorDetails;

    private async Task LoadTemplates()
    {
        templates = await TemplateService.GetAllTemplatesAsync();
        templateCategories = templates.Select(t => t.Category).Distinct().OrderBy(c => c).ToList();
        FilterTemplates(new ChangeEventArgs { Value = "" });
    }

    private void FilterTemplates(ChangeEventArgs e)
    {
        selectedTemplateCategory = e.Value?.ToString() ?? "";
        if (string.IsNullOrEmpty(selectedTemplateCategory))
        {
            filteredTemplates = templates;
        }
        else
        {
            filteredTemplates = templates.Where(t => t.Category == selectedTemplateCategory).ToList();
        }
    }

    private async Task DeleteTemplate(int id)
    {
        await TemplateService.DeleteTemplateAsync(id);
        await LoadTemplates();
    }

    private void setViewport(string viewport)
    {
        currentViewport = viewport;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && string.IsNullOrEmpty(errorMessage))
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            currentUserName = authState.User.Identity?.Name ?? "System";

            try 
            {
                allPages = await PageService.GetAllPagesAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to load pages list");
            }

            if (PageId == 0)
            {
                var dotNetHelper = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("studioInterop.setDotNetHelper", dotNetHelper);
                await JSRuntime.InvokeVoidAsync("studioInterop.initializeMessageHandler");
            }

            var lockResult = await StudioService.AcquireLockAsync(PageId, "System"); // TODO: Use real user
            if (!lockResult)
            {
                var currentLock = await StudioService.GetLockAsync(PageId);
                isLocked = true;
                lockedBy = currentLock?.LockedBy ?? "another user";

                var userState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = userState.User;
                canForceUnlock = (await AuthorizationService.AuthorizeAsync(user, AppPolicies.CanForceUnlock)).Succeeded;

                return;
            }

            draft = await StudioService.GetLatestDraftAsync(PageId);
            latestVersion = await AutoSaveService.GetLatestVersionAsync(PageId);

            if (draft != null && !string.IsNullOrEmpty(draft.ContentJson))
            {
                // Sections will be loaded here
            }
        }
        else if (firstRender && !string.IsNullOrEmpty(errorMessage))
        {
             // Log error case
        }

        if (selectedSection != null)
        {
            await JSRuntime.InvokeVoidAsync("animationInterop.initializeTimeline", DotNetObjectReference.Create(this));
            await JSRuntime.InvokeVoidAsync("animationScrubbing.initializeScrubbing", _previewIframe);
        }
    }

    private async Task LoadPageAsync(int pageId)
    {
        errorMessage = null;
        errorDetails = null;
        sections = new();
        draft = null;
        currentPage = null;

        try
        {
            currentPage = await PageService.GetPageAsync(pageId);
            if (currentPage == null)
            {
                errorMessage = "The requested page could not be found.";
                return;
            }

            PageId = pageId; // Update the component's parameter
            _pageSlug = currentPage.Slug;
            var previewUrlBase = Configuration["NEXTJS_PREVIEW_URL"];
            _previewUrl = $"{previewUrlBase}/studio-preview/{_pageSlug}";

            draft = await StudioService.GetLatestDraftAsync(PageId);
            sections = !string.IsNullOrEmpty(draft?.ContentSnapshotJson)
                ? JsonSerializer.Deserialize<List<StudioSection>>(draft.ContentSnapshotJson)
                : new List<StudioSection>();

            await LoadHistory();
            await LoadTemplates(); // Consider if this needs to be reloaded every time
            
            // Send sections to the preview iframe
            await SendSectionsToPreview();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load page data for page {PageId}", pageId);
            errorMessage = "An unexpected error occurred while loading the page.";
            errorDetails = ex.Message;
        }

        StateHasChanged(); // Ensure the UI updates
    }

    private async Task SendSectionsToPreview()
    {
        try
        {
            if (_previewIframe.Id != null && sections != null)
            {
                var sectionsJson = JsonSerializer.Serialize(sections);
                await JSRuntime.InvokeVoidAsync("sendSectionsToPreview", _previewIframe, sectionsJson);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to send sections to preview");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allPages = await PageService.GetAllPagesAsync();

            var effectivePageId = PageId;
            if (effectivePageId == 0)
            {
                var firstPage = allPages.FirstOrDefault();
                if (firstPage != null)
                {
                    effectivePageId = firstPage.Id;
                    // Update URL without forcing a reload, just to be clean
                    NavigationManager.NavigateTo($"/studio/{effectivePageId}", replace: true);
                }
                else
                {
                    errorMessage = "No pages found. Create a new page to begin.";
                    return;
                }
            }

            await LoadPageAsync(effectivePageId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize Studio");
            errorMessage = $"Studio initialization failed: {ex.Message}";
            errorDetails = ex.StackTrace;
        }
    }

    [JSInvokable]
    public async Task UpdateAnimationTimeline(double delay, double duration)
    {
        currentAnimationSettings.Delay = Math.Round(delay, 2);
        currentAnimationSettings.Duration = Math.Round(duration, 2);
        await UpdateAnimationSettings();
        StateHasChanged();
    }

    private async Task LoadHistory()
    {
        draftHistory = (await StudioService.GetDraftHistoryAsync(PageId)).ToList();
    }

    private async Task SaveDraft(bool fromModal = false)
    {
        if (!fromModal)
        {
            showSaveVersionModal = true;
            return;
        }

        showSaveVersionModal = false;

        try
        {
            saveStatus = SaveStatus.Saving;
            saveStatusText = "Saving manual version...";
            StateHasChanged();

            if (selectedSection != null)
            {
               // Update animation settings logic if needed
            }
            
            var json = JsonSerializer.Serialize(sections);
            draft = await StudioService.SaveDraftAsync(PageId, json, "System", versionDescription); // TODO: Use real user
            versionDescription = string.Empty; // Reset for next time
            
            await LoadHistory();
            latestVersion = await AutoSaveService.GetLatestVersionAsync(PageId);

            saveStatus = SaveStatus.Saved;
            saveStatusText = "Manual version saved.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save draft");
            errorMessage = "Failed to save draft: " + ex.Message;
        }
    }

    private void OpenPublishWizard()
    {
        showPublishingWizard = true;
    }

    private async Task HandlePublish(string notes)
    {
        showPublishModal = true;
    }

    private async Task ConfirmPublish()
    {
        showPublishModal = false;

        try
        {
            if (draft == null || draft.Id == 0)
            {
                await SaveDraft(true);
            }
            
            if (draft != null)
            {
                await StudioService.PublishDraftAsync(draft.Id);
                // After publishing, we might want to refresh the page or show success
                saveStatus = SaveStatus.Saved;
                saveStatusText = "Published successfully!";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to publish page");
            errorMessage = "Failed to publish page: " + ex.Message;
        }
    }

    private void AddSection()
    {
        // This is now deprecated in favor of dragging components.
        // var newSection = new StudioSection
        // {
        //     ClientId = Guid.NewGuid(),
        //     PageIndex = sections.Count,
        //     StudioPageId = PageId,
        //     ComponentType = "TextBlock", // Default component
        //     PropertiesJson = "{ \"text\": \"New Section\" }"
        // };
        // sections.Add(newSection);
    }

    private RenderFragment RenderPropertyEditor(StudioSection section) => builder =>
    {
        if (section.ComponentType == "HeroSection")
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "property-group");

            builder.OpenElement(2, "label");
            builder.AddAttribute(3, "for", "hero-headline");
            builder.AddContent(4, "Headline");
            builder.CloseElement();

            builder.OpenElement(5, "input");
            builder.AddAttribute(6, "type", "text");
            builder.AddAttribute(7, "id", "hero-headline");
            builder.AddAttribute(8, "class", "form-control");
            builder.AddAttribute(9, "value", heroSectionProperties.GetValueOrDefault("Headline"));
            builder.AddAttribute(10, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, async e => await UpdateHeroProperty("Headline", (string)e.Value)));
            builder.CloseElement();

            builder.CloseElement();
        }
    };

    private async Task UpdateHeroProperty(string key, string value)
    {
        heroSectionProperties[key] = value;
        selectedSection.PropertiesJson = JsonSerializer.Serialize(heroSectionProperties);
        await SaveDraft();
        await JSRuntime.InvokeVoidAsync("studioInterop.refreshPreview");
    }

    [JSInvokable]
    public void SelectComponent(string componentId)
    {
        var section = sections.FirstOrDefault(s => s.ClientId.ToString() == componentId);
        if (section != null)
        {
            selectedSection = section;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void UpdateSectionOrder(string[] clientIds)
    {
        var newSections = new List<StudioSection>();
        foreach (var id in clientIds)
        {
            var section = sections.First(s => s.ClientId == Guid.Parse(id));
            section.PageIndex = newSections.Count;
            newSections.Add(section);
        }
        sections = newSections;
        MarkAsDirty();
        StateHasChanged();
    }

    private void CloseImportModal()
    {
        showUrlImportModal = false;
        importErrorMessage = "";
        urlToImport = "";
    }

    private async Task ImportFromUrl()
    {
        if (string.IsNullOrWhiteSpace(urlToImport))
        {
            importErrorMessage = "Please enter a URL to import.";
            return;
        }

        isImporting = true;
        importErrorMessage = "";
        StateHasChanged();

        try
        {
            var scrapedSections = await ContentIngestionService.ScrapeUrlAsync(urlToImport);
            if (scrapedSections.Any())
            {
                // 1. Create a new page
                var pageTitle = scrapedSections.FirstOrDefault(s => s.ComponentType == StudioComponentType.Heading)?.Title ?? "Imported Page";
                var newPage = await PageService.CreatePageAsync(pageTitle);

                // 2. Create the redirect
                await ContentIngestionService.CreateRedirectAsync(urlToImport, newPage.Slug);

                // 3. Associate sections with the new page and save
                int index = 0;
                foreach (var section in scrapedSections)
                {
                    section.StudioPageId = newPage.Id;
                    section.PageIndex = index++;
                }

                var json = JsonSerializer.Serialize(scrapedSections);
                await StudioService.SaveDraftAsync(newPage.Id, json, currentUserName, "Initial import from URL");

                // 4. Navigate to the new page
                CloseImportModal();
                NavigationManager.NavigateTo($"/studio/{newPage.Id}");
            }
            else
            {
                importErrorMessage = "No content (headings, paragraphs, or images) could be found at the specified URL.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to import from URL {Url}", urlToImport);
            importErrorMessage = $"Failed to import content. Error: {ex.Message}";
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    private async Task ExportSite()
    {
        isExporting = true;
        exportErrorMessage = "";
        StateHasChanged();

        try
        {
            var zipBytes = await StaticExportService.ExportSiteAsZipAsync();
            var fileName = $"GFC-Studio-Export-{DateTime.Now:yyyyMMddHHmmss}.zip";

            // Trigger download using JavaScript interop
            var fileStream = new MemoryStream(zipBytes);
            using var streamRef = new DotNetStreamReference(stream: fileStream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to export site");
            exportErrorMessage = $"Failed to export site. Error: {ex.Message}";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }
}
