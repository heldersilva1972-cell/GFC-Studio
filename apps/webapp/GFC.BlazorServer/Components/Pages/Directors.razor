@page "/directors"
@page "/board"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using System.Linq
@using System.Security.Cryptography
@using GFC.Core.BusinessRules
@using GFC.Core.Interfaces
@using GFC.Core.Models
@using GFC.Core.Services
@inject IBoardRepository BoardRepository
@inject IMemberRepository MemberRepository
@inject IHistoryRepository HistoryRepository
@inject IBoardTermConfirmationService BoardTermConfirmationService
@inject IUserManagementService UserManagementService
@inject IUserRepository UserRepository
@inject IAuditLogger AuditLogger
@inject GFC.BlazorServer.Services.CustomAuthenticationStateProvider AuthStateProvider
@inject ILogger<Directors> Logger
@inject IPasswordPolicy PasswordPolicy

<PageTitle>Board Management - GFC</PageTitle>

<div class="page-header mb-4">
    <div>
        <h1 class="page-title mb-2">Board Management</h1>
        <p class="text-muted mb-0">Manage officer and director assignments for each term year</p>
    </div>
    <div class="page-header-actions">
        <div class="year-selector-group">
            <label class="form-label mb-1">Term Year</label>
            <div class="d-flex gap-2">
                <select class="form-select" value="@_selectedTermYear" @onchange="OnTermYearChanged" disabled="@_loading">
                    @foreach (var year in _termYears)
                    {
                        <option value="@year">@year</option>
                    }
                </select>
                @if (_selectedTermYear != _currentYear)
                {
                    <button class="btn btn-outline-primary" type="button" @onclick="UseCurrentYear">
                        <i class="bi bi-calendar-check me-1"></i>
                        Current
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@if (_loading)
{
    <div class="loading-state-modern">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted">Loading board data...</p>
    </div>
}
else if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
    </div>
}
else
{
    <!-- Summary Metrics -->
    <div class="board-metrics-grid mb-4">
        <div class="metric-card metric-card-primary">
            <div class="metric-icon">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Total Positions</div>
                <div class="metric-value">@_seats.Count</div>
            </div>
        </div>

        <div class="metric-card metric-card-success">
            <div class="metric-icon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Filled</div>
                <div class="metric-value">@_seats.Count(s => s.AssignmentId.HasValue)</div>
            </div>
        </div>

        <div class="metric-card metric-card-warning">
            <div class="metric-icon">
                <i class="bi bi-exclamation-circle-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Vacant</div>
                <div class="metric-value">@_seats.Count(s => !s.AssignmentId.HasValue)</div>
            </div>
        </div>

        <div class="metric-card metric-card-info">
            <div class="metric-icon">
                <i class="bi bi-person-check-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Eligible Members</div>
                <div class="metric-value">@_memberOptions.Count</div>
            </div>
        </div>
    </div>

    <!-- Confirmation Status -->
    @if (_termConfirmation is null)
    {
        <div class="alert alert-warning d-flex align-items-center justify-content-between mb-4">
            <div>
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Board Not Confirmed</strong>
                <p class="mb-0 mt-1 small">The @_selectedTermYear board has not been confirmed yet. Confirm once positions are finalized.</p>
            </div>
            <button class="btn btn-warning" type="button" @onclick="OpenConfirmationModal">
                <i class="bi bi-check-circle me-1"></i>Confirm Board
            </button>
        </div>
    }
    else
    {
        <div class="alert alert-success d-flex align-items-center justify-content-between mb-4">
            <div>
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>Board Confirmed</strong>
                <p class="mb-0 mt-1 small">
                    Confirmed on @_termConfirmation.ConfirmedOnUtc.ToLocalTime().ToString("MMM d, yyyy") by @_termConfirmation.ConfirmedBy
                    @if (!string.IsNullOrWhiteSpace(_termConfirmation.Notes))
                    {
                        <span class="d-block mt-1">Notes: @_termConfirmation.Notes</span>
                    }
                </p>
            </div>
            <button class="btn btn-outline-success btn-sm" type="button" @onclick="OpenConfirmationModal">
                <i class="bi bi-pencil me-1"></i>Update
            </button>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(_statusMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@_statusMessage
            <button type="button" class="btn-close" aria-label="Close" @onclick="() => _statusMessage = null"></button>
        </div>
    }

    @if (_memberOptions.Count == 0)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No eligible members found. Only active Regular or Life members can be assigned to the board.
        </div>
    }

    <!-- Board Positions Grid -->
    @if (_loadingAssignments)
    {
        <div class="loading-state-modern">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Refreshing assignments...</p>
        </div>
    }
    else
    {
        <div class="positions-grid">
            @foreach (var seat in _seats)
            {
                <div class="position-card @(seat.AssignmentId.HasValue ? "position-filled" : "position-vacant")">
                    <div class="position-header">
                        <div class="position-title-group">
                            <h3 class="position-title">@seat.PositionLabel</h3>
                            <span class="position-badge @(seat.AssignmentId.HasValue ? "badge-filled" : "badge-vacant")">
                                @(seat.AssignmentId.HasValue ? "Filled" : "Vacant")
                            </span>
                        </div>
                        @if (seat.AssignmentId.HasValue && seat.OriginalMemberId.HasValue)
                        {
                            <div class="current-assignment">
                                <i class="bi bi-person-fill me-1"></i>
                                <span>@FormatMemberDisplay(seat.OriginalMemberId.Value)</span>
                            </div>
                        }
                    </div>

                    <div class="position-body">
                        <label class="form-label">Assign Member</label>
                        <select class="form-select modern-select"
                                value="@FormatSelectValue(seat.SelectedMemberId)"
                                disabled="@(_savingTerm || seat.IsSaving || _memberOptions.Count == 0)"
                                @onchange="args => OnSelectionChanged(seat, args)">
                            <option value="">— Select a member —</option>
                            @foreach (var option in _memberOptions)
                            {
                                var isSelected = seat.SelectedMemberId == option.MemberId;
                                var alreadySelected = _seats.Any(other => !ReferenceEquals(other, seat) && other.SelectedMemberId == option.MemberId);
                                if (alreadySelected && !isSelected)
                                {
                                    continue;
                                }
                                <option value="@option.MemberId">@option.DisplayLabel</option>
                            }
                        </select>

                        @if (!string.IsNullOrWhiteSpace(seat.Error))
                        {
                            <div class="error-message">
                                <i class="bi bi-exclamation-circle me-1"></i>@seat.Error
                            </div>
                        }
                    </div>

                    <div class="position-footer">
                        <button class="btn btn-primary"
                                disabled="@(!seat.CanSave || _savingTerm)"
                                @onclick="() => SaveSeatAsync(seat)">
                            @if (seat.IsSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            else
                            {
                                <i class="bi bi-check-lg me-1"></i>
                            }
                            Save Assignment
                        </button>

                        @if (seat.AssignmentId is not null)
                        {
                            <button class="btn btn-outline-danger"
                                    type="button"
                                    disabled="@(seat.IsSaving || _savingTerm)"
                                    @onclick="() => ClearSeatAsync(seat)">
                                <i class="bi bi-x-lg me-1"></i>
                                Remove
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
}

<!-- Confirmation Modal -->
@if (_confirmationModalOpen)
{
    <div class="modal-backdrop-modern show"></div>
    <div class="modal-modern show">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <div>
                    <h4 class="modal-title-modern">Confirm @_selectedTermYear Board</h4>
                    <p class="modal-subtitle">Mark this board lineup as complete and finalized</p>
                </div>
                <button class="btn-close-modern" type="button" @onclick="CancelConfirmationModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="modal-body-modern">
                <p class="text-muted mb-3">
                    Confirming the board will acknowledge that all positions are either filled or intentionally left vacant. 
                    This will clear dashboard alerts for this term.
                </p>

                <div class="mb-3">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-control" rows="3" @bind="_confirmationNotes" 
                              placeholder="Add any notes about this board term..."></textarea>
                </div>
            </div>

            <div class="modal-footer-modern">
                <button class="btn btn-outline-secondary" type="button" @onclick="CancelConfirmationModal">
                    Cancel
                </button>
                <button class="btn btn-success" disabled="@_confirmationSaving" @onclick="ConfirmBoardAsync">
                    @if (_confirmationSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    else
                    {
                        <i class="bi bi-check-circle me-1"></i>
                    }
                    Confirm Board
                </button>
            </div>
        </div>
    </div>
}

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .page-header-actions {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }

    .year-selector-group {
        min-width: 200px;
    }

    .loading-state-modern {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
    }

    /* Metrics Grid */
    .board-metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
    }

    .metric-card {
        background: var(--bg-surface);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--glass-border);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        color: var(--text-primary);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--metric-color-start), var(--metric-color-end));
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
    }

    .metric-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        background: linear-gradient(135deg, var(--metric-color-start), var(--metric-color-end));
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .metric-content {
        flex: 1;
    }

    .metric-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .metric-card-primary {
        --metric-color-start: #6366f1;
        --metric-color-end: #4f46e5;
    }

    .metric-card-success {
        --metric-color-start: #10b981;
        --metric-color-end: #059669;
    }

    .metric-card-warning {
        --metric-color-start: #f59e0b;
        --metric-color-end: #d97706;
    }

    .metric-card-info {
        --metric-color-start: #3b82f6;
        --metric-color-end: #2563eb;
    }

    /* Positions Grid */
    .positions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 1.5rem;
    }

    .position-card {
        background: var(--bg-surface);
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border: 2px solid var(--glass-border);
        overflow: hidden;
        transition: all 0.3s ease;
        color: var(--text-primary);
    }

    .position-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
        border-color: var(--accent-primary);
    }

    .position-filled {
        border-color: rgba(16, 185, 129, 0.5);
    }

    .position-vacant {
        border-color: rgba(245, 158, 11, 0.5);
    }

    .position-header {
        padding: 1.5rem;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--glass-border);
    }

    .position-title-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }

    .position-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .position-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-filled {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-vacant {
        background: #fef3c7;
        color: #92400e;
    }

    .current-assignment {
        display: flex;
        align-items: center;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .position-body {
        padding: 1.5rem;
    }

    .modern-select {
        border-radius: 8px;
        border: 2px solid var(--glass-border);
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: 0.625rem 1rem;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
    }

    .modern-select:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .error-message {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: #fee2e2;
        border-left: 3px solid #ef4444;
        border-radius: 6px;
        color: #991b1b;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .position-footer {
        padding: 1.5rem;
        background: var(--bg-primary);
        border-top: 1px solid var(--glass-border);
        display: flex;
        gap: 0.75rem;
    }

    .position-footer .btn {
        flex: 1;
        border-radius: 8px;
        font-weight: 600;
        padding: 0.625rem 1rem;
    }

    /* Modern Modal */
    .modal-backdrop-modern {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 1040;
        animation: fadeIn 0.2s ease;
    }

    .modal-modern {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        padding: 1rem;
        animation: fadeIn 0.3s ease;
    }

    .modal-content-modern {
        background: var(--bg-secondary);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid var(--glass-border);
        max-width: 540px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
        color: var(--text-primary);
    }

    .modal-header-modern {
        padding: 2rem;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .modal-title-modern {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .modal-subtitle {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin: 0.5rem 0 0 0;
    }

    .btn-close-modern {
        background: none;
        border: none;
        font-size: 1.25rem;
        color: #6b7280;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .btn-close-modern:hover {
        background: var(--bg-surface-hover);
        color: var(--text-primary);
    }

    .modal-body-modern {
        padding: 2rem;
    }

    .modal-footer-modern {
        padding: 1.5rem 2rem;
        background: var(--bg-primary);
        border-top: 1px solid var(--glass-border);
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
        }

        .positions-grid {
            grid-template-columns: 1fr;
        }

        .board-metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 480px) {
        .board-metrics-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private readonly int _currentYear = DateTime.Today.Year;
    private static readonly string[] PositionOrder =
    {
        "President",
        "Vice President",
        "Treasurer",
        "Collector of Dues",
        "Recording Secretary",
        "Director"
    };

    private bool _loading = true;
    private bool _loadingAssignments;
    private bool _savingTerm;
    private string? _errorMessage;
    private string? _statusMessage;

    private int _selectedTermYear;
    private List<int> _termYears = new();
    private List<MemberOption> _memberOptions = new();
    private Dictionary<int, MemberOption> _memberLookup = new();
    private List<BoardSeatModel> _seats = new();
    private BoardTermConfirmation? _termConfirmation;
    private bool _confirmationModalOpen;
    private string? _confirmationNotes;
    private bool _confirmationSaving;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadEligibleMembersAsync();
            await LoadTermYearsAsync();
            await LoadAssignmentsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize board page");
            _errorMessage = "We couldn't load the board at this time.";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadEligibleMembersAsync()
    {
        var members = await Task.Run(() => MemberRepository.GetAllMembers());
        var eligible = members
            .Where(IsEligibleForBoard)
            .OrderBy(m => m.LastName)
            .ThenBy(m => m.FirstName)
            .Select(m => new MemberOption(
                m.MemberID,
                FormatMemberName(m),
                MemberStatusHelper.NormalizeStatus(m.Status)))
            .ToList();

        _memberOptions = eligible;
        _memberLookup = eligible.ToDictionary(m => m.MemberId);
    }

    private async Task LoadTermYearsAsync()
    {
        var years = await Task.Run(() => BoardRepository.GetAllTermYears());
        if (!years.Contains(_currentYear))
        {
            years.Add(_currentYear);
        }

        var nextYear = _currentYear + 1;
        if (!years.Contains(nextYear))
        {
            years.Add(nextYear);
        }

        if (years.Count == 0)
        {
            years.Add(_currentYear);
        }

        _termYears = years.Distinct().OrderByDescending(y => y).ToList();
        _selectedTermYear = _termYears.Contains(_currentYear) ? _currentYear : _termYears.First();
    }

    private async Task LoadAssignmentsAsync()
    {
        _loadingAssignments = true;
        StateHasChanged();

        try
        {
            var positions = await Task.Run(() => BoardRepository.GetAllPositions());
            var assignments = await Task.Run(() => BoardRepository.GetAssignmentsByYear(_selectedTermYear));
            _seats = BuildSeatModels(positions, assignments);
            await LoadTermConfirmationAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load assignments for term {Term}", _selectedTermYear);
            _errorMessage = "We couldn't load assignments for this term.";
        }
        finally
        {
            _loadingAssignments = false;
            StateHasChanged();
        }
    }

    private List<BoardSeatModel> BuildSeatModels(IEnumerable<BoardPosition> positions, List<BoardAssignment> assignments)
    {
        var orderedPositions = positions
            .OrderBy(p => Array.IndexOf(PositionOrder, p.PositionName) switch
            {
                -1 => int.MaxValue,
                var index => index
            })
            .ThenBy(p => p.PositionName)
            .ToList();

        var seats = new List<BoardSeatModel>();

        foreach (var position in orderedPositions)
        {
            var seatCount = Math.Max(1, position.MaxSeats);
            var positionAssignments = assignments
                .Where(a => a.PositionID == position.PositionID)
                .OrderBy(a => a.AssignmentID)
                .ToList();

            for (var seatIndex = 0; seatIndex < seatCount; seatIndex++)
            {
                var assignment = positionAssignments.ElementAtOrDefault(seatIndex);
                seats.Add(new BoardSeatModel
                {
                    PositionId = position.PositionID,
                    BasePositionName = position.PositionName,
                    PositionLabel = seatCount > 1 ? $"{position.PositionName} #{seatIndex + 1}" : position.PositionName,
                    AssignmentId = assignment?.AssignmentID,
                    Assignment = assignment,
                    OriginalMemberId = assignment?.MemberID,
                    SelectedMemberId = assignment?.MemberID,
                    CurrentSummary = assignment?.MemberID is int memberId
                        ? $"Currently: {FormatMemberDisplay(memberId)}"
                        : "Currently: Unassigned"
                });
            }
        }

        return seats;
    }

    private async Task SaveSeatAsync(BoardSeatModel seat)
    {
        if (!seat.CanSave)
        {
            return;
        }

        seat.Error = null;
        seat.IsSaving = true;
        _statusMessage = null;
        StateHasChanged();

        try
        {
            var currentUser = AuthStateProvider.GetCurrentUser();
            var performedByUserId = currentUser?.UserId;
            var performedByUserName = currentUser?.Username ?? "Unknown";

            await Task.Run(() => PersistSeatChange(seat, performedByUserName, performedByUserId));
            await LoadAssignmentsAsync();
            _statusMessage = $"{seat.PositionLabel} updated for {_selectedTermYear}.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save assignment for {Position}", seat.PositionLabel);
            seat.Error = "Unable to save this assignment.";
        }
        finally
        {
            seat.IsSaving = false;
            StateHasChanged();
        }
    }

    private async Task ClearSeatAsync(BoardSeatModel seat)
    {
        seat.SelectedMemberId = null;
        await SaveSeatAsync(seat);
    }

    private void PersistSeatChange(BoardSeatModel seat, string performedByUserName, int? performedByUserId)
    {
        var desiredMemberId = seat.SelectedMemberId;
        var originalMemberId = seat.OriginalMemberId;

        if (desiredMemberId == originalMemberId)
        {
            return;
        }

        if (!desiredMemberId.HasValue)
        {
            if (seat.AssignmentId.HasValue)
            {
                BoardRepository.RemoveAssignment(seat.AssignmentId.Value);
                if (originalMemberId.HasValue)
                {
                    LogBoardHistory(originalMemberId.Value, seat.BasePositionName, $"{seat.BasePositionName} ({_selectedTermYear})", "Removed");
                    AuditLogger.Log(
                        AuditLogActions.DirectorRoleChanged,
                        performedByUserId,
                        originalMemberId.Value,
                        BuildDirectorAuditDetails(seat.BasePositionName, _selectedTermYear, "Removed", performedByUserName));
                }
            }

            return;
        }

        if (!_memberLookup.ContainsKey(desiredMemberId.Value))
        {
            throw new InvalidOperationException("Selected member is not eligible for board service.");
        }

        if (seat.AssignmentId is null)
        {
            EnsureMemberNotAlreadyAssigned(desiredMemberId.Value, seat.AssignmentId);
            var assignment = new BoardAssignment
            {
                MemberID = desiredMemberId.Value,
                PositionID = seat.PositionId,
                TermYear = _selectedTermYear,
                StartDate = GetDefaultTermStart(_selectedTermYear)
            };

            BoardRepository.InsertAssignment(assignment);
            LogBoardHistory(desiredMemberId.Value, seat.BasePositionName, "Unassigned", $"{seat.BasePositionName} ({_selectedTermYear})");
            AuditLogger.Log(
                AuditLogActions.DirectorRoleChanged,
                performedByUserId,
                desiredMemberId.Value,
                BuildDirectorAuditDetails(seat.BasePositionName, _selectedTermYear, "Added", performedByUserName));
            
            CreateDirectorUserIfNeeded(desiredMemberId.Value);
            
            return;
        }

        if (originalMemberId.HasValue && originalMemberId.Value == desiredMemberId.Value)
        {
            return;
        }

        EnsureMemberNotAlreadyAssigned(desiredMemberId.Value, seat.AssignmentId);

        var updatedAssignment = new BoardAssignment
        {
            AssignmentID = seat.AssignmentId.Value,
            MemberID = desiredMemberId.Value,
            PositionID = seat.PositionId,
            TermYear = _selectedTermYear,
            StartDate = seat.Assignment?.StartDate ?? GetDefaultTermStart(_selectedTermYear),
            EndDate = seat.Assignment?.EndDate,
            Notes = seat.Assignment?.Notes
        };

        BoardRepository.UpdateAssignment(updatedAssignment);

        if (originalMemberId.HasValue)
        {
            LogBoardHistory(originalMemberId.Value, seat.BasePositionName, $"{seat.BasePositionName} ({_selectedTermYear})", "Removed");
            AuditLogger.Log(
                AuditLogActions.DirectorRoleChanged,
                performedByUserId,
                originalMemberId.Value,
                BuildDirectorAuditDetails(seat.BasePositionName, _selectedTermYear, "Removed", performedByUserName));
        }

        LogBoardHistory(desiredMemberId.Value, seat.BasePositionName, "Unassigned", $"{seat.BasePositionName} ({_selectedTermYear})");
        AuditLogger.Log(
            AuditLogActions.DirectorRoleChanged,
            performedByUserId,
            desiredMemberId.Value,
            BuildDirectorAuditDetails(seat.BasePositionName, _selectedTermYear, "Added", performedByUserName, originalMemberId));
        
        CreateDirectorUserIfNeeded(desiredMemberId.Value);
    }

    private void CreateDirectorUserIfNeeded(int memberId)
    {
        try
        {
            var existingUser = UserRepository.GetByMemberId(memberId);
            
            if (existingUser != null)
            {
                return;
            }

            var username = UserManagementService.GenerateUsernameFromMember(memberId);
            var currentUser = AuthStateProvider.GetCurrentUser();
            var createdBy = currentUser?.Username ?? "System";
            var tempPassword = BuildDefaultDirectorPassword(memberId, username);
            
            UserManagementService.CreateUser(
                username: username,
                password: tempPassword,
                isAdmin: false,
                memberId: memberId,
                notes: "Auto-created when assigned as director",
                createdBy: createdBy,
                passwordChangeRequired: true,
                createdByUserId: currentUser?.UserId
            );
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to create user account for director member {MemberId}", memberId);
        }
    }

    private static string BuildDirectorAuditDetails(string position, int termYear, string change, string performedBy, int? previousMemberId = null)
    {
        var details = $"{position} ({termYear}) {change} by {performedBy}";
        if (previousMemberId.HasValue)
        {
            details += $"; previousMemberId={previousMemberId.Value}";
        }
        return details;
    }

    private string BuildDefaultDirectorPassword(int memberId, string username)
    {
        var candidate = $"Gfc{memberId}#{DateTime.UtcNow.Year}!";
        if (PasswordPolicy.Validate(username, candidate).IsValid)
        {
            return candidate;
        }

        const string fallback = "GfcDirectors!2025";
        var fallbackResult = PasswordPolicy.Validate(username, fallback);
        if (!fallbackResult.IsValid)
        {
            throw new InvalidOperationException(fallbackResult.ErrorMessage ?? PasswordPolicy.RequirementSummary);
        }
        return fallback;
    }

    private void LogBoardHistory(int memberId, string positionName, string? oldValue, string? newValue)
    {
        try
        {
            var currentUser = AuthStateProvider.GetCurrentUser();
            var username = currentUser?.Username ?? "Unknown";
            HistoryRepository.LogMemberChange(memberId, $"Board:{positionName}", oldValue, newValue, username);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to log history for member {Member}", memberId);
        }
    }

    private void EnsureMemberNotAlreadyAssigned(int memberId, int? currentAssignmentId)
    {
        var assignments = BoardRepository.GetAssignmentsByYear(_selectedTermYear);
        var alreadyAssigned = assignments.Any(a =>
            a.MemberID == memberId &&
            (!currentAssignmentId.HasValue || a.AssignmentID != currentAssignmentId.Value));

        if (alreadyAssigned)
        {
            throw new InvalidOperationException("This member already holds another board position for the selected term.");
        }
    }

    private void OnSelectionChanged(BoardSeatModel seat, ChangeEventArgs args)
    {
        seat.Error = null;
        var raw = args.Value?.ToString();
        if (int.TryParse(raw, out var parsed))
        {
            var alreadySelected = _seats.Any(other => !ReferenceEquals(other, seat) && other.SelectedMemberId == parsed);
            if (alreadySelected)
            {
                seat.Error = "This member is already assigned to a different position.";
                StateHasChanged();
                return;
            }

            seat.SelectedMemberId = parsed;
        }
        else
        {
            seat.SelectedMemberId = null;
        }
    }

    private async Task OnTermYearChanged(ChangeEventArgs args)
    {
        if (!int.TryParse(args.Value?.ToString(), out var year))
        {
            return;
        }

        if (year == _selectedTermYear)
        {
            return;
        }

        _selectedTermYear = year;
        _savingTerm = true;
        await LoadAssignmentsAsync();
        _savingTerm = false;
    }

    private async Task UseCurrentYear()
    {
        if (_selectedTermYear == _currentYear)
        {
            return;
        }

        if (!_termYears.Contains(_currentYear))
        {
            _termYears.Insert(0, _currentYear);
        }

        _selectedTermYear = _currentYear;
        _savingTerm = true;
        await LoadAssignmentsAsync();
        _savingTerm = false;
    }

    private static DateTime GetDefaultTermStart(int year) =>
        new(year, 1, 1);

    private bool IsEligibleForBoard(Member member)
    {
        var normalized = MemberStatusHelper.NormalizeStatus(member.Status);
        return normalized is "REGULAR" or "REGULAR-NP" or "LIFE";
    }

    private string FormatMemberDisplay(int memberId) =>
        _memberLookup.TryGetValue(memberId, out var option)
            ? option.DisplayLabel
            : "Unknown member";

    private static string FormatMemberName(Member member)
    {
        return string.IsNullOrWhiteSpace(member.LastName)
            ? member.FirstName
            : $"{member.LastName}, {member.FirstName}";
    }

    private static string FormatSelectValue(int? value) => value?.ToString() ?? string.Empty;

    private async Task LoadTermConfirmationAsync()
    {
        try
        {
            _termConfirmation = await Task.Run(() => BoardTermConfirmationService.GetConfirmation(_selectedTermYear));
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load board confirmation for term {Term}", _selectedTermYear);
            _termConfirmation = null;
        }
    }

    private void OpenConfirmationModal()
    {
        _confirmationModalOpen = true;
        _confirmationNotes = _termConfirmation?.Notes;
        _confirmationSaving = false;
    }

    private void CancelConfirmationModal()
    {
        _confirmationModalOpen = false;
        _confirmationNotes = null;
        _confirmationSaving = false;
    }

    private async Task ConfirmBoardAsync()
    {
        if (_confirmationSaving)
        {
            return;
        }

        _confirmationSaving = true;
        try
        {
            await Task.Run(() => BoardTermConfirmationService.Confirm(
                _selectedTermYear,
                Environment.UserName,
                _confirmationNotes));

            _termConfirmation = new BoardTermConfirmation(
                _selectedTermYear,
                DateTime.UtcNow,
                Environment.UserName,
                _confirmationNotes);

            _statusMessage = $"Board for {_selectedTermYear} confirmed.";
            _confirmationModalOpen = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to confirm board term {Term}", _selectedTermYear);
            _errorMessage = "We couldn't record the confirmation. Please try again.";
        }
        finally
        {
            _confirmationSaving = false;
        }
    }

    private sealed record MemberOption(int MemberId, string DisplayName, string NormalizedStatus)
    {
        public string DisplayLabel => $"{DisplayName} ({GetStatusLabel(NormalizedStatus)})";

        private static string GetStatusLabel(string normalizedStatus) => normalizedStatus switch
        {
            "REGULAR" => "Regular",
            "REGULAR-NP" => "Regular-NP",
            "LIFE" => "Life",
            _ => normalizedStatus
        };
    }

    private sealed class BoardSeatModel
    {
        public int PositionId { get; set; }
        public string BasePositionName { get; set; } = string.Empty;
        public string PositionLabel { get; set; } = string.Empty;
        public int? AssignmentId { get; set; }
        public BoardAssignment? Assignment { get; set; }
        public int? OriginalMemberId { get; set; }
        public int? SelectedMemberId { get; set; }
        public string CurrentSummary { get; set; } = "Currently: Unassigned";
        public bool IsSaving { get; set; }
        public string? Error { get; set; }

        public bool IsDirty => (OriginalMemberId ?? -1) != (SelectedMemberId ?? -1);
        public bool CanSave => IsDirty && !IsSaving;

        public string BadgeLabel => AssignmentId.HasValue ? "Assigned" : "Open";
        public string BadgeClass => AssignmentId.HasValue ? "badge-success" : "badge bg-secondary";
    }
}
