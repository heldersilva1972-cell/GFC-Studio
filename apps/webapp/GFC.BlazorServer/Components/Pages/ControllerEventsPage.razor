@page "/controllers/events"
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Services
@using GFC.Core.Interfaces
@using Microsoft.EntityFrameworkCore
@inject ControllerRegistryService RegistryService
@inject ControllerEventService EventService
@inject NavigationManager Navigation
@inject ILogger<ControllerEventsPage> Logger
@inject IJSRuntime JSRuntime
@inject IBlazorSystemSettingsService SettingsService
@inject IMemberRepository MemberRepository
@inject IKeyCardRepository KeyCardRepository
@inject IDbContextFactory<GfcDbContext> DbFactory

<div class="page-header">
    <div>
        <h1>Controller Events</h1>
        <p class="text-muted mb-0">Review mirrored controller events stored in SQL.</p>
    </div>
    <button class="btn btn-outline-primary" @onclick="NavigateBackToDashboard">
        <i class="bi bi-arrow-left"></i> Back to dashboard
    </button>
</div>

@if (_errorMessage != null)
{
    <div class="alert alert-danger">@_errorMessage</div>
}

<EditForm Model="@_filterModel" OnValidSubmit="HandleFilterAsync">
    <div class="data-card mb-3">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Controller</label>
                <select class="form-select" @bind="_filterModel.ControllerId" @bind:after="OnControllerChanged">
                    <option value="">All controllers</option>
                    @foreach (var controller in _controllers)
                    {
                        <option value="@controller.Id">@controller.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Door</label>
                <select class="form-select" @bind="_filterModel.DoorId" disabled="@(!_availableDoors.Any())">
                    <option value="">All doors</option>
                    @foreach (var door in _availableDoors)
                    {
                        <option value="@door.Id">@door.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Start</label>
                <InputDate class="form-control" @bind-Value="_filterModel.StartDate" />
            </div>
            <div class="col-md-2">
                <label class="form-label">End</label>
                <InputDate class="form-control" @bind-Value="_filterModel.EndDate" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Event type</label>
                <select class="form-select" @bind="_filterModel.EventCategory">
                    @foreach (var option in _eventTypeOptions)
                    {
                        <option value="@option.Key">@option.Label</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Source</label>
                <select class="form-select" @bind="_filterModel.EventSource">
                    @foreach (var option in _eventSourceOptions)
                    {
                        <option value="@option.Key">@option.Label</option>
                    }
                </select>
            </div>
        </div>
        <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary" disabled="@_isLoading">
                <i class="bi bi-search"></i> Apply Filters
            </button>
            <button type="button" class="btn btn-outline-secondary" @onclick="ResetFilters" disabled="@_isLoading">Reset</button>
        </div>
    </div>
</EditForm>

@if (_isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_events.Count == 0)
{
    <div class="data-card">
        <h4>No events found</h4>
        <p class="text-muted mb-0">
            @if (_filterModel.ControllerId.HasValue)
            {
                <text>No events match the selected filters. If this controller has no sync history, it may not have been polled yet.</text>
            }
            else
            {
                <text>No events match the selected filters.</text>
            }
        </p>
    </div>
}
else
{
    <div class="data-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <strong>@_totalCount</strong> events found
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" @onclick="DownloadCsvAsync" disabled="@(_events.Count == 0 || _isLoading)">
                    <i class="bi bi-download"></i> Download CSV
                </button>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" @onclick="PreviousPage" disabled="@(_currentPage <= 1 || _isLoading)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-secondary disabled">Page @_currentPage</button>
                    <button class="btn btn-outline-secondary" @onclick="NextPage" disabled="@(_currentPage * _pageSize >= _totalCount || _isLoading)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead>
                    <tr>
                        <th>Occurred At</th>
                        <th>Logged At</th>
                        <th>Controller</th>
                        <th>Door</th>
                        <th>Card #</th>
                        <th>Type</th>
                        <th>Reason</th>
                        <th>Source</th>
                        <th>Sim</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var evt in _events)
                    {
                        <tr>
                            <td>@evt.ControllerEventTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>@ToClubLocal(evt.CreatedUtc).ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>@evt.Controller?.Name</td>
            <td>@(evt.Door?.Name ?? "Unknown door")</td>
                            <td>
                                @(evt.CardNumber?.ToString("D") ?? "-")
                                @if (evt.CardNumber.HasValue && _cardMemberNames.TryGetValue(evt.CardNumber.Value, out var name))
                                {
                                    <div class="small text-muted">@name</div>
                                }
                            </td>
                            <td>@evt.EventType</td>
                            <td>@(evt.ReasonCode?.ToString() ?? "-")</td>
                            <td>
                                @if (evt.IsByCard)
                                {
                                    <span class="badge bg-primary">Card</span>
                                }
                                else if (evt.IsByButton)
                                {
                                    <span class="badge bg-info text-dark">Button</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Alarm</span>
                                }
                            </td>
                            <td>
                                @if (evt.IsSimulated)
                                {
                                    <span class="badge bg-warning text-dark" title="Simulated event">
                                        <i class="bi bi-cpu"></i> SIM
                                    </span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private readonly List<ControllerDevice> _controllers = new();
    private readonly List<Door> _availableDoors = new();
    private readonly List<ControllerEvent> _events = new();
    private Dictionary<long, string> _cardMemberNames = new();
    private readonly List<EventCategoryOption> _eventTypeOptions =
    [
        new("all", "All"),
        new("card", "Card"),
        new("button", "Button"),
        new("alarm", "Alarm")
    ];
    private readonly List<EventCategoryOption> _eventSourceOptions =
    [
        new("all", "All events"),
        new("simulated", "Simulated only"),
        new("real", "Real only")
    ];

    private readonly EventFilterModel _filterModel = new();

    private bool _isLoading = true;
    private int _currentPage = 1;
    private int _pageSize = 50;
    private int _totalCount;
    private string? _errorMessage;

    private TimeZoneInfo _systemTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var settings = await SettingsService.GetAsync();
            _systemTimeZone = TimeZoneInfo.FindSystemTimeZoneById(settings.SystemTimeZoneId ?? "Eastern Standard Time");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load system timezone, defaulting to Eastern Standard Time.");
            _systemTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");
        }

        var controllers = await RegistryService.GetControllersAsync(cancellationToken: CancellationToken.None);
        _controllers.AddRange(controllers);
        await HandleFilterAsync();
    }

    private async Task HandleFilterAsync()
    {
        _isLoading = true;
        _events.Clear();
        _cardMemberNames.Clear();

        bool? isByCard = null;
        bool? isByButton = null;
        switch (_filterModel.EventCategory)
        {
            case "card":
                isByCard = true;
                break;
            case "button":
                isByButton = true;
                break;
            case "alarm":
                isByCard = false;
                isByButton = false;
                break;
        }

        try
        {
            var startUtc = _filterModel.StartDate?.ToUniversalTime();
            var endUtc = _filterModel.EndDate?.AddDays(1).AddTicks(-1).ToUniversalTime();

            var result = await EventService.GetEventsPageAsync(
                _currentPage,
                _pageSize,
                startUtc,
                endUtc,
                _filterModel.ControllerId,
                _filterModel.DoorId,
                isByCard,
                isByButton);

            _events.AddRange(result.Events);
            _totalCount = result.TotalCount;
            
            await EnrichEventsWithMemberNames();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load events");
            _errorMessage = "Failed to load events. Check logs for details.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task EnrichEventsWithMemberNames()
    {
        _cardMemberNames.Clear();
        var cardNumbers = _events
            .Where(e => e.CardNumber.HasValue && e.CardNumber.Value > 0)
            .Select(e => e.CardNumber!.Value)
            .Distinct()
            .ToArray();
            
        if (!cardNumbers.Any()) return;
        
        try
        {
            // Use KeyCardRepository to get all cards (using ADO.NET for clean connection)
            var allCards = await Task.Run(() => KeyCardRepository.GetAll());
            
            // Normalize DB cards for lookup: Trim leading zeros
            var cardMap = allCards
                .Where(c => !string.IsNullOrEmpty(c.CardNumber))
                .GroupBy(c => c.CardNumber.TrimStart('0')) 
                .ToDictionary(g => g.Key, g => g.First());
            
            // Look up each required card number
            foreach (var cNum in cardNumbers)
            {
                var searchNum = cNum.ToString().TrimStart('0');
                if (cardMap.TryGetValue(searchNum, out var keyCard))
                {
                    if (!_cardMemberNames.ContainsKey(cNum))
                    {
                        var member = await Task.Run(() => MemberRepository.GetMemberById(keyCard.MemberId));
                        if (member != null)
                        {
                            _cardMemberNames[cNum] = $"{member.FirstName} {member.LastName}";
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to enrich member names in controller events log");
        }
    }

    private void OnControllerChanged()
    {
        _availableDoors.Clear();
        if (_filterModel.ControllerId.HasValue)
        {
            var controller = _controllers.FirstOrDefault(c => c.Id == _filterModel.ControllerId.Value);
            if (controller != null)
            {
                _availableDoors.AddRange(controller.Doors.OrderBy(d => d.DoorIndex));
            }
        }
        _filterModel.DoorId = null;
    }

    private async Task ResetFilters()
    {
        _filterModel.ControllerId = null;
        _filterModel.DoorId = null;
        _filterModel.StartDate = null;
        _filterModel.EndDate = null;
        _filterModel.EventCategory = "all";
        _filterModel.EventSource = "all";
        _currentPage = 1;
        await HandleFilterAsync();
    }

    private async Task PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            await HandleFilterAsync();
        }
    }

    private async Task NextPage()
    {
        if (_currentPage * _pageSize < _totalCount)
        {
            _currentPage++;
            await HandleFilterAsync();
        }
    }

    private void NavigateBackToDashboard() => Navigation.NavigateTo("/controllers");

    private async Task DownloadCsvAsync()
    {
        try
        {
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("Occurred At,Logged At,Controller,Door,CardNumber,MemberName,EventType,ReasonCode,ByCard,ByButton");

            foreach (var evt in _events)
            {
                var memberName = "";
                if (evt.CardNumber.HasValue && _cardMemberNames.TryGetValue(evt.CardNumber.Value, out var name))
                {
                    memberName = name;
                }

                csv.AppendLine($"{evt.ControllerEventTime.ToString("yyyy-MM-dd HH:mm:ss")}," +
                              $"{ToClubLocal(evt.CreatedUtc).ToString("yyyy-MM-dd HH:mm:ss")}," +
                              $"\"{evt.Controller?.Name ?? "Unknown"}\"," +
                              $"\"{evt.Door?.Name ?? "Unknown"}\"," +
                              $"{evt.CardNumber?.ToString() ?? ""}," +
                              $"\"{memberName}\"," + 
                              $"{evt.EventType}," +
                              $"{evt.ReasonCode?.ToString() ?? ""}," +
                              $"{(evt.IsByCard ? "Yes" : "No")}," +
                              $"{(evt.IsByButton ? "Yes" : "No")}");
            }

            var csvContent = csv.ToString();
            var fileName = $"controller-events-{DateTime.UtcNow:yyyyMMdd-HHmmss}.csv";
            var bytes = System.Text.Encoding.UTF8.GetBytes(csvContent);
            var base64 = Convert.ToBase64String(bytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64, "text/csv");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to generate CSV");
        }
    }

    private class EventFilterModel
    {
        public int? ControllerId { get; set; }
        public int? DoorId { get; set; }
        public DateTime? StartDate { get; set; }
        public DateTime? EndDate { get; set; }
        public string EventCategory { get; set; } = "all";
        public string EventSource { get; set; } = "all";
    }

    private record EventCategoryOption(string Key, string Label);

    private DateTime ToClubLocal(DateTime utcTime)
    {
        return TimeZoneInfo.ConvertTimeFromUtc(utcTime, _systemTimeZone);
    }
}
