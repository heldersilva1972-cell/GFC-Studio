@page "/admin/system-diagnostics"
@using GFC.BlazorServer.Auth
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@inject IDiagnosticsService DiagnosticsService
@inject GFC.BlazorServer.Services.Diagnostics.IPerformanceHistoryService PerformanceHistoryService
@inject GFC.BlazorServer.Services.Diagnostics.IAlertManagementService AlertManagementService
@using GFC.Core.Models
@using GFC.Core.Models.Diagnostics
@using GFC.BlazorServer.Components.Shared.Diagnostics
@implements IAsyncDisposable

<PageTitle>System Diagnostics</PageTitle>

<div class="container mt-4">
    <h3>System Diagnostics - Debug View</h3>
    
    <div class="alert alert-info">
        <h5>Diagnostic Information:</h5>
        <p><strong>Loading State:</strong> @_isLoading</p>
        <p><strong>Info is null:</strong> @(_info == null)</p>
        @if (_info != null)
        {
            <p><strong>Performance is null:</strong> @(_info.Performance == null)</p>
            <p><strong>DatabaseHealth is null:</strong> @(_info.DatabaseHealth == null)</p>
            <p><strong>ControllerHealth is null:</strong> @(_info.ControllerHealth == null)</p>
            <p><strong>CameraSystem is null:</strong> @(_info.CameraSystem == null)</p>
            <p><strong>Overall Health:</strong> @_info.OverallHealth</p>
            <p><strong>Uptime:</strong> @_info.Uptime</p>
        }
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <hr />
            <h6 class="text-danger">Error Details:</h6>
            <pre style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">@_errorMessage</pre>
        }
    </div>
    
    @if (_info != null && string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-success">
            <h5>âœ… Data Loaded Successfully!</h5>
            <p>All services are working correctly. The issue is likely in the component rendering.</p>
        </div>
    }
</div>

@code {
    private SystemDiagnosticsInfo? _info;
    private bool _isLoading = false;
    private string _errorMessage = "";
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();
            
            _info = await DiagnosticsService.GetDiagnosticsAsync();
            _errorMessage = "";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Exception Type: {ex.GetType().Name}\n\n" +
                          $"Message: {ex.Message}\n\n" +
                          $"Stack Trace:\n{ex.StackTrace}\n\n";
            
            if (ex.InnerException != null)
            {
                _errorMessage += $"Inner Exception: {ex.InnerException.Message}\n\n" +
                               $"Inner Stack Trace:\n{ex.InnerException.StackTrace}";
            }
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
    
    public ValueTask DisposeAsync() => ValueTask.CompletedTask;
}
