@using GFC.BlazorServer.Data.Entities
@implements IDisposable
@using GFC.BlazorServer.Data
@using GFC.Core.Interfaces
@using GFC.BlazorServer.Services.Controllers
@using GFC.BlazorServer.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<GfcDbContext> DbContextFactory
@inject IKeyCardRepository KeyCardRepository
@inject IMemberRepository MemberRepository
@inject IControllerClient ControllerClient
@inject IJSRuntime JSRuntime
@inject ILogger<DoorActivityTab> Logger

<div class="activity-container">
    <!-- Time Range Filters -->
    <div class="activity-filters slide-in-up">
        <div class="filter-row">
            <div class="filter-group">
                <label class="filter-label">Time Range</label>
                <select class="form-select" @bind="_timeRange" @bind:after="() => LoadActivityAsync(true)">
                    <option value="all">All Time</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            @if (_timeRange == "custom")
            {
                <div class="filter-group">
                    <label class="filter-label">From</label>
                    <input type="datetime-local" class="form-control" @bind="_fromDate" @bind:after="() => LoadActivityAsync(true)" />
                </div>
                <div class="filter-group">
                    <label class="filter-label">To</label>
                    <input type="datetime-local" class="form-control" @bind="_toDate" @bind:after="() => LoadActivityAsync(true)" />
                </div>
            }
            
            <div class="filter-group">
                <label class="filter-label">Controller</label>
                <select class="form-select" @bind="_selectedControllerId" @bind:after="() => LoadActivityAsync(true)">
                    <option value="0">All Controllers</option>
                    @foreach (var controller in _controllers)
                    {
                        <option value="@controller.Id">@controller.Name</option>
                    }
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Door</label>
                <select class="form-select" @bind="_selectedDoorId" @bind:after="() => LoadActivityAsync(true)">
                    <option value="0">All Doors</option>
                    @foreach (var door in _filteredDoors)
                    {
                        <option value="@door.Id">@door.Name</option>
                    }
                </select>
            </div>
            
            <div class="filter-group align-end">
                <button class="btn btn-primary" @onclick="() => LoadActivityAsync(true)" disabled="@_loading">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            
            @if (_lastRefreshTime.HasValue)
            {
                <div class="filter-group align-end ms-auto">
                    <span class="text-muted small">Last updated: @_lastRefreshTime.Value.ToString("HH:mm:ss")</span>
                </div>
            }
        </div>
    </div>

    <!-- Debug Status Panel -->
    @if (_showDebugPanel)
    {
        <div class="alert alert-info mt-3" style="font-family: monospace; font-size: 0.85rem;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong><i class="bi bi-info-circle"></i> Download Status & Diagnostics</strong>
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => _showDebugPanel = false">
                    <i class="bi bi-x"></i> Hide
                </button>
            </div>
            
            @if (_debugInfo.Any())
            {
                <div style="max-height: 300px; overflow-y: auto;">
                    @foreach (var info in _debugInfo.OrderByDescending(x => x.Timestamp))
                    {
                        <div class="mb-2 pb-2 border-bottom">
                            <div><strong>@info.Timestamp.ToString("HH:mm:ss")</strong> - @info.ControllerName</div>
                            <div class="text-muted small">
                                @if (info.Success)
                                {
                                    <span class="text-success">✓ Success</span>
                                }
                                else
                                {
                                    <span class="text-danger">✗ Failed: @info.ErrorMessage</span>
                                }
                            </div>
                            @if (info.Success)
                            {
                                <div class="small">
                                    • Downloaded: @info.EventsDownloaded events<br/>
                                    • Saved: @info.EventsSaved new events<br/>
                                    • Skipped: @info.EventsSkipped duplicates<br/>
                                    • Last Index: @info.LastIndex
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-muted">Click refresh to download events from controllers...</div>
            }
        </div>
    }
    else
    {
        <div class="mt-2">
            <button class="btn btn-sm btn-outline-info" @onclick="() => _showDebugPanel = true">
                <i class="bi bi-bug"></i> Show Download Diagnostics
            </button>
        </div>
    }

    <!-- Activity Table -->
    @if (_loading)
    {
        <div class="loading-state">
            <div class="spinner-modern">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <p>Loading activity...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> @_errorMessage
        </div>
    }
    else
    {
        <div class="activity-card slide-in-up" style="animation-delay: 0.1s;">
            <div class="activity-header">
                <div>
                    <h5 class="mb-1">Door Activity Log</h5>
                    <p class="text-muted mb-0 small">Showing @_activities.Count of @_totalCount events @(_hasMore ? "(more available)" : "")</p>
                </div>
                <div class="activity-actions">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ExportToCsv">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="activity-table-container">
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Controller</th>
                            <th>Door</th>
                            <th>Card</th>
                            <th>Member</th>
                            <th>Event</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!_activities.Any())
                        {
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="empty-icon-small">
                                        <i class="bi bi-inbox"></i>
                                    </div>
                                    <p class="text-muted mb-0">No activity found for the selected filters</p>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var activity in _activities)
                            {
                                <tr class="activity-row @GetRowClass(activity)">
                                    <td class="time-cell">
                                        <div class="time-display">@activity.TimestampUtc.ToLocalTime().ToString("MM/dd HH:mm:ss")</div>
                                    </td>
                                    <td>@activity.ControllerName</td>
                                    <td>@activity.DoorName</td>
                                    <td>
                                        @if (activity.CardNumber.HasValue)
                                        {
                                            <span class="card-badge">#@activity.CardNumber</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(activity.MemberName))
                                        {
                                            <span>@activity.MemberName</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Unknown</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="event-badge event-@GetEventClass(activity.EventType, activity.ReasonCode)">
                                            <i class="bi bi-@GetEventIcon(activity.EventType, activity.ReasonCode)"></i>
                                            @GetEventName(activity.EventType, activity.ReasonCode)
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewDetails(activity)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
            
            @if (_hasMore)
            {
                <div class="activity-footer">
                    <button class="btn btn-outline-primary" @onclick="LoadMoreAsync" disabled="@_loadingMore">
                        @if (_loadingMore)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Load More (Next 100)
                    </button>
                </div>
            }
        </div>
    }

    <!-- Detail Modal -->
    @if (_showDetailsModal && _selectedActivity != null)
    {
        <div class="modal-backdrop-modern fade-in" @onclick="CloseDetailsModal"></div>
        <div class="modal-modern-container fade-in scale-in">
            <div class="modal-modern">
                <div class="modal-header-modern">
                    <h3 class="modal-title-modern">
                        <i class="bi bi-activity text-primary"></i>
                        Event Details
                    </h3>
                    <button class="btn-close-modern" @onclick="CloseDetailsModal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-4">
                        <div class="col-6">
                            <label class="text-muted small d-block mb-1">Controller / Door</label>
                            <div class="fw-bold">@_selectedActivity.ControllerName / @_selectedActivity.DoorName</div>
                        </div>
                        <div class="col-6">
                            <label class="text-muted small d-block mb-1">Time (Local)</label>
                            <div class="fw-bold">@_selectedActivity.TimestampUtc.ToLocalTime().ToString("G")</div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Technical Diagnostics -->
                        <div class="col-6">
                            <label class="text-muted small d-block mb-1">Controller Index</label>
                            <div class="badge bg-secondary">#@_activities.FirstOrDefault(a => a.Id == _selectedActivity.Id)?.RawIndex</div>
                        </div>
                        <div class="col-6">
                            <label class="text-muted small d-block mb-1">Reason / Code</label>
                            <div>@(_selectedActivity.ReasonCode ?? 0)</div>
                        </div>
                        
                        <div class="col-12">
                            <label class="text-muted small d-block mb-1">Member / Card</label>
                            <div class="fw-bold">@(_selectedActivity.MemberName ?? "Unknown Member") <span class="text-muted ms-2">#@_selectedActivity.CardNumber</span></div>
                        </div>

                        @if (!string.IsNullOrEmpty(_activities.FirstOrDefault(a => a.Id == _selectedActivity.Id)?.RawData))
                        {
                            <div class="col-12">
                                <label class="text-muted small d-block mb-1">Raw Payload (Hex)</label>
                                <div class="bg-light p-2 rounded selectable-text" style="font-family: monospace; font-size: 0.75rem; word-break: break-all;">
                                    @_activities.FirstOrDefault(a => a.Id == _selectedActivity.Id)?.RawData
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer-modern">
                    <button class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool _loading = true;
    private bool _loadingMore = false;
    private string _errorMessage = string.Empty;
    private string _timeRange = "all";
    private DateTime? _fromDate;
    private DateTime? _toDate;
    private int _selectedControllerId = 0;
    private int _selectedDoorId = 0;
    
    private List<ControllerDevice> _controllers = new();
    private List<Door> _allDoors = new();
    private List<Door> _filteredDoors = new();
    private List<ActivityItem> _activities = new();
    private int _totalCount = 0;
    private bool _hasMore = false;
    private int _currentPage = 0;
    private const int PageSize = 100;
    
    // Modal State
    private bool _showDetailsModal = false;
    private ActivityItem? _selectedActivity;
    
    // Debug Panel State
    private bool _showDebugPanel = false;
    private List<DebugInfo> _debugInfo = new();
    
    private DateTime? _lastRefreshTime;
    private System.Threading.Timer? _autoRefreshTimer;
    private bool _autoRefreshEnabled = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadControllersAndDoorsAsync();
        await LoadActivityAsync();
        
        // Start auto-refresh timer (every 60 seconds)
        _autoRefreshTimer = new System.Threading.Timer(async _ => 
        {
            if (_autoRefreshEnabled && !_loading && !_loadingMore)
            {
                await InvokeAsync(async () => 
                {
                    await LoadActivityAsync();
                    StateHasChanged();
                });
            }
        }, null, TimeSpan.FromSeconds(60), TimeSpan.FromSeconds(60));
    }

    public void Dispose()
    {
        _autoRefreshTimer?.Dispose();
    }
    
    private async Task LoadControllersAndDoorsAsync()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            _controllers = await context.Controllers.AsNoTracking().ToListAsync();
            _allDoors = await context.Doors.AsNoTracking().ToListAsync();
            _filteredDoors = _allDoors;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading controllers and doors");
        }
    }
    
    private async Task LoadActivityAsync(bool reset = false)
    {
        _errorMessage = null;
        if (reset)
            _currentPage = 0;
        _activities.Clear();
        _errorMessage = string.Empty;
        
        // First, download new events from all controllers
        try
        {
            await DownloadNewEventsFromControllersAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error downloading events from controllers");
            _errorMessage = $"Warning: Failed to download new events from controllers. Showing cached data only. Error: {ex.Message}";
        }
        
        // Query database to show what's actually there for debugging
        await UpdateDatabaseDiagnostics();
        
        // Then load from database
        await LoadMoreAsync();
        
        // Force UI update
        StateHasChanged();
    }
    
    private async Task UpdateDatabaseDiagnostics()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var (fromDate, toDate) = GetDateRange();
            
            var totalEvents = await context.ControllerEvents.CountAsync();
            var eventsInTimeRange = await context.ControllerEvents
                .Where(e => e.TimestampUtc >= fromDate && e.TimestampUtc <= toDate)
                .CountAsync();
            var cardEvents = await context.ControllerEvents
                .Where(e => e.TimestampUtc >= fromDate && e.TimestampUtc <= toDate && e.IsByCard)
                .CountAsync();
            var nonCardEvents = await context.ControllerEvents
                .Where(e => e.TimestampUtc >= fromDate && e.TimestampUtc <= toDate && !e.IsByCard)
                .CountAsync();
                
            Logger.LogInformation("DB Diagnostics: Total={Total}, InTimeRange={InRange}, IsByCard={ByCard}, NotByCard={NotByCard}", 
                totalEvents, eventsInTimeRange, cardEvents, nonCardEvents);
                
            if (nonCardEvents > 0 && cardEvents == 0)
            {
                _errorMessage = $"Found {nonCardEvents} events in database, but they have IsByCard=false. The display filters for IsByCard=true only. Check the event data from the controller.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error querying database diagnostics");
        }
    }
    
    private async Task DownloadNewEventsFromControllersAsync()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            // Get all active controllers
            var controllers = await context.Controllers
                .Where(c => c.IsEnabled)
                .ToListAsync();
            
            foreach (var controller in controllers)
            {
                var debugEntry = new DebugInfo
                {
                    Timestamp = DateTime.Now,
                    ControllerName = controller.Name,
                    Success = false
                };
                
                try
                {
                    Logger.LogInformation("Starting event sync for controller {ControllerName} (SN: {SerialNumber})", 
                        controller.Name, controller.SerialNumber);
                    
                    // Step 1: Get the controller's current index via 0x20 (GetRunStatus)
                    var status = await ControllerClient.GetRunStatusAsync(
                        controller.SerialNumber.ToString(), 
                        CancellationToken.None);
                    
                    if (status == null)
                    {
                        Logger.LogWarning("Failed to get status from controller {ControllerName}", controller.Name);
                        debugEntry.ErrorMessage = "Failed to get controller status";
                        continue;
                    }
                    
                    uint currentIndex = status.TotalEvents;
                    Logger.LogInformation("Controller {ControllerName}: CurrentIndex={CurrentIndex}", 
                        controller.Name, currentIndex);
                    
                    // Step 2: Get our last read index from database
                    var lastEvent = await context.ControllerEvents
                        .Where(e => e.ControllerId == controller.Id)
                        .OrderByDescending(e => e.RawIndex)
                        .FirstOrDefaultAsync();
                    
                    uint lastReadIndex = lastEvent?.RawIndex > 0 ? (uint)lastEvent.RawIndex : 0;
                    Logger.LogInformation("Controller {ControllerName}: LastReadIndex={LastReadIndex}", 
                        controller.Name, lastReadIndex);
                    
                    // Step 3: Sequential retrieval loop
                    int downloadedCount = 0;
                    int savedCount = 0;
                    int skippedCount = 0;
                    
                    // CRITICAL FIX: Handle index reset. If currentIndex < lastReadIndex, the controller was reset.
                    uint startSyncIndex = lastReadIndex + 1;
                    if (currentIndex < lastReadIndex)
                    {
                        Logger.LogWarning("Controller {ControllerName} index reset detected! (Current: {Current}, LastRead: {LastRead}). Restarting sync from 0.", 
                            controller.Name, currentIndex, lastReadIndex);
                        startSyncIndex = 0;
                    }

                    // Fetch events from startSyncIndex to CurrentIndex
                    if (currentIndex > 0)
                    {
                        for (uint index = Math.Max(1, startSyncIndex); index <= currentIndex; index++)
                        {
                            try
                            {
                                // Fetch single event at this index
                                var result = await ControllerClient.GetNewEventsAsync(
                                    controller.SerialNumber.ToString(),
                                    index - 1, // index is 1-based in our loop, 0-based in hardware query
                                    CancellationToken.None);
                            
                            if (result?.Events != null && result.Events.Any())
                            {
                                downloadedCount += result.Events.Count;
                                
                                // Step 4: Process downloaded events
                                foreach (var evt in result.Events)
                                {
                                    // Check if already exists in database
                                    var exists = await context.ControllerEvents
                                        .AnyAsync(e => e.ControllerId == controller.Id && e.RawIndex == evt.RawIndex);
                                    
                                    if (!exists)
                                    {
                                        // Find the door record
                                        var door = await context.Doors
                                            .FirstOrDefaultAsync(d => d.ControllerId == controller.Id && d.DoorIndex == evt.DoorNumber);
                                        
                                        // Prepare hex dump for diagnostics modal
                                        var hexDump = evt.RawData ?? string.Empty;
                                        if (string.IsNullOrEmpty(hexDump))
                                        {
                                            hexDump = $"TYPE:{(int)evt.EventType}, CARD:{evt.CardNumber}, DOOR:{evt.DoorNumber}";
                                        }

                                        var controllerEvent = new Data.Entities.ControllerEvent
                                        {
                                            ControllerId = controller.Id,
                                            DoorId = door?.Id,
                                            TimestampUtc = evt.TimestampUtc,
                                            CardNumber = evt.CardNumber,
                                            EventType = (int)evt.EventType,
                                            ReasonCode = (int)evt.ReasonCode,
                                            IsByCard = evt.IsByCard || (evt.CardNumber > 0),
                                            IsByButton = evt.IsByButton,
                                            RawIndex = (int)evt.RawIndex,
                                            RawData = hexDump,
                                            CreatedUtc = DateTime.UtcNow
                                        };
                                        
                                        context.ControllerEvents.Add(controllerEvent);
                                        await context.SaveChangesAsync();
                                        savedCount++;
                                        
                                        Logger.LogInformation("Saved event: Index={RawIndex}, Card={CardNumber}, Door={DoorId}, Time={Time}", 
                                            evt.RawIndex, evt.CardNumber, door?.Id, evt.TimestampUtc);
                                    }
                                    else
                                    {
                                        skippedCount++;
                                    }
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            Logger.LogError(ex, "Failed to fetch event at index {Index} from controller {ControllerName}", 
                                index, controller.Name);
                        }
                    }
                    }
                    
                    debugEntry.EventsDownloaded = downloadedCount;
                    debugEntry.EventsSaved = savedCount;
                    debugEntry.EventsSkipped = skippedCount;
                    debugEntry.LastIndex = currentIndex;
                    debugEntry.Success = true;
                    
                    Logger.LogInformation("Event sync complete for {ControllerName}: Downloaded={Downloaded}, Saved={Saved}, Skipped={Skipped}", 
                        controller.Name, downloadedCount, savedCount, skippedCount);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failed to sync events from controller {ControllerName} (ID: {ControllerId})", 
                        controller.Name, controller.Id);
                    debugEntry.ErrorMessage = ex.Message;
                }
                
                _debugInfo.Add(debugEntry);
                
                // Keep only last 20 entries
                if (_debugInfo.Count > 20)
                {
                    _debugInfo.RemoveAt(0);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in event synchronization");
        }
    }
    
    private async Task<(int saved, int skipped)> SaveEventsToDatabase(int controllerId, IEnumerable<ControllerEventDto> events)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            int savedCount = 0;
            int skippedCount = 0;
            
            foreach (var evt in events)
            {
                // Check if event already exists (by controller + raw index)
                var exists = await context.ControllerEvents
                    .AnyAsync(e => e.ControllerId == controllerId && e.RawIndex == (int)evt.RawIndex);
                
                if (!exists)
                {
                    // Find the door by door index
                    var door = await context.Doors
                        .FirstOrDefaultAsync(d => d.ControllerId == controllerId && d.DoorIndex == evt.DoorNumber);
                    
                    var controllerEvent = new ControllerEvent
                    {
                        ControllerId = controllerId,
                        DoorId = door?.Id,
                        TimestampUtc = evt.TimestampUtc,
                        CardNumber = (evt.CardNumber > 0) ? evt.CardNumber : null,
                        EventType = evt.EventType,
                        ReasonCode = evt.ReasonCode,
                        IsByCard = evt.IsByCard,
                        IsByButton = evt.IsByButton,
                        RawIndex = (int)evt.RawIndex,
                        CreatedUtc = DateTime.UtcNow
                    };
                    
                    context.ControllerEvents.Add(controllerEvent);
                    savedCount++;
                    
                    Logger.LogInformation("Saving event: Index={RawIndex}, Card={CardNumber}, Door={DoorId}, Type={EventType}, IsByCard={IsByCard}, IsByButton={IsByButton}, Time={Time}", 
                        evt.RawIndex, evt.CardNumber, door?.Id, evt.EventType, evt.IsByCard, evt.IsByButton, evt.TimestampUtc);
                }
                else
                {
                    skippedCount++;
                }
            }
            
            if (savedCount > 0)
            {
                Logger.LogInformation("Calling SaveChangesAsync for {SavedCount} events...", savedCount);
                var changeCount = await context.SaveChangesAsync();
                Logger.LogInformation("SaveChangesAsync completed! Database reported {ChangeCount} changes saved for controller {ControllerId} (skipped {SkippedCount} duplicates)", 
                    changeCount, controllerId, skippedCount);
            }
            else
            {
                Logger.LogInformation("No new events to save for controller {ControllerId} ({SkippedCount} duplicates)", 
                    controllerId, skippedCount);
            }
            
            return (savedCount, skippedCount);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save events to database for controller {ControllerId}", controllerId);
            return (0, 0);
        }
    }
    
    private async Task LoadMoreAsync()
    {
        _loading = _currentPage == 0;
        _loadingMore = _currentPage > 0;
        _errorMessage = string.Empty;
        
        try
        {
            var (fromDate, toDate) = GetDateRange();
            
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            var query = context.ControllerEvents.AsNoTracking()
                .Where(e => e.TimestampUtc >= fromDate && e.TimestampUtc <= toDate)
                // Removed IsByCard filter - show ALL door activity (card swipes, button presses, etc.)
                .OrderByDescending(e => e.TimestampUtc);
            
            Logger.LogInformation("Querying events: FromDate={FromDate}, ToDate={ToDate}, TimeRange={TimeRange}", 
                fromDate, toDate, _timeRange);
            
            // Apply filters
            if (_selectedControllerId > 0)
            {
                query = (IOrderedQueryable<ControllerEvent>)query.Where(e => e.ControllerId == _selectedControllerId);
                Logger.LogInformation("Filtering by ControllerId={ControllerId}", _selectedControllerId);
            }
            
            if (_selectedDoorId > 0)
            {
                query = (IOrderedQueryable<ControllerEvent>)query.Where(e => e.DoorId == _selectedDoorId);
                Logger.LogInformation("Filtering by DoorId={DoorId}", _selectedDoorId);
            }
            
            var events = await query
                .Skip(_currentPage * PageSize)
                .Take(PageSize)
                .Include(e => e.Controller)
                .Include(e => e.Door)
                .ToListAsync();
            
            Logger.LogInformation("Query returned {Count} events (Page={Page}, PageSize={PageSize})", 
                events.Count, _currentPage, PageSize);
            
            // Load all cards and members for lookup - using repository might still be stale if it uses a long-lived context, 
            // but usually repositories in Blazor are Scoped. 
            // Better to fetch manually here to be sure, or rely on Repository if it uses Factory.
            // Assuming KeyCardRepository is scoped to the component (which is long-lived in Blazor Server), it might be stale.
            // Let's reload cards/members here using the fresh context.
            
            // Optimization: Fetch only needed cards? No, too complex join logic for now.
            // Just use the existing repository call but acknowledge it might be slightly stale for *new members*, 
            // but events are the main thing being refreshed.
            
            var allCards = await Task.Run(() => KeyCardRepository.GetAll());
            var allMembers = await Task.Run(() => MemberRepository.GetAllMembers());

            // Optimization: Use Dictionaries for O(1) lookups instead of O(N) FirstOrDefault in a loop
            var cardsByNumber = allCards
                .GroupBy(c => c.CardNumber.TrimStart('0'))
                .ToDictionary(g => g.Key, g => g.First());
            
            var membersById = allMembers.ToDictionary(m => m.MemberID);
            
            var newActivities = events.Select(e => {
                string? memberName = null;
                if (e.CardNumber.HasValue && e.CardNumber.Value > 0)
                {
                    // Normalize the scanned card number (remove leading zeros)
                    var normalizedScanned = e.CardNumber.Value.ToString().TrimStart('0');
                    
                    if (!string.IsNullOrEmpty(normalizedScanned) && cardsByNumber.TryGetValue(normalizedScanned, out var card))
                    {
                        if (membersById.TryGetValue(card.MemberId, out var member))
                        {
                            memberName = $"{member.FirstName} {member.LastName}";
                        }
                    }
                }
                
                return new ActivityItem
                {
                    Id = e.Id,
                    TimestampUtc = e.TimestampUtc,
                    ControllerName = e.Controller?.Name ?? "Unknown",
                    DoorName = e.Door?.Name ?? "Unknown", // Revert to only using mapped Door navigation property
                    CardNumber = e.CardNumber,
                    MemberName = memberName,
                    EventType = e.EventType,
                    ReasonCode = e.ReasonCode,
                    RawIndex = e.RawIndex,
                    RawData = e.RawData
                };
            }).ToList();
            
            _activities.AddRange(newActivities);
            _hasMore = newActivities.Count == PageSize;
            _currentPage++;
            _totalCount = _activities.Count; // Approximate
            _lastRefreshTime = DateTime.Now;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading activity");
            _errorMessage = "Failed to load door activity. Please try again.";
        }
        finally
        {
            _loading = false;
            _loadingMore = false;
        }
    }
    
    private (DateTime from, DateTime to) GetDateRange()
    {
        // Use Local Time for "Today" and "Yesterday" filtering to match user perspective
        var localNow = DateTime.Now;
        var nowUtc = DateTime.UtcNow;
        
        return _timeRange switch
        {
            "all" => (DateTime.MinValue, DateTime.MaxValue),
            "24h" => (nowUtc.AddHours(-24), nowUtc),
            "today" => (localNow.Date.ToUniversalTime(), nowUtc),
            "week" => (localNow.Date.AddDays(-(int)localNow.DayOfWeek).ToUniversalTime(), nowUtc),
            "month" => (new DateTime(localNow.Year, localNow.Month, 1).ToUniversalTime(), nowUtc),
            "custom" => (_fromDate?.ToUniversalTime() ?? nowUtc.AddHours(-24), _toDate?.ToUniversalTime() ?? nowUtc),
            _ => (nowUtc.AddHours(-24), nowUtc)
        };
    }
    
    private async Task ExportToCsv()
    {
        try 
        {
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("Time,Controller,Door,Card,Member,Event,Reason");
            
            foreach (var a in _activities)
            {
                csv.AppendLine($"{a.TimestampUtc},{a.ControllerName},{a.DoorName},{a.CardNumber},{a.MemberName},{GetEventName(a.EventType, a.ReasonCode)},{a.ReasonCode}");
            }
            
            var fileName = $"door_activity_export_{DateTime.Now:yyyyMMdd}.csv";
            await JSRuntime.InvokeVoidAsync("blazorInterop.downloadFile", fileName, "text/csv", csv.ToString());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Export failed");
            _errorMessage = "Export failed.";
        }
    }
    
    private void ViewDetails(ActivityItem activity)
    {
        _selectedActivity = activity;
        _showDetailsModal = true;
    }
    
    private void CloseDetailsModal() => _showDetailsModal = false;
    
    private string GetRowClass(ActivityItem activity)
    {
        if (activity.EventType == 1) // Category 1 = Swipe
        {
            return activity.ReasonCode == 0x01 ? "event-success" : "event-danger";
        }
        
        return activity.ReasonCode == 0x25 ? "event-success" : ""; // Remote Open is also success
    }
    
    private string GetEventClass(int eventType, int? reasonCode)
    {
        // Category 1 = Swipe, Category 3 = System/Sensor
        if (eventType == 1) // Swipe
        {
            return reasonCode == 1 ? "success" : "danger";
        }
        
        return reasonCode switch
        {
            0x1C => "info",    // Door Closed
            0x1D => "warning", // Door Opened
            0x25 => "success", // Remote Open
            _ => "secondary"
        };
    }
    
    private string GetEventIcon(int eventType, int? reasonCode)
    {
        if (eventType == 1) // Swipe
        {
            return reasonCode == 1 ? "check-circle-fill" : "x-circle-fill";
        }
        
        return reasonCode switch
        {
            0x1C => "shield-check",
            0x1D => "shield-exclamation",
            0x25 => "cloud-upload-fill",
            _ => "circle-fill"
        };
    }
    
    private string GetEventName(int eventType, int? reasonCode)
    {
        if (eventType == 1) // Swipe
        {
            return reasonCode switch
            {
                0x01 => "Access Granted",
                0x05 => "Denied: Not Found",
                0x06 => "Denied: Timezone",
                0x07 => "Denied: Password",
                0x08 => "Denied: Anti-Passback",
                0x09 => "Denied: Expired",
                0x0F => "Denied: Door Locked",
                _ => "Access Denied"
            };
        }
        
        return reasonCode switch
        {
            0x1C => "Door Closed",
            0x1D => "Door Opened",
            0x25 => "Remote Opened",
            _ => "System Event"
        };
    }
    
    private class ActivityItem
    {
        public int Id { get; set; }
        public DateTime TimestampUtc { get; set; }
        public string ControllerName { get; set; } = string.Empty;
        public string DoorName { get; set; } = string.Empty;
        public long? CardNumber { get; set; }
        public string? MemberName { get; set; }
        public int EventType { get; set; }
        public int? ReasonCode { get; set; }
        public int RawIndex { get; set; }
        public string? RawData { get; set; }
    }
    
    private class DebugInfo
    {
        public DateTime Timestamp { get; set; }
        public string ControllerName { get; set; } = string.Empty;
        public bool Success { get; set; }
        public string? ErrorMessage { get; set; }
        public int EventsDownloaded { get; set; }
        public int EventsSaved { get; set; }
        public int EventsSkipped { get; set; }
        public uint LastIndex { get; set; }
    }
}
