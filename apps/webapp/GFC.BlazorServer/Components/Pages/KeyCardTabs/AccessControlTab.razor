@using GFC.BlazorServer.Data.Entities
@using TimeProfile = GFC.BlazorServer.Data.Entities.TimeProfile
@using GFC.BlazorServer.Data
@using GFC.Core.Interfaces
@using Microsoft.EntityFrameworkCore
@inject GfcDbContext DbContext
@inject IKeyCardRepository _keyCardRepository
@inject KeyCardLifecycleService KeyCardLifecycleService
@inject IJSRuntime JSRuntime
@inject ILogger<AccessControlTab> Logger
@inject IMemberRepository MemberRepository

<div class="access-container">
    <div class="access-info slide-in-up">
        <div class="info-icon">
            <i class="bi bi-info-circle"></i>
        </div>
        <div>
            <h5 class="mb-1">Access Control Management</h5>
            <p class="mb-0">Configure which doors each member can access. Changes are synced to controllers automatically.</p>
        </div>
    </div>

    <div class="access-content slide-in-up" style="animation-delay: 0.1s;">
        <div class="view-selector">
            <button class="view-btn @(_viewMode == "member" ? "active" : "")" @onclick="@(() => _viewMode = "member")">
                <i class="bi bi-person"></i> By Member
            </button>
            <button class="view-btn @(_viewMode == "door" ? "active" : "")" @onclick="@(() => _viewMode = "door")">
                <i class="bi bi-door-open"></i> By Door
            </button>
        </div>

        @if (_viewMode == "member")
        {
            <div class="member-access-view fade-in">
                <div class="selection-panel">
                    <label class="form-label-modern">Select Member</label>
                    <select class="form-select form-select-lg" @bind="_selectedMemberId" @bind:after="LoadMemberAccessAsync">
                        <option value="0">-- Select a member --</option>
                        @foreach (var member in _membersWithCards)
                        {
                            <option value="@member.MemberId">@member.MemberName (Card: @member.CardNumber)</option>
                        }
                    </select>
                </div>

                @if (_selectedMemberId > 0)
                {
                    <div class="access-panel">
                        <div class="panel-header">
                            <h5>Door Access for @_selectedMemberName</h5>
                            <button class="btn btn-primary" @onclick="ShowAddDoorModal">
                                <i class="bi bi-plus-circle"></i> Add Door Access
                            </button>
                        </div>

                        @if (_loading)
                        {
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary"></div>
                            </div>
                        }
                        else if (!_memberAccess.Any())
                        {
                            <div class="empty-state-small">
                                <i class="bi bi-shield-x"></i>
                                <p>No door access configured for this member</p>
                            </div>
                        }
                        else
                        {
                            <div class="access-table-container">
                                <table class="access-table">
                                    <thead>
                                        <tr>
                                            <th>Controller</th>
                                            <th>Door</th>
                                            <th>Access Schedule</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var access in _memberAccess)
                                        {
                                            <tr>
                                                <td>@access.ControllerName</td>
                                                <td>@access.DoorName</td>
                                                <td>@access.TimeProfileName</td>
                                                <td>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               checked="@access.IsEnabled" 
                                                               @onchange="() => ToggleAccess(access)" />
                                                        <label class="form-check-label">
                                                            @(access.IsEnabled ? "Enabled" : "Disabled")
                                                        </label>
                                                    </div>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveAccess(access)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="door-access-view fade-in">
                <div class="selection-panel">
                    <label class="form-label-modern">Select Door</label>
                    <select class="form-select form-select-lg" @bind="_selectedDoorId" @bind:after="LoadDoorAccessAsync">
                        <option value="0">-- Select a door --</option>
                        @foreach (var door in _doors)
                        {
                            <option value="@door.Id">@door.Name @(door.Controller != null ? $"({door.Controller.Name})" : "")</option>
                        }
                    </select>
                </div>

                @if (_selectedDoorId > 0)
                {
                    <div class="access-panel">
                        <div class="panel-header">
                            <h5>Members with Access to @_selectedDoorName</h5>
                            <button class="btn btn-primary" @onclick="ShowAddMemberModal">
                                <i class="bi bi-plus-circle"></i> Add Member
                            </button>
                        </div>

                        @if (_loading)
                        {
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary"></div>
                            </div>
                        }
                        else if (!_doorAccess.Any())
                        {
                            <div class="empty-state-small">
                                <i class="bi bi-people-fill"></i>
                                <p>No members have access to this door</p>
                            </div>
                        }
                        else
                        {
                            <div class="access-grid">
                                @foreach (var access in _doorAccess)
                                {
                                    <div class="member-access-card">
                                        <div class="member-avatar">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <div class="member-info">
                                            <div class="member-name">@access.MemberName</div>
                                            <div class="member-card">Card: @access.CardNumber</div>
                                            <div class="member-profile">@access.TimeProfileName</div>
                                        </div>
                                        <div class="member-actions">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       checked="@access.IsEnabled" 
                                                       @onchange="() => ToggleAccess(access)" />
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveAccess(access)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
    
    <!-- Add Access Modal -->
    @if (_showAddModal)
    {
        <div class="modal-backdrop-modern fade-in" @onclick="CloseAddModal"></div>
        <div class="modal-modern-container fade-in scale-in">
            <div class="modal-modern">
                <div class="modal-header-modern">
                    <h3 class="modal-title-modern">
                        <i class="bi bi-shield-plus text-primary"></i>
                        Grant Access
                    </h3>
                    <button class="btn-close-modern" @onclick="CloseAddModal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="modal-body-modern">
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger">@_errorMessage</div>
                    }
                    
                    <div class="form-group-modern mb-3">
                        <label class="form-label-modern">Target</label>
                        <div class="form-control-plaintext fw-bold">
                            @(_viewMode == "member" ? _selectedMemberName : _selectedDoorName)
                        </div>
                    </div>

                    @if (_viewMode == "member")
                    {
                        <div class="form-group-modern mb-3">
                            <label class="form-label-modern">Select Door <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="_newAccessTargetId">
                                <option value="0">-- Select Door --</option>
                                @foreach (var door in _doors.Where(d => !_memberAccess.Any(ma => ma.DoorId == d.Id)))
                                {
                                    <option value="@door.Id">@door.Name</option>
                                }
                            </select>
                        </div>
                    }
                    else
                    {
                        <div class="form-group-modern mb-3">
                            <label class="form-label-modern">Select Member <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="_newAccessTargetId">
                                <option value="0">-- Select Member --</option>
                                @foreach (var m in _membersWithCards.Where(m => !_doorAccess.Any(da => da.MemberId == m.MemberId)))
                                {
                                    <option value="@m.MemberId">@m.MemberName</option>
                                }
                            </select>
                        </div>
                    }

                    <div class="form-group-modern mb-4">
                        <label class="form-label-modern">Time Profile</label>
                        <select class="form-select" @bind="_selectedProfileId">
                            <option value="">24/7 Access (Default)</option>
                            @foreach (var profile in _timeProfiles)
                            {
                                <option value="@profile.Id">@profile.Name</option>
                            }
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn btn-outline-secondary" @onclick="CloseAddModal">Cancel</button>
                        <button class="btn btn-success" @onclick="SaveAccess" disabled="@(_newAccessTargetId == 0 || _isSaving)">
                             @if (_isSaving) { <span class="spinner-border spinner-border-sm me-2"></span> }
                             Grant Access
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string _viewMode = "member";
    private bool _loading = false;
    private int _selectedMemberId = 0;
    private int _selectedDoorId = 0;
    private string _selectedMemberName = string.Empty;
    private string _selectedDoorName = string.Empty;
    
    private List<MemberWithCard> _membersWithCards = new();
    private List<Door> _doors = new();
    private List<TimeProfile> _timeProfiles = new();
    private List<AccessItem> _memberAccess = new();
    private List<AccessItem> _doorAccess = new();

    // Add Modal State
    private bool _showAddModal = false;
    private int _newAccessTargetId = 0;
    private int? _selectedProfileId;
    private bool _isSaving = false;
    private string _errorMessage = string.Empty;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            // Load members and cards
            var keycards = await Task.Run(() => _keyCardRepository.GetAll());
            var members = await Task.Run(() => MemberRepository.GetAllMembers());
            var memberMap = members.ToDictionary(m => m.MemberID, m => $"{m.FirstName} {m.LastName}");
            
            _membersWithCards = keycards.Select(k => new MemberWithCard
            {
                MemberId = k.MemberId,
                MemberName = memberMap.TryGetValue(k.MemberId, out var name) ? name : $"Member {k.MemberId}",
                CardNumber = k.CardNumber
            }).ToList();
            
            // Load doors
            _doors = await DbContext.Doors
                .Include(d => d.Controller)
                .ToListAsync();

            // Load profiles
            _timeProfiles = await DbContext.TimeProfiles.ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading data");
        }
    }
    
    private async Task LoadMemberAccessAsync()
    {
        if (_selectedMemberId == 0) return;
        
        _loading = true;
        try
        {
            var member = _membersWithCards.FirstOrDefault(m => m.MemberId == _selectedMemberId);
            _selectedMemberName = member?.MemberName ?? "";
            
            var access = await DbContext.MemberDoorAccesses
                .Where(a => a.MemberId == _selectedMemberId)
                .Include(a => a.Door)
                .ThenInclude(d => d.Controller)
                .Include(a => a.TimeProfile)
                .ToListAsync();
            
            _memberAccess = access.Select(a => new AccessItem
            {
                Id = a.Id,
                MemberId = a.MemberId,
                DoorId = a.DoorId,
                ControllerName = a.Door?.Controller?.Name ?? "Unknown",
                DoorName = a.Door?.Name ?? "Unknown",
                TimeProfileName = a.TimeProfile?.Name ?? "24/7",
                IsEnabled = a.IsEnabled
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading member access");
        }
        finally
        {
            _loading = false;
        }
    }
    
    private async Task LoadDoorAccessAsync()
    {
        if (_selectedDoorId == 0) return;
        
        _loading = true;
        try
        {
            var door = _doors.FirstOrDefault(d => d.Id == _selectedDoorId);
            _selectedDoorName = door?.Name ?? "";
            
            var access = await DbContext.MemberDoorAccesses
                .Where(a => a.DoorId == _selectedDoorId)
                .Include(a => a.TimeProfile)
                .ToListAsync();
            
            var members = await Task.Run(() => MemberRepository.GetAllMembers());
            var memberMap = members.ToDictionary(m => m.MemberID, m => $"{m.FirstName} {m.LastName}");

            _doorAccess = access.Select(a => new AccessItem
            {
                Id = a.Id,
                MemberId = a.MemberId,
                DoorId = a.DoorId,
                MemberName = memberMap.TryGetValue(a.MemberId, out var name) ? name : $"Member {a.MemberId}",
                CardNumber = a.CardNumber,
                TimeProfileName = a.TimeProfile?.Name ?? "24/7",
                IsEnabled = a.IsEnabled
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading door access");
        }
        finally
        {
            _loading = false;
        }
    }
    
    private void ShowAddDoorModal()
    {
        _newAccessTargetId = 0;
        _selectedProfileId = null;
        _errorMessage = string.Empty;
        _showAddModal = true;
    }
    
    private void ShowAddMemberModal()
    {
        _newAccessTargetId = 0;
        _selectedProfileId = null;
        _errorMessage = string.Empty;
        _showAddModal = true;
    }
    
    private void CloseAddModal() => _showAddModal = false;

    private async Task SaveAccess()
    {
        _isSaving = true;
        _errorMessage = string.Empty;
        try
        {
            var memberId = _viewMode == "member" ? _selectedMemberId : _newAccessTargetId;
            var doorId = _viewMode == "member" ? _newAccessTargetId : _selectedDoorId;

            // Get card number
            var card = await Task.Run(() => _keyCardRepository.GetActiveMemberCard(memberId));
            if (card == null)
            {
                _errorMessage = "Member does not have an active key card.";
                return;
            }

            var newAccess = new MemberDoorAccess
            {
                MemberId = memberId,
                DoorId = doorId,
                CardNumber = card.CardNumber,
                TimeProfileId = _selectedProfileId,
                IsEnabled = true
            };

            DbContext.MemberDoorAccesses.Add(newAccess);
            await DbContext.SaveChangesAsync();

            await TriggerSyncForMember(memberId);
            
            CloseAddModal();
            if (_viewMode == "member") await LoadMemberAccessAsync();
            else await LoadDoorAccessAsync();
        }
        catch (Exception ex)
        {
             Logger.LogError(ex, "Failed to save access");
             _errorMessage = "Failed to grant access.";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ToggleAccess(AccessItem access)
    {
        try 
        {
            var entity = await DbContext.MemberDoorAccesses.FindAsync(access.Id);
            if (entity != null)
            {
                entity.IsEnabled = !entity.IsEnabled; // Toggle
                await DbContext.SaveChangesAsync();
                
                // Update UI immediately for responsiveness
                access.IsEnabled = entity.IsEnabled;
                
                // Sync
                await TriggerSyncForMember(entity.MemberId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling access");
            // Revert UI?
        }
    }
    
    private async Task RemoveAccess(AccessItem access)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to remove this access rule?")) return;
        
        try
        {
             var entity = await DbContext.MemberDoorAccesses.FindAsync(access.Id);
             if (entity != null)
             {
                 DbContext.MemberDoorAccesses.Remove(entity);
                 await DbContext.SaveChangesAsync();
                 
                 await TriggerSyncForMember(entity.MemberId);
                 
                 if (_viewMode == "member") _memberAccess.Remove(access);
                 else _doorAccess.Remove(access);
             }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error removing access");
        }
    }

    private async Task TriggerSyncForMember(int memberId)
    {
        // Find active card for member
        var card = await Task.Run(() => _keyCardRepository.GetActiveMemberCard(memberId));
        if (card != null && card.IsActive)
        {
            await KeyCardLifecycleService.SyncCardToControllerAsync(card.KeyCardId, true, CancellationToken.None);
        }
    }
    
    private class MemberWithCard
    {
        public int MemberId { get; set; }
        public string MemberName { get; set; } = string.Empty;
        public string CardNumber { get; set; } = string.Empty;
    }
    
    private class AccessItem
    {
        public int Id { get; set; }
        public int MemberId { get; set; }
        public int DoorId { get; set; }
        public string MemberName { get; set; } = string.Empty;
        public string CardNumber { get; set; } = string.Empty;
        public string ControllerName { get; set; } = string.Empty;
        public string DoorName { get; set; } = string.Empty;
        public string TimeProfileName { get; set; } = string.Empty;
        public bool IsEnabled { get; set; }
    }
}
