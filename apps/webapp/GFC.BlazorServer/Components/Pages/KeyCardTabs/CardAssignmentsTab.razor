@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Models
@using Microsoft.EntityFrameworkCore
@using GFC.Core.Interfaces
@using GFC.Core.Models
@using GFC.Core.Services
@implements IDisposable
@inject IDbContextFactory<GfcDbContext> DbContextFactory
@inject IKeyCardRepository KeyCardRepository
@inject IMemberRepository MemberRepository
@inject IBoardRepository BoardRepository
@inject IDuesInsightService DuesInsightService
@inject ICardDeactivationLogRepository DeactivationLogRepository
@inject IControllerSyncQueueRepository SyncQueueRepository
@inject KeyCardLifecycleService LifecycleService
@inject ILogger<CardAssignmentsTab> Logger
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject IDuesYearSettingsRepository DuesYearSettingsRepository
@inject IMemberAccessService MemberAccessService
@inject KeyCardService KeyCardService
@inject IDuesRepository DuesRepository

<div class="assignments-container">
    <!-- Summary Metrics -->
    <div class="metrics-grid slide-in-up">
        <div class="metric-card metric-primary">
            <div class="metric-icon">
                <i class="bi bi-credit-card-2-front-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Total Cards</div>
                <div class="metric-value">@_totalCards</div>
            </div>
        </div>
        
        <div class="metric-card metric-success">
            <div class="metric-icon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Active Cards</div>
                <div class="metric-value">@_activeCards</div>
            </div>
        </div>
        
        <div class="metric-card metric-warning">
            <div class="metric-icon">
                <i class="bi bi-pause-circle-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Inactive Cards</div>
                <div class="metric-value">@_inactiveCards</div>
            </div>
        </div>
        
        <div class="metric-card metric-info">
            <div class="metric-icon">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Members with Cards</div>
                <div class="metric-value">@_membersWithCards</div>
            </div>
        </div>

        <div class="metric-card metric-danger" @onclick="HandleNeedingCardsClick">
            <div class="metric-icon">
                <i class="bi bi-person-exclamation"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Needing Cards</div>
                <div class="metric-value">@_membersNeedingCards</div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-section slide-in-up" style="animation-delay: 0.1s;">
        <div class="search-filter-bar">
            <div class="search-box-large">
                <i class="bi bi-search"></i>
                <input type="text" 
                       class="form-control" 
                       placeholder="Search by card number, member name, or ID..."
                       @bind="_searchTerm"
                       @bind:event="oninput"
                       @bind:after="ApplyFilters" />
                @if (!string.IsNullOrEmpty(_searchTerm))
                {
                    <button class="btn-clear" @onclick="ClearSearch">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
            </div>
            
            <div class="filter-pills">
                <button class="filter-pill @(_statusFilter == "all" ? "active" : "")" 
                        @onclick='() => SetStatusFilter("all")'>
                    All Cards
                </button>
                <button class="filter-pill @(_statusFilter == "active" ? "active" : "")" 
                        @onclick='() => SetStatusFilter("active")'>
                    <i class="bi bi-check-circle"></i> Active Cards
                </button>
                <button class="filter-pill @(_statusFilter == "inactive" ? "active" : "")" 
                        @onclick='() => SetStatusFilter("inactive")'>
                    <i class="bi bi-pause-circle"></i> Inactive Cards
                </button>
                <button class="filter-pill @(_statusFilter == "unpaid" ? "active" : "")" 
                        @onclick='() => SetStatusFilter("unpaid")' title="Show active cards with unpaid dues">
                    <i class="bi bi-clock-history"></i> At Risk
                </button>
                <button class="filter-pill @(_statusFilter == "delinquent" ? "active" : "")" 
                        @onclick='() => SetStatusFilter("delinquent")' title="Show cards where previous year was also unpaid">
                    <i class="bi bi-x-circle text-danger"></i> Delinquent
                </button>
                <button class="filter-pill filter-pill-danger" @onclick="HandleNeedingCardsClick">
                    <i class="bi bi-person-badge"></i> Needing Cards
                    @if (_membersNeedingCards > 0)
                    {
                        <span class="badge bg-danger ms-1">@_membersNeedingCards</span>
                    }
                </button>
            </div>

            <div class="d-flex align-items-center gap-2 ms-auto">
                <div class="view-toggle">
                    <button class="btn-toggle @(_viewMode == "grid" ? "active" : "")" @onclick='() => SetViewMode("grid")' title="Grid View">
                        <i class="bi bi-grid-3x3-gap-fill"></i>
                    </button>
                    <button class="btn-toggle @(_viewMode == "list" ? "active" : "")" @onclick='() => SetViewMode("list")' title="List View">
                        <i class="bi bi-list-ul"></i>
                    </button>
                </div>
                <button class="btn btn-outline-secondary" @onclick="ExportCards" title="Export to CSV">
                    <i class="bi bi-download"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    @if (_loading)
    {
        <div class="loading-state">
            <div class="spinner-modern">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <p>Loading cards...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger slide-in-up">
            <i class="bi bi-exclamation-triangle"></i> @_errorMessage
        </div>
    }
    else if (!_filteredCards.Any())
    {
        <div class="empty-state slide-in-up">
            <div class="empty-icon">
                <i class="bi bi-inbox"></i>
            </div>
            <h3>No Cards Found</h3>
            <p>@(_searchTerm.Length > 0 ? "Try adjusting your search or filters" : "Get started by assigning a new key card")</p>
        </div>
    }
    else
    {
        @if (_viewMode == "grid")
        {
            <div class="cards-grid">
                @foreach (var card in _filteredCards)
                {
                    <div class="card-item fade-in">
                        <div class="card-item-header">
                            <div class="card-number-badge">
                                <i class="bi bi-credit-card-2-front"></i>
                                <span>#@card.CardNumber</span>
                                @if (card.IsDirector)
                                {
                                    <span class="badge-director ms-2">
                                        <i class="bi bi-star-fill me-1"></i>DIRECTOR
                                    </span>
                                }
                            </div>
                            <div class="status-badge @(card.IsActive ? "status-active" : "status-inactive")">
                                <i class="bi @(card.IsActive ? "bi-check-circle-fill" : "bi-pause-circle-fill")"></i>
                                @(card.IsActive ? "Active Card" : "Inactive Card")
                            </div>
                        </div>

                        @if (card.IsSyncPending)
                        {
                            <div class="sync-status-indicator pulse-slow">
                                <i class="bi bi-clock-history"></i> Pending Sync to Controller
                            </div>
                        }
                        else if (!card.IsControllerSynced)
                        {
                            <div class="sync-status-indicator" style="background: rgba(239, 68, 68, 0.1); color: #dc2626;">
                                <i class="bi bi-exclamation-triangle"></i> @(card.IsActive ? "Activation Not Confirmed" : "Deactivation Not Confirmed")
                            </div>
                        }
                        
                        <div class="card-item-body">
                            <div class="member-info-row">
                                <div class="member-avatar-small">
                                    <i class="bi bi-person-fill"></i>
                                </div>
                                <div class="flex-grow-1 min-width-0">
                                    <div class="member-name-small text-truncate">@card.MemberName</div>
                                    <div class="member-id-small">Member #@card.MemberId</div>
                                </div>
                            </div>
                            
                            @if (card.IssuedDate.HasValue)
                            {
                                <div class="card-meta">
                                    <i class="bi bi-calendar3"></i>
                                    <span>Issued @card.IssuedDate.Value.ToString("MMM dd, yyyy")</span>
                                </div>
                            }
                            
                            <div class="card-meta @(card.LastUsed.HasValue ? "" : "text-muted")">
                                <i class="bi bi-clock-history"></i>
                                <span>@(card.LastUsed.HasValue ? $"Used {GetRelativeTime(card.LastUsed.Value)}" : "Never used")</span>
                            </div>
                            
                            @if (card.IsDelinquent)
                            {
                                <div class="card-meta text-danger fw-bold">
                                    <i class="bi bi-x-circle-fill"></i>
                                    <span>DELINQUENT: Revoke Access</span>
                                </div>
                            }
                            else if (card.InGracePeriod)
                            {
                                <div class="card-meta text-warning fw-bold">
                                    <i class="bi bi-clock-history"></i>
                                    <span>Grace Period: Ends @(card.DeactivationDate?.ToString("MMM dd") ?? "Soon")</span>
                                </div>
                            }
                            else if (card.IsPaid)
                            {
                                <div class="card-meta text-success">
                                    <i class="bi bi-shield-check"></i>
                                    <span>Dues Paid for @DateTime.Today.Year</span>
                                </div>
                            }
                            else if (!card.IsActive)
                            {
                                <div class="card-meta text-muted italic">
                                    <i class="bi bi-pause-circle"></i>
                                    <span>Inactive Card</span>
                                </div>
                            }
                        </div>
                        
                        <div class="card-item-actions">
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewCard(card.CardId)">
                                <i class="bi bi-clock-history"></i> Card Activity
                            </button>
                            <button class="btn btn-sm btn-outline-info" @onclick="() => ConfigureAccess(card.MemberId)">
                                <i class="bi bi-door-open"></i> Access Rights
                            </button>
                            @if (card.IsActive)
                            {
                                <button class="btn btn-sm btn-outline-warning" @onclick="() => DeactivateCard(card.CardId)">
                                    <i class="bi bi-pause-circle"></i> Deactivate
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-success" @onclick="() => ReactivateCard(card.CardId)">
                                    <i class="bi bi-play-circle"></i> Reactivate
                                </button>
                            }
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => ReplaceCard(card.CardId)">
                                <i class="bi bi-arrow-repeat"></i> Replace
                            </button>
                        </div>


                        @* Expandable Access Rights Section *@
                        @* Debug: Selected Member ID: @_selectedMemberIdForAccess, Card Member ID: @card.MemberId *@
                        @if (_selectedMemberIdForAccess == card.MemberId)
                        {
                            <div class="access-rights-panel">
                                <div class="access-rights-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-door-open text-info me-2"></i>
                                        Configure Access Rights
                                    </h6>
                                    <button class="btn btn-sm btn-link text-muted p-0" @onclick="CloseAccessPanel">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>

                                <div class="access-rights-body">
                                    @if (_loadingAccess)
                                    {
                                        <div class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-info"></div>
                                            <p class="text-muted small mt-2 mb-0">Loading doors...</p>
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(_accessError))
                                    {
                                        <div class="alert alert-danger alert-sm mb-0">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            @_accessError
                                        </div>
                                    }
                                    else if (!_memberAccessData.Any())
                                    {
                                        <div class="alert alert-warning alert-sm mb-0">
                                            <i class="bi bi-info-circle me-1"></i>
                                            No doors available
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="door-access-list">
                                            @foreach (var access in _memberAccessData)
                                            {
                                                <div class="door-access-item">
                                                    <div class="door-info">
                                                        <i class="bi bi-door-open text-muted me-2"></i>
                                                        <div>
                                                            <div class="door-name">@access.DoorName</div>
                                                            <small class="text-muted">@access.ControllerName</small>
                                                        </div>
                                                    </div>
                                                    <div class="form-check form-switch mb-0">
                                                        <input class="form-check-input" 
                                                               type="checkbox" 
                                                               id="door_@(card.CardId)_@access.DoorId"
                                                               checked="@access.IsEnabled"
                                                               @onchange="@(e => ToggleDoorAccess(access.DoorId, (bool)e.Value!))" />
                                                        <label class="form-check-label small" for="door_@(card.CardId)_@access.DoorId">
                                                            @(access.IsEnabled ? "Enabled" : "Disabled")
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <div class="access-rights-footer">
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="CloseAccessPanel">
                                                Cancel
                                            </button>
                                            <button class="btn btn-sm btn-primary" @onclick="SaveAccessChanges" disabled="@_savingAccess">
                                                @if (_savingAccess)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                                    <span>Saving...</span>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    <span>Save & Sync</span>
                                                }
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="table-container fade-in">
                <table class="table table-hover table-modern mb-0">
                    <thead>
                        <tr>
                            <th>Card #</th>
                            <th>Member</th>
                            <th>Status</th>
                            <th>Issued</th>
                            <th>Dues Status</th>
                            <th>Last Used</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var card in _filteredCards)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="card-num-text">#@card.CardNumber</span>
                                        @if (card.IsDirector)
                                        {
                                            <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">DIR</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="member-cell">
                                        <div class="member-name-table">@card.MemberName</div>
                                        <div class="member-id-table">ID: @card.MemberId</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge @(card.IsActive ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger") border border-@(card.IsActive ? "success" : "danger") border-opacity-25 rounded-pill px-3">
                                        @(card.IsActive ? "Active Card" : "Inactive Card")
                                    </span>
                                    @if (card.IsSyncPending)
                                    {
                                        <span class="badge bg-warning-subtle text-warning border border-warning border-opacity-25 rounded-pill px-2 ms-1" style="font-size: 0.65rem;">
                                            <i class="bi bi-clock-history me-1"></i>SYNC PENDING
                                        </span>
                                    }
                                </td>
                                <td>@(card.IssuedDate?.ToString("MMM dd, yyyy") ?? "-")</td>
                                <td>
                                    @if (card.IsPaid)
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success border-opacity-25 rounded-pill px-2" style="font-size: 0.7rem;">
                                            <i class="bi bi-check-circle me-1"></i>PAID
                                        </span>
                                    }
                                    else if (card.IsDelinquent)
                                    {
                                        <div class="d-flex flex-column">
                                            <span class="badge bg-danger text-white border border-danger border-opacity-25 rounded-pill px-2" style="font-size: 0.7rem;" title="Unpaid for current and previous year">
                                                <i class="bi bi-x-circle me-1"></i>DELINQUENT
                                            </span>
                                            <small class="text-danger mt-1" style="font-size: 0.65rem;">Lockout Pending</small>
                                        </div>
                                    }
                                    else if (card.InGracePeriod)
                                    {
                                        <div class="d-flex flex-column">
                                            <span class="badge bg-warning-subtle text-warning-emphasis border border-warning border-opacity-25 rounded-pill px-2" style="font-size: 0.7rem;" title='Grace period expires on @(card.DeactivationDate?.ToString("MMM dd, yyyy") ?? "soon")'>
                                                <i class="bi bi-clock-history me-1"></i>GRACE PERIOD
                                            </span>
                                            <small class="text-warning mt-1" style="font-size: 0.65rem;">Ends @(card.DeactivationDate?.ToString("MM/dd") ?? "Soon")</small>
                                        </div>
                                    }
                                    else if (card.IsActive)
                                    {
                                        <div class="d-flex flex-column">
                                            <span class="badge bg-danger-subtle text-danger border border-danger border-opacity-25 rounded-pill px-2" style="font-size: 0.7rem;">
                                                <i class="bi bi-exclamation-triangle me-1"></i>UNPAID
                                            </span>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                                <td class="@(card.LastUsed.HasValue ? "" : "text-muted italic")">
                                    @(card.LastUsed.HasValue ? GetRelativeTime(card.LastUsed.Value) : "Never")
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" @onclick="() => ViewCard(card.CardId)" title="View Card Activity">
                                            <i class="bi bi-clock-history"></i>
                                        </button>
                                        <button class="btn btn-outline-info" @onclick="() => ConfigureAccess(card.MemberId)" title="Configure Access Rights">
                                            <i class="bi bi-door-open"></i>
                                        </button>
                                        @if (card.IsActive)
                                        {
                                            <button class="btn btn-outline-warning" @onclick="() => DeactivateCard(card.CardId)" title="Deactivate">
                                                <i class="bi bi-pause-circle"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-outline-success" @onclick="() => ReactivateCard(card.CardId)" title="Reactivate">
                                                <i class="bi bi-play-circle"></i>
                                            </button>
                                        }
                                        <button class="btn btn-outline-secondary" @onclick="() => ReplaceCard(card.CardId)" title="Replace Card">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }
    
    @* Custom Confirmation Modal *@
    @if (_showConfirmModal)
    {
        <ConfirmActionModal 
            Title="@_confirmTitle"
            Message="@_confirmMessage"
            SubMessage="@_confirmSubMessage"
            ConfirmText="@_confirmActionText"
            Type="@_confirmType"
            Icon="@_confirmIcon"
            OnConfirm="HandleConfirmedAction"
            OnCancel="() => _showConfirmModal = false" />
    }
</div>

@* Card Activity Modal Overlay *@
    @if (_showDetailModal && _selectedCard != null)
{
    @* NUCLEAR CSS FIX: Hide overlapping parent elements and reset stacking contexts *@
    <style>
        .tab-navigation-modern, .page-header-modern, .info-card-modern, .communication-alert-banner, .filters-section {
            opacity: 0.1 !important; 
            pointer-events: none !important;
            transition: none !important;
        }
        .tab-content-modern, .tab-pane {
            transform: none !important;
            animation: none !important;
            z-index: auto !important;
        }
    </style>
    <div class="activity-modal-backdrop" @onclick="CloseDetailModal"></div>
    <div class="activity-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; max-height: 85vh; background-color: #ffffff !important; opacity: 1 !important; z-index: 2147483647 !important; box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;">
        <div class="activity-modal-header">
            <div>
                <h4 class="mb-1">
                    <i class="bi bi-credit-card-2-front me-2"></i>Card #@_selectedCard.CardNumber
                </h4>
                <p class="text-muted mb-0">@_selectedCard.MemberName</p>
            </div>
            <button class="btn-close-modal" @onclick="CloseDetailModal">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        @* Fixed Stats Header *@
        <div class="activity-modal-stats" style="padding: 1rem 1.5rem; background-color: #ffffff; border-bottom: 1px solid #e2e8f0; flex-shrink: 0;">
             <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-primary">
                        <i class="bi bi-upc-scan"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Total Scans</div>
                        <div class="stat-value">@_totalScans</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-success">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Last Used</div>
                        <div class="stat-value">@(_selectedCard.LastUsed.HasValue ? GetRelativeTime(_selectedCard.LastUsed.Value) : "Never")</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-info">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Issued Date</div>
                        <div class="stat-value">@(_selectedCard.IssuedDate?.ToString("MMM dd, yyyy") ?? "Unknown")</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="activity-modal-body" style="background-color: #ffffff !important; flex: 1; overflow-y: auto;">
            @* Usage Statistics *@
            @* Usage Statistics MOVED UP - REMOVED FROM HERE *@

            @* Access History *@
            <div class="section-header mb-3">
                <i class="bi bi-door-open me-2"></i>Access History
            </div>
            @if (_cardAccessHistory == null || !_cardAccessHistory.Any())
            {
                <div class="empty-state-box mb-4">
                    <i class="bi bi-inbox"></i>
                    <p class="mb-0">No access history recorded</p>
                    <small class="text-muted">Card scans will appear here</small>
                </div>
            }
            else
            {
                <div class="access-history-list mb-4">
                    @foreach (var access in _cardAccessHistory.Take(10))
                    {
                        <div class="access-entry">
                            <div class="access-icon">
                                <i class="bi bi-door-open-fill"></i>
                            </div>
                            <div class="access-details">
                                <div class="access-location">
                                    <span class="fw-bold">@access.DoorName</span>
                                    <small class="text-muted d-block" style="font-size: 0.75rem;">@access.ControllerName</small>
                                </div>
                                <div class="access-time">@access.EventTime.ToString("MMM dd, yyyy h:mm:ss tt")</div>
                            </div>
                            <div class="access-status">
                                <span class="badge @(access.AccessGranted ? "bg-success" : "bg-danger")">
                                    @(access.AccessGranted ? "Granted" : "Denied")
                                </span>
                            </div>
                        </div>
                    }
                </div>
            }

            @* Card History (Lifecycle) *@
            @if (_cardHistory.Any())
            {
                <div class="section-header mb-3">
                    <i class="bi bi-clock-history me-2"></i>Card History
                </div>
                <div class="deactivation-list">
                    @foreach (var log in _cardHistory.OrderByDescending(l => l.DeactivatedDate))
                    {
                        var isActivation = log.Reason.Equals("Activated", StringComparison.OrdinalIgnoreCase);
                        <div class="deactivation-entry @(isActivation ? "entry-activation" : "entry-deactivation")">
                            <div class="deactivation-dot"></div>
                            <div class="deactivation-content">
                                <div class="deactivation-title">@(isActivation ? "Activated" : "Deactivated")</div>
                                <div class="deactivation-time">@log.DeactivatedDate.ToString("MMM dd, yyyy h:mm tt")</div>
                                <div class="deactivation-reason">
                                    <span class="badge @(isActivation ? "bg-success-subtle text-success" : "bg-warning text-dark")">@log.Reason</span>
                                </div>
                                @if (!string.IsNullOrEmpty(log.Notes))
                                {
                                    <div class="deactivation-notes">"@log.Notes"</div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@* Custom Confirmation Modal moved inside container *@

<style>
    /* Activity Modal Overlay */
    .activity-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        animation: fadeIn 0.2s ease;
    }

    .activity-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 800px;
        max-height: 85vh;
        background: #ffffff !important;
        opacity: 1 !important;
        border-radius: 12px;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.4);
        z-index: 10010;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255,255,255,0.1);
    }

    .activity-modal-header {
        padding: 1.25rem 1.5rem;
        background: white;
        color: #1e293b;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e2e8f0;
    }

    .activity-modal-header h4 {
        color: #1e293b;
        font-weight: 700;
        font-size: 1.1rem;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .btn-close-modal {
        background: #f1f5f9;
        border: none;
        color: #64748b;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 1.25rem;
    }

    .btn-close-modal:hover {
        background: #e2e8f0;
        color: #0f172a;
        transform: scale(1.05);
    }

    .activity-modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
        background: #f8fafc;
        border-radius: 0 0 12px 12px;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .stat-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .stat-icon {
        width: 42px;
        height: 42px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .stat-label {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #0f172a;
    }

    /* Section Headers */
    .section-header {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #475569;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Access History List */
    .access-history-list {
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .access-entry {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1rem;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f5f9;
        align-items: center;
    }

    .access-entry:last-child {
        border-bottom: none;
    }

    .access-icon {
        width: 32px;
        height: 32px;
        background: #f1f5f9;
        color: #64748b;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .access-location {
        font-weight: 600;
        color: #334155;
        font-size: 0.9rem;
    }

    .access-time {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    /* Deactivation List */
    .deactivation-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .deactivation-entry {
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        gap: 1rem;
        border: 1px solid transparent;
    }

    .entry-deactivation {
        background: #fff1f2;
        border-color: #fecdd3;
    }

    .entry-activation {
        background: #f0fdf4;
        border-color: #bbf7d0;
    }

    .deactivation-title {
        font-weight: 700;
        font-size: 0.95rem;
    }

    .entry-deactivation .deactivation-title { color: #9f1239; }
    .entry-activation .deactivation-title { color: #166534; }
    
    .deactivation-time {
        font-size: 0.75rem;
        opacity: 0.8;
    }


    .entry-deactivation .deactivation-time { color: #be123c; }
    .entry-activation .deactivation-time { color: #15803d; }

    /* Access Rights Floating Card */
    .access-rights-panel {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 0.5rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 100;
        animation: slideDown 0.2s ease-out;
    }

    .access-rights-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        background: linear-gradient(to bottom, #f8fafc, white);
        border-radius: 12px 12px 0 0;
    }

    .access-rights-header h6 {
        font-size: 0.9rem;
        font-weight: 600;
        color: #334155;
    }

    .access-rights-body {
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .door-access-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .door-access-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .door-access-item:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .door-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .door-name {
        font-weight: 600;
        font-size: 0.85rem;
        color: #334155;
    }

    .access-rights-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        padding: 1rem;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        border-radius: 0 0 12px 12px;
    }

    .card-item {
        position: relative;
    }



    @@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes slideUp { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }
</style>

@code {
    private bool _loading = true;
    private string _searchTerm = string.Empty;
    private string _statusFilter = "all";
    private string _typeFilter = "all";
    private string _eligibilityFilter = "all";
    private string _errorMessage = string.Empty;
    
    // Confirmation Modal State
    private bool _showConfirmModal = false;
    private string _confirmTitle = "";
    private string _confirmMessage = "";
    private string _confirmSubMessage = "";
    private string _confirmActionText = "";
    private string _confirmIcon = "";
    private ConfirmActionModal.ConfirmType _confirmType;
    private Func<Task>? _confirmAction;
    private string _viewMode = "grid"; // New: Toggle between 'grid' and 'list'
    
    private int _totalCards = 0;
    private int _activeCards = 0;
    private int _inactiveCards = 0;
    private int _membersWithCards = 0;
    private int _membersNeedingCards = 0;
    
    private List<CardListItem> _allCards = new();
    private List<CardListItem> _filteredCards = new();
    
    private CardListItem? _selectedCard;
    private List<CardDeactivationLog> _cardHistory = new();
    private List<CardAccessEvent> _cardAccessHistory = new();
    private int _totalScans = 0;
    private bool _showDetailModal;

    // Access Rights Modal State
    private int _selectedMemberIdForAccess = 0;
    private string _selectedMemberForAccess = string.Empty;
    private bool _loadingAccess = false;
    private bool _savingAccess = false;
    private string _accessError = string.Empty;
    private List<MemberDoorAccessDto> _memberAccessData = new();
    
    // Auto-refresh timer
    private CancellationTokenSource? _refreshCts;
    
    private void SetViewMode(string mode)
    {
        _viewMode = mode;
        StateHasChanged();
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadCardsAsync();
        _ = StartStatusRefresh();
    }
    
    private async Task StartStatusRefresh()
    {
        _refreshCts?.Cancel();
        _refreshCts = new CancellationTokenSource();
        var token = _refreshCts.Token;

        try
        {
            while (!token.IsCancellationRequested)
            {
                await Task.Delay(10000, token); // Refresh every 10s
                
                // We only want to refresh if there are pending syncs to avoid unnecessary DB load
                if (_allCards.Any(c => c.IsSyncPending || !c.IsControllerSynced))
                {
                    await LoadCardsAsync();
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (TaskCanceledException) { }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in CardAssignmentsTab auto-refresh");
        }
    }

    public void Dispose()
    {
        _refreshCts?.Cancel();
        _refreshCts?.Dispose();
    }
    
    private async Task LoadCardsAsync()
    {
        _loading = true;
        _errorMessage = string.Empty;
        var swTotal = System.Diagnostics.Stopwatch.StartNew();
        var swStep = new System.Diagnostics.Stopwatch();
        
        try
        {
            var year = DateTime.Today.Year;
            
            // 1. Load Cards First - This is the driver
            swStep.Start();
            var cards = await Task.Run(() => KeyCardRepository.GetAll());
            
            // Get unique MemberIDs from the cards to filter subsequent queries
            var cardMemberIds = cards.Select(c => c.MemberId).Distinct().ToHashSet();
            swStep.Stop();
            Logger.LogInformation("Performance Trace: Loaded {count} cards in {ms}ms", cards.Count, swStep.ElapsedMilliseconds);
            swStep.Reset();
            
            // 2. Load RELATED data only (filtered by MemberID)
            swStep.Start();
            
            // EXECUTE SEQUENTIALLY on Background Thread
            // sequential = avoids pool exhaustion
            // Task.Run = avoids UI freeze
            
            var settings = await Task.Run(() => DuesYearSettingsRepository.GetSettingsForYear(year));
            var membersList = await Task.Run(() => MemberRepository.GetAllMembers()); 
            var duesCurrent = await Task.Run(() => DuesRepository.GetDuesForYear(year));
            var duesPrev = await Task.Run(() => DuesRepository.GetDuesForYear(year - 1));
            var boardCurrentList = await Task.Run(() => BoardRepository.GetAssignmentsByYear(year));
            var boardPrevList = await Task.Run(() => BoardRepository.GetAssignmentsByYear(year - 1));
            
            // SyncQueue might be locked by background worker, so we await it safely
            var pendingSyncs = await SyncQueueRepository.GetByStatusAsync("PENDING");
            var processingSyncs = await SyncQueueRepository.GetByStatusAsync("PROCESSING");

            // Filter maps to only relevant members
            var members = membersList
                            .Where(m => cardMemberIds.Contains(m.MemberID))
                            .ToDictionary(m => m.MemberID);
                            
            var duesCurrentMap = duesCurrent
                                .Where(d => cardMemberIds.Contains(d.MemberID))
                                .ToDictionary(d => d.MemberID);
                                
            var duesPrevMap = duesPrev
                                .Where(d => cardMemberIds.Contains(d.MemberID))
                                .ToDictionary(d => d.MemberID);
                                
            var boardCurrent = boardCurrentList
                                .Where(a => cardMemberIds.Contains(a.MemberID))
                                .Select(a => a.MemberID).ToHashSet();
                                
            var boardPrev = boardPrevList
                                .Where(a => cardMemberIds.Contains(a.MemberID))
                                .Select(a => a.MemberID).ToHashSet();
                                
            var pendingCardIds = pendingSyncs.Concat(processingSyncs)
                                .Select(x => x.KeyCardId).ToHashSet();
                                
            swStep.Stop();
            Logger.LogInformation("Performance Trace: Related data loaded/filtered in {ms}ms", swStep.ElapsedMilliseconds);
            swStep.Reset();

            // 3. Fetch last used dates from ControllerEvents - CRITICAL FIX
            swStep.Start();
            var cardNumbers = cards.Select(c => long.TryParse(c.CardNumber, out var val) ? (long?)val : null)
                                   .Where(v => v.HasValue).Select(v => v!.Value).ToList();
            
            var lastUsedMap = new Dictionary<long, DateTime>();
            if (cardNumbers.Any())
            {
                using var db = await DbContextFactory.CreateDbContextAsync();
                
                // RAW SQL to prevent EF Timeout
                var sql = @"
                    SELECT CardNumber, MAX(TimestampUtc) as LastUsed
                    FROM ControllerEvents WITH (NOLOCK)
                    WHERE CardNumber IS NOT NULL
                    GROUP BY CardNumber";
                    
                try
                {
                    // Use DTO defined at bottom of file
                    var allResults = await db.Database.SqlQueryRaw<CardLastUsedDto>(sql)
                        .AsNoTracking()
                        .ToListAsync();
                    
                    var cardNumberSet = cardNumbers.ToHashSet();
                    lastUsedMap = allResults
                        .Where(r => cardNumberSet.Contains(r.CardNumber))
                        .ToDictionary(x => x.CardNumber, x => x.LastUsed);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error loading ControllerEvents");
                }
            }
            swStep.Stop();
            Logger.LogInformation("Performance Trace: Event log query took {ms}ms", swStep.ElapsedMilliseconds);
            swStep.Reset();

            // 4. Project to ViewModel
            swStep.Start();
            _allCards = cards.Select(c => {
                members.TryGetValue(c.MemberId, out var member);
                
                long? cardNumberLong = long.TryParse(c.CardNumber, out long val) ? val : null;
                DateTime? lastUsed = (cardNumberLong.HasValue && lastUsedMap.TryGetValue(cardNumberLong.Value, out var lu)) ? lu : null;

                bool currentSatisfied = boardCurrent.Contains(c.MemberId) || (duesCurrentMap.TryGetValue(c.MemberId, out var dc) && KeyCardService.IsDuesSatisfied(dc.PaymentType, dc.PaidDate));
                bool prevSatisfied = boardPrev.Contains(c.MemberId) || (duesPrevMap.TryGetValue(c.MemberId, out var dp) && KeyCardService.IsDuesSatisfied(dp.PaymentType, dp.PaidDate));

                var eligibility = member != null 
                    ? KeyCardService.GetEligibilityBulk(member, year, settings, currentSatisfied, prevSatisfied)
                    : new KeyCardEligibilityResult(false, false, false, false, false, null, "UNKNOWN");

                return new CardListItem
                {
                    CardId = c.KeyCardId,
                    CardNumber = c.CardNumber,
                    MemberId = c.MemberId,
                    MemberName = member != null ? $"{member.FirstName} {member.LastName}" : "Unknown",
                    IsActive = c.IsActive,
                    IssuedDate = c.CreatedDate == DateTime.MinValue ? null : c.CreatedDate,
                    LastUsed = lastUsed,
                    CardType = c.CardType ?? "Card",
                    IsEligible = eligibility.Eligible,
                    IsDirector = boardCurrent.Contains(c.MemberId),
                    IsSyncPending = pendingCardIds.Contains(c.KeyCardId),
                    IsControllerSynced = c.IsControllerSynced,
                    LastControllerSyncDate = c.LastControllerSyncDate,
                    IsPaid = eligibility.CurrentYearSatisfied,
                    DeactivationDate = eligibility.GraceEndDate,
                    IsDelinquent = !eligibility.Eligible && !eligibility.GracePeriodActive,
                    InGracePeriod = eligibility.GracePeriodActive && eligibility.PreviousYearSatisfied && !eligibility.CurrentYearSatisfied
                };
            }).ToList();
            
            swStep.Stop();
            Logger.LogInformation("Performance Trace: Projection loop took {ms}ms", swStep.ElapsedMilliseconds);
            
            // NOTE: Removed costly _membersNeedingCards calculation to ensure performance.
            // It required iterating over ALL members, which defeats the purpose of optimization.
            _membersNeedingCards = 0;
            
            UpdateMetrics();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading cards");
            _errorMessage = "Failed to load key cards. Please try again.";
        }
        finally
        {
            _loading = false;
            swTotal.Stop();
            Logger.LogInformation("Performance Trace: TOTAL LoadCardsAsync took {ms}ms", swTotal.ElapsedMilliseconds);
            StateHasChanged();
        }
    }
    
    private void UpdateMetrics()
    {
        _totalCards = _allCards.Count;
        _activeCards = _allCards.Count(c => c.IsActive);
        _inactiveCards = _allCards.Count(c => !c.IsActive);
        _membersWithCards = _allCards.Select(c => c.MemberId).Distinct().Count();
    }
    
    private void ApplyFilters()
    {
        var query = _allCards.AsEnumerable();
        
        // Search filter
        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            var search = _searchTerm.ToLower();
            query = query.Where(c =>
                (c.CardNumber != null && c.CardNumber.ToLower().Contains(search)) ||
                (c.MemberName != null && c.MemberName.ToLower().Contains(search)) ||
                c.MemberId.ToString().Contains(search));
        }
        
        // Status filter
        query = _statusFilter switch
        {
            "active" => query.Where(c => c.IsActive),
            "inactive" => query.Where(c => !c.IsActive),
            "unpaid" => query.Where(c => !c.IsPaid && c.IsActive),
            "delinquent" => query.Where(c => c.IsDelinquent && c.IsActive),
            _ => query
        };
        
        // Type filter
        if (_typeFilter != "all")
        {
            query = query.Where(c => c.CardType == _typeFilter);
        }

        // Eligibility filter
        if (_eligibilityFilter != "all")
        {
             query = _eligibilityFilter == "eligible" 
                ? query.Where(c => c.IsEligible) 
                : query.Where(c => !c.IsEligible);
        }
        
        _filteredCards = query.OrderByDescending(c => c.IssuedDate).ToList();
    }
    
    private void ClearSearch()
    {
        _searchTerm = string.Empty;
        ApplyFilters();
    }
    
    private void SetStatusFilter(string filter)
    {
        _statusFilter = filter;
        ApplyFilters();
    }
    
    private async Task DeactivateCard(int cardId)
    {
        var card = _allCards.FirstOrDefault(c => c.CardId == cardId);
        if (card == null) return;
        
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User.Identity?.Name ?? "Unknown";

        _confirmTitle = "Confirm Deactivation";
        _confirmMessage = $"Are you sure you want to DEACTIVATE Card #{card.CardNumber} for {card.MemberName}?";
        _confirmSubMessage = "This will immediately disable their door access and lock them out of the facility.";
        _confirmActionText = "Confirm Deactivate";
        _confirmType = ConfirmActionModal.ConfirmType.Danger;
        _confirmIcon = "bi-lock-fill";
        _confirmAction = async () => 
        {
            await LifecycleService.DeactivateCardAsync(cardId, "Manual", "Deactivated from management console", performedBy: user);
            Logger.LogInformation("Card {CardId} deactivated manually by {User}", cardId, user);
            await LoadCardsAsync();
        };
        _showConfirmModal = true;
    }

    private async Task HandleConfirmedAction()
    {
        if (_confirmAction != null)
        {
            try
            {
                _showConfirmModal = false;
                StateHasChanged();
                await _confirmAction();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error performing confirmed action");
                _errorMessage = $"Operation failed: {ex.Message}";
            }
            finally
            {
                StateHasChanged();
            }
        }
    }
    
    private async Task ViewCard(int cardId)
    {
        try
        {
            var card = _allCards.FirstOrDefault(c => c.CardId == cardId);
            if (card == null) return;
            
            _selectedCard = card;
            
            // Load deactivation history
            _cardHistory = await Task.Run(() => DeactivationLogRepository.GetByCardIdAsync(cardId));
            
            // Load access history from ControllerEvent table
            _cardAccessHistory = new List<CardAccessEvent>();
            _totalScans = 0;
            using var db = await DbContextFactory.CreateDbContextAsync();
            if (long.TryParse(card.CardNumber, out long cardNumberLong))
            {
                 var query = db.ControllerEvents.Where(e => e.CardNumber == cardNumberLong);
                 _totalScans = await query.CountAsync();

                 var events = await query
                    .OrderByDescending(e => e.TimestampUtc)
                    .Take(20)
                    .Include(e => e.Controller)
                    .Include(e => e.Door) // Added Include
                    .ToListAsync();

                 _cardAccessHistory = events.Select(e => new CardAccessEvent
                 {
                     EventTime = e.TimestampUtc, 
                     ControllerName = e.Controller?.Name ?? "Unknown Controller",
                     DoorName = e.Door?.Name ?? (e.RawData != null && e.RawData.Contains("DOOR:0") ? "Main Entry (Door 1)" : "Unknown Door"),
                     AccessGranted = e.EventType == 1 // 1 = Granted, 2 = Denied (from ControllerEventType)
                 }).ToList();
            }
            
            _showDetailModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading card details for {CardId}", cardId);
        }
    }
    
    private void CloseDetailModal()
    {
        _showDetailModal = false;
        _selectedCard = null;
        _cardHistory.Clear();
        _cardAccessHistory.Clear();
        StateHasChanged();
    }
    
    private async Task ReactivateCard(int cardId)
    {
        // Check if member already has another active card
        var card = _allCards.FirstOrDefault(c => c.CardId == cardId);
        if (card == null) return;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User.Identity?.Name ?? "Unknown";

        var memberActiveCard = _allCards.FirstOrDefault(c => 
            c.MemberId == card.MemberId && c.IsActive && c.CardId != cardId);
        
        if (memberActiveCard != null)
        {
            _errorMessage = $"Member already has an active card (#{memberActiveCard.CardNumber}). Please deactivate it first.";
            return;
        }
        
        _confirmTitle = "Confirm Reactivation";
        _confirmMessage = $"Are you sure you want to REACTIVATE Card #{card.CardNumber} for {card.MemberName}?";
        _confirmSubMessage = "Access will be restored once synchronized with the hardware controller.";
        _confirmActionText = "Confirm Reactivate";
        _confirmType = ConfirmActionModal.ConfirmType.Info;
        _confirmIcon = "bi-unlock-fill";
        _confirmAction = async () => 
        {
            await LifecycleService.ReactivateCardAsync(cardId, "Manual reactivation from console", performedBy: user);
            Logger.LogInformation("Card {CardId} reactivated manually by {User}", cardId, user);
            await LoadCardsAsync();
        };
        _showConfirmModal = true;
    }
    
    [Parameter] public EventCallback<int> OnReplaceCard { get; set; }
    [Parameter] public EventCallback OnNeedingCardsClick { get; set; }

    private void HandleNeedingCardsClick()
    {
        if (OnNeedingCardsClick.HasDelegate)
        {
            OnNeedingCardsClick.InvokeAsync();
        }
    }

    private async Task ReplaceCard(int cardId)
    {
        if (OnReplaceCard.HasDelegate)
        {
            await OnReplaceCard.InvokeAsync(cardId);
        }
    }
    
    
    private void ConfigureAccess(int memberId)
    {
        try
        {
            Logger.LogInformation("ConfigureAccess called for member {MemberId}", memberId);
            
            _selectedMemberIdForAccess = memberId;
            var card = _allCards.FirstOrDefault(c => c.MemberId == memberId);
            _selectedMemberForAccess = card?.MemberName ?? $"Member #{memberId}";
            
            _loadingAccess = true;
            _accessError = string.Empty;
            _memberAccessData.Clear();
            
            Logger.LogInformation("Panel should now be visible for member {MemberId}", memberId);
            
            // Load data asynchronously without blocking
            _ = LoadAccessDataAsync(memberId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in ConfigureAccess for member {MemberId}", memberId);
        }
    }

    private async Task LoadAccessDataAsync(int memberId)
    {
        try
        {
            var response = await MemberAccessService.GetMemberDoorAccessAsync(memberId);
            _memberAccessData = response.Access.ToList();
            Logger.LogInformation("Loaded {Count} doors for member {MemberId}", _memberAccessData.Count, memberId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load door access for member {MemberId}", memberId);
            _accessError = "Failed to load door access. Please try again.";
        }
        finally
        {
            _loadingAccess = false;
            StateHasChanged();
        }
    }

    private void CloseAccessPanel()
    {
        _selectedMemberIdForAccess = 0;
        _selectedMemberForAccess = string.Empty;
        _memberAccessData.Clear();
        _accessError = string.Empty;
    }

    private void ToggleDoorAccess(int doorId, bool isEnabled)
    {
        var access = _memberAccessData.FirstOrDefault(a => a.DoorId == doorId);
        if (access != null)
        {
            access.IsEnabled = isEnabled;
        }
    }

    private async Task SaveAccessChanges()
    {
        _savingAccess = true;
        _accessError = string.Empty;
        
        try
        {
            Logger.LogInformation("SaveAccessChanges started for member {MemberId}", _selectedMemberIdForAccess);
            
            // Get the member's active card number
            var memberCard = _allCards.FirstOrDefault(c => c.MemberId == _selectedMemberIdForAccess && c.IsActive);
            if (memberCard == null)
            {
                _accessError = "No active card found for this member.";
                Logger.LogWarning("No active card found for member {MemberId}", _selectedMemberIdForAccess);
                return;
            }

            // Check if member is eligible
            if (!memberCard.IsEligible)
            {
                _accessError = "This member is not eligible for door access. Please check membership status and dues payment.";
                Logger.LogWarning("Member {MemberId} is not eligible for door access", _selectedMemberIdForAccess);
                return;
            }

            Logger.LogInformation("Found active card {CardNumber} for member {MemberId}", memberCard.CardNumber, _selectedMemberIdForAccess);

            var updates = _memberAccessData.Select(a => new MemberDoorAccessUpdateDto
            {
                DoorId = a.DoorId,
                CardNumber = memberCard.CardNumber,
                IsEnabled = a.IsEnabled,
                TimeProfileId = a.TimeProfileId
            }).ToList();

            Logger.LogInformation("Updating {Count} door access entries", updates.Count);

            await MemberAccessService.UpdateMemberDoorAccessAsync(_selectedMemberIdForAccess, updates);
            Logger.LogInformation("UpdateMemberDoorAccessAsync completed");
            
            await MemberAccessService.SyncMemberPrivilegesAsync(_selectedMemberIdForAccess);
            Logger.LogInformation("SyncMemberPrivilegesAsync completed");
            
            Logger.LogInformation("Successfully updated door access for member {MemberId}", _selectedMemberIdForAccess);
            CloseAccessPanel();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save door access for member {MemberId}. Error: {Message}", _selectedMemberIdForAccess, ex.Message);
            _accessError = $"Failed to save changes: {ex.Message}";
        }
        finally
        {
            _savingAccess = false;
            StateHasChanged();
        }
    }

    private async Task ExportCards()
    {
        try 
        {
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("CardNumber,MemberId,MemberName,Status,Type,Eligible,IssuedDate");
            
            foreach (var card in _filteredCards)
            {
                csv.AppendLine($"{card.CardNumber},{card.MemberId},{card.MemberName},{card.IsActive},{card.CardType},{card.IsEligible},{card.IssuedDate:yyyy-MM-dd}");
            }
            
            var fileName = $"keycards_export_{DateTime.Now:yyyyMMdd}.csv";
            await JSRuntime.InvokeVoidAsync("blazorInterop.downloadFile", fileName, "text/csv", csv.ToString());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Export failed");
            _errorMessage = "Export failed.";
        }
    }
    
    private string GetRelativeTime(DateTime date)
    {
        var span = DateTime.Now - date;
        if (span.TotalMinutes < 1) return "just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays}d ago";
        return date.ToString("MMM dd");
    }
    
    private class CardListItem
    {
        public int CardId { get; set; }
        public string CardNumber { get; set; } = string.Empty;
        public int MemberId { get; set; }
        public string MemberName { get; set; } = string.Empty;
        public bool IsActive { get; set; }
        public DateTime? IssuedDate { get; set; }
        public DateTime? LastUsed { get; set; }
        public string CardType { get; set; } = "Card";
        public bool IsEligible { get; set; }
        public bool IsDirector { get; set; }
        public bool IsSyncPending { get; set; }
        public bool IsControllerSynced { get; set; }
        public DateTime? LastControllerSyncDate { get; set; }
        public bool IsPaid { get; set; }
        public DateTime? DeactivationDate { get; set; }
        public bool IsDelinquent { get; set; }
        public bool InGracePeriod { get; set; }
    }
    
    private class CardAccessEvent
    {
        public DateTime EventTime { get; set; }
        public string ControllerName { get; set; } = string.Empty;
        public string DoorName { get; set; } = string.Empty; // Added
        public bool AccessGranted { get; set; }
    }
    
    // DTO for optimized raw SQL query
    public class CardLastUsedDto
    {
        public long CardNumber { get; set; }
        public DateTime LastUsed { get; set; }
    }
}
