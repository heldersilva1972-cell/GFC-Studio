@using GFC.Core.Interfaces
@using GFC.Core.Models
@inject IKeyCardRepository KeyCardRepository
@inject IMemberRepository MemberRepository
@inject IBoardRepository BoardRepository
@inject IDuesInsightService DuesInsightService
@inject ICardDeactivationLogRepository DeactivationLogRepository
@inject ILogger<CardAssignmentsTab> Logger
@inject IJSRuntime JSRuntime

<div class="assignments-container">
    <!-- Summary Metrics -->
    <div class="metrics-grid slide-in-up">
        <div class="metric-card metric-primary">
            <div class="metric-icon">
                <i class="bi bi-credit-card-2-front-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Total Cards</div>
                <div class="metric-value">@_totalCards</div>
            </div>
        </div>
        
        <div class="metric-card metric-success">
            <div class="metric-icon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Active</div>
                <div class="metric-value">@_activeCards</div>
            </div>
        </div>
        
        <div class="metric-card metric-warning">
            <div class="metric-icon">
                <i class="bi bi-pause-circle-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Inactive</div>
                <div class="metric-value">@_inactiveCards</div>
            </div>
        </div>
        
        <div class="metric-card metric-info">
            <div class="metric-icon">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Members with Cards</div>
                <div class="metric-value">@_membersWithCards</div>
            </div>
        </div>

        <div class="metric-card metric-danger" @onclick="HandleNeedingCardsClick">
            <div class="metric-icon">
                <i class="bi bi-person-exclamation"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Needing Cards</div>
                <div class="metric-value">@_membersNeedingCards</div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-section slide-in-up" style="animation-delay: 0.1s;">
        <div class="search-filter-bar">
            <div class="search-box-large">
                <i class="bi bi-search"></i>
                <input type="text" 
                       class="form-control" 
                       placeholder="Search by card number, member name, or ID..."
                       @bind="_searchTerm"
                       @bind:event="oninput"
                       @bind:after="ApplyFilters" />
                @if (!string.IsNullOrEmpty(_searchTerm))
                {
                    <button class="btn-clear" @onclick="ClearSearch">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
            </div>
            
            <div class="filter-pills">
                <button class="filter-pill @(_statusFilter == "all" ? "active" : "")" 
                        @onclick='() => SetStatusFilter("all")'>
                    All Cards
                </button>
                <button class="filter-pill @(_statusFilter == "active" ? "active" : "")" 
                        @onclick='() => SetStatusFilter("active")'>
                    <i class="bi bi-check-circle"></i> Active
                </button>
                <button class="filter-pill @(_statusFilter == "inactive" ? "active" : "")" 
                        @onclick='() => SetStatusFilter("inactive")'>
                    <i class="bi bi-pause-circle"></i> Inactive
                </button>
                <button class="filter-pill filter-pill-danger" @onclick="HandleNeedingCardsClick">
                    <i class="bi bi-person-badge"></i> Needing Cards
                    @if (_membersNeedingCards > 0)
                    {
                        <span class="badge bg-danger ms-1">@_membersNeedingCards</span>
                    }
                </button>
            </div>

            <div class="d-flex align-items-center gap-2 ms-auto">
                <div class="view-toggle">
                    <button class="btn-toggle @(_viewMode == "grid" ? "active" : "")" @onclick='() => SetViewMode("grid")' title="Grid View">
                        <i class="bi bi-grid-3x3-gap-fill"></i>
                    </button>
                    <button class="btn-toggle @(_viewMode == "list" ? "active" : "")" @onclick='() => SetViewMode("list")' title="List View">
                        <i class="bi bi-list-ul"></i>
                    </button>
                </div>
                <button class="btn btn-outline-secondary" @onclick="ExportCards" title="Export to CSV">
                    <i class="bi bi-download"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    @if (_loading)
    {
        <div class="loading-state">
            <div class="spinner-modern">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <p>Loading cards...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger slide-in-up">
            <i class="bi bi-exclamation-triangle"></i> @_errorMessage
        </div>
    }
    else if (!_filteredCards.Any())
    {
        <div class="empty-state slide-in-up">
            <div class="empty-icon">
                <i class="bi bi-inbox"></i>
            </div>
            <h3>No Cards Found</h3>
            <p>@(_searchTerm.Length > 0 ? "Try adjusting your search or filters" : "Get started by assigning a new key card")</p>
        </div>
    }
    else
    {
        @if (_viewMode == "grid")
        {
            <div class="cards-grid">
                @foreach (var card in _filteredCards)
                {
                    <div class="card-item fade-in">
                        <div class="card-item-header">
                            <div class="card-number-badge">
                                <i class="bi bi-credit-card-2-front"></i>
                                <span>#@card.CardNumber</span>
                                @if (card.IsDirector)
                                {
                                    <span class="badge bg-warning text-dark ms-2" style="font-size: 0.7rem; letter-spacing: 0.5px;">
                                        <i class="bi bi-star-fill me-1"></i>DIRECTOR
                                    </span>
                                }
                            </div>
                            <div class="status-badge @(card.IsActive ? "status-active" : "status-inactive")">
                                <i class="bi @(card.IsActive ? "bi-check-circle-fill" : "bi-pause-circle-fill")"></i>
                                @(card.IsActive ? "Active" : "Inactive")
                            </div>
                        </div>
                        
                        <div class="card-item-body">
                            <div class="member-info-row">
                                <div class="member-avatar-small">
                                    <i class="bi bi-person-fill"></i>
                                </div>
                                <div class="flex-grow-1 min-width-0">
                                    <div class="member-name-small text-truncate">@card.MemberName</div>
                                    <div class="member-id-small">Member #@card.MemberId</div>
                                </div>
                            </div>
                            
                            @if (card.IssuedDate.HasValue)
                            {
                                <div class="card-meta">
                                    <i class="bi bi-calendar3"></i>
                                    <span>Issued @card.IssuedDate.Value.ToString("MMM dd, yyyy")</span>
                                </div>
                            }
                            
                            <div class="card-meta @(card.LastUsed.HasValue ? "" : "text-muted")">
                                <i class="bi bi-clock-history"></i>
                                <span>@(card.LastUsed.HasValue ? $"Used {GetRelativeTime(card.LastUsed.Value)}" : "Never used")</span>
                            </div>
                        </div>
                        
                        <div class="card-item-actions">
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewCard(card.CardId)">
                                <i class="bi bi-eye"></i> View
                            </button>
                            @if (card.IsActive)
                            {
                                <button class="btn btn-sm btn-outline-warning" @onclick="() => DeactivateCard(card.CardId)">
                                    <i class="bi bi-pause-circle"></i> Deactivate
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-success" @onclick="() => ReactivateCard(card.CardId)">
                                    <i class="bi bi-play-circle"></i> Reactivate
                                </button>
                            }
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => ReplaceCard(card.CardId)">
                                <i class="bi bi-arrow-repeat"></i> Replace
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="table-container fade-in">
                <table class="table table-hover table-modern mb-0">
                    <thead>
                        <tr>
                            <th>Card #</th>
                            <th>Member</th>
                            <th>Status</th>
                            <th>Issued</th>
                            <th>Last Used</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var card in _filteredCards)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="card-num-text">#@card.CardNumber</span>
                                        @if (card.IsDirector)
                                        {
                                            <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">DIR</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="member-cell">
                                        <div class="member-name-table">@card.MemberName</div>
                                        <div class="member-id-table">ID: @card.MemberId</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge @(card.IsActive ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger") border border-@(card.IsActive ? "success" : "danger") border-opacity-25 rounded-pill px-3">
                                        @(card.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>@(card.IssuedDate?.ToString("MMM dd, yyyy") ?? "-")</td>
                                <td class="@(card.LastUsed.HasValue ? "" : "text-muted italic")">
                                    @(card.LastUsed.HasValue ? GetRelativeTime(card.LastUsed.Value) : "Never")
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" @onclick="() => ViewCard(card.CardId)" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        @if (card.IsActive)
                                        {
                                            <button class="btn btn-outline-warning" @onclick="() => DeactivateCard(card.CardId)" title="Deactivate">
                                                <i class="bi bi-pause-circle"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-outline-success" @onclick="() => ReactivateCard(card.CardId)" title="Reactivate">
                                                <i class="bi bi-play-circle"></i>
                                            </button>
                                        }
                                        <button class="btn btn-outline-secondary" @onclick="() => ReplaceCard(card.CardId)" title="Replace Card">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }
</div>

<!-- Card Detail Modal -->
@if (_showDetailModal && _selectedCard != null)
{
    <div class="modal-backdrop-modern fade-in" @onclick="CloseDetailModal"></div>
    <div class="modal-modern-container fade-in scale-in">
        <div class="modal-modern">
            <div class="modal-header-modern">
                <div>
                    <h3 class="modal-title-modern">
                        <i class="bi bi-credit-card-2-front text-primary"></i>
                        Card Details
                    </h3>
                    <p class="modal-subtitle">@_selectedCard.CardType #@_selectedCard.CardNumber</p>
                </div>
                <button class="btn-close-modern" @onclick="CloseDetailModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="modal-body-modern">
                <div class="detail-card mb-4">
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="text-muted small">Status</label>
                            <div>
                                <span class="badge bg-@(_selectedCard.IsActive ? "success" : "danger")-subtle text-@(_selectedCard.IsActive ? "success" : "danger")">
                                    @(_selectedCard.IsActive ? "Active" : "Inactive")
                                </span>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="text-muted small">Assigned Member</label>
                            <div class="fw-bold">@_selectedCard.MemberName</div>
                        </div>
                        <div class="col-6">
                            <label class="text-muted small">Issued Date</label>
                            <div>@(_selectedCard.IssuedDate?.ToString("MMM dd, yyyy") ?? "-")</div>
                        </div>
                        <div class="col-6">
                            <label class="text-muted small">Eligibility</label>
                            <div>
                                @if (_selectedCard.IsEligible)
                                {
                                    <span class="text-success"><i class="bi bi-check-circle"></i> Eligible</span>
                                }
                                else
                                {
                                    <span class="text-danger"><i class="bi bi-x-circle"></i> Ineligible (Unpaid)</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6 class="mb-3">History <span class="badge bg-light text-dark ms-2">Real</span></h6>
                <div class="history-timeline">
                    <!-- Initial Assignment -->
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <div class="fw-bold">Issued</div>
                            <div class="small text-muted">@(_selectedCard.IssuedDate?.ToString("MMM dd, yyyy") ?? "Unknown Date") - Active</div>
                        </div>
                    </div>
                    
                    @foreach (var log in _cardHistory)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger"></div>
                            <div class="timeline-content">
                                <div class="fw-bold">Deactivated</div>
                                <div class="small text-muted">@log.DeactivatedDate.ToString("MMM dd") - @log.Reason</div>
                                @if (!string.IsNullOrEmpty(log.Notes))
                                {
                                    <div class="small text-muted fst-italic">"@log.Notes"</div>
                                }
                            </div>
                        </div>
                    }

                    @if (_cardHistory.Count == 0 && !_selectedCard.IsActive)
                    {
                         <div class="timeline-item">
                            <div class="timeline-marker bg-secondary"></div>
                            <div class="timeline-content">
                                <div class="text-muted">Status changed to Inactive (No log entry)</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <div class="modal-footer-modern">
                <button class="btn btn-outline-secondary" @onclick="CloseDetailModal">Close</button>
                    @if (_selectedCard.IsActive)
                {
                    <button class="btn btn-warning" @onclick="() => DeactivateCard(_selectedCard.CardId)">Deactivate</button>
                }
                else
                {
                    <button class="btn btn-success" @onclick="() => ReactivateCard(_selectedCard.CardId)">Reactivate</button>
                }
            </div>
        </div>
    </div>
}

@code {
    private bool _loading = true;
    private string _searchTerm = string.Empty;
    private string _statusFilter = "all";
    private string _typeFilter = "all";
    private string _eligibilityFilter = "all";
    private string _errorMessage = string.Empty;
    private string _viewMode = "grid"; // New: Toggle between 'grid' and 'list'
    
    private int _totalCards = 0;
    private int _activeCards = 0;
    private int _inactiveCards = 0;
    private int _membersWithCards = 0;
    private int _membersNeedingCards = 0;
    
    private List<CardListItem> _allCards = new();
    private List<CardListItem> _filteredCards = new();

    private void SetViewMode(string mode)
    {
        _viewMode = mode;
        StateHasChanged();
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadCardsAsync();
    }
    
    private async Task LoadCardsAsync()
    {
        _loading = true;
        _errorMessage = string.Empty;
        
        try
        {
            // Load all key cards with member info
            var cards = await Task.Run(() => KeyCardRepository.GetAll());
            var members = await Task.Run(() => MemberRepository.GetAllMembers());
            var unpaid = await DuesInsightService.GetDuesAsync(DateTime.Today.Year, false);
            var unpaidIds = unpaid?.Select(u => u.MemberId).ToHashSet() ?? new HashSet<int>();
            
            var year = DateTime.Today.Year;
            var boardMemberIds = BoardRepository.GetAssignmentsByYear(year).Select(a => a.MemberID).ToHashSet();
            
            _allCards = cards.Select(c => {
                var member = members.FirstOrDefault(m => m.MemberID == c.MemberId);
                var isDirector = boardMemberIds.Contains(c.MemberId);
                var status = member?.Status ?? string.Empty;
                var isLife = status.Equals("LIFE", StringComparison.OrdinalIgnoreCase);
                var isReg = status.Equals("REGULAR", StringComparison.OrdinalIgnoreCase) || 
                            status.Equals("REGULAR-NP", StringComparison.OrdinalIgnoreCase);
                var isGuest = status.Equals("GUEST", StringComparison.OrdinalIgnoreCase);
                
                var isUnpaid = unpaidIds.Contains(c.MemberId);
                
                // Eligibility rule: (Life OR Reg OR Guest) AND Paid
                // Note: Guests who pay dues ARE eligible for cards.
                var isEligible = (isLife || isReg || isGuest) && !isUnpaid;

                return new CardListItem
                {
                    CardId = c.KeyCardId,
                    CardNumber = c.CardNumber,
                    MemberId = c.MemberId,
                    MemberName = member != null ? $"{member.FirstName} {member.LastName}" : "Unknown",
                    IsActive = c.IsActive,
                    IssuedDate = c.CreatedDate,
                    LastUsed = null,
                    CardType = c.CardType ?? "Card",
                    IsEligible = isEligible,
                    IsDirector = isDirector
                };
            }).ToList();
            
            // Calculate members needing cards
            var paid = await DuesInsightService.GetDuesAsync(year, true);
            var waived = await DuesInsightService.GetDuesAsync(year, false);
            var activeCardMemberIds = _allCards.Where(c => c.IsActive).Select(c => c.MemberId).ToHashSet();
            _membersNeedingCards = paid.Count(m => !activeCardMemberIds.Contains(m.MemberId)) 
                                    + waived.Count(m => (m.IsWaived || m.IsBoardMember) && !activeCardMemberIds.Contains(m.MemberId));
            
            UpdateMetrics();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading cards");
            _errorMessage = "Failed to load key cards. Please try again.";
        }
        finally
        {
            _loading = false;
        }
    }
    
    private void UpdateMetrics()
    {
        _totalCards = _allCards.Count;
        _activeCards = _allCards.Count(c => c.IsActive);
        _inactiveCards = _allCards.Count(c => !c.IsActive);
        _membersWithCards = _allCards.Select(c => c.MemberId).Distinct().Count();
    }
    
    private void ApplyFilters()
    {
        var query = _allCards.AsEnumerable();
        
        // Search filter
        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            var search = _searchTerm.ToLower();
            query = query.Where(c =>
                (c.CardNumber != null && c.CardNumber.ToLower().Contains(search)) ||
                (c.MemberName != null && c.MemberName.ToLower().Contains(search)) ||
                c.MemberId.ToString().Contains(search));
        }
        
        // Status filter
        query = _statusFilter switch
        {
            "active" => query.Where(c => c.IsActive),
            "inactive" => query.Where(c => !c.IsActive),
            _ => query
        };
        
        // Type filter
        if (_typeFilter != "all")
        {
            query = query.Where(c => c.CardType == _typeFilter);
        }

        // Eligibility filter
        if (_eligibilityFilter != "all")
        {
             query = _eligibilityFilter == "eligible" 
                ? query.Where(c => c.IsEligible) 
                : query.Where(c => !c.IsEligible);
        }
        
        _filteredCards = query.OrderByDescending(c => c.IssuedDate).ToList();
    }
    
    private void ClearSearch()
    {
        _searchTerm = string.Empty;
        ApplyFilters();
    }
    
    private void SetStatusFilter(string filter)
    {
        _statusFilter = filter;
        ApplyFilters();
    }
    
    private CardListItem? _selectedCard;
    private bool _showDetailModal;
    private List<GFC.Core.Models.CardDeactivationLog> _cardHistory = new();

    private async Task ViewCard(int cardId)
    {
        _selectedCard = _filteredCards.FirstOrDefault(c => c.CardId == cardId);
        if (_selectedCard != null)
        {
            _cardHistory = await DeactivationLogRepository.GetByCardIdAsync(cardId);
            _showDetailModal = true;
        }
    }

    private void CloseDetailModal() => _showDetailModal = false;
    
    private async Task DeactivateCard(int cardId)
    {
        try
        {
            var card = await Task.Run(() => KeyCardRepository.GetById(cardId));
            if (card == null) return;
            
            card.IsActive = false;
            await Task.Run(() => KeyCardRepository.Update(card));
            
            Logger.LogInformation("Card {CardId} deactivated", cardId);
            
            // Refresh the list
            await LoadCardsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deactivating card {CardId}", cardId);
            _errorMessage = "Failed to deactivate card. Please try again.";
        }
    }
    
    private async Task ReactivateCard(int cardId)
    {
        try
        {
            var card = await Task.Run(() => KeyCardRepository.GetById(cardId));
            if (card == null) return;
            
            // Check if member already has another active card
            var memberActiveCard = _allCards.FirstOrDefault(c => 
                c.MemberId == card.MemberId && c.IsActive && c.CardId != cardId);
            
            if (memberActiveCard != null)
            {
                _errorMessage = $"Member already has an active card (#{memberActiveCard.CardNumber}). Please deactivate it first.";
                return;
            }
            
            card.IsActive = true;
            await Task.Run(() => KeyCardRepository.Update(card));
            
            Logger.LogInformation("Card {CardId} reactivated", cardId);
            
            // Refresh the list
            await LoadCardsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error reactivating card {CardId}", cardId);
            _errorMessage = "Failed to reactivate card. Please try again.";
        }
    }
    
    [Parameter] public EventCallback<int> OnReplaceCard { get; set; }
    [Parameter] public EventCallback OnNeedingCardsClick { get; set; }

    private void HandleNeedingCardsClick()
    {
        if (OnNeedingCardsClick.HasDelegate)
        {
            OnNeedingCardsClick.InvokeAsync();
        }
    }

    private async Task ReplaceCard(int cardId)
    {
        if (OnReplaceCard.HasDelegate)
        {
            await OnReplaceCard.InvokeAsync(cardId);
        }
    }
    
    private async Task ExportCards()
    {
        try 
        {
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("CardNumber,MemberId,MemberName,Status,Type,Eligible,IssuedDate");
            
            foreach (var card in _filteredCards)
            {
                csv.AppendLine($"{card.CardNumber},{card.MemberId},{card.MemberName},{card.IsActive},{card.CardType},{card.IsEligible},{card.IssuedDate:yyyy-MM-dd}");
            }
            
            var fileName = $"keycards_export_{DateTime.Now:yyyyMMdd}.csv";
            await JSRuntime.InvokeVoidAsync("blazorInterop.downloadFile", fileName, "text/csv", csv.ToString());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Export failed");
            _errorMessage = "Export failed.";
        }
    }
    
    private string GetRelativeTime(DateTime date)
    {
        var span = DateTime.Now - date;
        if (span.TotalMinutes < 1) return "just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays}d ago";
        return date.ToString("MMM dd");
    }
    
    private class CardListItem
    {
        public int CardId { get; set; }
        public string CardNumber { get; set; } = string.Empty;
        public int MemberId { get; set; }
        public string MemberName { get; set; } = string.Empty;
        public bool IsActive { get; set; }
        public DateTime? IssuedDate { get; set; }
        public DateTime? LastUsed { get; set; }
        public string CardType { get; set; } = "Card";
        public bool IsEligible { get; set; }
        public bool IsDirector { get; set; }
    }
}
