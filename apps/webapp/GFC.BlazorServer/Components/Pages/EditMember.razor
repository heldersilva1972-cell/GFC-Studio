@page "/members/{MemberId:int}/edit"
@implements IDisposable
@using Microsoft.AspNetCore.Authorization
@using GFC.Core.Models
@using GFC.Core.Interfaces
@using GFC.Core.BusinessRules
@using System.ComponentModel.DataAnnotations
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@inject IMemberRepository MemberRepository
@inject NavigationManager NavManager
@inject ILogger<EditMember> Logger
@inject IHistoryRepository HistoryRepository
@inject IJSRuntime JSRuntime
@inject GFC.Core.Services.KeyCardLifecycleService KeyCardLifecycleService

<PageTitle>Edit Member - GFC Membership</PageTitle>

<link href="css/add-member-animations.css" rel="stylesheet" />

<style>
    .date-picker-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .date-picker-group .form-select {
        flex: 1;
        min-width: 100px;
    }

    .date-picker-group .form-select:first-child {
        min-width: 140px; /* Month dropdown */
    }

    .date-picker-group .form-select:nth-child(2) {
        min-width: 80px; /* Day dropdown */
    }

    .date-picker-group .form-select:nth-child(3) {
        min-width: 100px; /* Year dropdown */
    }

    .date-picker-group .btn {
        flex-shrink: 0;
    }
</style>

<div class="page-header mb-4">
    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-outline-secondary" @onclick="GoBack" disabled="@_saving">
            <i class="bi bi-arrow-left"></i>
        </button>
        <div>
            <h1 class="page-title mb-0">Edit Member</h1>
            @if (_loading)
            {
                <p class="text-muted mb-0">Loading member data...</p>
            }
            else if (_member != null)
            {
                <p class="text-muted mb-0">Editing: @GetFullName(_member)</p>
            }
        </div>
    </div>
</div>

@if (_loading)
{
    <div class="d-flex align-items-center gap-2 text-muted">
        <div class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></div>
        <span>Loading member details...</span>
    </div>
}
else if (_notFound)
{
    <div class="alert alert-warning">
        <strong>Member not found.</strong>
        <div class="text-muted small">Member ID @MemberId could not be loaded.</div>
        <button class="btn btn-outline-secondary mt-2" type="button" @onclick="GoBack">Back to Members</button>
    </div>
}
else if (!string.IsNullOrWhiteSpace(_loadError))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>@_loadError
        <button class="btn btn-outline-secondary mt-2" type="button" @onclick="GoBack">Back to Members</button>
    </div>
}
else if (_showSuccessAnimation)
{
    <div class="success-overlay">
        <div class="success-card">
            <div class="success-checkmark">
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <h2 class="success-title">Member Updated Successfully!</h2>
            <p class="success-message">Changes to @_memberName have been saved.</p>
            <div class="success-actions">
                <button class="btn btn-primary" @onclick="GoToMemberDetail">
                    <i class="bi bi-eye me-2"></i>View Member Details
                </button>
                <button class="btn btn-outline-primary" @onclick="GoBack">
                    <i class="bi bi-list-ul me-2"></i>Back to Members
                </button>
            </div>
        </div>
    </div>
}
else if (_showDuesPrompt)
{
    <div class="success-overlay">
        <div class="success-card">
            <div class="success-checkmark">
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <h2 class="success-title">Member Accepted!</h2>
            <p class="success-message"><strong>@_memberName</strong> has been updated with an <strong>Accepted Date</strong>.</p>
            
            <div class="alert alert-info border-0 shadow-sm mb-4" style="border-radius: 12px; background: #eef2ff; color: #3730a3; text-align: left;">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-cash-coin" style="font-size: 1.25rem;"></i>
                    <strong style="font-weight: 700;">Record Initial Payment</strong>
                </div>
                <p class="mb-0 small">Since this member is now officially accepted, would you like to record their initial dues payment now?</p>
            </div>

            <div class="success-actions d-flex flex-column gap-2">
                <button class="btn btn-primary btn-lg w-100 py-3 shadow-sm" @onclick="GoToRecordDues" style="border-radius: 14px; font-weight: 700;">
                    <i class="bi bi-cash me-2"></i>Yes, Record Dues
                </button>
                <button class="btn btn-outline-secondary w-100 py-2" @onclick="() => { _showDuesPrompt = false; _showSuccessAnimation = true; }" style="border-radius: 12px; border-style: dashed;">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>
}
else if (_memberForm != null)
{
    <EditForm Model="@_memberForm" OnValidSubmit="SaveMember" @onchange="MarkAsChanged">
        <DataAnnotationsValidator />
        
        <div class="row g-4">
            <!-- Personal Information Card -->
            <div class="col-lg-6">
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="bi bi-person-circle"></i>
                        <h5>Personal Information</h5>
                    </div>
                    <div class="form-card-body">
                        <div class="mb-3">
                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                            <InputText class="form-control form-control-modern" @bind-Value="_memberForm.FirstName" @oninput="MarkAsChanged" placeholder="Enter first name" disabled="@_saving" />
                            <ValidationMessage For="@(() => _memberForm.FirstName)" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Middle Name</label>
                            <InputText class="form-control form-control-modern" @bind-Value="_memberForm.MiddleName" @oninput="MarkAsChanged" placeholder="Enter middle name (optional)" disabled="@_saving" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                            <InputText class="form-control form-control-modern" @bind-Value="_memberForm.LastName" @oninput="MarkAsChanged" placeholder="Enter last name" disabled="@_saving" />
                            <ValidationMessage For="@(() => _memberForm.LastName)" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Suffix</label>
                            <InputText class="form-control form-control-modern" @bind-Value="_memberForm.Suffix" @oninput="MarkAsChanged" placeholder="Jr., Sr., III, etc." disabled="@_saving" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                            <div class="date-picker-group">
                                <select class="form-select" @bind="_dobMonth" disabled="@_saving" @bind:after="UpdateDateOfBirth">
                                    <option value="0">Month</option>
                                    <option value="1">01 - January</option>
                                    <option value="2">02 - February</option>
                                    <option value="3">03 - March</option>
                                    <option value="4">04 - April</option>
                                    <option value="5">05 - May</option>
                                    <option value="6">06 - June</option>
                                    <option value="7">07 - July</option>
                                    <option value="8">08 - August</option>
                                    <option value="9">09 - September</option>
                                    <option value="10">10 - October</option>
                                    <option value="11">11 - November</option>
                                    <option value="12">12 - December</option>
                                </select>
                                <select class="form-select" @bind="_dobDay" disabled="@_saving" @bind:after="UpdateDateOfBirth">
                                    <option value="0">Day</option>
                                    @for (int i = 1; i <= 31; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                                <select class="form-select" @bind="_dobYear" disabled="@_saving" @bind:after="UpdateDateOfBirth">
                                    <option value="0">Year</option>
                                    @for (int year = DateTime.Today.Year; year >= 1900; year--)
                                    {
                                        <option value="@year">@year</option>
                                    }
                                </select>
                            </div>
                            <ValidationMessage For="@(() => _memberForm.DateOfBirth)" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information Card -->
            <div class="col-lg-6">
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="bi bi-telephone"></i>
                        <h5>Contact Information</h5>
                    </div>
                    <div class="form-card-body">
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-muted small">(Optional)</span></label>
                            <InputText type="email" class="form-control form-control-modern" @bind-Value="_memberForm.Email" @oninput="MarkAsChanged" placeholder="member@example.com" disabled="@_saving" />
                            <ValidationMessage For="@(() => _memberForm.Email)" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Home Phone <span class="text-danger">*</span></label>
                            <InputText class="form-control form-control-modern" @bind-Value="_memberForm.Phone" @oninput="MarkAsChanged" placeholder="(555) 123-4567" disabled="@_saving" />
                            <ValidationMessage For="@(() => _memberForm.Phone)" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Cell Phone <span class="text-danger">*</span></label>
                            <InputText class="form-control form-control-modern" @bind-Value="_memberForm.CellPhone" @oninput="MarkAsChanged" placeholder="(555) 987-6543" disabled="@_saving" />
                            <ValidationMessage For="@(() => _memberForm.CellPhone)" />
                            <small class="text-muted">At least one phone number is required</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Address <span class="text-danger">*</span></label>
                            <InputText class="form-control form-control-modern" @bind-Value="_memberForm.Address1" @oninput="MarkAsChanged" placeholder="123 Main Street" disabled="@_saving" />
                            <ValidationMessage For="@(() => _memberForm.Address1)" />
                        </div>
                        
                        <div class="row g-2">
                            <div class="col-md-5">
                                <label class="form-label">City <span class="text-danger">*</span></label>
                                @if (_cities.Any())
                                {
                                <InputSelect class="form-select form-control-modern" @bind-Value="_memberForm.City" @onchange="MarkAsChanged" disabled="@_saving">
                                        <option value="">-- Select --</option>
                                        @foreach (var city in _cities)
                                        {
                                            <option value="@city">@city</option>
                                        }
                                    </InputSelect>
                                }
                                else
                                {
                                    <InputText class="form-control form-control-modern" @bind-Value="_memberForm.City" @oninput="MarkAsChanged" placeholder="City" disabled="@_saving" />
                                }
                                <ValidationMessage For="@(() => _memberForm.City)" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">State <span class="text-danger">*</span></label>
                                @if (_states.Any())
                                {
                                    <InputSelect class="form-select form-control-modern" @bind-Value="_memberForm.State" @onchange="MarkAsChanged" disabled="@_saving">
                                        <option value="">-- Select --</option>
                                        @foreach (var state in _states)
                                        {
                                            <option value="@state">@state</option>
                                        }
                                    </InputSelect>
                                }
                                else
                                {
                                    <InputText class="form-control form-control-modern" @bind-Value="_memberForm.State" @oninput="MarkAsChanged" placeholder="MA" disabled="@_saving" maxlength="2" />
                                }
                                <ValidationMessage For="@(() => _memberForm.State)" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Zip Code <span class="text-danger">*</span></label>
                                @if (_postalCodes.Any())
                                {
                                    <InputSelect class="form-select form-control-modern" @bind-Value="_memberForm.PostalCode" @onchange="MarkAsChanged" disabled="@_saving">
                                        <option value="">-- Select --</option>
                                        @foreach (var zip in _postalCodes)
                                        {
                                            <option value="@zip">@zip</option>
                                        }
                                    </InputSelect>
                                }
                                else
                                {
                                    <InputText class="form-control form-control-modern" @bind-Value="_memberForm.PostalCode" @oninput="MarkAsChanged" placeholder="02101" disabled="@_saving" />
                                }
                                <ValidationMessage For="@(() => _memberForm.PostalCode)" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Membership Details Card -->
            <div class="col-lg-6">
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="bi bi-card-checklist"></i>
                        <h5>Membership Details</h5>
                    </div>
                    <div class="form-card-body">
                        <div class="mb-3">
                            <label class="form-label">Status <span class="text-danger">*</span></label>
                            <InputSelect class="form-select form-control-modern" @bind-Value="_memberForm.Status" @onchange="MarkAsChanged" disabled="@_saving">
                                <option value="">-- Select Status --</option>
                                <option value="GUEST">Guest</option>
                                <option value="REGULAR">Regular</option>
                                <option value="REGULAR-NP">Regular (NP)</option>
                                <option value="LIFE">Life</option>
                                <option value="INACTIVE">Inactive</option>
                                <option value="DECEASED">Deceased</option>
                                <option value="REJECTED">Rejected</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => _memberForm.Status)" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Application Date <span class="text-danger">*</span></label>
                            <div class="date-picker-group">
                                <select class="form-select" @bind="_appMonth" disabled="@_saving" @bind:after="UpdateApplicationDate">
                                    <option value="0">Month</option>
                                    <option value="1">01 - January</option>
                                    <option value="2">02 - February</option>
                                    <option value="3">03 - March</option>
                                    <option value="4">04 - April</option>
                                    <option value="5">05 - May</option>
                                    <option value="6">06 - June</option>
                                    <option value="7">07 - July</option>
                                    <option value="8">08 - August</option>
                                    <option value="9">09 - September</option>
                                    <option value="10">10 - October</option>
                                    <option value="11">11 - November</option>
                                    <option value="12">12 - December</option>
                                </select>
                                <select class="form-select" @bind="_appDay" disabled="@_saving" @bind:after="UpdateApplicationDate">
                                    <option value="0">Day</option>
                                    @for (int i = 1; i <= 31; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                                <select class="form-select" @bind="_appYear" disabled="@_saving" @bind:after="UpdateApplicationDate">
                                    <option value="0">Year</option>
                                    @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 50; year--)
                                    {
                                        <option value="@year">@year</option>
                                    }
                                </select>
                            </div>
                            <ValidationMessage For="@(() => _memberForm.ApplicationDate)" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Accepted Date</label>
                            <div class="date-picker-group">
                                <select class="form-select" @bind="_accMonth" disabled="@_saving" @bind:after="UpdateAcceptedDate">
                                    <option value="0">Month</option>
                                    <option value="1">01 - January</option>
                                    <option value="2">02 - February</option>
                                    <option value="3">03 - March</option>
                                    <option value="4">04 - April</option>
                                    <option value="5">05 - May</option>
                                    <option value="6">06 - June</option>
                                    <option value="7">07 - July</option>
                                    <option value="8">08 - August</option>
                                    <option value="9">09 - September</option>
                                    <option value="10">10 - October</option>
                                    <option value="11">11 - November</option>
                                    <option value="12">12 - December</option>
                                </select>
                                <select class="form-select" @bind="_accDay" disabled="@_saving" @bind:after="UpdateAcceptedDate">
                                    <option value="0">Day</option>
                                    @for (int i = 1; i <= 31; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                                <select class="form-select" @bind="_accYear" disabled="@_saving" @bind:after="UpdateAcceptedDate">
                                    <option value="0">Year</option>
                                    @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 50; year--)
                                    {
                                        <option value="@year">@year</option>
                                    }
                                </select>

                            </div>
                            <ValidationMessage For="@(() => _memberForm.AcceptedDate)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Regular Membership Start Date</label>
                            <div class="date-picker-group">
                                <select class="form-select" @bind="_regMonth" disabled="@_saving" @bind:after="UpdateRegularSinceDate">
                                    <option value="0">Month</option>
                                    <option value="1">01 - January</option>
                                    <option value="2">02 - February</option>
                                    <option value="3">03 - March</option>
                                    <option value="4">04 - April</option>
                                    <option value="5">05 - May</option>
                                    <option value="6">06 - June</option>
                                    <option value="7">07 - July</option>
                                    <option value="8">08 - August</option>
                                    <option value="9">09 - September</option>
                                    <option value="10">10 - October</option>
                                    <option value="11">11 - November</option>
                                    <option value="12">12 - December</option>
                                </select>
                                <select class="form-select" @bind="_regDay" disabled="@_saving" @bind:after="UpdateRegularSinceDate">
                                    <option value="0">Day</option>
                                    @for (int i = 1; i <= 31; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                                <select class="form-select" @bind="_regYear" disabled="@_saving" @bind:after="UpdateRegularSinceDate">
                                    <option value="0">Year</option>
                                    @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 50; year--)
                                    {
                                        <option value="@year">@year</option>
                                    }
                                </select>
                            </div>
                            <div class="form-text text-muted small mt-2">
                                <i class="bi bi-info-circle me-1"></i>
                                Date changed from Guest to Regular/Regular-NP status. Marks start of 15-year tenure for Life Membership.
                            </div>
                            @if (_memberForm.RegularSince.HasValue)
                            {
                                <div class="alert alert-warning mt-2 py-2 px-3 small border-0 bg-warning bg-opacity-10 text-warning-emphasis">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <strong>Warning:</strong> You are manually overriding the calculated start date. 
                                    This manual date will be prioritized over the automatic history log.
                                </div>
                            }
                        </div>


                    </div>
                </div>
            </div>

            <!-- Notes Card -->
            <div class="col-lg-6">
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="bi bi-sticky"></i>
                        <h5>Additional Notes</h5>
                    </div>
                    <div class="form-card-body">
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <InputTextArea class="form-control form-control-modern" @bind-Value="_memberForm.Notes" @oninput="MarkAsChanged" rows="8" placeholder="Add any additional information about this member..." disabled="@_saving" />
                        </div>
                    </div>
                </div>
            </div>
            <!-- Deceased Information Card -->
            <div class="col-lg-6">
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="bi bi-heartbreak"></i>
                        <h5>Deceased Information</h5>
                    </div>
                    <div class="form-card-body">
                        <div class="mb-3">
                            <label class="form-label">Date of Death</label>
                            <div class="date-picker-group">
                                <select class="form-select" @bind="_deathMonth" disabled="@_saving" @bind:after="UpdateDateOfDeath">
                                    <option value="0">Month</option>
                                    <option value="1">01 - January</option>
                                    <option value="2">02 - February</option>
                                    <option value="3">03 - March</option>
                                    <option value="4">04 - April</option>
                                    <option value="5">05 - May</option>
                                    <option value="6">06 - June</option>
                                    <option value="7">07 - July</option>
                                    <option value="8">08 - August</option>
                                    <option value="9">09 - September</option>
                                    <option value="10">10 - October</option>
                                    <option value="11">11 - November</option>
                                    <option value="12">12 - December</option>
                                </select>
                                <select class="form-select" @bind="_deathDay" disabled="@_saving" @bind:after="UpdateDateOfDeath">
                                    <option value="0">Day</option>
                                    @for (int i = 1; i <= 31; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                                <select class="form-select" @bind="_deathYear" disabled="@_saving" @bind:after="UpdateDateOfDeath">
                                    <option value="0">Year</option>
                                    @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 50; year--)
                                    {
                                        <option value="@year">@year</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" @onclick="ClearDateOfDeath" disabled="@_saving" title="Clear date">
                                    <i class="bi bi-x-circle"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <InputCheckbox class="form-check-input" @bind-Value="_memberForm.ShowOnWebsite" disabled="@_saving" id="showOnWebsiteCheck" />
                            <label class="form-check-label" for="showOnWebsiteCheck">
                                Show on Website "In Memoriam"
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-bar">
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mb-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
                </div>
            }
            
            <div class="d-flex gap-3 justify-content-end">
                <button type="button" class="btn btn-outline-secondary" @onclick="GoBack" disabled="@_saving">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="submit" class="btn-save @(_saving ? "saving" : "")" disabled="@_saving">
                    @if (_saving)
                    {
                        <span class="spinner"></span>
                        <span class="save-text">Saving...</span>
                    }
                    else
                    {
                        <i class="bi bi-check-circle me-2"></i>
                        <span class="save-text">Save Changes</span>
                    }
                </button>
            </div>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int MemberId { get; set; }

    private Member? _member;
    private MemberFormModel? _memberForm;
    private bool _loading = true;
    private bool _notFound = false;
    private string? _loadError;
    private bool _saving = false;
    private bool _showSuccessAnimation = false;
    private bool _showDuesPrompt = false;
    private string _errorMessage = "";
    private string _memberName = "";
    private List<string> _cities = new();
    private List<string> _states = new();
    private List<string> _postalCodes = new();

    // Date picker backing fields
    private int _dobMonth = 0;
    private int _dobDay = 0;
    private int _dobYear = 0;
    
    private int _appMonth = 0;
    private int _appDay = 0;
    private int _appYear = 0;
    
    private int _accMonth = 0;
    private int _accDay = 0;
    private int _accYear = 0;

    private int _regMonth = 0;
    private int _regDay = 0;
    private int _regYear = 0;



    private int _deathMonth = 0;
    private int _deathDay = 0;
    private int _deathYear = 0;

    private bool _hasUnsavedChanges = false;
    private bool _isFirstRender = true;
    private IDisposable? _navigationInterceptor;

    protected override async Task OnInitializedAsync()
    {
        // Register navigation interceptor for in-app navigation
        _navigationInterceptor = NavManager.RegisterLocationChangingHandler(OnLocationChanging);
        
        await LoadMemberAsync();
        LoadDropdownData();
    }

    private ValueTask OnLocationChanging(LocationChangingContext context)
    {
        if (_hasUnsavedChanges && !_saving)
        {
            // Prevent navigation and show confirmation
            context.PreventNavigation();
            
            // Show async confirmation dialog
            _ = ConfirmNavigationAsync(context.TargetLocation);
        }
        
        return ValueTask.CompletedTask;
    }

    private async Task ConfirmNavigationAsync(string targetLocation)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "You have unsaved changes. Are you sure you want to leave without saving?");
        
        if (confirmed)
        {
            _hasUnsavedChanges = false;
            await JSRuntime.InvokeVoidAsync("eval", "window.hasUnsavedChanges = false;");
            NavManager.NavigateTo(targetLocation);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                window.addEventListener('beforeunload', function (e) {
                    if (window.hasUnsavedChanges) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            ");
        }

        if (_hasUnsavedChanges && !_isFirstRender)
        {
            await JSRuntime.InvokeVoidAsync("eval", "window.hasUnsavedChanges = true;");
        }
        else if (!_hasUnsavedChanges)
        {
            await JSRuntime.InvokeVoidAsync("eval", "window.hasUnsavedChanges = false;");
        }

        _isFirstRender = false;
    }

    private async Task LoadMemberAsync()
    {
        _loading = true;
        _loadError = null;
        _notFound = false;

        try
        {
            _member = await Task.Run(() => MemberRepository.GetMemberById(MemberId));

            if (_member == null)
            {
                _notFound = true;
                return;
            }

            // Populate form with existing member data
            _memberForm = new MemberFormModel
            {
                FirstName = _member.FirstName ?? "",
                MiddleName = _member.MiddleName,
                LastName = _member.LastName ?? "",
                Suffix = _member.Suffix,
                DateOfBirth = _member.DateOfBirth,
                Email = _member.Email,
                Phone = _member.Phone,
                CellPhone = _member.CellPhone,
                Address1 = _member.Address1,
                City = _member.City,
                State = _member.State,
                PostalCode = _member.PostalCode,
                Status = _member.Status ?? "",
                ApplicationDate = _member.ApplicationDate,
                AcceptedDate = _member.AcceptedDate,
                RegularSince = _member.RegularSince,
                IsNonPortugueseOrigin = _member.IsNonPortugueseOrigin,
                Notes = _member.Notes,
                DateOfDeath = _member.DateOfDeath,
                ShowOnWebsite = _member.ShowOnWebsite
            };

            // Initialize date components
            if (_memberForm.DateOfBirth.HasValue)
            {
                _dobMonth = _memberForm.DateOfBirth.Value.Month;
                _dobDay = _memberForm.DateOfBirth.Value.Day;
                _dobYear = _memberForm.DateOfBirth.Value.Year;
            }

            if (_memberForm.ApplicationDate.HasValue)
            {
                _appMonth = _memberForm.ApplicationDate.Value.Month;
                _appDay = _memberForm.ApplicationDate.Value.Day;
                _appYear = _memberForm.ApplicationDate.Value.Year;
            }

            if (_memberForm.AcceptedDate.HasValue)
            {
                _accMonth = _memberForm.AcceptedDate.Value.Month;
                _accDay = _memberForm.AcceptedDate.Value.Day;
                _accYear = _memberForm.AcceptedDate.Value.Year;
            }

            // Calculate 'Regular Since' for display/edit using the helper
            // This ensures we show the effective date (History or StatusChangeDate)
            var regularSince = MemberStatusHelper.GetRegularSinceDate(_member, HistoryRepository);
            if (regularSince.HasValue)
            {
                _memberForm.RegularSince = regularSince;
                _regMonth = regularSince.Value.Month;
                _regDay = regularSince.Value.Day;
                _regYear = regularSince.Value.Year;
            }



            if (_memberForm.DateOfDeath.HasValue)
            {
                _deathMonth = _memberForm.DateOfDeath.Value.Month;
                _deathDay = _memberForm.DateOfDeath.Value.Day;
                _deathYear = _memberForm.DateOfDeath.Value.Year;
            }

            _memberName = GetFullName(_member);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading member {MemberId} for editing", MemberId);
            _loadError = "Failed to load member details. Please try again.";
        }
        finally
        {
            _loading = false;
        }
    }

    private void LoadDropdownData()
    {
        try
        {
            _cities = MemberRepository.GetDistinctCities()
                .Where(c => !string.IsNullOrWhiteSpace(c))
                .OrderBy(c => c)
                .ToList();
            
            _states = MemberRepository.GetDistinctStates()
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .OrderBy(s => s)
                .ToList();
                
            _postalCodes = MemberRepository.GetDistinctPostalCodes()
                .Where(z => !string.IsNullOrWhiteSpace(z))
                .OrderBy(z => z)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dropdown data");
        }
    }

    private async Task SaveMember()
    {
        if (_member == null || _memberForm == null)
        {
            return;
        }

        _saving = true;
        _errorMessage = "";
        
        // Custom validation: At least one phone required
        if (string.IsNullOrWhiteSpace(_memberForm.Phone) && string.IsNullOrWhiteSpace(_memberForm.CellPhone))
        {
            _errorMessage = "At least one phone number (Home or Cell) is required.";
            _saving = false;
            return;
        }

        // Custom validation: Minimum Age
        if (_memberForm.DateOfBirth.HasValue)
        {
            var age = MemberStatusHelper.CalculateAge(_memberForm.DateOfBirth.Value, DateTime.Today);
            if (age < MemberStatusHelper.MinimumMemberAge)
            {
                _errorMessage = $"Member must be at least {MemberStatusHelper.MinimumMemberAge} years old (Current age: {age}).";
                _saving = false;
                return;
            }
        }
        
        StateHasChanged();

        try
        {
            // Track if we just added an accepted date
            bool wasPending = !_member.AcceptedDate.HasValue;
            bool isAcceptedNow = _memberForm.AcceptedDate.HasValue;
            bool justAccepted = wasPending && isAcceptedNow;

            // Update member object with form data
            _member.FirstName = FormatName(_memberForm.FirstName);
            _member.MiddleName = FormatName(_memberForm.MiddleName);
            _member.LastName = FormatName(_memberForm.LastName);
            _member.Suffix = _memberForm.Suffix?.Trim();
            _member.DateOfBirth = _memberForm.DateOfBirth;
            _member.Address1 = FormatAddress(_memberForm.Address1);
            _member.City = FormatName(_memberForm.City);
            _member.State = _memberForm.State?.Trim().ToUpperInvariant();
            _member.PostalCode = _memberForm.PostalCode?.Trim();
            _member.Phone = FormatPhone(_memberForm.Phone);
            _member.CellPhone = FormatPhone(_memberForm.CellPhone);
            _member.Email = string.IsNullOrWhiteSpace(_memberForm.Email) ? null : _memberForm.Email.Trim().ToLowerInvariant();
            _member.ApplicationDate = _memberForm.ApplicationDate;
            _member.AcceptedDate = _memberForm.AcceptedDate;
            _member.RegularSince = _memberForm.RegularSince;
            // Track status change
            string oldStatus = _member.Status;
            string newStatus = _memberForm.Status;
            bool statusChanged = !string.Equals(oldStatus, newStatus, StringComparison.OrdinalIgnoreCase);

            _member.Status = newStatus;

            if (statusChanged)
            {
                // Update the change date
                _member.StatusChangeDate = DateTime.Today;

                // Log to history
                try 
                {
                    HistoryRepository.LogMemberChange(MemberId, "Status", oldStatus, newStatus);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failed to log status change history for member {MemberId}", MemberId);
                }
            }

            // [FIX] Ensure the RegularSince date from the form is persisted to StatusChangeDate
            // This allows manual backdating/correction of the "Regular Member Start Date".
            // We only do this if the user has explicitly set/changed the RegularSince date in the form.
            if (_memberForm.RegularSince.HasValue)
            {
                 // If the user specified a date, save it to StatusChangeDate.
                 // This effectively "wins" over the DateTime.Today set above if the user backdated it.
                 _member.StatusChangeDate = _memberForm.RegularSince;

                 // [IMPORTANT] Also log this as a persistent "Historical Event" in the History table.
                 // This ensures that even if status changes again (e.g. to Inactive), we have a permanent record
                 // of when they FIRST became regular, which GetRegularSinceDate() will find.
                 try
                 {
                     HistoryRepository.LogHistoricalEvent(
                         MemberId, 
                         "Status", 
                         "GUEST", 
                         "REGULAR", 
                         _memberForm.RegularSince.Value, 
                         $"Manual Correction ({DateTime.Now:MM/dd/yyyy})"
                     );
                 }
                 catch (Exception ex)
                 {
                     Logger.LogError(ex, "Failed to log historical regular start date for member {MemberId}", MemberId);
                 }
            }
            else if (statusChanged && newStatus.Equals("REGULAR", StringComparison.OrdinalIgnoreCase))
            {
                // If they cleared the date but just became regular, ensure it defaults to today
                // (Already handled by statusChanged block, but just being explicit if needed)
            }
            
            _member.IsNonPortugueseOrigin = _memberForm.IsNonPortugueseOrigin;
            _member.Notes = _memberForm.Notes?.Trim();
            _member.DateOfDeath = _memberForm.DateOfDeath;
            _member.ShowOnWebsite = _memberForm.ShowOnWebsite;

            // Update in database
            MemberRepository.UpdateMember(_member);
            
            try
            {
                // Ensure key card eligibility is re-evaluated immediately
                await KeyCardLifecycleService.ProcessMemberAsync(_member.MemberID, DateTime.Today.Year);
            }
            catch (Exception ex)
            {
                // Don't fail the whole save, just log
                Logger.LogError(ex, "Failed to process card lifecycle for member {MemberId} after edit", _member.MemberID);
            }

            _memberName = GetFullName(_member);
            
            // Show success animation
            _saving = false;
            _hasUnsavedChanges = false; // Clear unsaved changes flag

            if (justAccepted)
            {
                _showDuesPrompt = true;
            }
            else
            {
                _showSuccessAnimation = true;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating member {MemberId}", MemberId);
            _errorMessage = "Failed to update member. Please try again.";
            _saving = false;
        }
    }
    
    // Format names: Capitalize first letter of each word, lowercase the rest
    private string? FormatName(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return name;
        
        var textInfo = System.Globalization.CultureInfo.CurrentCulture.TextInfo;
        return textInfo.ToTitleCase(name.Trim().ToLowerInvariant());
    }
    
    // Format addresses: Proper capitalization
    private string? FormatAddress(string? address)
    {
        if (string.IsNullOrWhiteSpace(address)) return address;
        
        var textInfo = System.Globalization.CultureInfo.CurrentCulture.TextInfo;
        return textInfo.ToTitleCase(address.Trim().ToLowerInvariant());
    }
    
    // Format phone numbers to xxx-xxx-xxxx if they are 10 digits
    private string? FormatPhone(string? phone)
    {
        if (string.IsNullOrWhiteSpace(phone)) return phone;
        
        // Remove allowed characters to check for digits
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        
        if (digits.Length == 10)
        {
            return $"{digits.Substring(0, 3)}-{digits.Substring(3, 3)}-{digits.Substring(6)}";
        }
        
        return phone?.Trim();
    }

    private static string GetFullName(Member member)
    {
        var first = member.FirstName?.Trim() ?? string.Empty;
        var middle = member.MiddleName?.Trim();
        var last = member.LastName?.Trim() ?? string.Empty;
        var suffix = member.Suffix?.Trim();
        
        // Build name: First [Middle] Last [Suffix]
        var nameParts = new List<string>();
        if (!string.IsNullOrWhiteSpace(first)) nameParts.Add(first);
        if (!string.IsNullOrWhiteSpace(middle)) nameParts.Add(middle);
        if (!string.IsNullOrWhiteSpace(last)) nameParts.Add(last);
        
        var name = string.Join(" ", nameParts);
        return string.IsNullOrWhiteSpace(suffix) ? name : $"{name} {suffix}";
    }

    private async Task GoBack()
    {
        if (_hasUnsavedChanges)
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "You have unsaved changes. Are you sure you want to leave without saving?");
            if (!confirmed)
            {
                return;
            }
        }
        
        await JSRuntime.InvokeVoidAsync("eval", "window.hasUnsavedChanges = false;");
        NavManager.NavigateTo("/members");
    }

    private void MarkAsChanged()
    {
        _hasUnsavedChanges = true;
    }

    private void GoToMemberDetail()
    {
        NavManager.NavigateTo($"/members/{MemberId}");
    }

    private void GoToRecordDues()
    {
        NavManager.NavigateTo($"/dues?action=pay&memberId={MemberId}");
    }

    private void UpdateDateOfBirth()
    {
        if (_dobMonth > 0 && _dobDay > 0 && _dobYear > 0)
        {
            try { _memberForm.DateOfBirth = new DateTime(_dobYear, _dobMonth, _dobDay); }
            catch { _memberForm.DateOfBirth = null; }
        }
        else _memberForm.DateOfBirth = null;
        
        MarkAsChanged();
    }

    private void UpdateApplicationDate()
    {
        if (_appMonth > 0 && _appDay > 0 && _appYear > 0)
        {
            try { _memberForm.ApplicationDate = new DateTime(_appYear, _appMonth, _appDay); }
            catch { _memberForm.ApplicationDate = null; }
        }
        else _memberForm.ApplicationDate = null;
        
        MarkAsChanged();
    }

    private void UpdateAcceptedDate()
    {
        if (_accMonth > 0 && _accDay > 0 && _accYear > 0)
        {
            try { _memberForm.AcceptedDate = new DateTime(_accYear, _accMonth, _accDay); }
            catch { _memberForm.AcceptedDate = null; }
        }
        else _memberForm.AcceptedDate = null;
        
        MarkAsChanged();
    }

    private void UpdateRegularSinceDate()
    {
        if (_regMonth > 0 && _regDay > 0 && _regYear > 0)
        {
            try { _memberForm.RegularSince = new DateTime(_regYear, _regMonth, _regDay); }
            catch { _memberForm.RegularSince = null; }
        }
        else _memberForm.RegularSince = null;
        
        MarkAsChanged();
    }

    private void UpdateDateOfDeath()
    {
        if (_deathMonth > 0 && _deathDay > 0 && _deathYear > 0)
        {
            try { _memberForm.DateOfDeath = new DateTime(_deathYear, _deathMonth, _deathDay); }
            catch { _memberForm.DateOfDeath = null; }
        }
        else _memberForm.DateOfDeath = null;
        
        MarkAsChanged();
    }

    private void ClearDateOfDeath()
    {
        _deathMonth = 0; _deathDay = 0; _deathYear = 0;
        if (_memberForm != null) _memberForm.DateOfDeath = null;
    }

    private class MemberFormModel
    {
        [Required(ErrorMessage = "First name is required")]
        [StringLength(50, ErrorMessage = "First name cannot exceed 50 characters")]
        public string FirstName { get; set; } = "";

        public string? MiddleName { get; set; }

        [Required(ErrorMessage = "Last name is required")]
        [StringLength(50, ErrorMessage = "Last name cannot exceed 50 characters")]
        public string LastName { get; set; } = "";

        public string? Suffix { get; set; }

        private string? _email;
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string? Email 
        { 
            get => _email; 
            set => _email = string.IsNullOrWhiteSpace(value) ? null : value; 
        }

        public string? Phone { get; set; }
        public string? CellPhone { get; set; }
        
        [Required(ErrorMessage = "Address is required")]
        public string? Address1 { get; set; }
        
        [Required(ErrorMessage = "City is required")]
        public string? City { get; set; }
        
        [Required(ErrorMessage = "State is required")]
        [StringLength(2, ErrorMessage = "State must be 2 characters")]
        public string? State { get; set; }
        
        [Required(ErrorMessage = "Zip code is required")]
        public string? PostalCode { get; set; }

        [Required(ErrorMessage = "Status is required")]
        public string Status { get; set; } = "";

        [Required(ErrorMessage = "Application date is required")]
        public DateTime? ApplicationDate { get; set; }
        
        public DateTime? AcceptedDate { get; set; }
        
        public DateTime? RegularSince { get; set; }
        
        [Required(ErrorMessage = "Date of birth is required")]
        public DateTime? DateOfBirth { get; set; }

        public bool IsNonPortugueseOrigin { get; set; }
        
        public string? Notes { get; set; }

        public DateTime? DateOfDeath { get; set; }

        public bool ShowOnWebsite { get; set; }
    }

    public void Dispose()
    {
        _navigationInterceptor?.Dispose();
    }
}
