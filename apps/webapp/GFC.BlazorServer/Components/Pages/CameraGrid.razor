<!-- [MODIFIED] -->
@page "/cameras/grid"
@using GFC.BlazorServer.Services.Camera
@using GFC.BlazorServer.Components.Shared
@using GFC.Core.Models
@inject ICameraService CameraService
@inject IJSRuntime JS

<PageTitle>Camera Grid - GFC Cameras</PageTitle>

<div class="camera-grid-container">
    <div class="camera-grid-header">
        <h1>Live Camera Grid</h1>
        <div class="grid-controls">
            <select @bind="GridLayout" class="form-select" @bind:after="OnGridLayoutChange">
                <option value="1">1 Camera</option>
                <option value="4">2x2 Grid</option>
                <option value="9">3x3 Grid</option>
                <option value="16">4x4 Grid</option>
            </select>
            <button class="btn btn-primary" @onclick="RefreshAll">
                <i class="bi bi-arrow-clockwise"></i> Refresh All
            </button>
        </div>
    </div>

    @if (Cameras.Any())
    {
        <div class="camera-grid grid-layout-@GridLayout">
            @foreach (var camera in Cameras.Take(GridLayout))
            {
                <div class="camera-grid-item">
                    <CameraFeedEnhanced
                        CameraId="@camera.Id"
                        CameraName="@camera.Name"
                        ShowControls="true"
                        EnablePTZ="true"
                        OnFullscreen="@(() => EnterFullscreen(camera.Id))" />
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">
            Loading cameras...
        </div>
    }
</div>

@code {
    private int GridLayout { get; set; } = 4;
    private List<GFC.Core.Models.Camera> Cameras { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCameras();
    }

    private async Task LoadCameras()
    {
        Cameras = await CameraService.GetAllCamerasAsync();
        StateHasChanged();
    }

    private async Task RefreshAll()
    {
        await LoadCameras();
    }

    private async Task EnterFullscreen(int cameraId)
    {
        await JS.InvokeVoidAsync("CameraGrid.enterFullscreen", $"camera-{cameraId}");
    }

    private void OnGridLayoutChange()
    {
        StateHasChanged();
    }
}
