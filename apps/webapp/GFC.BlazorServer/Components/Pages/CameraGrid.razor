<!-- [MODIFIED] -->
@page "/cameras/grid"
@using GFC.BlazorServer.Services.Camera
@using GFC.BlazorServer.Components.Shared
@using GFC.Core.Models
@inject ICameraService CameraService
@inject IJSRuntime JS

<PageTitle>Camera Grid - GFC Cameras</PageTitle>

<div class="camera-grid-container">
    <div class="camera-grid-header">
        <h1>Live Camera Grid</h1>
        <div class="grid-controls">
            <select @bind="GridLayout" class="form-select" @bind:after="OnGridLayoutChange">
                <option value="1">1 Camera</option>
                <option value="4">2x2 Grid</option>
                <option value="9">3x3 Grid</option>
                <option value="16">4x4 Grid</option>
            </select>
            <button class="btn btn-primary" @onclick="RefreshAll">
                <i class="bi bi-arrow-clockwise"></i> Refresh All
            </button>
        </div>
    </div>

    @if (Cameras == null)
    {
        <div class="alert alert-info">
            <i class="bi bi-hourglass-split"></i> Loading cameras...
        </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-circle"></i> @ErrorMessage
        </div>
    }
    else if (!Cameras.Any())
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> No cameras found. Please add cameras in <a href="/cameras">Camera Management</a>.
        </div>
    }
    else
    {
        <div class="camera-grid grid-layout-@GridLayout">
            @foreach (var camera in Cameras.Take(GridLayout))
            {
                <div class="camera-grid-item">
                    <CameraFeedEnhanced
                        CameraId="@camera.Id"
                        CameraName="@camera.Name"
                        ShowControls="true"
                        EnablePTZ="true"
                        OnFullscreen="@(() => EnterFullscreen(camera.Id))" />
                </div>
            }
        </div>
    }
</div>

@code {
    private int GridLayout { get; set; } = 4;
    private List<GFC.Core.Models.Camera> Cameras { get; set; } = null;
    private string ErrorMessage { get; set; } = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadCameras();
    }

    private async Task LoadCameras()
    {
        try
        {
            Cameras = await CameraService.GetAllCamerasAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading cameras: {ex.Message}";
            Cameras = new List<GFC.Core.Models.Camera>(); // Set to empty list to show error message
            StateHasChanged();
        }
    }

    private async Task RefreshAll()
    {
        await LoadCameras();
    }

    private async Task EnterFullscreen(int cameraId)
    {
        await JS.InvokeVoidAsync("CameraGrid.enterFullscreen", $"camera-{cameraId}");
    }

    private void OnGridLayoutChange()
    {
        StateHasChanged();
    }
}
