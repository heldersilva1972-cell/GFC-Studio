<!-- [NEW] -->
@page "/cameras/permissions"
@inject GFC.BlazorServer.Services.Camera.ICameraService CameraService
@inject GFC.BlazorServer.Services.Camera.ICameraPermissionService PermissionService
@* @inject GFC.BlazorServer.Services.IUserManagementService UserService *@

<PageTitle>Camera Permissions</PageTitle>

<h1>Camera Permissions</h1>

<div class="mb-3">
    <label for="camera" class="form-label">Camera</label>
    <select id="camera" class="form-select" @onchange="OnCameraSelected">
        <option value="">Select a camera</option>
        @if (_cameras != null)
        {
            @foreach (var cam in _cameras)
            {
                <option value="@cam.Id">@cam.Name</option>
            }
        }
    </select>
</div>

@if (_selectedCameraId > 0)
{
    <h2>Permissions for @_camera?.Name</h2>

    <EditForm Model="@_newPermission" OnValidSubmit="AddPermission">
        <div class="row">
            <div class="col-md-4">
                <InputSelect @bind-Value="_newPermission.UserId" class="form-select">
                    <option value="">Select User</option>
                    @if(_users != null)
                    {
                        @foreach(var user in _users)
                        {
                            <option value="@user.UserId">@user.Username</option>
                        }
                    }
                </InputSelect>
            </div>
            <div class="col-md-4">
                <InputSelect @bind-Value="_newPermission.AccessLevel" class="form-select">
                    @foreach (GFC.Core.Models.CameraAccessLevel level in Enum.GetValues(typeof(GFC.Core.Models.CameraAccessLevel)))
                    {
                        <option value="@level">@level</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary">Add Permission</button>
            </div>
        </div>
    </EditForm>

    <hr />

    @if (_permissions != null)
    {
        <table class="table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Access Level</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in _permissions)
                {
                    <tr>
                        <td>@p.User?.Username</td>
                        <td>@p.AccessLevel</td>
                        <td>
                            <button class="btn btn-sm btn-danger" @onclick="() => RemovePermission(p.Id)">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private List<GFC.Core.Models.Camera> _cameras;
    private List<GFC.Core.Models.AppUser> _users;
    private List<GFC.Core.Models.CameraPermission> _permissions;
    private GFC.Core.Models.Camera _camera;
    private GFC.Core.Models.CameraPermission _newPermission = new();

    private int _selectedCameraId;

    protected override async Task OnInitializedAsync()
    {
        _cameras = await CameraService.GetAllCamerasAsync();
        // _users = (await UserService.GetAllUsersAsync()).ToList();
        _users = new List<GFC.Core.Models.AppUser>(); // TODO: Implement user service
    }

    private async Task OnCameraSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value.ToString(), out _selectedCameraId) && _selectedCameraId > 0)
        {
            _camera = _cameras.FirstOrDefault(c => c.Id == _selectedCameraId);
            await LoadPermissions();
        }
        else
        {
            _selectedCameraId = 0;
            _camera = null;
            _permissions = null;
        }
    }

    private async Task LoadPermissions()
    {
        _permissions = await PermissionService.GetPermissionsForCameraAsync(_selectedCameraId);
        // Manually load user for display
        foreach(var p in _permissions)
        {
            p.User = _users.FirstOrDefault(u => u.UserId == p.UserId);
        }
    }

    private async Task AddPermission()
    {
        if (_selectedCameraId > 0 && !string.IsNullOrEmpty(_newPermission.UserId))
        {
            _newPermission.CameraId = _selectedCameraId;
            await PermissionService.AddPermissionAsync(_newPermission);
            _newPermission = new();
            await LoadPermissions();
        }
    }

    private async Task RemovePermission(int permissionId)
    {
        await PermissionService.RemovePermissionAsync(permissionId);
        await LoadPermissions();
    }
}
