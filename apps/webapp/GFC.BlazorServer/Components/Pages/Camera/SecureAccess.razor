@page "/cameras/secure-access"
@using GFC.Core.Interfaces
@inject NavigationManager NavigationManager
@inject INetworkLocationService NetworkLocationService
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Secure Video Access Required</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-body p-5 text-center">
                    <div class="mb-4">
                        <i class="bi bi-shield-lock" style="font-size: 4rem; color: var(--bs-primary);"></i>
                    </div>
                    
                    <h2 class="card-title mb-3">Secure Access Required</h2>
                    
                    <p class="text-muted mb-4">
                        For security reasons, viewing cameras from outside the club network requires a secure VPN connection.
                    </p>

                    @if (_isCheckingAccess)
                    {
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Checking access...</span>
                        </div>
                        <p class="mt-3 text-muted">Verifying your connection...</p>
                    }
                    else if (_hasAccess)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> Access granted! Redirecting...
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> You are not connected via the secure network.
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary btn-lg" @onclick="CheckAccessAgain">
                                <i class="bi bi-arrow-repeat"></i> Check Connection Again
                            </button>
                            <a href="/" class="btn btn-outline-secondary">
                                <i class="bi bi-house"></i> Return to Dashboard
                            </a>
                        </div>

                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="mb-2">Need Help?</h6>
                            <p class="small text-muted mb-0">
                                Contact the system administrator to set up secure remote access to the camera system.
                            </p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private bool _isCheckingAccess = true;
    private bool _hasAccess = false;

    protected override async Task OnInitializedAsync()
    {
        await CheckAccess();
    }

    private async Task CheckAccess()
    {
        _isCheckingAccess = true;
        StateHasChanged();

        try
        {
            var httpContext = HttpContextAccessor.HttpContext;
            var clientIp = httpContext?.Connection?.RemoteIpAddress?.ToString();

            if (clientIp != null)
            {
                _hasAccess = await NetworkLocationService.IsAuthorizedForVideoAsync(clientIp);

                if (_hasAccess)
                {
                    // Redirect back to the original page
                    await Task.Delay(1000); // Brief delay to show success message
                    var redirectUrl = !string.IsNullOrEmpty(ReturnUrl) 
                        ? Uri.UnescapeDataString(ReturnUrl) 
                        : "/cameras/view";
                    NavigationManager.NavigateTo(redirectUrl, forceLoad: true);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking access: {ex.Message}");
            _hasAccess = false;
        }
        finally
        {
            _isCheckingAccess = false;
            StateHasChanged();
        }
    }

    private async Task CheckAccessAgain()
    {
        await CheckAccess();
    }
}
