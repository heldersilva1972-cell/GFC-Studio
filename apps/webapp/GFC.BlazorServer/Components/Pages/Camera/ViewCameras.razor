@page "/cameras/view"
@using GFC.Core.Models
@inject GFC.BlazorServer.Services.Diagnostics.CameraDiagnosticsService DiagnosticsService
@inject GFC.BlazorServer.Services.Camera.ICameraService CameraService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

<PageTitle>Camera Monitor</PageTitle>

<div class="camera-monitor-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-camera-video"></i> Cameras</h3>
            <span class="badge bg-secondary">@(_cameras?.Count ?? 0)</span>
            <button class="btn btn-sm btn-link text-light ms-auto" @onclick="RefreshStatuses" title="Check Connection" style="margin-left: auto;">
                <i class="bi bi-arrow-repeat"></i>
            </button>
        </div>
        <div class="camera-list">
            @if (_errorMessage != null)
            {
                <div class="alert alert-danger m-2 p-2">
                    <small>@_errorMessage</small>
                </div>
            }
            @if (_cameras == null)
            {
                <div class="p-3 text-center">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                </div>
            }
            else
            {
                @foreach (var cam in _cameras)
                {
                    var isOnline = _cameraStatuses.ContainsKey(cam.Id) && _cameraStatuses[cam.Id];
                    var statusClass = cam.IsEnabled == true ? (isOnline ? "online" : "offline") : "disabled";
                    
                    <div class="camera-pill @(IsSelected(cam.Id) ? "active" : "")" @onclick="() => ToggleCamera(cam.Id)">
                        <div class="d-flex align-items-center justify-content-between w-100">
                            <div class="d-flex align-items-center">
                                <span class="status-dot @statusClass" title="@(cam.IsEnabled == true ? (isOnline ? "Online" : "Offline") : "Disabled")"></span>
                                <span class="camera-name text-truncate">@cam.Name</span>
                            </div>
                            @if (IsSelected(cam.Id))
                            {
                                <i class="bi bi-check-circle-fill text-primary"></i>
                            }
                        </div>
                    </div>
                }
            }
        </div>
        <div class="sidebar-footer">
            <small class="text-muted">Select cameras to view</small>
        </div>
    </div>

    <div class="main-stage">
        <div class="stage-header">
            <div class="view-mode-tabs">
                <button class="btn btn-sm @(_activeTab == "live" ? "btn-primary" : "btn-outline-secondary")" @onclick="@(() => SetTab("live"))">
                    <i class="bi bi-broadcast"></i> Live
                </button>
                <button class="btn btn-sm @(_activeTab == "recorded" ? "btn-primary" : "btn-outline-secondary")" @onclick="@(() => SetTab("recorded"))">
                    <i class="bi bi-skip-backward-fill"></i> Recorded
                </button>
            </div>
            <div class="layout-controls">
                @if (_selectedCameraIds.Count > 0)
                {
                    <button class="btn btn-sm btn-outline-danger" @onclick="ClearSelection" title="Clear All">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
                <div class="btn-group">
                     <button class="btn btn-sm btn-outline-secondary disabled">
                        <i class="bi bi-grid-fill"></i> Grid: @GetGridSizeName()
                     </button>
                </div>
            </div>
        </div>

        <div class="stage-content">
            @if (_selectedCameraIds.Count == 0)
            {
                <div class="empty-state">
                    <i class="bi bi-camera-video display-1 text-muted"></i>
                    <h3 class="mt-3 text-muted">Select cameras to start monitoring</h3>
                    <p class="text-muted">Use the sidebar to select one or more cameras.</p>
                </div>
            }
            else if (_activeTab == "live")
            {
                <div class="video-grid @_gridClass">
                    @foreach (var camId in _selectedCameraIds)
                    {
                        var cam = _cameras.FirstOrDefault(c => c.Id == camId);
                        if (cam != null)
                        {
                            <div class="video-cell">
                                <div class="video-wrapper">
                                    <video id="video-player-@cam.Id" class="video-element" muted autoplay playsinline></video>
                                    <div class="video-overlay">
                                        <div class="cam-info">
                                            <span class="badge bg-dark opacity-75">@cam.Name</span>
                                        </div>
                                        <div class="cam-controls">
                                            <button class="btn btn-sm btn-dark opacity-75" title="Snapshot" @onclick="@(() => TakeSnapshot(cam.Id))"><i class="bi bi-camera"></i></button>
                                            <button class="btn btn-sm btn-dark opacity-75" title="Fullscreen" @onclick="@(() => ToggleFullscreen(cam.Id))"><i class="bi bi-arrows-fullscreen"></i></button>
                                        </div>
                                    </div>
                                    <div class="loading-overlay" id="loading-@cam.Id">
                                        <div class="spinner-border text-light" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            }
            else
            {
                <div class="recorded-placeholder">
                    <h2><i class="bi bi-film"></i> Recorded Footage</h2>
                    <p>Timeline playback feature coming soon.</p>
                </div>
            }
        </div>
    </div>
</div>

@implements IDisposable
@code {
    private List<Camera> _cameras = new();
    private Dictionary<int, bool> _cameraStatuses = new();
    private HashSet<int> _selectedCameraIds = new();
    private Dictionary<int, string> _secureUrls = new();
    private string _activeTab = "live";
    private string _gridClass = "grid-1";
    private string _errorMessage;
    private System.Threading.Timer _tokenRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _cameras = await CameraService.GetAllCamerasAsync();
            _ = RefreshStatuses();
            _tokenRefreshTimer = new System.Threading.Timer(async _ => await RefreshTokens(), null, TimeSpan.Zero, TimeSpan.FromSeconds(45));
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading cameras: {ex.Message}";
            _cameras = new List<Camera>(); // Ensure it's not null to prevent other crashes
        }
    }
    
    private async Task RefreshStatuses()
    {
        try 
        {
            _cameraStatuses = await DiagnosticsService.GetCameraOnlineStatusesAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // Fail silently
        }
    }

    private async Task RefreshTokens()
    {
        if (_activeTab != "live" || _selectedCameraIds.Count == 0) return;

        foreach (var camId in _selectedCameraIds.ToList())
        {
            try
            {
                var newUrl = await CameraService.GetSecureStreamUrlAsync(camId);
                _secureUrls[camId] = newUrl;
                await JSRuntime.InvokeVoidAsync("updateHlsPlayerSource", $"video-player-{camId}", newUrl);
            }
            catch (Exception ex)
            {
                // Handle error, maybe show an indicator on the video
                Console.WriteLine($"Error refreshing token for camera {camId}: {ex.Message}");
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_activeTab == "live" && _selectedCameraIds.Count > 0)
        {
            foreach (var camId in _selectedCameraIds)
            {
                if (_secureUrls.TryGetValue(camId, out var hlsUrl))
                {
                    await JSRuntime.InvokeVoidAsync("initializeHlsPlayer", $"video-player-{camId}", hlsUrl);
                }
            }
        }
    }

    private bool IsSelected(int cameraId) => _selectedCameraIds.Contains(cameraId);

    private async Task ToggleCamera(int cameraId)
    {
        if (_selectedCameraIds.Contains(cameraId))
        {
            _selectedCameraIds.Remove(cameraId);
            _secureUrls.Remove(cameraId);
        }
        else
        {
            try
            {
                var secureUrl = await CameraService.GetSecureStreamUrlAsync(cameraId);
                _secureUrls[cameraId] = secureUrl;
                _selectedCameraIds.Add(cameraId);
            }
            catch (Exception ex)
            {
                _errorMessage = $"Could not get secure URL for camera: {ex.Message}";
            }
        }
        UpdateGridClass();
    }

    private void ClearSelection()
    {
        _selectedCameraIds.Clear();
        UpdateGridClass();
    }

    private void SetTab(string tab)
    {
        _activeTab = tab;
    }

    private void UpdateGridClass()
    {
        var count = _selectedCameraIds.Count;
        if (count <= 1) _gridClass = "grid-1";
        else if (count <= 2) _gridClass = "grid-2"; // 1x2 or 2x1 generally side by side
        else if (count <= 4) _gridClass = "grid-2x2";
        else if (count <= 9) _gridClass = "grid-3x3";
        else _gridClass = "grid-4x4";
    }

    private string GetGridSizeName()
    {
        var count = _selectedCameraIds.Count;
        if (count == 0) return "None";
        if (count == 1) return "Single";
        if (count == 2) return "Split";
        if (count <= 4) return "2x2";
        if (count <= 9) return "3x3";
        return "Many";
    }

    private async Task TakeSnapshot(int videoId)
    {
        // Simple client-side snapshot from video element
        await JSRuntime.InvokeVoidAsync("captureVideoSnapshot", $"video-player-{videoId}", $"snapshot-{videoId}.jpg");
    }

    private async Task ToggleFullscreen(int videoId)
    {
        await JSRuntime.InvokeVoidAsync("toggleFullscreen", $"video-player-{videoId}");
    }

    public void Dispose()
    {
        _tokenRefreshTimer?.Dispose();
    }
}
