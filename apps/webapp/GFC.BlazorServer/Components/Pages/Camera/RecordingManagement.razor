<!-- [NEW] -->
@page "/cameras/recordings"
@inject GFC.BlazorServer.Services.Camera.IRecordingService RecordingService
@inject GFC.BlazorServer.Services.Camera.ICameraService CameraService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@inject HttpClient HttpClient

<PageTitle>Recording Management</PageTitle>

<h1>Recording Management</h1>

<div class="mb-3">
    <label for="camera" class="form-label">Camera</label>
    <select id="camera" class="form-select" @onchange="OnCameraSelected">
        <option value="">Select a camera</option>
        @foreach (var cam in _cameras)
        {
            <option value="@cam.Id">@cam.Name</option>
        }
    </select>
</div>

@if (_recordings != null)
{
    <table class="table">
        <thead>
            <tr>
                <th>Start Time</th>
                <th>End Time</th>
                <th>File Size</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var rec in _recordings)
            {
                <tr>
                    <td>@rec.StartTime.ToLocalTime()</td>
                    <td>@rec.EndTime.ToLocalTime()</td>
                    <td>@(rec.FileSize / 1024 / 1024) MB</td>
                    <td>
                        <button class="btn btn-sm btn-primary" @onclick="() => DownloadRecording(rec)">Download</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<GFC.Core.Models.Camera> _cameras = new();
    private List<GFC.Core.Models.Recording> _recordings;
    private int _selectedCameraId;

    protected override async Task OnInitializedAsync()
    {
        _cameras = await CameraService.GetAllCamerasAsync();
    }

    private async Task OnCameraSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value.ToString(), out _selectedCameraId))
        {
            _recordings = await RecordingService.GetRecordingsForCameraAsync(_selectedCameraId, DateTime.UtcNow.AddDays(-7), DateTime.UtcNow);
        }
        else
        {
            _recordings = null;
        }
    }

    private async Task DownloadRecording(Recording recording)
    {
        var videoAgentBaseUrl = Configuration["VideoAgent:BaseUrl"];
        var fileUrl = $"{videoAgentBaseUrl}{recording.FilePath}";
        var fileBytes = await HttpClient.GetByteArrayAsync(fileUrl);
        var fileName = System.IO.Path.GetFileName(recording.FilePath);
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes), "video/mp4");
    }
}
