<!-- [NEW] -->
@page "/cameras/audit"
@inject GFC.BlazorServer.Services.Camera.ICameraAuditLogService AuditLogService
@inject GFC.BlazorServer.Services.Camera.ICameraService CameraService
@inject GFC.Core.Interfaces.IUserRepository UserRepository

<PageTitle>Camera Audit Log</PageTitle>

<h1>Camera Audit Log</h1>

<div class="row mb-3">
    <div class="col-md-4">
        <label for="camera" class="form-label">Camera</label>
        <select id="camera" class="form-select" @onchange="OnCameraFilterChanged">
            <option value="0">All Cameras</option>
            @if (_cameras != null)
            {
                @foreach (var cam in _cameras)
                {
                    <option value="@cam.Id">@cam.Name</option>
                }
            }
        </select>
    </div>
    <div class="col-md-4">
        <label for="user" class="form-label">User</label>
        <select id="user" class="form-select" @onchange="OnUserFilterChanged">
            <option value="0">All Users</option>
            @if (_users != null)
            {
                @foreach (var user in _users)
                {
                    <option value="@user.UserId">@user.Username</option>
                }
            }
        </select>
    </div>
</div>

@if (_logs == null && !_hasError)
{
    <p><em>Loading logs...</em></p>
}
else if (_hasError)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill"></i> @_errorMessage
        <button class="btn btn-link" @onclick="ReloadData">Try Again</button>
    </div>
}
else if (_logs == null || !_logs.Any())
{
    <p class="text-muted">No audit logs found for the selected criteria.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Camera</th>
                <th>Action</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var log in _logs)
            {
                <tr>
                    <td>@log.Timestamp.ToLocalTime()</td>
                    <td>@log.User?.Username</td>
                    <td>@log.Camera?.Name</td>
                    <td>@log.Action</td>
                    <td>@log.Details</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<GFC.Core.Models.CameraAuditLog> _logs;
    private List<GFC.Core.Models.Camera> _cameras = new();
    private List<GFC.Core.Models.AppUser> _users = new();
    private bool _hasError = false;
    private string _errorMessage = "";

    private int? _selectedCameraId;
    private int? _selectedUserId;

    protected override async Task OnInitializedAsync()
    {
        await ReloadData();
    }

    private async Task ReloadData()
    {
        _hasError = false;
        _logs = null;
        try
        {
            _cameras = await CameraService.GetAllCamerasAsync() ?? new();
            _users = await Task.Run(() => UserRepository.GetAllUsers()) ?? new();
            await LoadLogs();
        }
        catch (Exception ex)
        {
            _hasError = true;
            _errorMessage = $"Failed to load data: {ex.Message}. Details: {ex.InnerException?.Message}. Stack: {ex.StackTrace}";
        }
    }

    private async Task OnCameraFilterChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int cameraId) && cameraId > 0)
        {
            _selectedCameraId = cameraId;
        }
        else
        {
            _selectedCameraId = null;
        }
        await LoadLogs();
    }

    private async Task OnUserFilterChanged(ChangeEventArgs e)
    {
        // Safely parse the selected user ID; "0" means all users
        if (int.TryParse(e.Value?.ToString(), out int userId) && userId > 0)
        {
            _selectedUserId = userId;
        }
        else
        {
            _selectedUserId = null;
        }
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        try
        {
            var allLogs = new List<GFC.Core.Models.CameraAuditLog>();

            if (_selectedCameraId.HasValue && _selectedUserId.HasValue)
            {
                var logs = await AuditLogService.GetLogsForCameraAsync(_selectedCameraId.Value, DateTime.UtcNow.AddDays(-30), DateTime.UtcNow);
                allLogs.AddRange(logs.Where(l => l.UserId == _selectedUserId.Value));
            }
            else if (_selectedCameraId.HasValue)
            {
                allLogs.AddRange(await AuditLogService.GetLogsForCameraAsync(_selectedCameraId.Value, DateTime.UtcNow.AddDays(-30), DateTime.UtcNow));
            }
            else if (_selectedUserId.HasValue)
            {
                allLogs.AddRange(await AuditLogService.GetLogsForUserAsync(_selectedUserId.Value, DateTime.UtcNow.AddDays(-30), DateTime.UtcNow));
            }
            else
            {
                if (_cameras != null && _cameras.Any())
                {
                    foreach (var cam in _cameras)
                    {
                        var logs = await AuditLogService.GetLogsForCameraAsync(cam.Id, DateTime.UtcNow.AddDays(-30), DateTime.UtcNow);
                        if (logs != null) allLogs.AddRange(logs);
                    }
                }
            }

            // Manually load user and camera for display
            foreach (var l in allLogs)
            {
                if (_users != null)
                    l.User = _users.FirstOrDefault(u => u.UserId == l.UserId);
                
                if (_cameras != null)
                    l.Camera = _cameras.FirstOrDefault(c => c.Id == l.CameraId);
            }

            _logs = allLogs.OrderByDescending(l => l.Timestamp).ToList();
        }
        catch (Exception ex)
        {
            _hasError = true;
            _errorMessage = $"Error loading log entries: {ex.Message}. Details: {ex.InnerException?.Message}. Stack: {ex.StackTrace}";
        }
    }
}
