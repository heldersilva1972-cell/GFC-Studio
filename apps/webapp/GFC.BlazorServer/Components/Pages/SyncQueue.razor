@page "/keycards/sync-queue"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using GFC.Core.Interfaces
@using GFC.Core.Models
@using GFC.Core.Services
@inject IControllerSyncQueueRepository SyncQueueRepository
@inject IKeyCardRepository KeyCardRepository
@inject IMemberRepository MemberRepository
@inject KeyCardLifecycleService LifecycleService
@inject NavigationManager Navigation
@inject ILogger<SyncQueue> Logger
@inject IJSRuntime JSRuntime

<PageTitle>Controller Sync Queue - GFC</PageTitle>

<!-- Page Header -->
<div class="page-header-modern fade-in">
    <div class="header-content">
        <div class="header-icon-wrapper">
            <div class="header-icon pulse">
                <i class="bi bi-arrow-repeat"></i>
            </div>
        </div>
        <div>
            <h1 class="page-title-modern">Controller Sync Queue</h1>
            <p class="page-subtitle">Monitor and manage card synchronization operations</p>
        </div>
    </div>
    <div class="header-actions">
        <button class="btn btn-outline-secondary" @onclick="GoBack">
            <i class="bi bi-arrow-left"></i> Back to Key Cards
        </button>
        <button class="btn btn-primary" @onclick="RefreshQueue">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4 fade-in" style="animation-delay: 0.1s;">
    <div class="col-md-4">
        <div class="metric-card bg-warning-subtle">
            <div class="metric-icon">
                <i class="bi bi-hourglass-split text-warning"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Pending Syncs</div>
                <div class="metric-value">@_pendingCount</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card bg-success-subtle">
            <div class="metric-icon">
                <i class="bi bi-check-circle text-success"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Completed Today</div>
                <div class="metric-value">@_completedTodayCount</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card bg-info-subtle">
            <div class="metric-icon">
                <i class="bi bi-clock-history text-info"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Oldest Pending</div>
                <div class="metric-value">@(_oldestPendingAge ?? "N/A")</div>
            </div>
        </div>
    </div>
</div>

<!-- Filters & Actions -->
<div class="toolbar mb-3 fade-in" style="animation-delay: 0.2s;">
    <div class="btn-group">
        <button class="btn @(_statusFilter == "ALL" ? "btn-primary" : "btn-outline-secondary")" 
                @onclick='() => SetStatusFilter("ALL")'>
            All (@_allItems.Count)
        </button>
        <button class="btn @(_statusFilter == "PENDING" ? "btn-primary" : "btn-outline-secondary")" 
                @onclick='() => SetStatusFilter("PENDING")'>
            Pending (@_pendingCount)
        </button>
        <button class="btn @(_statusFilter == "COMPLETED" ? "btn-primary" : "btn-outline-secondary")" 
                @onclick='() => SetStatusFilter("COMPLETED")'>
            Completed (@_completedTodayCount)
        </button>
    </div>
    
    <div class="ms-auto d-flex gap-2">
        <button class="btn btn-info" @onclick="RetryAllPending" disabled="@(_pendingCount == 0 || _processing)">
            <i class="bi bi-arrow-repeat"></i> Retry All Pending
        </button>
        <button class="btn btn-outline-danger" @onclick="ClearCompleted" disabled="@(_completedTodayCount == 0 || _processing)">
            <i class="bi bi-trash"></i> Clear Completed
        </button>
    </div>
</div>

@if (_loading)
{
    <div class="loading-state fade-in">
        <div class="spinner-modern"></div>
        <p class="mt-3 text-muted">Synchronizing queue data...</p>
    </div>
}
else
{
    @if (_unconfirmedMissingFromQueue.Any())
    {
        <div class="unconfirmed-notice slide-in-down mb-4">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <div class="notice-icon pulse-warning">
                        <i class="bi bi-exclamation-octagon"></i>
                    </div>
                    <div>
                        <h6 class="mb-1 text-warning fw-bold">Missing Sync Tasks Detected</h6>
                        <p class="mb-0 text-muted small">@_unconfirmedMissingFromQueue.Count current card status changes are not in the sync queue.</p>
                    </div>
                </div>
                <button class="btn btn-warning btn-sm fw-bold px-3" @onclick="RequeueMissingTasks" disabled="@_processing">
                    <i class="bi bi-plus-circle me-1"></i> Fix Queue Now
                </button>
            </div>
        </div>
    }

    @if (!FilteredItems.Any() && !_unconfirmedMissingFromQueue.Any())
    {
        <div class="empty-state-modern fade-in">
            <div class="empty-icon-wrapper">
                <i class="bi bi-check-all"></i>
            </div>
            <h4>Everything is Syncing</h4>
            <p>All cards are currently confirmed or correctly queued for the controller.</p>
            <button class="btn btn-outline-primary mt-3" @onclick="GoBack">
                <i class="bi bi-arrow-left me-2"></i>Back to Management
            </button>
        </div>
    }
    else
    {
        <div class="queue-grid fade-in">
            @foreach (var item in FilteredItems)
            {
                <div class="queue-card @GetRowClass(item)">
                    <div class="queue-card-header">
                        <div class="card-num-group">
                            <span class="card-icon"><i class="bi bi-credit-card-2-front"></i></span>
                            <span class="card-num">#@item.CardNumber</span>
                        </div>
                        <div class="status-group">
                            @if (item.Status == "PENDING")
                            {
                                <span class="badge-modern badge-warning">
                                    <span class="dot pulse-warning"></span>PENDING
                                </span>
                            }
                            else if (item.Status == "PROCESSING")
                            {
                                <span class="badge-modern badge-info">
                                    <span class="spinner-border spinner-border-sm me-1"></span>SYNCING
                                </span>
                            }
                            else
                            {
                                <span class="badge-modern badge-success">
                                    <i class="bi bi-check2-all me-1"></i>SYNCED
                                </span>
                            }
                        </div>
                    </div>
                    
                    <div class="queue-card-body">
                        <div class="member-info">
                            <div class="member-name">
                                @(_memberNames.TryGetValue(item.KeyCardId, out var name) ? name : "Unknown Member")
                            </div>
                            <div class="member-id">Member #@item.KeyCardId</div>
                        </div>
                        
                        <div class="action-info">
                            <div class="action-label">Operation</div>
                            <div class="action-value @(item.Action == "ACTIVATE" ? "text-success" : "text-danger")">
                                <i class="bi @(item.Action == "ACTIVATE" ? "bi-unlock-fill" : "bi-lock-fill") me-1"></i>
                                @item.Action
                            </div>
                        </div>
                    </div>
                    
                    <div class="queue-card-footer">
                        <div class="footer-stats">
                            <span class="stat-item" title="Attempts">
                                <i class="bi bi-arrow-repeat"></i> @item.AttemptCount
                            </span>
                            <span class="stat-item" title="Queued Time">
                                <i class="bi bi-clock"></i> @GetTimeAgo(item.QueuedDate)
                            </span>
                        </div>
                        
                        <div class="footer-actions">
                            @if (item.Status == "PENDING")
                            {
                                <button class="btn btn-icon-only text-primary" @onclick="() => RetryItem(item.QueueId)" title="Retry Now">
                                    <i class="bi bi-play-circle-fill fs-5"></i>
                                </button>
                            }
                            @if (!string.IsNullOrEmpty(item.LastError))
                            {
                                <button class="btn btn-icon-only text-danger" @onclick="() => ShowError(item.LastError)" title="View Error">
                                    <i class="bi bi-exclamation-circle-fill fs-5"></i>
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}

@if (!string.IsNullOrEmpty(_message))
{
    <div class="alert @(_messageIsError ? "alert-danger" : "alert-success") mt-3 fade-in">
        <i class="bi @(_messageIsError ? "bi-exclamation-triangle" : "bi-check-circle")"></i>
        @_message
    </div>
}

@code {
    private List<ControllerSyncQueueItem> _allItems = new();
    private List<KeyCard> _unconfirmedMissingFromQueue = new();
    private Dictionary<int, string> _memberNames = new();
    private bool _loading = true;
    private bool _processing = false;
    private string _statusFilter = "PENDING";
    private int _pendingCount = 0;
    private int _completedTodayCount = 0;
    private string? _oldestPendingAge = null;
    private string _message = string.Empty;
    private bool _messageIsError = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadQueueAsync();
    }

    private async Task LoadQueueAsync()
    {
        _loading = true;
        _message = string.Empty;
        
        try
        {
            // Load all queue items
            var pending = await SyncQueueRepository.GetByStatusAsync("PENDING");
            var completed = await SyncQueueRepository.GetByStatusAsync("COMPLETED");
            
            _allItems = pending.Concat(completed).OrderBy(x => x.QueuedDate).ToList();
            
            // Calculate metrics
            _pendingCount = pending.Count;
            _completedTodayCount = completed.Count(x => x.CompletedDate.HasValue && x.CompletedDate.Value.Date == DateTime.Today);
            
            // Look for cards that are unconfirmed but NOT in the queue
            var allCards = await Task.Run(() => KeyCardRepository.GetAll());
            var pendingCardIds = pending.Select(p => p.KeyCardId).ToHashSet();
            
            _unconfirmedMissingFromQueue = allCards
                .Where(c => !c.IsControllerSynced && !pendingCardIds.Contains(c.KeyCardId))
                .ToList();

            if (pending.Any())
            {
                var oldest = pending.OrderBy(x => x.QueuedDate).First();
                var age = DateTime.Now - oldest.QueuedDate;
                _oldestPendingAge = FormatTimeSpan(age);
            }
            else
            {
                _oldestPendingAge = null;
            }
            
            // Load member names
            _memberNames.Clear();
            foreach (var item in _allItems)
            {
                try
                {
                    var card = await Task.Run(() => KeyCardRepository.GetById(item.KeyCardId));
                    if (card != null)
                    {
                        var member = await Task.Run(() => MemberRepository.GetMemberById(card.MemberId));
                        if (member != null)
                        {
                            _memberNames[item.KeyCardId] = $"{member.FirstName} {member.LastName}";
                        }
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Failed to load member name for card {KeyCardId}", item.KeyCardId);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading sync queue");
            _message = "Failed to load sync queue";
            _messageIsError = true;
        }
        finally
        {
            _loading = false;
        }
    }

    private IEnumerable<ControllerSyncQueueItem> FilteredItems
    {
        get
        {
            return _statusFilter switch
            {
                "PENDING" => _allItems.Where(x => x.Status == "PENDING"),
                "COMPLETED" => _allItems.Where(x => x.Status == "COMPLETED"),
                _ => _allItems
            };
        }
    }

    private void SetStatusFilter(string filter)
    {
        _statusFilter = filter;
    }

    private async Task RefreshQueue()
    {
        await LoadQueueAsync();
    }

    private async Task RetryItem(int queueId)
    {
        _processing = true;
        _message = string.Empty;
        
        try
        {
            // TODO: Implement actual retry logic
            Logger.LogInformation("Retrying sync for queue item {QueueId}", queueId);
            _message = "Retry triggered successfully";
            _messageIsError = false;
            
            await Task.Delay(500); // Simulate processing
            await LoadQueueAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error retrying sync");
            _message = "Failed to retry sync";
            _messageIsError = true;
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task RetryAllPending()
    {
        _processing = true;
        _message = string.Empty;
        
        try
        {
            // TODO: Implement retry all logic
            Logger.LogInformation("Retrying all pending syncs");
            _message = $"Triggered retry for {_pendingCount} pending sync(s)";
            _messageIsError = false;
            
            await Task.Delay(500);
            await LoadQueueAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error retrying all syncs");
            _message = "Failed to retry all syncs";
            _messageIsError = true;
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task ClearCompleted()
    {
        _processing = true;
        _message = string.Empty;
        
        try
        {
            await SyncQueueRepository.DeleteCompletedOlderThanAsync(0); // Delete all completed
            _message = "Cleared completed sync items";
            _messageIsError = false;
            
            await LoadQueueAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error clearing completed items");
            _message = "Failed to clear completed items";
            _messageIsError = true;
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task RequeueMissingTasks()
    {
        _processing = true;
        _message = "Re-queuing missing tasks...";
        _messageIsError = false;
        
        try
        {
            int count = 0;
            foreach (var card in _unconfirmedMissingFromQueue)
            {
                await LifecycleService.SyncCardToControllerAsync(card.KeyCardId, card.IsActive);
                count++;
            }
            
            _message = $"Successfully re-queued {count} task(s).";
            await LoadQueueAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error re-queuing missing tasks");
            _message = "Failed to re-queue missing tasks.";
            _messageIsError = true;
        }
        finally
        {
            _processing = false;
        }
    }

    private void ViewDetails(ControllerSyncQueueItem item)
    {
        Logger.LogInformation("View details for queue item {QueueId}", item.QueueId);
    }

    private async Task ShowError(string? error)
    {
        if (string.IsNullOrEmpty(error)) return;
        await JSRuntime.InvokeVoidAsync("alert", $"Last Sync Error:\n\n{error}");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/keycards");
    }

    private string GetRowClass(ControllerSyncQueueItem item)
    {
        if (item.Status == "COMPLETED") return "table-row-success";
        if (item.AttemptCount > 50) return "table-row-danger";
        if (item.AttemptCount > 20) return "table-row-warning";
        return "";
    }

    private string GetAttemptsClass(int attempts)
    {
        if (attempts > 50) return "badge bg-danger";
        if (attempts > 20) return "badge bg-warning";
        if (attempts > 10) return "badge bg-info";
        return "badge bg-secondary";
    }

    private DateTime CalculateNextRetryTime(int attemptCount, DateTime lastAttemptDate)
    {
        TimeSpan delay = attemptCount switch
        {
            0 => TimeSpan.Zero,
            1 => TimeSpan.FromMinutes(5),
            2 => TimeSpan.FromMinutes(15),
            _ => TimeSpan.FromMinutes(30)
        };
        
        return lastAttemptDate.Add(delay);
    }

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.Now - date;
        
        if (span.TotalMinutes < 1) return "Just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays}d ago";
        
        return date.ToString("MMM d, yyyy");
    }

    private string FormatTimeSpan(TimeSpan span)
    {
        if (span.TotalMinutes < 1) return "< 1 min";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes} min";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h {span.Minutes}m";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays}d {span.Hours}h";
        
        return $"{(int)span.TotalDays} days";
    }

    private string TruncateError(string error)
    {
        if (string.IsNullOrEmpty(error)) return "";
        return error.Length > 50 ? error.Substring(0, 47) + "..." : error;
    }
}

<style>
    .metric-card {
        background: var(--bg-surface);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 16px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease;
    }

    .metric-card:hover { transform: translateY(-3px); }

    .metric-icon {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
    }

    .metric-value {
        font-size: 1.850rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: var(--text-primary);
    }

    .unconfirmed-notice {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-left: 5px solid #f59e0b;
        border-radius: 12px;
        padding: 1rem 1.5rem;
    }

    .notice-icon {
        width: 42px;
        height: 42px;
        background: #fef3c7;
        color: #d97706;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
    }

    /* Queue Grid & Cards */
    .queue-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .queue-card {
        background: var(--bg-surface);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
    }

    .queue-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        border-color: var(--accent-primary);
    }

    .queue-card-header {
        padding: 1.25rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-num-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .card-icon {
        width: 32px;
        height: 32px;
        background: var(--bg-surface);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
    }

    .card-num {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
        color: var(--text-primary);
    }

    .queue-card-body {
        padding: 1.5rem;
        flex-grow: 1;
    }

    .member-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .member-id {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .action-info {
        margin-top: 1.25rem;
        padding: 0.75rem;
        background: var(--bg-secondary);
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .action-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--text-muted);
    }

    .action-value {
        font-weight: 800;
        font-size: 0.85rem;
    }

    .queue-card-footer {
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--glass-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.01);
    }

    .footer-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    /* Modern Badges */
    .badge-modern {
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.65rem;
        font-weight: 800;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .badge-warning { background: #fffbeb; color: #d97706; }
    .dot.pulse-warning { background: #f59e0b; animation: pulse-warning 2s infinite; }

    .badge-info { background: #eff6ff; color: #2563eb; }
    .badge-success { background: #f0fdf4; color: #166534; }

    @@keyframes pulse-warning {
        0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
        70% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }

    .empty-state-modern {
        text-align: center;
        padding: 5rem 2rem;
        background: var(--bg-surface);
        border-radius: 24px;
        border: 2px dashed var(--glass-border);
    }

    .empty-icon-wrapper {
        width: 80px;
        height: 80px;
        background: var(--bg-secondary);
        color: var(--text-muted);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin: 0 auto 1.5rem;
    }

    .spinner-modern {
        width: 40px;
        height: 40px;
        border: 3px solid var(--bg-secondary);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @@keyframes spin { to { transform: rotate(360deg); } }
</style>
