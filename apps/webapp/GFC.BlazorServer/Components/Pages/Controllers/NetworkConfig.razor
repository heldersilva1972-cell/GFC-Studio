@page "/controllers/{ControllerId:int}/network-config"
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using GFC.BlazorServer.Models
@using Microsoft.AspNetCore.Authorization
@inject ControllerRegistryService RegistryService
@inject ControllerNetworkConfigService NetworkConfigService
@inject CommandInfoService CommandInfoService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject ISystemSettingsService SystemSettingsService
@inject NavigationManager Navigation
@inject ILogger<NetworkConfig> Logger
@inject GfcDbContext DbContext
@inject IJSRuntime JSRuntime

<PageTitle>Network Configuration - GFC Controllers</PageTitle>

<div class="page-header">
    <div>
        <h1>Network Configuration</h1>
        <p class="text-muted mb-0">@(_controller?.Name ?? "Unknown controller")</p>
        @if (_useRealControllers)
        {
            <span class="badge bg-success ms-2">
                <i class="bi bi-hdd-network"></i> Real Controller Mode
            </span>
        }
        else
        {
            <span class="badge bg-warning text-dark ms-2">
                <i class="bi bi-cpu"></i> Simulation Mode (dangerous ops blocked)
            </span>
        }
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" @onclick="ReadFromController" disabled="@(_isLoading || _isSyncing)">
            <i class="bi bi-arrow-down-circle"></i> Read from Controller
        </button>
        <button class="btn btn-success" @onclick="SaveToDb" disabled="@(_isLoading || _isSaving)">
            <i class="bi bi-save"></i> Save to DB
        </button>
        <button class="btn btn-outline-secondary" @onclick="NavigateBackToDashboard">
            <i class="bi bi-arrow-left"></i> Back
        </button>
    </div>
</div>

@if (!_useRealControllers)
{
    <div class="alert alert-warning mb-3">
        <strong>Simulation Mode enabled:</strong> Syncing network or security settings to real controllers is blocked until Real Controller Mode is enabled in System Settings.
    </div>
}

@if (_errorMessage != null)
{
    <div class="alert alert-danger">@_errorMessage</div>
}

@if (_successMessage != null)
{
    <div class="alert alert-success">@_successMessage</div>
}

@if (_controller == null)
{
    <div class="alert alert-warning">Controller not found.</div>
}
else if (_isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="data-card">
        @if (_networkConfigCommandInfo != null)
        {
            <div class="alert alert-@(_networkConfigCommandInfo.RiskLevel >= 2 ? "warning" : "info") mb-3">
                <strong>@_networkConfigCommandInfo.DisplayName</strong> (Risk Level: @_networkConfigCommandInfo.RiskLevel / 3)
                <br />
                <small>@_networkConfigCommandInfo.ShortDescription</small>
            </div>
        }

        <EditForm Model="_config">
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-md-6">
                    <h5>Network Settings</h5>
                    <div class="mb-3">
                        <label class="form-label">IP Address</label>
                        <InputText class="form-control" @bind-Value="_config.IpAddress" placeholder="192.168.1.100" />
                        <ValidationMessage For="@(() => _config.IpAddress)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Subnet Mask</label>
                        <InputText class="form-control" @bind-Value="_config.SubnetMask" placeholder="255.255.255.0" />
                        <ValidationMessage For="@(() => _config.SubnetMask)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Gateway</label>
                        <InputText class="form-control" @bind-Value="_config.Gateway" placeholder="192.168.1.1" />
                        <ValidationMessage For="@(() => _config.Gateway)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Port</label>
                        <InputNumber class="form-control" @bind-Value="_config.Port" min="1" max="65535" />
                        <ValidationMessage For="@(() => _config.Port)" />
                        <small class="form-text text-muted">UDP port for controller communication (1-65535)</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <InputCheckbox class="form-check-input" @bind-Value="_config.DhcpEnabled" id="dhcp-enabled" />
                            <label class="form-check-label" for="dhcp-enabled">
                                Enable DHCP
                            </label>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h5>Security Settings</h5>
                    <div class="mb-3">
                        <label class="form-label">Allowed PC IP</label>
                        <InputText class="form-control" @bind-Value="_config.AllowedPcIp" placeholder="192.168.1.50" />
                        <ValidationMessage For="@(() => _config.AllowedPcIp)" />
                        <small class="form-text text-muted">IP address of the PC allowed to communicate with this controller</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">New Controller Password</label>
                        <InputText type="password" class="form-control" @bind-Value="_newPassword" placeholder="Leave blank to keep current password" />
                        <small class="form-text text-muted">Only enter if you want to change the password. Leave blank to keep the current password.</small>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(_config.CommPasswordMasked))
                    {
                        <div class="mb-3">
                            <small class="text-muted">Current password status: @_config.CommPasswordMasked</small>
                        </div>
                    }
                </div>
            </div>

            <div class="mt-3">
                <small class="text-muted">
                    @if (_config.LastReadUtc.HasValue)
                    {
                        <span>Last read from controller: @_config.LastReadUtc.Value.ToLocalTime().ToString("g")</span>
                    }
                    @if (_config.LastSyncUtc.HasValue)
                    {
                        <span class="ms-3">Last synced to controller: @_config.LastSyncUtc.Value.ToLocalTime().ToString("g")</span>
                    }
                </small>
            </div>
        </EditForm>
    </div>

    <div class="danger-zone card mt-4">
        <div class="card-body">
            <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
                <div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-danger text-light">Danger Zone</span>
                        @if (_networkConfigCommandInfo != null)
                        {
                            <span class="text-muted small">Risk Level @_networkConfigCommandInfo.RiskLevel / 3</span>
                        }
                    </div>
                    <p class="mb-2 text-danger fw-semibold">Applying these changes updates live controller network access and may disconnect the device if IP, allowed PC, or passwords are incorrect.</p>
                    <p class="mb-0 text-muted small">
                        This action writes the current network settings (including Allowed PC IP and controller password) to the controller.
                    </p>
                </div>
                <div class="text-end">
                    <button class="btn btn-danger"
                            @onclick="ShowSyncConfirmationModal"
                            disabled="@(_isLoading || _isSyncing || _controller?.IsEnabled != true || !_useRealControllers)"
                            title="@(!_useRealControllers ? "Disabled while in Simulation Mode. Enable 'Use real controllers' in Settings to push network changes." : _syncTooltip)">
                        <i class="bi bi-cloud-upload"></i>
                        Apply Network Changes
                    </button>
                    @if (!_useRealControllers)
                    {
                        <div class="text-danger small mt-2">Blocked while Simulation Mode is enabled.</div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* Double Confirmation Modal for Sync *@
@if (_showSyncConfirmation)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.4);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Apply Network Configuration to Controller</h5>
                    <button type="button" class="btn-close" @onclick="CloseSyncConfirmation"></button>
                </div>
                <div class="modal-body">
                    @if (_networkConfigCommandInfo != null)
                    {
                        <div class="alert alert-danger">
                            <strong>@_networkConfigCommandInfo.DisplayName</strong> (Risk Level: @_networkConfigCommandInfo.RiskLevel / 3)
                            <br />
                            <small>@_networkConfigCommandInfo.ShortDescription</small>
                        </div>
                    }
                    <p>This will write network settings to controller <strong>@(_controller?.Name ?? "Unknown")</strong>.</p>
                    @if (_confirmStep == 1)
                    {
                        <p class="text-danger">
                            <strong>Warning:</strong> Controller connectivity may drop during apply; ensure the IP, subnet, gateway, and Allowed PC IP are correct.
                        </p>
                    }
                    else
                    {
                        <p class="text-danger">
                            <strong>Final Warning:</strong> Incorrect IP, Allowed PC, or password can lock out controller management or disconnect the device from the network.
                        </p>
                        <p class="text-muted small">
                            IP: @_config.IpAddress<br />
                            Port: @_config.Port<br />
                            Allowed PC: @_config.AllowedPcIp<br />
                            @if (!string.IsNullOrWhiteSpace(_newPassword))
                            {
                                <span>Password: <strong>Will be changed</strong></span>
                            }
                        </p>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="CloseSyncConfirmation" disabled="@_isSyncing">Cancel</button>
                    @if (_confirmStep == 1)
                    {
                        <button class="btn btn-warning" @onclick="ProceedToFinalConfirmation" disabled="@_isSyncing">
                            I Understand - Continue
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-danger" @onclick="ConfirmSyncToController" disabled="@_isSyncing">
                            @(_isSyncing ? "Syncing..." : "Confirm Sync")
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ControllerId { get; set; }

    private ControllerDevice? _controller;
    private ControllerNetworkConfig _config = new();
    private string? _newPassword;
    private bool _isLoading = false;
    private bool _isSaving = false;
    private bool _isSyncing = false;
    private bool _useRealControllers = false;
    private string? _errorMessage;
    private string? _successMessage;
    private string _syncTooltip = "Sync network configuration to controller";
    private ControllerCommandInfo? _networkConfigCommandInfo;
    private bool _showSyncConfirmation = false;
    private int _confirmStep = 1;
    private bool _isUnauthorized = false;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            var isAdmin = await CheckAdminAccess();
            if (!isAdmin)
            {
                _isUnauthorized = true;
                _isLoading = false;
                return;
            }

            await LoadControllerModeAsync();
            await LoadController();
            await LoadNetworkConfig();
            await LoadCommandInfo();
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _isUnauthorized)
        {
            Navigation.NavigateTo("/", forceLoad: true);
            return;
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task<bool> CheckAdminAccess()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var isAdmin = authState.User.IsInRole(AppRoles.Admin);
        if (!isAdmin)
        {
            var currentUser = AuthStateProvider.GetCurrentUser();
            isAdmin = currentUser?.IsAdmin == true;
        }

        if (!isAdmin)
        {
            Logger.LogWarning("Non-admin user attempted to access Network Config page");
            return false;
        }
        return true;
    }

    private async Task LoadController()
    {
        try
        {
            _controller = await RegistryService.GetControllerByIdAsync(ControllerId);
            if (_controller == null)
            {
                _errorMessage = "Controller not found.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load controller");
            _errorMessage = "Failed to load controller: " + ex.Message;
        }
    }

    private async Task LoadNetworkConfig()
    {
        if (_controller == null) return;

        try
        {
            var config = await NetworkConfigService.GetFromDbAsync(ControllerId);
            if (config != null)
            {
                _config = config;
            }
            else
            {
                _config = new ControllerNetworkConfig
                {
                    ControllerId = ControllerId,
                    Port = 60000
                };
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load network config");
            _errorMessage = "Failed to load network configuration: " + ex.Message;
        }
    }

    private async Task LoadCommandInfo()
    {
        try
        {
            _networkConfigCommandInfo = await CommandInfoService.GetByKeyAsync("SyncNetworkConfig");
            if (_networkConfigCommandInfo != null)
            {
                _syncTooltip = $"{_networkConfigCommandInfo.DisplayName} (Risk Level {_networkConfigCommandInfo.RiskLevel}): {_networkConfigCommandInfo.ShortDescription}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load command info");
        }
    }

    private async Task ReadFromController()
    {
        if (_controller == null) return;

        _isLoading = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            var config = await NetworkConfigService.ReadFromControllerAsync(_controller.SerialNumber);
            if (config != null)
            {
                _config = config;
                _successMessage = "Network configuration read from controller successfully.";
                
                // Audit log
                var currentUser = AuthStateProvider.GetCurrentUser();
                var userName = currentUser?.Username ?? Environment.UserName ?? "System";
                DbContext.ControllerCommandLogs.Add(new ControllerCommandLog
                {
                    ControllerId = ControllerId,
                    Action = "ReadNetworkConfig",
                    Success = true,
                    TimestampUtc = DateTime.UtcNow
                });
                await DbContext.SaveChangesAsync();
            }
            else
            {
                _errorMessage = "Failed to read network configuration from controller.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to read network config from controller");
            if (ex.Message.Contains("501") || ex.Message.Contains("NotImplemented"))
            {
                _errorMessage = "Network configuration read is not implemented in Agent/firmware.";
            }
            else
            {
                _errorMessage = "Failed to read from controller: " + ex.Message;
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveToDb()
    {
        if (_controller == null) return;

        _isSaving = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            _config.ControllerId = ControllerId;
            await NetworkConfigService.SaveToDbAsync(_config);
            _successMessage = "Network configuration saved to database.";
            
            // Audit log
            var currentUser = AuthStateProvider.GetCurrentUser();
            var userName = currentUser?.Username ?? Environment.UserName ?? "System";
            DbContext.ControllerCommandLogs.Add(new ControllerCommandLog
            {
                ControllerId = ControllerId,
                Action = "SaveNetworkConfig",
                Success = true,
                TimestampUtc = DateTime.UtcNow
            });
            await DbContext.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save network config");
            _errorMessage = "Failed to save configuration: " + ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void ShowSyncConfirmationModal()
    {
        if (_controller == null || !_controller.IsEnabled)
        {
            _errorMessage = "Controller must be enabled before syncing.";
            return;
        }
        if (!_useRealControllers)
        {
            _errorMessage = "Sync is disabled while Simulation Mode is enabled.";
            return;
        }
        _confirmStep = 1;
        _showSyncConfirmation = true;
    }

    private void CloseSyncConfirmation()
    {
        _showSyncConfirmation = false;
        _confirmStep = 1;
    }

    private void ProceedToFinalConfirmation()
    {
        _confirmStep = 2;
    }

    private async Task ConfirmSyncToController()
    {
        if (_controller == null || !_controller.IsEnabled || !_useRealControllers) return;

        _isSyncing = true;
        _errorMessage = null;
        _successMessage = null;
        CloseSyncConfirmation();

        try
        {
            // Validate IP addresses
            if (!string.IsNullOrWhiteSpace(_config.IpAddress) && !System.Net.IPAddress.TryParse(_config.IpAddress, out _))
            {
                _errorMessage = "Invalid IP address format.";
                return;
            }

            if (!string.IsNullOrWhiteSpace(_config.SubnetMask) && !System.Net.IPAddress.TryParse(_config.SubnetMask, out _))
            {
                _errorMessage = "Invalid subnet mask format.";
                return;
            }

            if (!string.IsNullOrWhiteSpace(_config.Gateway) && !System.Net.IPAddress.TryParse(_config.Gateway, out _))
            {
                _errorMessage = "Invalid gateway format.";
                return;
            }

            if (!string.IsNullOrWhiteSpace(_config.AllowedPcIp) && !System.Net.IPAddress.TryParse(_config.AllowedPcIp, out _))
            {
                _errorMessage = "Invalid Allowed PC IP format.";
                return;
            }

            // Sync network config (includes allowed PC and password sync)
            await NetworkConfigService.SyncToControllerAsync(_controller.SerialNumber, _config, _newPassword);

            _successMessage = $"Network configuration synced successfully to controller '{_controller.Name}'.";
            Logger.LogInformation("Network config synced to controller {ControllerId}", ControllerId);
            
            // Clear password field after successful sync
            _newPassword = null;
            
            // Audit log
            var currentUser = AuthStateProvider.GetCurrentUser();
            var userName = currentUser?.Username ?? Environment.UserName ?? "System";
            DbContext.ControllerCommandLogs.Add(new ControllerCommandLog
            {
                ControllerId = ControllerId,
                Action = "SyncNetworkConfig",
                Success = true,
                TimestampUtc = DateTime.UtcNow
            });
            await DbContext.SaveChangesAsync();

            // Reload config to get updated timestamps
            await LoadNetworkConfig();
        }

        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to sync network config to controller");
            if (ex.Message.Contains("501") || ex.Message.Contains("NotImplemented"))
            {
                _errorMessage = "Network configuration sync is not implemented in Agent/firmware.";
            }
            else
            {
                _errorMessage = $"Failed to sync configuration to '{_controller.Name}': {ex.Message}";
            }
        }
        finally
        {
            _isSyncing = false;
        }
    }

    private void NavigateBackToDashboard()
    {
        Navigation.NavigateTo("/controllers");
    }

    private async Task LoadControllerModeAsync()
    {
        try
        {
            var settings = await SystemSettingsService.GetAsync();
            _useRealControllers = true; // Simulation mode removed
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load controller mode indicator; defaulting to simulation for UI only");
            _useRealControllers = false;
        }
    }
}

<style>
    .danger-zone {
        border: 1px solid #f5c2c7;
        background-color: #fff7f8;
    }

    .danger-zone .card-body {
        padding: 1.25rem;
    }

    .danger-zone .btn-danger {
        min-width: 220px;
    }
</style>
