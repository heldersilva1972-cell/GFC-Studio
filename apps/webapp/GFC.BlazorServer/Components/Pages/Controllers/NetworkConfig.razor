@page "/controllers/{ControllerId:int}/network-config"
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using GFC.BlazorServer.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@inject ControllerRegistryService RegistryService
@inject ControllerNetworkConfigService NetworkConfigService
@inject CommandInfoService CommandInfoService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject ISystemSettingsService SystemSettingsService
@inject NavigationManager Navigation
@inject ILogger<NetworkConfig> Logger
@inject IDbContextFactory<GfcDbContext> DbFactory
@inject IJSRuntime JSRuntime

<PageTitle>Network Configuration - GFC Controllers</PageTitle>

<div class="controller-container">
    @if (_initError != null)
    {
        <div class="alert alert-danger glass-panel py-4 px-5 fadeIn mb-4">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-bug-fill fs-2"></i>
                <div>
                    <h4 class="mb-1">Initialization Error</h4>
                    <p class="mb-0 opacity-75">@_initError</p>
                    @if (_initError.Contains("column name"))
                    {
                        <p class="mt-2 small text-warning"><i class="bi bi-info-circle"></i> This confirms the database needs to be updated. Please run the provided SQL script in SSMS.</p>
                    }
                </div>
            </div>
            <button class="btn-modern btn-outline-modern mt-3" @onclick="() => _initError = null">Dismiss</button>
        </div>
    }

    <header class="page-header fadeIn">
        <div class="header-title">
            <div class="d-flex align-items-center gap-3">
                <button class="btn-icon-back" @onclick="NavigateBackToDashboard" title="Back to Settings">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <div>
                    <h1>Network Configuration</h1>
                    <p class="mb-0">@(_controller?.Name ?? ( _isLoading ? "Loading..." : "Hardware Setup" ))</p>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <div class="d-flex gap-2">
                <button class="btn-modern btn-outline-modern" @onclick="ReadFromController" disabled="@(_isLoading || _isSyncing || _controller == null)">
                    <i class="bi bi-broadcast-pin"></i> Read from Hardware
                </button>
                <button class="btn-modern btn-primary-modern" @onclick="SaveToDb" disabled="@(_isLoading || _isSaving || _controller == null)">
                    <i class="bi bi-save"></i> Save Changes
                </button>
            </div>
        </div>
    </header>

    @if (_errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show glass-panel py-3 px-4 mb-4 fadeIn" role="alert">
            <i class="bi bi-exclamation-octagon-fill me-2"></i> @_errorMessage
            <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
        </div>
    }

    @if (_successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show glass-panel py-3 px-4 mb-4 fadeIn" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @_successMessage
            <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
        </div>
    }

    @if (_controller == null && !_isLoading)
    {
        <div class="glass-panel text-center py-5 fadeIn">
            <i class="bi bi-search text-muted mb-3" style="font-size: 3rem;"></i>
            <h3 class="text-muted">Controller not found</h3>
            <button class="btn-modern btn-outline-modern mt-3" @onclick="NavigateBackToDashboard">Return to Settings</button>
        </div>
    }
    else if (_isLoading)
    {
        <div class="text-center my-5 py-5 fadeIn">
            <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Awaiting controller response...</p>
        </div>
    }
    else
    {
        <div class="settings-layout fadeIn">
            <div class="settings-main">
                <div class="glass-panel mb-4">
                    <div class="panel-header mb-4">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-hdd-network text-primary fs-4"></i>
                            <h2 class="mb-0">Hardware IP Assignment</h2>
                        </div>
                    </div>

                    <EditForm Model="_config">
                        <DataAnnotationsValidator />
                        
                        <div class="settings-grid">
                            <div class="modern-field">
                                <label class="form-label">Static IP Address</label>
                                <InputText class="modern-input" @bind-Value="_config.IpAddress" placeholder="192.168.1.100" />
                                <div class="form-label-desc">Unique address of the controller on your local network.</div>
                            </div>

                            <div class="modern-field">
                                <label class="form-label">Gateway Address</label>
                                <InputText class="modern-input" @bind-Value="_config.Gateway" placeholder="192.168.1.1" />
                                <div class="form-label-desc">The default router address for external communication.</div>
                            </div>

                            <div class="modern-field">
                                <label class="form-label">Subnet Mask</label>
                                <InputText class="modern-input" @bind-Value="_config.SubnetMask" placeholder="255.255.255.0" />
                                <div class="form-label-desc">Typically 255.255.255.0 for standard networks.</div>
                            </div>

                            <div class="modern-field">
                                <label class="form-label">Communication Port</label>
                                <InputNumber TValue="int?" class="modern-input" @bind-Value="_config.Port" />
                                <div class="form-label-desc">UDP port used by the GFC Agent (Default: 60000).</div>
                            </div>
                        </div>

                        <div class="mt-4 pt-3 border-top border-glass">
                            <div class="status-box d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="fw-bold">Dynamic IP (DHCP)</div>
                                    <div class="form-label-desc">Allow router to assign IP automatically. Static IP is recommended for controllers.</div>
                                </div>
                                <div class="form-check form-switch fs-4">
                                    <InputCheckbox class="form-check-input" @bind-Value="_config.DhcpEnabled" id="dhcp-enabled" />
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </div>

                <div class="glass-panel">
                    <div class="panel-header mb-4">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-shield-lock text-primary fs-4"></i>
                            <h2 class="mb-0">Access Security & Passwords</h2>
                        </div>
                    </div>

                    <div class="settings-grid">
                        <div class="modern-field">
                            <label class="form-label">Allowed PC IP</label>
                            <InputText class="modern-input" @bind-Value="_config.AllowedPcIp" placeholder="192.168.1.50" />
                            <div class="form-label-desc">Strict mode: Only this PC IP can communicate with the controller.</div>
                        </div>

                        <div class="modern-field">
                            <label class="form-label">Hardware Comm Password</label>
                            <InputText type="password" class="modern-input" @bind-Value="_newPassword" placeholder="••••••••" />
                            <div class="form-label-desc">Leave blank to keep existing. Masked current: @(_config.CommPasswordMasked ?? "None")</div>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="settings-sidebar">
                <div class="glass-panel mb-4 status-panel">
                    <h3>Configuration Status</h3>
                    
                    <div class="status-list mt-3">
                        <div class="status-item">
                            <span class="dot @( _config.LastReadUtc.HasValue ? "success" : "warning" )"></span>
                            <div class="status-text">
                                <label>Hardware Read</label>
                                <span>@(_config.LastReadUtc?.ToLocalTime().ToString("g") ?? "Never")</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="dot @( _config.LastSyncUtc.HasValue ? "success" : "warning" )"></span>
                            <div class="status-text">
                                <label>Controller Sync</label>
                                <span>@(_config.LastSyncUtc?.ToLocalTime().ToString("g") ?? "Never")</span>
                            </div>
                        </div>
                    </div>

                    <div class="info-alert mt-4">
                        <i class="bi bi-info-circle"></i>
                        <p>Changes saved to DB do not affect hardware until you click <strong>Apply to Controller</strong> below.</p>
                    </div>
                </div>

                <div class="danger-panel fadeIn">
                    <div class="panel-header d-flex align-items-center gap-2 mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-danger fs-4"></i>
                        <h3 class="text-danger mb-0">Hardware Write</h3>
                    </div>
                    <p class="small opacity-75 mb-4">Updating these settings will briefly disconnect the controller. Incorrect IP settings may require a physical factory reset.</p>
                    
                    <button class="btn-modern btn-danger w-100 py-3 fw-bold"
                            @onclick="ShowSyncConfirmationModal"
                            disabled="@(_isLoading || _isSyncing || _controller?.IsEnabled != true || !_useRealControllers)">
                        @if(_isSyncing) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        else { <i class="bi bi-cloud-upload me-2"></i> }
                        Apply to Controller
                    </button>
                    
                    @if (!_useRealControllers)
                    {
                        <div class="badge bg-soft-danger text-danger mt-3 w-100 py-2 text-center">Simulation Mode Active</div>
                    }
                </div>
            </aside>
        </div>
    }
</div>

@* Double Confirmation Modal for Sync *@
@if (_showSyncConfirmation)
{
    <div class="modal-backdrop fade show" @onclick="CloseSyncConfirmation"></div>
    <div class="modern-modal-container">
        <div class="modern-modal fadeIn">
            <div class="modal-header-modern danger">
                <div class="header-icon"><i class="bi bi-exclamation-triangle"></i></div>
                <h2>Hardware Update</h2>
                <button class="btn-close-modern" @onclick="CloseSyncConfirmation"><i class="bi bi-x"></i></button>
            </div>
            <div class="modal-body-modern">
                @if (_confirmStep == 1)
                {
                    <div class="warning-banner">
                        <strong>RISK LEVEL @(_networkConfigCommandInfo?.RiskLevel ?? 2)/3</strong>
                        <p>This will overwrite the physical network chips on <strong>@_controller?.Name</strong>.</p>
                    </div>
                    <p class="mt-4">Are you sure you want to push these settings? Controller connectivity will drop temporarily.</p>
                }
                else
                {
                    <div class="summary-list">
                        <div class="summary-item">
                            <label>Target IP</label>
                            <strong>@_config.IpAddress</strong>
                        </div>
                        <div class="summary-item">
                            <label>Allowed PC</label>
                            <strong>@_config.AllowedPcIp</strong>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(_newPassword))
                        {
                            <div class="summary-item">
                                <label>Password</label>
                                <span class="badge bg-warning text-dark">Will be updated</span>
                            </div>
                        }
                    </div>
                    <p class="mt-4 text-danger fw-bold">FINAL WARNING: If the target IP is unreachable from this PC, you will lose access!</p>
                }
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-outline-modern" @onclick="CloseSyncConfirmation" disabled="@_isSyncing">Abort</button>
                @if (_confirmStep == 1)
                {
                    <button class="btn-modern btn-warning" @onclick="ProceedToFinalConfirmation" disabled="@_isSyncing">
                        I Understand - Proceed
                    </button>
                }
                else
                {
                    <button class="btn-modern btn-danger" @onclick="ConfirmSyncToController" disabled="@_isSyncing">
                        @(_isSyncing ? "Writing Configuration..." : "Apply Final Changes")
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ControllerId { get; set; }

    private ControllerDevice? _controller;
    private ControllerNetworkConfig _config = new();
    private string? _newPassword;
    private bool _isLoading = false;
    private bool _isSaving = false;
    private bool _isSyncing = false;
    private bool _useRealControllers = true;
    private string? _errorMessage;
    private string? _successMessage;
    private string? _initError;
    private ControllerCommandInfo? _networkConfigCommandInfo;
    private bool _showSyncConfirmation = false;
    private int _confirmStep = 1;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            // Defensive loading to catch DB errors immediately
            await LoadControllerModeAsync();
            await LoadController();
            
            if (_controller != null)
            {
                await LoadNetworkConfig();
                await LoadCommandInfo();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Critical error initializing NetworkConfig page for Controller {Id}", ControllerId);
            _initError = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadController()
    {
        _controller = await RegistryService.GetControllerByIdAsync(ControllerId);
        if (_controller == null)
        {
            _errorMessage = $"Controller with ID {ControllerId} not found.";
        }
    }

    private async Task LoadNetworkConfig()
    {
        try
        {
            var config = await NetworkConfigService.GetFromDbAsync(ControllerId);
            if (config != null)
            {
                _config = config;
            }
            else
            {
                _config = new ControllerNetworkConfig
                {
                    ControllerId = ControllerId,
                    Port = 60000
                };
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load network config for Controller {Id}", ControllerId);
            _initError = "Database error while loading network configuration: " + ex.Message;
        }
    }

    private async Task LoadCommandInfo()
    {
        try
        {
            _networkConfigCommandInfo = await CommandInfoService.GetByKeyAsync("SyncNetworkConfig");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load command info");
        }
    }

    private async Task ReadFromController()
    {
        if (_controller == null) return;

        _isLoading = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            var config = await NetworkConfigService.ReadFromControllerAsync(_controller.SerialNumber);
            if (config != null)
            {
                _config = config;
                _successMessage = "Network configuration read successfully from hardware.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to read network config from controller");
            _errorMessage = "Hardware communication error: " + ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveToDb()
    {
        if (_controller == null) return;

        _isSaving = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            _config.ControllerId = ControllerId;
            await NetworkConfigService.SaveToDbAsync(_config);
            _successMessage = "Settings saved to local database.";
            
            // Audit log
            await using var db = await DbFactory.CreateDbContextAsync();
            db.ControllerCommandLogs.Add(new ControllerCommandLog
            {
                ControllerId = ControllerId,
                Action = "SaveNetworkConfig",
                Success = true,
                TimestampUtc = DateTime.UtcNow
            });
            await db.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save network config");
            _errorMessage = "Save error: " + ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void ShowSyncConfirmationModal()
    {
        if (_controller == null || !_controller.IsEnabled)
        {
            _errorMessage = "Controller must be enabled before syncing.";
            return;
        }
        _confirmStep = 1;
        _showSyncConfirmation = true;
    }

    private void CloseSyncConfirmation()
    {
        _showSyncConfirmation = false;
        _confirmStep = 1;
    }

    private void ProceedToFinalConfirmation()
    {
        _confirmStep = 2;
    }

    private async Task ConfirmSyncToController()
    {
        if (_controller == null || !_controller.IsEnabled) return;

        _isSyncing = true;
        _errorMessage = null;
        _successMessage = null;
        CloseSyncConfirmation();

        try
        {
            await NetworkConfigService.SyncToControllerAsync(_controller.SerialNumber, _config, _newPassword);

            _successMessage = $"Network configuration pushed successfully to '{_controller.Name}'.";
            _newPassword = null;
            
            // Audit log
            await using var db = await DbFactory.CreateDbContextAsync();
            db.ControllerCommandLogs.Add(new ControllerCommandLog
            {
                ControllerId = ControllerId,
                Action = "SyncNetworkConfig",
                Success = true,
                TimestampUtc = DateTime.UtcNow
            });
            await db.SaveChangesAsync();

            await LoadNetworkConfig();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to sync network config");
            _errorMessage = $"Sync error: {ex.Message}";
        }
        finally
        {
            _isSyncing = false;
        }
    }

    private void NavigateBackToDashboard()
    {
        Navigation.NavigateTo("/controllers/settings");
    }

    private async Task LoadControllerModeAsync()
    {
        try
        {
            var settings = await SystemSettingsService.GetAsync();
            _useRealControllers = true;
        }
        catch
        {
             _useRealControllers = true; 
        }
    }
}
