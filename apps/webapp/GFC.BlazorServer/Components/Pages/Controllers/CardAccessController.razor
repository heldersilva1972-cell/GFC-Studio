@page "/controllers"
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@inject ControllerRegistryService RegistryService
@inject ControllerEventService EventService
@inject IControllerClient ControllerClient
@inject GfcDbContext DbContext
@inject IDbContextFactory<GfcDbContext> DbFactory
@inject NavigationManager Navigation
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject ILogger<CardAccessController> Logger
@inject IJSRuntime JSRuntime

<PageTitle>Controller Dashboard - GFC</PageTitle>

<div class="dashboard-container">
    <header class="dashboard-header fadeIn">
        <div class="header-content">
            <div class="header-title">
                <h1><i class="bi bi-hdd-rack-fill me-3"></i>Controller Dashboard</h1>
                <p class="header-subtitle">Real-time monitoring and control center</p>
            </div>
            <div class="header-actions">
                <button class="btn-modern btn-outline-modern" @onclick="NavigateToSettings">
                    <i class="bi bi-gear-fill"></i> Configuration
                </button>
                <button class="btn-modern btn-primary-modern" @onclick="RefreshDashboard" disabled="@_isRefreshing">
                    @if (_isRefreshing) { <span class="spinner-border spinner-border-sm me-2"></span> }
                    else { <i class="bi bi-arrow-clockwise"></i> }
                    Refresh
                </button>
            </div>
        </div>
    </header>

    @if (_errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show glass-panel py-3 px-4 mb-4 fadeIn" role="alert">
            <i class="bi bi-exclamation-octagon-fill me-2"></i> @_errorMessage
            <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
        </div>
    }

    @if (_successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show glass-panel py-3 px-4 mb-4 fadeIn" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @_successMessage
            <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
        </div>
    }

    @if (_isLoading)
    {
        <div class="text-center my-5 py-5">
            <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading controller status...</p>
        </div>
    }
    else
    {
        <!-- Controller Status Grid -->
        <section class="status-grid fadeIn">
            @foreach (var controller in _controllers)
            {
                <div class="status-card @(controller.IsOnline ? "online" : "offline") @(_selectedControllerId == controller.Id ? "selected" : "")" 
                     @onclick="() => SelectController(controller.Id)">
                    <div class="status-card-header">
                        <div class="status-indicator-large">
                            <span class="pulse-dot @(controller.IsOnline ? "online" : "offline")"></span>
                        </div>
                        <div class="status-card-title">
                            <h3>@controller.Name</h3>
                            <span class="status-label">@(controller.IsOnline ? "Online" : "Offline")</span>
                        </div>
                    </div>
                    <div class="status-card-body">
                        <div class="metric-row">
                            <div class="metric">
                                <i class="bi bi-door-open-fill"></i>
                                <div>
                                    <span class="metric-value">@controller.Doors.Count</span>
                                    <span class="metric-label">Doors</span>
                                </div>
                            </div>
                            <div class="metric">
                                <i class="bi bi-activity"></i>
                                <div>
                                    <span class="metric-value">@GetRecentEventCount(controller.Id)</span>
                                    <span class="metric-label">Events (24h)</span>
                                </div>
                            </div>
                        </div>
                        <div class="quick-info">
                            <span><i class="bi bi-hdd-network"></i> @controller.IpAddress</span>
                            <span><i class="bi bi-hash"></i> SN: @controller.SerialNumberDisplay</span>
                        </div>
                    </div>
                    <div class="status-card-footer">
                        <button class="btn-card-action" @onclick:stopPropagation="true" @onclick="() => TestControllerConnection(controller.Id)" disabled="@_isTesting">
                            <i class="bi bi-broadcast"></i> Test
                        </button>
                        <button class="btn-card-action primary" @onclick:stopPropagation="true" @onclick="() => NavigateToControllerSettings(controller.Id)">
                            <i class="bi bi-gear"></i> Configure
                        </button>
                    </div>
                </div>
            }
        </section>

        @if (_selectedController != null)
        {
            <!-- Dashboard Details -->
            <div class="dashboard-details fadeIn">
                <!-- Left Column: Door Status & Quick Actions -->
                <div class="details-main">
                    <!-- Door Status Panel -->
                    <div class="glass-panel">
                        <div class="panel-header">
                            <h2><i class="bi bi-door-open-fill"></i> Door Status</h2>
                            <button class="btn-modern btn-sm btn-outline-modern" @onclick="() => NavigateToControllerSettings(_selectedController.Id)">
                                <i class="bi bi-plus-lg"></i> Manage Doors
                            </button>
                        </div>

                        @if (!_selectedController.Doors.Any())
                        {
                            <div class="empty-state">
                                <i class="bi bi-door-closed"></i>
                                <p>No doors configured</p>
                                <button class="btn-modern btn-primary-modern btn-sm" @onclick="() => NavigateToControllerSettings(_selectedController.Id)">
                                    Set Up Doors
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="door-grid">
                                @foreach (var door in _selectedController.Doors.OrderBy(d => d.DoorIndex))
                                {
                                    var isUnlocked = _unlockedDoors.Contains(door.Id);
                                    <div class="door-status-item @(door.IsEnabled ? "enabled" : "disabled") @(isUnlocked ? "unlocked" : "")">
                                        <div class="door-status-icon">
                                            <i class="bi bi-door-@(door.IsEnabled ? "open" : "closed")-fill"></i>
                                            <span class="door-index">#@door.DoorIndex</span>
                                            @if (isUnlocked)
                                            {
                                                <div class="unlock-indicator">
                                                    <i class="bi bi-unlock-fill"></i>
                                                </div>
                                            }
                                        </div>
                                        <div class="door-status-info">
                                            <div class="door-name">@door.Name</div>
                                            <div class="door-location">@(string.IsNullOrEmpty(door.Notes) ? "No location" : door.Notes)</div>
                                            
                                            <!-- Card Scanner Input -->
                                            <div class="card-scanner-input mt-2">
                                                <input type="text" 
                                                       class="scanner-field" 
                                                       placeholder="Scan card to test access..."
                                                       @onkeydown="@(e => HandleCardScan(e, door.Id))"
                                                       disabled="@(!door.IsEnabled)" />
                                            </div>
                                        </div>
                                        <div class="door-status-actions">
                                            <button class="btn-unlock-test" 
                                                    title="Test Unlock" 
                                                    @onclick="() => UnlockDoor(door.Id)" 
                                                    disabled="@(!door.IsEnabled || _isUnlocking)">
                                                @if (_isUnlocking && _unlockingDoorId == door.Id)
                                                {
                                                    <span class="spinner-border spinner-border-sm"></span>
                                                }
                                                else if (isUnlocked)
                                                {
                                                    <i class="bi bi-check-circle-fill"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-unlock-fill"></i>
                                                }
                                                <span>@(isUnlocked ? "Unlocked" : "Test Unlock")</span>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Quick Actions Panel -->
                    <div class="glass-panel">
                        <div class="panel-header">
                            <h2><i class="bi bi-lightning-charge-fill"></i> Quick Actions</h2>
                        </div>
                        <div class="quick-actions-grid">
                            <button class="action-card" @onclick="SyncTime">
                                <i class="bi bi-clock-history"></i>
                                <span>Sync Time</span>
                            </button>
                            <button class="action-card" @onclick="() => NavigateToScheduler(_selectedController.Id)">
                                <i class="bi bi-calendar3"></i>
                                <span>Schedules</span>
                            </button>
                            <button class="action-card" @onclick="() => NavigateToControllerSettings(_selectedController.Id)">
                                <i class="bi bi-sliders"></i>
                                <span>Settings</span>
                            </button>
                            <button class="action-card danger" @onclick="ShowEmergencyLockdown">
                                <i class="bi bi-shield-fill-exclamation"></i>
                                <span>Emergency</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Event Feed & System Info -->
                <div class="details-sidebar">
                    <!-- Recent Events -->
                    <div class="glass-panel">
                        <div class="panel-header">
                            <h2><i class="bi bi-activity"></i> Recent Events</h2>
                        </div>
                        <div class="event-feed">
                            @if (_recentEvents.Any())
                            {
                                @foreach (var evt in _recentEvents.Take(10))
                                {
                                    <div class="event-item">
                                        <div class="event-icon @GetEventTypeClass(evt.EventType)">
                                            <i class="bi @GetEventIcon(evt.EventType)"></i>
                                        </div>
                                        <div class="event-details">
                                            <div class="event-description">@GetEventDescription(evt)</div>
                                            <div class="event-time">@evt.TimestampUtc.ToLocalTime().ToString("g")</div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="empty-state-small">
                                    <i class="bi bi-inbox"></i>
                                    <p>No recent events</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- System Health -->
                    <div class="glass-panel">
                        <div class="panel-header">
                            <h2><i class="bi bi-heart-pulse-fill"></i> System Health</h2>
                        </div>
                        <div class="health-metrics">
                            <div class="health-item">
                                <span class="health-label">Connection</span>
                                <span class="health-status @(_selectedController.IsOnline ? "healthy" : "error")">
                                    @(_selectedController.IsOnline ? "Stable" : "Disconnected")
                                </span>
                            </div>
                            <div class="health-item">
                                <span class="health-label">Active Doors</span>
                                <span class="health-status healthy">@_selectedController.Doors.Count(d => d.IsEnabled) / @_selectedController.Doors.Count</span>
                            </div>
                            <div class="health-item">
                                <span class="health-label">Last Sync</span>
                                <span class="health-status">@GetLastSyncTime()</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<ControllerDevice> _controllers = new();
    private ControllerDevice? _selectedController;
    private int? _selectedControllerId;
    private List<ControllerEvent> _recentEvents = new();
    private HashSet<int> _unlockedDoors = new();
    private bool _isLoading = true;
    private bool _isRefreshing = false;
    private bool _isTesting = false;
    private bool _isUnlocking = false;
    private int? _unlockingDoorId;
    private string? _errorMessage;
    private string? _successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadControllers();
        if (_controllers.Any())
        {
            await SelectController(_controllers.First().Id);
        }
        _isLoading = false;
    }

    private string _currentCardInput = "";
    
    private async Task HandleCardScan(KeyboardEventArgs e, int doorId)
    {
        if (e.Key == "Enter")
        {
            if (!string.IsNullOrWhiteSpace(_currentCardInput))
            {
                await ValidateCardAccess(_currentCardInput, doorId);
                _currentCardInput = "";
            }
        }
        else if (e.Key.Length == 1)
        {
            _currentCardInput += e.Key;
        }
    }

    private async Task ValidateCardAccess(string cardNumber, int doorId)
    {
        try
        {
            var door = _selectedController?.Doors.FirstOrDefault(d => d.Id == doorId);
            if (door == null || _selectedController == null) return;

            // Check if card has access to this door
            await using var db = await DbFactory.CreateDbContextAsync();
            
            var hasAccess = await db.MemberDoorAccesses
                .AnyAsync(mda => mda.CardNumber.ToString() == cardNumber && 
                                 mda.DoorId == doorId &&
                                 mda.IsEnabled);

            if (hasAccess)
            {
                // Grant access - unlock the door
                await ControllerClient.OpenDoorAsync(_selectedController.SerialNumber.ToString(), door.DoorIndex);
                
                // Add visual feedback
                _unlockedDoors.Add(doorId);
                _successMessage = $"✓ Access Granted - Card {cardNumber} unlocked '{door.Name}'";
                
                // Auto-remove unlock indicator after 3 seconds
                _ = Task.Run(async () =>
                {
                    await Task.Delay(3000);
                    _unlockedDoors.Remove(doorId);
                    await InvokeAsync(StateHasChanged);
                });
            }
            else
            {
                _errorMessage = $"✗ Access Denied - Card {cardNumber} does not have access to '{door.Name}'";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error validating card access");
            _errorMessage = "Card validation error: " + ex.Message;
        }
    }

    private async Task LoadControllers()
    {
        try
        {
            _controllers = (await RegistryService.GetControllersAsync(includeDoors: true)).ToList();
            
            // Check online status for each controller
            foreach (var controller in _controllers)
            {
                try
                {
                    var status = await ControllerClient.GetRunStatusAsync(controller.SerialNumber.ToString());
                    controller.IsOnline = status != null;
                }
                catch
                {
                    controller.IsOnline = false;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load controllers");
            _errorMessage = "Failed to load controllers: " + ex.Message;
        }
    }

    private async Task SelectController(int controllerId)
    {
        _selectedControllerId = controllerId;
        _selectedController = _controllers.FirstOrDefault(c => c.Id == controllerId);
        
        if (_selectedController != null)
        {
            await LoadRecentEvents(controllerId);
        }
    }

    private async Task LoadRecentEvents(int controllerId)
    {
        try
        {
            var since = DateTime.UtcNow.AddHours(-24);
            _recentEvents = await DbContext.ControllerEvents
                .Where(e => e.ControllerId == controllerId && e.TimestampUtc >= since)
                .OrderByDescending(e => e.TimestampUtc)
                .Take(50)
                .Include(e => e.Door)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load events for controller {Id}", controllerId);
        }
    }

    private async Task RefreshDashboard()
    {
        _isRefreshing = true;
        await LoadControllers();
        if (_selectedControllerId.HasValue)
        {
            await SelectController(_selectedControllerId.Value);
        }
        _isRefreshing = false;
        _successMessage = "Dashboard refreshed successfully.";
    }

    private async Task TestControllerConnection(int controllerId)
    {
        _isTesting = true;
        try
        {
            var controller = _controllers.FirstOrDefault(c => c.Id == controllerId);
            if (controller != null)
            {
                var status = await ControllerClient.GetRunStatusAsync(controller.SerialNumber.ToString());
                controller.IsOnline = status != null;
                _successMessage = $"Connection test successful for {controller.Name}.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Connection test failed: " + ex.Message;
        }
        finally
        {
            _isTesting = false;
        }
    }

    private async Task UnlockDoor(int doorId)
    {
        _isUnlocking = true;
        _unlockingDoorId = doorId;
        
        try
        {
            var door = _selectedController?.Doors.FirstOrDefault(d => d.Id == doorId);
            if (door != null && _selectedController != null)
            {
                await ControllerClient.OpenDoorAsync(_selectedController.SerialNumber.ToString(), door.DoorIndex);
                
                // Add visual feedback
                _unlockedDoors.Add(doorId);
                _successMessage = $"✓ Door '{door.Name}' unlocked successfully!";
                
                // Auto-remove unlock indicator after 3 seconds
                _ = Task.Run(async () =>
                {
                    await Task.Delay(3000);
                    _unlockedDoors.Remove(doorId);
                    await InvokeAsync(StateHasChanged);
                });
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Failed to unlock door: " + ex.Message;
        }
        finally
        {
            _isUnlocking = false;
            _unlockingDoorId = null;
        }
    }

    private async Task SyncTime()
    {
        try
        {
            if (_selectedController != null)
            {
                await ControllerClient.SyncTimeAsync(_selectedController.Id, CancellationToken.None);
                _successMessage = "Controller time synchronized successfully.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Failed to sync time: " + ex.Message;
        }
    }

    private void ShowEmergencyLockdown()
    {
        // TODO: Implement emergency lockdown modal
        _errorMessage = "Emergency lockdown feature coming soon.";
    }

    private void NavigateToSettings()
    {
        Navigation.NavigateTo("/controllers/settings");
    }

    private void NavigateToControllerSettings(int controllerId)
    {
        Navigation.NavigateTo($"/controllers/settings?controller={controllerId}");
    }

    private void NavigateToScheduler(int controllerId)
    {
        Navigation.NavigateTo($"/controllers/{controllerId}/schedules");
    }

    private int GetRecentEventCount(int controllerId)
    {
        return _recentEvents.Count(e => e.ControllerId == controllerId);
    }

    private string GetLastSyncTime()
    {
        var lastEvent = _recentEvents.OrderByDescending(e => e.TimestampUtc).FirstOrDefault();
        return lastEvent != null ? lastEvent.TimestampUtc.ToLocalTime().ToString("g") : "Never";
    }

    private string GetEventTypeClass(int eventType)
    {
        return eventType switch
        {
            1 => "success",
            2 => "error",
            3 => "warning",
            _ => "info"
        };
    }

    private string GetEventIcon(int eventType)
    {
        return eventType switch
        {
            1 => "bi-check-circle-fill",
            2 => "bi-x-circle-fill",
            3 => "bi-exclamation-triangle-fill",
            _ => "bi-info-circle-fill"
        };
    }

    private string GetEventDescription(ControllerEvent evt)
    {
        var desc = evt.EventType switch
        {
            1 => "Access Granted",
            2 => "Access Denied",
            3 => "Door Forced Open",
            4 => "Door Opened",
            _ => "Event"
        };
        
        if (evt.CardNumber.HasValue)
        {
            desc += $" - Card: {evt.CardNumber}";
        }
        
        if (evt.Door != null)
        {
            desc += $" - {evt.Door.Name}";
        }
        
        return desc;
    }
}
