@page "/controllers/access-admin"
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using Microsoft.AspNetCore.Authorization
@inject ControllerRegistryService RegistryService
@inject IMemberAccessService MemberAccessService
@inject CommandInfoService CommandInfoService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject IBlazorSystemSettingsService SystemSettingsService
@inject NavigationManager Navigation
@inject ILogger<AccessAdmin> Logger
@inject GfcDbContext DbContext
@inject IJSRuntime JSRuntime

<PageTitle>Access Administration - GFC Controllers</PageTitle>

<h1 class="page-title">Access Administration</h1>

@if (!_useRealControllers)
{
    <div class="alert alert-warning mb-3">
        <strong>Simulation Mode enabled:</strong> Dangerous controller operations are blocked until Real Controller Mode is turned on in System Settings.
        <div class="small mt-1">Clear-all commands stay disabled while simulation mode is active.</div>
    </div>
}

@if (_errorMessage != null)
{
    <div class="alert alert-danger">@_errorMessage</div>
}

@if (_successMessage != null)
{
    <div class="alert alert-success">@_successMessage</div>
}

@if (_isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="data-card">
        <div class="mb-3">
            <h3>Clear All Privileges</h3>
            <p class="text-muted small mb-3">
                <strong>DANGEROUS OPERATION:</strong> This will erase ALL card privileges from the selected controller. 
                This action cannot be undone and will lock out all members until privileges are restored.
            </p>
            @if (_clearAllCommandInfo != null)
            {
                <div class="alert alert-@(_clearAllCommandInfo.RiskLevel >= 3 ? "danger" : "warning") mb-3">
                    <strong>@_clearAllCommandInfo.DisplayName</strong> (Risk Level: @_clearAllCommandInfo.RiskLevel / 3)
                    <br />
                    <small>@_clearAllCommandInfo.ShortDescription</small>
                    @if (!string.IsNullOrWhiteSpace(_clearAllCommandInfo.LongDescription))
                    {
                        <br />
                        <small>@_clearAllCommandInfo.LongDescription</small>
                    }
                </div>
            }
        </div>

        <table class="data-table table-compact">
            <thead>
                <tr>
                    <th>Controller</th>
                    <th>Serial Number</th>
                    <th>IP Address</th>
                    <th>Status</th>
                    <th style="width:200px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (_controllers.Count == 0)
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">No controllers configured.</td>
                    </tr>
                }
                else
                {
                    @foreach (var controller in _controllers)
                    {
                        <tr>
                            <td>
                                <strong>@controller.Name</strong>
                            </td>
                            <td>@controller.SerialNumberDisplay</td>
                            <td>@controller.IpAddress</td>
                            <td>
                                <span class="badge @(controller.IsEnabled ? "bg-success" : "bg-secondary")">
                                    @(controller.IsEnabled ? "Enabled" : "Disabled")
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm" 
                                        @onclick="() => ShowClearAllModal(controller)" 
                                        disabled="@(_isClearing || !controller.IsEnabled || !_useRealControllers)"
                                        title="@(!_useRealControllers ? "Disabled while in Simulation Mode. Enable 'Use real controllers' in Settings to run this command." : _clearAllTooltip)">
                                    <i class="bi bi-trash"></i> Clear All Privileges
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
        @if (!_useRealControllers)
        {
            <small class="text-muted d-block mt-2">Disabled in Simulation Mode.</small>
        }
    </div>
}

@if (_showClearAllModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.4);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">⚠️ Clear All Privileges</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseClearAllModal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>WARNING: This is a dangerous operation!</strong>
                        <br />
                        This will permanently delete ALL card privileges from controller <strong>@_clearingController?.Name</strong> (Serial: @_clearingController?.SerialNumberDisplay).
                        <br />
                        All members will be locked out until privileges are restored.
                    </div>
                    <p>Type <strong>@_clearingController?.Name</strong> to confirm:</p>
                    <input type="text" class="form-control" @bind="_clearAllConfirmText" />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="CloseClearAllModal" disabled="@_isClearing">Cancel</button>
                    <button class="btn btn-danger" @onclick="ExecuteClearAll" disabled="@(_isClearing || _clearAllConfirmText != _clearingController?.Name)">
                        @(_isClearing ? "Clearing..." : "Clear All Privileges")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<ControllerDevice> _controllers = new();
    private bool _isLoading = false;
    private bool _isClearing = false;
    private bool _useRealControllers = false;
    private string? _errorMessage;
    private string? _successMessage;
    private string _clearAllTooltip = "Clear all privileges from controller";
    private ControllerCommandInfo? _clearAllCommandInfo;
    private bool _showClearAllModal = false;
    private ControllerDevice? _clearingController;
    private string _clearAllConfirmText = string.Empty;
    private bool _isUnauthorized = false;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            var isAdmin = await CheckAdminAccess();
            if (!isAdmin)
            {
                _isUnauthorized = true;
                _isLoading = false;
                return;
            }
            await LoadControllerModeAsync();
            await LoadControllers();
            await LoadCommandInfo();
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _isUnauthorized)
        {
            Navigation.NavigateTo("/", forceLoad: true);
            return;
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task<bool> CheckAdminAccess()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var isAdmin = authState.User.IsInRole(AppRoles.Admin);
        if (!isAdmin)
        {
            var currentUser = AuthStateProvider.GetCurrentUser();
            isAdmin = currentUser?.IsAdmin == true;
        }

        if (!isAdmin)
        {
            Logger.LogWarning("Non-admin user attempted to access Access Admin page");
            return false;
        }
        return true;
    }

    private async Task LoadControllers()
    {
        try
        {
            _controllers = (await RegistryService.GetControllersAsync()).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load controllers");
            _errorMessage = "Failed to load controllers: " + ex.Message;
        }
    }

    private async Task LoadCommandInfo()
    {
        try
        {
            _clearAllCommandInfo = await CommandInfoService.GetByKeyAsync("ClearAllCards");
            if (_clearAllCommandInfo != null)
            {
                _clearAllTooltip = $"{_clearAllCommandInfo.DisplayName} (Risk Level {_clearAllCommandInfo.RiskLevel}): {_clearAllCommandInfo.ShortDescription}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load command info");
        }
    }

    private void ShowClearAllModal(ControllerDevice controller)
    {
        _clearingController = controller;
        _clearAllConfirmText = string.Empty;
        _showClearAllModal = true;
    }

    private void CloseClearAllModal()
    {
        _showClearAllModal = false;
        _clearingController = null;
        _clearAllConfirmText = string.Empty;
    }

    private async Task ExecuteClearAll()
    {
        if (_clearingController == null) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"DANGER: You are about to clear ALL privileges from controller '{_clearingController.Name}'.\n\n" +
            "This action is permanent and irreversible. Continue?");
            
        if (!confirmed) return;

        _isClearing = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            await MemberAccessService.ClearAllPrivilegesAsync(_clearingController.Id);

            _successMessage = $"All privileges cleared from controller '{_clearingController.Name}'.";
            Logger.LogWarning("All privileges cleared from controller {ControllerId} by user", _clearingController.Id);
            await LogControllerCommandAsync(_clearingController.Id, true, null);

            CloseClearAllModal();
        }

        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to clear all privileges from controller {ControllerId}", _clearingController.Id);
            _errorMessage = "Failed to clear privileges: " + ex.Message;
            await LogControllerCommandAsync(_clearingController.Id, false, ex.Message);
        }
        finally
        {
            _isClearing = false;
        }
    }

    private async Task LogControllerCommandAsync(int controllerId, bool success, string? error)
    {
        DbContext.ControllerCommandLogs.Add(new ControllerCommandLog
        {
            ControllerId = controllerId,
            Action = "ClearAllCards",
            Success = success,
            Error = error,
            TimestampUtc = DateTime.UtcNow
        });

        await DbContext.SaveChangesAsync();
    }

    private async Task LoadControllerModeAsync()
    {
        try
        {
            var settings = await SystemSettingsService.GetAsync();
            _useRealControllers = true; // Simulation mode removed
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load controller mode indicator; defaulting to simulation for UI only");
            _useRealControllers = false;
        }
    }
}
