@page "/controllers/schedules"
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Components.Pages.Controllers.Schedules
@using Microsoft.AspNetCore.Authorization
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ILogger<SchedulesPage> Logger

<PageTitle>Schedules & Holidays - GFC Controllers</PageTitle>

<div class="page-header">
    <div>
        <h1>Schedules & Holidays</h1>
        <p class="text-muted mb-0">Manage time profiles, intervals, and holidays for controller schedules.</p>
    </div>
</div>

<div class="pill-tabs mb-4">
    <button class="pill-tab @(_activeTab == "holidays" ? "active" : "")" 
            type="button" 
            @onclick='() => SetActiveTab("holidays")'>
        Holidays
    </button>
    <button class="pill-tab @(_activeTab == "profiles" ? "active" : "")" 
            type="button" 
            @onclick='() => SetActiveTab("profiles")'>
        Time Profiles
    </button>
</div>

@if (_activeTab == "holidays")
{
    <HolidaysTab />
}
else if (_activeTab == "profiles")
{
    <TimeProfilesTab />
}

@code {
    private string _activeTab = "holidays";
    private bool _isUnauthorized = false;

    protected override async Task OnInitializedAsync()
    {
        var isAdmin = await CheckAdminAccess();
        if (!isAdmin)
        {
            _isUnauthorized = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _isUnauthorized)
        {
            Navigation.NavigateTo("/", forceLoad: true);
            return;
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private Task<bool> CheckAdminAccess()
    {
        var user = AuthStateProvider.GetCurrentUser();
        var isAdmin = user?.IsAdmin == true;
        return Task.FromResult(isAdmin);
    }

    private void SetActiveTab(string tab)
    {
        _activeTab = tab;
    }
}
