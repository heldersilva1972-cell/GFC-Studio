@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@inject IControllerClient ControllerClient
@using Microsoft.EntityFrameworkCore
@inject IMemberAccessService MemberAccessService
@inject CommandInfoService CommandInfoService
@inject ISystemSettingsService SystemSettingsService
@inject ILogger<MaintenanceTab> Logger
@inject IDbContextFactory<GfcDbContext> DbFactory
@inject IJSRuntime JSRuntime

<div class="settings-tab-content fadeIn">
    @if (_errorMessage != null)
    {
        <div class="alert alert-danger mb-4">
             <i class="bi bi-exclamation-triangle-fill me-2"></i> @_errorMessage
        </div>
    }
    @if (_successMessage != null)
    {
        <div class="alert alert-success mb-4">
             <i class="bi bi-check-circle-fill me-2"></i> @_successMessage
        </div>
    }

    @if (Controller == null)
    {
        <div class="alert alert-info">Please select a controller.</div>
    }
    else
    {
         <div class="row g-4">
            <div class="col-lg-12">
                <div class="glass-panel h-100 pb-5">
                    <div class="panel-header mb-4 border-bottom border-glass pb-3">
                         <h3 class="mb-0 text-danger"><i class="bi bi-tools me-2"></i>System Maintenance</h3>
                         <p class="text-muted small mb-0 mt-1">Perform critical system operations on this controller.</p>
                    </div>

                    <div class="row g-4">
                         <!-- Clear Privileges Card -->
                         <div class="col-md-4">
                            <div class="danger-panel p-4 rounded-3 border border-danger border-opacity-25 h-100">
                                <h5 class="text-danger fw-bold"><i class="bi bi-trash me-2"></i>Clear All Privileges</h5>
                                <p class="small text-muted mb-3">
                                    Wipes **ALL** card rights. Users will be locked out until re-uploaded.
                                </p>
                                
                                <div class="alert alert-warning py-2 px-3 small mb-4">
                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                    Risk Level: @(_clearAllCommandInfo?.RiskLevel ?? 3)/3
                                </div>

                                <button class="btn btn-danger w-100" 
                                        @onclick="ShowClearAllModal" 
                                        disabled="@(_isClearing || !Controller.IsEnabled)">
                                    @if (_isClearing) { <span class="spinner-border spinner-border-sm me-2"></span> }
                                    Clear All
                                </button>
                            </div>
                         </div>
                         
                         <!-- Synchronize Clock Card -->
                         <div class="col-md-4">
                            <div class="bg-surface-subtle p-4 rounded-3 border border-glass h-100">
                                <h5 class="text-success fw-bold"><i class="bi bi-clock-history me-2"></i>Synchronize Clock</h5>
                                <p class="small text-muted mb-3">
                                    Updates the internal RTC to <strong>@DateTime.Now.ToString("yyyy-MM-dd HH:mm")</strong>.
                                </p>
                                
                                <div class="alert alert-info py-2 px-3 small mb-4">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Auto-sync runs every 30s.
                                </div>

                                <button class="btn btn-outline-success w-100" 
                                        @onclick="ExecuteSyncTime"
                                        disabled="@(_isSyncingTime || !Controller.IsEnabled)">
                                    @if (_isSyncingTime) { <span class="spinner-border spinner-border-sm me-2"></span> }
                                    Sync Time Now
                                </button>
                            </div>
                         </div>

                         <!-- Deep Reset / Recovery Project -->
                         <div class="col-md-4">
                            <div class="bg-surface-subtle p-4 rounded-3 border border-glass h-100">
                                <h5 class="text-primary fw-bold"><i class="bi bi-arrow-counterclockwise me-2"></i>Deep Reset</h5>
                                <p class="small text-muted mb-3">
                                    Full recovery: 0x54, 0x30, 0x8E, 0x50. Wipes ghost data residue.
                                </p>

                                <div class="alert alert-primary py-2 px-3 small mb-4">
                                    <i class="bi bi-shield-check me-1"></i>
                                    Full Hardware Recovery
                                </div>

                                <button class="btn btn-outline-primary w-100" 
                                        @onclick="ShowResetModal"
                                        disabled="@(_isResetting || !Controller.IsEnabled)">
                                    @if (_isResetting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                                    Execute Deep Reset
                                </button>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@* Clear Confirmation Modal *@
@if (_showClearAllModal)
{
    <div class="modal-backdrop fade show" @onclick="CloseClearAllModal"></div>
    <div class="modern-modal-container">
        <div class="modern-modal fadeIn">
            <div class="modal-header-modern danger bg-danger text-white">
                <div class="header-icon text-white"><i class="bi bi-trash-fill"></i></div>
                <h2 class="text-white">DANGER ZONE</h2>
                <button class="btn-close-modern text-white" @onclick="CloseClearAllModal"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body-modern">
                <div class="alert alert-danger">
                    <strong>WARNING: IRREVERSIBLE ACTION</strong><br/>
                    You are about to delete ALL credentials from <strong>@Controller?.Name</strong>.
                </div>
                <p class="mb-2">To confirm, type the controller name below:</p>
                <div class="mb-3">
                    <input type="text" class="modern-input border-danger" 
                           @bind="_clearAllConfirmText" 
                           placeholder="@Controller?.Name" />
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-outline-modern" @onclick="CloseClearAllModal">Cancel</button>
                <button class="btn-modern btn-danger" 
                        @onclick="ExecuteClearAll" 
                        disabled="@(_isClearing || _clearAllConfirmText != Controller?.Name)">
                    @(_isClearing ? "Wiping..." : "I Understand, Clear All")
                </button>
            </div>
        </div>
    </div>
}

@* Reset Confirmation Modal *@
@if (_showResetModal)
{
    <div class="modal-backdrop fade show" @onclick="CloseResetModal"></div>
    <div class="modern-modal-container">
        <div class="modern-modal fadeIn">
            <div class="modal-header-modern primary">
                <div class="header-icon"><i class="bi bi-arrow-counterclockwise"></i></div>
                <h2>Confirm Deep Reset</h2>
                <button class="btn-close-modern" @onclick="CloseResetModal"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body-modern">
                <div class="alert alert-info">
                   The Deep Reset process follows this exact sequence:
                   <ol class="mb-0 ps-3">
                       <li><strong>0x54:</strong> Clear all card privileges (Set count to 0)</li>
                       <li><strong>0x30:</strong> Synchronize internal clock (Corrects timestamps)</li>
                       <li><strong>0x8E:</strong> Initialize Door 1 & 2 (Enable physical hardware)</li>
                       <li><strong>0x8E:</strong> Wipe Ghost Data on Unused Doors (Doors 3 & 4)</li>
                       <li><strong>0x50:</strong> Re-Add Primary Card (Ensures system is functional)</li>
                   </ol>
                </div>
                <p class="mb-2">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-outline-modern" @onclick="CloseResetModal">Cancel</button>
                <button class="btn-modern btn-primary" 
                        @onclick="ExecuteReset" 
                        disabled="@(_isResetting)">
                    @(_isResetting ? "Resetting..." : "Yes, Reset Controller")
                </button>
            </div>
        </div>
    </div>
}

<style>
    /* Scoped minimal styles reuse */
    .glass-panel { background: var(--bg-surface); border: 1px solid var(--glass-border); border-radius: 16px; padding: 1.5rem; }
    .danger-panel { background: rgba(220, 53, 69, 0.05); }
    
    .modern-input { background: var(--bg-surface-hover); border: 1px solid var(--glass-border); border-radius: 10px; padding: 0.75rem 1rem; color: var(--text-primary); width: 100%; }

    /* Modal styles reuse */
    .modal-backdrop { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1050; }
    .modern-modal-container { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1060; pointer-events: none; }
    .modern-modal { background: var(--bg-surface); width: 90%; max-width: 500px; border-radius: 20px; border: 1px solid var(--glass-border); pointer-events: auto; overflow: hidden; }
    .modal-header-modern { padding: 1.5rem; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; }
    .modal-body-modern { padding: 1.5rem; }
    .modal-footer-modern { padding: 1.5rem; border-top: 1px solid var(--glass-border); display: flex; justify-content: flex-end; gap: 1rem; }
    .btn-close-modern { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: inherit; }
</style>

@code {
    [Parameter] public ControllerDevice? Controller { get; set; }

    private bool _isClearing = false;
    private string? _errorMessage;
    private string? _successMessage;
    private ControllerCommandInfo? _clearAllCommandInfo;
    private bool _showClearAllModal = false;
    private bool _showResetModal = false;
    private bool _isResetting = false;
    private bool _isSyncingTime = false;
    private string _clearAllConfirmText = string.Empty;

    private int _lastControllerId;

    protected override async Task OnParametersSetAsync()
    {
         if (Controller != null && Controller.Id != _lastControllerId)
         {
             _lastControllerId = Controller.Id;
             await LoadCommandInfo();
         }
    }

    private async Task LoadCommandInfo()
    {
        try { _clearAllCommandInfo = await CommandInfoService.GetByKeyAsync("ClearAllCards"); } catch {}
    }

    private void ShowClearAllModal()
    {
        _clearAllConfirmText = string.Empty;
        _showClearAllModal = true;
    }

    private void CloseClearAllModal() => _showClearAllModal = false;

    private void ShowResetModal() => _showResetModal = true;
    private void CloseResetModal() => _showResetModal = false;

    private async Task ExecuteReset()
    {
         if (Controller == null) return;
         
         var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
             $"WARNING: This will perform a DEEP RESET on '{Controller.Name}'.\n\n" +
             "It will clear all cards, sync the clock, calibrate doors, and re-add the primary card.\n\n" +
             "Are you ABSOLUTELY sure you want to proceed?");
             
         if (!confirmed) return;

         _isResetting = true;
         _errorMessage = null; _successMessage = null;
         try
         {
             await ControllerClient.ResetControllerAsync(Controller.Id);
             var doorCount = Controller.DoorCount > 0 ? Controller.DoorCount : 4;
             _successMessage = $"Deep reset completed. Clock and doors have been re-calibrated.";
             await LogCommand("DeepReset", true);
             CloseResetModal();
         }
         catch (Exception ex)
         {
             Logger.LogError(ex, "Failed to reset");
             _errorMessage = "Reset failed: " + ex.Message;
             await LogCommand("DeepReset", false, ex.Message);
         }
         finally { _isResetting = false; }
    }

    private async Task ExecuteSyncTime()
    {
        if (Controller == null) return;
        _isSyncingTime = true;
        _errorMessage = null; _successMessage = null;
        try
        {
            await ControllerClient.SyncTimeAsync(Controller.Id, CancellationToken.None);
            _successMessage = $"Hardware clock successfully updated to {DateTime.Now:yyyy-MM-dd HH:mm:ss}.";
            await LogCommand("SyncTime", true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to sync time");
            _errorMessage = "Sync failed: " + ex.Message;
            await LogCommand("SyncTime", false, ex.Message);
        }
        finally { _isSyncingTime = false; }
    }

    private async Task ExecuteClearAll()
    {
        if (Controller == null) return;
        
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"FINAL WARNING: You are about to wipe ALL privileges from '{Controller.Name}'.\n\n" +
            "This action is IRREVERSIBLE. Are you sure?");
            
        if (!confirmed) return;

        _isClearing = true;
        _errorMessage = null; _successMessage = null;
        try
        {
            await MemberAccessService.ClearAllPrivilegesAsync(Controller.Id);
            _successMessage = "All privileges cleared. Users locked out.";
            await LogCommand("ClearAllCards", true);
            CloseClearAllModal();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to clear");
            _errorMessage = ex.Message;
            await LogCommand("ClearAllCards", false, ex.Message);
        }
        finally { _isClearing = false; }
    }

    private async Task LogCommand(string action, bool success, string? error = null)
    {
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            db.ControllerCommandLogs.Add(new ControllerCommandLog
            {
                ControllerId = Controller!.Id,
                Action = action,
                Success = success,
                Error = error,
                TimestampUtc = DateTime.UtcNow
            });
            await db.SaveChangesAsync();
        }
        catch {}
    }
}
