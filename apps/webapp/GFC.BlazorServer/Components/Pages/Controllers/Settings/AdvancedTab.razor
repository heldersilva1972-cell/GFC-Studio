@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Models
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using Microsoft.EntityFrameworkCore
@inject AutoOpenAndAdvancedModesService AdvancedModesService
@inject GFC.BlazorServer.Services.Controllers.IControllerClient ControllerClient
@inject CommandInfoService CommandInfoService
@inject ISystemSettingsService SystemSettingsService
@inject ILogger<AdvancedTab> Logger
@inject IDbContextFactory<GfcDbContext> DbFactory
@inject IJSRuntime JSRuntime

<div class="settings-tab-content fadeIn">
    @if (_errorMessage != null)
    {
        <div class="alert alert-danger mb-4">
             <i class="bi bi-exclamation-triangle-fill me-2"></i> @_errorMessage
        </div>
    }
    @if (_successMessage != null)
    {
        <div class="alert alert-success mb-4">
             <i class="bi bi-check-circle-fill me-2"></i> @_successMessage
        </div>
    }

    @if (Controller == null)
    {
        <div class="alert alert-info">Please select a controller.</div>
    }
    else
    {
         <div class="row g-4 d-flex align-items-stretch">
            <div class="col-lg-12 d-flex flex-column">
                <div class="glass-panel h-100 d-flex flex-column">
                    <div class="panel-header mb-4 border-bottom border-glass pb-3">
                         <h3 class="mb-0">Advanced Access Modes</h3>
                         <p class="text-muted small mb-0 mt-1">Configure global behavior and special door modes.</p>
                    </div>

                    @if (_isLoading)
                    {
                         <div class="d-flex justify-content-center p-5">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    }
                    else
                    {
                        <div class="flex-grow-1 overflow-auto custom-scrollbar">
                            <!-- Controller Global Settings -->
                            <div class="bg-surface-subtle p-3 rounded-3 mb-4 border border-glass">
                                <h5 class="text-primary mb-3"><i class="bi bi-sliders me-2"></i>Global Behavior</h5>
                                @if (_controllerBehavior != null)
                                {
                                     <div class="modern-field mb-2" style="max-width: 400px;">
                                        <label class="form-label">Valid Swipe Gap (Seconds)</label>
                                        <div class="d-flex gap-2">
                                            <input type="number" class="modern-input" min="0" max="60" @bind="_controllerBehavior.ValidSwipeGapSeconds" />
                                            <span class="badge @GetStatusBadgeClass(_controllerBehavior.ControllerStatusState) align-self-center">
                                                @GetStatusText(_controllerBehavior.ControllerStatusState)
                                            </span>
                                        </div>
                                        <div class="form-label-desc">Time required between valid swipes (anti-double-swipe).</div>
                                    </div>
                                }
                            </div>

                            <!-- Per Door Settings -->
                            <h5 class="mb-3"><i class="bi bi-door-open me-2"></i>Door Modes</h5>
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Door</th>
                                        <th class="text-center" title="Unlock when first valid card is presented">First Card Open</th>
                                        <th class="text-center" title="Toggle mode (lock/unlock) on card read">Toggle Mode</th>
                                        <th class="text-center" title="Warn if door held open">Held Open Warn</th>
                                        <th class="text-center" title="Warn after 3 invalid attempts">Invalid Attempt Warn</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var model in _doorModes)
                                    {
                                        <tr>
                                            <td>
                                                <div class="fw-bold">@model.DoorName</div>
                                                <small class="text-muted">Port @model.DoorIndex</small>
                                            </td>
                                            <td class="text-center"><input type="checkbox" class="form-check-input" @bind="model.FirstCardOpenEnabled" /></td>
                                            <td class="text-center"><input type="checkbox" class="form-check-input" @bind="model.DoorAsSwitchEnabled" /></td>
                                            <td class="text-center"><input type="checkbox" class="form-check-input" @bind="model.OpenTooLongWarnEnabled" /></td>
                                            <td class="text-center"><input type="checkbox" class="form-check-input" @bind="model.Invalid3CardsWarnEnabled" /></td>
                                            <td>
                                                <span class="badge @GetStatusBadgeClass(model.ControllerStatusState)">
                                                    @GetStatusText(model.ControllerStatusState)
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="action-footer mt-4 pt-3 border-top border-glass d-flex justify-content-end gap-2">
                             <button class="btn btn-outline-secondary" @onclick="RefreshFromController" disabled="@(_isLoading || _isSyncing)">
                                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                            </button>
                            <button class="btn btn-outline-primary" @onclick="SaveToDb" disabled="@(_isSaving || _isSyncing)">
                                <i class="bi bi-save me-1"></i> Save DB
                            </button>
                            <button class="btn btn-primary" @onclick="ShowSyncConfirmationModal"
                                    disabled="@(_isLoading || _isSaving || _isSyncing || Controller?.IsEnabled != true)">
                                @if (_isSyncing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-cloud-upload me-1"></i> Sync to Hardware
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@* Sync Confirmation Modal *@
@if (_showSyncConfirmation)
{
    <div class="modal-backdrop fade show" @onclick="CloseSyncConfirmation"></div>
    <div class="modern-modal-container">
        <div class="modern-modal fadeIn">
            <div class="modal-header-modern danger">
                <div class="header-icon"><i class="bi bi-cpu"></i></div>
                <h2>Sync Advanced Modes</h2>
                <button class="btn-close-modern" @onclick="CloseSyncConfirmation"><i class="bi bi-x"></i></button>
            </div>
            <div class="modal-body-modern">
                <div class="alert alert-info">
                    <strong>@(_commandInfo?.DisplayName ?? "Sync Modes")</strong><br/>
                    Risk Level: @(_commandInfo?.RiskLevel ?? 1)/3
                </div>
                <p>
                    This will update special access modes and timers on controller <strong>@(Controller?.Name)</strong>.
                </p>
                <div class="summary-list my-3">
                     <div class="d-flex justify-content-between border-bottom py-2">
                        <span>Swipe Gap</span>
                        <strong>@(_controllerBehavior?.ValidSwipeGapSeconds)s</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-outline-modern" @onclick="CloseSyncConfirmation">Cancel</button>
                <button class="btn-modern btn-danger" @onclick="ConfirmSyncToController">
                    @(_isSyncing ? "Syncing..." : "Confirm Sync")
                </button>
            </div>
        </div>
    </div>
}

<style>
    /* Scoped minimal styles reuse */
    .glass-panel { background: var(--bg-surface); border: 1px solid var(--glass-border); border-radius: 16px; padding: 1.5rem; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.2); border-radius: 3px; }
    
     /* Modern Field Standard */
    .modern-field label { font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block; }
    .modern-input { background: var(--bg-surface-hover); border: 1px solid var(--glass-border); border-radius: 10px; padding: 0.5rem 1rem; color: var(--text-primary); transition: all 0.2s; }
    .form-label-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.4rem; }

    /* Modal styles reuse */
    .modal-backdrop { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1050; }
    .modern-modal-container { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1060; pointer-events: none; }
    .modern-modal { background: var(--bg-surface); width: 90%; max-width: 500px; border-radius: 20px; border: 1px solid var(--glass-border); pointer-events: auto; }
    .modal-header-modern { padding: 1.5rem; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; }
    .modal-header-modern.danger { background: rgba(var(--accent-primary-rgb), 0.1); color: var(--accent-primary); }
    .modal-body-modern { padding: 1.5rem; }
    .modal-footer-modern { padding: 1.5rem; border-top: 1px solid var(--glass-border); display: flex; justify-content: flex-end; gap: 1rem; }
    .btn-close-modern { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: inherit; }
</style>

@code {
    [Parameter] public ControllerDevice? Controller { get; set; }

    private List<DoorAdvancedModeViewModel> _doorModes = new();
    private ControllerBehaviorViewModel? _controllerBehavior;
    private bool _isLoading = false;
    private bool _isSaving = false;
    private bool _isSyncing = false;
    private string? _errorMessage;
    private string? _successMessage;
    private ControllerCommandInfo? _commandInfo;
    private bool _showSyncConfirmation = false;

    protected override async Task OnParametersSetAsync()
    {
        if (Controller != null)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        if (Controller == null) return;
        _isLoading = true;
        _errorMessage = null; 
        try
        {
            await LoadCommandInfo();
            _doorModes = await AdvancedModesService.GetDoorAdvancedModesForControllerAsync(Controller.Id);
            _controllerBehavior = await AdvancedModesService.GetControllerBehaviorAsync(Controller.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load advanced modes");
            _errorMessage = ex.Message;
        }
        finally { _isLoading = false; }
    }

    private string GetStatusBadgeClass(ControllerStatusState state) => state switch
    {
        ControllerStatusState.InSync => "bg-success",
        ControllerStatusState.OutOfSync => "bg-warning",
        _ => "bg-secondary"
    };

    private string GetStatusText(ControllerStatusState state) => state switch
    {
        ControllerStatusState.InSync => "Synced",
        ControllerStatusState.OutOfSync => "Not Synced",
        _ => "Unknown"
    };

    private async Task SaveToDb()
    {
        if (Controller == null) return;
        _isSaving = true;
        _errorMessage = null; _successMessage = null;
        try
        {
            await AdvancedModesService.SaveDoorAdvancedModesAsync(Controller.Id, _doorModes);
             if (_controllerBehavior != null)
                await AdvancedModesService.SaveControllerBehaviorAsync(_controllerBehavior);

            _successMessage = "Saved to database.";
            await LogCommand("SaveAdvancedModesConfig", true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save");
            _errorMessage = ex.Message;
        }
        finally { _isSaving = false; }
    }

     private async Task RefreshFromController()
    {
        if (Controller == null) return;
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Overwrite database with settings from hardware?")) return;

        _isLoading = true;
        try 
        {
            var report = await AdvancedModesService.RefreshFromControllerAsync(Controller.Id, ControllerClient);
            if (report.Success)
            {
                _successMessage = "Refreshed from hardware.";
                await LoadData();
                await LogCommand("RefreshAdvancedModesFromController", true);
            }
            else
            {
                _errorMessage = "Refresh failed: " + report.Message;
            }
        }
        catch(Exception ex) 
        { 
            _errorMessage = ex.Message; 
        }
        finally { _isLoading = false; }
    }

    private void ShowSyncConfirmationModal() => _showSyncConfirmation = true;
    private void CloseSyncConfirmation() => _showSyncConfirmation = false;

    private async Task ConfirmSyncToController()
    {
        if (Controller == null) return;
        _isSyncing = true;
        CloseSyncConfirmation();
        try
        {
            var report = await AdvancedModesService.SyncAdvancedModesToControllerAsync(Controller.Id, ControllerClient);
            if (report.Success)
            {
                _successMessage = "Pushed to hardware successfully.";
                await LogCommand("SyncAdvancedModesToController", true);
                await LoadData();
            }
            else
            {
                _errorMessage = "Sync failed: " + report.Message;
            }
        }
        catch(Exception ex)
        {
            _errorMessage = "Sync error: " + ex.Message;
        }
        finally { _isSyncing = false; }
    }

    private async Task LoadCommandInfo()
    {
        try { _commandInfo = await CommandInfoService.GetByKeyAsync("SyncAdvancedDoorModes"); } catch {}
    }

    private async Task LogCommand(string action, bool success)
    {
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            db.ControllerCommandLogs.Add(new ControllerCommandLog
            {
                ControllerId = Controller!.Id,
                Action = action,
                Success = success,
                TimestampUtc = DateTime.UtcNow
            });
            await db.SaveChangesAsync();
        }
        catch {}
    }
}
