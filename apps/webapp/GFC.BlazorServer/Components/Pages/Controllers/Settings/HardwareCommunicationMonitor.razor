@implements IDisposable
@using GFC.BlazorServer.Services.Controllers
@inject ICommunicationLogService LogService
@inject IJSRuntime JSRuntime

<div class="hw-monitor-container @(IsPaused ? "paused" : "") @(IsLarge ? "large" : "")">
    <div class="hw-monitor-header">
        <div class="d-flex align-items-center gap-2">
            <span class="live-pulse @(IsActive ? "active" : "")"></span>
            <span class="fw-bold small text-uppercase letter-spacing-1 text-dark">Hardware Traffic Monitor</span>
            @if (_pendingLogs.Any())
            {
                <span class="badge bg-warning text-dark animate-bounce-in ms-2">@_pendingLogs.Count New</span>
            }
        </div>
        <div class="hw-monitor-controls">
            <button class="btn btn-sm @(IsPaused ? "btn-warning" : "btn-outline-secondary") px-3" @onclick="TogglePause">
                <i class="bi @(IsPaused ? "bi-play-fill" : "bi-pause-fill") me-1"></i>
                @(IsPaused ? "Resume Feed" : "Pause Feed")
            </button>
            <button class="btn btn-sm btn-outline-danger ms-2" @onclick="ClearLogs" title="Clear All Logs">
                <i class="bi bi-trash me-1"></i> Clear
            </button>
            <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="ToggleSize" title="Toggle Large View">
                <i class="bi @(IsLarge ? "bi-arrows-angle-contract" : "bi-arrows-angle-expand")"></i>
            </button>
        </div>
    </div>

    <div class="hw-monitor-feed custom-scrollbar" @ref="FeedElement">
        @if (!_logs.Any())
        {
            <div class="text-center py-5 opacity-50">
                <i class="bi bi-activity fs-1 mb-2 d-block"></i>
                <p>Waiting for controller traffic...</p>
            </div>
        }
        else
        {
            @foreach (var log in _logs)
            {
                <div class="hw-log-entry @(log.IsError ? "error" : "")" @key="log">
                    <div class="log-main-row">
                        <div class="log-timestamp">@log.Timestamp.ToString("HH:mm:ss.fff")</div>
                        <div class="log-controller">SN:@log.ControllerSn</div>
                        <div class="log-badge-container">
                            <span class="badge badge-op" title="Command Code: 0x@(log.RequestPacket != null ? log.RequestPacket[1].ToString("X2") : "--")">
                                @log.Operation <span class="ms-1 opacity-50">[0x@(log.RequestPacket != null ? log.RequestPacket[1].ToString("X2") : "--")]</span>
                            </span>
                        </div>
                        <div class="log-text">
                            @log.PlainEnglish
                            @if (log.Operation == "SetDoorConfig" && log.RequestPacket?.Length > 9)
                            {
                                <span class="ms-1 badge bg-glass text-dark border-glass small">
                                    Mode: @log.RequestPacket[9]
                                </span>
                            }
                        </div>
                        <div class="log-details-toggle" @onclick="() => ToggleDetails(log)">
                            <i class="bi @(ExpandedLogs.Contains(log) ? "bi-chevron-up" : "bi-chevron-down")"></i>
                        </div>
                    </div>
                    
                    @if (ExpandedLogs.Contains(log))
                    {
                        <div class="log-hex-dump animate-fade-in">
                            @if (log.RequestPacket != null)
                            {
                                <div class="hex-row">
                                    <span class="hex-label text-primary">TX:</span>
                                    <code class="hex-data">@FormatHex(log.RequestPacket)</code>
                                </div>
                            }
                            @if (log.ResponsePacket != null)
                            {
                                <div class="hex-row">
                                    <span class="hex-label text-success">RX:</span>
                                    <code class="hex-data">@FormatHex(log.ResponsePacket)</code>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(log.ErrorMessage))
                            {
                                <div class="hex-row text-danger fw-bold mt-1">
                                    <span class="hex-label">ERR:</span>
                                    <code>@log.ErrorMessage</code>
                                </div>
                            }
                            <div class="text-xs text-muted mt-2 border-top pt-1">
                                <strong>Technical Details:</strong> @log.Description
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </div>
</div>

<style>
    .hw-monitor-container {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 2rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 220px;
        min-height: 180px;
        max-height: 85vh;
        resize: vertical;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
        position: relative;
    }

    .hw-monitor-container.large {
        height: 550px;
    }

    .hw-monitor-container.paused {
        border: 1px solid #fbbf24;
        box-shadow: 0 4px 20px rgba(251, 191, 36, 0.1);
    }

    .hw-monitor-header {
        padding: 0.75rem 1.25rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .live-pulse {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #cbd5e1;
        display: inline-block;
        transition: all 0.2s;
    }

    .live-pulse.active {
        background: #ef4444;
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    }

    .hw-monitor-feed {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
        background: #fff;
    }

    .hw-log-entry {
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
        transition: background 0.2s;
    }

    .log-main-row {
        display: flex;
        align-items: center;
        padding: 8px 1.25rem;
        gap: 12px;
        width: 100%;
    }

    .log-timestamp { width: 100px; font-size: 0.75rem; color: #64748b; flex-shrink: 0; }
    .log-controller { width: 110px; color: #0284c7; font-weight: 500; font-size: 0.8rem; flex-shrink: 0; }
    .log-badge-container { width: 220px; flex-shrink: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .log-text { flex-grow: 1; font-weight: 500; color: #1e293b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }

    .hw-log-entry:hover {
        background: #f8fafc;
    }

    .hw-log-entry.error {
        background: #fff1f2;
        color: #991b1b;
    }

    .log-time { font-size: 0.75rem; color: #64748b; }
    .log-sn { color: #0284c7; font-weight: 500; }
    
    .badge-op {
        background: #e0f2fe;
        color: #0369a1;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
        padding: 0.35rem 0.6rem;
        border-radius: 4px;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        max-width: 100%; /* Ensure badge fits in container if text is huge */
    }

    .error .badge-op {
        background: #fee2e2;
        color: #991b1b;
    }

    .log-summary { 
        font-weight: 500; 
        color: #1e293b;
        padding-left: 10px;
    }

    .log-details-toggle {
        cursor: pointer;
        display: flex;
        justify-content: center;
        color: #94a3b8;
        padding: 4px;
        border-radius: 50%;
    }
    .log-details-toggle:hover { 
        background: #e2e8f0;
        color: #1e293b;
    }

    .log-hex-dump {
        grid-column: 1 / -1;
        padding: 12px 1.5rem;
        background: #f1f5f9;
        border-radius: 8px;
        margin: 8px 0;
        font-size: 0.8rem;
        border: 1px solid #e2e8f0;
    }

    .hex-row {
        display: flex;
        gap: 15px;
        margin-bottom: 4px;
    }

    .hex-label { 
        width: 35px; 
        font-weight: 700; 
        font-size: 0.75rem;
    }

    .hex-data { 
        color: #475569; 
        word-break: break-all;
        line-height: 1.4;
        background: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #cbd5e1;
        display: block;
        width: 100%;
    }

    .animate-fade-in {
        animation: hwFadeIn 0.25s ease-out;
    }

    @@keyframes hwFadeIn {
        from { opacity: 0; transform: translateY(-4px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-bounce-in {
        animation: hwBounceIn 0.4s cubic-bezier(0.36, 0, 0.66, -0.56) forwards;
    }

    @@keyframes hwBounceIn {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
</style>

@code {
    private List<CommunicationLogEntry> _logs = new();
    private List<CommunicationLogEntry> _pendingLogs = new();
    private ElementReference FeedElement;
    private bool IsPaused { get; set; }
    private bool IsActive { get; set; }
    private bool IsLarge { get; set; }
    private HashSet<CommunicationLogEntry> ExpandedLogs = new();

    protected override void OnInitialized()
    {
        _logs = LogService.GetRecentLogs(20).ToList();
        LogService.OnLog += HandleNewLog;
    }

    private void HandleNewLog(CommunicationLogEntry entry)
    {
        InvokeAsync(async () => {
            if (IsPaused)
            {
                _pendingLogs.Add(entry);
            }
            else
            {
                _logs.Add(entry);
                if (_logs.Count > 100) _logs.RemoveAt(0);
            }

            IsActive = true;
            StateHasChanged();
            
            if (!IsPaused)
            {
                await ScrollToBottom();
            }

            // Blink active indicator
            await Task.Delay(400);
            IsActive = false;
            StateHasChanged();
        });
    }

    private void TogglePause()
    {
        IsPaused = !IsPaused;
        if (!IsPaused && _pendingLogs.Any())
        {
            // Flush pending logs
            _logs.AddRange(_pendingLogs);
            _pendingLogs.Clear();
            
            // Trim
            if (_logs.Count > 100) 
            {
                _logs = _logs.Skip(_logs.Count - 100).ToList();
            }
            
            StateHasChanged();
            _ = ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        try {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", FeedElement);
        } catch { }
    }

    private void ClearLogs() 
    {
        _logs.Clear();
        _pendingLogs.Clear();
        ExpandedLogs.Clear();
        StateHasChanged();
    }

    private void ToggleDetails(CommunicationLogEntry log)
    {
        if (ExpandedLogs.Contains(log)) ExpandedLogs.Remove(log);
        else ExpandedLogs.Add(log);
    }

    private void ToggleSize()
    {
        IsLarge = !IsLarge;
    }

    private string FormatHex(byte[] packet)
    {
        return BitConverter.ToString(packet).Replace("-", " ");
    }

    public void Dispose()
    {
        LogService.OnLog -= HandleNewLog;
    }
}
