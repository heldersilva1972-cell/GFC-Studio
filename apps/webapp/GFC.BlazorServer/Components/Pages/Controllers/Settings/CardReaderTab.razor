@using GFC.BlazorServer.Data
@using GFC.BlazorServer.Data.Entities
@using GFC.BlazorServer.Services
@using GFC.BlazorServer.Services.Controllers
@using Microsoft.EntityFrameworkCore
@inject IControllerClient ControllerClient
@inject IDbContextFactory<GfcDbContext> DbFactory
@inject ILogger<CardReaderTab> Logger
@inject IJSRuntime JSRuntime

<div class="settings-tab-content fadeIn h-100 p-4 overflow-y-auto custom-scrollbar">
    @if (Controller == null)
    {
        <div class="alert alert-info">Please select a controller.</div>
    }
    else
    {
        <div class="row g-4">
            <!-- Card Reader Test Section -->
            <div class="col-md-6 d-flex">
                <div class="glass-panel p-4 flex-grow-1">
                    <h5 class="mb-3 d-flex align-items-center">
                        <i class="bi bi-credit-card-2-front me-2"></i>Card Reader Test
                    </h5>
                    
                    <div class="card-reader-test-area h-100 d-flex flex-column justify-content-center">
                        @if (_activeScanMode != "Test" && string.IsNullOrEmpty(_scannedCardResult))
                        {
                            <div class="text-center py-4">
                                <p class="text-muted mb-3">Scan a card to verify reader functionality.</p>
                                <button class="btn btn-primary" @onclick='() => StartCardScan("Test")'>
                                    <i class="bi bi-play-fill me-2"></i>Start Card Read
                                </button>
                                <div class="mt-3">
                                    <small class="text-muted fst-italic">Supports connected readers (Wiegand) and USB Keyboard readers.</small>
                                </div>
                            </div>
                        }
                        else if (_activeScanMode == "Test")
                        {
                             <div class="text-center py-4 scan-active-state">
                                <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Scanning...</span>
                                </div>
                                <h5 class="fw-bold animate-pulse">Waiting for Card...</h5>
                                <p class="text-muted small mb-3">Tap card on reader OR scan with USB reader.</p>
                                
                                <button class="btn btn-outline-secondary btn-sm mt-3" @onclick="CancelCardScan">Cancel</button>
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(_scannedCardResult) && _lastScanMode == "Test")
                        {
                            <div class="text-center py-4 result-state">
                                @if (_scannedCardResult == "Timeout")
                                {
                                    <div class="mb-3 text-warning"><i class="bi bi-hourglass-split fs-1"></i></div>
                                    <h5 class="text-warning fw-bold">Scan Timed Out</h5>
                                    <p class="text-muted small">No card was detected within the time limit.</p>
                                }
                                else
                                {
                                    <div class="mb-3 text-success"><i class="bi bi-check-circle-fill fs-1"></i></div>
                                    <h5 class="text-success fw-bold">Card Detected!</h5>
                                    <div class="card-result-box my-3 p-3 bg-surface-subtle border rounded-3">
                                        <div class="text-uppercase text-muted small fw-bold">Card Number</div>
                                        <div class="fs-2 font-monospace">@_scannedCardResult</div>
                                    </div>
                                }
                                <div class="d-flex justify-content-center gap-2 mt-3">
                                    <button class="btn btn-outline-secondary" @onclick="ResetCardScan">Close</button>
                                    <button class="btn btn-primary" @onclick='() => StartCardScan("Test")'>Scan Another</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Assignment Section -->
            <div class="col-md-6 d-flex">
                <div class="glass-panel p-4 flex-grow-1">
                    <h5 class="mb-3 d-flex align-items-center">
                        <i class="bi bi-person-badge me-2"></i>Quick Assign to Test User
                    </h5>
                    
                    <div>
                         @if (_activeScanMode != "Assign" && string.IsNullOrEmpty(_assignResult))
                        {
                            <div class="text-center py-4">
                                <p class="text-muted mb-3">Scan a card to instantly assign it to a Test User and configure all doors.</p>
                                <button class="btn btn-primary" @onclick='() => StartCardScan("Assign")'>
                                    <i class="bi bi-person-plus-fill me-2"></i>Scan to Assign
                                </button>
                            </div>
                        }
                        else if (_activeScanMode == "Assign")
                        {
                             <div class="text-center py-4 scan-active-state">
                                <div class="spinner-grow text-info mb-3" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Scanning...</span>
                                </div>
                                <h5 class="fw-bold animate-pulse">Waiting for Card to Assign...</h5>
                                <p class="text-muted small mb-3">Tap card to enrollment reader.</p>
                                
                                <button class="btn btn-outline-secondary btn-sm mt-3" @onclick="CancelCardScan">Cancel</button>
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(_assignResult) && _lastScanMode == "Assign")
                        {
                             <div class="text-center py-4 result-state">
                                <div class="mb-3 text-success"><i class="bi bi-check-circle-fill fs-1"></i></div>
                                <h5 class="text-success fw-bold">@_assignMessage</h5>
                                <p class="text-muted">@_assignDetails</p>
                                
                                <div class="d-flex justify-content-center gap-2 mt-3">
                                    <button class="btn btn-outline-secondary" @onclick="ResetCardScan">Close</button>
                                    <button class="btn btn-primary" @onclick='() => StartCardScan("Assign")'>Assign Another</button>
                                </div>
                            </div>
                        }
                        @if (_activityLog.Any())
                        {
                            <div class="mt-4 p-3 bg-dark rounded-3 font-monospace small" style="max-height: 200px; overflow-y: auto;">
                                <div class="d-flex justify-content-between align-items-center mb-2 border-bottom border-secondary pb-1">
                                    <span class="text-uppercase text-muted" style="font-size: 0.7rem;">Activity Log</span>
                                    <span class="badge bg-secondary">@_activityLog.Count entries</span>
                                </div>
                                @foreach (var log in _activityLog)
                                {
                                    <div class="mb-1 text-light">@log</div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

         <!-- Shared Hidden input for capturing keyboard wedge readers -->
        <div style="position: fixed; top: 50%; left: 50%; width: 1px; height: 1px; opacity: 0; overflow: hidden; pointer-events: none;">
                <input @ref="_cardInputRef" 
                    @bind="_keyboardInput" 
                    @bind:event="oninput" 
                    @onkeydown="HandleKeyDown"
                    autocomplete="off" 
                     />
        </div>
    }
</div>

<style>
    /* Scoped Styles matches OverviewTab */
    .glass-panel { background: var(--bg-surface); border: 1px solid var(--glass-border); border-radius: 16px; }
    .scan-active-state, .result-state { animation: fadeIn 0.3s ease; }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-pulse { animation: pulse 2s infinite; }
</style>

@code {
    [Parameter] public ControllerDevice? Controller { get; set; }

    // Card Reader & Assignment State
    private string? _activeScanMode; // "Test" or "Assign"
    private string? _lastScanMode;
    private string? _scannedCardResult;

    // Assignment Results
    private string? _assignResult; // "Success" or "Error"
    private string? _assignMessage;
    private string? _assignDetails;

    // Activity Log
    private List<string> _activityLog = new();

    private CancellationTokenSource? _cardScanCts;
    
    // Keyboard/USB Reader Support
    private ElementReference _cardInputRef;
    private string _keyboardInput = "";

    private async Task StartCardScan(string mode)
    {
        if (Controller == null) return;
        _activeScanMode = mode;
        _lastScanMode = mode;
        
        // Reset previous results based on mode
        if (mode == "Test") _scannedCardResult = null;
        if (mode == "Assign") { 
            _assignResult = null; 
            _assignMessage = null; 
            _activityLog.Clear(); 
            AddLog("Waiting for card read...");
        }

        _keyboardInput = ""; 
        _cardScanCts = new CancellationTokenSource();
        StateHasChanged(); 

        try {
            await Task.Delay(50); 
            await _cardInputRef.FocusAsync();
        } catch { }

        // Run polling in background
        _ = PollForCardRead(_cardScanCts.Token);
    }

    private void AddLog(string message)
    {
        var time = DateTime.Now.ToString("HH:mm:ss");
        _activityLog.Add($"[{time}] {message}");
        InvokeAsync(StateHasChanged);
    }

    private async Task AssignCardToTestUser(string cardNumber)
    {
        if (Controller == null) return;
        _assignMessage = "Assigning...";
        AddLog($"Card detected: {cardNumber}");
        AddLog("Starting assignment process...");
        StateHasChanged();

        try
        {
            var doors = Controller.Doors.ToList();
            if (!doors.Any()) 
            {
                 doors = new List<Door> { new Door { DoorIndex = 1 }, new Door { DoorIndex = 2 } };
                 AddLog("No doors found in registry, using default doors 1 & 2.");
            }
            else
            {
                AddLog($"Found {doors.Count} configured doors.");
            }

            int successCount = 0;
            foreach(var door in doors)
            {
                AddLog($"Configuring Door {door.DoorIndex} ({door.Name})...");
                var request = new GFC.BlazorServer.Models.AddOrUpdateCardRequestDto
                {
                    CardNumber = cardNumber,
                    DoorIndexes = new List<int> { door.DoorIndex },
                    TimeProfileIndex = 1,
                    Enabled = true
                };

               var result = await ControllerClient.AddOrUpdateCardAsync(Controller.SerialNumberDisplay, request);
               if (result.Success) 
               {
                   successCount++;
                   AddLog($"✓ Door {door.DoorIndex}: Success");
               }
               else
               {
                   AddLog($"✗ Door {door.DoorIndex}: Failed - {result.Message}");
               }
            }

            if (successCount > 0)
            {
                _assignResult = "Success";
                _assignMessage = $"Card {cardNumber} Assigned!";
                _assignDetails = $"Successfully configured on {successCount} doors for 'Test User'.";
                AddLog("Assignment process completed successfully.");
            }
            else
            {
                throw new Exception("Failed to configure any door.");
            }
        }
        catch (Exception ex)
        {
            _assignResult = "Error";
            _assignMessage = "Assignment Failed";
            _assignDetails = ex.Message;
            AddLog($"FATAL ERROR: {ex.Message}");
            Logger.LogError(ex, "Failed to assign card");
        }
        finally
        {
            _activeScanMode = null; 
            StateHasChanged();
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            CancelCardScan();
            return;
        }

        if (e.Key == "Enter")
        {
            if (!string.IsNullOrWhiteSpace(_keyboardInput))
            {
                var card = _keyboardInput.Trim();
                _cardScanCts?.Cancel();
                
                if (_activeScanMode == "Test")
                {
                    _scannedCardResult = card;
                    _activeScanMode = null;
                    StateHasChanged();
                }
                else if (_activeScanMode == "Assign")
                {
                    _ = AssignCardToTestUser(card);
                }
            }
        }
    }

    private void CancelCardScan()
    {
        _cardScanCts?.Cancel();
        _activeScanMode = null;
        StateHasChanged();
    }
    
    private void ResetCardScan()
    {
        _activeScanMode = null;
        _scannedCardResult = null;
        _assignResult = null;
        StateHasChanged();
    }

    private async Task PollForCardRead(CancellationToken token)
    {
        var startTime = DateTime.UtcNow;
        var timeout = TimeSpan.FromSeconds(30);

        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            while (!token.IsCancellationRequested)
            {
                if (DateTime.UtcNow - startTime > timeout)
                {
                     if (_activeScanMode == "Test") _scannedCardResult = "Timeout";
                     _activeScanMode = null;
                     await InvokeAsync(StateHasChanged);
                     break;
                }

                var cardEvent = await db.ControllerEvents
                    .Where(e => e.ControllerId == Controller!.Id && 
                                e.TimestampUtc > startTime && 
                                e.CardNumber != null)
                    .OrderBy(e => e.TimestampUtc)
                    .FirstOrDefaultAsync(token);

                if (cardEvent != null)
                {
                    var card = cardEvent.CardNumber.ToString();
                    
                    if (_activeScanMode == "Test")
                    {
                        _scannedCardResult = card;
                        _activeScanMode = null;
                         await InvokeAsync(StateHasChanged);
                    }
                    else if (_activeScanMode == "Assign")
                    {
                         _activeScanMode = null;
                         await InvokeAsync(() => AssignCardToTestUser(card));
                    }
                    break;
                }

                await Task.Delay(1000, token);
            }
        }
        catch (TaskCanceledException) { }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error polling");
        }
    }
}
