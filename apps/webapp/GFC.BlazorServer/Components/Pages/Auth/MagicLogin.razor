// [MODIFIED]
@page "/auth/magic-login"
@using GFC.Core.Interfaces
@using GFC.Core.Models
@using GFC.BlazorServer.Services
@inject IMagicLinkService MagicLinkService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IAuditLogger AuditLogger

<p>Verifying your magic link...</p>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string Token { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var result = await MagicLinkService.ValidateMagicLinkTokenAsync(Token);
        if (result.Success)
        {
            await AuthStateProvider.LoginWithUserAsync(result.User);
            AuditLogger.Log(result.User.UserId, AuditLogActions.LoginSuccessMagicLink, "User logged in successfully via magic link.");
            Navigation.NavigateTo("/", forceLoad: false);
        }
        else
        {
            ToastService.ShowError(result.ErrorMessage);
            Navigation.NavigateTo("/login");
        }
    }
}
