@page "/dues"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using System.ComponentModel.DataAnnotations
@using GFC.Core.Enums
@using GFC.Core.Models
@using GFC.Core.Interfaces
@using GFC.Core.Services
@inject IDuesInsightService DuesService
@inject IDuesRepository DuesRepository
@inject IKeyCardRepository KeyCardRepository
@inject GFC.BlazorServer.Services.DuesService DuesServiceEF
@inject GFC.BlazorServer.Services.WaiverService WaiverService
@inject IDuesYearSettingsRepository DuesYearSettingsRepository
@inject IDuesWaiverRepository DuesWaiverRepository
@inject IMemberRepository MemberRepository
@inject MemberService MemberService
@inject IGlobalNoteRepository GlobalNoteRepository
@inject GFC.BlazorServer.Services.CustomAuthenticationStateProvider AuthStateProvider
@inject ILogger<Dues> Logger
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager
@inject IControllerSyncQueueRepository SyncQueueRepository
@inject KeyCardLifecycleService KeyCardLifecycleService
@inject TutorialService TutorialService
@implements IDisposable

<PageTitle>Dues Management - GFC</PageTitle>

<div class="dues-container fade-in">
    <!-- Header Section -->
    <div class="page-header d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
        <div>
            <h1 class="page-title-modern mb-1">Dues & Payments</h1>
            <p class="text-muted mb-0 small d-none d-sm-block">Manage membership dues, payments, and waivers for @_selectedYear</p>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap w-100 w-lg-auto">
            @if (_graceEndDate.HasValue)
            {
                var daysRemaining = (_graceEndDate.Value - DateTime.Today).Days;
                var badgeClass = daysRemaining > 15 ? "bg-success" : daysRemaining > 0 ? "bg-warning" : "bg-danger";
                var remainingText = daysRemaining > 0 ? $"{daysRemaining} Days Remaining" : (daysRemaining == 0 ? "Expires Today" : "Expired");
                
                <div class="badge @badgeClass text-white d-flex align-items-center gap-2 px-3 py-2 flex-grow-1 flex-lg-grow-0 justify-content-center" 
                     style="font-size: 0.85rem; cursor: pointer; font-weight: 600; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); height: 38px;" 
                     @onclick="EditGracePeriod"
                     title="Click to edit grace period">
                    <i class="bi bi-calendar-check" style="font-size: 1rem;"></i>
                    <span class="text-truncate">Grace Period: <strong style="font-weight: 800;">@remainingText</strong></span>
                    <i class="bi bi-pencil-fill" style="font-size: 0.7rem; opacity: 0.9; margin-left: 2px;"></i>
                </div>
            }

            <div class="d-flex align-items-center gap-2 flex-grow-1 flex-lg-grow-0 justify-content-end">
                <label class="text-muted small mb-0 fw-semibold d-lg-none">Year:</label>
                <select class="form-select year-select" @bind="_selectedYear" @bind:after="OnYearChanged">
                @foreach (var year in _years)
                {
                    <option value="@year">@year</option>
                }
            </select>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(_operationMessage))
    {
        <div class="alert @( _operationError ? "alert-danger" : "alert-success") shadow-sm border-0 mb-4">
            @_operationMessage
        </div>
    }

    <!-- Status Banners -->
    <!-- Compact Status Grid -->
    <div class="row g-2 mb-3">
        <!-- Removed old grace period card -->
    </div>


    @if (_loading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Loading dues information...</p>
        </div>
    }
    else if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <div class="alert alert-danger shadow-sm">@_errorMessage</div>
    }
    else
    {
        @* Tutorial Step 5: Find the member on Dues page *@
        @if (TutorialService.ShouldShowStep(5))
        {
            <TutorialBubble 
                Show="true"
                Title="Initialize Dues"
                Message="Search for the member to log their initial dues payment."
                Tip="You can also scan a member's card to find them instantly!"
                Position="top-center"
                ShowNext="false"
                ShowWait="true"
                WaitingText="Waiting for you to click 'Pay'..."
                AllowCancel="true"
                OnCancel="@(async () => await TutorialService.CancelTutorialAsync())" />
        }

        @* Tutorial Step 6: Complete the payment form *@
        @if (TutorialService.ShouldShowStep(6))
        {
            <TutorialBubble 
                Show="true"
                Title="Payment Entry"
                Message="Select payment method and confirm the transaction."
                Position="top-center"
                ShowNext="false"
                ShowWait="true"
                WaitingText="Waiting for you to confirm the payment..."
                AllowCancel="true"
                OnCancel="@(async () => await TutorialService.CancelTutorialAsync())" />
        }

        @* Tutorial Step 7: Payment recorded success *@
        @if (TutorialService.ShouldShowStep(7))
        {
            <TutorialBubble 
                Show="true"
                Title="Transaction Complete"
                Message="Payment verified. Final Step: Provision a physical key card."
                Tip="Click 'Yes, Assign & Activate Card' to proceed."
                Position="top-center"
                ShowNext="false"
                ShowWait="true"
                WaitingText="Waiting for you to proceed to Key Cards..."
                AllowCancel="true"
                OnCancel="@(async () => await TutorialService.CancelTutorialAsync())" />
        }

        <!-- Metrics Grid -->
        <!-- Desktop Metrics  -->
        <div class="metrics-grid mb-4 d-none d-lg-grid">
            @if (_summary is not null)
            {
                <div class="metric-card @(_activeFilter == DuesFilter.Paid ? "active" : "")" @onclick="() => SetFilter(DuesFilter.Paid)">
                    <div class="metric-icon bg-success-subtle text-success">
                        <i class="bi bi-check-lg"></i>
                    </div>
                    <div>
                        <div class="metric-label">Paid</div>
                        <div class="metric-value">@_summary.PaidCount</div>
                    </div>
                </div>

                <div class="metric-card @(_activeFilter == DuesFilter.Unpaid ? "active" : "")" @onclick="() => SetFilter(DuesFilter.Unpaid)">
                    <div class="metric-icon bg-warning-subtle text-warning">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div>
                        <div class="metric-label">Unpaid</div>
                        <div class="metric-value">@_summary.UnpaidCount</div>
                    </div>
                </div>

                <div class="metric-card @(_activeFilter == DuesFilter.Waived ? "active" : "")" @onclick="() => SetFilter(DuesFilter.Waived)">
                    <div class="metric-icon bg-info-subtle text-info">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div>
                        <div class="metric-label">Waived</div>
                        <div class="metric-value">@_summary.WaivedCount</div>
                    </div>
                </div>

                <div class="metric-card highlight">
                    <div class="metric-icon bg-primary-subtle text-primary">
                        <i class="bi bi-currency-dollar"></i>
                    </div>
                    <div>
                        <div class="metric-label">Collected</div>
                        <div class="metric-value">@_summary.AmountCollected.ToString("C0")</div>
                    </div>
                </div>
            }
        </div>

        <!-- Mobile Metrics (Compact) -->
        <div class="d-lg-none mb-3">
             @if (_summary is not null)
             {
                <div class="card border-0 shadow-sm bg-primary text-white overflow-hidden">
                    <div class="card-body p-3 position-relative">
                        <!-- Decorative circle -->
                        <div style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-white-50 small text-uppercase fw-bold">Total Collected</span>
                            <span class="badge bg-white text-primary rounded-pill">@_selectedYear</span>
                        </div>
                        <h2 class="display-6 fw-bold mb-3">@_summary.AmountCollected.ToString("C0")</h2>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm flex-grow-1 border-0 @(_activeFilter == DuesFilter.Paid ? "bg-white text-primary fw-bold" : "bg-primary-dark text-white")" 
                                    style="@(_activeFilter != DuesFilter.Paid ? "background: rgba(0,0,0,0.2)" : "")"
                                    @onclick="() => SetFilter(DuesFilter.Paid)">
                                <i class="bi bi-check-lg me-1"></i> @_summary.PaidCount Paid
                            </button>
                            <button class="btn btn-sm flex-grow-1 border-0 @(_activeFilter == DuesFilter.Unpaid ? "bg-white text-primary fw-bold" : "bg-primary-dark text-white")" 
                                     style="@(_activeFilter != DuesFilter.Unpaid ? "background: rgba(0,0,0,0.2)" : "")"
                                    @onclick="() => SetFilter(DuesFilter.Unpaid)">
                                <i class="bi bi-clock me-1"></i> @_summary.UnpaidCount Unpaid
                            </button>
                        </div>
                    </div>
                </div>
             }
        </div>

        <!-- Search & Toolbar -->
        <div class="search-toolbar-modern mb-4">
            <div class="search-container-modern">
                <i class="bi bi-search search-icon-modern"></i>
                <input class="search-input-modern @(TutorialService.ShouldShowStep(5) ? "tutorial-pulse" : "")"
                       placeholder="Search by name..."
                       @bind="_searchText"
                       @bind:event="oninput" />
                @if (!string.IsNullOrWhiteSpace(_searchText))
                {
                    <button class="search-clear-btn" @onclick="ClearDuesSearch" title="Clear search">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                }
            </div>
            <button class="btn btn-outline-primary d-flex align-items-center gap-2" type="button" @onclick="NavigateToKeyCards" style="white-space: nowrap;">
                <i class="bi bi-credit-card"></i>
                <span class="d-none d-sm-inline">Manage Key Cards</span>
            </button>
            <div class="record-count-badge">
                <i class="bi bi-list-ul me-1"></i>
                <span>@FilteredItems.Count()</span>
            </div>
        </div>

        <!-- Desktop Table View -->
        <div class="card shadow-sm border-0 overflow-hidden d-none d-lg-block">
            <div class="table-responsive table-container-fixed">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Member</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Date</th>
                            <th>Card</th>
                            <th>Dues Status</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!FilteredItems.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                        No members found matching your criteria.
                                    </div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var item in FilteredItems.Take(100))
                            {
                                var overdueClass = (_activeFilter == DuesFilter.Unpaid) && item.MonthsOverdue >= 15 ? "text-danger fw-bold" : "";
                                <tr>
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-3 @(GetAvatarClass(item))">
                                                @GetInitials(item.FullName)
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">@item.FullName</div>
                                                <div class="small text-muted">ID: @item.MemberId</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadge(item.Status)">
                                            @GetStatusLabel(item.Status)
                                        </span>
                                        @if(item.IsBoardMember) { <span class="badge bg-purple-subtle text-purple ms-1">Board</span> }
                                    </td>
                                    <td>
                                        @if (item.Amount > 0)
                                        {
                                            <span class="fw-medium">@item.Amount?.ToString("C")</span>
                                        }
                                        else if (item.IsWaived && !string.IsNullOrEmpty(item.WaiverReason))
                                        {
                                            <span class="badge bg-info-subtle text-info border border-info-subtle">
                                                <i class="bi bi-shield-check me-1"></i>@item.WaiverReason
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">--</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.PaidDate.HasValue)
                                        {
                                            <span class="text-success"><i class="bi bi-check2-circle me-1"></i>@item.PaidDate.Value.ToString("MMM d")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">--</span>
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var hasCard = _memberCards.TryGetValue(item.MemberId, out var card);
                                            if (hasCard)
                                            {
                                                var isPending = _pendingSyncs.ContainsKey(card.KeyCardId);
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="badge bg-success-subtle text-success border border-success-subtle">
                                                        <i class="bi bi-credit-card-2-front"></i> Active
                                                    </span>
                                                    @if (isPending)
                                                    {
                                                        <span class="text-warning" title="Sync Pending">
                                                            <i class="bi bi-arrow-repeat spin-slow"></i>
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-success" title="Synced">
                                                            <i class="bi bi-cloud-check"></i>
                                                        </span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="badge bg-light text-muted border">No Card</span>
                                            }
                                        }
                                    </td>
                                    <td class="@overdueClass">
                                         @if (item.Satisfied)
                                         {
                                              if (item.IsWaived) 
                                              {
                                                  <span class="badge bg-info-subtle text-info border border-info-subtle">
                                                      <i class="bi bi-shield-check me-1"></i> Waived
                                                  </span>
                                              }
                                              else 
                                              {
                                                  <span class="badge bg-success-subtle text-success border border-success-subtle">
                                                      <i class="bi bi-check-circle me-1"></i> Paid
                                                  </span>
                                              }
                                         }
                                         else if (item.IsInGracePeriod)
                                         {
                                             <span class="badge bg-success-subtle text-success border border-success-subtle">
                                                 <i class="bi bi-hourglass-split me-1"></i> Grace Period
                                             </span>
                                         }
                                         else
                                         {
                                             @FormatOverdueText(item.MonthsOverdue)
                                         }
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="d-flex justify-content-end gap-2">
                                            @if (CanRecordPayment(item))
                                            {
                                                <button class="btn btn-sm btn-primary px-3 @(TutorialService.ShouldShowStep(5) ? "tutorial-pulse" : "")" @onclick="() => OpenPaymentModal(item)" title="Record Payment">
                                                    Pay
                                                </button>
                                            }
                                            else if (item.Status == MemberStatus.Life || item.IsBoardMember)
                                            {
                                                <button class="btn btn-sm btn-light border text-muted pe-none" disabled>
                                                    <i class="bi bi-shield-lock"></i>
                                                    <span class="d-none d-lg-inline ms-1">Auto-Waived</span>
                                                </button>
                                            }
                                            else if (IsPaid(item))
                                            {
                                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenEditPaymentModal(item)" title="Edit Payment">
                                                    <i class="bi bi-pencil"></i>
                                                    <span class="d-none d-lg-inline ms-1">Edit</span>
                                                </button>
                                            }
                                            else if (item.MonthsOverdue >= 15 && CanSetInactive(item))
                                            {
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmAndSetInactiveAsync(item)">
                                                    Deactivate
                                                </button>
                                            }
                                            else if (CanWaive(item) || item.IsWaived)
                                            {
                                                <button class="btn btn-sm @(item.IsWaived ? "btn-outline-info" : "btn-info text-white")" 
                                                        @onclick="() => OpenWaiverModal(item)" 
                                                        title="@(item.IsWaived ? "Manage Waiver" : "Apply Waiver")">
                                                    <i class="bi @(item.IsWaived ? "bi-shield-check" : "bi-shield-plus")"></i>
                                                    <span class="d-none d-lg-inline ms-1">@(item.IsWaived ? "Waiver" : "Waive")</span>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
            @if (FilteredItems.Count() > 100)
            {
                <div class="card-footer text-center text-muted small py-3">
                    Showing first 100 results. Use search to find specific members.
                </div>
            }
        </div>

        <!-- Mobile List View -->
        <div class="d-lg-none">
             @if (!FilteredItems.Any())
             {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                    No members found.
                </div>
             }
             else 
             {
                @foreach (var item in FilteredItems.Take(50))
                {
                    <div class="card mb-3 shadow-sm border-0 border-start border-4 @(IsPaid(item) ? "border-success" : (item.MonthsOverdue >= 12 ? "border-danger" : "border-warning"))">
                        <div class="card-body p-3">
                            <!-- Header Row with Avatar & Status -->
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-circle me-3 @(GetAvatarClass(item))" style="width: 48px; height: 48px; font-size: 1.1rem;">
                                    @GetInitials(item.FullName)
                                </div>
                                <div class="flex-grow-1 min-width-0">
                                    <div class="fw-bold text-dark text-truncate">@item.FullName</div>
                                    <div class="small text-muted mb-1">ID: @item.MemberId</div>
                                </div>
                                <div class="d-flex flex-column align-items-end gap-1">
                                    <span class="badge @GetStatusBadge(item.Status)">@GetStatusLabel(item.Status)</span>
                                    @if(item.IsBoardMember) { <span class="badge bg-purple-subtle text-purple x-small">Board</span> }
                                </div>
                            </div>

                            <!-- Info Grid -->
                            <div class="row g-2 mb-3 bg-light rounded p-2 mx-0">
                                <div class="col-6 border-end">
                                    <div class="small text-uppercase text-muted" style="font-size: 0.7rem;">Dues Status</div>
                                    @if (item.PaidDate.HasValue)
                                    {
                                        <div class="text-success fw-bold">
                                            <i class="bi bi-check2-circle"></i> Paid
                                        </div>
                                    }
                                    else if (item.IsWaived)
                                    {
                                        <div class="text-info fw-bold">Waived</div>
                                    }
                                    else
                                    {
                                        <div class="text-danger fw-bold">Unpaid</div>
                                        @if(item.MonthsOverdue > 0) {
                                            <div class="text-danger x-small">@FormatOverdueText(item.MonthsOverdue)</div>
                                        }
                                    }
                                </div>
                                <div class="col-6 ps-3">
                                    <div class="small text-uppercase text-muted" style="font-size: 0.7rem;">Key Card</div>
                                    @{
                                        var hasCard = _memberCards.TryGetValue(item.MemberId, out var card);
                                        if (hasCard)
                                        {
                                            <div class="text-success fw-bold"><i class="bi bi-credit-card"></i> Active</div>
                                        }
                                        else
                                        {
                                            <div class="text-muted"><i class="bi bi-dash-circle"></i> None</div>
                                        }
                                    }
                                </div>
                            </div>

                            <!-- Actions Row -->
                            <div class="d-grid gap-2 d-flex">
                                @if (CanRecordPayment(item))
                                {
                                    <button class="btn btn-primary flex-grow-1" @onclick="() => OpenPaymentModal(item)">
                                        Record Pay
                                    </button>
                                }

                                @if (item.Status != MemberStatus.Life && !item.IsBoardMember && !IsPaid(item))
                                {
                                     <button class="btn btn-outline-secondary" @onclick="() => OpenWaiverModal(item)">
                                        <i class="bi bi-shield-exclamation"></i>
                                    </button>
                                }
                                
                                <button class="btn btn-light text-muted" @onclick='() => NavManager.NavigateTo($"/members/{item.MemberId}")'>
                                    Details
                                </button>
                            </div>
                        </div>
                    </div>
                }
                
                @if (FilteredItems.Count() > 50)
                {
                    <div class="text-center pb-3">
                        <small class="text-muted">Showing 50 of @FilteredItems.Count() items</small>
                    </div>
                }
             }
        </div>
    }

    <!-- Payment Modal -->
    @if (_showPaymentModal && _paymentTarget is not null)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header border-bottom-0 pb-0">
                        <h5 class="modal-title">Record Payment</h5>
                        <button type="button" class="btn-close" @onclick="ClosePaymentModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="_paymentForm" OnValidSubmit="PromptSubmitPayment">
                            <DataAnnotationsValidator />
                            <div class="d-flex align-items-center mb-4 p-3 bg-light rounded-3">
                                <div class="avatar-circle me-3 bg-primary text-white">
                                    @GetInitials(_paymentTarget.FullName)
                                </div>
                                <div>
                                    <h6 class="mb-0">@_paymentTarget.FullName</h6>
                                    <small class="text-muted">Member ID: @_paymentTarget.MemberId</small>
                                </div>
                                <div class="ms-auto text-end">
                                    <label class="small text-muted mb-0">Dues Year</label>
                                    <InputSelect class="form-select form-select-sm fw-bold border-0 bg-transparent text-end pe-4" @bind-Value="_paymentForm.Year">
                                        @for (int y = _selectedYear - 2; y <= _selectedYear + 2; y++)
                                        {
                                            <option value="@y">@y</option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Amount</label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-white text-muted">$</span>
                                        <InputNumber class="form-control fw-bold" @bind-Value="_paymentForm.Amount" />
                                    </div>
                                    <ValidationMessage For="@(() => _paymentForm.Amount)" />
                                </div>
                                
                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Date</label>
                                    <div class="d-flex gap-2">
                                        <select class="form-select" @bind="_paymentMonth" @bind:after="UpdatePaymentDate">
                                            <option value="0">Month</option>
                                            <option value="1">01 - January</option>
                                            <option value="2">02 - February</option>
                                            <option value="3">03 - March</option>
                                            <option value="4">04 - April</option>
                                            <option value="5">05 - May</option>
                                            <option value="6">06 - June</option>
                                            <option value="7">07 - July</option>
                                            <option value="8">08 - August</option>
                                            <option value="9">09 - September</option>
                                            <option value="10">10 - October</option>
                                            <option value="11">11 - November</option>
                                            <option value="12">12 - December</option>
                                        </select>
                                        <select class="form-select" @bind="_paymentDay" @bind:after="UpdatePaymentDate">
                                            <option value="0">Day</option>
                                            @for (int i = 1; i <= 31; i++)
                                            {
                                                <option value="@i">@i</option>
                                            }
                                        </select>
                                        <select class="form-select" @bind="_paymentYear" @bind:after="UpdatePaymentDate">
                                            <option value="0">Year</option>
                                            @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 5; year--)
                                            {
                                                <option value="@year">@year</option>
                                            }
                                        </select>
                                    </div>
                                    <ValidationMessage For="@(() => _paymentForm.PaidDate)" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Method</label>
                                    <InputSelect class="form-select" @bind-Value="_paymentForm.PaymentType">
                                        @foreach (var method in PaymentMethods)
                                        {
                                            <option value="@method">@method</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => _paymentForm.PaymentType)" />
                                </div>
                                
                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Notes</label>
                                    <InputText class="form-control" placeholder="Check #, Reference, etc." @bind-Value="_paymentForm.Notes" />
                                    <ValidationMessage For="@(() => _paymentForm.Notes)" />
                                </div>
                            </div>

                            <div class="d-grid mt-4">
                                <button class="btn btn-primary btn-lg @(TutorialService.ShouldShowStep(6) ? "tutorial-pulse" : "")" type="submit" disabled="@_operationInProgress">
                                    @if (_operationInProgress)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Processing...</span>
                                    }
                                    else
                                    {
                                        <span>Confirm Payment</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
    
    <!-- Payment Success Modal -->
    @if (_showSuccessModal && _lastPaymentMember != null)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg text-center">
                    <div class="modal-body p-5">
                       <div class="mb-3 text-success">
                           <i class="bi bi-check-circle-fill display-1"></i>
                       </div>
                       <h3 class="fw-bold mb-3">Payment Recorded!</h3>
                       <p class="text-muted mb-4">
                           Payment of <strong>@_lastPaymentAmount.ToString("C")</strong> for <strong>@_lastPaymentMember</strong> was successful.
                       </p>
                        
                        @if (!_hasActiveCard)
                        {
                            <div class="alert alert-warning border-0 shadow-sm mb-4 text-start">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="bi bi-credit-card-2-front-fill fs-5"></i>
                                    <strong class="fw-bold">No Key Card Assigned</strong>
                                </div>
                                <p class="mb-0 small">This member has paid their dues but does not have an active key card. Would you like to assign one now?</p>
                            </div>
                            
                            <div class="d-grid gap-2 col-10 mx-auto">
                                <button class="btn btn-primary btn-lg mb-2 @(TutorialService.ShouldShowStep(7) ? "tutorial-pulse" : "")" @onclick="NavigateToAssignCard">
                                    <i class="bi bi-credit-card-2-front me-2"></i>Yes, Assign & Activate Card
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="CloseSuccessModal">No, Close</button>
                            </div>
                        }
                        else
                        {
                            <div class="d-grid gap-2 col-8 mx-auto">
                                <button class="btn btn-primary" @onclick="PrintReceipt">
                                    <i class="bi bi-printer me-2"></i> Print Receipt
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="CloseSuccessModal">Close</button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @* Edit Payment Modal *@
    @if (_showEditPaymentModal && _editPaymentTarget != null)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg modal-glass">
                    <div class="modal-header border-bottom-0">
                        <div class="d-flex align-items-center w-100">
                            <div class="icon-shape bg-warning-subtle text-warning me-3">
                                <i class="bi bi-pencil-square"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="modal-title fw-bold mb-0">Edit Payment</h5>
                                <small class="text-muted">@_editPaymentTarget.FullName - ID: @_editPaymentTarget.MemberId</small>
                            </div>
                            <button type="button" class="btn-close" @onclick="CloseEditPaymentModal"></button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="_editPaymentForm" OnValidSubmit="PromptEditPaymentConfirmation">
                            <DataAnnotationsValidator />
                            
                            <div class="alert alert-warning border-0 mb-4">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Caution:</strong> Editing this payment will update the record and log the change for audit purposes.
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Amount</label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-white text-muted">$</span>
                                        <InputNumber class="form-control fw-bold" @bind-Value="_editPaymentForm.Amount" />
                                    </div>
                                    <ValidationMessage For="@(() => _editPaymentForm.Amount)" />
                                </div>
                                
                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Date</label>
                                    <div class="d-flex gap-2">
                                        <select class="form-select" @bind="_editPaymentMonth" @bind:after="UpdateEditPaymentDate">
                                            <option value="0">Month</option>
                                            <option value="1">01 - January</option>
                                            <option value="2">02 - February</option>
                                            <option value="3">03 - March</option>
                                            <option value="4">04 - April</option>
                                            <option value="5">05 - May</option>
                                            <option value="6">06 - June</option>
                                            <option value="7">07 - July</option>
                                            <option value="8">08 - August</option>
                                            <option value="9">09 - September</option>
                                            <option value="10">10 - October</option>
                                            <option value="11">11 - November</option>
                                            <option value="12">12 - December</option>
                                        </select>
                                        <select class="form-select" @bind="_editPaymentDay" @bind:after="UpdateEditPaymentDate">
                                            <option value="0">Day</option>
                                            @for (int i = 1; i <= 31; i++)
                                            {
                                                <option value="@i">@i</option>
                                            }
                                        </select>
                                        <select class="form-select" @bind="_editPaymentYear" @bind:after="UpdateEditPaymentDate">
                                            <option value="0">Year</option>
                                            @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 5; year--)
                                            {
                                                <option value="@year">@year</option>
                                            }
                                        </select>
                                    </div>
                                    <ValidationMessage For="@(() => _editPaymentForm.PaidDate)" />
                                </div>
                                
                                <div class="col-6">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Method</label>
                                    <InputSelect class="form-select" @bind-Value="_editPaymentForm.PaymentType">
                                        @foreach (var method in PaymentMethods)
                                        {
                                            <option value="@method">@method</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => _editPaymentForm.PaymentType)" />
                                </div>
                                
                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Notes</label>
                                    <InputText class="form-control" placeholder="Check #, Reference, etc." @bind-Value="_editPaymentForm.Notes" />
                                    <ValidationMessage For="@(() => _editPaymentForm.Notes)" />
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-warning text-white btn-lg" type="submit" disabled="@_operationInProgress">
                                    @if (_operationInProgress)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Updating...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-check-circle me-2"></i>
                                        <span>Update Payment</span>
                                    }
                                </button>
                                <button type="button" class="btn btn-light" @onclick="CloseEditPaymentModal" disabled="@_operationInProgress">Cancel</button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Waiver Modal -->
    @if (_showWaiverModal)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg modal-glass">
                    <div class="modal-header border-bottom-0">
                        <div class="d-flex align-items-center">
                            <div class="icon-shape bg-info-subtle text-info me-3">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div>
                                <h5 class="modal-title fw-bold">Manage Dues Waiver</h5>
                                <p class="text-muted small mb-0">@_waiverForm.MemberName - ID: @_waiverForm.MemberId</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" @onclick="CloseWaiverModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="_waiverForm" OnValidSubmit="PromptSubmitWaiver">
                            <DataAnnotationsValidator />
                            
                            <div class="row g-4">
                                <!-- Duration Selection -->
                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold ls-1">Waiver Duration</label>
                                    <div class="d-flex gap-3 mt-1">
                                        <div class="form-check custom-radio">
                                            <input class="form-check-input" type="radio" name="waiverType" id="typeSingle" 
                                                   checked="@(!_waiverForm.IsPermanent)" @onclick="() => _waiverForm.IsPermanent = false">
                                            <label class="form-check-label" for="typeSingle">Temporary</label>
                                        </div>
                                        <div class="form-check custom-radio">
                                            <input class="form-check-input" type="radio" name="waiverType" id="typePerm" 
                                                   checked="@(_waiverForm.IsPermanent)" @onclick="() => _waiverForm.IsPermanent = true">
                                            <label class="form-check-label" for="typePerm">Permanent</label>
                                        </div>
                                    </div>
                                </div>

                                @if (!_waiverForm.IsPermanent)
                                {
                                    <div class="col-6">
                                        <label class="form-label small text-muted text-uppercase fw-bold ls-1">Start Year</label>
                                        <InputNumber class="form-control form-control-modern" @bind-Value="_waiverForm.StartYear" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small text-muted text-uppercase fw-bold ls-1">End Year</label>
                                        <InputNumber class="form-control form-control-modern" @bind-Value="_waiverForm.EndYear" />
                                        <div class="form-text x-small mt-1 text-info">
                                            <i class="bi bi-info-circle me-1"></i>Owes dues in <strong>@(_waiverForm.EndYear + 1)</strong>
                                        </div>
                                    </div>
                                }

                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold ls-1">Reason for Waiver</label>
                                    <InputSelect class="form-select form-control-modern" @bind-Value="_waiverForm.Reason">
                                        <option value="">-- Select Reason --</option>
                                        <option value="Club Maintenance & Repairs">Club Maintenance & Repairs</option>
                                        <option value="Building/Facility Improvements">Building/Facility Improvements</option>
                                        <option value="Technical/Professional Services">Technical/Professional Services</option>
                                        <option value="Outstanding Service Contribution">Outstanding Service Contribution</option>
                                        <option value="Financial Hardship">Financial Hardship</option>
                                        <option value="Other (Specify in notes)">Other (Specify in notes)</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => _waiverForm.Reason)" />
                                </div>

                                <div class="col-12">
                                    <label class="form-label small text-muted text-uppercase fw-bold ls-1">Internal Notes</label>
                                    <InputTextArea class="form-control form-control-modern" rows="3" 
                                                   placeholder="Add details about why this waiver was granted..." 
                                                   @bind-Value="_waiverForm.Notes" />
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top">
                                @if (_waiverForm.WaiverId > 0)
                                {
                                    <button type="button" class="btn btn-link text-danger p-0" @onclick="PromptDeleteWaiver">
                                        <i class="bi bi-trash me-1"></i> Remove Waiver
                                    </button>
                                }
                                else
                                {
                                    <div></div>
                                }
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-light px-4" @onclick="CloseWaiverModal">Cancel</button>
                                    <button type="submit" class="btn btn-info text-white px-4 fw-bold" disabled="@_operationInProgress">
                                        @if (_operationInProgress)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        @( _waiverForm.WaiverId > 0 ? "Update Waiver" : "Grant Waiver")
                                    </button>
                                </div>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Global Confirmation Modal -->
    @if (_showConfirmModal)
    {
        <ConfirmActionModal 
            Title="@_confirmTitle"
            Message="@_confirmMessage"
            SubMessage="@_confirmSubMessage"
            ConfirmText="@_confirmActionText"
            Icon="@_confirmIcon"
            Type="@_confirmType"
            OnConfirm="HandleConfirmedAction"
            OnCancel="() => _showConfirmModal = false" />
    }

    <!-- Grace Period Edit Modal -->
    @if (_showGracePeriodModal)
    {
        <div class="modal-backdrop-modern fade-in" @onclick="CloseGracePeriodModal"></div>
        <div class="modal-modern-container fade-in scale-in">
            <div class="modal-modern">
                <div class="modal-header-modern">
                    <div>
                        <h3 class="modal-title-modern">
                            <i class="bi bi-calendar-check text-success"></i>
                            Configure Grace Period
                        </h3>
                        <p class="modal-subtitle">Set the grace end date for @_selectedYear dues</p>
                    </div>
                    <button class="btn-close-modern" @onclick="CloseGracePeriodModal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                
                <div class="modal-body-modern">
                    <div class="grace-period-config">
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle"></i>
                            <div>
                                <strong>About Grace Period:</strong>
                                <p class="mb-0 small">Members who paid last year can continue using their key cards until this recurring date.</p>
                            </div>
                        </div>

                        <div class="form-group-modern mb-4">
                            <label class="form-label-modern">
                                Recurring Deadline <span class="text-danger">*</span>
                            </label>
                            <div class="d-flex gap-3">
                                <select class="form-select form-select-lg" @bind="_gracePeriodMonth">
                                    @for (int m = 1; m <= 12; m++)
                                    {
                                        <option value="@m">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
                                    }
                                </select>
                                <select class="form-select form-select-lg" style="width: 100px;" @bind="_gracePeriodDay">
                                    @for (int d = 1; d <= 31; d++)
                                    {
                                        <option value="@d">@d</option>
                                    }
                                </select>
                            </div>
                            <small class="text-muted">
                                Setting "April 1st" means cards expire on April 1st, @_selectedYear.
                            </small>
                        </div>

                        <div class="summary-card mb-4">
                            <h6 class="mb-3">Summary</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Selected Date:</span>
                                <strong>@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(_gracePeriodMonth) @_gracePeriodDay</strong>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Effect:</span>
                                <span class="badge bg-primary">Recurs Annually</span>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(_gracePeriodError))
                        {
                            <div class="alert alert-danger mt-3">@_gracePeriodError</div>
                        }
                    </div>
                </div>
                
                <div class="modal-footer-modern">
                    <button class="btn btn-light px-4" @onclick="CloseGracePeriodModal">Cancel</button>
                    <button class="btn btn-primary px-4 fw-bold" @onclick="RequestSaveGracePeriod" disabled="@_savingGracePeriod">
                        @if (_savingGracePeriod)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private enum DuesFilter { Unpaid, Paid, Waived }
    
    private List<int> _years = new();
    private int _selectedYear;
    private DuesFilter _activeFilter = DuesFilter.Unpaid;
    private bool _loading = true;
    private List<DuesListItemDto> _allItems = new();
    private DuesSummaryDto? _summary;
    private string? _errorMessage;
    private string? _operationMessage;
    private bool _operationError;
    private bool _operationInProgress;
    private DuesYearSettings? _currentYearSettings;
    private string _searchText = string.Empty;
    private bool _showPaymentModal;
    private bool _showSuccessModal = false;
    private string? _lastPaymentMember;
    private decimal _lastPaymentAmount;
    private int _lastPaymentMemberId;
    private bool _showGracePeriodModal;
    private int _gracePeriodMonth;
    private int _gracePeriodDay;
    private string _gracePeriodError = string.Empty;
    private bool _savingGracePeriod;
    
    // Edit Payment Modal State
    private bool _showEditPaymentModal;
    private DuesListItemDto? _editPaymentTarget;
    private PaymentFormModel _editPaymentForm = new();
    private int _editPaymentMonth;
    private int _editPaymentDay;
    private int _editPaymentYear;
    private int _originalPaymentId;

    // Confirmation Modal State
    private bool _showConfirmModal = false;
    private string _confirmTitle = "";
    private string _confirmMessage = "";
    private string _confirmSubMessage = "";
    private string _confirmActionText = "";
    private string _confirmIcon = "";
    private ConfirmActionModal.ConfirmType _confirmType;
    private Func<Task>? _confirmAction;

    private async Task HandleConfirmedAction()
    {
        if (_confirmAction != null)
        {
            try
            {
                _showConfirmModal = false;
                StateHasChanged(); // Hide modal immediately
                await _confirmAction();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error performing confirmed action");
                _operationError = true;
                _operationMessage = "An error occurred while performing the action.";
            }
            finally
            {
                StateHasChanged();
            }
        }
    }

    private void NavigateToKeyCards()
    {
        NavManager.NavigateTo("/keycards");
    }

    private bool _hasActiveCard;
    private DuesListItemDto? _paymentTarget;
    private PaymentFormModel _paymentForm = PaymentFormModel.CreateDefault();
    
    // Date picker backing fields for payment modal
    private int _paymentMonth = 0;
    private int _paymentDay = 0;
    private int _paymentYear = 0;
    
    private bool _showWaiverModal;
    private WaiverFormModel _waiverForm = new();

    private async Task OpenWaiverModal(DuesListItemDto item)
    {
        if (item.Status == MemberStatus.Life || item.IsBoardMember) return;
        
        _operationInProgress = true;
        try 
        {
            var existingWaivers = await Task.Run(() => DuesWaiverRepository.GetWaiversForMember(item.MemberId));
            var activeWaiver = existingWaivers.FirstOrDefault(w => _selectedYear >= w.StartYear && _selectedYear <= w.EndYear);
            
            if (activeWaiver != null)
            {
                _waiverForm = new WaiverFormModel
                {
                    WaiverId = activeWaiver.WaiverId,
                    MemberId = item.MemberId,
                    MemberName = item.FullName,
                    StartYear = activeWaiver.StartYear,
                    EndYear = activeWaiver.EndYear,
                    Reason = activeWaiver.Reason,
                    IsPermanent = activeWaiver.EndYear >= 2099
                };
            }
            else
            {
                _waiverForm = WaiverFormModel.Create(item, _selectedYear);
            }
            
            _showWaiverModal = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load waiver data");
            _operationMessage = "Could not load waiver details.";
            _operationError = true;
        }
        finally
        {
            _operationInProgress = false;
        }
    }

    private void CloseWaiverModal()
    {
        _showWaiverModal = false;
    }

    private async Task PromptSubmitWaiver()
    {
        _confirmTitle = _waiverForm.WaiverId > 0 ? "Update Waiver" : "Grant Waiver";
        _confirmMessage = $"Are you sure you want to {_confirmTitle.ToLower()} for {_waiverForm.MemberName}?";
        _confirmSubMessage = _waiverForm.IsPermanent 
            ? "This waiver will apply permanently (thru 2099)." 
            : $"This will cover member dues from {_waiverForm.StartYear} to {_waiverForm.EndYear}.";
        _confirmActionText = _confirmTitle;
        _confirmType = ConfirmActionModal.ConfirmType.Info;
        _confirmIcon = "bi-shield-check";
        _confirmAction = async () => await SubmitWaiverAsync();
        _showConfirmModal = true;
    }

    private async Task SubmitWaiverAsync()
    {
        _showWaiverModal = false; // Close form modal before showing confirm? No, form modal is usually under.
                                 // Let's close it so the confirm modal is the only thing.
        _operationInProgress = true;
        try
        {
            // NEW: Validate no payments exist for ANY year in the range
            var startYear = _waiverForm.StartYear;
            var endYear = _waiverForm.IsPermanent ? 2099 : _waiverForm.EndYear;

            var existingPayments = await Task.Run(() => DuesRepository.GetDuesForMember(_waiverForm.MemberId));
            var conflictingPayment = existingPayments.FirstOrDefault(p => 
                p.Year >= startYear && p.Year <= endYear && 
                p.PaidDate.HasValue && !string.Equals(p.PaymentType, "WAIVED", StringComparison.OrdinalIgnoreCase));

            if (conflictingPayment != null)
            {
                _operationMessage = $"Conflict: The member already has a recorded payment for the year {conflictingPayment.Year}. You cannot waive a year that is already paid.";
                _operationError = true;
                _showWaiverModal = true; // Re-open the form so they can fix the range
                return;
            }

            var currentUser = AuthStateProvider.GetCurrentUser();
            var waiver = new DuesWaiverPeriod
            {
                WaiverId = _waiverForm.WaiverId ?? 0,
                MemberId = _waiverForm.MemberId,
                StartYear = startYear,
                EndYear = endYear,
                Reason = _waiverForm.Reason,
                CreatedBy = currentUser?.Username ?? "System Admin",
                CreatedDate = DateTime.Now
            };

            if (waiver.WaiverId > 0)
            {
                await Task.Run(() => DuesWaiverRepository.UpdateWaiver(waiver));
            }
            else
            {
                await Task.Run(() => DuesWaiverRepository.AddWaiver(waiver));
            }

            _operationMessage = $"Waiver updated for {_waiverForm.MemberName}.";
            _operationError = false;
            
            // NEW: Automatically trigger card reactivation if they are now eligible
            try 
            {
                await KeyCardLifecycleService.ProcessMemberAsync(_waiverForm.MemberId, _selectedYear);
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to auto-reactivate card after waiver");
            }

            await LoadDataInternal(silent: true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save waiver");
            _operationMessage = "Error saving waiver details.";
            _operationError = true;
        }
        finally
        {
            _operationInProgress = false;
        }
    }

    private void PromptDeleteWaiver()
    {
        _confirmTitle = "Remove Waiver";
        _confirmMessage = $"Remove the dues waiver for {_waiverForm.MemberName}?";
        _confirmSubMessage = "This will erase the waiver record entirely. The member may immediately show as 'Unpaid' for the covered years.";
        _confirmActionText = "Remove Record";
        _confirmIcon = "bi-trash";
        _confirmType = ConfirmActionModal.ConfirmType.Danger;
        _confirmAction = async () => await DeleteWaiverAsync();
        _showConfirmModal = true;
    }

    private async Task DeleteWaiverAsync()
    {
        if (_waiverForm.WaiverId == null) return;
        
        _showWaiverModal = false;
        _operationInProgress = true;
        try
        {
            await Task.Run(() => DuesWaiverRepository.DeleteWaiver(_waiverForm.WaiverId.Value));
            _operationMessage = "Waiver removed successfully.";
            _operationError = false;
            await LoadDataInternal(silent: true);
            if (_allItems.Count > 0)
            {
               CheckQueryParameters();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete waiver");
            _operationMessage = "Error removing waiver.";
            _operationError = true;
        }
        finally
        {
            _operationInProgress = false;
            StateHasChanged();
        }
    }
    
    private void CheckQueryParameters()
    {
        if (QueryMemberId.HasValue && QueryMemberId.Value > 0 && 
            string.Equals(QueryAction, "pay", StringComparison.OrdinalIgnoreCase))
        {
            var member = _allItems.FirstOrDefault(m => m.MemberId == QueryMemberId.Value);
            if (member != null)
            {
                // Verify member hasn't paid yet? Or allow paying anyway?
                // Logic: If they are coming from "Add Member", they likely haven't paid.
                // Just open the modal.
                OpenPaymentModal(member);
                
                // Clear the query string so it doesn't reopen on refresh
                // This is a bit hacky in Blazor Server without full reload, but effectively we just clear our state
                QueryAction = null;
                QueryMemberId = null; 
            }
        }
    }
    private static readonly string[] PaymentMethods = { "Cash", "Check", "Card", "Online", "Other" };
    
    private DateTime? _graceEndDate;
    private int _membersAtRiskCount = 0;
    private int _pendingSyncCount = 0;
    private DateTime? _lastSyncTime;
    
    // Data Caches
    private Dictionary<int, KeyCard> _memberCards = new();
    private Dictionary<int, ControllerSyncQueueItem> _pendingSyncs = new();

    // Scan Buffer
    private string _scanBuffer = "";
    private System.Timers.Timer _scanTimer;
    private DotNetObjectReference<Dues>? _objRef;

    [SupplyParameterFromQuery(Name = "action")]
    public string? QueryAction { get; set; }

    [SupplyParameterFromQuery(Name = "memberId")]
    public int? QueryMemberId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        TutorialService.OnTutorialStateChanged += HandleTutorialStateChanged;

        // Auto-advance from Step 4 (AddMember success) to Step 5 (Navigate to Dues)
        if (TutorialService.ShouldShowStep(4))
        {
            _ = TutorialService.NextStepAsync();
        }

        _scanTimer = new System.Timers.Timer(100); // 100ms timeout for rapid variance
        _scanTimer.Elapsed += (s, e) => _scanBuffer = "";
        _scanTimer.AutoReset = false;

        try
        {
            _years = (await DuesService.GetAvailableYearsAsync()).OrderBy(y => y).ToList();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Dues:years] {ex}");
            _errorMessage = "We couldn't load the list of dues years. Please verify the database connection.";
            _loading = false;
            return;
        }

        var currentYear = DateTime.Today.Year;
        if (!_years.Contains(currentYear))
        {
            _years.Add(currentYear);
            _years = _years.OrderBy(y => y).ToList();
        }
        _selectedYear = currentYear;
        await LoadDataInternal();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _objRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("blazorInterop.registerKeyListener", _objRef);
            }
            catch (JSException ex)
            {
                // Likely a cached JS file issue or older client.
                Logger.LogWarning(ex, "Failed to register key listener. Scanner features may be unavailable.");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Unexpected error registering key listener.");
            }
        }
    }

    [JSInvokable]
    public async Task HandleGlobalKeyPress(string key)
    {
        if (key == "Enter")
        {
            if (!string.IsNullOrWhiteSpace(_scanBuffer))
            {
                await ProcessScanAsync(_scanBuffer);
                _scanBuffer = "";
            }
        }
        else if (key.Length == 1)
        {
            _scanBuffer += key;
            _scanTimer.Stop();
            _scanTimer.Start();
        }
    }

    private async Task ProcessScanAsync(string cardNumber)
    {
        // Find member by card
        try
        {
            var card = await Task.Run(() => KeyCardRepository.GetByCardNumber(cardNumber));
            if (card != null)
            {
                var memberItem = _allItems.FirstOrDefault(m => m.MemberId == card.MemberId);
                if (memberItem != null)
                {
                    _operationMessage = $"Card Scanned: Found {memberItem.FullName}";
                    _operationError = false;
                    _searchText = memberItem.FullName; // Filter view
                    
                    // If unpaid, prompt for payment? Or just show?
                    // Let's just filter so user can decide. 
                    // Or if unpaid, open modal automatically?
                     if (CanRecordPayment(memberItem)) 
                     {
                         OpenPaymentModal(memberItem);
                     }
                     StateHasChanged();
                }
                else
                {
                    _operationMessage = "Card scanned, but member not found in current dues list.";
                    _operationError = true;
                    StateHasChanged();
                }
            }
            else
            {
                _operationMessage = "Card scanned, but no matching key card found in system.";
                _operationError = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
        }
    }

    public void Dispose()
    {
        TutorialService.OnTutorialStateChanged -= HandleTutorialStateChanged;
        _scanTimer?.Dispose();
        _objRef?.Dispose();
        JSRuntime.InvokeVoidAsync("blazorInterop.unregisterKeyListener").AsTask();
    }

    private void HandleTutorialStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task OnYearChanged()
    {
        _operationMessage = null;
        await LoadDataInternal();
    }

    private void SetFilter(DuesFilter filter)
    {
        _activeFilter = filter;
        _operationMessage = null;
        _searchText = string.Empty;
    }

    private async Task LoadDataInternal(bool silent = false)
    {
        if (!silent) _loading = true;
        _errorMessage = null;
        try
        {
            var unpaidItems = await DuesService.GetDuesAsync(_selectedYear, false);
            var paidItems = await DuesService.GetDuesAsync(_selectedYear, true);
            _summary = await DuesService.GetSummaryAsync(_selectedYear);
            
            _currentYearSettings = await Task.Run(() => DuesYearSettingsRepository.GetSettingsForYear(_selectedYear));

            var combined = new List<DuesListItemDto>();
            if (unpaidItems != null) combined.AddRange(unpaidItems);
            if (paidItems != null) combined.AddRange(paidItems);
            
            _allItems = combined.GroupBy(x => x.MemberId).Select(g => g.First()).ToList();
            
            _graceEndDate = _currentYearSettings?.GraceEndDate;
            if (_graceEndDate.HasValue && DateTime.Today <= _graceEndDate.Value)
            {
                _membersAtRiskCount = _allItems.Count(x => x.PaidDate == null && (x.Amount ?? 0) > 0);
            }
            else
            {
                _membersAtRiskCount = 0;
            }
            
            // Load Card and Sync Data
            try 
            {
                var allCards = await Task.Run(() => KeyCardRepository.GetAll());
                _memberCards = allCards
                    .Where(c => c.IsActive)
                    .GroupBy(c => c.MemberId)
                    .ToDictionary(g => g.Key, g => g.First());

                var allPendingSyncs = await SyncQueueRepository.GetPendingItemsAsync();
                _pendingSyncs = allPendingSyncs
                    .GroupBy(s => s.KeyCardId)
                    .ToDictionary(g => g.Key, g => g.First());

                _pendingSyncCount = _pendingSyncs.Count;
                _lastSyncTime = await SyncQueueRepository.GetLastCompletedTimeAsync();
            }
            catch (Exception)
            {
                _memberCards = new();
                _pendingSyncs = new();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[Dues] Failed to load dues data");
            _errorMessage = "Unable to load dues details right now.";
            _allItems = new List<DuesListItemDto>();
            _summary = null;
        }
        finally
        {
            _loading = false;
        }
    }

    private void OpenPaymentModal(DuesListItemDto item)
    {
        if (!CanRecordPayment(item)) return;

        var suggestedAmount = item.Amount ?? _currentYearSettings?.StandardDues ?? 0m;
        _paymentTarget = item;
        _paymentForm = PaymentFormModel.CreateDefault();
        _paymentForm.PaymentType = string.IsNullOrWhiteSpace(item.PaymentType) ? PaymentMethods.First() : item.PaymentType;
        _paymentForm.Year = _selectedYear;
        
        // Initialize date dropdowns to today's date
        var today = DateTime.Today;
        _paymentMonth = today.Month;
        _paymentDay = today.Day;
        _paymentYear = today.Year;
        
        _showPaymentModal = true;

        // Tutorial: Advance to Step 6 when payment modal opens
        if (TutorialService.ShouldShowStep(5))
        {
            _ = TutorialService.NextStepAsync();
        }
    }

    private void ClosePaymentModal()
    {
        _showPaymentModal = false;
        _paymentTarget = null;
        _paymentMonth = 0;
        _paymentDay = 0;
        _paymentYear = 0;
    }
    
    private void UpdatePaymentDate()
    {
        if (_paymentMonth > 0 && _paymentDay > 0 && _paymentYear > 0)
        {
            try
            {
                _paymentForm.PaidDate = new DateTime(_paymentYear, _paymentMonth, _paymentDay);
            }
            catch
            {
                // Invalid date combination (e.g., Feb 30)
                _paymentForm.PaidDate = DateTime.Today;
            }
        }
        else
        {
            _paymentForm.PaidDate = DateTime.Today;
        }
    }

    private void PromptSubmitPayment()
    {
        if (_paymentTarget == null) return;
        
        // Check if payment already exists for this member/year
        var existingPayment = DuesRepository.GetDuesForMemberYear(_paymentTarget.MemberId, _paymentForm.Year);
        
        // Check if member is waived (Life, Board, or Manual waiver)
        bool isLifeMember = _paymentTarget.Status == MemberStatus.Life;
        bool isBoardMember = _paymentTarget.IsBoardMember;
        bool hasManualWaiver = DuesWaiverRepository.GetWaiversForMember(_paymentTarget.MemberId)
            .Any(w => _paymentForm.Year >= w.StartYear && _paymentForm.Year <= w.EndYear);
        bool hasWaivedPayment = existingPayment?.PaymentType?.Equals("WAIVED", StringComparison.OrdinalIgnoreCase) == true;
        
        bool isWaived = isLifeMember || isBoardMember || hasManualWaiver || hasWaivedPayment;
        
        if (isWaived)
        {
            // Member is waived - show warning
            string waiverReason = isLifeMember ? "Life Member" :
                                  isBoardMember ? "Board Member/Director" :
                                  hasWaivedPayment ? "Manually Waived" :
                                  "Active Waiver Period";
            
            _confirmTitle = " Member Has Waived Dues";
            _confirmMessage = $"{_paymentTarget.FullName} has waived dues for {_paymentForm.Year}.";
            _confirmSubMessage = $"Waiver Reason: {waiverReason}\n\n" +
                                 $"Recording a payment will REMOVE the waiver and replace it with:\n" +
                                 $"{_paymentForm.Amount:C} paid on {_paymentForm.PaidDate:MM/dd/yyyy} via {_paymentForm.PaymentType}\n\n" +
                                 $"Do you want to proceed?";
            _confirmActionText = "Yes, Remove Waiver & Record Payment";
            _confirmType = ConfirmActionModal.ConfirmType.Warning;
            _confirmIcon = "bi-exclamation-triangle";
        }
        else if (existingPayment != null)
        {
            // Payment already exists - show warning and ask for confirmation to modify
            _confirmTitle = " Payment Already Exists";
            _confirmMessage = $"{_paymentTarget.FullName} already has a payment recorded for {_paymentForm.Year}.";
            _confirmSubMessage = $"Existing: {existingPayment.Amount:C} paid on {existingPayment.PaidDate:MM/dd/yyyy} via {existingPayment.PaymentType}\n\n" +
                                 $"New: {_paymentForm.Amount:C} on {_paymentForm.PaidDate:MM/dd/yyyy} via {_paymentForm.PaymentType}\n\n" +
                                 $"Do you want to REPLACE the existing payment with the new one?";
            _confirmActionText = "Yes, Replace Payment";
            _confirmType = ConfirmActionModal.ConfirmType.Warning;
            _confirmIcon = "bi-exclamation-triangle";
        }
        else
        {
            // No existing payment - normal confirmation
            _confirmTitle = "Record Payment";
            _confirmMessage = $"Confirm payment of {_paymentForm.Amount:C} for {_paymentTarget.FullName}?";
            _confirmSubMessage = $"This will record a {_paymentForm.PaymentType} payment for the year {_paymentForm.Year}.";
            _confirmActionText = "Record Payment";
            _confirmType = ConfirmActionModal.ConfirmType.Success;
            _confirmIcon = "bi-cash-coin";
        }
        
        _confirmAction = async () => await SubmitPaymentAsync();
        _showConfirmModal = true;
    }

    private async Task SubmitPaymentAsync()
    {
        if (_paymentTarget is null) return;
        _showPaymentModal = false;
        _operationInProgress = true;
        
        try
        {
            var currentUser = AuthStateProvider.GetCurrentUser();
            await DuesServiceEF.RecordPaymentAsync(
                _paymentTarget.MemberId,
                _paymentForm.Year,
                _paymentForm.Amount ?? 0m,
                _paymentForm.PaidDate,
                _paymentForm.Notes,
                _paymentForm.PaymentType,
                currentUser?.UserId);
            
            // Auto-clear waiver if exists (Requirement: Automatically clear waivers upon payment)
            try 
            {
               var waivers = await Task.Run(() => DuesWaiverRepository.GetWaiversForMember(_paymentTarget.MemberId));
               var activeWaiver = waivers.FirstOrDefault(w => _paymentForm.Year >= w.StartYear && _paymentForm.Year <= w.EndYear);
               if (activeWaiver != null)
               {
                   await Task.Run(() => DuesWaiverRepository.DeleteWaiver(activeWaiver.WaiverId));
                   Logger.LogInformation("Waiver {WaiverId} auto-cleared due to payment", activeWaiver.WaiverId);
               }
            }
            catch (Exception wEx)
            {
                Logger.LogWarning(wEx, "Failed to auto-clear waiver");
            }

            _operationMessage = $"Payment recorded for {_paymentTarget.FullName}.";
            _operationError = false;
            
            var memberId = _paymentTarget.MemberId;
            var memberName = _paymentTarget.FullName;
            var amount = _paymentForm.Amount ?? 0m;
            
            ClosePaymentModal();
            await LoadDataInternal(silent: true);

            // Store for success modal
            _lastPaymentMember = memberName;
            _lastPaymentAmount = amount;
            _lastPaymentMemberId = memberId;
            _hasActiveCard = _memberCards.ContainsKey(memberId);
            _showSuccessModal = true;

            // Tutorial: Advance to Step 7 after success
            if (TutorialService.ShouldShowStep(6))
            {
                await TutorialService.NextStepAsync();
            }
            
            // Note: Card prompt removed from here as per preference for receipt first.
            // If card is missing, user can navigate manually or we can add a nudge in success modal later.
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Payment failed");
            _operationError = true;
            _operationMessage = "Payment failed. Please try again.";
        }
        finally
        {
            _operationInProgress = false;
        }
    }

    private void EditGracePeriod()
    {
        if (_graceEndDate.HasValue)
        {
            _gracePeriodMonth = _graceEndDate.Value.Month;
            _gracePeriodDay = _graceEndDate.Value.Day;
        }
        else
        {
            _gracePeriodMonth = 4;
            _gracePeriodDay = 1;
        }

        _gracePeriodError = string.Empty;
        _showGracePeriodModal = true;
    }

    private void CloseGracePeriodModal()
    {
        _showGracePeriodModal = false;
        _gracePeriodError = string.Empty;
    }

    private void RequestSaveGracePeriod()
    {
        int daysInMonth = DateTime.DaysInMonth(_selectedYear, _gracePeriodMonth);
        if (_gracePeriodDay > daysInMonth)
        {
            _gracePeriodError = $"Invalid date. {System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(_gracePeriodMonth)} only has {daysInMonth} days.";
            return;
        }

        _gracePeriodError = string.Empty;
        
        var monthName = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(_gracePeriodMonth);
        _confirmTitle = "Change Grace Period Date";
        _confirmMessage = $"Are you sure you want to change the annual grace period deadline to: {monthName} {_gracePeriodDay}?";
        _confirmSubMessage = "This date will recur annually. Key cards for members who haven't paid by this date will be automatically deactivated.";
        _confirmActionText = "Yes, Change Date";
        _confirmIcon = "bi-calendar-check";
        _confirmType = ConfirmActionModal.ConfirmType.Warning;
        _confirmAction = ExecuteSaveGracePeriod;
        _showGracePeriodModal = false;
        _showConfirmModal = true;
    }

    private async Task ExecuteSaveGracePeriod()
    {
        _savingGracePeriod = true;
        try
        {
            var newDate = new DateTime(_selectedYear, _gracePeriodMonth, _gracePeriodDay);
            var settings = await Task.Run(() => DuesYearSettingsRepository.GetSettingsForYear(_selectedYear));
            
            if (settings == null)
            {
                settings = new DuesYearSettings
                {
                    Year = _selectedYear,
                    StandardDues = 250,
                    GraceEndApplied = true,
                    GraceEndDate = newDate
                };
                await DuesYearSettingsRepository.UpsertSettings(settings);
            }
            else
            {
                settings.GraceEndDate = newDate;
                settings.GraceEndApplied = true;
                await DuesYearSettingsRepository.UpsertSettings(settings);
            }
            
            await LoadDataInternal(silent: true);
            _gracePeriodError = string.Empty;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving grace period");
            _gracePeriodError = "Failed to save grace period settings.";
            _showGracePeriodModal = true;
        }
        finally
        {
            _savingGracePeriod = false;
            StateHasChanged();
        }
    }

    private void CloseSuccessModal()
    {
        _showSuccessModal = false;
        _lastPaymentMember = null;
    }

    private void NavigateToAssignCard()
    {
        _showSuccessModal = false;

        // Tutorial: Advance to Step 8 (Navigate to Key Cards)
        if (TutorialService.ShouldShowStep(7))
        {
            _ = TutorialService.NextStepAsync();
        }

        NavManager.NavigateTo($"/keycards?assignTo={_lastPaymentMemberId}");
    }

    private async Task PrintReceipt()
    {
        await JSRuntime.InvokeVoidAsync("print");
    }

    private void ConfirmAndSetInactiveAsync(DuesListItemDto item)
    {
        _confirmTitle = "Confirm Member Deactivation";
        _confirmMessage = $"Are you sure you want to deactivate {item.FullName}?";
        _confirmSubMessage = "This will mark them as INACTIVE and simultaneously deactivate their physical key card access.";
        _confirmActionText = "Confirm Deactivate";
        _confirmType = ConfirmActionModal.ConfirmType.Danger;
        _confirmIcon = "bi-person-x-fill";
        _confirmAction = async () => 
        {
             _operationInProgress = true;
             try {
                 var member = await Task.Run(() => MemberRepository.GetMemberById(item.MemberId));
                 if (member != null) {
                     member.InactiveDate = DateTime.Today;
                     await MemberService.UpdateMemberStatusAsync(member, "INACTIVE", "System", false);
                     
                     // Log note
                     await Task.Run(() => GlobalNoteRepository.InsertNote(new GlobalNote {
                         NoteDate = DateTime.Now,
                         Category = "STATUS CHANGE",
                         Text = $"{item.FullName} (ID {item.MemberId}) set inactive on {DateTime.Today:yyyy-MM-dd} for unpaid dues."
                     }));

                     // Deactivate Key Card
                     var activeCard = await Task.Run(() => KeyCardRepository.GetActiveMemberCard(item.MemberId));
                     if (activeCard != null && activeCard.IsActive)
                     {
                         var currentUser = AuthStateProvider.GetCurrentUser();
                         await KeyCardLifecycleService.DeactivateCardAsync(
                             activeCard.KeyCardId, 
                             "Member Deactivated", 
                             "Dues > Set Inactive Action", 
                             currentUser?.Username ?? "Unknown",
                             CancellationToken.None);
                     }
                     _operationMessage = $"{item.FullName} marked as Inactive and key card deactivated.";
                     _operationError = false;
                 }
                 
                 await LoadDataInternal();
                 StateHasChanged();
             }
             catch (Exception ex)
             {
                 Logger.LogError(ex, "Error deactivating member");
                 _operationError = true;
                 _operationMessage = "Deactivation failed.";
             }
             finally
             {
                 _operationInProgress = false;
             }
        };
        _showConfirmModal = true;
    }
    
    // Edit Payment Methods
    private async Task OpenEditPaymentModal(DuesListItemDto item)
    {
        _editPaymentTarget = item;
        
        // Fetch the existing payment record
        var payment = await Task.Run(() => DuesRepository.GetDuesForMemberYear(item.MemberId, item.Year));
        if (payment == null)
        {
            _operationMessage = "Payment record not found.";
            _operationError = true;
            return;
        }
        
        _originalPaymentId = payment.DuesPaymentID;
        
        // Populate the form
        _editPaymentForm = new PaymentFormModel
        {
            Year = item.Year,
            Amount = payment.Amount,
            PaidDate = payment.PaidDate ?? DateTime.Today,
            PaymentType = payment.PaymentType ?? "CASH",
            Notes = payment.Notes ?? string.Empty
        };
        
        // Set date dropdowns
        if (payment.PaidDate.HasValue)
        {
            _editPaymentMonth = payment.PaidDate.Value.Month;
            _editPaymentDay = payment.PaidDate.Value.Day;
            _editPaymentYear = payment.PaidDate.Value.Year;
        }
        else
        {
            var today = DateTime.Today;
            _editPaymentMonth = today.Month;
            _editPaymentDay = today.Day;
            _editPaymentYear = today.Year;
        }
        
        _showEditPaymentModal = true;
    }
    
    private void UpdateEditPaymentDate()
    {
        if (_editPaymentMonth > 0 && _editPaymentDay > 0 && _editPaymentYear > 0)
        {
            try
            {
                _editPaymentForm.PaidDate = new DateTime(_editPaymentYear, _editPaymentMonth, _editPaymentDay);
            }
            catch
            {
                // Invalid date combination - keep current date
            }
        }
    }
    
    private void PromptEditPaymentConfirmation()
    {
        _confirmTitle = "Confirm Payment Edit";
        _confirmMessage = $"Are you sure you want to update the payment for {_editPaymentTarget?.FullName}?";
        _confirmSubMessage = $"Amount: {_editPaymentForm.Amount:C} | Date: {_editPaymentForm.PaidDate.ToString("MMM d, yyyy")} | Method: {_editPaymentForm.PaymentType}";
        _confirmActionText = "Update Payment";
        _confirmType = ConfirmActionModal.ConfirmType.Warning;
        _confirmIcon = "bi-pencil-square";
        _confirmAction = SubmitEditPayment;
        _showConfirmModal = true;
    }
    
    private async Task SubmitEditPayment()
    {
        _operationInProgress = true;
        try
        {
            // Update the payment record
            var payment = await Task.Run(() => DuesRepository.GetDuesForMemberYear(_editPaymentTarget.MemberId, _editPaymentTarget.Year));
            if (payment != null)
            {
                payment.Amount = _editPaymentForm.Amount;
                payment.PaidDate = _editPaymentForm.PaidDate;
                payment.PaymentType = _editPaymentForm.PaymentType;
                payment.Notes = _editPaymentForm.Notes;
                await Task.Run(() => DuesRepository.UpdateDuesRecord(payment));
            }
            
            // Log the change for audit
            var currentUser = AuthStateProvider.GetCurrentUser();
            await Task.Run(() => GlobalNoteRepository.InsertNote(new GlobalNote
            {
                NoteDate = DateTime.Now,
                Category = "PAYMENT EDIT",
                Text = $"Payment edited for {_editPaymentTarget?.FullName} (ID {_editPaymentTarget?.MemberId}) - Year: {_editPaymentForm.Year}, Amount: {_editPaymentForm.Amount:C}, Date: {_editPaymentForm.PaidDate.ToString("yyyy-MM-dd")}, Method: {_editPaymentForm.PaymentType} by {currentUser?.Username ?? "Unknown"}"
            }));
            
            _operationMessage = $"Payment for {_editPaymentTarget?.FullName} updated successfully.";
            _operationError = false;
            
            _showEditPaymentModal = false;
            await LoadDataInternal();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating payment");
            _operationMessage = "Failed to update payment.";
            _operationError = true;
        }
        finally
        {
            _operationInProgress = false;
        }
    }
    
    private void CloseEditPaymentModal()
    {
        _showEditPaymentModal = false;
        _editPaymentTarget = null;
        _editPaymentForm = new PaymentFormModel();
    }

    private bool IsExempt(DuesListItemDto item) =>
        item.Status == MemberStatus.Life || item.IsBoardMember || item.IsWaived;

    private bool IsPaid(DuesListItemDto item) => item.Satisfied;

    private bool CanWaive(DuesListItemDto item) =>
        (item.Status == MemberStatus.Regular || item.Status == MemberStatus.RegularNonPortuguese || item.Status == MemberStatus.Guest) &&
        !_operationInProgress;

    private bool CanRecordPayment(DuesListItemDto item) =>
        !item.Satisfied && !IsExempt(item) && !_operationInProgress;

    private bool CanSetInactive(DuesListItemDto item) =>
        !item.Satisfied && !IsExempt(item) && item.MonthsOverdue >= 15 && !_operationInProgress;

    private IEnumerable<DuesListItemDto> FilteredItems
    {
        get
        {
            var items = string.IsNullOrWhiteSpace(_searchText)
                ? _allItems
                : _allItems.Where(item => item.FullName.Contains(_searchText, StringComparison.OrdinalIgnoreCase));
            
            return _activeFilter switch
            {
                DuesFilter.Paid => items.Where(i => i.Satisfied),
                DuesFilter.Unpaid => items.Where(i => !i.Satisfied),
                DuesFilter.Waived => items.Where(i => IsExempt(i)),
                _ => items
            };
        }
    }

    private static string FormatOverdueText(int months) => $"{months} mo";
    
    private static string GetStatusBadge(MemberStatus status) => status switch {
        MemberStatus.Regular or MemberStatus.RegularNonPortuguese => "bg-success-subtle text-success",
        MemberStatus.Life => "bg-gold-subtle text-gold",
        MemberStatus.Guest => "bg-warning-subtle text-warning",
        MemberStatus.Inactive => "bg-danger-subtle text-danger",
        _ => "bg-light text-muted"
    };

    private static string GetStatusLabel(MemberStatus status) => status.ToString();
    
    private static string GetInitials(string name) {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0][0].ToString().ToUpper();
        return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
    }
    
    private static string GetAvatarClass(DuesListItemDto item) => item.Satisfied ? "bg-success text-white" : "bg-light text-muted";

    private void ViewSyncQueue() => NavManager.NavigateTo("/keycards/sync-queue");
    private async Task RetryAllSync()
    {
        try
        {
            await SyncQueueRepository.ResetPendingAsync();
            await LoadDataInternal();
            Logger.LogInformation("Sync queue reset from Dues page");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to retry all syncs");
        }
    }
    private void ClearDuesSearch() => _searchText = string.Empty;

    private sealed class PaymentFormModel
    {
        [Required(ErrorMessage = "Payment amount is required")]
        [Range(typeof(decimal), "0.01", "1000000", ErrorMessage = "Please enter a valid amount")]
        public decimal? Amount { get; set; }

        [Required]
        public DateTime PaidDate { get; set; } = DateTime.Today;

        [Required]
        public string PaymentType { get; set; } = PaymentMethods.First();

        public string? Notes { get; set; }

        [Required]
        public int Year { get; set; }

        public static PaymentFormModel CreateDefault() => new();
    }

    private sealed class WaiverFormModel
    {
        public int? WaiverId { get; set; }
        public int MemberId { get; set; }
        public string MemberName { get; set; } = string.Empty;
        public int StartYear { get; set; }
        public int EndYear { get; set; }
        [Required(ErrorMessage = "Reason is required")]
        public string Reason { get; set; } = string.Empty;
        public string? Notes { get; set; }
        public bool IsPermanent { get; set; }

        public static WaiverFormModel Create(DuesListItemDto item, int year)
        {
            return new WaiverFormModel
            {
                MemberId = item.MemberId,
                MemberName = item.FullName,
                StartYear = year,
                EndYear = year
            };
        }
    }
}

<style>
    :root {
        --glass-border: rgba(255, 255, 255, 0.1);
        --bg-surface: #ffffff;
        --text-primary: #1f2937;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Remove arrows/spinners from number inputs */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }
    
    .bg-purple-subtle { background-color: #f3e8ff; }
    .text-purple { color: #9333ea; }
    .bg-gold-subtle { background-color: #fef9c3; }
    .text-gold { color: #ca8a04; }

    .page-title-modern {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.025em;
    }

    .metric-card {
        background: var(--bg-surface);
        border-radius: 12px;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border: 1px solid #e5e7eb;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-shadow);
    }
    
    .metric-card.active {
        border-color: #3b82f6;
        background-color: #eff6ff;
    }
    
    .metric-card.highlight {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #f5f3ff, #ede9fe);
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .metric-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .status-banner {
        border-radius: 12px;
        padding: 1rem 1.25rem;
        position: relative;
        overflow: hidden;
    }
    
    .status-banner-neutral { background: #f3f4f6; border-left: 4px solid #9ca3af; }
    .status-banner-info { background: #e0f2fe; border-left: 4px solid #0ea5e9; }
    .status-banner-success-subtle { background: #dcfce7; border: 1px solid #86efac; }
    .status-banner-warning { background: #fef3c7; border-left: 4px solid #f59e0b; }
    .status-banner-danger { background: #fee2e2; border-left: 4px solid #ef4444; }

    .banner-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.25rem;
    }

    /* Compact Banner Styles */
    .status-banner-compact {
        padding: 0.625rem 1rem;
        border-radius: 8px;
    }

    .banner-icon-compact {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 1rem;
    }

    /* Fixed Height Table Container */
    .table-container-fixed {
        max-height: calc(100vh - 480px);
        overflow-y: auto;
        overflow-x: hidden;
    }

    .table-container-fixed::-webkit-scrollbar {
        width: 8px;
    }

    .table-container-fixed::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .table-container-fixed::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    .table-container-fixed::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .table-container-fixed thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #f8f9fa;
    }

    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .scanner-status {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: #10b981;
        background: #ecfdf5;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 500;
    }

    .pulse-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }
    
    @@keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    
    .spin-slow {
        animation: spin 3s linear infinite;
    }
    
    @@keyframes spin { 100% { transform: rotate(360deg); } }

    .modal-glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .icon-shape {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .form-control-modern {
        border-radius: 10px;
        padding: 0.625rem 1rem;
        border: 1px solid #e5e7eb;
        background-color: #f9fafb;
        transition: all 0.2s;
    }

    .form-control-modern:focus {
        background-color: #ffffff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .ls-1 { letter-spacing: 0.05em; }

    .x-small { font-size: 0.75rem; }

    .custom-radio .form-check-input {
        width: 1.25rem;
        height: 1.25rem;
        margin-top: 0.125rem;
        cursor: pointer;
    }

    .custom-radio .form-check-label {
        padding-left: 0.5rem;
        padding-top: 0.125rem;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-primary);
    }

    /* Modern Search Toolbar */
    .search-toolbar-modern {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: #ffffff;
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .search-container-modern {
        position: relative;
        flex: 1;
        max-width: 500px;
    }

    .search-icon-modern {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 1rem;
        pointer-events: none;
    }

    .search-input-modern {
        width: 100%;
        padding: 0.625rem 2.75rem 0.625rem 2.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.9375rem;
        background: #f9fafb;
        transition: all 0.2s ease;
        outline: none;
    }

    .search-input-modern:focus {
        background: #ffffff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .search-input-modern::placeholder {
        color: #9ca3af;
    }

    .search-clear-btn {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 1.125rem;
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease;
    }

    .search-clear-btn:hover {
        color: #ef4444;
    }

    .record-count-badge {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }

    .record-count-badge i {
        font-size: 0.875rem;
    }
</style>
