@page "/members/{MemberId:int}/dues"
@using Microsoft.AspNetCore.Authorization
@using GFC.Core.Interfaces
@using System.Globalization
@using CoreDuesPayment = GFC.Core.Models.DuesPayment
@using Member = GFC.Core.Models.Member
@attribute [Authorize]
@inject IMemberRepository MemberRepository
@inject IDuesRepository DuesRepository
@inject NavigationManager NavManager
@inject ILogger<MemberDuesHistory> Logger

<PageTitle>Dues History - GFC Membership</PageTitle>

<div class="page-header mb-4">
    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-outline-secondary" @onclick="GoBack" disabled="@_loading">
            <i class="bi bi-arrow-left"></i>
        </button>
        <div>
            <h1 class="page-title mb-0">Dues History</h1>
            @if (_loading)
            {
                <p class="text-muted mb-0">Loading member data...</p>
            }
            else if (_member != null)
            {
                <p class="text-muted mb-0">@GetFullName(_member) (ID: @_member.MemberID)</p>
            }
        </div>
    </div>
</div>

@if (_loading)
{
    <div class="d-flex align-items-center gap-2 text-muted">
        <div class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></div>
        <span>Loading dues history...</span>
    </div>
}
else if (_notFound)
{
    <div class="alert alert-warning">
        <strong>Member not found.</strong>
        <div class="text-muted small">Member ID @MemberId could not be loaded.</div>
        <button class="btn btn-outline-secondary mt-2" type="button" @onclick="GoBack">Back to Member Details</button>
    </div>
}
else if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
        <button class="btn btn-outline-secondary mt-2" type="button" @onclick="LoadDataAsync">Retry</button>
    </div>
}
else if (_member != null)
{
    <div class="row g-4">
        <!-- Summary Card -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-bar-chart-line me-2"></i>Summary
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="metric-box">
                                <div class="metric-label">Total Years</div>
                                <div class="metric-value">@_duesPayments.Count</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <div class="metric-label">Paid</div>
                                <div class="metric-value text-success">@_duesPayments.Count(d => d.PaidDate.HasValue)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <div class="metric-label">Waived</div>
                                <div class="metric-value text-info">@_duesPayments.Count(d => string.Equals(d.PaymentType, "WAIVED", StringComparison.OrdinalIgnoreCase))</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <div class="metric-label">Total Amount</div>
                                <div class="metric-value text-primary">@GetTotalAmount()</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dues History Table -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>Payment History
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (_duesPayments.Count == 0)
                    {
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox display-4 d-block mb-3"></i>
                            <p>No dues records found for this member.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Year</th>
                                        <th>Status</th>
                                        <th>Amount</th>
                                        <th>Payment Type</th>
                                        <th>Paid Date</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var payment in _duesPayments.OrderByDescending(d => d.Year))
                                    {
                                        var statusClass = GetStatusClass(payment);
                                        var statusLabel = GetStatusLabel(payment);
                                        
                                        <tr>
                                            <td>
                                                <strong>@payment.Year</strong>
                                                @if (payment.Year == DateTime.Today.Year)
                                                {
                                                    <span class="badge bg-primary ms-2">Current</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge @statusClass">@statusLabel</span>
                                            </td>
                                            <td>
                                                @if (payment.Amount.HasValue)
                                                {
                                                    <strong>@payment.Amount.Value.ToString("C", new CultureInfo("en-US"))</strong>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(payment.PaymentType))
                                                {
                                                    <span>@payment.PaymentType</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                            </td>
                                            <td>
                                                @if (payment.PaidDate.HasValue)
                                                {
                                                    <span>@payment.PaidDate.Value.ToString("MMM d, yyyy")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Not paid</span>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(payment.Notes))
                                                {
                                                    <div class="notes-cell">
                                                        @payment.Notes
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    .metric-box {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #212529;
    }

    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }

    .table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .notes-cell {
        max-width: 400px;
        word-wrap: break-word;
        white-space: normal;
        line-height: 1.5;
    }
</style>

@code {
    [Parameter] public int MemberId { get; set; }

    private Member? _member;
    private List<CoreDuesPayment> _duesPayments = new();
    private bool _loading = true;
    private bool _notFound = false;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        _errorMessage = null;
        _notFound = false;

        try
        {
            // Load member and dues in parallel
            var memberTask = Task.Run(() => MemberRepository.GetMemberById(MemberId));
            var duesTask = Task.Run(() => DuesRepository.GetDuesForMember(MemberId));

            await Task.WhenAll(memberTask, duesTask);

            _member = memberTask.Result;

            if (_member == null)
            {
                _notFound = true;
                return;
            }

            _duesPayments = duesTask.Result?.ToList() ?? new List<CoreDuesPayment>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dues history for member {MemberId}", MemberId);
            _errorMessage = "Failed to load dues history. Please try again.";
        }
        finally
        {
            _loading = false;
        }
    }

    private static string GetFullName(Member member)
    {
        var first = member.FirstName?.Trim() ?? string.Empty;
        var last = member.LastName?.Trim() ?? string.Empty;
        var suffix = member.Suffix?.Trim();
        var name = string.IsNullOrWhiteSpace(last) ? first : $"{first} {last}";
        return string.IsNullOrWhiteSpace(suffix) ? name : $"{name} {suffix}";
    }

    private string GetTotalAmount()
    {
        var total = _duesPayments
            .Where(d => d.Amount.HasValue && d.PaidDate.HasValue)
            .Sum(d => d.Amount!.Value);
        
        return total.ToString("C", new CultureInfo("en-US"));
    }

    private static string GetStatusClass(CoreDuesPayment payment)
    {
        if (string.Equals(payment.PaymentType, "WAIVED", StringComparison.OrdinalIgnoreCase))
        {
            return "bg-info";
        }

        if (payment.PaidDate.HasValue)
        {
            return "bg-success";
        }

        // Check if overdue (current year and not paid)
        if (payment.Year == DateTime.Today.Year)
        {
            return "bg-warning";
        }

        // Past year and not paid
        if (payment.Year < DateTime.Today.Year)
        {
            return "bg-danger";
        }

        return "bg-secondary";
    }

    private static string GetStatusLabel(CoreDuesPayment payment)
    {
        if (string.Equals(payment.PaymentType, "WAIVED", StringComparison.OrdinalIgnoreCase))
        {
            return "Waived";
        }

        if (payment.PaidDate.HasValue)
        {
            return "Paid";
        }

        // Check if overdue
        if (payment.Year < DateTime.Today.Year)
        {
            return "Overdue";
        }

        if (payment.Year == DateTime.Today.Year)
        {
            return "Pending";
        }

        return "Unpaid";
    }

    private void GoBack()
    {
        NavManager.NavigateTo($"/members/{MemberId}");
    }
}
