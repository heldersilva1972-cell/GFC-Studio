@page "/my-devices"
@using GFC.BlazorServer.Services.Vpn
@using GFC.Core.Models
@using GFC.BlazorServer.Auth
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = AppRoles.Admin + "," + AppRoles.Director)]
@inject IVpnConfigurationService VpnService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ILogger<DeviceSetup> Logger
@inject GFC.Core.Interfaces.IUserRepository UserRepository

<div class="device-setup-container">
    <div class="page-header">
        <div class="header-content">
            <i class="bi bi-shield-lock-fill header-icon"></i>
            <div>
                <h1>Secure Access & Devices</h1>
                <p class="subtitle">
                    @if (_isAdmin)
                    {
                        <span>Administrator View - Manage all system access</span>
                    }
                    else if (_profiles.Count > 0)
                    {
                        <span>Manage your connected devices and access settings</span>
                    }
                    else
                    {
                        <span>Setup required for access</span>
                    }
                </p>
            </div>
        </div>
        
        @* Access State Indicator *@
        <div class="access-state-badge">
            @if (_isAdmin)
            {
                <span class="badge badge-admin">
                    <i class="bi bi-shield-fill-check me-1"></i>
                    Administrator
                </span>
            }
            else if (_profiles.Count > 0)
            {
                <span class="badge badge-active">
                    <i class="bi bi-check-circle-fill me-1"></i>
                    Active Access (@_profiles.Count @(_profiles.Count == 1 ? "Device" : "Devices"))
                </span>
            }
            else
            {
                <span class="badge badge-pending">
                    <i class="bi bi-hourglass-split me-1"></i>
                    Not Connected
                </span>
            }
        </div>
    </div>
    
    @* Admin-Only Actions *@
    @if (_isAdmin)
    {
        <div class="admin-actions-bar">
            <h3><i class="bi bi-tools me-2"></i>Admin Tools</h3>
            <div class="admin-buttons">
                <button class="btn btn-primary" @onclick="ShowGenerateInviteModal">
                    <i class="bi bi-envelope-plus me-2"></i>
                    Generate Invite Link
                </button>
                <button class="btn btn-outline-secondary" @onclick="NavigateToAuditLog">
                    <i class="bi bi-list-check me-2"></i>
                    View Audit Log
                </button>
                <button class="btn btn-outline-secondary" @onclick="NavigateToVpnManagement">
                    <i class="bi bi-diagram-3 me-2"></i>
                    Network Management
                </button>
            </div>
        </div>
    }

    @if (_loading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading your settings...</p>
        </div>
    }
    else
    {
        @* PWA Install Prompt - Show after successful setup *@
        @if (_profiles.Count > 0 && !_pwaInstallDismissed)
        {
            <PwaInstallPrompt 
                Title="Quick Access to GFC"
                Description="Install the app for instant access from your home screen"
                ButtonText="Install App"
                ShowDismiss="true"
                OnInstalled="HandlePwaInstalled"
                OnDismissed="HandlePwaDismissed" />
        }
        
        <div class="profiles-grid">
            @if (_profiles.Count == 0)
            {
                <div class="empty-state">
                    <i class="bi bi-shield-lock-fill"></i>
                    <h3>No Devices Connected</h3>
                    <p class="primary-message">This page is for managing devices after setup is complete.</p>
                    
                    <div class="access-info-card">
                        <div class="info-section">
                            <i class="bi bi-info-circle-fill text-primary"></i>
                            <div>
                                <h4>How to Get Access</h4>
                                <p>To get access for the first time, your administrator must send you a secure setup link.</p>
                                <p class="mb-0"><strong>Need access?</strong> Click the button below to email your administrator.</p>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <i class="bi bi-gear-fill text-secondary"></i>
                            <div>
                                <h4>About This Page</h4>
                                <p class="mb-2">Once you are set up, use this page to:</p>
                                <ul class="feature-list">
                                    <li>View your connected devices</li>
                                    <li>Re-install access if you switch devices</li>
                                    <li>Remove lost or stolen devices</li>
                                    <li>Fix connection problems</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-actions">
                        <a href="mailto:admin@gfc.local?subject=Requesting%20GFC%20Secure%20Access" class="btn btn-primary">
                            <i class="bi bi-envelope-fill me-2"></i>
                            Contact Administrator
                        </a>
                    </div>
                </div>
            }
            else
            {
                @foreach (var profile in _profiles)
                {
                    <div class="device-card">
                        <div class="card-status @(profile.LastUsedAt.HasValue && (DateTime.UtcNow - profile.LastUsedAt.Value).TotalDays < 1 ? "status-online" : "status-offline")">
                            @(profile.LastUsedAt.HasValue && (DateTime.UtcNow - profile.LastUsedAt.Value).TotalDays < 1 ? "Connected recently" : "Inactive")
                        </div>
                        <div class="card-header">
                            <div class="device-type-icon">
                                @if (profile.DeviceType?.Contains("iOS") == true || profile.DeviceType?.Contains("Apple") == true)
                                {
                                    <i class="bi bi-apple"></i>
                                }
                                else if (profile.DeviceType?.Contains("Windows") == true)
                                {
                                    <i class="bi bi-windows"></i>
                                }
                                else if (profile.DeviceType?.Contains("Android") == true)
                                {
                                    <i class="bi bi-phone"></i>
                                }
                                else
                                {
                                    <i class="bi bi-pc-display"></i>
                                }
                            </div>
                            <div class="device-info">
                                <h3>@profile.DeviceName</h3>
                                <span class="assigned-ip">@profile.AssignedIP</span>
                            </div>
                        </div>

                        <div class="card-body">
                            <div class="info-row">
                                <span class="label">Device ID</span>
                                <span class="value code">@TruncateKey(profile.PublicKey)</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Added</span>
                                <span class="value">@profile.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Last Seen</span>
                                <span class="value">@(profile.LastUsedAt?.ToLocalTime().ToString("g") ?? "Never")</span>
                            </div>
                        </div>

                        <div class="card-actions">
                            <div class="dropdown-group">
                                <button class="btn btn-download" @onclick="() => DownloadConfig(profile)">
                                    <i class="bi bi-download"></i> Download Settings
                                </button>
                                <div class="action-menu">
                                    <button class="btn btn-icon" title="Fix Connection (Rotate Keys)" @onclick="() => ConfirmRotateKeys(profile)">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                    <button class="btn btn-icon btn-danger" title="Remove Device" @onclick="() => ConfirmRevoke(profile)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                
                @* Phase 2: Device Management Help *@
                <div class="management-help-card">
                    <h4><i class="bi bi-question-circle-fill me-2"></i>Need Help?</h4>
                    <div class="help-grid">
                        <div class="help-item">
                            <strong>Adding Devices</strong>
                            <p>Ask your administrator for a new setup link to add another device.</p>
                        </div>
                        <div class="help-item">
                            <strong>Lost or Stolen Device?</strong>
                            <p>Use the trash icon on the device card to remove access immediately.</p>
                        </div>
                        <div class="help-item">
                            <strong>Connection Problems</strong>
                            <p>Try the Fix Connection button (arrows icon) or re-install the app.</p>
                        </div>
                    </div>
                </div>

                @* Artifacts Section - Restricted Access *@
                @if (_profiles.Count > 0 || _isAdmin)
                {
                    <div class="artifacts-section mt-4">
                        <h4 class="mb-3"><i class="bi bi-box-seam me-2"></i>Tools & Downloads</h4>
                        <div class="tools-grid">
                            @* Platform Installers - Only for users with existing devices *@
                            @if (_profiles.Count > 0)
                            {
                                <button class="tool-btn" @onclick="DownloadWindowsInstaller">
                                    <i class="bi bi-windows"></i>
                                    <div>
                                        <strong>Windows Installer</strong>
                                        <div class="small">Reinstall app</div>
                                    </div>
                                </button>
                                <button class="tool-btn" @onclick="DownloadAppleProfile">
                                    <i class="bi bi-apple"></i>
                                    <div>
                                        <strong>Apple Profile</strong>
                                        <div class="small">Re-download profile</div>
                                    </div>
                                </button>
                            }
                            
                            @* Root CA - Admin Only *@
                            @if (_isAdmin)
                            {
                                <a href="/api/onboarding/ca-cert" class="tool-btn admin-tool" target="_blank">
                                    <i class="bi bi-shield-lock-fill"></i>
                                    <div>
                                        <strong>Root Certificate</strong>
                                        <div class="small">Admin Download</div>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    }
    
    @* Admin-Only: Generate Invite Modal *@
    @if (_isAdmin)
    {
        <GenerateInviteModal 
            Show="_showInviteModal" 
            ShowChanged="HandleInviteModalClosed"
            AvailableUsers="_availableUsers"
            OnLinkGenerated="HandleLinkGenerated" />
    }
</div>

<style>
    .device-setup-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem;
    }

    .page-header {
        margin-bottom: 2.5rem;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        padding: 2rem;
        border-radius: 1rem;
        color: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        position: relative;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .header-icon {
        font-size: 3rem;
        opacity: 0.9;
    }

    .page-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
    }

    .subtitle {
        margin: 0.5rem 0 0 0;
        opacity: 0.8;
    }

    /* Access State Badge */
    .access-state-badge {
        position: absolute;
        top: 2rem;
        right: 2rem;
    }

    .access-state-badge .badge {
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .badge-admin {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #78350f;
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
    }

    .badge-active {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        color: #064e3b;
        box-shadow: 0 4px 12px rgba(52, 211, 153, 0.4);
    }

    .badge-pending {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        color: #1e293b;
        box-shadow: 0 4px 12px rgba(148, 163, 184, 0.4);
    }

    /* Admin Actions Bar */
    .admin-actions-bar {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #fbbf24;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .admin-actions-bar h3 {
        margin: 0 0 1rem 0;
        font-size: 1.2rem;
        color: #78350f;
        display: flex;
        align-items: center;
    }

    .admin-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .admin-buttons .btn {
        font-weight: 600;
    }

    .admin-buttons .btn-primary {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border: none;
        color: #78350f;
    }

    .admin-buttons .btn-primary:hover {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
    }

    .admin-buttons .btn-outline-secondary {
        border-color: #f59e0b;
        color: #78350f;
    }

    .admin-buttons .btn-outline-secondary:hover {
        background: #f59e0b;
        color: white;
        border-color: #f59e0b;
    }

    /* Grid & Cards */
    .profiles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .device-card {
        background: var(--card-bg, #fff);
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: 1rem;
        padding: 1.5rem;
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
    }

    .device-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }

    .card-status {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: 1rem;
    }

    .status-online {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-offline {
        background: #F3F4F6;
        color: #6B7280;
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-top: 0.5rem;
    }

    .device-type-icon {
        width: 48px;
        height: 48px;
        background: var(--gray-100);
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--primary);
    }

    .device-info h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .assigned-ip {
        font-family: var(--font-mono);
        color: var(--primary);
        font-size: 0.85rem;
        font-weight: 600;
    }

    .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
    }

    .label {
        color: var(--gray-500);
    }

    .value {
        font-weight: 500;
        color: var(--gray-800);
    }

    .value.code {
        font-family: var(--font-mono);
        font-size: 0.75rem;
    }

    .card-actions {
        border-top: 1px solid var(--gray-100);
        padding-top: 1rem;
    }

    .dropdown-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.6rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        border: none;
        transition: background 0.2s;
    }

    .btn-download {
        background: var(--primary);
        color: white;
        flex: 1;
    }

    .btn-download:hover {
        background: var(--primary-dark);
    }

    .btn-icon {
        background: var(--gray-100);
        color: var(--gray-700);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .btn-icon:hover {
        background: var(--gray-200);
    }

    .btn-danger:hover {
        background: #FEE2E2;
        color: var(--error);
    }

    .action-menu {
        display: flex;
        gap: 0.5rem;
    }

    /* Empty State - Enhanced for Two-Phase Model */
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem 2rem;
        max-width: 800px;
        margin: 0 auto;
    }

    .empty-state i.bi-shield-lock-fill {
        font-size: 4rem;
        margin-bottom: 1rem;
        display: block;
        color: var(--primary);
        opacity: 0.3;
    }

    .empty-state h3 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .primary-message {
        font-size: 1.1rem;
        color: var(--gray-600);
        margin-bottom: 2rem;
    }

    .access-info-card {
        background: var(--card-bg, #fff);
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: 1rem;
        padding: 2rem;
        margin: 2rem 0;
        text-align: left;
    }

    .info-section {
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
        margin-bottom: 2rem;
    }

    .info-section:last-child {
        margin-bottom: 0;
    }

    .info-section i {
        font-size: 2rem;
        flex-shrink: 0;
        margin-top: 0.25rem;
    }

    .info-section h4 {
        margin: 0 0 0.75rem 0;
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .info-section p {
        margin: 0 0 0.5rem 0;
        color: var(--gray-600);
        line-height: 1.6;
    }

    .feature-list {
        margin: 0;
        padding-left: 1.5rem;
        color: var(--gray-600);
    }

    .feature-list li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    .help-actions {
        margin-top: 2rem;
    }

    .help-actions .btn {
        padding: 0.75rem 2rem;
        font-size: 1rem;
        font-weight: 600;
    }

    /* Management Help Card */
    .management-help-card {
        grid-column: 1 / -1;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 1rem;
        padding: 2rem;
        margin-top: 2rem;
    }

    .management-help-card h4 {
        margin: 0 0 1.5rem 0;
        font-size: 1.2rem;
        color: var(--text-primary);
    }

    .help-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .help-item {
        background: white;
        padding: 1.25rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .help-item strong {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .help-item p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--gray-600);
        line-height: 1.5;
    }

    /* Artifacts Section */
    .artifacts-section {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }

    .tool-btn {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 1rem;
        border-radius: 0.5rem;
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.2s;
        cursor: pointer;
        width: 100%;
        text-align: left;
    }

    .tool-btn:hover {
        background: #f1f5f9;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .tool-btn i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .tool-btn.admin-tool {
        border-color: #fbbf24;
        background: #fffbeb;
    }
    
    .tool-btn.admin-tool i {
        color: #d97706;
    }
    
    .tool-btn.admin-tool:hover {
        background: #fef3c7;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--gray-200);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

@code {
    // Access State Properties
    private List<VpnProfile> _profiles = new();
    private bool _loading = true;
    private int _currentUserId;
    private bool _isAdmin = false;
    
    // Computed Access State
    private AccessState CurrentState => _isAdmin ? AccessState.Admin : 
                                        _profiles.Count > 0 ? AccessState.HasDevices : 
                                        AccessState.NoDevices;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfiles();
        await CheckAdminStatus();
        
        if (_isAdmin)
        {
            await LoadAvailableUsers();
        }
    }

    private async Task LoadProfiles()
    {
        _loading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var uidClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (uidClaim != null && int.TryParse(uidClaim.Value, out int uid))
            {
                _currentUserId = uid;
                _profiles = await VpnService.GetUserProfilesAsync(uid);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading VPN profiles");
        }
        finally
        {
            _loading = false;
        }
    }

    private string TruncateKey(string key)
    {
        if (string.IsNullOrEmpty(key) || key.Length <= 12) return key;
        return key.Substring(0, 8) + "..." + key.Substring(key.Length - 4);
    }

    private async Task DownloadConfig(VpnProfile profile)
    {
        try
        {
            var configContent = await VpnService.GenerateConfigForUserAsync(_currentUserId, profile.DeviceName, profile.DeviceType);
            var bytes = System.Text.Encoding.UTF8.GetBytes(configContent);
            var base64 = Convert.ToBase64String(bytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", "gfc-access.conf", "text/plain", base64);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error downloading config");
            await JSRuntime.InvokeVoidAsync("alert", "Failed to download configuration.");
        }
    }

    private async Task ConfirmRotateKeys(VpnProfile profile)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to rotate keys for '{profile.DeviceName}'? This will invalidate your current WireGuard connection on that device until you update it with the new config.");
        
        if (confirmed)
        {
            try
            {
                await VpnService.RotateKeysAsync(profile.Id);
                await LoadProfiles();
                StateHasChanged();
                await JSRuntime.InvokeVoidAsync("alert", "Keys rotated successfully. Please download the new config and update your device.");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error rotating keys");
                await JSRuntime.InvokeVoidAsync("alert", "Failed to rotate keys.");
            }
        }
    }

    private async Task ConfirmRevoke(VpnProfile profile)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Permanently revoke access for '{profile.DeviceName}'? You will lose secure access from this device immediately.");
        
        if (confirmed)
        {
            try
            {
                await VpnService.RevokeProfileAsync(profile.Id, _currentUserId, "Userself-revoked via portal");
                await LoadProfiles();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error revoking profile");
                await JSRuntime.InvokeVoidAsync("alert", "Failed to revoke profile.");
            }
        }
    }
    
    // PWA Install Handlers
    private bool _pwaInstallDismissed = false;
    
    private void HandlePwaInstalled()
    {
        Logger.LogInformation("User installed PWA from Device Setup page");
        _pwaInstallDismissed = true;
    }
    
    private void HandlePwaDismissed()
    {
        Logger.LogInformation("User dismissed PWA install prompt");
        _pwaInstallDismissed = true;
    }
    
    // Access State Management
    private async Task CheckAdminStatus()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _isAdmin = authState.User.IsInRole(AppRoles.Admin);
            Logger.LogInformation($"User admin status: {_isAdmin}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking admin status");
            _isAdmin = false;
        }
    }
    
    // Admin-Only Methods
    private bool _showInviteModal = false;
    private List<GenerateInviteModal.UserInfo> _availableUsers = new();
    
    private void ShowGenerateInviteModal()
    {
        if (!_isAdmin)
        {
            Logger.LogWarning("Non-admin user attempted to access Generate Invite");
            return;
        }
        
        _showInviteModal = true;
        StateHasChanged();
    }
    
    private async Task LoadAvailableUsers()
    {
        try
        {
            // Get all users who are Directors (potential invite recipients)
            var allUsers = UserRepository.GetAllUsers();
            _availableUsers = allUsers
                .Where(u => u.IsActive && !u.IsAdmin) // Only active, non-admin users
                .Select(u => new GenerateInviteModal.UserInfo
                {
                    Id = u.UserId,
                    Username = u.Username,
                    Email = u.Email
                })
                .OrderBy(u => u.Username)
                .ToList();
                
            Logger.LogInformation($"Loaded {_availableUsers.Count} available users for invite generation");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading available users");
            _availableUsers = new();
        }
    }
    
    private void HandleInviteModalClosed(bool show)
    {
        _showInviteModal = show;
        StateHasChanged();
    }
    
    private void HandleLinkGenerated(GenerateInviteModal.InviteLinkGenerated linkInfo)
    {
        Logger.LogInformation(
            "Invite link generated: User={UserId}, Email={Email}, Expires={ExpiresAt}",
            linkInfo.UserId, linkInfo.UserEmail, linkInfo.ExpiresAt
        );
        
        // Could add additional logic here:
        // - Send email notification
        // - Update user record
        // - Track invite in database
    }
    
    private void NavigateToAuditLog()
    {
        if (!_isAdmin)
        {
            Logger.LogWarning("Non-admin user attempted to access Audit Log");
            return;
        }
        
        Navigation.NavigateTo("/admin/audit-log");
    }
    
    private void NavigateToVpnManagement()
    {
        if (!_isAdmin)
        {
            Logger.LogWarning("Non-admin user attempted to access VPN Management");
            return;
        }
        
        
        Navigation.NavigateTo("/admin/vpn");
    }

    // Artifact Download Helpers
    private async Task DownloadWindowsInstaller()
    {
        try
        {
            // Generate short-lived token (1 hour) for re-installation
            // GUARDRAIL: Use Reinstall method which enforces checks
            var token = await VpnService.CreateReinstallTokenAsync(_currentUserId, 1);
            Navigation.NavigateTo($"/api/onboarding/windows-setup?token={token}", true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generating token for Windows installer");
            await JSRuntime.InvokeVoidAsync("alert", "Failed to generate download link. Please contact support.");
        }
    }

    private async Task DownloadAppleProfile()
    {
        try
        {
            // Generate short-lived token (1 hour) for re-installation
            // GUARDRAIL: Use Reinstall method which enforces checks
            var token = await VpnService.CreateReinstallTokenAsync(_currentUserId, 1);
            Navigation.NavigateTo($"/api/onboarding/apple-profile?token={token}", true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generating token for Apple profile");
            await JSRuntime.InvokeVoidAsync("alert", "Failed to generate download link. Please contact support.");
        }
    }

    // Access State Enum
    public enum AccessState
    {
        NoDevices,   // State 1: First-time user, no devices
        HasDevices,  // State 2: Managed user, has devices
        Admin        // State 3: Administrator
    }
}
