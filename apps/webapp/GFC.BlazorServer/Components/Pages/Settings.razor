@page "/settings"

<div class="gfc-modified-tag">
    <span class="gfc-tag-label">MODIFIED</span>
    <strong>Settings Page Update:</strong> Removed the "Controller Settings" section, which included the toggle for Simulation Mode vs. Real Controller Mode. The system now exclusively uses real hardware controllers.
</div>

@using GFC.Core.Services
@using GFC.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@using System.IO
@using GFC.BlazorServer.Models
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@inject BackupConfigService BackupConfigService
@inject IDatabaseBackupService DatabaseBackupService
@inject ISystemSettingsService SystemSettingsService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject ILogger<Settings> Logger
@inject IJSRuntime JSRuntime

<PageTitle>Settings - GFC Membership System</PageTitle>

<div class="settings-page">
    <h1 class="page-title">Settings</h1>

    <div class="settings-container">
        <div class="settings-section">
            <div class="settings-section__header">
                <h2>
                    <i class="bi bi-database"></i>
                    Database Backup Configuration
                </h2>
                <p class="settings-section__description">
                    Configure automatic database backups, including location, frequency, and retention policy.
                </p>
            </div>

            <div class="settings-section__body">
                @if (_showSuccessMessage)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle"></i>
                        Settings saved successfully!
                        <button type="button" class="btn-close" @onclick="() => _showSuccessMessage = false"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-circle"></i>
                        @_errorMessage
                        <button type="button" class="btn-close" @onclick="() => _errorMessage = string.Empty"></button>
                    </div>
                }

                <EditForm Model="_backupConfig" OnValidSubmit="SaveBackupSettings">
                    <DataAnnotationsValidator />

                    <div class="form-grid two-column">
                        <div class="form-field full-width-field">
                            <label class="form-label" for="backup-folder">
                                Backup Folder Path <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <InputText id="backup-folder" 
                                           class="form-control" 
                                           @bind-Value="_backupConfig.BackupFolder" 
                                           placeholder="C:\GFC_Backups\ClubMembership" />
                                <button type="button" 
                                        class="btn btn-outline-secondary" 
                                        @onclick="SelectBackupFolder"
                                        disabled="@_selectingFolder"
                                        title="Browse for folder">
                                    <i class="bi bi-folder"></i>
                                    @if (_selectingFolder)
                                    {
                                        <span>Selecting...</span>
                                    }
                                    else
                                    {
                                        <span>Browse</span>
                                    }
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                <strong>Important:</strong> Enter the full server path (e.g., C:\GFC_Backups\ClubMembership). 
                                The folder will be created automatically on the server when you save settings. 
                                Note: Browser folder picker may only provide folder names - you may need to complete the full server path manually.
                            </small>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="backup-time">
                                Daily Backup Time <span class="text-danger">*</span>
                            </label>
                            <InputSelect id="backup-time" 
                                         class="form-select" 
                                         @bind-Value="_selectedBackupHour">
                                @for (int hour = 0; hour < 24; hour++)
                                {
                                    var displayTime = hour == 0 ? "12:00 AM" : hour < 12 ? $"{hour}:00 AM" : hour == 12 ? "12:00 PM" : $"{hour - 12}:00 PM";
                                    <option value="@hour">@displayTime</option>
                                }
                            </InputSelect>
                            <small class="form-text text-muted">
                                Hour of day when automatic backups should run.
                            </small>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="retention-days">
                                Retention Days <span class="text-danger">*</span>
                            </label>
                            <InputSelect id="retention-days" 
                                         class="form-select" 
                                         @bind-Value="_selectedRetentionDays">
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                                <option value="30">30 days</option>
                                <option value="60">60 days</option>
                            </InputSelect>
                            <small class="form-text text-muted">
                                Number of days to keep backup files. Older backups will be automatically deleted.
                            </small>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="server-instance">
                                SQL Server Instance
                            </label>
                            <InputText id="server-instance" 
                                       class="form-control" 
                                       @bind-Value="_backupConfig.ServerInstance" 
                                       placeholder="localhost" />
                            <small class="form-text text-muted">
                                SQL Server instance name or server address.
                            </small>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="database-name">
                                Database Name
                            </label>
                            <InputText id="database-name" 
                                       class="form-control" 
                                       @bind-Value="_backupConfig.DatabaseName" 
                                       placeholder="ClubMembership" />
                            <small class="form-text text-muted">
                                Name of the database to backup.
                            </small>
                        </div>
                    </div>

                    @if (_backupConfig.LastBackupTime.HasValue)
                    {
                        <div class="backup-status-info">
                            <div class="backup-status-info__item">
                                <span class="backup-status-info__label">Last Backup:</span>
                                <span class="backup-status-info__value">@_backupConfig.LastBackupTime.Value.ToString("MMM d, yyyy h:mm tt")</span>
                            </div>
                        </div>
                    }

                    <div class="settings-actions">
                        <button type="submit" 
                                class="btn btn-primary" 
                                disabled="@_saving">
                            <i class="bi bi-save"></i>
                            @if (_saving)
                            {
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save Backup Settings</span>
                            }
                        </button>
                        <button type="button" 
                                class="btn btn-outline" 
                                @onclick="ResetToDefaults"
                                disabled="@_saving">
                            <i class="bi bi-arrow-counterclockwise"></i>
                            Reset to Defaults
                        </button>
                        <button type="button" 
                                class="btn btn-success" 
                                @onclick="RunBackupNow"
                                disabled="@(_saving || _runningBackup)">
                            <i class="bi bi-database-check"></i>
                            @if (_runningBackup)
                            {
                                <span>Running Backup...</span>
                            }
                            else
                            {
                                <span>Run Backup Now</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>

        <!-- [NEW] NVR/Camera Credentials Section -->
        <div class="settings-section">
            <div class="settings-section__header">
                <h2>
                    <i class="bi bi-camera-video"></i>
                    NVR / Camera Credentials
                </h2>
                <p class="settings-section__description">
                    Configure default credentials for camera auto-discovery. These credentials will be used to connect to all discovered cameras.
                </p>
            </div>

            <div class="settings-section__body">
                @if (_showNvrSuccessMessage)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle"></i>
                        NVR credentials saved successfully!
                        <button type="button" class="btn-close" @onclick="() => _showNvrSuccessMessage = false"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(_nvrErrorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-circle"></i>
                        @_nvrErrorMessage
                        <button type="button" class="btn-close" @onclick="() => _nvrErrorMessage = string.Empty"></button>
                    </div>
                }

                <EditForm Model="_nvrConfig" OnValidSubmit="SaveNvrCredentials">
                    <DataAnnotationsValidator />

                    <div class="form-grid two-column">
                        <div class="form-field">
                            <label class="form-label" for="nvr-ip">
                                NVR IP Address <span class="text-danger">*</span>
                            </label>
                            <InputText id="nvr-ip" 
                                       class="form-control" 
                                       @bind-Value="_nvrConfig.NvrIpAddress" 
                                       placeholder="192.168.1.64" />
                            <small class="form-text text-muted">
                                IP address of your NVR (Network Video Recorder)
                            </small>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="nvr-port">
                                NVR Port
                            </label>
                            <InputText id="nvr-port" 
                                       class="form-control" 
                                       @bind-Value="_nvrPortText" 
                                       placeholder="80" />
                            <small class="form-text text-muted">
                                HTTP port (default: 80)
                            </small>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="nvr-username">
                                Username <span class="text-danger">*</span>
                            </label>
                            <InputText id="nvr-username" 
                                       class="form-control" 
                                       @bind-Value="_nvrConfig.Username" 
                                       placeholder="admin" />
                            <small class="form-text text-muted">
                                NVR/Camera username (usually 'admin')
                            </small>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="nvr-password">
                                Password <span class="text-danger">*</span>
                            </label>
                            <InputText id="nvr-password" 
                                       type="password"
                                       class="form-control" 
                                       @bind-Value="_nvrConfig.Password" 
                                       placeholder="••••••••" />
                            <small class="form-text text-muted">
                                NVR/Camera password
                            </small>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> These credentials will be used automatically when discovering cameras on your network. 
                        All discovered cameras will use these credentials unless you specify different ones.
                    </div>

                    <div class="settings-actions">
                        <button type="submit" 
                                class="btn btn-primary" 
                                disabled="@_savingNvrConfig">
                            <i class="bi bi-save"></i>
                            @if (_savingNvrConfig)
                            {
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save NVR Credentials</span>
                            }
                        </button>
                        <a href="/cameras/discover" class="btn btn-success">
                            <i class="bi bi-radar"></i>
                            Discover Cameras
                        </a>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private BackupConfig _backupConfig = new();
    private int _selectedBackupHour = 2; // Default to 2 AM
    private int _selectedRetentionDays = 30; // Default to 30 days
    private bool _saving = false;
    private bool _selectingFolder = false;
    private bool _runningBackup = false;
    private bool _showSuccessMessage = false;
    private string _errorMessage = string.Empty;

    // [NEW] NVR Credentials fields
    private NvrConfig _nvrConfig = new();
    private string _nvrPortText = "80"; // Port as string for proper binding
    private bool _savingNvrConfig = false;
    private bool _showNvrSuccessMessage = false;
    private string _nvrErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        LoadBackupSettings();
        LoadNvrSettings();
        await Task.CompletedTask; // Suppress async warning
    }

    private void LoadNvrSettings()
    {
        try
        {
            // Load from database
            var config = SystemSettingsService.GetSettings();
            _nvrConfig = new NvrConfig
            {
                NvrIpAddress = config?.NvrIpAddress ?? "192.168.1.64",
                NvrPort = config?.NvrPort ?? 80,
                Username = config?.NvrUsername ?? "admin",
                Password = "" // Never load password for security
            };
            _nvrPortText = _nvrConfig.NvrPort.ToString();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading NVR settings");
            _nvrConfig = new NvrConfig();
            _nvrPortText = "80";
        }
    }


    private async Task SaveNvrCredentials()
    {
        _savingNvrConfig = true;
        _nvrErrorMessage = string.Empty;
        _showNvrSuccessMessage = false;

        try
        {
            // Parse port from text field
            if (!int.TryParse(_nvrPortText, out int port) || port < 1 || port > 65535)
            {
                _nvrErrorMessage = "Invalid port number. Please enter a number between 1 and 65535.";
                _savingNvrConfig = false;
                return;
            }
            _nvrConfig.NvrPort = port;

            // Save to database first
            await SystemSettingsService.UpdateNvrCredentialsAsync(
                _nvrConfig.NvrIpAddress,
                _nvrConfig.NvrPort,
                _nvrConfig.Username,
                _nvrConfig.Password
            );

            // Path to Video Agent appsettings.json
            var videoAgentPath = Path.Combine(Directory.GetCurrentDirectory(), "..", "..", "services", "GFC.VideoAgent", "appsettings.json");
            
            if (!File.Exists(videoAgentPath))
            {
                _nvrErrorMessage = $"Video Agent config file not found at: {videoAgentPath}";
                _savingNvrConfig = false;
                return;
            }

            // Read the existing config
            var jsonText = await File.ReadAllTextAsync(videoAgentPath);
            var config = System.Text.Json.JsonDocument.Parse(jsonText);
            
            // Create updated config
            using var stream = new MemoryStream();
            using (var writer = new System.Text.Json.Utf8JsonWriter(stream, new System.Text.Json.JsonWriterOptions { Indented = true }))
            {
                writer.WriteStartObject();
                
                // Copy VideoAgent section
                if (config.RootElement.TryGetProperty("VideoAgent", out var videoAgent))
                {
                    writer.WritePropertyName("VideoAgent");
                    videoAgent.WriteTo(writer);
                }
                
                // Write updated NvrSettings
                writer.WritePropertyName("NvrSettings");
                writer.WriteStartObject();
                writer.WriteString("IpAddress", _nvrConfig.NvrIpAddress);
                writer.WriteNumber("RtspPort", 554); // RTSP port is always 554
                writer.WriteString("Username", _nvrConfig.Username);
                writer.WriteString("Password", _nvrConfig.Password);
                
                // Copy existing Cameras array if it exists
                if (config.RootElement.TryGetProperty("NvrSettings", out var nvrSettings) && 
                    nvrSettings.TryGetProperty("Cameras", out var cameras))
                {
                    writer.WritePropertyName("Cameras");
                    cameras.WriteTo(writer);
                }
                else
                {
                    writer.WritePropertyName("Cameras");
                    writer.WriteStartArray();
                    writer.WriteEndArray();
                }
                
                writer.WriteEndObject(); // End NvrSettings
                
                // Copy Logging section
                if (config.RootElement.TryGetProperty("Logging", out var logging))
                {
                    writer.WritePropertyName("Logging");
                    logging.WriteTo(writer);
                }
                
                writer.WriteEndObject(); // End root
            }
            
            // Write back to file
            var updatedJson = System.Text.Encoding.UTF8.GetString(stream.ToArray());
            await File.WriteAllTextAsync(videoAgentPath, updatedJson);
            
            _showNvrSuccessMessage = true;
            Logger.LogInformation("NVR credentials saved to Video Agent config: {Path}", videoAgentPath);
            
            // Clear password field after save for security
            _nvrConfig.Password = "";
            
            await Task.Delay(100);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving NVR credentials");
            _nvrErrorMessage = "Failed to save NVR credentials: " + ex.Message;
        }
        finally
        {
            _savingNvrConfig = false;
        }
    }

    private void LoadBackupSettings()
    {
        try
        {
            _backupConfig = BackupConfigService.Load();
            if (_backupConfig == null)
            {
                _backupConfig = new BackupConfig
                {
                    BackupFolder = BackupConfigService.GetDefaultBackupFolder()
                };
            }
            
            // Convert TimeSpan to selected hour (0-23)
            _selectedBackupHour = _backupConfig.DailyBackupTime.Hours;
            
            // Set retention days, defaulting to 30 if not one of the allowed values
            if (_backupConfig.RetentionDays == 7 || _backupConfig.RetentionDays == 14 || 
                _backupConfig.RetentionDays == 30 || _backupConfig.RetentionDays == 60)
            {
                _selectedRetentionDays = _backupConfig.RetentionDays;
            }
            else
            {
                _selectedRetentionDays = 30;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading backup settings");
            _errorMessage = "Failed to load backup settings. Using defaults.";
            _backupConfig = new BackupConfig
            {
                BackupFolder = BackupConfigService.GetDefaultBackupFolder()
            };
            _selectedBackupHour = 2;
            _selectedRetentionDays = 30;
        }
    }

    private async Task SaveBackupSettings()
    {
        _saving = true;
        _errorMessage = string.Empty;
        _showSuccessMessage = false;

        try
        {
            // Validate backup folder path
            if (string.IsNullOrWhiteSpace(_backupConfig.BackupFolder))
            {
                _errorMessage = "Backup folder path is required.";
                _saving = false;
                return;
            }

            // Create backup folder if it doesn't exist
            try
            {
                // Normalize the path (handle any browser-specific path issues)
                var folderPath = _backupConfig.BackupFolder.Trim();
                
                if (string.IsNullOrWhiteSpace(folderPath))
                {
                    _errorMessage = "Backup folder path cannot be empty.";
                    _saving = false;
                    return;
                }

                if (!Directory.Exists(folderPath))
                {
                    // Create the directory and all parent directories if needed
                    Directory.CreateDirectory(folderPath);
                    Logger.LogInformation("Created backup folder: {BackupFolder}", folderPath);
                    
                    // Verify the folder was actually created
                    if (Directory.Exists(folderPath))
                    {
                        // Update the config with the normalized path
                        _backupConfig.BackupFolder = folderPath;
                    }
                    else
                    {
                        _errorMessage = $"Failed to create backup folder. Please check the path and permissions: {folderPath}";
                        _saving = false;
                        return;
                    }
                }
                else
                {
                    // Folder already exists, just update the config with normalized path
                    _backupConfig.BackupFolder = folderPath;
                }
            }
            catch (UnauthorizedAccessException ex)
            {
                Logger.LogError(ex, "Permission denied creating backup folder: {BackupFolder}", _backupConfig.BackupFolder);
                _errorMessage = $"Permission denied. Unable to create backup folder. Please check folder permissions: {ex.Message}";
                _saving = false;
                return;
            }
            catch (DirectoryNotFoundException ex)
            {
                Logger.LogError(ex, "Parent directory not found for backup folder: {BackupFolder}", _backupConfig.BackupFolder);
                _errorMessage = $"Parent directory not found. Please ensure the parent folder exists: {ex.Message}";
                _saving = false;
                return;
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to create backup folder: {BackupFolder}", _backupConfig.BackupFolder);
                _errorMessage = $"Failed to create backup folder: {ex.Message}. Please check the path is valid and you have permissions.";
                _saving = false;
                return;
            }

            // Set backup time from selected hour
            _backupConfig.DailyBackupTime = new TimeSpan(_selectedBackupHour, 0, 0);
            
            // Set retention days from selected value
            _backupConfig.RetentionDays = _selectedRetentionDays;

            // Mark as configured
            _backupConfig.IsConfigured = true;

            // Save the configuration
            BackupConfigService.Save(_backupConfig);

            _showSuccessMessage = true;
            var folderStatus = Directory.Exists(_backupConfig.BackupFolder) ? "exists" : "created";
            Logger.LogInformation("Backup settings saved successfully. Backup folder: {BackupFolder} ({Status})", _backupConfig.BackupFolder, folderStatus);
            
            // Small delay to show success message
            await Task.Delay(100);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving backup settings");
            _errorMessage = "Failed to save backup settings: " + ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }


    private async Task SelectBackupFolder()
    {
        _selectingFolder = true;
        _errorMessage = string.Empty;

        try
        {
            // Try to use File System Access API (Chrome/Edge) or fallback to file input
            var selectedPath = await JSRuntime.InvokeAsync<string>("selectBackupFolder");
            
            if (!string.IsNullOrWhiteSpace(selectedPath))
            {
                // Note: Browser security prevents getting full file system paths
                // The selectedPath will be just the folder name, not the full path
                // User will need to enter the full server path manually
                // We'll use the selected folder name as a starting point
                if (!selectedPath.Contains(":\\") && !selectedPath.StartsWith("\\\\"))
                {
                    // This is just a folder name, not a full path
                    // Prepend a default server path or let user complete it
                    var defaultBasePath = "C:\\GFC_Backups\\";
                    _backupConfig.BackupFolder = defaultBasePath + selectedPath;
                    _errorMessage = $"Selected folder: {selectedPath}. Please verify and complete the full server path above (e.g., C:\\GFC_Backups\\{selectedPath}).";
                }
                else
                {
                    _backupConfig.BackupFolder = selectedPath;
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error selecting backup folder");
            _errorMessage = "Folder picker is not available in this browser. Please enter the path manually.";
        }
        finally
        {
            _selectingFolder = false;
        }
    }

    private void ResetToDefaults()
    {
        _backupConfig = new BackupConfig
        {
            BackupFolder = BackupConfigService.GetDefaultBackupFolder(),
            ServerInstance = "localhost",
            DatabaseName = "ClubMembership",
            RetentionDays = 30,
            DailyBackupTime = new TimeSpan(2, 0, 0),
            IsConfigured = false,
            LastBackupTime = null
        };
        _selectedBackupHour = 2;
        _selectedRetentionDays = 30;
        _errorMessage = string.Empty;
        _showSuccessMessage = false;
    }

    private async Task RunBackupNow()
    {
        _runningBackup = true;
        _errorMessage = string.Empty;
        _showSuccessMessage = false;

        try
        {
            // Ensure settings are saved first
            if (!_backupConfig.IsConfigured)
            {
                _errorMessage = "Please configure and save backup settings before running a backup.";
                _runningBackup = false;
                return;
            }

            Logger.LogInformation("Manual backup triggered from Settings page");
            var success = await DatabaseBackupService.ExecuteBackupAsync();

            if (success)
            {
                _showSuccessMessage = true;
                Logger.LogInformation("Manual backup completed successfully");
                
                // Reload settings to get updated LastBackupTime
                LoadBackupSettings();
                
                // Clear success message after 5 seconds
                await Task.Delay(5000);
                _showSuccessMessage = false;
            }
            else
            {
                _errorMessage = "Backup failed. Please check the logs for details.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error running manual backup");
            _errorMessage = "Error running backup: " + ex.Message;
        }
        finally
        {
            _runningBackup = false;
        }
    }
}

