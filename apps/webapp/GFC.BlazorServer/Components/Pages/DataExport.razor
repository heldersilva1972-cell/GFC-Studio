@page "/export"
@using GFC.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDataExportService ExportService
@inject ILogger<DataExport> Logger
@inject IJSRuntime JSRuntime
@using System.IO

<PageTitle>Data Export - GFC Membership</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Data Export</h1>
        <p class="page-subtitle">Export club data to Excel format</p>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @_errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert alert-success">
            @_successMessage
        </div>
    }

    <div class="card mb-4">
        <div class="card-header">
            <h3>Select Data to Export</h3>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">Choose which data types to include in the Excel export. Each data type will be exported to a separate sheet.</p>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="members" @bind="_options.IncludeMembers" />
                        <label class="form-check-label" for="members">
                            <strong>Members</strong>
                            <small class="d-block text-muted">All member information including contact details and status</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="dues" @bind="_options.IncludeDues" />
                        <label class="form-check-label" for="dues">
                            <strong>Dues Payments</strong>
                            <small class="d-block text-muted">All dues payment records</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="keycards" @bind="_options.IncludeKeyCards" />
                        <label class="form-check-label" for="keycards">
                            <strong>Key Cards</strong>
                            <small class="d-block text-muted">All key card assignments and information</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="physicalkeys" @bind="_options.IncludePhysicalKeys" />
                        <label class="form-check-label" for="physicalkeys">
                            <strong>Physical Keys</strong>
                            <small class="d-block text-muted">All physical door key assignments and returns</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="lottery" @bind="_options.IncludeLotteryShifts" />
                        <label class="form-check-label" for="lottery">
                            <strong>Lottery Shifts</strong>
                            <small class="d-block text-muted">All lottery sales shift records</small>
                        </label>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="board" @bind="_options.IncludeBoardMembers" />
                        <label class="form-check-label" for="board">
                            <strong>Board Members</strong>
                            <small class="d-block text-muted">Board of directors assignments and history</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="npqueue" @bind="_options.IncludeNpQueue" />
                        <label class="form-check-label" for="npqueue">
                            <strong>Non-Portuguese Queue</strong>
                            <small class="d-block text-muted">Current queue of guests waiting for regular status</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="life" @bind="_options.IncludeLifeEligibility" />
                        <label class="form-check-label" for="life">
                            <strong>Life Eligibility</strong>
                            <small class="d-block text-muted">Members eligible for life membership</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="users" @bind="_options.IncludeUsers" />
                        <label class="form-check-label" for="users">
                            <strong>Users</strong>
                            <small class="d-block text-muted">System user accounts (Admin only)</small>
                        </label>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button class="btn btn-primary" @onclick="ExportData" disabled="@_isExporting">
                    @if (_isExporting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span>Exporting...</span>
                    }
                    else
                    {
                        <i class="bi bi-download me-2"></i>
                        <span>Export to Excel</span>
                    }
                </button>
                <button class="btn btn-outline-secondary ms-2" @onclick="SelectAll">Select All</button>
                <button class="btn btn-outline-secondary ms-2" @onclick="DeselectAll">Deselect All</button>
            </div>
        </div>
    </div>

    <!-- Import Section -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning-subtle text-dark">
            <h3><i class="bi bi-upload me-2"></i>Import Data from Excel</h3>
        </div>
        <div class="card-body">
            <p class="mb-3">
                You can update the database by uploading an Excel file.
                <strong>Ideally, use a file previously exported from this system.</strong>
            </p>
            <div class="alert alert-info small">
                <i class="bi bi-info-circle-fill me-2"></i>
                Currently, only <strong>Members</strong> updates are supported. 
                <br/>
                • To <strong>update</strong>: Keep the existing <strong>Member ID</strong>.
                <br/>
                • To <strong>create new</strong>: Leave the <strong>Member ID</strong> blank (or set to 0).
            </div>

            <div class="mb-3">
                <InputFile OnChange="HandleFileSelected" class="form-control" accept=".xlsx" />
            </div>

            @if (_importResult != null)
            {
                <div class="mt-3">
                    <h5>Import Results</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            processed Rows
                            <span class="badge bg-primary rounded-pill">@_importResult.ProcessedCount</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-success">
                            Created New
                            <span class="badge bg-success rounded-pill">@_importResult.CreatedCount</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-primary">
                            Updated Existing
                            <span class="badge bg-primary rounded-pill">@_importResult.UpdatedCount</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-danger">
                            Errors
                            <span class="badge bg-danger rounded-pill">@_importResult.ErrorCount</span>
                        </li>
                    </ul>
                    @if (_importResult.Errors.Any())
                    {
                        <div class="alert alert-danger mt-2" style="max-height: 200px; overflow-y: auto;">
                            <h6>Error Details:</h6>
                            <ul class="mb-0 small">
                                @foreach (var err in _importResult.Errors)
                                {
                                    <li>@err</li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            }
             @if (_isImporting)
            {
                <div class="mt-3 text-center">
                     <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                     <span>Importing data... please wait.</span>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private ExportOptions _options = new();
    private bool _isExporting = false;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;
    
    // Import state
    private bool _isImporting = false;
    private GFC.Core.Models.ImportResult _importResult;

    private void SelectAll()
    {
        _options.IncludeMembers = true;
        _options.IncludeDues = true;
        _options.IncludeKeyCards = true;
        _options.IncludePhysicalKeys = true;
        _options.IncludeLotteryShifts = true;
        _options.IncludeBoardMembers = true;
        _options.IncludeNpQueue = true;
        _options.IncludeLifeEligibility = true;
        _options.IncludeUsers = false; // Keep users off by default for security
    }

    private void DeselectAll()
    {
        _options.IncludeMembers = false;
        _options.IncludeDues = false;
        _options.IncludeKeyCards = false;
        _options.IncludePhysicalKeys = false;
        _options.IncludeLotteryShifts = false;
        _options.IncludeBoardMembers = false;
        _options.IncludeNpQueue = false;
        _options.IncludeLifeEligibility = false;
        _options.IncludeUsers = false;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        _importResult = null;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        var file = e.File;
        if (file == null) return;

        // Max size 10MB
        long maxFileSize = 1024 * 1024 * 10; 

        _isImporting = true;
        StateHasChanged();

        try
        {
            using var stream = file.OpenReadStream(maxFileSize);
            // Copy to memory stream because EPPlus might need seekable stream
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            ms.Position = 0;

            _importResult = await ExportService.ImportFromExcelAsync(ms);

            if (_importResult.SuccessCount > 0)
            {
               _successMessage = $"Import completed. {_importResult.SuccessCount} records updated.";
            }
            if (_importResult.ErrorCount > 0)
            {
                // If we also had success, append.
                if (!string.IsNullOrEmpty(_successMessage)) 
                    _errorMessage = "Import completed with some errors. See details below.";
                else
                    _errorMessage = "Import completed with errors. See details below.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error importing Excel file");
            _errorMessage = "Error importing file: " + ex.Message;
        }
        finally
        {
            _isImporting = false;
            StateHasChanged();
        }
    }

    private async Task ExportData()
    {
        // Check if at least one option is selected
        if (!_options.IncludeMembers && !_options.IncludeDues && !_options.IncludeKeyCards &&
            !_options.IncludePhysicalKeys && !_options.IncludeLotteryShifts && !_options.IncludeBoardMembers && 
            !_options.IncludeNpQueue && !_options.IncludeLifeEligibility && !_options.IncludeUsers)
        {
            _errorMessage = "Please select at least one data type to export.";
            _successMessage = string.Empty;
            return;
        }

        _isExporting = true;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        try
        {
            var excelData = ExportService.ExportToExcel(_options);
            var fileName = $"GFC_Export_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            var contentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";

            // Trigger download
            await DownloadFile(fileName, excelData, contentType);
            
            _successMessage = "Export completed successfully! The file should download automatically.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting data to Excel");
            _errorMessage = "An error occurred while exporting data: " + ex.Message;
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task DownloadFile(string fileName, byte[] fileData, string contentType)
    {
        // Use JavaScript interop to trigger download
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileData), contentType);
    }
}

