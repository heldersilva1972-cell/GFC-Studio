@using GFC.Core.Interfaces
@inject ISystemSettingsService SystemSettingsService
@inject ILogger<SimulationStatusTile> Logger

<div class="card shadow-sm">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">
            <i class="bi bi-info-circle"></i> System Status
        </h5>
    </div>
    <div class="card-body">
        @if (!_loaded)
        {
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="small text-muted mt-2">Checking mode...</div>
            </div>
        }
        else
        {
            <div class="d-flex flex-column gap-3">
                <!-- Mode Status -->
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <div class="status-indicator @(_useRealControllers ? "status-live" : "status-sim")"></div>
                        <div>
                            <div class="fw-semibold">@(_useRealControllers ? "Live Mode" : "Simulation Mode")</div>
                            <div class="small text-muted">
                                @(_useRealControllers ? "Real hardware active" : "No hardware writes")
                            </div>
                        </div>
                    </div>
                    @if (!_useRealControllers)
                    {
                        <span class="badge bg-success">SAFE</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">LIVE</span>
                    }
                </div>

                <!-- Simulation Time (only show in sim mode) -->
                @if (!_useRealControllers && SimulationTime.HasValue)
                {
                    <div class="border-top pt-3">
                        <div class="small text-muted mb-1">Simulation Clock</div>
                        <div class="d-flex align-items-baseline gap-2">
                            <div class="h5 mb-0 font-monospace">@SimulationTime.Value.ToString("HH:mm:ss")</div>
                            <small class="text-muted">UTC</small>
                        </div>
                        @if (TimeOffset.HasValue)
                        {
                            <div class="small text-muted">
                                Offset: @TimeOffset.Value.ToString(@"dd\.hh\:mm\:ss")
                            </div>
                        }
                    </div>
                }

                <!-- Connection Status -->
                <div class="border-top pt-3">
                    <div class="small text-muted mb-2">Controller Status</div>
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-hdd-network text-@(ControllerOnline ? "success" : "secondary")"></i>
                        <span class="small">@(ControllerOnline ? $"{ControllerCount} Online" : "No controllers")</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
    }

    .status-sim {
        background: #28a745;
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
    }

    .status-live {
        background: #dc3545;
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }

    @@keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(40, 167, 69, 0);
        }
    }
</style>

@code {
    [Parameter] public DateTime? SimulationTime { get; set; }
    [Parameter] public TimeSpan? TimeOffset { get; set; }
    [Parameter] public bool ControllerOnline { get; set; }
    [Parameter] public int ControllerCount { get; set; }

    private bool _loaded = false;
    private bool _useRealControllers = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadModeAsync();
    }

    private async Task LoadModeAsync()
    {
        try
        {
            var settings = await SystemSettingsService.GetAsync();
            _useRealControllers = settings.UseRealControllers;
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load system mode; defaulting to simulation");
            _useRealControllers = false;
        }
        finally
        {
            _loaded = true;
        }
    }

    public async Task RefreshAsync()
    {
        await LoadModeAsync();
        StateHasChanged();
    }
}
