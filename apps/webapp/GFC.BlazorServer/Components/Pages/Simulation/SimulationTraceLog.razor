@using GFC.BlazorServer.Services.Controllers

<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="bi bi-list-ul"></i> Recent Traces
        </h5>
        <div class="d-flex gap-2 align-items-center">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="autoRefreshToggle" 
                       @bind="AutoRefresh" 
                       @bind:after="OnAutoRefreshChanged">
                <label class="form-check-label small" for="autoRefreshToggle">
                    Auto-refresh
                </label>
            </div>
            <button class="btn btn-sm btn-outline-secondary" 
                    @onclick="OnRefresh" 
                    disabled="@IsRefreshing">
                <i class="bi bi-arrow-clockwise @(IsRefreshing ? "spin" : "")"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        @if (IsLoading)
        {
            <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="small text-muted mt-2">Loading traces...</div>
            </div>
        }
        else if (!Traces.Any())
        {
            <div class="text-center text-muted py-4">
                <i class="bi bi-inbox"></i>
                <div class="small mt-2">No traces recorded yet</div>
            </div>
        }
        else
        {
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 140px;">Timestamp</th>
                            <th style="width: 100px;">Type</th>
                            <th>Controller</th>
                            <th style="width: 80px;">Door</th>
                            <th style="width: 100px;">Status</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var trace in Traces)
                        {
                            <tr class="@GetTraceRowClass(trace)">
                                <td class="small font-monospace">@trace.Timestamp.ToString("HH:mm:ss.fff")</td>
                                <td>
                                    <span class="badge badge-sm @GetEventTypeBadge(trace.EventType)">
                                        @trace.EventType
                                    </span>
                                </td>
                                <td class="small">@trace.ControllerName</td>
                                <td class="small text-center">@trace.DoorIndex</td>
                                <td>
                                    <span class="badge badge-sm @GetStatusBadge(trace.Status)">
                                        @trace.Status
                                    </span>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-link p-0" 
                                            @onclick="@(() => HandleViewDetails(trace))"
                                            title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
    @if (Traces.Any())
    {
        <div class="card-footer bg-light small text-muted">
            Showing @Traces.Count trace(s) Â· Last updated: @LastUpdated.ToString("HH:mm:ss")
        </div>
    }
</div>

<style>
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .spin {
        animation: spin 1s linear infinite;
    }

    .trace-row-success {
        background-color: rgba(40, 167, 69, 0.05);
    }

    .trace-row-error {
        background-color: rgba(220, 53, 69, 0.05);
    }

    .trace-row-warning {
        background-color: rgba(255, 193, 7, 0.05);
    }

    .badge-sm {
        font-size: 0.7rem;
        padding: 0.25em 0.5em;
    }

    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>

@code {
    [Parameter] public List<TraceDto> Traces { get; set; } = new();
    [Parameter] public bool AutoRefresh { get; set; } = true;
    [Parameter] public EventCallback<bool> AutoRefreshChanged { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }
    [Parameter] public EventCallback<TraceDto> OnViewDetails { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public bool IsRefreshing { get; set; }

    private DateTime LastUpdated { get; set; } = DateTime.Now;

    private async Task OnAutoRefreshChanged()
    {
        await AutoRefreshChanged.InvokeAsync(AutoRefresh);
    }

    private async Task HandleViewDetails(TraceDto trace)
    {
        await OnViewDetails.InvokeAsync(trace);
    }

    private string GetTraceRowClass(TraceDto trace)
    {
        return trace.Status?.ToLower() switch
        {
            "success" or "granted" => "trace-row-success",
            "error" or "denied" => "trace-row-error",
            "warning" => "trace-row-warning",
            _ => string.Empty
        };
    }

    private string GetEventTypeBadge(string eventType)
    {
        return eventType?.ToLower() switch
        {
            "access granted" or "granted" => "bg-success",
            "access denied" or "denied" => "bg-danger",
            "door open" => "bg-warning text-dark",
            "door closed" => "bg-secondary",
            "card swipe" => "bg-info",
            _ => "bg-secondary"
        };
    }

    private string GetStatusBadge(string? status)
    {
        return status?.ToLower() switch
        {
            "success" or "granted" => "bg-success",
            "error" or "denied" => "bg-danger",
            "warning" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    public void UpdateLastRefreshed()
    {
        LastUpdated = DateTime.Now;
        StateHasChanged();
    }

    public class TraceDto
    {
        public int Id { get; set; }
        public DateTime Timestamp { get; set; }
        public string EventType { get; set; } = string.Empty;
        public string ControllerName { get; set; } = string.Empty;
        public int DoorIndex { get; set; }
        public string? Status { get; set; }
        public string? Details { get; set; }
    }
}
