@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using GFC.BlazorServer.Components.Shared


<div class="nav-search-container">
    <div class="nav-search-wrapper">
        <i class="bi bi-search search-icon"></i>
        <input type="text" 
               class="nav-search-input" 
               placeholder="Search menu..." 
               @bind="SearchTerm" 
               @bind:event="oninput" />
        @if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            <i class="bi bi-x search-clear" @onclick="() => SearchTerm = string.Empty"></i>
        }
    </div>
</div>

<nav class="navmenu">
    <ul>
        <li>
            <NavLink class="nav-item" ActiveClass="nav-item-active" href="/" Match="NavLinkMatch.All">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </NavLink>
        </li>

        <!-- Members Section -->
        @if (ShouldShowSection("Members"))
        {
            <li class="nav-group @(IsSectionExpanded("Members") ? "expanded" : "")">
                <div class="nav-group-header" @onclick="@(() => ToggleSection("Members"))">
                    <span class="group-title">Members</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/members" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-people"></i>
                        <span>Members</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/dues" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-wallet2"></i>
                        <span>Dues</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/np-queue" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-arrow-up-right-circle"></i>
                        <span>Non-Portuguese Queue</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/life-eligibility" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-award"></i>
                        <span>Life Eligibility</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/directors" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-people-fill"></i>
                        <span>Directors</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/keycards" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-key-fill"></i>
                        <span>Key Cards</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/members/keycards" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-person-badge"></i>
                        <span>Member Card Status</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/physicalkeys" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-key"></i>
                        <span>Physical Keys</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- Camera System (Consolidated) -->
        @if (IsAdmin && ShouldShowSection("Cameras"))
        {
            <li class="nav-group @(IsSectionExpanded("Cameras") ? "expanded" : "")">
                <div class="nav-group-header" @onclick="@(() => ToggleSection("Cameras"))">
                    <span class="group-title">Camera System</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/grid" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-grid-3x3-gap-fill"></i>
                        <span>Camera Grid</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/1" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-camera-video-fill"></i>
                        <span>Live Cameras</span>
                        <span class="badge gfc-new-tag">NEW</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/camera-verification" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-camera-video"></i>
                        <span>Verification</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/discover" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-radar"></i>
                        <span>Discover Cameras</span>
                        <NewFeatureBadge />
                    </NavLink>
                    
                    <div class="nav-divider"></div>
                    
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-gear-fill"></i>
                        <span>Management</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/recordings" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-cloud-download"></i>
                        <span>Recordings</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/permissions" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-shield-lock"></i>
                        <span>Permissions</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/analytics" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-bar-chart-line"></i>
                        <span>Analytics</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/audit" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-journal-richtext"></i>
                        <span>Audit Log</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- Controllers -->
        @if (IsAdmin && ShouldShowSection("Controllers"))
        {
            <li class="nav-group @(IsSectionExpanded("Controllers") ? "expanded" : "")">
                <div class="nav-group-header" @onclick="@(() => ToggleSection("Controllers"))">
                    <span class="group-title">Controllers</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/controllers/card-access" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-credit-card-2-front"></i>
                        <span>Card Access</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/maintenance/system-status" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-tools"></i>
                        <span>Maintenance</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- Finance & Ops -->
        @if (ShouldShowSection("Finance"))
        {
            <li class="nav-group @(IsSectionExpanded("Finance") ? "expanded" : "")">
                <div class="nav-group-header" @onclick="@(() => ToggleSection("Finance"))">
                    <span class="group-title">Finance & Ops</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/reimbursements" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-receipt"></i>
                        <span>Reimbursements</span>
                    </NavLink>
                    @if (IsAdmin)
                    {
                        <NavLink class="nav-item" ActiveClass="nav-item-active" href="/reimbursements/manage" Match="NavLinkMatch.Prefix">
                            <i class="bi bi-gear"></i>
                            <span>Manage Reimbursements</span>
                        </NavLink>
                        <NavLink class="nav-item" ActiveClass="nav-item-active" href="/reimbursements/reports" Match="NavLinkMatch.Prefix">
                            <i class="bi bi-graph-up"></i>
                            <span>Reports</span>
                        </NavLink>
                    }
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/lottery" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-ticket-perforated"></i>
                        <span>Lottery Sales</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/export" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-file-earmark-excel"></i>
                        <span>Data Export</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- Admin -->
        @if (IsAdmin && ShouldShowSection("Admin"))
        {
            <li class="nav-group @(IsSectionExpanded("Admin") ? "expanded" : "")">
                <div class="nav-group-header" @onclick="@(() => ToggleSection("Admin"))">
                    <span class="group-title">Administration</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/users" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-person-gear"></i>
                        <span>Users</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/audit-logs" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-journal-text"></i>
                        <span>System Logs</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/system-diagnostics" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-heart-pulse"></i>
                        <span>Diagnostics</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/notification-preferences" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-bell"></i>
                        <span>Notifications</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/settings" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-gear"></i>
                        <span>Settings</span>
                    </NavLink>
                </div>
            </li>
        }

    </ul>
</nav>

@code {
    [Parameter]
    public bool IsAdmin { get; set; }

    private string SearchTerm { get; set; } = "";
    
    // Track expanded state of groups. Default to Members open? Or all closed?
    // Let's keep Members open by default as it's the most used.
    private Dictionary<string, bool> ExpandedSections = new()
    {
        { "Members", true },
        { "Cameras", false },
        { "Controllers", false },
        { "Finance", false },
        { "Admin", false }
    };

    private void ToggleSection(string sectionName)
    {
        if (ExpandedSections.ContainsKey(sectionName))
        {
            var isCurrentlyExpanded = ExpandedSections[sectionName];

            // Close all sections
            foreach (var key in ExpandedSections.Keys.ToList())
            {
                ExpandedSections[key] = false;
            }

            // Toggle the one we clicked: if it was closed, it opens; if it was open, it closes.
            ExpandedSections[sectionName] = !isCurrentlyExpanded;
        }
    }

    private bool IsSectionExpanded(string sectionName)
    {
        // If searching, everything matches is "expanded" implicitly to show results
        if (!string.IsNullOrWhiteSpace(SearchTerm)) return true;

        return ExpandedSections.ContainsKey(sectionName) && ExpandedSections[sectionName];
    }
    
    // Very simple search filter simulation:
    // If search is active, we only show sections that MIGHT contain the item.
    // However, for this simple implementation, we'll just check if the section name OR any meaningful keyword matches.
    // Improved logic: We rely on CSS purely for hiding? No, Blazor logic is cleaner.
    // Let's keep it simple: If searching, show all sections, expand all.
    // Ideally, we'd filter the inner items too, but that requires extracting items to data structures.
    // For now, "Search" just expands everything so the user can see matching highlights? 
    // No, that's messy. 
    // Let's implement a helper that returns true/false if the section should be visible.
    
    private bool ShouldShowSection(string sectionName)
    {
        if (string.IsNullOrWhiteSpace(SearchTerm)) return true;
        
        // Simple string matching against keywords known to be in that section
        // This is a rough heuristic to avoid complex object mapping for now.
        var term = SearchTerm.ToLowerInvariant();
        
        return sectionName switch
        {
            "Members" => "members dues queue directors key cards keys".Contains(term),
            "Cameras" => "camera video record lens grid live".Contains(term),
            "Controllers" => "controller access door maintenance".Contains(term),
            "Finance" => "finance reimbursement lottery export data money".Contains(term),
            "Admin" => "admin user settings log diagnostics".Contains(term),
            _ => true
        };
    }
}
