@implements IDisposable
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using GFC.BlazorServer.Components.Shared


<div class="nav-search-container">
    <div class="nav-search-wrapper">
        <i class="bi bi-search search-icon"></i>
        <input type="text" 
               class="nav-search-input" 
               placeholder="Search menu..." 
               @bind="SearchTerm" 
               @bind:event="oninput" />
        @if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            <i class="bi bi-x search-clear" @onclick="() => SearchTerm = string.Empty"></i>
        }
    </div>
</div>

<nav class="navmenu">
    <ul>
        <li>
            <NavLink class="nav-item" ActiveClass="nav-item-active" href="/" Match="NavLinkMatch.All">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </NavLink>
        </li>

        <!-- GFC Studio Section -->
        @if (IsAdmin && ShouldShowSection("Studio"))
        {
            <li class="nav-group @(IsSectionExpanded("Studio") ? "expanded" : "")">
                <div class="nav-group-header @(IsSectionActive("Studio") ? "active" : "")" @onclick="@(() => ToggleSection("Studio"))">
                    <span class="group-title">GFC Studio</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/studio" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-palette"></i>
                        <span>Visual Editor</span>
                        <NewFeatureBadge />
                    </NavLink>
                </div>
            </li>
        }

        <!-- Members Section -->
        @if (ShouldShowSection("Members"))
        {
            <li class="nav-group @(IsSectionExpanded("Members") ? "expanded" : "")">
                <div class="nav-group-header @(IsSectionActive("Members") ? "active" : "")" @onclick="@(() => ToggleSection("Members"))">
                    <span class="group-title">Members</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/members" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-people"></i>
                        <span>Members</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/dues" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-wallet2"></i>
                        <span>Dues</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/np-queue" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-arrow-up-right-circle"></i>
                        <span>Non-Portuguese Queue</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/life-eligibility" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-award"></i>
                        <span>Life Eligibility</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/directors" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-people-fill"></i>
                        <span>Directors</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/keycards" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-key-fill"></i>
                        <span>Key Cards</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/controllers/schedules/holidays" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-calendar-heart"></i>
                        <span>Holidays</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/controllers/schedules/specialevents" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-calendar-star"></i>
                        <span>Special Events</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/physicalkeys" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-key"></i>
                        <span>Physical Keys</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- Camera System (Consolidated) -->
        @if (IsAdmin && ShouldShowSection("Cameras"))
        {
            <li class="nav-group @(IsSectionExpanded("Cameras") ? "expanded" : "")">
                <div class="nav-group-header @(IsSectionActive("Cameras") ? "active" : "")" @onclick="@(() => ToggleSection("Cameras"))">
                    <span class="group-title">Camera System</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/view" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-display"></i>
                        <span>View Monitor</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/configure" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-gear-wide-connected"></i>
                        <span>System Setup</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/cameras/audit" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-journal-richtext"></i>
                        <span>Audit Log</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- Controllers -->
        @if (IsAdmin && ShouldShowSection("Controllers"))
        {
            <li class="nav-group @(IsSectionExpanded("Controllers") ? "expanded" : "")">
                <div class="nav-group-header @(IsSectionActive("Controllers") ? "active" : "")" @onclick="@(() => ToggleSection("Controllers"))">
                    <span class="group-title">Controllers</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/controllers/card-access" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-hdd-network-fill"></i>

                        <span>Access Controllers</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- Finance & Ops -->
        @if (ShouldShowSection("Finance"))
        {
            <li class="nav-group @(IsSectionExpanded("Finance") ? "expanded" : "")">
                <div class="nav-group-header @(IsSectionActive("Finance") ? "active" : "")" @onclick="@(() => ToggleSection("Finance"))">
                    <span class="group-title">Finance & Ops</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/reimbursements" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-receipt"></i>
                        <span>Reimbursements</span>
                    </NavLink>
                    @if (IsAdmin)
                    {
                        <NavLink class="nav-item" ActiveClass="nav-item-active" href="/reimbursements/manage" Match="NavLinkMatch.Prefix">
                            <i class="bi bi-gear"></i>
                            <span>Manage Reimbursements</span>
                        </NavLink>
                        <NavLink class="nav-item" ActiveClass="nav-item-active" href="/reimbursements/reports" Match="NavLinkMatch.Prefix">
                            <i class="bi bi-graph-up"></i>
                            <span>Reports</span>
                        </NavLink>
                    }
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/lottery" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-ticket-perforated"></i>
                        <span>Lottery Sales</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/bartender-shift" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-person-badge"></i>
                        <span>Bartender Shift</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/export" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-file-earmark-excel"></i>
                        <span>Data Export</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- Admin -->
        @if (IsAdmin && ShouldShowSection("Admin"))
        {
            <li class="nav-group @(IsSectionExpanded("Admin") ? "expanded" : "")">
                <div class="nav-group-header @(IsSectionActive("Admin") ? "active" : "")" @onclick="@(() => ToggleSection("Admin"))">
                    <span class="group-title">Administration</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/pages" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-file-earmark-richtext"></i>
                        <span>Page Management</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/media" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-images"></i>
                        <span>Media Manager</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/form-builder" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-ui-checks-grid"></i>
                        <span>Form Builder</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/users" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-person-gear"></i>
                        <span>Users</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/reviews" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-chat-square-quote"></i>
                        <span>Review Moderation</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/documents" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-file-earmark-lock"></i>
                        <span>Document Management</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/staff-shifts" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-person-badge"></i>
                        <span>Staff Shifts</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/event-promotions" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-card-image"></i>
                        <span>Event Promotions</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/nav-menu-editor" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-list-nested"></i>
                        <span>Nav Menu Editor</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/website-settings" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-globe2"></i>
                        <span>Website Settings</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/security-settings" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-shield-lock"></i>
                        <span>Security & Remote Access</span>
                        <NewFeatureBadge />
                    </NavLink>
                </div>
            </li>
        }

        <!-- Hall Rentals -->
        @if (IsAdmin && ShouldShowSection("HallRentals"))
        {
            <li class="nav-group @(IsSectionExpanded("HallRentals") ? "expanded" : "")">
                <div class="nav-group-header @(IsSectionActive("HallRentals") ? "active" : "")" @onclick="@(() => ToggleSection("HallRentals"))">
                    <span class="group-title">Hall Rentals</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/rental-management" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-calendar-check"></i>
                        <span>Manage Requests</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/blackout-dates" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-calendar-x"></i>
                        <span>Blackout Dates</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/hall-rental-settings" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-gear"></i>
                        <span>Settings</span>
                    </NavLink>
                </div>
            </li>
        }

        <!-- System -->
        @if (IsAdmin && ShouldShowSection("System"))
        {
            <li class="nav-group @(IsSectionExpanded("System") ? "expanded" : "")">
                <div class="nav-group-header @(IsSectionActive("System") ? "active" : "")" @onclick="@(() => ToggleSection("System"))">
                    <span class="group-title">System</span>
                    <i class="bi bi-chevron-right group-arrow"></i>
                </div>
                <div class="nav-group-items">
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/audit-logs" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-journal-text"></i>
                        <span>System Logs</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/video-access-monitoring" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-camera-video"></i>
                        <span>Video Monitoring</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/system-diagnostics" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-heart-pulse"></i>
                        <span>Diagnostics</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/maintenance/system-status" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-tools"></i>
                        <span>Maintenance</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/notification-preferences" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-bell"></i>
                        <span>Notifications</span>
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/admin/notification-routing" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-diagram-3"></i>
                        <span>Notification Routing</span>
                        <NewFeatureBadge />
                    </NavLink>
                    <NavLink class="nav-item" ActiveClass="nav-item-active" href="/settings" Match="NavLinkMatch.Prefix">
                        <i class="bi bi-gear"></i>
                        <span>Settings</span>
                    </NavLink>
                </div>
            </li>
        }

    </ul>
</nav>

@code {
    [Parameter]
    public bool IsAdmin { get; set; }

    private string SearchTerm { get; set; } = "";
    
    // Track expanded state of groups.
    private Dictionary<string, bool> ExpandedSections = new()
    {
        { "Studio", false },
        { "Members", false },
        { "Cameras", false },
        { "Controllers", false },
        { "Finance", false },
        { "Admin", false },
        { "HallRentals", false },
        { "System", false }
    };

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += HandleLocationChanged;
        
        // Auto-expand the section that is currently active on first load
        foreach (var section in ExpandedSections.Keys.ToList())
        {
            if (IsSectionActive(section))
            {
                ExpandedSections[section] = true;
            }
        }
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= HandleLocationChanged;
    }

    private void ToggleSection(string sectionName)
    {
        if (ExpandedSections.ContainsKey(sectionName))
        {
            var isCurrentlyExpanded = ExpandedSections[sectionName];

            // Close all sections
            foreach (var key in ExpandedSections.Keys.ToList())
            {
                ExpandedSections[key] = false;
            }

            // Toggle the one we clicked: if it was closed, it opens; if it was open, it closes.
            ExpandedSections[sectionName] = !isCurrentlyExpanded;
        }
    }

    private bool IsSectionExpanded(string sectionName)
    {
        if (!string.IsNullOrWhiteSpace(SearchTerm)) return true;
        return ExpandedSections.ContainsKey(sectionName) && ExpandedSections[sectionName];
    }

    private bool IsSectionActive(string sectionName)
    {
        var currentPath = Navigation.ToBaseRelativePath(Navigation.Uri);
        var path = "/" + currentPath.ToLowerInvariant();

        return sectionName switch
        {
            "Studio" => path.StartsWith("/studio"),
            "Members" => path.StartsWith("/members") || path.StartsWith("/dues") || path.StartsWith("/np-queue") || path.StartsWith("/life-eligibility") || path.StartsWith("/directors") || path.StartsWith("/keycards") || path.StartsWith("/physicalkeys"),
            "Cameras" => path.StartsWith("/cameras"),
            "Controllers" => path.StartsWith("/controllers"),
            "Finance" => path.StartsWith("/reimbursements") || path.StartsWith("/lottery") || path.StartsWith("/export") || path.StartsWith("/bartender-shift"),
            "Admin" => path.StartsWith("/users") || path.StartsWith("/admin/pages") || path.StartsWith("/admin/reviews") || path.StartsWith("/admin/documents") || path.StartsWith("/admin/staff-shifts") || path.StartsWith("/admin/nav-menu") || path.StartsWith("/admin/website-settings") || path.StartsWith("/admin/security-settings"),
            "HallRentals" => path.StartsWith("/admin/rental-management") || path.StartsWith("/admin/blackout-dates") || path.StartsWith("/admin/hall-rental-settings"),
            "System" => path.StartsWith("/admin/audit-logs") || path.StartsWith("/admin/video-access") || path.StartsWith("/admin/system-diagnostics"),
            _ => false
        };
    }
    
    private bool ShouldShowSection(string sectionName)
    {
        if (string.IsNullOrWhiteSpace(SearchTerm)) return true;
        
        var term = SearchTerm.ToLowerInvariant();
        
        return sectionName switch
        {
            "Studio" => "gfc studio visual editor page builder".Contains(term),
            "Members" => "members dues queue directors key cards keys".Contains(term),
            "Cameras" => "camera video record lens grid live audit monitor setup".Contains(term),
            "Controllers" => "controller access door maintenance hardware".Contains(term),
            "Finance" => "finance reimbursement lottery export data money ops bartender shift".Contains(term),
            "Admin" => "admin user settings page review document staff nav menu website security".Contains(term),
            "HallRentals" => "hall rental request booking blackout dates calendar".Contains(term),
            "System" => "system log diagnostics video monitoring audit".Contains(term),
            _ => true
        };
    }
}
