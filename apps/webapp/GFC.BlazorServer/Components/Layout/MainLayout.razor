@using GFC.BlazorServer.Components.Common
@inherits LayoutComponentBase
@using GFC.Core.Enums
@using GFC.Core.Interfaces
@using GFC.BlazorServer.Services
@using Microsoft.AspNetCore.Authorization
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IAuthenticationService AuthService
@inject IVersionService VersionService
@inject IBlazorSystemSettingsService SystemSettingsService
@inject ILogger<MainLayout> Logger
@inject ThemeService ThemeService
@inject IUserConnectionService UserConnectionService
@inject ControllerHealthService ControllerHealthService
@inject IUserSessionService UserSessionService
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="app-shell">
    @if (_safeModeEnabled)
    {
        <div style="background-color: #ff4444; color: white; text-align: center; padding: 0.5rem; font-weight: bold; position: sticky; top: 0; z-index: 2000;">
            ‚ö†Ô∏è SYSTEM IN SAFE MODE. RESTRICTED ACCESS ACTIVE.
        </div>
    }
    <header class="app-topbar">
        <div class="app-topbar-left">
            <span class="app-logo">GFC</span>
            <span class="app-title">GFC Membership System</span>
        </div>
        <div class="app-topbar-right">
            <div class="security-badge @GetSecurityBadgeClass()">
                @GetSecurityBadgeText()
            </div>
            <div class="connection-status @GetConnectionStatusClass()" title="Card Access Controller Status">
                <i class="bi @GetConnectionStatusIcon()"></i>
                <span>@_connectionStatus</span>
            </div>
            <AuthorizeView>
                <Authorized>
                    <span class="app-user">@_currentUsername</span>
                    @if (_isAdmin || IsAdminUser())
                    {
                        <span class="app-badge">Admin</span>
                    }
                    <button class="app-link-button" @onclick="HandleLogout" type="button">
                        Logout
                    </button>
                </Authorized>
                <NotAuthorized>
                    <a class="app-link-button" href="/login">Login</a>
                </NotAuthorized>
            </AuthorizeView>
            <button class="theme-toggle" @onclick="ThemeService.ToggleThemeAsync" title="Toggle Theme" type="button">
                @if (ThemeService.IsDarkMode)
                {
                    <i class="bi bi-sun-fill"></i>
                }
                else
                {
                    <i class="bi bi-moon-stars-fill"></i>
                }
                }
            </button>
            @if (_canInstallPwa && !_isPwaInstalled)
            {
                <button class="app-link-button ms-2" @onclick="InstallPwa" title="Install App">
                    <i class="bi bi-download me-1"></i> Install App
                </button>
            }
        </div>
    </header>

    <div class="app-main">
        <aside class="app-sidebar">
            <div class="app-sidebar-inner">
                <div class="app-sidebar-header">
                    <div class="app-logo-mark">GFC</div>
                    <div class="app-sidebar-title">
                        <div class="app-sidebar-title__main">Membership</div>
                        <div class="app-sidebar-title__sub">Control Center</div>
                    </div>
                </div>

                <div style="flex: 1; overflow-y: auto; min-height: 0;">
                    <NavMenu IsAdmin="_isAdmin || IsAdminUser()" />
                </div>

                <div class="app-sidebar-footer">
                    <div class="version-info">
                        <div class="version-info__developer">@VersionService.GetDeveloper() @VersionService.GetYear()</div>
                        <div class="version-info__revision">Revision @VersionService.GetRevision()</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="app-content">
            <Toast />
            <div class="content px-4">
                @Body
            </div>
        </main>
    </div>
</div>

<SessionMonitor />

@code {
    private string _currentUsername = string.Empty;
    private bool _isAdmin = false;
    private bool _safeModeEnabled = false;
    private string _connectionStatus = "Checking...";
    private System.Threading.Timer? _healthTimer;
    private System.Threading.Timer? _sessionTimer;
    private bool _isControllerOnline = false;

    private bool _canInstallPwa = false;
    private bool _isPwaInstalled = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CheckVpnEnforcement();
            await UpdateUserInfo();
            
            _safeModeEnabled = await SystemSettingsService.GetSafeModeEnabledAsync();
            if (_safeModeEnabled && !_isAdmin && !IsAdminUser())
            {
                Navigation.NavigateTo("/safe-mode-lockout");
                return;
            }

            UpdateControllerStatus();

            _healthTimer = new System.Threading.Timer(async _ => 
            {
                UpdateControllerStatus();
                // Check PWA status periodically
                await CheckPwaStatus();
                await InvokeAsync(StateHasChanged);
            }, null, 3000, 5000);

            var settings = await SystemSettingsService.GetSystemSettingsAsync();
            var absoluteSessionMaxMinutes = settings?.AbsoluteSessionMaxMinutes ?? 1440;

            _sessionTimer = new System.Threading.Timer(async _ =>
            {
                if (UserSessionService.LoginTimeUtc != default && (DateTime.UtcNow - UserSessionService.LoginTimeUtc).TotalMinutes > absoluteSessionMaxMinutes)
                {
                    await HandleLogout();
                }
            }, null, 60000, 60000);
            
            AuthStateProvider.AuthenticationStateChanged += async (task) =>
            {
                await UpdateUserInfo();
                StateHasChanged();
            };

            await ThemeService.InitializeAsync();
            ThemeService.OnThemeChanged += StateHasChanged;
        }
        catch
        {
            _currentUsername = "Unknown";
            _isAdmin = false;
        }
    }

    private async Task CheckPwaStatus()
    {
        try
        {
            _canInstallPwa = await JSRuntime.InvokeAsync<bool>("window.GFC.canInstall");
            _isPwaInstalled = await JSRuntime.InvokeAsync<bool>("window.GFC.isPwaInstalled");
        }
        catch 
        {
            // Ignore JS interop errors during prerendering or if script not loaded
        }
    }

    private async Task InstallPwa()
    {
        try
        {
            var isIOS = await JSRuntime.InvokeAsync<bool>("window.GFC.isIOS");
            if (isIOS)
            {
                await JSRuntime.InvokeVoidAsync("alert", "To install on iOS: Tap the Share button in Safari, then select 'Add to Home Screen'.");
            }
            else
            {
                await JSRuntime.InvokeAsync<bool>("window.GFC.triggerInstall");
                // Recheck status after attempt
                await Task.Delay(1000); 
                await CheckPwaStatus();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"PWA Install Error: {ex.Message}");
        }
    }

    private async Task CheckVpnEnforcement()
    {
        var settings = await SystemSettingsService.GetAsync();
        if (!settings.EnforceVpn || UserConnectionService.LocationType == LocationType.Local)
        {
            return;
        }

        bool shouldBlock = false;
        switch (settings.AccessMode)
        {
            case AccessMode.VpnOnly:
                if (UserConnectionService.LocationType != LocationType.VPN)
                {
                    shouldBlock = true;
                }
                break;
            case AccessMode.LanOrVpn:
                if (UserConnectionService.LocationType != LocationType.LAN && UserConnectionService.LocationType != LocationType.VPN)
                {
                    shouldBlock = true;
                }
                break;
            case AccessMode.Open:
            default:
                break;
        }

        if (shouldBlock)
        {
            Navigation.NavigateTo("/vpn-required");
        }
    }

    public void Dispose()
    {
        _healthTimer?.Dispose();
        _sessionTimer?.Dispose();
        ThemeService.OnThemeChanged -= StateHasChanged;
    }

    private async Task UpdateUserInfo()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _currentUsername = authState.User.Identity?.Name ?? "Unknown";
            
            _isAdmin = authState.User.IsInRole(AppRoles.Admin);
            if (!_isAdmin)
            {
                var currentUser = AuthStateProvider.GetCurrentUser();
                if (currentUser != null)
                {
                    _isAdmin = currentUser.IsAdmin;
                }
            }
        }
        catch
        {
            _currentUsername = "Unknown";
            _isAdmin = false;
        }
    }

    private void NavigateToLogin()
    {
        try
        {
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch { }
    }

    private async Task HandleLogout()
    {
        try
        {
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "gfc_device_token");
            await AuthStateProvider.LogoutAsync(token);
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "gfc_device_token");

            await Task.Delay(100);
            await UpdateUserInfo();
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch
        {
            Navigation.NavigateTo("/login", forceLoad: true);
        }
    }

    private bool IsAdminUser()
    {
        try
        {
            if (_isAdmin) return true;
            var currentUser = AuthStateProvider.GetCurrentUser();
            return currentUser?.IsAdmin == true;
        }
        catch
        {
            return false;
        }
    }

    private string GetConnectionStatusClass()
    {
        return _isControllerOnline ? "status-lan" : "status-public";
    }

    private string GetConnectionStatusIcon()
    {
        return _isControllerOnline ? "bi-check-circle-fill" : "bi-x-circle-fill";
    }

    private void UpdateControllerStatus()
    {
        var status = ControllerHealthService.GetHealthStatus();
        _isControllerOnline = status.IsOnline;
        _connectionStatus = _isControllerOnline ? "Card Access Controller: Online" : "Card Access Controller: Offline";
    }

    private string GetSecurityBadgeClass()
    {
        return UserConnectionService.LocationType switch
        {
            LocationType.VPN => "status-secure",
            LocationType.LAN => "status-secure",
            LocationType.Local => "status-secure",
            LocationType.Public => "status-public",
            _ => "status-unknown"
        };
    }

    private string GetSecurityBadgeText()
    {
        return UserConnectionService.LocationType switch
        {
            LocationType.VPN => "üîí Secure (VPN)",
            LocationType.LAN => "üîí Secure (LAN)",
            LocationType.Local => "üîí Secure (Local)",
            LocationType.Public => "‚ö†Ô∏è Public Web",
            _ => "‚ùì Unknown Connection"
        };
    }
}
