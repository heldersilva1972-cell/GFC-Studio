@inherits LayoutComponentBase
@using GFC.BlazorServer.Services
@using Microsoft.AspNetCore.Authorization
@using GFC.Core.Interfaces
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IAuthenticationService AuthService
@inject IVersionService VersionService
@inject ISystemSettingsService SystemSettingsService
@inject ILogger<MainLayout> Logger
@inject ThemeService ThemeService
@inject IUserConnectionService UserConnectionService
@inject ControllerHealthService ControllerHealthService

<div class="app-shell">
    <header class="app-topbar">
        <div class="app-topbar-left">
            <span class="app-logo">GFC</span>
            <span class="app-title">GFC Membership System</span>
        </div>
        <div class="app-topbar-right">
            <div class="connection-status @GetConnectionStatusClass()" title="IP Address: @(UserConnectionService.IpAddress ?? "Detecting...")">
                <i class="bi @GetConnectionStatusIcon()"></i>
                <span>@_connectionStatus</span>
            </div>
            <AuthorizeView>
                <Authorized>
                    <span class="app-user">@_currentUsername</span>
                    @if (_isAdmin || IsAdminUser())
                    {
                        <span class="app-badge">Admin</span>
                    }
                    <button class="app-link-button" @onclick="HandleLogout" type="button">
                        Logout
                    </button>
                </Authorized>
                <NotAuthorized>
                    <a class="app-link-button" href="/login">Login</a>
                </NotAuthorized>
            </AuthorizeView>
            <button class="theme-toggle" @onclick="ThemeService.ToggleThemeAsync" title="Toggle Theme" type="button">
                @if (ThemeService.IsDarkMode)
                {
                    <i class="bi bi-sun-fill"></i>
                }
                else
                {
                    <i class="bi bi-moon-stars-fill"></i>
                }
            </button>

        </div>
    </header>

    <div class="app-main">
        <aside class="app-sidebar">
            <div class="app-sidebar-inner">
                <div class="app-sidebar-header">
                    <div class="app-logo-mark">GFC</div>
                    <div class="app-sidebar-title">
                        <div class="app-sidebar-title__main">Membership</div>
                        <div class="app-sidebar-title__sub">Control Center</div>
                    </div>
                </div>

                <div style="flex: 1; overflow-y: auto; min-height: 0;">
                    <NavMenu IsAdmin="_isAdmin || IsAdminUser()" />
                </div>

                <div class="app-sidebar-footer">
                    <div class="version-info">
                        <div class="version-info__developer">@VersionService.GetDeveloper() @VersionService.GetYear()</div>
                        <div class="version-info__revision">Revision @VersionService.GetRevision()</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="app-content">
            <Toast />
            <div class="content px-4">
                @Body
            </div>
        </main>
    </div>
</div>



@* Scripts have been moved to _Host.cshtml for proper resolution *@

@code {
    private string _currentUsername = string.Empty;
    private bool _isAdmin = false;
    private string _connectionStatus = "Checking...";
    private GFC.Core.Interfaces.LocationType _locationType = GFC.Core.Interfaces.LocationType.Unknown;

    private System.Threading.Timer? _healthTimer;
    private bool _isControllerOnline = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await UpdateUserInfo();
            
            // Initial check
            UpdateControllerStatus();

            // Start polling for controller health every 5 seconds
            _healthTimer = new System.Threading.Timer(async _ => 
            {
                UpdateControllerStatus();
                await InvokeAsync(StateHasChanged);
            }, null, 5000, 5000);
            
            // Subscribe to authentication state changes
            AuthStateProvider.AuthenticationStateChanged += async (task) =>
            {
                await UpdateUserInfo();
                StateHasChanged();
            };

            await ThemeService.InitializeAsync();
            ThemeService.OnThemeChanged += StateHasChanged;
        }
        catch
        {
            _currentUsername = "Unknown";
            _isAdmin = false;
        }
    }

    public void Dispose()
    {
        _healthTimer?.Dispose();
        ThemeService.OnThemeChanged -= StateHasChanged;
    }

    private async Task UpdateUserInfo()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _currentUsername = authState.User.Identity?.Name ?? "Unknown";
            
            _isAdmin = authState.User.IsInRole(AppRoles.Admin);
            if (!_isAdmin)
            {
                var currentUser = AuthStateProvider.GetCurrentUser();
                if (currentUser != null)
                {
                    _isAdmin = currentUser.IsAdmin;
                }
            }
        }
        catch
        {
            _currentUsername = "Unknown";
            _isAdmin = false;
        }
    }

    private void NavigateToLogin()
    {
        try
        {
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch { }
    }

    private async Task HandleLogout()
    {
        try
        {
            await AuthStateProvider.LogoutAsync();
            await Task.Delay(100);
            await UpdateUserInfo();
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch
        {
            Navigation.NavigateTo("/login", forceLoad: true);
        }
    }

    private bool IsAdminUser()
    {
        try
        {
            if (_isAdmin) return true;
            var currentUser = AuthStateProvider.GetCurrentUser();
            return currentUser?.IsAdmin == true;
        }
        catch
        {
            return false;
        }
    }

    private string GetConnectionStatusClass()
    {
        return _isControllerOnline ? "status-lan" : "status-public";
    }

    private string GetConnectionStatusIcon()
    {
        return _isControllerOnline ? "bi-check-circle-fill" : "bi-x-circle-fill";
    }

    private void UpdateControllerStatus()
    {
        var status = ControllerHealthService.GetHealthStatus();
        _isControllerOnline = status.IsOnline;
        _connectionStatus = _isControllerOnline ? "System Online" : "System Offline";
    }
}

