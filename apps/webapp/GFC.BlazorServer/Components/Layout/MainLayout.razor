@inherits LayoutComponentBase
@using GFC.BlazorServer.Services
@using Microsoft.AspNetCore.Authorization
@using GFC.Core.Interfaces
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IAuthenticationService AuthService
@inject IVersionService VersionService
@inject ISystemSettingsService SystemSettingsService
@inject ILogger<MainLayout> Logger
@inject ThemeService ThemeService
@inject IUserConnectionService UserConnectionService

<div class="app-shell">
    <header class="app-topbar">
        <div class="app-topbar-left">
            <span class="app-logo">GFC</span>
            <span class="app-title">GFC Membership System</span>
        </div>
        <div class="app-topbar-right">
            <div class="connection-status @GetConnectionStatusClass()" title="IP Address: @(UserConnectionService.IpAddress ?? "Detecting...")">
                <i class="bi @GetConnectionStatusIcon()"></i>
                <span>@_connectionStatus</span>
            </div>
            <AuthorizeView>
                <Authorized>
                    <span class="app-user">@_currentUsername</span>
                    @if (_isAdmin || IsAdminUser())
                    {
                        <span class="app-badge">Admin</span>
                    }
                    <button class="app-link-button" @onclick="HandleLogout" type="button">
                        Logout
                    </button>
                </Authorized>
                <NotAuthorized>
                    <a class="app-link-button" href="/login">Login</a>
                </NotAuthorized>
            </AuthorizeView>
            <button class="theme-toggle" @onclick="ThemeService.ToggleThemeAsync" title="Toggle Theme" type="button">
                @if (ThemeService.IsDarkMode)
                {
                    <i class="bi bi-sun-fill"></i>
                }
                else
                {
                    <i class="bi bi-moon-stars-fill"></i>
                }
            </button>

        </div>
    </header>

    <div class="app-main">
        <aside class="app-sidebar">
            <div class="app-sidebar-inner">
                <div class="app-sidebar-header">
                    <div class="app-logo-mark">GFC</div>
                    <div class="app-sidebar-title">
                        <div class="app-sidebar-title__main">Membership</div>
                        <div class="app-sidebar-title__sub">Control Center</div>
                    </div>
                </div>

                <div style="flex: 1; overflow-y: auto; min-height: 0;">
                    <NavMenu IsAdmin="_isAdmin || IsAdminUser()" />
                </div>

                <div class="app-sidebar-footer">
                    <div class="version-info">
                        <div class="version-info__developer">@VersionService.GetDeveloper() @VersionService.GetYear()</div>
                        <div class="version-info__revision">Revision @VersionService.GetRevision()</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="app-content">
            <Toast />
            <div class="content px-4">
                @Body
            </div>
        </main>
    </div>
</div>



@* Scripts have been moved to _Host.cshtml for proper resolution *@

@code {
    private string _currentUsername = string.Empty;
    private bool _isAdmin = false;
    private string _connectionStatus = "Checking...";
    private GFC.Core.Interfaces.LocationType _locationType = GFC.Core.Interfaces.LocationType.Unknown;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await UpdateUserInfo();
            UpdateConnectionStatus();
            
            // Subscribe to authentication state changes to update menu visibility
            AuthStateProvider.AuthenticationStateChanged += async (task) =>
            {
                await UpdateUserInfo();
                StateHasChanged();
            };

            await ThemeService.InitializeAsync();
            ThemeService.OnThemeChanged += StateHasChanged;
        }
        catch
        {
            // Ignore errors during initialization
            _currentUsername = "Unknown";
            _isAdmin = false;
        }
    }



    private async Task UpdateUserInfo()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _currentUsername = authState.User.Identity?.Name ?? "Unknown";
            
            // Check role from claims
            _isAdmin = authState.User.IsInRole(AppRoles.Admin);
            
            // Also check directly from the user object as a fallback
            if (!_isAdmin)
            {
                var currentUser = AuthStateProvider.GetCurrentUser();
                if (currentUser != null)
                {
                    _isAdmin = currentUser.IsAdmin;
                }
            }
            
            StateHasChanged();
        }
        catch
        {
            _currentUsername = "Unknown";
            _isAdmin = false;
        }
    }

    private void NavigateToLogin()
    {
        try
        {
            // Use JavaScript to navigate as a fallback
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch
        {
            // If navigation fails, try JavaScript
            // This will be handled by the browser
        }
    }

    private async Task HandleLogout()
    {
        try
        {
            await AuthStateProvider.LogoutAsync();
            // Wait a moment for state to propagate
            await Task.Delay(100);
            await UpdateUserInfo();
            // Force navigation with full page reload
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception)
        {
            // If logout fails, still try to navigate
            Navigation.NavigateTo("/login", forceLoad: true);
        }
    }

    private bool IsAdminUser()
    {
        try
        {
            // Check the cached _isAdmin first
            if (_isAdmin)
                return true;
            
            // Check directly from the current user object
            var currentUser = AuthStateProvider.GetCurrentUser();
            return currentUser?.IsAdmin == true;
        }
        catch
        {
            return false;
        }
    }





    private string GetConnectionStatusClass()
    {
        return _locationType switch
        {
            GFC.Core.Interfaces.LocationType.LAN => "status-lan",
            GFC.Core.Interfaces.LocationType.VPN => "status-vpn",
            GFC.Core.Interfaces.LocationType.Public => "status-public",
            _ => "status-unknown"
        };
    }

    private string GetConnectionStatusIcon()
    {
        return _locationType switch
        {
            GFC.Core.Interfaces.LocationType.LAN => "bi-wifi",
            GFC.Core.Interfaces.LocationType.VPN => "bi-shield-lock-fill",
            GFC.Core.Interfaces.LocationType.Public => "bi-exclamation-triangle-fill",
            _ => "bi-question-circle-fill"
        };
    }

    private void UpdateConnectionStatus()
    {
        _locationType = UserConnectionService.LocationType;
        _connectionStatus = _locationType switch
        {
            GFC.Core.Interfaces.LocationType.LAN => "Secure: Club Network",
            GFC.Core.Interfaces.LocationType.VPN => "Secure: Home VPN",
            GFC.Core.Interfaces.LocationType.Public => "Insecure: Public Net",
            _ => "Detecting Connection..."
        };
        StateHasChanged();
    }
}

