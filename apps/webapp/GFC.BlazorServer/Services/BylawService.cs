using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using GFC.BlazorServer.Data;
using GFC.Core.Interfaces;
using GFC.Core.Models;
using Microsoft.EntityFrameworkCore;

namespace GFC.BlazorServer.Services;

public class BylawService : IBylawService
{
    private readonly IDbContextFactory<GfcDbContext> _dbFactory;

    public BylawService(IDbContextFactory<GfcDbContext> dbFactory)
    {
        _dbFactory = dbFactory;
    }

    public async Task<BylawDocument> GetCurrentBylawsAsync(string category = "Club")
    {
        using var db = await _dbFactory.CreateDbContextAsync();
        
        var doc = await db.BylawDocuments
            .FirstOrDefaultAsync(d => d.Category == category);

        if (doc == null)
        {
            // Auto-create if missing (Handling the "first run" scenario gracefully)
            doc = new BylawDocument
            {
                Category = category,
                Title = "GFC Bylaws",
                Content = @"<div class='text-center mb-5'><h1>Constitution and By-Laws</h1><h2 class='text-muted'>Gloucester Fraternity Club, Inc.</h2><p><strong>REVISED:</strong> October 28, 1999<br><strong>REVISED:</strong> February 27, 2003</p></div><hr><h2>INDEX</h2><ul><li><strong>PREAMBLE</strong></li><li><strong>ORDER OF BUSINESS</strong></li><li><strong>CONSTITUTION</strong><ul><li>Name of Organization</li><li>Membership</li><li>Officers</li><li>Board of Directors</li><li>Membership Investigating Committee</li><li>Meetings</li><li>Amendments</li></ul></li><li><strong>BY-LAWS</strong><ul><li>Membership</li><li>Dues, Fines, and Membership Fees</li><li>Nominations and Elections of Officers</li><li>Duties of Officers</li><li>Duties of Membership Investigating Committee</li><li>Privileges and Conduct of Members</li><li>Committees</li><li>Expenditures and Appropriations</li><li>Interpretation of Constitution and By-Laws</li><li>Pledge and By-Laws Committee</li></ul></li></ul><hr><h3>PREAMBLE</h3><p>The purpose and object of this club shall be to bring together at frequent intervals those who are interested in the civic and fraternal betterment of any nature, with the purpose of promoting the cause of good citizenship.</p><h3>ORDER OF BUSINESS</h3><ol><li>Call meeting to order</li><li>Salute to the flag</li><li>Moment of silence for all departed members</li><li>Roll call of Officers</li><li>Reading of minutes of previous meeting</li><li>Communications</li><li>Treasurer's Report</li><li>Board of Directors' Report</li><li>Report of regular and special committees, Hall Rental and Lottery</li><li>Unfinished business</li><li>New business</li><li>Good of the club<ul><li>Sick call</li><li>Bank night</li></ul></li><li>Adjournment</li></ol><hr><h2>CONSTITUTION</h2><h3>ARTICLE I - NAME OF ORGANIZATION</h3><p>This organization shall be known as the <strong>Gloucester Fraternity Club, Inc.</strong> This official title shall be used in all written transactions of this organization.</p><h3>ARTICLE II - MEMBERSHIP</h3><h4>Section I - Regular Membership:</h4><p>To become a regular member of this organization, one must be a male of Portuguese descent, be of good moral character, and have reached the age of twenty-one (21).</p><p>There shall be forty-five (45) non-Portuguese regular members with American citizenship within the organization at any one time.</p><h4>Section II - Guest Membership:</h4><p>To become a guest member of this organization, one must be a male, an American citizen of good moral character who has reached the age of twenty-one (21), and who by nationality or other reasons is unable to join regular membership. Guest members shall have use of the clubrooms when available and shall attend club festivities and serve on committees on invitation only. They shall not attend regular or special meetings or vote.</p><h4>Section III - Armed Services</h4><p>A regular member joining the Armed Forces shall be granted a leave of absence for four years providing he remains in the service. All regular members, in the Armed Forces, shall be notified of any new laws pertaining to leave of absence.</p><h3>ARTICLE III - OFFICERS</h3><p>The officers of this organization shall consist of a President, Vice-President, Recording Secretary, Financial Secretary-Treasurer, Collector of Dues, Guide, and Four Directors.</p><h3>ARTICLE IV - BOARD OF DIRECTORS</h3><p>There shall be elected from the regular membership of this organization, four members to be known as Directors who, with the President, Vice-President, Recording Secretary, Financial Secretary-Treasurer, and Collector of Dues, shall constitute the nine-man Board of Directors, who shall meet to formulate plans and recommend all purposes and procedures of the organization.</p><p>The Board in its entirety at its first meeting of the new term of office will elect from among the four directors a chairman who will conduct all meeting of the board, and a vice-chairman to serve in the absence of the chairman.</p><h3>ARTICLE V - MEMBERSHIP INVESTIGATING COMMITTEE</h3><p>This five (5) member standing committee shall consist of two (2) Directors appointed by the Chairman of the Board, the Collector of Dues, and two (2) regular members-at-large in good standing appointed by the President with confirmation by the Board of Directors. The term of service for this committee will run concurrent with the term of the presiding administration.</p><p>This committee in its entirety, at its first meeting, will elect from amongst themselves a chairman who will conduct all meetings of the committee, and a vice-chairman to serve in the absence of the chairman.</p><h3>ARTICLE VI - MEETINGS</h3><h4>Section I</h4><p>The regular meetings of this organization shall be held once a month on the fourth Thursday at 7:00 p.m. When that day is in conflict with a special event or falls on a holiday, then the meeting shall be held at the discretion of the Board of Directors. Public notice shall be given.</p><h4>Section II</h4><p>Special meetings shall be called at the discretion of the Board of Directors or when requested in a written statement signed by a minimum of twenty (20) regular members in good standing and in which the specific purpose of the meeting is stated. This request must be submitted to the Board of Directors. Due public notice must be given to the entire regular membership and only the matter for which such special meeting is called shall be discussed and acted upon.</p><h4>Section III</h4><p>A quorum of fifteen (15) shall be necessary for all regular and special club meetings.</p><h3>ARTICLE VII - AMENDMENTS</h3><p>Any amendments to this constitution and by-laws shall be submitted in writing at a regular meeting of this organization. Such amendments must be signed by at least three (3) members in good standing. The amendment shall be read by the Secretary under the heading of new business, at three consecutive meetings. If at the third reading it is approved by a two-thirds majority of the members voting, the proposed amendment shall become a part of the Constitution and By-Laws.</p><hr><h2>BY-LAWS</h2><h3>ARTICLE I - MEMBERSHIP</h3><h4>Section I - Regular and Guest Membership, Application procedure:</h4><p>To become a regular or guest member of this organization, an applicant must be sponsored by a regular member in good standing. Said sponsor shall obtain an application form which will be completed by the applicant. The completed application and membership fee shall then be submitted to the Collector of Dues for first reading at the next regular meeting. The application shall then be forwarded to the Membership Investigating Committee. (See Article V of the By-Laws.)</p><h4>Section II - Regular and Guest Membership, Election Procedure:</h4><p>A. An approved application from the Membership Investigating Committee will be forwarded to the general membership for second reading and vote at the next regular meeting. A ballot system of white and black balls shall be used, with the white balls electing and a minimum of three (3) black balls rejecting. If an applicant is rejected he will be notified in writing by the Collector of Dues and his membership fee returned. He may reapply for membership after a six month period. In the case of a guest member who applies for an opening in the non-Portuguese regular membership, and is rejected twice, his name will drop to the bottom of the guest membership list. An applicant, if accepted, will be notified in writing by the Collector of Dues and be requested to be present at the next regular meeting to take his pledge of membership and to be formally introduced to the membership.</p><p>B. An unapproved application from the Membership Investigating Committee is covered in Article V of these By-Laws.</p><h4>Section III</h4><p>Regular membership shall be limited to three hundred (300) paying members. Guest membership shall not exceed fifty (50) percent (50%) of the allowed regular membership.</p><h4>Section IV - Life Membership, Definition:</h4><p>Any regular member who has served at least fifteen (15) consecutive years of membership in good standing, and has at least attained age 65 at the completion of said service, will be granted Life Membership.</p><h3>ARTICLE II - DUES, FINES AND MEMBERSHIP FEES</h3><h4>Section I</h4><p>The membership fee for regular and guest membership shall be ten ($10.00) dollars.</p><h4>Section II</h4><p>Dues shall be as set forth by the general membership and payable by January 1st of each year. Any regular member who is in arrears at the end of January will be duly notified by the Collector of Dues that he has until the February meeting to pay his dues in full or be automatically expelled from this organization; however, no member shall be suspended, expelled, or lose his membership because of illness, providing any officer of this organization has been duly notified of such illness.</p><p>If a regular member is expelled for non-payment of dues, he must follow the procedure as set forth in Article I, Section I, in order to rejoin this organization.</p><h4>Section III</h4><p>Guest members shall pay dues as set forth by the membership at a regular meeting.</p><h3>ARTICLE III - NOMINATIONS AND ELECTIONS OF OFFICERS</h3><ol><li>Nomination of Officers shall be held at the regular meeting in October of an election year.</li><li>A list shall be prepared by the Collector of Dues of all regular members in good standing and this list shall be checked as regular members accept nominations.</li><li>A regular member must be in good standing for a minimum of six (6) months to accept a nomination.</li><li>No regular member shall be a candidate for more than one office.</li><li>No employees of this organization shall be seated on the Board of Directors.</li><li>Any regular member who meets the above requirements can run on stickers for any office.</li><li>Nominations and acceptance of nominations, shall be made from the floor at said meeting, or in writing and in the hands of the Secretary prior to the nominations, as it appears on the calendar of business at said meeting.</li><li>At the close of nominations, an election committee composed of a chairman and a minimum of four (4) shall be appointed by the President. This committee shall take full charge of the election, make themselves available for absentee voting, count ballots, and post final results.</li><li>Candidates' names shall be drawn for ballot position by the election committee.</li><li>A copy of the ballot shall be posted prior to the election meeting and marked 'Sample Ballot'.</li><li>A list shall be prepared (see Item 2 above) and this list to be checked for eligible voters.</li><li>Enough ballots shall be printed to correspond to the above list.</li><li>Election of Officers shall be held at that meeting which follows the nomination meeting.</li><li>Polls to open from 7:00 p.m. to 9:00 p.m.</li><li>Date and time of the election meeting shall be posted on the club bulletin board; also, a back page ad shall be placed in the Gloucester Daily Times in advance of the election meeting date.</li><li>Any regular member unable to attend said election meeting because of illness, occupational, or other responsibilities, may obtain an absentee ballot and an envelope from a member of the election committee only. The voter will then mark his ballot, place it in and seal the envelope. He will then sign the envelope and hand it to the election committee member who will co-sign the envelope. These absentee ballots must be in the hands of the election committee before the polls open.</li><li>In the event of a tie vote, for any office, there shall be a special election between the tied candidates only. This election to be held within thirty (30) days and only those who voted previously are eligible to vote on the tie. The election committee will notify all eligible voters.</li><li>Ballots are to be kept in the office safe until the elected officers have been installed at the bi-annual ceremony held in January, following the election.</li><li>All elected officers of this organization will serve the full term of one (1) year, except as noted in Article III, Item 20.</li><li>Any office vacated as a result of death, illness, malfeasance of office, expulsion, resignation or entrance into the Armed Forces of the United States, shall be filled by the Board of Directors as soon as possible.</li><li>No member shall serve more than four consecutive terms (4 years) as President. After a minimum of two (2) one year terms (2 years) break in service, he may run again for the office of president. During the break in service, he may seek any office other than Vice President.</li></ol><h3>ARTICLE IV - DUTIES OF OFFICERS</h3><h4>Section I</h4><p>It shall be the duty of the President to preside at all meetings of the club, to preserve order and discharge all duties generally attendant upon the office of the President.</p><h4>Section II</h4><p>The Vice-President shall assist the President in the discharge of his duties and, in the absence of the President, perform the duties of his office.</p><h4>Section III</h4><p>The Recording Secretary shall attend all regular meetings of the organization, Board of Directors meetings, and shall record clearly and correctly the minutes of such meetings. He shall receive and answer all correspondence and bring before the organization all matters contained in such correspondence at its next regular meeting.</p><h4>Section IV</h4><p>The Financial Secretary-Treasurer shall receive all monies and pay all customary bills pertaining to the normal operation of this organization. Special or unusual bills must first be submitted to the body for approval of payment. He shall submit an accurate account of all monies received and all bills paid. See Article VIII.</p><h4>Section V</h4><p>The Collector of Dues shall receive all membership fees and dues and notify all members of their arrearage. He shall give a detailed report of membership status at the monthly Board of Directors meetings.</p><h4>Section VI</h4><p>The Guide shall introduce all candidates and guests and shall extend to them the courtesies of the club. He shall perform such other duties as may be required of him by the direction of the Board of Directors.</p><h4>Section VII</h4><p>The Board of Directors as specified in Article IV of the Constitution shall meet at least once a month. They shall also see that the books are audited by an in-house auditing committee appointed by the Board of Directors at the end of their first year in office. Prior to the completion of their term, the Board of Directors shall have the books audited by a public accountant with the assistance of the auditing committee. The term of service of the auditing committee shall run concurrently with the term of the presiding administration.</p><p>The Board of Directors will appoint a manager of the bar to comply with local Licensing Board regulations. However, the Board of Directors shall control management of the bar.</p><p>The Board of Directors shall also have charge of all legal papers of the club and such other duties, authorities, and powers as are generally conferred upon such Board of Directors in the management and government of the affairs of this club.</p><h4>Section VIII</h4><p>Any officer or director who fails to attend the regular meetings of the club and Board of Directors three (3) consecutive times without a reasonable excuse shall, by such failure to attend, vacate his office, or if his office is vacated in accordance with Article III, Section 22, said vacancy shall be filled by the Board of Directors as soon as possible.</p><h4>Section IX</h4><p>All Officers and Employees shall be bondable.</p><h3>ARTICLE V - DUTIES OF MEMBERSHIP INVESTIGATING COMMITTEE</h3><p>The Membership Investigating Committee as specified in Article V of the Constitution shall meet monthly subject to submitted applications. They will be responsible for compiling character evaluations of all applicants by such means as:</p><p>(a) verifying the statements made in the applications<br>(b) interviewing applicants<br>(c) interviewing sponsors<br>(d) interviewing character reference noted on applications<br>(e) inquiring with local authorities</p><p>Following their investigations, the committee shall meet to vote whether to forward an application (with a minimum of three (3) votes in the affirmative necessary) for a second reading and vote by the general membership at the next regular meeting; or reject said application thereby requesting the sponsoring member to withdraw his sponsorship. In this case, the sponsor retains his right to have the applications forwarded to the general membership for second reading and vote. However, it will be noted that said application is not sanctioned by the Membership Investigating Committee.</p><h3>ARTICLE VI - PRIVILEGES AND CONDUCT OF MEMBERS</h3><h4>Section I</h4><p>Regular members shall be allowed all privileges generally accorded members of an organization of this kind.</p><h4>Section II</h4><p>No member shall contract any bills or incur any expense in the name of this organization without proper authority.</p><p>No intoxicating liquors or games of chance shall be allowed at regular meetings.</p><h4>Section III</h4><p>No refreshments of any kind shall be allowed at regular or special meetings. Any member who is intoxicated or disorderly in any other manner shall be warned by the presiding officer, and at the second warning, the member shall be asked to leave the meeting.</p><p>Any member committing or permitting a violation of the rules and regulations, or pledge of membership as set down by this organization, or creates an obstruction of any other member in the enjoyment of his equal rights may be brought up on written charges and dealt with in accordance with these by-laws. Any member brought up on written charges shall be heard and judged by the Board of Directors of the club at a private hearing.</p><p>The course of action allowed the Board of Directors may be one of the following:</p><p>(a) Dismiss the case.<br>(b) Suspend the member for a stated period of time with an automatic one (1) year probationary period, following the suspension. The regular member having the right to appeal to the General Body.</p><p>Any member admitting to, or indicated guilty of flagrant disregard of club property (including cards, keys, by-laws, etc.), or inflicting damage to club property, a written charge not withstanding, shall appear before the Board of Directors to be heard and judged at a private hearing.</p><h4>Section IV</h4><p>Any member on probation by this organization shall not hold or run for any office or hold any job pertaining to the club for his period of probation.</p><h3>ARTICLE VII - COMMITTEES</h3><p>The chairman of any committee shall be appointed by the President unless other provisions for his selection shall be made on motion, approved by a two-thirds majority of the members voting, or as otherwise provided for in these by-laws.</p><h3>ARTICLE VIII - EXPENDITURES AND APPROPRIATIONS</h3><p>Donations of more than ten ($10.00) dollars shall require a two-thirds majority of those voting. All money belonging to the club shall be deposited in some bank in the name of the President, the Financial Secretary-Treasurer, and the club, and shall not be withdrawn except by check bearing the name of the Financial Secretary-Treasurer and counter-signed by the President. All expenditures shall be made by check, however, expenditures of over fifty ($50.00) dollars not expressly considered 'normal operating expenses' by the Board of Directors, require a two-thirds majority of those voting at a regular or special meeting.</p><p>Withdrawals of money from the regular savings accounts also require the approval of a two-thirds majority of members voting at a regular or special meeting. Any attempted circumvention (i.e. The earmarking of cash funds) of the aforementioned procedure is strictly prohibited.</p><h3>ARTICLE IX - INTERPRETATION OF CONSTITUTION AND BY-LAWS</h3><p>All rules and motions heretofore in force which would conflict with any herein, shall upon adoption of this constitution and by-laws, be declared void. Interpretation of these by-laws shall be made by the Board of Directors.</p><h3>ARTICLE X - PLEDGE</h3><blockquote class='blockquote p-3 bg-light border-start border-4 border-primary'>I do most solemnly on my honor, promise to observe and abide by the rules and regulations of the Gloucester Fraternity Club, Inc., and that I will attend the meetings of this organization as often as it is possible for me to do so; and I will strive to create a brotherly feeling between the members of this organization. To this I pledge my honor.</blockquote><h3>Constitution and By-Laws Committee</h3><p>The Constitution and By-Laws committee consisted of the following members:</p><ul><li>Ralph E. Goulart, Chairman</li><li>Richard A. Duwart</li><li>William P. Goulart, III</li><li>David A. Rose, P.P.</li><li>John A. Vestal, P.P.</li></ul><p><strong>Accepted:</strong> October 1994</p>",
                LastUpdatedAt = DateTime.UtcNow,
                LastUpdatedBy = "System",
                CurrentVersion = 1
            };
            db.BylawDocuments.Add(doc);
            await db.SaveChangesAsync();

            // Create initial revision
            db.BylawRevisions.Add(new BylawRevision
            {
                DocumentId = doc.Id,
                Content = doc.Content,
                Version = 1,
                RevisionBy = "System",
                RevisionDate = DateTime.UtcNow,
                ChangeReason = "Initial Creation"
            });
            await db.SaveChangesAsync();
        }

        return doc;
    }

    public async Task<List<BylawRevision>> GetRevisionHistoryAsync(int documentId)
    {
        using var db = await _dbFactory.CreateDbContextAsync();
        return await db.BylawRevisions
            .Where(r => r.DocumentId == documentId)
            .OrderByDescending(r => r.Version)
            .ToListAsync();
    }

    public async Task<BylawDocument> UpdateBylawsAsync(int documentId, string content, string changeReason, string updatedBy)
    {
        using var db = await _dbFactory.CreateDbContextAsync();
        
        var doc = await db.BylawDocuments.FindAsync(documentId);
        if (doc == null) throw new KeyNotFoundException("Bylaw document not found");

        // Update Document
        doc.Content = content;
        doc.LastUpdatedAt = DateTime.UtcNow;
        doc.LastUpdatedBy = updatedBy;
        doc.CurrentVersion++;

        // Add Revision
        var revision = new BylawRevision
        {
            DocumentId = doc.Id,
            Content = content,
            Version = doc.CurrentVersion,
            RevisionDate = doc.LastUpdatedAt,
            RevisionBy = updatedBy,
            ChangeReason = changeReason
        };

        db.BylawRevisions.Add(revision);
        
        await db.SaveChangesAsync();
        return doc;
    }
}
